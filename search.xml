<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>SpringCloud Alibaba 第一章</title>
      <link href="/hexo-docs/2025/08/23/SpringCloud/alibaba/chapter01/"/>
      <url>/hexo-docs/2025/08/23/SpringCloud/alibaba/chapter01/</url>
      
        <content type="html"><![CDATA[<h1 id="分布式基础"><a href="#分布式基础" class="headerlink" title="分布式基础"></a>分布式基础</h1><h2 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a><strong>微服务</strong></h2><p>微服务架构风格，就像是把一个<strong>单独的应用程序</strong>开发为<strong>一套小服务</strong>，每个<strong>小服务</strong>运行在<strong>自己</strong>的<strong>进程</strong>中，并使用轻量级机制通信，通常是 HTTP API。这些服务围绕业务能力来构建， 并通过完全自动化部署机制来独立部署。这些服务使用不同的编程语言书写，以及不同数据存储技术，并保持最低限度的集中式管理。 </p><p><em><strong>简而言之：拒绝大型单体应用，基于业务边界进行服务微化拆分，各个服务独立部署运行。</strong></em></p><p><img src="/hexo-docs/images/alibabaImage/1733297310596-6a264038-d7d3-43b6-9883-c0d70c43d678.png" alt="img"></p><h2 id="集群-分布式-节点"><a href="#集群-分布式-节点" class="headerlink" title="集群&amp;分布式&amp;节点"></a><strong>集群&amp;分布式&amp;节点</strong></h2><p><strong>集群是个物理形态，分布式是个工作方式。</strong> </p><p>只要是一堆机器，就可以叫集群，他们是不是一起协作着干活，这个谁也不知道； </p><p>《分布式系统原理与范型》定义： </p><ul><li>“分布式系统是若干独立计算机的集合，这些计算机对于用户来说就像单个相关系统” </li><li>分布式系统（distributed system）是建立在网络之上的软件系统。</li></ul><p>分布式是指将不同的业务分布在不同的地方。</p><p>集群指的是将几台服务器集中在一起，实现同一业务。 </p><p>例如：<strong>京东是一个分布式系统，众多业务运行在不同的机器</strong>，所有业务构成一个大型的<strong>业务集群</strong>。每一个小的业务，比如用户系统，访问压力大的时候一台服务器是不够的。我们就应该将用户系统部署到多个服务器，也就是<strong>每一个业务系统也可以做集群化</strong>； </p><p><em><strong>分布式中的每一个节点，都可以做集群。 而集群并不一定就是分布式的。</strong></em> </p><p><em><strong>节点：集群中的一个服务器</strong></em></p><h2 id="服务熔断-服务降级"><a href="#服务熔断-服务降级" class="headerlink" title="服务熔断&amp;服务降级"></a><strong>服务熔断&amp;服务降级</strong></h2><p>在微服务架构中，微服务之间通过网络进行通信，存在相互依赖，当其中一个服务不可用时，有可能会造成雪崩效应。要防止这样的情况，必须要有容错机制来保护服务。</p><p><img src="/hexo-docs/images/alibabaImage/52c47f.png" alt="img"></p><p>1）、服务熔断 </p><p>设置服务的超时，当被调用的服务经常失败到达某个阈值，我们可以开启断路保护机制，后来的请求不再去调用这个服务。本地直接返回默认的数据 </p><p>2）、服务降级 </p><p>在运维期间，当系统处于高峰期，系统资源紧张，我们可以让非核心业务降级运行。降级：某些服务不处理，或者简单处理【抛异常、返回 NULL、调用 Mock 数据、调用 Fallback 处理逻辑】</p><h2 id="API-网关"><a href="#API-网关" class="headerlink" title="API 网关"></a><strong>API 网关</strong></h2><p>在微服务架构中，API Gateway 作为整体架构的重要组件，它<em><strong>抽象了微服务中都需要的公共功能</strong></em>，同时提供了客户端<strong>负载均衡</strong>，<strong>服务自动熔断</strong>，<strong>灰度发布</strong>，<strong>统一认证</strong>，<strong>限流流控</strong>，<strong>日志统计</strong>等丰富的功能，帮助我们解决很多 API 管理难题。</p><p><img src="/hexo-docs/images/alibabaImage/718a16.png" alt="img"></p><h2 id="Spring-Cloud-Alibaba-是什么"><a href="#Spring-Cloud-Alibaba-是什么" class="headerlink" title="Spring Cloud Alibaba 是什么"></a>Spring Cloud Alibaba 是什么</h2><p>Spring Cloud Alibaba 致力于提供微服务开发的一站式解决方案。此项目包含开发分布式应用服务的必需组件，方便开发者通过 Spring Cloud 编程模型轻松使用这些组件来开发分布式应用服务。</p><p>依托 Spring Cloud Alibaba，您只需要添加一些注解和少量配置，就可以将 Spring Cloud 应用接入阿里分布式应用解决方案，通过阿里中间件来迅速搭建分布式应用系统。</p><p>此外，<a href="https://www.aliyun.com/product/aliware/mse?spm=sca-website.topbar.0.0.0">Spring Cloud Alibaba 企业版</a>，包括无侵入服务治理(全链路灰度，无损上下线，离群实例摘除等)，企业级 Nacos 注册配置中心和企业级云原生网关等众多产品。</p><h3 id="Spring-Cloud-微服务体系"><a href="#Spring-Cloud-微服务体系" class="headerlink" title="Spring Cloud 微服务体系"></a>Spring Cloud 微服务体系</h3><p>Spring Cloud 是分布式微服务架构的一站式解决方案，它提供了一套简单易用的编程模型，使我们能在 Spring Boot 的基础上轻松地实现微服务系统的构建。 <strong>Spring Cloud 提供以微服务为核心的分布式系统构建标准。</strong></p><p><img src="/hexo-docs/images/alibabaImage/spring-cloud-img.png" alt="spring-cloud"></p><p>Spring Cloud 本身并不是一个开箱即用的框架，它是一套微服务规范，共有两代实现。</p><ul><li>Spring Cloud Netflix 是 Spring Cloud 的第一代实现，主要由 Eureka、Ribbon、Feign、Hystrix 等组件组成。</li><li>Spring Cloud Alibaba 是 Spring Cloud 的第二代实现，主要由 Nacos、Sentinel、Seata 等组件组成。</li></ul><h3 id="Spring-Cloud-Alibaba-定位"><a href="#Spring-Cloud-Alibaba-定位" class="headerlink" title="Spring Cloud Alibaba 定位"></a>Spring Cloud Alibaba 定位</h3><p><img src="/hexo-docs/images/alibabaImage/spring-cloud-alibaba-img.png" alt="spring-cloud"></p><p>Spring Cloud Alibaba 是阿里巴巴结合自身丰富的微服务实践而推出的微服务开发的一站式解决方案，是 Spring Cloud 第二代实现的主要组成部分。吸收了 Spring Cloud Netflix 微服务框架的核心架构思想，并进行了高性能改进。自 Spring Cloud Netflix 进入停更维护后，Spring Cloud Alibaba 逐渐代替它成为主流的微服务框架。</p><p>同时 Spring Cloud Alibaba 也是国内首个进入 Spring 社区的开源项目。2018 年 7 月，Spring Cloud Alibaba 正式开源，并进入 Spring Cloud 孵化器中孵化；2019 年 7 月，Spring Cloud 官方宣布 Spring Cloud Alibaba 毕业，并将仓库迁移到 Alibaba Github OSS 下。</p><h2 id="版本发布说明"><a href="#版本发布说明" class="headerlink" title="版本发布说明"></a>版本发布说明</h2><h3 id="2023-x-分支"><a href="#2023-x-分支" class="headerlink" title="2023.x 分支"></a>2023.x 分支</h3><p>适配 Spring Boot 3.2，Spring Cloud 2023.x 版本及以上的 Spring Cloud Alibaba 版本按从新到旧排列如下表（最新版本用*标记）：</p><table><thead><tr><th>Spring Cloud Alibaba Version</th><th>Spring Cloud Version</th><th>Spring Boot Version</th></tr></thead><tbody><tr><td>2023.0.1.0*</td><td>Spring Cloud 2023.0.1</td><td>3.2.4</td></tr><tr><td>2023.0.0.0-RC1</td><td>Spring Cloud 2023.0.0</td><td>3.2.0</td></tr></tbody></table><h3 id="组件版本关系"><a href="#组件版本关系" class="headerlink" title="组件版本关系"></a>组件版本关系</h3><p>每个 Spring Cloud Alibaba 版本及其自身所适配的各组件对应版本如下表所示：</p><table><thead><tr><th>Spring Cloud Alibaba Version</th><th>Sentinel Version</th><th>Nacos Version</th><th>RocketMQ Version</th><th>Seata Version</th></tr></thead><tbody><tr><td>2023.0.1.0</td><td>1.8.6</td><td>2.3.2</td><td>5.1.4</td><td>2.0.0</td></tr><tr><td>2023.0.0.0-RC1</td><td>1.8.6</td><td>2.3.0</td><td>5.1.4</td><td>2.0.0</td></tr></tbody></table><h2 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a><code>Nacos</code></h2><h3 id="Nacos概述"><a href="#Nacos概述" class="headerlink" title="Nacos概述"></a><code>Nacos</code>概述</h3><p><a href="https://nacos.io/zh-cn/">Nacos</a> &#x2F;nɑ:k əʊs&#x2F; 是 Dynamic Naming and Configuration Service 的首字母简称，一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。</p><p><code>Nacos</code> 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。</p><p><code>Nacos</code> 帮助您更敏捷和容易地构建、交付和管理微服务平台。Nacos 是构建以“服务”为中心的现代应用架构 (例如微服务范式、云原生范式) 的服务基础设施。</p><h3 id="什么是-Nacos？"><a href="#什么是-Nacos？" class="headerlink" title="什么是 Nacos？"></a>什么是 Nacos？</h3><p>服务（Service）是 Nacos 世界的一等公民。Nacos 支持几乎所有主流类型的“服务”的发现、配置和管理：</p><p><a href="https://kubernetes.io/docs/concepts/services-networking/service/">Kubernetes Service</a></p><p><a href="https://grpc.io/docs/guides/concepts.html#service-definition">gRPC</a> &amp; <a href="https://dubbo.apache.org/">Dubbo RPC Service</a></p><p><a href="https://spring.io/projects/spring-cloud">Spring Cloud RESTful Service</a></p><p>Nacos 的关键特性包括:</p><ul><li><p><strong>服务发现和服务健康监测</strong></p><p>Nacos 支持基于 DNS 和基于 RPC 的服务发现。服务提供者使用 <a href="https://nacos.io/docs/latest/guide/user/sdk/">原生SDK</a>、<a href="https://nacos.io/docs/latest/guide/user/open-api/">OpenAPI</a>、或一个<a href="https://nacos.io/docs/latest/guide/user/other-language/">独立的Agent TODO</a>注册 Service 后，服务消费者可以使用<a href="https://nacos.io/docs/latest/ecology/use-nacos-with-coredns/">DNS TODO</a> 或<a href="https://nacos.io/docs/latest/guide/user/open-api/">HTTP&amp;API</a>查找和发现服务。</p><p>Nacos 提供对服务的实时的健康检查，阻止向不健康的主机或服务实例发送请求。Nacos 支持传输层 (PING 或 TCP)和应用层 (如 HTTP、MySQL、用户自定义）的健康检查。 对于复杂的云环境和网络拓扑环境中（如 VPC、边缘网络等）服务的健康检查，Nacos 提供了 agent 上报模式和服务端主动检测2种健康检查模式。Nacos 还提供了统一的健康检查仪表盘，帮助您根据健康状态管理服务的可用性及流量。</p></li><li><p><strong>动态配置服务</strong></p><p>动态配置服务可以让您以中心化、外部化和动态化的方式管理所有环境的应用配置和服务配置。</p><p>动态配置消除了配置变更时重新部署应用和服务的需要，让配置管理变得更加高效和敏捷。</p><p>配置中心化管理让实现无状态服务变得更简单，让服务按需弹性扩展变得更容易。</p><p>Nacos 提供了一个简洁易用的UI (<a href="http://console.nacos.io/nacos/index.html">控制台样例 Demo</a>) 帮助您管理所有的服务和应用的配置。Nacos 还提供包括配置版本跟踪、金丝雀发布、一键回滚配置以及客户端配置更新状态跟踪在内的一系列开箱即用的配置管理特性，帮助您更安全地在生产环境中管理配置变更和降低配置变更带来的风险。</p></li><li><p><strong>动态 DNS 服务</strong></p><p>动态 DNS 服务支持权重路由，让您更容易地实现中间层负载均衡、更灵活的路由策略、流量控制以及数据中心内网的简单DNS解析服务。动态DNS服务还能让您更容易地实现以 DNS 协议为基础的服务发现，以帮助您消除耦合到厂商私有服务发现 API 上的风险。</p><p>Nacos 提供了一些简单的 <a href="https://nacos.io/docs/latest/ecology/use-nacos-with-coredns/">DNS APIs TODO</a> 帮助您管理服务的关联域名和可用的 IP</p><p>列表.</p></li><li><p><strong>服务及其元数据管理</strong></p><p>Nacos 能让您从微服务平台建设的视角管理数据中心的所有服务及元数据，包括管理服务的描述、生命周期、服务的静态依赖分析、服务的健康状态、服务的流量管理、路由及安全策略、服务的 SLA 以及最首要的 metrics 统计数据。</p></li></ul><h2 id="使用的版本"><a href="#使用的版本" class="headerlink" title="使用的版本"></a>使用的版本</h2><ol><li><code>spring-cloud.alibaba</code>: 2023.0.3.2 </li><li><code>spring-cloud</code>：2023.0.3</li><li><code>springboot</code>：3.3.4</li></ol><h3 id="搭建项目"><a href="#搭建项目" class="headerlink" title="搭建项目"></a>搭建项目</h3><ol><li><p>搭建一个这个目录的项目</p><p><img src="/hexo-docs/images/alibabaImage/image-20250326181953606.png" alt="image-20250326181953606"></p></li><li><p>在<code>study-spring-cloud-alibaba</code>项目下添加依赖</p><p>1. </p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud-alibaba.version</span>&gt;</span>2023.0.3.2<span class="tag">&lt;/<span class="name">spring-cloud-alibaba.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>2023.0.3<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>3.3.4<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- spring-cloud alibaba --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud-alibaba.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- spring-boot --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- spring-cloud --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在<code>services</code>项目下添加依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 服务发现 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>下载<code>Nacos</code> <a href="https://nacos.io/download/nacos-server/?spm=5238cd80.2ef5001f.0.0.3f613b7cxWlkjC#%E7%A8%B3%E5%AE%9A%E7%89%88%E6%9C%AC">Nacos Server 下载 地址</a></p></li><li><p>下载完之后解压到一个没有中文和空格的文件夹下</p></li><li><p>解压完成之后，进入bin文件夹下在<code>cmd</code>输入 <code>startup.cmd -m standalone</code>启动<code>Nacos</code></p></li><li><p><img src="/hexo-docs/images/alibabaImage/image-20250326183208176.png" alt="image-20250326183208176"></p></li><li><p>启动完成之后我们访问<code>localhost:8848/nacos</code>来访问<code>Nacos</code></p><blockquote><p>注意：</p><p>​如果访问<code>localhost:8848</code>会访问不到</p></blockquote></li><li><p>集成 <code>Nacos</code></p><ol><li><p>基于上面的项目在<code>service-order</code>和<code>service-product</code>添加依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>编写<code>service-order</code>和<code>service-product</code>配置</p><ol><li><p><code>service-order</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service-order</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span> <span class="comment"># nacos 注册地址</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8000</span></span><br></pre></td></tr></table></figure></li><li><p><code>service-product</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service-product</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span> <span class="comment"># nacos 注册地址</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9000</span></span><br></pre></td></tr></table></figure></li><li><p>启动这两个项目</p></li><li><p>访问<code>localhost:8848/nacos</code></p></li><li><p><img src="/hexo-docs/images/alibabaImage/image-20250326193343921.png" alt="image-20250326193343921"></p></li><li><p>从图中看的我们的两个服务已经注册到<code>Nacos</code>上了</p><blockquote><p>注意：</p><p>​<code>Nacos</code>必须开启，要不然访问不到</p></blockquote></li></ol></li></ol></li></ol><h2 id="服务注册-发现-注册中心"><a href="#服务注册-发现-注册中心" class="headerlink" title="服务注册&#x2F;发现&amp;注册中心"></a>服务注册&#x2F;发现&amp;注册中心</h2><p>A 服务调用 B 服务，A 服务并不知道 B 服务当前在哪几台服务器有，哪些正常的，哪些服务已经下线。解决这个问题可以引入注册中心；</p><p><img src="/hexo-docs/images/alibabaImage/d2db.png" alt="img"></p><p>如果某些服务下线，我们其他人可以实时的感知到其他服务的状态，从而避免调用不可用的服务</p><p>服务发现是一种允许服务之间相互发现和通信的机制</p><p>服务发现是一种<strong>允许服务之间相互发现和通信的机制</strong>。服务发现包括服务注册和服务查找两个过程。服务注册是指服务将自己的网络地址注册到服务注册中心。服务查找是指服务通过查询服务注册中心来获取其他服务的网络地址。服务发现的优点是提高了系统的灵活性和可扩展性，无需关心服务的具体位置，只需要知道服务的名称。服务发现还需要提供健康监控、多种查询、实时更新和高可用性等特性。</p><p>开启服务发现：</p><ol><li><p>在启动类上添加服务发现的注解 <code>@EnableDiscoveryClient</code></p></li><li><p>获取端口号，主机名字</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">discoveryTest</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//获取所有服务</span></span><br><span class="line">    List&lt;String&gt; services = discoveryClient.getServices();</span><br><span class="line">    <span class="keyword">for</span> (String service : services) &#123;</span><br><span class="line">        <span class="comment">// 根据服务获取所有实例</span></span><br><span class="line">        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(service);</span><br><span class="line">        <span class="keyword">for</span> (ServiceInstance instance : instances) &#123;</span><br><span class="line">            <span class="comment">//主机地址</span></span><br><span class="line">            System.out.println(<span class="string">&quot;host：&quot;</span>+instance.getHost());</span><br><span class="line">            <span class="comment">//获取url</span></span><br><span class="line">            System.out.println(<span class="string">&quot;uri：&quot;</span>+instance.getUri());</span><br><span class="line">            <span class="comment">//获取端口号</span></span><br><span class="line">            System.out.println(<span class="string">&quot;port：&quot;</span>+instance.getPort());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>测试结果</p><p><img src="/hexo-docs/images/alibabaImage/image-20250327215131828.png" alt="image-20250327215131828"></p></li><li><p>使用<code>NacosDiscoveryClint</code>获取服务实例</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> NacosDiscoveryClient nacosDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">nacosDiscoveryClientTest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取所有服务</span></span><br><span class="line">    List&lt;String&gt; services = nacosDiscoveryClient.getServices();</span><br><span class="line">    <span class="keyword">for</span> (String service : services) &#123;</span><br><span class="line">        <span class="comment">// 根据服务获取实例</span></span><br><span class="line">        <span class="keyword">for</span> (ServiceInstance instance : nacosDiscoveryClient.getInstances(service)) &#123;</span><br><span class="line">            <span class="comment">//主机地址</span></span><br><span class="line">            System.out.println(<span class="string">&quot;host：&quot;</span>+instance.getHost());</span><br><span class="line">            <span class="comment">// 端口号</span></span><br><span class="line">            System.out.println(<span class="string">&quot;port：&quot;</span>+instance.getPort());</span><br><span class="line">            System.out.println(<span class="string">&quot;uri：&quot;</span>+instance.getUri());</span><br><span class="line">            System.out.println(<span class="string">&quot;实例id：&quot;</span>+instance.getInstanceId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/alibabaImage/image-20250327215734279.png" alt="image-20250327215734279"></p></li></ol><h2 id="远程调用"><a href="#远程调用" class="headerlink" title="远程调用"></a>远程调用</h2><p>在分布式系统中，各个服务可能处于不同主机，但是服务之间不可避免的需要互相调用，我们称为远程调用。 SpringCloud 中使用 HTTP+JSON 的方式完成远程调用</p><p><img src="/hexo-docs/images/alibabaImage/1733297496168-259c804b-17cc-4f14-9127-9eb0f56c049b.png" alt="img"></p><p>在Spring Cloud中，远程调用是微服务架构中非常重要的一部分。它允许一个服务调用另一个服务的API，从而实现服务之间的通信。Spring Cloud提供了多种方式来实现远程调用，主要包括<strong>RestTemplate</strong>和<strong>Feign</strong>，我们就有 <code>RestTemplate</code>来实现远程调用，我们要用订单远程调用商品</p><ol><li><p>在<code>study-spring-cloud-alibab</code>下新建一个<code>model</code>模块作为公共模块，在存放<code>service-order</code>和<code>service-product</code>的公共模块,在下面在引入<code>lombok</code>依赖</p><p><img src="/hexo-docs/images/alibabaImage/image-20250327225354669.png" alt="image-20250327225354669"></p></li><li><p>在<code>model</code>创建<code>Order实体类</code>和<code>Product实体类</code></p><ol><li><p><code>Order实体类</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.order.bean;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal totalAmount;</span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Product&gt; productList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p><code>Product实体类</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.product.bean;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Product</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">    <span class="keyword">private</span> String productName;</span><br><span class="line">    <span class="keyword">private</span> Integer num;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>在<code>service-order</code>和<code>service-product</code>的父项<code>service</code>引入<code>model</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lazy.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>model<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><code>service-product</code></p><ol><li><p><code>service</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProductService</span> &#123;</span><br><span class="line">    Product <span class="title function_">addProduct</span><span class="params">(Long productId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>impl</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ProductService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">addProduct</span><span class="params">(Long productId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Product</span>(productId,<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;20.0&quot;</span>),<span class="string">&quot;苹果&quot;</span>+productId,<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>controller</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ProductService productService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/product/&#123;productId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProduct</span><span class="params">(<span class="meta">@PathVariable(&quot;productId&quot;)</span> Long productId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> productService.addProduct(productId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>测试<code>service-product</code></p><p><img src="/hexo-docs/images/alibabaImage/image-20250327230127411.png" alt="image-20250327230127411"></p></li></ol></li><li><p><code>service-order</code></p><ol><li><p><code>service</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    Order <span class="title function_">addOrder</span><span class="params">(Long userId, Long productId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>impl</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">addOrder</span><span class="params">(Long userId, Long productId)</span> &#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> getProductFormRemote(productId);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">price</span> <span class="operator">=</span> product.getPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(product.getNum()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Order</span>(userId,price,productId,<span class="string">&quot;河北&quot;</span>, List.of(product));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProductFormRemote</span><span class="params">(Long productId)</span> &#123;</span><br><span class="line">        <span class="comment">//获取商品所在的所有机器的IP+Port</span></span><br><span class="line">        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;service-product&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;远程请求调用&#123;&#125;&quot;</span>,instances.get(<span class="number">0</span>).getUri());</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> instances.get(<span class="number">0</span>).getUri()+<span class="string">&quot;/product/&quot;</span>+productId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(url, Product.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>config</code>配置<code>RestTemplate</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p><code>controller</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/addOrder&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">addOrder</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;userId&quot;)</span> Long userId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;productId&quot;)</span> Long productId</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> orderService.addOrder(userId, productId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>测试<code>service-product</code>,要启动<code>service-product</code>和<code>service-order</code></p><p><img src="/hexo-docs/images/alibabaImage/image-20250327230508764.png" alt="image-20250327230508764"></p></li></ol></li></ol></li></ol><h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>分布式系统中，A 服务需要调用 B 服务，B 服务在多台机器中都存在，A 调用任意一个服务器均可完成功能。 为了使每一个服务器都不要太忙或者太闲，我们可以负载均衡的调用每一个服务器，提升网站的健壮性。 </p><p><em><strong>常见的负载均衡算法：</strong></em> </p><ul><li><p><strong>轮询：</strong> 为第一个请求选择健康池中的第一个后端服务器，然后按顺序往后依次选择，直到最后一个，然后循环。 </p></li><li><p><strong>最小连接：</strong> 优先选择连接数最少，也就是压力最小的后端服务器，在会话较长的情况下可以考虑采取这种方式。 </p></li><li><p><strong>散列：</strong> 根据请求源的 IP 的散列（hash）来选择要转发的服务器。这种方式可以一定程度上保证特定用户能连接到相同的服务器。如果你的应用需要处理状态而要求用户能连接到和之前相同的服务器，可以考虑采取这种方式。</p></li></ul><p><img src="/hexo-docs/images/alibabaImage/1733297584522-54991385-dc66-4e94-a9a0-159da79227f6.png" alt="img"></p><h3 id="LoadBalancer负载均衡"><a href="#LoadBalancer负载均衡" class="headerlink" title="LoadBalancer负载均衡"></a>LoadBalancer负载均衡</h3><p>当我们的<code>service-product</code>服务崩了，随着我们的<code>service-order</code>服务也用不了了，所以我们要引入负载均衡</p><p>因为我们的<code>service-order</code>服务对我们的<code>service-product</code>进行调用，所以说服务调用者是<code>service-order</code>，对我们的<code>service-product</code>进行负载均衡</p><ol><li><p>对我们的<code>service-order</code>引入负载均衡的依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>修改<code>OrderServiceImpl</code>进行改造</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">addOrder</span><span class="params">(Long userId, Long productId)</span> &#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> getProductFormRemoteWithLoadBalance(productId);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">price</span> <span class="operator">=</span> product.getPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(product.getNum()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Order</span>(userId,price,productId,<span class="string">&quot;河北&quot;</span>, List.of(product));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerClient loadBalancer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProductFormRemoteWithLoadBalance</span><span class="params">(Long productId)</span> &#123;</span><br><span class="line">        <span class="comment">//获取商品所在的所有机器的IP+Port</span></span><br><span class="line">        <span class="type">ServiceInstance</span> <span class="variable">serviceInstance</span> <span class="operator">=</span> loadBalancer.choose(<span class="string">&quot;service-product&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;远程请求调用&#123;&#125;&quot;</span>,serviceInstance.getUri());</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> serviceInstance.getUri()+<span class="string">&quot;/product/&quot;</span>+productId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(url, Product.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>运行测试</p><p>当我们运行多次后发现，已经实现了负载均衡</p><p><img src="/hexo-docs/images/alibabaImage/image-20250327232746247.png" alt="image-20250327232746247"></p><h3 id="基于注解的负载均衡"><a href="#基于注解的负载均衡" class="headerlink" title="基于注解的负载均衡"></a>基于注解的负载均衡</h3><ol><li><p>改造<code>OrderServiceConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>改造<code>OrderServiceImpl</code>类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">addOrder</span><span class="params">(Long userId, Long productId)</span> &#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> getProductFormRemoteWithLoadBalanceAnnotation(productId);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">price</span> <span class="operator">=</span> product.getPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(product.getNum()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Order</span>(userId,price,productId,<span class="string">&quot;河北&quot;</span>, List.of(product));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 基于注解的负载均衡</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProductFormRemoteWithLoadBalanceAnnotation</span><span class="params">(Long productId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://service-product/product/&quot;</span>+productId;</span><br><span class="line">        log.info(<span class="string">&quot;远程请求调用&#123;&#125;&quot;</span>,url);</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(url, Product.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>运行测试，访问<code>localhost:8000/addOrder?userId=1&amp;productId=100](http://localhost:8000/addOrder?userId=1&amp;productId=100</code></p><p><img src="/hexo-docs/images/alibabaImage/4.png" alt="image-20250328181459804"></p><p><img src="/hexo-docs/images/alibabaImage/6.png" alt="image-20250328181508786"></p></li></ol></li></ol><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><strong>如果注册中心宕机，远程调用是否可以成功？</strong></p><ol><li>从未调用过，如果宕机，调用会立即失败</li><li>调用过，如果宕机，因为会缓存名单，调用会成功</li><li>调用过，如果注册中心和对方服务宕机，因为会缓存名单，调用会阻塞后失败（Connection Refused）</li></ol><p><img src="/hexo-docs/images/alibabaImage/81.png" alt="img"></p><h2 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h2><p>主要提示：</p><p><img src="/hexo-docs/images/alibabaImage/9.png" alt="image-20250328224501029"></p><p>每一个服务最终都有大量的配置，并且每个服务都可能部署在多台机器上。我们经常需要变更配置，我们可以让每个服务在配置中心获取自己的配置。 </p><p><em><strong>配置中心用来集中管理微服务的配置信息</strong></em></p><p><img src="/hexo-docs/images/alibabaImage/fa.png" alt="img"></p><h2 id="1、使用-value和-RefreshScope自动刷新"><a href="#1、使用-value和-RefreshScope自动刷新" class="headerlink" title="1、使用@value和@RefreshScope自动刷新"></a>1、使用@value和@RefreshScope自动刷新</h2><ol><li><p>在<code>service</code>下引入依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在<code>service-order</code>编写配置文件</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service-order</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span> <span class="comment"># nacos 服务地址和端口号</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span> <span class="string">nacos:service-order.properties</span> <span class="comment"># nacos 配置列表的名字</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8000</span></span><br></pre></td></tr></table></figure></li><li><p>打开<code>nacos</code>创建<code>service-order.properties</code></p><p><img src="/hexo-docs/images/alibabaImage/18.png" alt="image-20250328203049848"></p></li><li><p>点击创建配置、创建<code>service-order.properties</code></p><p><img src="/hexo-docs/images/alibabaImage/34.png" alt="image-20250328203254934"></p></li><li><p>点击发布</p><p><img src="/hexo-docs/images/alibabaImage/623.png" alt="image-20250328203317623"></p></li><li><p>编写<code>controller</code>类来进行测试</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;order.timeout&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String timeout;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;order.auto-confirm&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String autoConfirm;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/config&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">config</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;timeout：&quot;</span>+timeout+<span class="string">&quot;\nauto-confirm&quot;</span>+autoConfirm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>运行测试一下</p><p><img src="/hexo-docs/images/alibabaImage/20250328203656304.png" alt="image-20250328203656304"></p></li><li><p>发现已经，可以访问了，我们在修改一下<code>service-order.properties</code>，测试一下看看本地是否变</p><p><img src="/hexo-docs/images/alibabaImage/03399.png" alt="image-20250328203803399"></p></li><li><p>在刷新一下，配置文件变了，本地没有变</p><p><img src="/hexo-docs/images/alibabaImage/-20250328203845610.png" alt="image-20250328203845610"></p></li><li><p>我们在改造一下<code>controller</code>类，让他实现实时刷新</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.cloud.order.bean.Order;</span><br><span class="line"><span class="keyword">import</span> com.lazy.cloud.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RefreshScope</span> <span class="comment">// 配置自动刷新</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;order.timeout&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String timeout;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;order.auto-confirm&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String autoConfirm;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/config&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">config</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;timeout：&quot;</span>+timeout+<span class="string">&quot;\nauto-confirm&quot;</span>+autoConfirm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在运行一下看看，发现配置已经变了</p><p><img src="/hexo-docs/images/alibabaImage/250328204107416.png" alt="image-20250328204107416"></p></li><li><p>我们在变回来试试</p><p><img src="/hexo-docs/images/alibabaImage/image-20250328204146150.png" alt="image-20250328204146150"></p></li></ol><p>发现配置实现了实时刷新！</p><blockquote><p>注意：<br>​如果导入了<code>spring-cloud-starter-alibaba-nacos-config</code>依赖就必须编写<code>spring.config.import</code>配置，不然启动的时候，启动不起来，或者添加<code>spring.cloud.nacos.config.import-check.enabled=false</code>也行。<code>spring.cloud.nacos.config.import-check.enabled=false</code>是禁用导入检查</p></blockquote><h2 id="2、使用-ConfigurationProperties无感刷新"><a href="#2、使用-ConfigurationProperties无感刷新" class="headerlink" title="2、使用@ConfigurationProperties无感刷新"></a>2、使用@ConfigurationProperties无感刷新</h2><ol><li><p>导入<code>spring-cloud-starter-alibaba-nacos-config</code>依赖</p></li><li><p>新建<code>OrderProerties</code>类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;order&quot;)</span> <span class="comment">//配置批量绑定在nacos下，可以无需@RefreshScope就能实现自动刷新</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String timeout;</span><br><span class="line">    <span class="keyword">private</span> String autoConfirm;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p><code>controller</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderProperties orderProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/config&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">config</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;timeout：&quot;</span>+orderProperties.getTimeout()+<span class="string">&quot;\nauto-confirm&quot;</span>+orderProperties.getAutoConfirm();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>运行测试</p><p><img src="/hexo-docs/images/alibabaImage/image-20250328205953330.png" alt="image-20250328205953330"></p></li><li><p>修改<code>service-order.properties</code>,再刷新</p><p><img src="/hexo-docs/images/alibabaImage/image-20250328210102666.png" alt="image-20250328210102666"></p></li></ol><p>发现可以实现无感刷新</p><h2 id="配置监听变换"><a href="#配置监听变换" class="headerlink" title="配置监听变换"></a>配置监听变换</h2><p>需求，当我们发现<code> service-order.properties</code>配置文件修改后，发生短信通知配置文件已修改</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceOrderApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ServiceOrderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//1、项目启动就监听配置文件变化</span></span><br><span class="line">    <span class="comment">//2、发生变换后拿到变化值</span></span><br><span class="line">    <span class="comment">//3、发生邮件</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ApplicationRunner 是一个一次性任务，项目启动成功后，这个任务就会执行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    ApplicationRunner <span class="title function_">applicationRunner</span><span class="params">(NacosConfigManager configManager)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> args -&gt; &#123;</span><br><span class="line">            <span class="type">ConfigService</span> <span class="variable">configService</span> <span class="operator">=</span> configManager.getConfigService();</span><br><span class="line">            configService.addListener(<span class="string">&quot;service-order.properties&quot;</span>, <span class="string">&quot;DEFAULT_GROUP&quot;</span>, <span class="keyword">new</span> <span class="title class_">Listener</span>() &#123;</span><br><span class="line">                <span class="comment">// 线程池,Executors.newFixedThreadPool(4) new 了4个线程</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> Executor <span class="title function_">getExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> Executors.newFixedThreadPool(<span class="number">4</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// receiveConfigInfo 接受所有变化了的配置</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveConfigInfo</span><span class="params">(String s)</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;变化了的配置：&quot;</span>+s);</span><br><span class="line">                    System.out.println(<span class="string">&quot;邮件通知...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>启动测试，当我们修改<code>service-order.properties</code>配置文件后，看看控制台打印什么</p><p><img src="/hexo-docs/images/alibabaImage/image-20250328211705854.png" alt="image-20250328211705854"></p><h2 id="nacos重启后配置还会有吗？"><a href="#nacos重启后配置还会有吗？" class="headerlink" title="nacos重启后配置还会有吗？"></a>nacos重启后配置还会有吗？</h2><p>会，配置会保存到本地</p><p><img src="/hexo-docs/images/alibabaImage/image-20250328213407805.png" alt="image-20250328213407805"></p><p>官方解释</p><p><img src="/hexo-docs/images/alibabaImage/image-20250328213727113.png" alt="image-20250328213727113"></p><h2 id="Nacos中的数据集和application-properties中有相同的配置项，那个先生效"><a href="#Nacos中的数据集和application-properties中有相同的配置项，那个先生效" class="headerlink" title="Nacos中的数据集和application.properties中有相同的配置项，那个先生效"></a><code>Nacos</code>中的数据集和<code>application.properties</code>中有相同的配置项，那个先生效</h2><p>在Nacos中，当配置中心（Nacos Server）中的数据集（如通过<code>dataId</code>和<code>groupId</code>指定的配置）与本地<code>application.properties</code>文件中存在<strong>相同配置项</strong>时，<strong>生效优先级</strong>取决于以下规则：</p><hr><h3 id="1-默认情况下：Nacos配置中心的优先级更高"><a href="#1-默认情况下：Nacos配置中心的优先级更高" class="headerlink" title="1. 默认情况下：Nacos配置中心的优先级更高"></a><strong>1. 默认情况下：Nacos配置中心的优先级更高</strong></h3><ul><li><strong>Nacos配置会覆盖本地配置</strong>。即如果Nacos Server和<code>application.properties</code>有相同的配置项，Nacos中的值会生效。</li><li><strong>原因</strong>：Spring Cloud Alibaba Nacos Config默认将远程配置（Nacos）作为高优先级源，本地配置作为低优先级源。这是通过<code>PropertySource</code>的顺序实现的（Nacos的配置通常被添加到<code>Environment</code>的前部）。</li></ul><hr><h3 id="2-关键配置项：spring-cloud-nacos-config-override-none"><a href="#2-关键配置项：spring-cloud-nacos-config-override-none" class="headerlink" title="2. 关键配置项：spring.cloud.nacos.config.override-none"></a><strong>2. 关键配置项：<code>spring.cloud.nacos.config.override-none</code></strong></h3><p>如果希望本地配置优先，可以通过以下配置显式控制：</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置为true时，本地配置优先（默认false）</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.override-none</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure><ul><li><strong><code>false</code>（默认）</strong>：Nacos配置覆盖本地配置。</li><li>**<code>true</code>**：本地配置优先，Nacos中的同名配置不生效。</li></ul><hr><h3 id="3-验证顺序"><a href="#3-验证顺序" class="headerlink" title="3. 验证顺序"></a><strong>3. 验证顺序</strong></h3><p>可以通过以下方式查看实际生效的配置：</p><ol><li><p><strong>检查<code>Environment</code>中的属性顺序</strong>：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> Environment env;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印所有PropertySource</span></span><br><span class="line">((AbstractEnvironment) env).getPropertySources().forEach(System.out::println);</span><br></pre></td></tr></table></figure><ul><li>输出中排名靠前的<code>PropertySource</code>优先级更高（如Nacos的配置通常以<code>NACOS</code>开头）。</li></ul></li><li><p><strong>直接获取配置值</strong>：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;your.config.key&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String configValue;</span><br></pre></td></tr></table></figure><p>观察实际注入的值是来自Nacos还是本地。</p></li></ol><hr><h3 id="4-动态刷新与本地配置"><a href="#4-动态刷新与本地配置" class="headerlink" title="4. 动态刷新与本地配置"></a><strong>4. 动态刷新与本地配置</strong></h3><ul><li>即使<code>Nacos</code>配置覆盖了本地配置，当<code>Nacos</code>中的配置<strong>动态更新</strong>时，应用也会实时生效（需配合<code>@RefreshScope</code>注解）。</li><li>本地<code>application.properties</code>的配置是静态的，启动后无法动态修改。</li></ul><hr><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h3><table><thead><tr><th align="left">场景</th><th align="left">生效配置</th></tr></thead><tbody><tr><td align="left">默认情况（<code>override-none=false</code>）</td><td align="left"><code>Nacos</code>配置优先</td></tr><tr><td align="left">显式设置<code>override-none=true</code></td><td align="left">本地<code>application.properties</code>优先</td></tr></tbody></table><h2 id="配置中心-数据隔离"><a href="#配置中心-数据隔离" class="headerlink" title="配置中心-数据隔离"></a>配置中心-数据隔离</h2><p>在企业研发过程中，通常需要在多个环境中进行开发、测试和部署，以确保生产环境的稳定性。<code>Nacos</code>提供了一种优雅的方式来实现环境隔离，确保不同环境的数据和配置互不干扰。</p><p>环境隔离的概念</p><p>环境是指一整套独立的系统，包括网关、服务框架、微服务注册中心、配置中心、消息系统、缓存、数据库等组件，用于处理特定类别的请求。环境隔离的主要目的是提高系统的可用性和稳定性，避免故障影响到整个系统。</p><p><code>Nacos</code>实现环境隔离的方法</p><p><code>Nacos</code>通过以下几种方式实现环境隔离：</p><ol><li><strong>网段划分</strong>：利用IP地址的网段划分不同的环境。例如，192.168.1.0&#x2F;24属于环境A，192.168.2.0&#x2F;24属于环境B。通过这种方式，不同网段的<code>Nacos</code>客户端会自动获取到不同的<code>Nacos</code>服务端IP列表，实现环境隔离。</li><li><strong>命名空间（Namespace）</strong>：命名空间用于进行租户粒度的配置隔离，不同的命名空间下可以存在相同的Group或Data ID的配置。在<code>Nacos</code>的管理界面中，可以创建新的命名空间，并在配置文件中指定命名空间ID，以实现配置的隔离。</li><li><strong>配置分组（Group）</strong>：通过配置分组，可以将不同环境的配置文件进行区分。例如，开发环境的配置文件可以使用Group&#x3D;DEV，测试环境的配置文件可以使用Group&#x3D;TEST。在配置文件中指定不同的Group，就能对应到不同的配置文件。</li></ol><p>步骤：</p><ol><li><p>在<code>Nacos</code>创建3个环境，分别为开发环境(<code>dev</code>)、测试环境(<code>test</code>)、生产环境(<code>prod</code>)</p></li><li><p><img src="/hexo-docs/images/alibabaImage/image-20250328215833735.png" alt="image-20250328215833735"></p></li><li><p>按照这个顺序创建</p><p><img src="/hexo-docs/images/alibabaImage/image-20250328215908057.png" alt="image-20250328215908057"></p></li><li><p><code>commont.properties</code>在<code>dev</code>环境下的配置文件，<code>prod</code>环境各加1，<code>test</code>环境各加2</p><p><img src="/hexo-docs/images/alibabaImage/image-20250328220316072.png" alt="image-20250328220316072"></p></li><li><p><code>database.properties</code>在<code>dev</code>环境下的配置文件，<code>prod</code>环境换成<code>order.db_url=order_prod</code>,<code>test</code>环境换成<code>order.db_url=order_test</code><img src="/hexo-docs/images/alibabaImage/image-20250328220602433.png" alt="image-20250328220602433"></p></li><li><p><code>common.properties</code>商品在<code>dev</code>环境下的配置文件，<code>prod</code>环境各加10，<code>test</code>环境各加10</p><p><img src="/hexo-docs/images/alibabaImage/image-20250328220908201.png" alt="image-20250328220908201"></p></li><li><p>结果</p><p><img src="/hexo-docs/images/alibabaImage/image-20250328221320164.png" alt="image-20250328221320164"></p><p><img src="/hexo-docs/images/alibabaImage/image-20250328221340427.png" alt="image-20250328221340427"></p><p><img src="/hexo-docs/images/alibabaImage/image-20250328221358203.png" alt="image-20250328221358203"></p><h2 id="读取nacos上的配置文件并显示"><a href="#读取nacos上的配置文件并显示" class="headerlink" title="读取nacos上的配置文件并显示"></a>读取<code>nacos</code>上的配置文件并显示</h2><p>配置文件</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment"># 激活那个环境</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service-order</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span> <span class="comment"># nacos 服务地址和端口号</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">$&#123;spring.profiles.active:dev&#125;</span> <span class="comment"># 要读取 nacos 的配置,默认为dev环境</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">nacos:common.properties?group=order</span> <span class="comment"># nacos 配置列表的名字</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">nacos:database.properties?group=order</span></span><br><span class="line">    <span class="attr">activate:</span></span><br><span class="line">      <span class="attr">on-profile:</span> <span class="string">dev</span> <span class="comment"># 动态激活判断，如果当前是 dev 环境才会生效</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:common.properties?group=order</span> <span class="comment"># nacos 配置列表的名字</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:database.properties?group=order</span></span><br><span class="line">    <span class="attr">activate:</span></span><br><span class="line">      <span class="attr">on-profile:</span> <span class="string">prod</span> <span class="comment"># 动态激活判断，如果当前是 prod 环境才会生效</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:common.properties?group=order</span> <span class="comment"># nacos 配置列表的名字</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:database.properties?group=order</span></span><br><span class="line">    <span class="attr">activate:</span></span><br><span class="line">      <span class="attr">on-profile:</span> <span class="string">test</span> <span class="comment"># 动态激活判断，如果当前是 test 环境才会生效</span></span><br></pre></td></tr></table></figure><p>实体类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;order&quot;)</span> <span class="comment">//配置批量绑定在nacos下，可以无需@RefreshScope就能实现自动刷新</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String timeout;</span><br><span class="line">    <span class="keyword">private</span> String autoConfirm;</span><br><span class="line">    <span class="keyword">private</span> String dbUrl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>controller</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderProperties orderProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/config&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">config</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;timeout=&quot;</span>+orderProperties.getTimeout()</span><br><span class="line">                +<span class="string">&quot;auto-confirm=&quot;</span>+orderProperties.getAutoConfirm()</span><br><span class="line">                +<span class="string">&quot;db-url=&quot;</span>+orderProperties.getDbUrl();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="/hexo-docs/images/alibabaImage/image-20250328225403518.png" alt="image-20250328225403518"></p><p>我们切换到<code>prod</code>环境下试试</p><p><img src="/hexo-docs/images/alibabaImage/image-20250328225446750.png" alt="image-20250328225446750"></p><p>发现我们已经成功了！</p><h2 id="Nacos拉取data-id的注意事项"><a href="#Nacos拉取data-id的注意事项" class="headerlink" title="Nacos拉取data-id的注意事项"></a><code>Nacos</code>拉取<code>data-id</code>的注意事项</h2><blockquote><p>在 Nacos Spring Cloud 中，<code>dataId</code> 的完整格式如下：</p><ul><li><code>prefix</code> 默认为 <code>spring.application.name</code> 的值，也可以通过配置项 <code>spring.cloud.nacos.config.prefix</code>来配置。</li><li><code>spring.profiles.active</code> 即为当前环境对应的 profile，详情可以参考 <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-profiles.html#boot-features-profiles">Spring Boot文档</a>。 <strong>注意：当 <code>spring.profiles.active</code> 为空时，对应的连接符 <code>-</code> 也将不存在，dataId 的拼接格式变成 <code>$&#123;prefix&#125;.$&#123;file-extension&#125;</code></strong></li><li><code>file-exetension</code> 为配置内容的数据格式，可以通过配置项 <code>spring.cloud.nacos.config.file-extension</code> 来配置。目前只支持 <code>properties</code> 和 <code>yaml</code> 类型。</li></ul></blockquote></li></ol><p>总结：先拉取不带后缀名的，类似于<code>data</code>在拉取代后缀名的，类似与<code>data.properties/yaml</code>最后拉取，带当前对应环境的<code>data.properties.dev</code></p><h2 id="从远程更换端口号"><a href="#从远程更换端口号" class="headerlink" title="从远程更换端口号"></a>从远程更换端口号</h2><ol><li><p>在<code>nacos</code>上创建好文件,和配置</p><p><img src="/hexo-docs/images/alibabaImage/image-20250328235251100.png" alt="image-20250328235251100"></p></li><li><p>在<code>application.yaml</code>中引用文件</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment"># 激活那个环境</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service-order</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span> <span class="comment"># nacos 服务地址和端口号</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">$&#123;spring.profiles.active:dev&#125;</span> <span class="comment"># 要读取 nacos 的配置,默认为dev环境</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">nacos:common.properties?group=order</span> <span class="comment"># nacos 配置列表的名字</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">nacos:database.properties?group=order</span></span><br><span class="line">    <span class="attr">activate:</span></span><br><span class="line">      <span class="attr">on-profile:</span> <span class="string">dev</span> <span class="comment"># 动态激活判断，如果当前是 dev 环境才会生效</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:common.properties?group=order</span> <span class="comment"># nacos 配置列表的名字</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:database.properties?group=order</span></span><br><span class="line">    <span class="attr">activate:</span></span><br><span class="line">      <span class="attr">on-profile:</span> <span class="string">prod</span> <span class="comment"># 动态激活判断，如果当前是 prod 环境才会生效</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:common.properties?group=order</span> <span class="comment"># nacos 配置列表的名字</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:database.properties?group=order</span></span><br><span class="line">    <span class="attr">activate:</span></span><br><span class="line">      <span class="attr">on-profile:</span> <span class="string">test</span> <span class="comment"># 动态激活判断，如果当前是 test 环境才会生效</span></span><br></pre></td></tr></table></figure></li><li><p>启动测试</p></li></ol><p><img src="/hexo-docs/images/alibabaImage/image-20250328235418981.png" alt="image-20250328235418981"></p><h2 id="Nacos集群配置和本地持久化配置"><a href="#Nacos集群配置和本地持久化配置" class="headerlink" title="Nacos集群配置和本地持久化配置"></a>Nacos集群配置和本地持久化配置</h2><h2 id="Nacos集群模式"><a href="#Nacos集群模式" class="headerlink" title="Nacos集群模式"></a>Nacos集群模式</h2><p>本部署手册是帮忙您快速在你的电脑上，下载安装并使用Nacos，部署生产使用的集群模式。</p><h3 id="集群部署架构图"><a href="#集群部署架构图" class="headerlink" title="集群部署架构图"></a>集群部署架构图</h3><p>无论采用何种部署方式，推荐用户把Nacos集群中所有服务节点放到一个vip下面，然后挂到一个域名下面。</p><p><code>&lt;http://ip1:port/openAPI&gt;</code> 直连ip模式，机器挂则需要修改ip才可以使用。</p><p><code>&lt;http://SLB:port/openAPI&gt;</code> 挂载SLB模式(内网SLB，不可暴露到公网，以免带来安全风险)，直连SLB即可，下面挂server真实ip，可读性不好。</p><p><code>&lt;http://nacos.com:port/openAPI&gt;</code> 域名 + SLB模式(内网SLB，不可暴露到公网，以免带来安全风险)，可读性好，而且换ip方便，推荐模式</p><p><img src="/hexo-docs/images/alibabaImage/deploy-dns-vip-mode.svg" alt="deployDnsVipMode.jpg"></p><p>在使用VIP时，需要开放Nacos服务的主端口(默认8848)以及gRPC端口(默认9848)、同时如果对Nacos的主端口有所修改的话，需要对vip中的端口映射作出配置，具体端口的映射方式参考<a href="https://nacos.io/docs/latest/manual/admin/deployment/deployment-overview/#1-Nacos%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84">部署手册概览-Nacos部署架构</a></p><h3 id="配置到mysql"><a href="#配置到mysql" class="headerlink" title="配置到mysql"></a>配置到mysql</h3><ol><li><p>安装数据库，版本要求：5.6.5+</p></li><li><p>新建<code>mysql-schema</code>库，把<code>nacos/conf</code>的<code>mysql-schema.sql</code>复制到数据库</p><ol><li><img src="/hexo-docs/images/alibabaImage/image-20250404174959032.png" alt="image-20250404174959032"></li><li><img src="/hexo-docs/images/alibabaImage/image-20250404175208957.png" alt="image-20250404175208957"></li></ol></li><li><p>修改配置文件</p><p><img src="/hexo-docs/images/alibabaImage/image-20250404175322497.png" alt="image-20250404175322497"></p><p><img src="/hexo-docs/images/alibabaImage/image-20250404175614989.png" alt="image-20250404175614989"></p></li><li><p>修改完重新启动</p><p><img src="/hexo-docs/images/alibabaImage/image-20250404175716337.png" alt="image-20250404175716337"></p><p>启动成功，没有报错，证明修改好了！创建一个配置文件，看看数据库上有没有</p><p><img src="/hexo-docs/images/alibabaImage/image-20250404175920495.png" alt="image-20250404175920495"></p><p>去mysql看看</p><p><img src="/hexo-docs/images/alibabaImage/image-20250404175942147.png" alt="image-20250404175942147"></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 后端 Spring Cloud Alibaba </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring Cloud </tag>
            
            <tag> Spring Cloud Alibaba </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloud Alibaba 第三章</title>
      <link href="/hexo-docs/2025/08/23/SpringCloud/alibaba/chapter03/"/>
      <url>/hexo-docs/2025/08/23/SpringCloud/alibaba/chapter03/</url>
      
        <content type="html"><![CDATA[<h1 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h1><h2 id="Sentinel-介绍"><a href="#Sentinel-介绍" class="headerlink" title="Sentinel 介绍"></a>Sentinel 介绍</h2><p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 是面向分布式、多语言异构化服务架构的流量治理组件，主要以流量为切入点，从流量路由、流量控制、流量整形、熔断降级、系统自适应过载保护、热点流量防护等多个维度来帮助开发者保障微服务的稳定性。</p><p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。<a href="https://sentinelguard.io/">Sentinel</a> 以流量为切入点，从流量控制、流量路由、熔断降级、系统自适应过载保护、热点流量防护等多个维度保护服务的稳定性。</p><p>Sentinel 具有以下特征:</p><ul><li><strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</li><li><strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</li><li><strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架&#x2F;库的整合模块，例如与 Spring Cloud、Apache Dubbo、gRPC、Quarkus 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。同时 Sentinel 提供 Java&#x2F;Go&#x2F;C++ 等多语言的原生实现。</li><li><strong>完善的 SPI 扩展机制</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</li></ul><p><img src="/hexo-docs/images/alibabaImage/image.png" alt="image-20250329155245335"></p><h2 id="架构原理"><a href="#架构原理" class="headerlink" title="架构原理"></a>架构原理</h2><p><img src="/hexo-docs/images/alibabaImage/1735526575167-31e5bca5-ba78-48da-b248-ebbeafff8c03.png" alt="img"></p><h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><p><a href="https://sentinelguard.io/zh-cn/docs/basic-implementation.html">Sentinel工作流程</a></p><h2 id="资源-规则"><a href="#资源-规则" class="headerlink" title="资源&amp;规则"></a>资源&amp;规则</h2><p>定义资源：</p><ul><li>主流框架自动适配（Web Servlet、Dubbo、Spring Cloud、gRPC、Spring WebFlux、Reactor）；所有Web接口均为资源</li><li>编程式：SphU API</li><li>声明式：@SentinelResource</li></ul><p>定义规则：</p><ul><li>流量控制规则</li><li>熔断降级规则</li><li>系统保护规则</li><li>来源访问控制规则</li><li>热点参数规则</li></ul><p><img src="/hexo-docs/images/alibabaImage/1735532694911-6d15ba90-0852-4116-be85-a1bcdaa94d11.png" alt="img"></p><h2 id="整合sentinel"><a href="#整合sentinel" class="headerlink" title="整合sentinel"></a>整合<code>sentinel</code></h2><p>下载<a href="https://github.com/alibaba/Sentinel">Sentinel</a></p><ol><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>配置文件</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span></span><br><span class="line">      <span class="attr">eager:</span> <span class="literal">true</span> <span class="comment"># sentinel 进行提前加载，不然访问不到 sentinel</span></span><br></pre></td></tr></table></figure></li><li><p>启动下载好的<code>jar</code>包</p><p>通过 <code>java -jar jar包名字</code></p><p><img src="/hexo-docs/images/alibabaImage/image-20250329162622483.png" alt="image-20250329162622483"></p><p>默认什么也没有</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329162714931.png" alt="image-20250329162714931"></p></li><li><p>启动服务，再刷新一下，发现可以正常访问了！</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329162946630.png" alt="image-20250329162946630"></p></li><li><p>设置流控规则，每秒最多可以发生1个请求</p><ol><li><p>添加保护资源注解</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderOpenFeignClient orderOpenFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;createOrder&quot;)</span> <span class="comment">// 设置addOrder是sentinel的资源</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">addOrder</span><span class="params">(Long userId, Long productId)</span> &#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> orderOpenFeignClient.getProduct(productId);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">price</span> <span class="operator">=</span> product.getPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(product.getNum()));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Order</span>(userId, price, productId, <span class="string">&quot;河北&quot;</span>, List.of(product));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>我们对<code>addOrder</code>设置保护规则，允许一秒只能发送一个请求</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329164924802.png" alt="image-20250329164924802"></p></li><li><p>如果我们一秒发送了两个请求，会显示</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329164802832.png" alt="image-20250329164802832"></p></li></ol></li></ol><p>如果我们想定义<code>code,data</code>那样的数据，需要实现<code>BlockExceptionHandler</code>，去重写里面的方法</p><h3 id="1-实现BlockExceptionHandler处理异常"><a href="#1-实现BlockExceptionHandler处理异常" class="headerlink" title="1.实现BlockExceptionHandler处理异常"></a>1.实现<code>BlockExceptionHandler</code>处理异常</h3><ol><li><p>在<code>model</code>添加公用返回的格式<code>R</code>实体类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.common;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">R</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">ok</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">R</span>(<span class="number">200</span>, <span class="string">&quot;ok&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">ok</span><span class="params">(Object data)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">R</span>(<span class="number">200</span>, <span class="string">&quot;ok&quot;</span>, data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">error</span><span class="params">(Integer code, String msg)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">R</span>(code, msg, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">error</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">R</span>(<span class="number">500</span>, <span class="string">&quot;error&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>编写<code>MyBlockExceptionHandler</code>去实现<code>BlockExceptionHandler</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.exception;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBlockExceptionHandler</span> <span class="keyword">implements</span> <span class="title class_">BlockExceptionHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, String s, BlockException e)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpServletResponse.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>); <span class="comment">//设置响应编码格式，一定要设置在第一行，不然不生效</span></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> httpServletResponse.getWriter();</span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">R</span>();</span><br><span class="line">        r.setCode(<span class="number">500</span>);</span><br><span class="line">        r.setMsg(s+<span class="string">&quot;被sentinel限制了，原因&quot;</span>+e.getClass());</span><br><span class="line">        writer.write(objectMapper.writeValueAsString(r));</span><br><span class="line">        writer.flush(); <span class="comment">// 刷新数据</span></span><br><span class="line">        writer.close(); <span class="comment">// 关闭 PrintWriter</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>运行测试，因为我们的<code>sentinel</code>是在内存中存放的，我们重启服务后需要重新去定义流控规则</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329171632965.png" alt="image-20250329171632965"></p></li><li><p>点击新增，再试试</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329171811360.png" alt="image-20250329171811360"></p></li></ol><h3 id="2、自定义处理异常"><a href="#2、自定义处理异常" class="headerlink" title="2、自定义处理异常"></a>2、自定义处理异常</h3><p><img src="/hexo-docs/images/alibabaImage/image-20250329173136872.png" alt="image-20250329173136872"></p><p>如果我们给<code>createOrder</code>添加流控规则后</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329175604173.png" alt="image-20250329175604173"></p><p>会提示</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329175637737.png" alt="image-20250329175637737"></p><p><code>springboot</code>的默认错误，但我们想要使用兜底操作，怎么办？</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;createOrder&quot;,blockHandler = &quot;addOrderFallBack&quot;)</span> <span class="comment">// blockHandler 添加兜底操作，兜底操作的方法名</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">addOrder</span><span class="params">(Long userId, Long productId)</span> &#123;</span><br><span class="line"><span class="comment">//        Product product = getProductFormRemoteWithLoadBalanceAnnotation(productId);</span></span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> orderOpenFeignClient.getProduct(productId);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">price</span> <span class="operator">=</span> product.getPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(product.getNum()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Order</span>(userId, price, productId, <span class="string">&quot;河北&quot;</span>, List.of(product));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">addOrderFallBack</span><span class="params">(Long userId, Long productId, BlockException exception)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Order</span>(<span class="number">0L</span>, <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0&quot;</span>), productId, <span class="string">&quot;未知地址&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们在运行测试一下，我们给<code>createOrder</code>添加流控规则</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329180015974.png" alt="image-20250329180015974"></p><p><img src="/hexo-docs/images/alibabaImage/image-20250329180025251.png" alt="image-20250329180025251"></p><p>官网解释：</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329172755125.png" alt="image-20250329172755125"></p><h3 id="3、OpenFeign异常"><a href="#3、OpenFeign异常" class="headerlink" title="3、OpenFeign异常"></a>3、OpenFeign异常</h3><p>当我们给<code>GET:http://service-product/product/&#123;productId&#125;</code>添加异常看看，这个会走那个兜底回调</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329180715347.png" alt="image-20250329180715347"></p><p><img src="/hexo-docs/images/alibabaImage/image-20250329180909214.png" alt="image-20250329180909214"></p><p>可以看出他是调用我们的第二个方法(自定义处理异常)，假如第二个没有了，看看他会调用那个</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.feign.fallback;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderOpenFeignClientFallBack</span> <span class="keyword">implements</span> <span class="title class_">OrderOpenFeignClient</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProduct</span><span class="params">(Long productId)</span> &#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>(productId,<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0&quot;</span>),<span class="string">&quot;未知商品&quot;</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/alibabaImage/image-20250329181705929.png" alt="image-20250329181705929"></p><h2 id="流量控制（FlowRule）"><a href="#流量控制（FlowRule）" class="headerlink" title="流量控制（FlowRule）"></a>流量控制（<code>FlowRule</code>）</h2><p><img src="/hexo-docs/images/alibabaImage/image-20250329185331021.png" alt="image-20250329185331021"></p><h3 id="阈值类型"><a href="#阈值类型" class="headerlink" title="阈值类型"></a>阈值类型</h3><p>QPS：统计每秒请求数</p><p>并发线程数：统计并发线程数</p><h3 id="流控模式"><a href="#流控模式" class="headerlink" title="流控模式"></a>流控模式</h3><p><img src="/hexo-docs/images/alibabaImage/image-20250329185953573.png" alt="image-20250329185953573"></p><p>调用关系包括调用方、被调用方，一个方法又可能会调用其他方法，形成一个调用链路的层次关系。有了调用链路的统计信息，我们可以衍生出多种流量控制手段</p><p><img src="/hexo-docs/images/alibabaImage/1735966975246-494ea585-e2cc-4ee9-a285-9fc3e0e2de43.png" alt="img"></p><h4 id="链路模式"><a href="#链路模式" class="headerlink" title="链路模式"></a>链路模式</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/seckill&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">seckill</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;userId&quot;)</span> Long userId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;productId&quot;)</span> Long productId</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderServiceImpl.addOrder(userId, productId);</span><br><span class="line">        order.setId(Long.MAX_VALUE); <span class="comment">// Long的最大值</span></span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置文件</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment"># 激活那个环境</span></span><br><span class="line">    <span class="attr">include:</span> <span class="string">feign</span> <span class="comment"># 包含那个</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service-order</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span> <span class="comment"># nacos 服务地址和端口号</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">$&#123;spring.profiles.active:dev&#125;</span> <span class="comment"># 要读取 nacos 的配置,默认为dev环境</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">web-context-unify:</span> <span class="literal">false</span> <span class="comment"># 关闭上下文统一</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span></span><br><span class="line">      <span class="attr">eager:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>启动测试，正常我们访问<code>localhost:8000/addOrder?userId=1&amp;productId=100</code>是可以访问的,我们修改为链路策略再试试</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329191014773.png" alt="image-20250329191014773"></p><p>我们新增的规则在<code>addOrder</code>新增的链路规则，入口资源为<code>/seckill</code>请求</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329191841473.png" alt="image-20250329191841473"></p><p>如果一秒两次访问<code>seckill</code>请求，会显示，看着对,<code>order</code>请求生效，实际上是对<code>/seckill</code>请求生效</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329191937396.png" alt="image-20250329191937396"></p><p>一秒2次访问<code>/addOrder</code>请求不影响</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329192149155.png" alt="image-20250329192149155"></p><h4 id="关联模式"><a href="#关联模式" class="headerlink" title="关联模式"></a>关联模式</h4><p>​针对与我们的读写的时候，如果写的访问资源特别大，那么我们的读就被限制了</p><p>步骤：</p><ol><li><p>在<code>controller</code>类上写两个方法，分别是<code>writeDb</code>和<code>readDb</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/writeDb&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">writeDb</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;writeDb success...&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/readDb&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">readDb</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;readDb success...&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>启动运行一下</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329212932427.png" alt="image-20250329212932427"></p><p>然后我们疯狂刷新，<code>/writeDb</code>，在刷新一下<code>/readDb</code>,就出现</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329213106344.png" alt="image-20250329213106344"></p></li></ol><h3 id="流控效果"><a href="#流控效果" class="headerlink" title="流控效果"></a>流控效果</h3><p><img src="/hexo-docs/images/alibabaImage/image-20250329215935850.png" alt="image-20250329215935850"></p><blockquote><p>注意：</p><p>​只有快速失败支持流控模式（直接、关联、链路）的设置</p></blockquote><p><img src="/hexo-docs/images/alibabaImage/1735966998917-bd864bb8-eea8-43e8-abe7-f9ea3c21fbb6.png" alt="img"></p><h4 id="快速失败"><a href="#快速失败" class="headerlink" title="快速失败"></a>快速失败</h4><p>快速失败，就是如果没有超过阈值就通过，如果超过阈值就抛出异常</p><p>官方解释：</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330151421754.png" alt="image-20250330151421754"></p><h4 id="warm-up"><a href="#warm-up" class="headerlink" title="warm up"></a>warm up</h4><p>比如说设置的是20个，刚开始每秒3个，每秒5个，逐增到设置的峰值20个，让系统逐步的增加处理能力，以适应突然来的高峰请求</p><p>官方解释：</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330151452740.png" alt="image-20250330151452740"></p><p>示例：</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330144919022.png" alt="image-20250330144919022"></p><p>可以看出他是逐渐涨到10个的</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330145506253.png" alt="image-20250330145506253"></p><h4 id="排队等待"><a href="#排队等待" class="headerlink" title="排队等待"></a>排队等待</h4><blockquote><p>注意：</p><p>​QPS&#x3D;2，每秒2个，则500ms 1个，剩下的就排队等待，如果超出了timeout&#x3D;20s，就排队失败，排队失败的请求也会被丢弃，不支持QPS&gt;1000 ,如果QPS&gt;1000 精度就失效了</p></blockquote><p>官方解释：</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330151534868.png" alt="image-20250330151534868"></p><p><img src="/hexo-docs/images/alibabaImage/image-20250330150538661.png" alt="image-20250330150538661"></p><p><img src="/hexo-docs/images/alibabaImage/image-20250330151059864.png" alt="image-20250330151059864"></p><p>匀速排队在底层还会用到漏桶算法</p><h5 id="漏桶算法"><a href="#漏桶算法" class="headerlink" title="漏桶算法"></a>漏桶算法</h5><p>漏桶算法，又称 leaky bucket。</p><p>为了理解漏桶算法，我们看一下对于该算法的示意图：</p><p><img src="/hexo-docs/images/alibabaImage/bVdeApa.png" alt="image"></p><p>从图中我们可以看到，整个算法其实十分简单。首先，我们有一个固定容量的桶，有水流进来，也有水流出去。</p><p>对于流进来的水来说，我们无法预计一共有多少水会流进来，也无法预计水流的速度。但是对于流出去的水来说，这个桶可以固定水流出的速率。而且，当桶满了之后，多余的水将会溢出。</p><p>我们将算法中的水换成实际应用中的请求，我们可以看到漏桶算法天生就限制了请求的速度。当使用了漏桶算法，我们可以保证接口会以一个常速速率来处理请求。</p><p>所以漏桶算法天生<strong>不会出现临界问题</strong>。</p><p>漏桶算法可以粗略的认为就是注水漏水过程，往桶中以一定速率流出水，以任意速率流入水，当水超过桶流量则丢弃，因为桶容量是不变的，保证了整体的速率。</p><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>只有快速失败，支持直接、关联、链路模式。warm up和排队等待只支持直接模式，不支持关联、链路模式</p><h2 id="熔断降级-DegradeRule-防止雪崩效应"><a href="#熔断降级-DegradeRule-防止雪崩效应" class="headerlink" title="熔断降级(DegradeRule)-防止雪崩效应"></a>熔断降级(<code>DegradeRule</code>)-防止雪崩效应</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>除了流量控制以外，对调用链路中不稳定的资源进行熔断降级也是保障高可用的重要措施之一。一个服务常常会调用别的模块，可能是另外的一个远程服务、数据库，或者第三方 API 等。例如，支付的时候，可能需要远程调用银联提供的 API；查询某个商品的价格，可能需要进行数据库查询。然而，这个被依赖服务的稳定性是不能保证的。如果依赖的服务出现了不稳定的情况，请求的响应时间变长，那么调用服务的方法的响应时间也会变长，线程会产生堆积，最终可能耗尽业务自身的线程池，服务本身也变得不可用。</p><p><img src="/hexo-docs/images/alibabaImage/c618644.png" alt="chain"></p><p>现代微服务架构都是分布式的，由非常多的服务组成。不同服务之间相互调用，组成复杂的调用链路。以上的问题在链路调用中会产生放大的效果。复杂链路上的某一环不稳定，就可能会层层级联，最终导致整个链路都不可用。因此我们需要对不稳定的<strong>弱依赖服务调用</strong>进行熔断降级，暂时切断不稳定调用，避免局部不稳定因素导致整体的雪崩。熔断降级作为保护自身的手段，通常在客户端（调用端）进行配置。</p><h3 id="熔断策略"><a href="#熔断策略" class="headerlink" title="熔断策略"></a>熔断策略</h3><p>Sentinel 提供以下几种熔断策略：</p><ul><li>慢调用比例 (<code>SLOW_REQUEST_RATIO</code>)：选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则会再次被熔断。</li><li>异常比例 (<code>ERROR_RATIO</code>)：当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。异常比率的阈值范围是 <code>[0.0, 1.0]</code>，代表 0% - 100%。</li><li>异常数 (<code>ERROR_COUNT</code>)：当单位统计时长内的异常数目超过阈值之后会自动进行熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。</li></ul><blockquote><p>注意:</p><p>​异常降级<strong>仅针对业务异常</strong>，对 Sentinel 限流降级本身的异常（<code>BlockException</code>）不生效。为了统计异常比例或异常数，需要通过 <code>Tracer.trace(ex)</code> 记录业务异常。</p></blockquote><h4 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h4><p><img src="/hexo-docs/images/alibabaImage/image-20250330154607283.png" alt="image-20250330154607283"></p><h4 id="慢调用比例"><a href="#慢调用比例" class="headerlink" title="慢调用比例"></a>慢调用比例</h4><p>实例：</p><p><code>service-order</code>不变，<code>service-product</code>,<code>controller</code>添加睡眠时长为2s</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ProductService productService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/product/&#123;productId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProduct</span><span class="params">(<span class="meta">@PathVariable(&quot;productId&quot;)</span> Long productId, HttpServletRequest request)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;productController====&quot;</span>+request.getHeader(<span class="string">&quot;x-token&quot;</span>));</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> productService.addProduct(productId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最少请求为5个！</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330155929585.png" alt="image-20250330155929585"></p><p>进入熔断机制了</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330160027142.png" alt="image-20250330160027142"></p><p>熔断时长为30s，如果过了30s，后就恢复正常了！</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330160129365.png" alt="image-20250330160129365"></p><h4 id="异常比例"><a href="#异常比例" class="headerlink" title="异常比例"></a>异常比例</h4><p> 异常比例 (ERROR_RATIO)：当单位统计时长（statIntervalMs）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。异常比率的阈值范围是 [0.0, 1.0]，代表 0% - 100%。</p><p>有熔断规则和无熔断规则的区别</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330164243700.png" alt="image-20250330164243700"></p><p>测试</p><ol><li><p><code>service-product</code>的<code>controller</code>类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ProductService productService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/product/&#123;productId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProduct</span><span class="params">(<span class="meta">@PathVariable(&quot;productId&quot;)</span> Long productId, HttpServletRequest request)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">10</span>/<span class="number">0</span>;<span class="comment">//异常</span></span><br><span class="line">        System.out.println(<span class="string">&quot;productController====&quot;</span>+request.getHeader(<span class="string">&quot;x-token&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> productService.addProduct(productId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>启动运行</p><p>触发了兜底回调</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330163646534.png" alt="image-20250330163646534"></p></li><li><p>添加异常比例</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330164207732.png" alt="image-20250330164207732"></p></li><li><p>疯狂刷新</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330164522960.png" alt="image-20250330164522960"></p><p>直接触发兜底回调，<code>service-product</code>和<code>service-order</code>不会被打印</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330164624427.png" alt="image-20250330164624427"></p><p><img src="/hexo-docs/images/alibabaImage/image-20250330164632562.png" alt="image-20250330164632562"></p></li></ol><h4 id="异常数"><a href="#异常数" class="headerlink" title="异常数"></a>异常数</h4><p>异常数，就是在N秒内发送的请求，有多少个异常，就触发熔断，前提是有个最小请求次数</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330164813025.png" alt="image-20250330164813025"></p><p>基于异常比例的代码，测试。先疯狂刷新10次，再刷新看看是否触发兜底回调</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330165156682.png" alt="image-20250330165156682"></p><p>没有打印异常，触发了兜底回调，30s内不会再发请求</p><h2 id="热点参数限流"><a href="#热点参数限流" class="headerlink" title="热点参数限流"></a>热点参数限流</h2><h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>何为热点？热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的 Top K 数据，并对其访问进行限制。比如：</p><ul><li>商品 ID 为参数，统计一段时间内最常购买的商品 ID 并进行限制</li><li>用户 ID 为参数，针对一段时间内频繁访问的用户 ID 进行限制</li></ul><p>热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效。</p><p><img src="/hexo-docs/images/alibabaImage/sentinel-hot-param-overview-1.png" alt="Sentinel Parameter Flow Control"></p><p>Sentinel 利用 LRU 策略统计最近最常访问的热点参数，结合令牌桶算法来进行参数级别的流控。</p><p>环境搭建<code>service-order</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderServiceImpl orderServiceImpl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/seckill&quot;)</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;seckill-order&quot;,fallback = &quot;seckillFallback&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">seckill</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(value = &quot;userId&quot;,defaultValue = &quot;666&quot;)</span> Long userId,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(value = &quot;productId&quot;,defaultValue = &quot;888&quot;)</span> Long productId</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderServiceImpl.addOrder(userId, productId);</span><br><span class="line">        order.setId(Long.MAX_VALUE); <span class="comment">// Long的最大值</span></span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">seckillFallback</span><span class="params">(Long userId, Long productId, BlockException exception)</span> &#123;</span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderServiceImpl.addOrder(userId, productId);</span><br><span class="line">        order.setId(productId);</span><br><span class="line">        order.setUserId(userId);</span><br><span class="line">        order.setAddress(<span class="string">&quot;异常信息：&quot;</span>+exception.getClass());</span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>service-product</code>去除<code>int i =10/0</code></p><p><img src="/hexo-docs/images/alibabaImage/image-20250330171613263.png" alt="image-20250330171613263"></p><p>如果带了<code>userId</code>会被限流</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330172007931.png" alt="image-20250330172007931"></p><p>如果不带<code>userId</code>,不会被限流</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/seckill&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;seckill-order&quot;,fallback = &quot;seckillFallback&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">seckill</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;userId&quot;,required = false)</span> Long userId,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;productId&quot;,defaultValue = &quot;888&quot;)</span> Long productId</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderServiceImpl.addOrder(userId, productId);</span><br><span class="line">    order.setId(Long.MAX_VALUE); <span class="comment">// Long的最大值</span></span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">seckillFallback</span><span class="params">(Long userId, Long productId, BlockException exception)</span> &#123;</span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderServiceImpl.addOrder(userId, productId);</span><br><span class="line">    order.setId(productId);</span><br><span class="line">    order.setUserId(userId);</span><br><span class="line">    order.setAddress(<span class="string">&quot;异常信息：&quot;</span>+exception.getClass());</span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/alibabaImage/image-20250330172123268.png" alt="image-20250330172123268"></p><p>假如<code>userId</code>为6的是vip用户，不被限流，最后点击添加</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330172605080.png" alt="image-20250330172605080"></p><p>然后疯狂刷新，可以看到未被限制</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330172817597.png" alt="image-20250330172817597"></p><p>商品666是下架商品，不允许被访问</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330173040483.png" alt="image-20250330173040483"></p><p>限制666商品，不允许被访问</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330173154939.png" alt="image-20250330173154939"></p><p><img src="/hexo-docs/images/alibabaImage/image-20250330173211741.png" alt="image-20250330173211741"></p><p>上面的是<code>SpringBoot</code>默认的错误，我们不使用默认的错误</p><ol><li><p><code>blockHandler</code></p><ol><li><p>代码</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/seckill&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;seckill-order&quot;,blockHandler = &quot;seckillFallback&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">seckill</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;userId&quot;,required = false)</span> Long userId,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;productId&quot;,defaultValue = &quot;888&quot;)</span> Long productId</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderServiceImpl.addOrder(userId, productId);</span><br><span class="line">    order.setId(Long.MAX_VALUE); <span class="comment">// Long的最大值</span></span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">seckillFallback</span><span class="params">(Long userId, Long productId, BlockException exception)</span> &#123;</span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderServiceImpl.addOrder(userId, productId);</span><br><span class="line">    order.setId(productId);</span><br><span class="line">    order.setUserId(userId);</span><br><span class="line">    order.setAddress(<span class="string">&quot;异常信息：&quot;</span>+exception.getClass());</span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>省略添加热点规则<br><img src="/hexo-docs/images/alibabaImage/image-20250330173625241.png"></p></li></ol></li><li><p><code>fallback</code></p><ol><li><p>代码</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/seckill&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;seckill-order&quot;,fallback = &quot;seckillFallback&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">seckill</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;userId&quot;,required = false)</span> Long userId,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;productId&quot;,defaultValue = &quot;888&quot;)</span> Long productId</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderServiceImpl.addOrder(userId, productId);</span><br><span class="line">    order.setId(Long.MAX_VALUE); <span class="comment">// Long的最大值</span></span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">seckillFallback</span><span class="params">(Long userId, Long productId, Throwable exception)</span> &#123;</span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderServiceImpl.addOrder(userId, productId);</span><br><span class="line">    order.setId(productId);</span><br><span class="line">    order.setUserId(userId);</span><br><span class="line">    order.setAddress(<span class="string">&quot;异常信息：&quot;</span>+exception.getClass());</span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>省略添加热点规则<br><img src="/hexo-docs/images/alibabaImage/image-20250330173904612.png" alt="image-20250330173904612"></p></li></ol></li></ol>]]></content>
      
      
      <categories>
          
          <category> 后端 Spring Cloud Alibaba </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring Cloud </tag>
            
            <tag> Spring Cloud alibaba </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloud Alibaba 第二章</title>
      <link href="/hexo-docs/2025/08/23/SpringCloud/alibaba/chapter02/"/>
      <url>/hexo-docs/2025/08/23/SpringCloud/alibaba/chapter02/</url>
      
        <content type="html"><![CDATA[<h1 id="OpenFeign"><a href="#OpenFeign" class="headerlink" title="OpenFeign"></a><code>OpenFeign</code></h1><p><code>OpenFeign</code>客户端是一个web声明式http远程调用工具，直接可以根据服务名称去注册中心拿到指定的服务<code>IP</code>集合，提供了接口和注解方式进行调用，内嵌集成了Ribbon本地负载均衡器。</p><h2 id="feign和OpenFeign的区别"><a href="#feign和OpenFeign的区别" class="headerlink" title="feign和OpenFeign的区别"></a><code>feign</code>和<code>OpenFeign</code>的区别</h2><p>1、底层都是内置了Ribbon，去调用注册中心的服务。<br>2、Feign是<code>Netflix</code>公司写的，是SpringCloud组件中的一个轻量级RESTful的HTTP服务客户端，是SpringCloud中的第一代负载均衡客户端。<br>3、OpenFeign是SpringCloud自己研发的，在Feign的基础上支持了Spring MVC的注解，如@RequesMapping等等。是SpringCloud中的第二代负载均衡客户端。<br>4、Feign本身不支持Spring MVC的注解，使用Feign的注解定义接口，调用这个接口，就可以调用服务注册中心的服务<br>5、OpenFeign的@FeignClient可以解析SpringMVC的@RequestMapping注解下的接口，并通过动态代理的方式产生实现类，实现类中做负载均衡并调用其他服务。</p><h2 id="Springcloud-alibaba集成OpenFeign"><a href="#Springcloud-alibaba集成OpenFeign" class="headerlink" title="Springcloud alibaba集成OpenFeign"></a><code>Springcloud alibaba集成OpenFeign</code></h2><h3 id="业务API"><a href="#业务API" class="headerlink" title="业务API"></a>业务API</h3><ol><li><p>在<code>service</code>下引入依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在<code>service-order</code>下类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.feign;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(&quot;service-product&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderOpenFeignClient</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/product/&#123;productId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProduct</span><span class="params">(<span class="meta">@PathVariable(&quot;productId&quot;)</span> Integer productId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>serviceImpl</code>层，其他的不变</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderOpenFeignClient orderOpenFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">addOrder</span><span class="params">(Long userId, Long productId)</span> &#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> orderOpenFeignClient.getProduct(productId);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">price</span> <span class="operator">=</span> product.getPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(product.getNum()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Order</span>(userId, price, productId, <span class="string">&quot;河北&quot;</span>, List.of(product));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>主启动类上添加<code>@EnableFeignClients</code></p></li><li><p>启动<code>service-order</code>服务和<code>service-product</code>，测试一下</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329124113893.png" alt="image-20250329124113893"></p></li></ol><h3 id="远程调用-业务API（第三方API）"><a href="#远程调用-业务API（第三方API）" class="headerlink" title="远程调用-业务API（第三方API）"></a>远程调用-业务API（第三方API）</h3><ol><li><p>引入<code>OpenFeign</code>依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>编写<code>feignClient</code>接口</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.feign;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * url 为请求的网址</span></span><br><span class="line"><span class="comment"> * value 因为不是本底的，随便起的名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;hot-client&quot;,url = &quot;https://whyta.cn&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HotOpenFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 网址需要请求的参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回今日头条热搜榜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/api/toutiao&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTou</span><span class="params">(<span class="meta">@RequestParam(&quot;key&quot;)</span> String key)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在主启动类上添加<code>@EnableFeignClients</code>注解</p></li><li><p>在测试类上测试</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotOpenFeignClientTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HotOpenFeignClient hotOpenFeignClient;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(hotOpenFeignClient.getTou(<span class="string">&quot;36de5db81215&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>结果</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329132341658.png" alt="image-20250329132341658"></p></li></ol><h2 id="客户端负载均衡和服务端负载均衡的区别"><a href="#客户端负载均衡和服务端负载均衡的区别" class="headerlink" title="客户端负载均衡和服务端负载均衡的区别"></a>客户端负载均衡和服务端负载均衡的区别</h2><p><img src="/hexo-docs/images/alibabaImage/image-20250329133059782.jpeg" alt="image-20250329133059782"></p><p>服务端的负载均衡是一个url先经过一个代理服务器（这里是nginx），然后通过这个代理服务器通过算法（轮询，随机，权重等等）反向代理你的服务，来完成负载均衡。<br>而客户端的负载均衡则是一个请求在客户端的时候已经通过eureka获取了要调用服务的集群信息，然后通过具体的负载均衡算法来完成调用具体某个服务。<br>简而言之，服务端负载均衡需要先经过nginx代理服务器才能知道调用服务的集群信息。而客户端负载均衡请求在客户端的时候就已经知道了调用服务的集群信息。</p><h3 id="关键对比总结"><a href="#关键对比总结" class="headerlink" title="关键对比总结"></a><strong>关键对比总结</strong></h3><table><thead><tr><th align="left"><strong>维度</strong></th><th align="left"><strong>客户端负载均衡</strong></th><th align="left"><strong>服务端负载均衡</strong></th></tr></thead><tbody><tr><td align="left"><strong>决策位置</strong></td><td align="left">客户端</td><td align="left">独立的负载均衡器（代理层）</td></tr><tr><td align="left"><strong>性能</strong></td><td align="left">更优（无中间跳转）</td><td align="left">略低（需经过代理）</td></tr><tr><td align="left"><strong>复杂度</strong></td><td align="left">客户端逻辑复杂</td><td align="left">客户端无需感知负载逻辑</td></tr><tr><td align="left"><strong>服务发现</strong></td><td align="left">强依赖（如Eureka）</td><td align="left">可选（如Nginx手动配置或结合DNS）</td></tr><tr><td align="left"><strong>多语言支持</strong></td><td align="left">差（需各语言实现）</td><td align="left">好（客户端透明）</td></tr><tr><td align="left"><strong>典型工具</strong></td><td align="left">Ribbon、Spring Cloud LoadBalancer</td><td align="left">Nginx、HAProxy、AWS ELB</td></tr></tbody></table><h2 id="OpenFeign日志"><a href="#OpenFeign日志" class="headerlink" title="OpenFeign日志"></a>OpenFeign日志</h2><p><img src="/hexo-docs/images/alibabaImage/image-20250329134927000.png" alt="image-20250329134927000"></p><p>如何开启日志</p><ol><li><p>添加配置文件，配置日志</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.lazy.cloud.feign:</span> <span class="string">debug</span> <span class="comment"># com.lazy.cloud.feign包名，可以精确到类名，debug级别</span></span><br></pre></td></tr></table></figure></li><li><p>添加<code>@Bean</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FooConfiguration</span> &#123;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line">Logger.Level <span class="title function_">feignLoggerLevel</span><span class="params">()</span> &#123; <span class="comment">//Logger一定要导入 feign包下的</span></span><br><span class="line"><span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/alibabaImage/image-20250329135316724.png" alt="image-20250329135316724"></p></li><li><p>测试</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329135518987.png" alt="image-20250329135518987"></p></li></ol><h2 id="超时控制"><a href="#超时控制" class="headerlink" title="超时控制"></a>超时控制</h2><p>如果商品服务一直连接不上，或<code>API</code>读取慢，或读不到，有可能会造成服务雪崩的问题，针对这个问题我们要使用超时控制来解决！</p><p>我们引入超时控制，来解决这个问题，我们设置上请求多少秒，为超时，如果超时，会返回“网络繁忙”，或者“兜底数据”，兜底数据，需要结合<code>Sentinel </code>来实现，以我们现在的技术只能返回”网络繁忙”</p><p>超时分两种<code>connectTimeout(超时控制，默认为10秒)</code>和<code>readTimeout(读取超时，默认为60秒)</code>我们可以通过配置修改它的超时时间</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329142157162.png" alt="image-20250329142157162"></p><p><code>application.yml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment"># 激活那个环境</span></span><br><span class="line">    <span class="attr">include:</span> <span class="string">feign</span> <span class="comment"># 包含feign</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service-order</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span> <span class="comment"># nacos 服务地址和端口号</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.lazy.cloud.feign:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure><p><code>application-feign.yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">openfeign:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">config:</span></span><br><span class="line">          <span class="attr">default:</span> <span class="comment"># 默认配置</span></span><br><span class="line">            <span class="attr">read-timeout:</span> <span class="number">3000</span> <span class="comment"># 读取时间为3秒</span></span><br><span class="line">            <span class="attr">connect-timeout:</span> <span class="number">2000</span> <span class="comment"># 连接时间</span></span><br><span class="line">          <span class="attr">service-product:</span></span><br><span class="line">            <span class="attr">read-timeout:</span> <span class="number">5000</span></span><br><span class="line">            <span class="attr">connect-timeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure><p>修改<code>service-product</code>项目的<code>controller</code>类，让他睡上20秒</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">package</span> <span class="string">com.lazy.cloud.controller;</span></span><br><span class="line"></span><br><span class="line"><span class="string">@RestController</span></span><br><span class="line"><span class="string">public</span> <span class="string">class</span> <span class="string">ProductController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="string">@Resource</span></span><br><span class="line">    <span class="string">private</span> <span class="string">ProductService</span> <span class="string">productService;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">@GetMapping(&quot;/product/</span>&#123;<span class="string">productId</span>&#125;<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    public Product getProduct(@PathVariable(&quot;</span><span class="string">productId&quot;)</span> <span class="string">Long</span> <span class="string">productId)</span> <span class="string">throws</span> <span class="string">InterruptedException</span> &#123;</span><br><span class="line">        <span class="string">TimeUnit.SECONDS.sleep(20);</span></span><br><span class="line">        <span class="string">System.out.println(&quot;productController&quot;);</span></span><br><span class="line">        <span class="string">return</span> <span class="string">productService.addProduct(productId);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>启动测试一下</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329142655489.png" alt="image-20250329142655489"></p><p>使用默认配置再试试</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329142747168.png" alt="image-20250329142747168"></p><h2 id="重试机制"><a href="#重试机制" class="headerlink" title="重试机制"></a>重试机制</h2><p>远程调用超时失败后，还可以进行多次尝试，如果某次返回ok，如果多次依然失败则结束调用，返回错误</p><p>但是<code>OpenFeign</code>,默认没有使用重试机制</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329143126800.png" alt="image-20250329143126800"></p><p>默认重试器，间隔100毫秒，最大间隔1秒，默认重试5次</p><p>因为第一次重试是100毫秒，第二次间隔100*1.5毫秒，第三次间隔100*1.5*1.5毫秒，依次类推，最大间隔1秒</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329143627640.png" alt="image-20250329143627640"></p><p>添加重试</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Retryer <span class="title function_">retryer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Retryer</span>.Default();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行测试，发现打印了五次<code>productController</code>,重试了五次</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329144613068.png" alt="image-20250329144613068"></p><blockquote><p>这个重试机制，是加上设置的超时时间，再加上延迟等待时间</p></blockquote><h2 id="OpenFeign拦截器"><a href="#OpenFeign拦截器" class="headerlink" title="OpenFeign拦截器"></a><code>OpenFeign</code>拦截器</h2><p>请求拦截器<code>RequestInterceptor</code></p><p>​发送请求时，由请求拦截器进行最后拦截，可以对请求进行定制修改</p><p>响应拦截器<code>ResponseInterceptor</code></p><p>​可以对响应的数据进行预处理</p><p>需求，<code>service-order</code>定义<code>XTokenInterceptor</code>拦截器，向<code>service-product</code>发送请求的时候带上<code>x-token</code>：</p><h3 id="第一种方式"><a href="#第一种方式" class="headerlink" title="第一种方式"></a>第一种方式</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XTokenInterceptor</span> <span class="keyword">implements</span> <span class="title class_">RequestInterceptor</span> &#123; <span class="comment">//如果是响应拦截器的话就实现ResponseInterceptor</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate requestTemplate)</span> &#123;</span><br><span class="line">        requestTemplate.header(<span class="string">&quot;x-token&quot;</span>, UUID.randomUUID().toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>service-product</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ProductService productService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/product/&#123;productId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProduct</span><span class="params">(<span class="meta">@PathVariable(&quot;productId&quot;)</span> Long productId, HttpServletRequest request)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;productController====&quot;</span>+request.getHeader(<span class="string">&quot;x-token&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> productService.addProduct(productId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发起<code>http://localhost:8000/addOrder?userId=1&amp;productId=100</code></p><p><img src="/hexo-docs/images/alibabaImage/image-20250329151745802.png" alt="image-20250329151745802"></p><h3 id="第二种方式"><a href="#第二种方式" class="headerlink" title="第二种方式"></a>第二种方式</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XTokenInterceptor</span> <span class="keyword">implements</span> <span class="title class_">RequestInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate requestTemplate)</span> &#123;</span><br><span class="line">        requestTemplate.header(<span class="string">&quot;x-token&quot;</span>, UUID.randomUUID().toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">openfeign:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">config:</span></span><br><span class="line">          <span class="attr">default:</span> <span class="comment"># 默认配置</span></span><br><span class="line">            <span class="attr">read-timeout:</span> <span class="number">3000</span> <span class="comment"># 读取时间为3秒</span></span><br><span class="line">            <span class="attr">connect-timeout:</span> <span class="number">2000</span> <span class="comment"># 连接时间</span></span><br><span class="line">          <span class="attr">service-product:</span></span><br><span class="line">            <span class="attr">read-timeout:</span> <span class="number">5000</span></span><br><span class="line">            <span class="attr">connect-timeout:</span> <span class="number">5000</span></span><br><span class="line">            <span class="attr">request-interceptors:</span> <span class="comment"># 只在 service-product 服务下生效</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">com.lazy.cloud.interceptor.XTokenInterceptor</span> </span><br></pre></td></tr></table></figure><p><code>service-product</code>不变</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329152119166.png" alt="image-20250329152119166"></p><h2 id="FallBack"><a href="#FallBack" class="headerlink" title="FallBack"></a>FallBack</h2><p><code>FallBack</code>：兜底返回</p><blockquote><p>注意：</p><p>​此功能需要整合<code>sentienl</code>才能实现</p></blockquote><p>整合<code>FallBack</code></p><ol><li><p>添加<code>sentienl</code>依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>编写<code>OrderOpenFeignFallBack</code>实现<code>OrderOpenFeign</code>接口</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.feign.fallback;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderOpenFeignClientFallBack</span> <span class="keyword">implements</span> <span class="title class_">OrderOpenFeignClient</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProduct</span><span class="params">(Long productId)</span> &#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>(productId,<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0&quot;</span>),<span class="string">&quot;未知商品&quot;</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在<code>OrderOpenFeignClient</code>类配置，兜底返回</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.feign;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;service-product&quot;,fallback = OrderOpenFeignClientFallBack.class)</span> <span class="comment">//fallback 配置兜底返回</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderOpenFeignClient</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/product/&#123;productId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProduct</span><span class="params">(<span class="meta">@PathVariable(&quot;productId&quot;)</span> Long productId)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>开启熔断功能</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li><li><p>先启动<code>service-order</code>，不启动<code>service-product</code>，看看能不能实现兜底返回</p><p><img src="/hexo-docs/images/alibabaImage/image-20250329155150900.png" alt="image-20250329155150900"></p></li><li><p>在启动<code>service-product</code></p><p><img src="/hexo-docs/images/alibabaImage/image-20250329155245335.png" alt="image-20250329155245335"></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 后端 Spring Cloud Alibaba </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring Cloud </tag>
            
            <tag> Spring Cloud alibaba </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloud Alibaba 第五章</title>
      <link href="/hexo-docs/2025/08/23/SpringCloud/alibaba/chapter05/"/>
      <url>/hexo-docs/2025/08/23/SpringCloud/alibaba/chapter05/</url>
      
        <content type="html"><![CDATA[<h1 id="Seata-分布式事务"><a href="#Seata-分布式事务" class="headerlink" title="Seata 分布式事务"></a>Seata 分布式事务</h1><p>Seata 框架中有三个角色：</p><ul><li><strong>Transaction Coordinator(TC):</strong> 事务协调器（TC）：维护全局事务和分支事务的状态，驱动全局提交或回滚。</li><li><strong>Transaction Manager(TM):</strong> 事务管理器（TM）：定义全局事务的范围：开始全局事务、提交或回滚全局事务。</li><li>**Resource Manager(RM):**资源管理器（RM）：管理参与分支事务的资源，与 TC 通信以注册分支事务并报告分支事务的状态，并驱动分支事务的提交或回滚。</li></ul><p><a href="https://camo.githubusercontent.com/a302427a15e1ed0cd8da485e8bb38aadc673657d8574aad4023d6e71dadd65c3/68747470733a2f2f63646e2e6e6c61726b2e636f6d2f6c61726b2f302f323031382f706e672f31383836322f313534353031333931353238362d34613930663064662d356664612d343165312d393165302d3261613364333331633033352e706e67"><img src="/hexo-docs/images/alibabaImage/seata1.png" alt="Model"></a><br>Seata 管理的分布式事务的典型生命周期：</p><ol><li>TM 请求 TC 开始一个新的事务。TC 生成一个 XID 来表示全局事务。</li><li>XID 在微服务调用链中传播。</li><li>RM 将本地事务注册为 XID 对应的全局事务的分支到 TC。</li><li>TM 请求 TC 提交或回滚 XID 对应的全局事务。</li><li>TC 驱动所有分支事务在对应的 XID 全局事务下完成分支提交或回滚。</li></ol><p><a href="https://camo.githubusercontent.com/837b5a990d776ae3eb3f96126a251390e25cdb27a563157b45ea436f3a0dc541/68747470733a2f2f63646e2e6e6c61726b2e636f6d2f6c61726b2f302f323031382f706e672f31383836322f313534353239363931373838312d32366661626562392d373166612d346633652d386137612d6663333137643333383966342e706e67"><img src="/hexo-docs/images/alibabaImage/seata2.png" alt="Typical Process"></a></p><p>Seata 是一款开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事务服务。致力于在微服务架构下提供高性能和简单易用的分布式事务服务。</p><p><a href="https://seata.apache.org/zh-cn/">Seata官网</a></p><p>创建四个服务，分别是<code>seata-account</code>、<code>seata-busines</code>、<code>seata-storage</code>、<code>seata-order</code>四个服务，分别在<code>service</code>下</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `undo_log`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `undo_log` (</span><br><span class="line">                            `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT,</span><br><span class="line">                            `branch_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `xid` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `context` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `rollback_info` longblob <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `log_status` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `log_created` datetime <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `log_modified` datetime <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `ext` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">                            <span class="keyword">PRIMARY KEY</span> (`id`),</span><br><span class="line">                            <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`,`branch_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure><blockquote><p>注意：</p><p>​如果使用<code>seata</code>必须要写入<code>undo_log</code>日志</p></blockquote><h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `storage_db`;</span><br><span class="line">USE  `storage_db`;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `storage_tbl`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `storage_tbl` (</span><br><span class="line">                               `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT,</span><br><span class="line">                               `commodity_code` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">                               `count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">                               <span class="keyword">PRIMARY KEY</span> (`id`),</span><br><span class="line">                               <span class="keyword">UNIQUE</span> KEY (`commodity_code`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"><span class="keyword">INSERT INTO</span> storage_tbl (commodity_code, count) <span class="keyword">VALUES</span> (<span class="string">&#x27;P0001&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> storage_tbl (commodity_code, count) <span class="keyword">VALUES</span> (<span class="string">&#x27;B1234&#x27;</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 注意此处0.3.0+ 增加唯一索引 ux_undo_log</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `undo_log`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `undo_log` (</span><br><span class="line">                            `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT,</span><br><span class="line">                            `branch_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `xid` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `context` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `rollback_info` longblob <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `log_status` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `log_created` datetime <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `log_modified` datetime <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `ext` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">                            <span class="keyword">PRIMARY KEY</span> (`id`),</span><br><span class="line">                            <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`,`branch_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `order_db`;</span><br><span class="line">USE  `order_db`;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `order_tbl`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `order_tbl` (</span><br><span class="line">                             `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT,</span><br><span class="line">                             `user_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">                             `commodity_code` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">                             `count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">                             `money` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">                             <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"><span class="comment">-- 注意此处0.3.0+ 增加唯一索引 ux_undo_log</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `undo_log`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `undo_log` (</span><br><span class="line">                            `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT,</span><br><span class="line">                            `branch_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `xid` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `context` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `rollback_info` longblob <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `log_status` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `log_created` datetime <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `log_modified` datetime <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `ext` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">                            <span class="keyword">PRIMARY KEY</span> (`id`),</span><br><span class="line">                            <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`,`branch_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `account_db`;</span><br><span class="line">USE  `account_db`;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `account_tbl`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `account_tbl` (</span><br><span class="line">                               `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT,</span><br><span class="line">                               `user_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">                               `money` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">                               <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"><span class="keyword">INSERT INTO</span> account_tbl (user_id, money) <span class="keyword">VALUES</span> (<span class="string">&#x27;1&#x27;</span>, <span class="number">10000</span>);</span><br><span class="line"><span class="comment">-- 注意此处0.3.0+ 增加唯一索引 ux_undo_log</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `undo_log`;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> `undo_log` (</span><br><span class="line">                            `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT,</span><br><span class="line">                            `branch_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `xid` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `context` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `rollback_info` longblob <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `log_status` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `log_created` datetime <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `log_modified` datetime <span class="keyword">NOT NULL</span>,</span><br><span class="line">                            `ext` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">                            <span class="keyword">PRIMARY KEY</span> (`id`),</span><br><span class="line">                            <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`,`branch_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure><h2 id="seata-account"><a href="#seata-account" class="headerlink" title="seata-account"></a><code>seata-account</code></h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>bean</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.bean;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountTbl</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    <span class="keyword">private</span> Integer money;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mapper</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.mapper;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 针对表【account_tbl】的数据库操作Mapper</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountTblMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteByPrimaryKey</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insert</span><span class="params">(AccountTbl record)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insertSelective</span><span class="params">(AccountTbl record)</span>;</span><br><span class="line"></span><br><span class="line">    AccountTbl <span class="title function_">selectByPrimaryKey</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateByPrimaryKeySelective</span><span class="params">(AccountTbl record)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateByPrimaryKey</span><span class="params">(AccountTbl record)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">debit</span><span class="params">(String userId, <span class="type">int</span> money)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>service</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从用户账户中扣减</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId  用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> money   扣减金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">debit</span><span class="params">(String userId, <span class="type">int</span> money)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>serviceImpl</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountTblMapper accountTblMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">debit</span><span class="params">(String userId, <span class="type">int</span> money)</span> &#123;</span><br><span class="line">        accountTblMapper.debit(userId, money);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>controller</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountTbRestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AccountService accountService;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扣减账户余额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/debit&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">debit</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> String userId,</span></span><br><span class="line"><span class="params">                        <span class="meta">@RequestParam(&quot;money&quot;)</span> <span class="type">int</span> money)</span>&#123;</span><br><span class="line">        accountService.debit(userId, money);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;account debit success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主启动类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy;</span><br><span class="line"></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.lazy.mapper&quot;)</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeataAccountApplication</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">SpringApplication.run(SeataAccountApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置文件</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">seata-account</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/account_db?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">import-check:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span></span><br></pre></td></tr></table></figure><p>mapper.xml</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.lazy.mapper.AccountTblMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;BaseResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.lazy.bean.AccountTbl&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;INTEGER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;userId&quot;</span> <span class="attr">column</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;money&quot;</span> <span class="attr">column</span>=<span class="string">&quot;money&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;INTEGER&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;Base_Column_List&quot;</span>&gt;</span></span><br><span class="line">        id,user_id,money</span><br><span class="line">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectByPrimaryKey&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.lang.Long&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;BaseResultMap&quot;</span>&gt;</span></span><br><span class="line">        select</span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;Base_Column_List&quot;</span> /&gt;</span></span><br><span class="line">        from account_tbl</span><br><span class="line">        where  id = #&#123;id,jdbcType=INTEGER&#125; </span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteByPrimaryKey&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.lang.Long&quot;</span>&gt;</span></span><br><span class="line">        delete from account_tbl</span><br><span class="line">        where  id = #&#123;id,jdbcType=INTEGER&#125; </span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insert&quot;</span> <span class="attr">keyColumn</span>=<span class="string">&quot;id&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.lazy.bean.AccountTbl&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        insert into account_tbl</span><br><span class="line">        ( id,user_id,money</span><br><span class="line">        )</span><br><span class="line">        values (#&#123;id,jdbcType=INTEGER&#125;,#&#123;userId,jdbcType=VARCHAR&#125;,#&#123;money,jdbcType=INTEGER&#125;</span><br><span class="line">        )</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertSelective&quot;</span> <span class="attr">keyColumn</span>=<span class="string">&quot;id&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.lazy.bean.AccountTbl&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        insert into account_tbl</span><br><span class="line">        <span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">&quot;(&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;)&quot;</span> <span class="attr">suffixOverrides</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;id != null&quot;</span>&gt;</span>id,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId != null&quot;</span>&gt;</span>user_id,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;money != null&quot;</span>&gt;</span>money,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">&quot;values (&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;)&quot;</span> <span class="attr">suffixOverrides</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;id != null&quot;</span>&gt;</span>#&#123;id,jdbcType=INTEGER&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId != null&quot;</span>&gt;</span>#&#123;userId,jdbcType=VARCHAR&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;money != null&quot;</span>&gt;</span>#&#123;money,jdbcType=INTEGER&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateByPrimaryKeySelective&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.lazy.bean.AccountTbl&quot;</span>&gt;</span></span><br><span class="line">        update account_tbl</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId != null&quot;</span>&gt;</span></span><br><span class="line">                    user_id = #&#123;userId,jdbcType=VARCHAR&#125;,</span><br><span class="line">                <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;money != null&quot;</span>&gt;</span></span><br><span class="line">                    money = #&#123;money,jdbcType=INTEGER&#125;,</span><br><span class="line">                <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        where   id = #&#123;id,jdbcType=INTEGER&#125; </span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateByPrimaryKey&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.lazy.bean.AccountTbl&quot;</span>&gt;</span></span><br><span class="line">        update account_tbl</span><br><span class="line">        set </span><br><span class="line">            user_id =  #&#123;userId,jdbcType=VARCHAR&#125;,</span><br><span class="line">            money =  #&#123;money,jdbcType=INTEGER&#125;</span><br><span class="line">        where   id = #&#123;id,jdbcType=INTEGER&#125; </span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;debit&quot;</span>&gt;</span></span><br><span class="line">        update account_tbl</span><br><span class="line">        set money = money - #&#123;money,jdbcType=INTEGER&#125;</span><br><span class="line">        where user_id = #&#123;userId,jdbcType=VARCHAR&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="seata-busines"><a href="#seata-busines" class="headerlink" title="seata-busines"></a><code>seata-busines</code></h2><p>依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>service</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.business.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BusinessService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 采购</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId            用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> commodityCode     商品编号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderCount        购买数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">purchase</span><span class="params">(String userId, String commodityCode, <span class="type">int</span> orderCount)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>serviceImpl</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.business.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BusinessService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">purchase</span><span class="params">(String userId, String commodityCode, <span class="type">int</span> orderCount)</span> &#123;</span><br><span class="line">        <span class="comment">//TODO 1. 扣减库存</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//TODO 2. 创建订单</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>controller</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.business.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PurchaseRestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    BusinessService businessService;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 购买</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> commodityCode 商品编码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderCount 数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/purchase&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">purchase</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> String userId,</span></span><br><span class="line"><span class="params">                           <span class="meta">@RequestParam(&quot;commodityCode&quot;)</span> String commodityCode,</span></span><br><span class="line"><span class="params">                           <span class="meta">@RequestParam(&quot;count&quot;)</span> <span class="type">int</span> orderCount)</span>&#123;</span><br><span class="line">        businessService.purchase(userId, commodityCode, orderCount);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;business purchase success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主启动类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.business;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeataBusinessMainApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SeataBusinessMainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">seata-business</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">import-check:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">11000</span></span><br></pre></td></tr></table></figure><h2 id="seata-order"><a href="#seata-order" class="headerlink" title="seata-order"></a><code>seata-order</code></h2><p>依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>bean</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.order.bean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@TableName</span> order_tbl</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderTbl</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String commodityCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer money;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mapper</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.order.mapper;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span> 针对表【order_tbl】的数据库操作Mapper</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderTblMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteByPrimaryKey</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insert</span><span class="params">(OrderTbl record)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insertSelective</span><span class="params">(OrderTbl record)</span>;</span><br><span class="line"></span><br><span class="line">    OrderTbl <span class="title function_">selectByPrimaryKey</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateByPrimaryKeySelective</span><span class="params">(OrderTbl record)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateByPrimaryKey</span><span class="params">(OrderTbl record)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>service</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.order.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId    用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> commodityCode  商品编码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderCount  商品数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    OrderTbl <span class="title function_">create</span><span class="params">(String userId, String commodityCode, <span class="type">int</span> orderCount)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>serviceImpl</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.order.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OrderTblMapper orderTblMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> OrderTbl <span class="title function_">create</span><span class="params">(String userId, String commodityCode, <span class="type">int</span> orderCount)</span> &#123;</span><br><span class="line">        <span class="comment">//1、计算订单价格</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">orderMoney</span> <span class="operator">=</span> calculate(commodityCode, orderCount);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//TODO 2、扣减账户余额</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、保存订单</span></span><br><span class="line">        <span class="type">OrderTbl</span> <span class="variable">orderTbl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderTbl</span>();</span><br><span class="line">        orderTbl.setUserId(userId);</span><br><span class="line">        orderTbl.setCommodityCode(commodityCode);</span><br><span class="line">        orderTbl.setCount(orderCount);</span><br><span class="line">        orderTbl.setMoney(orderMoney);</span><br><span class="line"></span><br><span class="line">        orderTblMapper.insert(orderTbl);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> orderTbl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计算价格</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">calculate</span><span class="params">(String commodityCode, <span class="type">int</span> orderCount)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">9</span>*orderCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>controller</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.order.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderRestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OrderService orderService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> commodityCode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderCount</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/create&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">create</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> String userId,</span></span><br><span class="line"><span class="params">                         <span class="meta">@RequestParam(&quot;commodityCode&quot;)</span> String commodityCode,</span></span><br><span class="line"><span class="params">                         <span class="meta">@RequestParam(&quot;count&quot;)</span> <span class="type">int</span> orderCount)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">OrderTbl</span> <span class="variable">tbl</span> <span class="operator">=</span> orderService.create(userId, commodityCode, orderCount);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;order create success = 订单id：【&quot;</span>+tbl.getId()+<span class="string">&quot;】&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主启动类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.order;</span><br><span class="line"></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.lazy.order.mapper&quot;)</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeataOrderMainApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SeataOrderMainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">seata-order</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/order_db?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">import-check:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">12000</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span></span><br></pre></td></tr></table></figure><p>mapper.xml</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.lazy.order.mapper.OrderTblMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;BaseResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.lazy.order.bean.OrderTbl&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;INTEGER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;userId&quot;</span> <span class="attr">column</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;commodityCode&quot;</span> <span class="attr">column</span>=<span class="string">&quot;commodity_code&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;count&quot;</span> <span class="attr">column</span>=<span class="string">&quot;count&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;INTEGER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;money&quot;</span> <span class="attr">column</span>=<span class="string">&quot;money&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;INTEGER&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;Base_Column_List&quot;</span>&gt;</span></span><br><span class="line">        id,user_id,commodity_code,</span><br><span class="line">        count,money</span><br><span class="line">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectByPrimaryKey&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.lang.Long&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;BaseResultMap&quot;</span>&gt;</span></span><br><span class="line">        select</span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;Base_Column_List&quot;</span> /&gt;</span></span><br><span class="line">        from order_tbl</span><br><span class="line">        where  id = #&#123;id,jdbcType=INTEGER&#125; </span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteByPrimaryKey&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.lang.Long&quot;</span>&gt;</span></span><br><span class="line">        delete from order_tbl</span><br><span class="line">        where  id = #&#123;id,jdbcType=INTEGER&#125; </span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insert&quot;</span> <span class="attr">keyColumn</span>=<span class="string">&quot;id&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.lazy.order.bean.OrderTbl&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        insert into order_tbl</span><br><span class="line">        ( id,user_id,commodity_code</span><br><span class="line">        ,count,money)</span><br><span class="line">        values (#&#123;id,jdbcType=INTEGER&#125;,#&#123;userId,jdbcType=VARCHAR&#125;,#&#123;commodityCode,jdbcType=VARCHAR&#125;</span><br><span class="line">        ,#&#123;count,jdbcType=INTEGER&#125;,#&#123;money,jdbcType=INTEGER&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertSelective&quot;</span> <span class="attr">keyColumn</span>=<span class="string">&quot;id&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.lazy.order.bean.OrderTbl&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        insert into order_tbl</span><br><span class="line">        <span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">&quot;(&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;)&quot;</span> <span class="attr">suffixOverrides</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;id != null&quot;</span>&gt;</span>id,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId != null&quot;</span>&gt;</span>user_id,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;commodityCode != null&quot;</span>&gt;</span>commodity_code,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;count != null&quot;</span>&gt;</span>count,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;money != null&quot;</span>&gt;</span>money,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">&quot;values (&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;)&quot;</span> <span class="attr">suffixOverrides</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;id != null&quot;</span>&gt;</span>#&#123;id,jdbcType=INTEGER&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId != null&quot;</span>&gt;</span>#&#123;userId,jdbcType=VARCHAR&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;commodityCode != null&quot;</span>&gt;</span>#&#123;commodityCode,jdbcType=VARCHAR&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;count != null&quot;</span>&gt;</span>#&#123;count,jdbcType=INTEGER&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;money != null&quot;</span>&gt;</span>#&#123;money,jdbcType=INTEGER&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateByPrimaryKeySelective&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.lazy.order.bean.OrderTbl&quot;</span>&gt;</span></span><br><span class="line">        update order_tbl</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId != null&quot;</span>&gt;</span></span><br><span class="line">                    user_id = #&#123;userId,jdbcType=VARCHAR&#125;,</span><br><span class="line">                <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;commodityCode != null&quot;</span>&gt;</span></span><br><span class="line">                    commodity_code = #&#123;commodityCode,jdbcType=VARCHAR&#125;,</span><br><span class="line">                <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;count != null&quot;</span>&gt;</span></span><br><span class="line">                    count = #&#123;count,jdbcType=INTEGER&#125;,</span><br><span class="line">                <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;money != null&quot;</span>&gt;</span></span><br><span class="line">                    money = #&#123;money,jdbcType=INTEGER&#125;,</span><br><span class="line">                <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        where   id = #&#123;id,jdbcType=INTEGER&#125; </span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateByPrimaryKey&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.lazy.order.bean.OrderTbl&quot;</span>&gt;</span></span><br><span class="line">        update order_tbl</span><br><span class="line">        set </span><br><span class="line">            user_id =  #&#123;userId,jdbcType=VARCHAR&#125;,</span><br><span class="line">            commodity_code =  #&#123;commodityCode,jdbcType=VARCHAR&#125;,</span><br><span class="line">            count =  #&#123;count,jdbcType=INTEGER&#125;,</span><br><span class="line">            money =  #&#123;money,jdbcType=INTEGER&#125;</span><br><span class="line">        where   id = #&#123;id,jdbcType=INTEGER&#125; </span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="seata-storage"><a href="#seata-storage" class="headerlink" title="seata-storage"></a><code>seata-storage</code></h2><p>依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>bean</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.storage.bean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@TableName</span> storage_tbl</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StorageTbl</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String commodityCode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mapper</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.storage.mapper;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span> 针对表【storage_tbl】的数据库操作Mapper</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StorageTblMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">deleteByPrimaryKey</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insert</span><span class="params">(StorageTbl record)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insertSelective</span><span class="params">(StorageTbl record)</span>;</span><br><span class="line"></span><br><span class="line">    StorageTbl <span class="title function_">selectByPrimaryKey</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateByPrimaryKeySelective</span><span class="params">(StorageTbl record)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateByPrimaryKey</span><span class="params">(StorageTbl record)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deduct</span><span class="params">(String commodityCode, <span class="type">int</span> count)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>service</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.storage.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StorageService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扣除存储数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> commodityCode 商品编码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count 数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deduct</span><span class="params">(String commodityCode, <span class="type">int</span> count)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>serviceImpl</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.storage.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StorageServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">StorageService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    StorageTblMapper storageTblMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deduct</span><span class="params">(String commodityCode, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        storageTblMapper.deduct(commodityCode, count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>controller</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.storage.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StorageRestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    StorageService  storageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/deduct&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">deduct</span><span class="params">(<span class="meta">@RequestParam(&quot;commodityCode&quot;)</span> String commodityCode,</span></span><br><span class="line"><span class="params">                         <span class="meta">@RequestParam(&quot;count&quot;)</span> Integer count)</span> &#123;</span><br><span class="line"></span><br><span class="line">        storageService.deduct(commodityCode, count);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;storage deduct success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主启动类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.storage;</span><br><span class="line"></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.lazy.storage.mapper&quot;)</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeataStorageMainApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SeataStorageMainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">seata-storage</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/storage_db?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">import-check:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">13000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span></span><br></pre></td></tr></table></figure><p>mapper.xml</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.lazy.storage.mapper.StorageTblMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;BaseResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.lazy.storage.bean.StorageTbl&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;INTEGER&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;commodityCode&quot;</span> <span class="attr">column</span>=<span class="string">&quot;commodity_code&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;count&quot;</span> <span class="attr">column</span>=<span class="string">&quot;count&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;INTEGER&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;Base_Column_List&quot;</span>&gt;</span></span><br><span class="line">        id,commodity_code,count</span><br><span class="line">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectByPrimaryKey&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.lang.Long&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;BaseResultMap&quot;</span>&gt;</span></span><br><span class="line">        select</span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;Base_Column_List&quot;</span> /&gt;</span></span><br><span class="line">        from storage_tbl</span><br><span class="line">        where  id = #&#123;id,jdbcType=INTEGER&#125; </span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteByPrimaryKey&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;java.lang.Long&quot;</span>&gt;</span></span><br><span class="line">        delete from storage_tbl</span><br><span class="line">        where  id = #&#123;id,jdbcType=INTEGER&#125; </span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insert&quot;</span> <span class="attr">keyColumn</span>=<span class="string">&quot;id&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.lazy.storage.bean.StorageTbl&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        insert into storage_tbl</span><br><span class="line">        ( id,commodity_code,count</span><br><span class="line">        )</span><br><span class="line">        values (#&#123;id,jdbcType=INTEGER&#125;,#&#123;commodityCode,jdbcType=VARCHAR&#125;,#&#123;count,jdbcType=INTEGER&#125;</span><br><span class="line">        )</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertSelective&quot;</span> <span class="attr">keyColumn</span>=<span class="string">&quot;id&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.lazy.storage.bean.StorageTbl&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        insert into storage_tbl</span><br><span class="line">        <span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">&quot;(&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;)&quot;</span> <span class="attr">suffixOverrides</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;id != null&quot;</span>&gt;</span>id,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;commodityCode != null&quot;</span>&gt;</span>commodity_code,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;count != null&quot;</span>&gt;</span>count,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">&quot;values (&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;)&quot;</span> <span class="attr">suffixOverrides</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;id != null&quot;</span>&gt;</span>#&#123;id,jdbcType=INTEGER&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;commodityCode != null&quot;</span>&gt;</span>#&#123;commodityCode,jdbcType=VARCHAR&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;count != null&quot;</span>&gt;</span>#&#123;count,jdbcType=INTEGER&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateByPrimaryKeySelective&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.lazy.storage.bean.StorageTbl&quot;</span>&gt;</span></span><br><span class="line">        update storage_tbl</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;commodityCode != null&quot;</span>&gt;</span></span><br><span class="line">                    commodity_code = #&#123;commodityCode,jdbcType=VARCHAR&#125;,</span><br><span class="line">                <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;count != null&quot;</span>&gt;</span></span><br><span class="line">                    count = #&#123;count,jdbcType=INTEGER&#125;,</span><br><span class="line">                <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        where   id = #&#123;id,jdbcType=INTEGER&#125; </span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateByPrimaryKey&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.lazy.storage.bean.StorageTbl&quot;</span>&gt;</span></span><br><span class="line">        update storage_tbl</span><br><span class="line">        set </span><br><span class="line">            commodity_code =  #&#123;commodityCode,jdbcType=VARCHAR&#125;,</span><br><span class="line">            count =  #&#123;count,jdbcType=INTEGER&#125;</span><br><span class="line">        where   id = #&#123;id,jdbcType=INTEGER&#125; </span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;deduct&quot;</span>&gt;</span></span><br><span class="line">        update storage_tbl</span><br><span class="line">        set count = count - #&#123;count&#125;</span><br><span class="line">        where commodity_code = #&#123;commodityCode&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="添加单个事务回滚"><a href="#添加单个事务回滚" class="headerlink" title="添加单个事务回滚"></a>添加单个事务回滚</h2><p>我们在<code>seata-account</code>、<code>seata-order</code>、<code>seata-storage</code>上的service添加事务，主启动类上开启事务</p><p>seata-account ，service</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountTblMapper accountTblMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">debit</span><span class="params">(String userId, <span class="type">int</span> money)</span> &#123;</span><br><span class="line">        accountTblMapper.debit(userId, money);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>开启事务</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.lazy.mapper&quot;)</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeataAccountApplication</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">SpringApplication.run(SeataAccountApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>seata-order</code>，service</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.order.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderRestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OrderService orderService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> commodityCode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderCount</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/create&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">create</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> String userId,</span></span><br><span class="line"><span class="params">                         <span class="meta">@RequestParam(&quot;commodityCode&quot;)</span> String commodityCode,</span></span><br><span class="line"><span class="params">                         <span class="meta">@RequestParam(&quot;count&quot;)</span> <span class="type">int</span> orderCount)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">OrderTbl</span> <span class="variable">tbl</span> <span class="operator">=</span> orderService.create(userId, commodityCode, orderCount);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;order create success = 订单id：【&quot;</span>+tbl.getId()+<span class="string">&quot;】&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.order;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.lazy.order.mapper&quot;)</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeataOrderMainApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SeataOrderMainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>seata-storage</code>，service</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.storage.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StorageServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">StorageService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    StorageTblMapper storageTblMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deduct</span><span class="params">(String commodityCode, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        storageTblMapper.deduct(commodityCode, count);</span><br><span class="line">        <span class="keyword">if</span> (count ==<span class="number">5</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;库存不足！&quot;</span>); <span class="comment">//如果扣减5个库存，会发生异常。进行事务回滚</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.storage;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.lazy.storage.mapper&quot;)</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeataStorageMainApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SeataStorageMainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="seata-busines集成下订单和扣库存"><a href="#seata-busines集成下订单和扣库存" class="headerlink" title="seata-busines集成下订单和扣库存"></a><code>seata-busines</code>集成下订单和扣库存</h2><p><img src="/hexo-docs/images/alibabaImage/image-20250403170009786.png" alt="image-20250403170009786"></p><p>在<code>seata-busines</code>创建两个接口</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.business.feign;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;seata-order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderFeignClient</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/create&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">create</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> String userId,</span></span><br><span class="line"><span class="params">                         <span class="meta">@RequestParam(&quot;commodityCode&quot;)</span> String commodityCode,</span></span><br><span class="line"><span class="params">                         <span class="meta">@RequestParam(&quot;count&quot;)</span> <span class="type">int</span> orderCount)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.business.feign;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;seata-storage&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StorageFeignClient</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/deduct&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">deduct</span><span class="params">(<span class="meta">@RequestParam(&quot;commodityCode&quot;)</span> String commodityCode,</span></span><br><span class="line"><span class="params">                         <span class="meta">@RequestParam(&quot;count&quot;)</span> Integer count)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>serviceImpl</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.business.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BusinessService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StorageFeignClient storageFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderFeignClient orderFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">purchase</span><span class="params">(String userId, String commodityCode, <span class="type">int</span> orderCount)</span> &#123;</span><br><span class="line">        <span class="comment">//1. 扣减库存</span></span><br><span class="line">        storageFeignClient.deduct(commodityCode, orderCount);</span><br><span class="line">        <span class="comment">//2. 创建订单</span></span><br><span class="line">        orderFeignClient.create(userId, commodityCode, orderCount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主启动类添加开启FeignClient</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.business;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeataBusinessMainApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SeataBusinessMainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>改造<code>seata-order</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.order.feign;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;seata-account&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountFeignClient</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/debit&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">debit</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> String userId,</span></span><br><span class="line"><span class="params">                        <span class="meta">@RequestParam(&quot;money&quot;)</span> <span class="type">int</span> money)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>serviceImpl</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.order.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OrderTblMapper orderTblMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountFeignClient accountFeignClient;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> OrderTbl <span class="title function_">create</span><span class="params">(String userId, String commodityCode, <span class="type">int</span> orderCount)</span> &#123;</span><br><span class="line">        <span class="comment">//1、计算订单价格</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">orderMoney</span> <span class="operator">=</span> calculate(commodityCode, orderCount);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、扣减账户余额</span></span><br><span class="line">        accountFeignClient.debit(userId, orderMoney);</span><br><span class="line">        <span class="comment">//3、保存订单</span></span><br><span class="line">        <span class="type">OrderTbl</span> <span class="variable">orderTbl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderTbl</span>();</span><br><span class="line">        orderTbl.setUserId(userId);</span><br><span class="line">        orderTbl.setCommodityCode(commodityCode);</span><br><span class="line">        orderTbl.setCount(orderCount);</span><br><span class="line">        orderTbl.setMoney(orderMoney);</span><br><span class="line"></span><br><span class="line">        orderTblMapper.insert(orderTbl);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> orderTbl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算价格</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">calculate</span><span class="params">(String commodityCode, <span class="type">int</span> orderCount)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">9</span>*orderCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主启动类添加开启Feign</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br></pre></td></tr></table></figure><h2 id="Seata原理"><a href="#Seata原理" class="headerlink" title="Seata原理"></a><code>Seata</code>原理</h2><p><img src="/hexo-docs/images/alibabaImage/image-20250403172725261.png" alt="image-20250403172725261"></p><p>下载<a href="https://seata.apache.org/zh-cn/download/seata-server">Seata</a></p><p>启动seata</p><p><img src="/hexo-docs/images/alibabaImage/image-20250403183001333.png" alt="image-20250403183001333"></p><p>seata的访问地址</p><p><img src="/hexo-docs/images/alibabaImage/image-20250403183040379.png" alt="image-20250403183040379"></p><p><img src="/hexo-docs/images/alibabaImage/image-20250403183124885.png" alt="image-20250403183124885"></p><p>启动完seata我们就应该配置引入seata了,只要用到了就需要引入</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置文件，需要跟<code>application.yaml</code>同级，创建一个<code>file.conf</code></p><p>完整的<code>file.conf</code></p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 版权归Apache软件基金会（ASF）所有，可能有一个或多个</span></span><br><span class="line"><span class="comment"># 贡献者许可协议。请查看与此工作一起分发的NOTICE文件，以获取有关版权所有权的更多信息。</span></span><br><span class="line"><span class="comment"># ASF根据Apache许可证2.0版（以下简称“许可证”）将此文件授权给您使用；</span></span><br><span class="line"><span class="comment"># 除非符合许可证的要求，否则您不得使用此文件。您可以在以下网址获取许可证副本：</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 除非适用法律要求或书面同意，否则根据许可证分发的软件按“原样”分发，</span></span><br><span class="line"><span class="comment"># 不附带任何形式的明示或暗示的保证或条件。请查看许可证以了解具体的权限和限制规定。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="attr">transport</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">  # 传输类型，可选值：tcp（TCP协议），unix-domain-socket（Unix域套接字）</span></span><br><span class="line">  <span class="attr">type</span> = <span class="string">&quot;TCP&quot;</span></span><br><span class="line"><span class="comment">  # 服务器模式，可选值：NIO（非阻塞I/O），NATIVE（原生模式）</span></span><br><span class="line">  <span class="attr">server</span> = <span class="string">&quot;NIO&quot;</span></span><br><span class="line"><span class="comment">  # 是否启用心跳机制</span></span><br><span class="line">  <span class="attr">heartbeat</span> = <span class="string">true</span></span><br><span class="line"><span class="comment">  # TM客户端是否启用批量发送请求</span></span><br><span class="line">  <span class="attr">enableTmClientBatchSendRequest</span> = <span class="string">false</span></span><br><span class="line"><span class="comment">  # RM客户端是否启用批量发送请求</span></span><br><span class="line">  <span class="attr">enableRmClientBatchSendRequest</span> = <span class="string">true</span></span><br><span class="line"><span class="comment">  # RM客户端RPC请求的超时时间（毫秒）</span></span><br><span class="line">  <span class="attr">rpcRmRequestTimeout</span> = <span class="string">2000</span></span><br><span class="line"><span class="comment">  # TM客户端RPC请求的超时时间（毫秒）</span></span><br><span class="line">  <span class="attr">rpcTmRequestTimeout</span> = <span class="string">30000</span></span><br><span class="line"><span class="comment">  # RM客户端RPC请求的超时时间（毫秒）</span></span><br><span class="line">  <span class="attr">rpcRmRequestTimeout</span> = <span class="string">15000</span></span><br><span class="line"><span class="comment">  # Netty线程工厂配置</span></span><br><span class="line">  <span class="attr">threadFactory</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">    # 主线程前缀</span></span><br><span class="line">    <span class="attr">bossThreadPrefix</span> = <span class="string">&quot;NettyBoss&quot;</span></span><br><span class="line"><span class="comment">    # 工作线程前缀</span></span><br><span class="line">    <span class="attr">workerThreadPrefix</span> = <span class="string">&quot;NettyServerNIOWorker&quot;</span></span><br><span class="line"><span class="comment">    # 服务器执行线程前缀</span></span><br><span class="line">    <span class="attr">serverExecutorThread-prefix</span> = <span class="string">&quot;NettyServerBizHandler&quot;</span></span><br><span class="line"><span class="comment">    # 是否共享主线程和工作线程</span></span><br><span class="line">    <span class="attr">shareBossWorker</span> = <span class="string">false</span></span><br><span class="line"><span class="comment">    # 客户端选择器线程前缀</span></span><br><span class="line">    <span class="attr">clientSelectorThreadPrefix</span> = <span class="string">&quot;NettyClientSelector&quot;</span></span><br><span class="line"><span class="comment">    # 客户端选择器线程数量</span></span><br><span class="line">    <span class="attr">clientSelectorThreadSize</span> = <span class="string">1</span></span><br><span class="line"><span class="comment">    # 客户端工作线程前缀</span></span><br><span class="line">    <span class="attr">clientWorkerThreadPrefix</span> = <span class="string">&quot;NettyClientWorkerThread&quot;</span></span><br><span class="line"><span class="comment">    # Netty主线程数量</span></span><br><span class="line">    <span class="attr">bossThreadSize</span> = <span class="string">1</span></span><br><span class="line"><span class="comment">    # 工作线程数量，&quot;default&quot;表示自动默认或为8</span></span><br><span class="line">    <span class="attr">workerThreadSize</span> = <span class="string">&quot;default&quot;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">shutdown</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">    # 销毁服务器时的等待秒数</span></span><br><span class="line">    <span class="attr">wait</span> = <span class="string">3</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="comment">  # 序列化方式</span></span><br><span class="line">  <span class="attr">serialization</span> = <span class="string">&quot;seata&quot;</span></span><br><span class="line"><span class="comment">  # 压缩方式</span></span><br><span class="line">  <span class="attr">compressor</span> = <span class="string">&quot;none&quot;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">service</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">  # 事务服务组映射</span></span><br><span class="line">  <span class="attr">vgroupMapping.default_tx_group</span> = <span class="string">&quot;default&quot;</span></span><br><span class="line"><span class="comment">  # 仅在registry.type=file时支持，请勿设置多个地址</span></span><br><span class="line">  <span class="attr">default.grouplist</span> = <span class="string">&quot;127.0.0.1:8091&quot;</span></span><br><span class="line"><span class="comment">  # 是否启用降级，当前不支持</span></span><br><span class="line">  <span class="attr">enableDegrade</span> = <span class="string">false</span></span><br><span class="line"><span class="comment">  # 是否禁用全局事务</span></span><br><span class="line">  <span class="attr">disableGlobalTransaction</span> = <span class="string">false</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">client</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="attr">rm</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">    # 异步提交缓冲区的最大限制</span></span><br><span class="line">    <span class="attr">asyncCommitBufferLimit</span> = <span class="string">10000</span></span><br><span class="line">    <span class="attr">lock</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">      # 锁重试间隔时间（毫秒）</span></span><br><span class="line">      <span class="attr">retryInterval</span> = <span class="string">10</span></span><br><span class="line"><span class="comment">      # 锁重试次数</span></span><br><span class="line">      <span class="attr">retryTimes</span> = <span class="string">30</span></span><br><span class="line"><span class="comment">      # 分支事务冲突时是否回滚</span></span><br><span class="line">      <span class="attr">retryPolicyBranchRollbackOnConflict</span> = <span class="string">true</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="comment">    # 报告重试次数</span></span><br><span class="line">    <span class="attr">reportRetryCount</span> = <span class="string">5</span></span><br><span class="line"><span class="comment">    # 是否启用表元数据检查</span></span><br><span class="line">    <span class="attr">tableMetaCheckEnable</span> = <span class="string">false</span></span><br><span class="line"><span class="comment">    # 表元数据检查的时间间隔（毫秒）</span></span><br><span class="line">    <span class="attr">tableMetaCheckerInterval</span> = <span class="string">60000</span></span><br><span class="line"><span class="comment">    # 是否启用报告成功</span></span><br><span class="line">    <span class="attr">reportSuccessEnable</span> = <span class="string">false</span></span><br><span class="line"><span class="comment">    # 是否启用Saga分支注册</span></span><br><span class="line">    <span class="attr">sagaBranchRegisterEnable</span> = <span class="string">false</span></span><br><span class="line"><span class="comment">    # Saga的JSON解析器</span></span><br><span class="line">    <span class="attr">sagaJsonParser</span> = <span class="string">&quot;fastjson&quot;</span></span><br><span class="line"><span class="comment">    # Saga重试持久化模式是否更新</span></span><br><span class="line">    <span class="attr">sagaRetryPersistModeUpdate</span> = <span class="string">false</span></span><br><span class="line"><span class="comment">    # Saga补偿持久化模式是否更新</span></span><br><span class="line">    <span class="attr">sagaCompensatePersistModeUpdate</span> = <span class="string">false</span></span><br><span class="line"><span class="comment">    # TCC动作拦截器的顺序</span></span><br><span class="line">    <span class="attr">tccActionInterceptorOrder</span> = <span class="string">-2147482648 #Ordered.HIGHEST_PRECEDENCE + 1000</span></span><br><span class="line"><span class="comment">    # SQL解析器类型</span></span><br><span class="line">    <span class="attr">sqlParserType</span> = <span class="string">&quot;druid&quot;</span></span><br><span class="line"><span class="comment">    # XA分支执行超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">branchExecutionTimeoutXA</span> = <span class="string">60000</span></span><br><span class="line"><span class="comment">    # XA连接两阶段持有超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">connectionTwoPhaseHoldTimeoutXA</span> = <span class="string">10000</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">tm</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">    # 提交重试次数</span></span><br><span class="line">    <span class="attr">commitRetryCount</span> = <span class="string">5</span></span><br><span class="line"><span class="comment">    # 回滚重试次数</span></span><br><span class="line">    <span class="attr">rollbackRetryCount</span> = <span class="string">5</span></span><br><span class="line"><span class="comment">    # 默认全局事务超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">defaultGlobalTransactionTimeout</span> = <span class="string">60000</span></span><br><span class="line"><span class="comment">    # 是否启用降级检查</span></span><br><span class="line">    <span class="attr">degradeCheck</span> = <span class="string">false</span></span><br><span class="line"><span class="comment">    # 降级检查周期（毫秒）</span></span><br><span class="line">    <span class="attr">degradeCheckPeriod</span> = <span class="string">2000</span></span><br><span class="line"><span class="comment">    # 降级检查允许次数</span></span><br><span class="line">    <span class="attr">degradeCheckAllowTimes</span> = <span class="string">10</span></span><br><span class="line"><span class="comment">    # 拦截器顺序</span></span><br><span class="line">    <span class="attr">interceptorOrder</span> = <span class="string">-2147482648 #Ordered.HIGHEST_PRECEDENCE + 1000</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">undo</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">    # 是否进行数据验证</span></span><br><span class="line">    <span class="attr">dataValidation</span> = <span class="string">true</span></span><br><span class="line"><span class="comment">    # 是否仅关注更新列</span></span><br><span class="line">    <span class="attr">onlyCareUpdateColumns</span> = <span class="string">true</span></span><br><span class="line"><span class="comment">    # 回滚日志的序列化方式</span></span><br><span class="line">    <span class="attr">logSerialization</span> = <span class="string">&quot;jackson&quot;</span></span><br><span class="line"><span class="comment">    # 回滚日志表名</span></span><br><span class="line">    <span class="attr">logTable</span> = <span class="string">&quot;undo_log&quot;</span></span><br><span class="line">    <span class="attr">compress</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">      # 是否启用压缩</span></span><br><span class="line">      <span class="attr">enable</span> = <span class="string">true</span></span><br><span class="line"><span class="comment">      # 压缩类型，可选值：zip, gzip, deflater, lz4, bzip2, zstd，默认是zip</span></span><br><span class="line">      <span class="attr">type</span> = <span class="string">zip</span></span><br><span class="line"><span class="comment">      # 回滚信息大小超过此阈值时进行压缩，支持k、m、g、t单位</span></span><br><span class="line">      <span class="attr">threshold</span> = <span class="string">64k</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">loadBalance</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">      # 负载均衡类型</span></span><br><span class="line">      <span class="attr">type</span> = <span class="string">&quot;XID&quot;</span></span><br><span class="line"><span class="comment">      # 虚拟节点数量</span></span><br><span class="line">      <span class="attr">virtualNodes</span> = <span class="string">10</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">log</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">  # 异常率</span></span><br><span class="line">  <span class="attr">exceptionRate</span> = <span class="string">100</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">tcc</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="attr">fence</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">    # TCC栅栏日志表名</span></span><br><span class="line">    <span class="attr">logTableName</span> = <span class="string">tcc_fence_log</span></span><br><span class="line"><span class="comment">    # TCC栅栏日志清理周期</span></span><br><span class="line">    <span class="attr">cleanPeriod</span> = <span class="string">1h</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><p>我们只需要引入部分即可，只要那个项目引入依赖，就得在下面配置这个，不然服务启动不起来</p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">service</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">  # 事务服务组映射</span></span><br><span class="line">  <span class="attr">vgroupMapping.default_tx_group</span> = <span class="string">&quot;default&quot;</span></span><br><span class="line"><span class="comment">  # 仅在registry.type=file时支持，请勿设置多个地址</span></span><br><span class="line">  <span class="attr">default.grouplist</span> = <span class="string">&quot;127.0.0.1:8091&quot; # seata服务端的地址</span></span><br><span class="line"><span class="comment">  # 是否启用降级，当前不支持</span></span><br><span class="line">  <span class="attr">enableDegrade</span> = <span class="string">false</span></span><br><span class="line"><span class="comment">  # 是否禁用全局事务</span></span><br><span class="line">  <span class="attr">disableGlobalTransaction</span> = <span class="string">false</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><p>只引入这个是实现不了分布式事务的，我们还需要在那个地方引入的分布式的上面添加<code>@GlobalTransactional</code>注解</p><p>这个项目我们是在<code>seata-busines</code>中的<code>serviceImpl</code>下调用的，所以在改方法上添加注解</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.business.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BusinessService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StorageFeignClient storageFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderFeignClient orderFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GlobalTransactional</span> # 添加seata的全局事务</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">purchase</span><span class="params">(String userId, String commodityCode, <span class="type">int</span> orderCount)</span> &#123;</span><br><span class="line">        <span class="comment">//1. 扣减库存</span></span><br><span class="line">        storageFeignClient.deduct(commodityCode, orderCount);</span><br><span class="line">        <span class="comment">//2. 创建订单</span></span><br><span class="line">        orderFeignClient.create(userId, commodityCode, orderCount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们在启动项目测试</p><p><img src="/hexo-docs/images/alibabaImage/image-20250403184404634.png" alt="image-20250403184404634"></p><p>发现我们的代码报错了，但是我们的数据库是进行回滚了</p><p><img src="/hexo-docs/images/alibabaImage/image-20250403184449259.png" alt="image-20250403184449259"></p><p><img src="/hexo-docs/images/alibabaImage/image-20250403184500736.png" alt="image-20250403184500736"></p><h2 id="seata二阶提交协议"><a href="#seata二阶提交协议" class="headerlink" title="seata二阶提交协议"></a>seata二阶提交协议</h2><p>Seata 通过引入 全局事务管理 和 分支事务 来解决分布式系统中的事务一致性问题。它使用类似于传统数据库事务中的 二阶段提交（2PC，Two-Phase Commit） 协议来确保事务的原子性。</p><p><img src="/hexo-docs/images/alibabaImage/seata%E4%BA%8C%E9%98%B6%E6%8F%90%E4%BA%A4.png"></p><h3 id="二阶段提交（2PC）过程"><a href="#二阶段提交（2PC）过程" class="headerlink" title="二阶段提交（2PC）过程"></a>二阶段提交（2PC）过程</h3><p>Seata 采用二阶段提交协议（2PC）来确保分布式事务的一致性。以下是二阶段提交的详细流程：</p><ol><li>第一阶段：事务预备（Try阶段）<br>全局事务开始：客户端应用向 Seata Server 发起请求，Seata 会生成一个全局事务 ID（XID），并返回给客户端应用。全局事务标识用于追踪整个分布式事务。</li></ol>  <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 启动全局事务</span></span><br><span class="line"><span class="type">GlobalTransaction</span> <span class="variable">tx</span> <span class="operator">=</span> GlobalTransactionContext.getCurrentOrCreate();</span><br><span class="line">tx.begin();</span><br></pre></td></tr></table></figure><p>  分支事务注册：每个参与者（微服务）启动后，会向 Seata Server 注册自己作为一个分支事务，Seata Server 会为每个分支事务分配一个唯一的事务分支 ID（Branch ID）。Try 阶段：每个微服务会执行 Try 操作，即准备执行本地事务操作，但不提交数据。例如，更新某个数据库中的记录，但不提交。执行数据库操作：每个参与的子事务都会执行数据库更新，但不会真正提交，而是进入 prepare 状态（对于 AT 模式，这意味着生成 undo_log）。</p><ol start="2"><li><p>第二阶段：提交（Commit）或回滚（Rollback）</p></li><li><p>提交（Commit）：</p><ol><li>Seata Server 收到全局事务提交请求后，通知所有分支事务提交事务。<ol start="2"><li>分支事务提交数据库操作（删除 undo_log）。</li></ol></li></ol></li><li><p>回滚（Rollback）：</p></li></ol><pre><code>如果 Seata Server 发现某个分支事务执行失败，则通知所有已提交的分支事务回滚，恢复 undo_log 记录的数据。</code></pre><h2 id="seata配置到nacos"><a href="#seata配置到nacos" class="headerlink" title="seata配置到nacos"></a>seata配置到nacos</h2><p><a href="https://seata.apache.org/zh-cn/docs/user/configuration/nacos">官网地址</a></p><h2 id="seata的四种事务模式"><a href="#seata的四种事务模式" class="headerlink" title="seata的四种事务模式"></a>seata的四种事务模式</h2><h3 id="Seata-AT-模式"><a href="#Seata-AT-模式" class="headerlink" title="Seata AT 模式"></a>Seata AT 模式</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>AT 模式是 Seata 创新的一种非侵入式的分布式事务解决方案，Seata 在内部做了对数据库操作的代理层，我们使用 Seata AT 模式时，实际上用的是 Seata 自带的数据源代理 DataSourceProxy，Seata 在这层代理中加入了很多逻辑，比如插入回滚 undo_log 日志，检查全局锁等。</p><p>本文中，我们将重点介绍 Seata AT 模式的使用，如果您对于 AT 模式原理感兴趣，还请阅读对应于本篇文章的<a href="https://seata.apache.org/zh-cn/docs/dev/mode/at-mode">开发者指南</a>。</p><h5 id="整体机制"><a href="#整体机制" class="headerlink" title="整体机制"></a>整体机制</h5><p>两阶段提交协议的演变：</p><ul><li>一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源。</li><li>二阶段：<ul><li>提交异步化，非常快速地完成。</li><li>回滚通过一阶段的回滚日志进行反向补偿。</li></ul></li></ul><h3 id="Seata-TCC-模式"><a href="#Seata-TCC-模式" class="headerlink" title="Seata TCC 模式"></a>Seata TCC 模式</h3><h4 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h4><p>TCC 模式是 Seata 支持的一种由业务方细粒度控制的侵入式分布式事务解决方案，是继 AT 模式后第二种支持的事务模式，最早由蚂蚁金服贡献。其分布式事务模型直接作用于服务层，不依赖底层数据库，可以灵活选择业务资源的锁定粒度，减少资源锁持有时间，可扩展性好，可以说是为独立部署的 SOA 服务而设计的。</p><p><img src="/hexo-docs/images/alibabaImage/seata_tcc-1-1f7a834639aa755d73fa2af435c4f042.png" alt="Overview of a global transaction"></p><p>本文中，我们将重点介绍 Seata TCC 模式的使用，如果您对于 TCC 模式原理感兴趣，想要了解 Seata TCC 对于幂等、空回滚、悬挂问题的解决，还请阅读对应于本篇文章的<a href="https://seata.apache.org/zh-cn/docs/dev/mode/tcc-mode">开发者指南</a>。</p><h4 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h4><p>TCC 完全不依赖底层数据库，能够实现跨数据库、跨应用资源管理，可以提供给业务方更细粒度的控制。</p><h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><p>TCC 是一种侵入式的分布式事务解决方案，需要业务系统自行实现 Try，Confirm，Cancel 三个操作，对业务系统有着非常大的入侵性，设计相对复杂。</p><h4 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h4><p>TCC 模式是高性能分布式事务解决方案，适用于核心系统等对性能有很高要求的场景。</p><h4 id="整体机制-1"><a href="#整体机制-1" class="headerlink" title="整体机制"></a>整体机制</h4><p>在两阶段提交协议中，资源管理器（RM, Resource Manager）需要提供“准备”、“提交”和“回滚” 3 个操作；而事务管理器（TM, Transaction Manager）分 2 阶段协调所有资源管理器，在第一阶段询问所有资源管理器“准备”是否成功，如果所有资源均“准备”成功则在第二阶段执行所有资源的“提交”操作，否则在第二阶段执行所有资源的“回滚”操作，保证所有资源的最终状态是一致的，要么全部提交要么全部回滚。</p><p>资源管理器有很多实现方式，其中 TCC（Try-Confirm-Cancel）是资源管理器的一种服务化的实现；TCC 是一种比较成熟的分布式事务解决方案，可用于解决跨数据库、跨服务业务操作的数据一致性问题；TCC 其 Try、Confirm、Cancel 3 个方法均由业务编码实现，故 TCC 可以被称为是服务化的资源管理器。</p><p>TCC 的 Try 操作作为一阶段，负责资源的检查和预留；Confirm 操作作为二阶段提交操作，执行真正的业务；Cancel 是二阶段回滚操作，执行预留资源的取消，使资源回到初始状态。</p><h3 id="Seata-Saga-模式"><a href="#Seata-Saga-模式" class="headerlink" title="Seata Saga 模式"></a>Seata Saga 模式</h3><h4 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h4><p>Saga 模式是 SEATA 提供的长事务解决方案，在 Saga 模式中，业务流程中每个参与者都提交本地事务，当出现某一个参与者失败则补偿前面已经成功的参与者，一阶段正向服务和二阶段补偿服务都由业务开发实现。</p><p><img src="/hexo-docs/images/alibabaImage/Saga%E6%A8%A1%E5%BC%8F%E7%A4%BA%E6%84%8F%E5%9B%BE.png" alt="Saga模式示意图"></p><p>理论基础：Hector &amp; Kenneth 发表论⽂ Sagas （1987）</p><h4 id="适用场景："><a href="#适用场景：" class="headerlink" title="适用场景："></a>适用场景：</h4><ul><li>业务流程长、业务流程多</li><li>参与者包含其它公司或遗留系统服务，无法提供 TCC 模式要求的三个接口</li></ul><h4 id="优势："><a href="#优势：" class="headerlink" title="优势："></a>优势：</h4><ul><li>一阶段提交本地事务，无锁，高性能</li><li>事件驱动架构，参与者可异步执行，高吞吐</li><li>补偿服务易于实现</li></ul><h4 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h4><ul><li>不保证隔离性（应对方案见后面文档）</li></ul><h4 id="Saga-的实现："><a href="#Saga-的实现：" class="headerlink" title="Saga 的实现："></a>Saga 的实现：</h4><h4 id="基于状态机引擎的-Saga-实现："><a href="#基于状态机引擎的-Saga-实现：" class="headerlink" title="基于状态机引擎的 Saga 实现："></a>基于状态机引擎的 Saga 实现：</h4><p>目前 SEATA 提供的 Saga 模式是基于状态机引擎来实现的，机制是：</p><ol><li><p>通过状态图来定义服务调用的流程并生成 json 状态语言定义文件</p></li><li><p>状态图中一个节点可以是调用一个服务，节点可以配置它的补偿节点</p></li><li><p>状态图 json 由状态机引擎驱动执行，当出现异常时状态引擎反向执行已成功节点对应的补偿节点将事务回滚</p><blockquote><p>注意: 异常发生时是否进行补偿也可由用户自定义决定</p></blockquote></li><li><p>可以实现服务编排需求，支持单项选择、并发、子流程、参数转换、参数映射、服务执行状态判断、异常捕获等功能</p></li></ol><p>示例状态图:</p><p><img src="/hexo-docs/images/alibabaImage/demo_statelang-90f1fc01bfaf3a795c3b3357e1046f16.png" alt="示例状态图"></p><h3 id="Seata-XA-模式"><a href="#Seata-XA-模式" class="headerlink" title="Seata XA 模式"></a>Seata XA 模式</h3><h4 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h4><p>XA 模式是从 1.2 版本支持的事务模式。XA 规范 是 X&#x2F;Open 组织定义的分布式事务处理（DTP，Distributed Transaction Processing）标准。Seata XA 模式是利用事务资源（数据库、消息服务等）对 XA 协议的支持，以 XA 协议的机制来管理分支事务的一种事务模式。</p><p><img src="/hexo-docs/images/alibabaImage/TB1hSpccIVl614jSZKPXXaGjpXa-1330-924.png" alt="img"></p><p>本文中，我们将重点介绍 Seata XA 模式的使用，如果您对于 XA 模式原理感兴趣，还请阅读对应于本篇文章的<a href="https://seata.apache.org/zh-cn/docs/dev/mode/xa-mode">开发者指南</a>。</p><h4 id="优势-1"><a href="#优势-1" class="headerlink" title="优势"></a>优势</h4><p>与 Seata 支持的其它事务模式不同，XA 协议要求事务资源本身提供对规范和协议的支持，所以事务资源（如数据库）可以保障从任意视角对数据的访问有效隔离，满足全局数据一致性。此外的一些优势还包括：</p><ol><li>业务无侵入：和 AT 一样，XA 模式将是业务无侵入的，不给应用设计和开发带来额外负担。</li><li>数据库的支持广泛：XA 协议被主流关系型数据库广泛支持，不需要额外的适配即可使用。</li></ol><h4 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h4><p>XA prepare 后，分支事务进入阻塞阶段，收到 XA commit 或 XA rollback 前必须阻塞等待。事务资源长时间得不到释放，锁定周期长，而且在应用层上面无法干预，性能差。</p><h4 id="适用场景-1"><a href="#适用场景-1" class="headerlink" title="适用场景"></a>适用场景</h4><p>适用于想要迁移到 Seata 平台基于 XA 协议的老应用，使用 XA 模式将更平滑，还有 AT 模式未适配的数据库应用。</p><h4 id="整体机制-2"><a href="#整体机制-2" class="headerlink" title="整体机制"></a>整体机制</h4><ul><li>执行阶段：<ul><li>可回滚：业务 SQL 操作放在 XA 分支中进行，由资源对 XA 协议的支持来保证 <em>可回滚</em></li><li>持久化：XA 分支完成后，执行 XA prepare，同样，由资源对 XA 协议的支持来保证 <em>持久化</em>（即，之后任何意外都不会造成无法回滚的情况）</li></ul></li><li>完成阶段：<ul><li>分支提交：执行 XA 分支的 commit</li><li>分支回滚：执行 XA 分支的 rollback</li></ul></li></ul><h2 id="切换seata数据源的代理模式"><a href="#切换seata数据源的代理模式" class="headerlink" title="切换seata数据源的代理模式"></a>切换seata数据源的代理模式</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">data-source-proxy-mode:</span> <span class="string">AT</span></span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><a href="https://www.processon.com/mindmap/67f46c3f4265fb0abfaf291f">SpringCloud alibaba 总结</a></p>]]></content>
      
      
      <categories>
          
          <category> 后端 Spring Cloud Alibaba </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring Cloud </tag>
            
            <tag> Spring Cloud alibaba </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloud Alibaba 第四章</title>
      <link href="/hexo-docs/2025/08/23/SpringCloud/alibaba/chapter04/"/>
      <url>/hexo-docs/2025/08/23/SpringCloud/alibaba/chapter04/</url>
      
        <content type="html"><![CDATA[<h1 id="Gateway网关"><a href="#Gateway网关" class="headerlink" title="Gateway网关"></a>Gateway网关</h1><h2 id="什么是-API-网关（API-Gateway）"><a href="#什么是-API-网关（API-Gateway）" class="headerlink" title="什么是 API 网关（API Gateway）"></a>什么是 API 网关（API Gateway）</h2><p>分布式服务架构、微服务架构与 API 网关<br>在微服务架构里，服务的粒度被进一步细分，各个业务服务可以被独立的设计、开发、测试、部署和管理。这时，各个独立部署单元可以用不同的开发测试团队维护，可以使用不同的编程语言和技术平台进行设计，这就要求必须使用一种语言和平 台无关的服务协议作为各个单元间的通讯方式。</p><p><img src="/hexo-docs/images/alibabaImage/bfe1c817e46b633913dc86072ab4b6ef.png"></p><h2 id="API-网关的定义"><a href="#API-网关的定义" class="headerlink" title="API 网关的定义"></a>API 网关的定义</h2><p>网关的角色是作为一个 API 架构，用来保护、增强和控制对于 API 服务的访问。</p><p>API 网关是一个处于应用程序或服务（提供 REST API 接口服务）之前的系统，用来管理授权、访问控制和流量限制等，这样 REST API 接口服务就被 API 网关保护起来，对所有的调用者透明。因此，隐藏在 API 网关后面的业务系统就可以专注于创建和管理服务，而不用去处理这些策略性的基础设施。</p><h4 id="API-网关的职能"><a href="#API-网关的职能" class="headerlink" title="API 网关的职能"></a>API 网关的职能</h4><p><img src="/hexo-docs/images/alibabaImage/e247852980e91800361cc3091b859ff7.png"></p><h4 id="API-网关的分类与功能"><a href="#API-网关的分类与功能" class="headerlink" title="API 网关的分类与功能"></a>API 网关的分类与功能</h4><p><img src="/hexo-docs/images/alibabaImage/d9e426dfc06dc8f3b35b9dfc4149e0a8.png"></p><h2 id="Gateway是什么"><a href="#Gateway是什么" class="headerlink" title="Gateway是什么"></a>Gateway是什么</h2><p>​Spring Cloud Gateway是Spring官方基于Spring 5.0，Spring Boot 2.0和Project Reactor等技术开发的网关，Spring Cloud Gateway旨在为微服务架构提供一种简单而有效的统一的API路由管理方式。Spring Cloud Gateway作为Spring Cloud生态系中的网关，目标是替代ZUUL，其不仅提供统一的路由方式，并且基于Filter链的方式提供了网关基本的功能，例如：安全，监控&#x2F;埋点，和限流等。</p><h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><p><img src="/hexo-docs/images/alibabaImage/1736142205023-039f6819-e615-4756-8f86-70421c54210d.png" alt="img"></p><h3 id="helloworld"><a href="#helloworld" class="headerlink" title="helloworld"></a>helloworld</h3><ol><li><p>创建<code>gateway</code>项目</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330175919459.png" alt="image-20250330175919459"></p></li><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>编写启动类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.gateway;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(MainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置文件</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="配置网关"><a href="#配置网关" class="headerlink" title="配置网关"></a>配置网关</h3><p>新建<code>application-route.yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-order</span> <span class="comment"># id</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-order</span> <span class="comment"># 负载均衡 service-order</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 断言</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/order/**</span> <span class="comment"># 只要断言是这个请求才会转</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-product</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-product</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/product/**</span></span><br></pre></td></tr></table></figure><p><code>application.yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">include:</span> <span class="string">route</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p><code>service-order</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/order&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/readDb&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">readDb</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;readDb&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;readDb success...&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.feign;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;service-product&quot;,fallback = OrderOpenFeignClientFallBack.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderOpenFeignClient</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/api/order//product/&#123;productId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProduct</span><span class="params">(<span class="meta">@PathVariable(&quot;productId&quot;)</span> Long productId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>service-product</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/product&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ProductService productService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/product/&#123;productId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProduct</span><span class="params">(<span class="meta">@PathVariable(&quot;productId&quot;)</span> Long productId, HttpServletRequest request)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;productController====&quot;</span>+request.getHeader(<span class="string">&quot;x-token&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> productService.addProduct(productId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行测试一下</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330182839946.png" alt="image-20250330182839946"></p><p>发现503，因为我们的<code>gateway</code>项目的配置文件添加了，负载均衡，但没有引入负载均衡的依赖，所以显示没有可用服务</p><p>我们在<code>gateway</code>项目中引入负载均衡的依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>再重启一下试试</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330183104431.png" alt="image-20250330183104431"></p><p>刷新了四遍，看看<code>service-order</code>两个服务有没有打印</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330183221114.png" alt="image-20250330183221114"></p><p><img src="/hexo-docs/images/alibabaImage/image-20250330183237592.png" alt="image-20250330183237592"></p><p>当我们这个设置，他会访问那个？</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">biying</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://cn.bing.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-order</span> <span class="comment"># id</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-order</span> <span class="comment"># 负载均衡 service-order</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 断言</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/order/**</span> <span class="comment"># 只要断言是这个请求才会转</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-product</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-product</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/product/**</span></span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/alibabaImage/image-20250330184229135.png" alt="image-20250330184229135"></p><p>可以看到，他是首先访问的是必应页面，那我们从中得出，他是按照先后顺序来进行访问的，我们也可以通过<code>order</code>来修改它的顺序，数字越小，优先级越高</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">biying</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://cn.bing.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/**</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-order</span> <span class="comment"># id</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-order</span> <span class="comment"># 负载均衡 service-order</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 断言</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/order/**</span> <span class="comment"># 只要断言是这个请求才会转</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">0</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-product</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-product</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/product/**</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p>再重启一下试试</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330184449020.png" alt="image-20250330184449020"></p><p>发现它访问的是我们自己写的页面，如果访问别的话，他会跳转到必应页面，因为必应配置的是下面所有请求都可以访问</p><p><img src="/hexo-docs/images/alibabaImage/image-20250330184550257.png" alt="image-20250330184550257"></p><p>如果这样写的话，也可以生效</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">biying</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://cn.bing.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/**</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-order</span> <span class="comment"># id</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-order</span> <span class="comment"># 负载均衡 service-order</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 断言</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Path</span> <span class="comment"># 用什么方式进行断言</span></span><br><span class="line">              <span class="attr">args:</span>   <span class="comment"># 断言的参数</span></span><br><span class="line">               <span class="attr">patterns:</span> <span class="string">/api/order/**</span> <span class="comment"># 下面的所有请求</span></span><br><span class="line">               <span class="attr">matchTrailingSlash:</span> <span class="literal">true</span> <span class="comment"># 如果设置为true的话，/api/order/1/ 可以匹配到和 /api/order/1 也可以匹配到</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">0</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-product</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-product</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/product/**</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p>效果</p><p><img src="/hexo-docs/images/alibabaImage/image-20250402181111283.png" alt="image-20250402181111283"></p><p><img src="/hexo-docs/images/alibabaImage/image-20250402181138395.png" alt="image-20250402181138395"></p><h3 id="Predicate-断言"><a href="#Predicate-断言" class="headerlink" title="Predicate - 断言"></a>Predicate - 断言</h3><p><img src="/hexo-docs/images/alibabaImage/image-20250402181700823.png" alt="image-20250402181700823"></p><h4 id="Query示例："><a href="#Query示例：" class="headerlink" title="Query示例："></a>Query示例：</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">biying</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://cn.bing.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Path</span>  <span class="comment"># 路径断言</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">patterns:</span> <span class="string">/search</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Query</span> <span class="comment"># 查询断言</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">param:</span> <span class="string">q</span> <span class="comment"># 必须满足参数是q</span></span><br><span class="line">                <span class="attr">regexp:</span> <span class="string">haha</span> <span class="comment"># 参数值是 haha 才能，跳转到相应的路径</span></span><br></pre></td></tr></table></figure><p>启动测试</p><p><img src="/hexo-docs/images/alibabaImage/image-20250402182204255.png" alt="image-20250402182204255"></p><p>从上图看出，我们访问<code>/search</code>会出现404，当我们带上参数后，且参数值为<code>haha</code>再试试</p><p><img src="/hexo-docs/images/alibabaImage/image-20250402182403457.png" alt="image-20250402182403457"></p><p>当我们随便换一个参数值后</p><p><img src="/hexo-docs/images/alibabaImage/image-20250402182425910.png" alt="image-20250402182425910"></p><h3 id="自定义断言工厂"><a href="#自定义断言工厂" class="headerlink" title="自定义断言工厂"></a>自定义断言工厂</h3><p>我们想要实现一个基于上面的在加上<code>vip</code>指定用户才可以访问，否则不能访问！</p><ol><li><p>编写<code>VipPredicateFactory</code>类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.gateway.predicate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VipPredicateFactory</span> <span class="keyword">extends</span> <span class="title class_">VipPredicateFactory</span>&lt;VipRoutePredicateFactory.Config&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VipPredicateFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(Config.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">shortcutFieldOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="string">&quot;param&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title function_">apply</span><span class="params">(Config config)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (GatewayPredicate) serverWebExchange -&gt; &#123;</span><br><span class="line">            <span class="comment">// 获取 request 请求</span></span><br><span class="line">            <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> serverWebExchange.getRequest();</span><br><span class="line">            <span class="comment">// 获取第一个请求参数</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">first</span> <span class="operator">=</span> request.getQueryParams().getFirst(config.param);</span><br><span class="line">            <span class="comment">//判断 param 不为空，并且参数值和配置文件的参数值相等</span></span><br><span class="line">            <span class="keyword">return</span> StringUtils.hasText(first) &amp;&amp; Objects.equals(first, config.value);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Validated</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="meta">@NotEmpty</span> String param;</span><br><span class="line">        <span class="keyword">private</span> <span class="meta">@NotEmpty</span> String value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParam</span><span class="params">(<span class="meta">@NotEmpty</span> String param)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.param = param;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="meta">@NotEmpty</span> String <span class="title function_">getParam</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> param;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(<span class="meta">@NotEmpty</span> String value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="meta">@NotEmpty</span> String <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置文件</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">biying</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://cn.bing.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Path</span>  <span class="comment"># 路径断言</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">patterns:</span> <span class="string">/search</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Query</span> <span class="comment"># 查询断言</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">param:</span> <span class="string">q</span> <span class="comment"># 必须满足参数是q</span></span><br><span class="line">                <span class="attr">regexp:</span> <span class="string">haha</span> <span class="comment"># 参数值是 haha 才能，跳转到相应的路径</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">VipPredicateFactory</span> <span class="comment"># 这个参数名必须和配置的类名一样</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">param:</span> <span class="string">user</span></span><br><span class="line">                <span class="attr">value:</span> <span class="string">lazy</span></span><br></pre></td></tr></table></figure></li><li><p>测试</p></li></ol><p>​<img src="/hexo-docs/images/alibabaImage/image-20250402190044849.png" alt="image-20250402190044849"></p><p>参数部分顺序，必须这两个条件同时满足才会生效！</p><blockquote><p>注意：</p><p>​如果类名是以<code>xxxRoutePredicateFactory</code>命名的话，到时候配置文件的name属性可以，<code>xxx</code>写，不需要写完整名，否则就写完整名</p></blockquote><h3 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h3><table><thead><tr><th>名</th><th>参数（个数&#x2F;类型）</th><th>作用</th></tr></thead><tbody><tr><td>AddRequestHeader</td><td>2&#x2F;string</td><td>添加请求头</td></tr><tr><td>AddRequestHeadersIfNotPresent</td><td>1&#x2F;List&lt;string&gt;</td><td>如果没有则添加请求头，key:value方式</td></tr><tr><td>AddRequestParameter</td><td>2&#x2F;string、string</td><td>添加请求参数</td></tr><tr><td>AddResponseHeader</td><td>2&#x2F;string、string</td><td>添加响应头</td></tr><tr><td>CircuitBreaker</td><td>1&#x2F;string</td><td>仅支持forward:&#x2F;inCaseOfFailureUseThis方式进行熔断</td></tr><tr><td>CacheRequestBody</td><td>1&#x2F;string</td><td>缓存请求体</td></tr><tr><td>DedupeResponseHeader</td><td>1&#x2F;string</td><td>移除重复响应头，多个用空格分割</td></tr><tr><td>FallbackHeaders</td><td>1&#x2F;string</td><td>设置Fallback头</td></tr><tr><td>JsonToGrpc</td><td></td><td>请求体Json转为gRPC</td></tr><tr><td>LocalResponseCache</td><td>2&#x2F;string</td><td>响应数据本地缓存</td></tr><tr><td>MapRequestHeader</td><td>2&#x2F;string</td><td>把某个请求头名字变为另一个名字</td></tr><tr><td>ModifyRequestBody</td><td>仅 Java 代码方式</td><td>修改请求体</td></tr><tr><td>ModifyResponseBody</td><td>仅 Java 代码方式</td><td>修改响应体</td></tr><tr><td>PrefixPath</td><td>1&#x2F;string</td><td>自动添加请求前缀路径</td></tr><tr><td>PreserveHostHeader</td><td>0</td><td>保护Host头</td></tr><tr><td>RedirectTo</td><td>3&#x2F;string</td><td>重定向到指定位置</td></tr><tr><td>RemoveJsonAttributesResponseBody</td><td>1&#x2F;string</td><td>移除响应体中的某些Json字段，多个用,分割</td></tr><tr><td>RemoveRequestHeader</td><td>1&#x2F;string</td><td>移除请求头</td></tr><tr><td>RemoveRequestParameter</td><td>1&#x2F;string</td><td>移除请求参数</td></tr><tr><td>RemoveResponseHeader</td><td>1&#x2F;string</td><td>移除响应头</td></tr><tr><td>RequestHeaderSize</td><td>2&#x2F;string</td><td>设置请求大小，超出则响应431状态码</td></tr><tr><td>RequestRateLimiter</td><td>1&#x2F;string</td><td>请求限流</td></tr><tr><td>RewriteLocationResponseHeader</td><td>4&#x2F;string</td><td>重写Location响应头</td></tr><tr><td>RewritePath</td><td>2&#x2F;string</td><td>路径重写</td></tr><tr><td>RewriteRequestParameter</td><td>2&#x2F;string</td><td>请求参数重写</td></tr><tr><td>RewriteResponseHeader</td><td>3&#x2F;string</td><td>响应头重写</td></tr><tr><td>SaveSession</td><td>0</td><td>session保存，配合spring-session框架</td></tr><tr><td>SecureHeaders</td><td>0</td><td>安全头设置</td></tr><tr><td>SetPath</td><td>1&#x2F;string</td><td>路径修改</td></tr><tr><td>SetRequestHeader</td><td>2&#x2F;string</td><td>请求头修改</td></tr><tr><td>SetResponseHeader</td><td>2&#x2F;string</td><td>响应头修改</td></tr><tr><td>SetStatus</td><td>1&#x2F;int</td><td>设置响应状态码</td></tr><tr><td>StripPrefix</td><td>1&#x2F;int</td><td>路径层级拆除</td></tr><tr><td>Retry</td><td>7&#x2F;string</td><td>请求重试设置</td></tr><tr><td>RequestSize</td><td>1&#x2F;string</td><td>请求大小限定</td></tr><tr><td>SetRequestHostHeader</td><td>1&#x2F;string</td><td>设置Host请求头</td></tr><tr><td>TokenRelay</td><td>1&#x2F;string</td><td>OAuth2的token转发</td></tr></tbody></table><p>示例：</p><p>​去除，<code>controller</code>的<code>/api/order</code>和<code>/api/product</code>请求，使用过滤器添加</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">biying</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://cn.bing.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Path</span>  <span class="comment"># 路径断言</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">patterns:</span> <span class="string">/search</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Query</span> <span class="comment"># 查询断言</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">param:</span> <span class="string">q</span> <span class="comment"># 必须满足参数是q</span></span><br><span class="line">                <span class="attr">regexp:</span> <span class="string">haha</span> <span class="comment"># 参数值是 haha 才能，跳转到相应的路径</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Vip</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">param:</span> <span class="string">user</span></span><br><span class="line">                <span class="attr">value:</span> <span class="string">lazy</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-order</span> <span class="comment"># id</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-order</span> <span class="comment"># 负载均衡 service-order</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 断言</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Path</span> <span class="comment"># 用什么方式进行断言</span></span><br><span class="line">              <span class="attr">args:</span>   <span class="comment"># 断言的参数</span></span><br><span class="line">               <span class="attr">patterns:</span> <span class="string">/api/order/**</span> <span class="comment"># 下面的所有请求</span></span><br><span class="line">               <span class="attr">matchTrailingSlash:</span> <span class="literal">true</span> <span class="comment"># 如果设置为true的话，/api/order/1/ 可以匹配到和 /api/order/1 也可以匹配到</span></span><br><span class="line">          <span class="attr">filters:</span> <span class="comment"># 在请求的时候添加/api/order/ab/c路径</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">RewritePath=/api/order/?(?&lt;segment&gt;.*),</span> <span class="string">/$\&#123;segment&#125;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AddResponseHeader=X-Response-xxx,</span> <span class="number">123</span> <span class="comment"># 添加响应头请求头的参数，值为123</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">0</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-product</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-product</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/product/**</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">2</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">RewritePath=/api/product/?(?&lt;segment&gt;.*),</span> <span class="string">/$\&#123;segment&#125;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AddResponseHeader=X-Response-xxx,</span> <span class="number">123</span> <span class="comment"># 添加响应头请求头的参数，值为123</span></span><br></pre></td></tr></table></figure><p>效果：</p><p><img src="/hexo-docs/images/alibabaImage/image-20250402202040568.png" alt="image-20250402202040568"></p><h3 id="默认过滤器"><a href="#默认过滤器" class="headerlink" title="默认过滤器"></a>默认过滤器</h3><p>添加过滤器并将其应用于所有路由，可以使用 <code>spring.cloud.gateway.default-filters</code> 。该属性接受一个过滤器列表。以下列表定义了一组默认过滤器：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">biying</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://cn.bing.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Path</span>  <span class="comment"># 路径断言</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">patterns:</span> <span class="string">/search</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Query</span> <span class="comment"># 查询断言</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">param:</span> <span class="string">q</span> <span class="comment"># 必须满足参数是q</span></span><br><span class="line">                <span class="attr">regexp:</span> <span class="string">haha</span> <span class="comment"># 参数值是 haha 才能，跳转到相应的路径</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Vip</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">param:</span> <span class="string">user</span></span><br><span class="line">                <span class="attr">value:</span> <span class="string">lazy</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-order</span> <span class="comment"># id</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-order</span> <span class="comment"># 负载均衡 service-order</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 断言</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Path</span> <span class="comment"># 用什么方式进行断言</span></span><br><span class="line">              <span class="attr">args:</span>   <span class="comment"># 断言的参数</span></span><br><span class="line">               <span class="attr">patterns:</span> <span class="string">/api/order/**</span> <span class="comment"># 下面的所有请求</span></span><br><span class="line">               <span class="attr">matchTrailingSlash:</span> <span class="literal">true</span> <span class="comment"># 如果设置为true的话，/api/order/1/ 可以匹配到和 /api/order/1 也可以匹配到</span></span><br><span class="line">          <span class="attr">filters:</span> <span class="comment"># 在请求的时候添加/api/order/ab/c路径</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">RewritePath=/api/order/?(?&lt;segment&gt;.*),</span> <span class="string">/$\&#123;segment&#125;</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">0</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-product</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-product</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/product/**</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">2</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">RewritePath=/api/product/?(?&lt;segment&gt;.*),</span> <span class="string">/$\&#123;segment&#125;</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">AddResponseHeader=X-Response-xxx,</span> <span class="number">123</span></span><br></pre></td></tr></table></figure><p>测试：</p><p>​我们访问<code>/api/order/readDb</code>会有响应头和<code>/api/product/product/1</code>也会有响应头</p><p><img src="/hexo-docs/images/alibabaImage/image-20250402202708242.png" alt="image-20250402202708242"></p><p><img src="/hexo-docs/images/alibabaImage/image-20250402202809463.png" alt="image-20250402202809463"></p><h3 id="全局过滤器GlobalFilter"><a href="#全局过滤器GlobalFilter" class="headerlink" title="全局过滤器GlobalFilter"></a>全局过滤器GlobalFilter</h3><p>我们想记录请求时间和响应时间用了多少毫秒，我们就可以使用<code>GlobalFilter</code>来记录</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.gateway.filter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RtGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span> , Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.getURI().toString();</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        log.info(<span class="string">&quot;请求[&#123;&#125;] 开始，时间：&#123;&#125;&quot;</span>,uri,start);</span><br><span class="line">        <span class="comment">//放行，这个方法是一个异步执行的</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange)</span><br><span class="line">                .doFinally((source) -&gt; &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            log.info(<span class="string">&quot;请求[&#123;&#125;] 结束，耗时：&#123;&#125;ms&quot;</span>, uri, end - start);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 执行顺序，数字越小，执行的顺序越优先执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/alibabaImage/image-20250402204536360.png" alt="image-20250402204536360"></p><h3 id="自定义过滤器"><a href="#自定义过滤器" class="headerlink" title="自定义过滤器"></a>自定义过滤器</h3><p>如果我们想在请求头里面添加token，可以自定义使用过滤器添加，如果写的是uuid我们就生成uuid，如果写的是jwt那我们就生成jwt</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.gateway.filter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OnceTokenFilter</span> <span class="keyword">extends</span> <span class="title class_">AbstractNameValueGatewayFilterFactory</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GatewayFilter <span class="title function_">apply</span><span class="params">(NameValueConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (exchange, chain) -&gt; chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123; <span class="comment">//开启一个异步任务</span></span><br><span class="line">            <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">            <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> response.getHeaders();<span class="comment">//获取响应头</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">//判断是否为uuid，不区分大小写</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;uuid&quot;</span>.equals(config.getValue())) &#123;</span><br><span class="line">                value = UUID.randomUUID().toString();</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;jwt&quot;</span>.equals(config.getValue()))&#123;</span><br><span class="line">                value = <span class="string">&quot;jwt&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            headers.add(config.getName(), value);</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">biying</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://cn.bing.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Path</span>  <span class="comment"># 路径断言</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">patterns:</span> <span class="string">/search</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Query</span> <span class="comment"># 查询断言</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">param:</span> <span class="string">q</span> <span class="comment"># 必须满足参数是q</span></span><br><span class="line">                <span class="attr">regexp:</span> <span class="string">haha</span> <span class="comment"># 参数值是 haha 才能，跳转到相应的路径</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Vip</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">param:</span> <span class="string">user</span></span><br><span class="line">                <span class="attr">value:</span> <span class="string">lazy</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">3</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-order</span> <span class="comment"># id</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-order</span> <span class="comment"># 负载均衡 service-order</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 断言</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Path</span> <span class="comment"># 用什么方式进行断言</span></span><br><span class="line">              <span class="attr">args:</span>   <span class="comment"># 断言的参数</span></span><br><span class="line">               <span class="attr">patterns:</span> <span class="string">/api/order/**</span> <span class="comment"># 下面的所有请求</span></span><br><span class="line">               <span class="attr">matchTrailingSlash:</span> <span class="literal">true</span> <span class="comment"># 如果设置为true的话，/api/order/1/ 可以匹配到和 /api/order/1 也可以匹配到</span></span><br><span class="line">          <span class="attr">filters:</span> <span class="comment"># 在请求的时候添加/api/order/ab/c路径</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">RewritePath=/api/order/?(?&lt;segment&gt;.*),</span> <span class="string">/$\&#123;segment&#125;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">OnceTokenFilter=X-Response-token,</span> <span class="string">uuid</span> <span class="comment"># OnceTokenFilter 配置的过滤器类名</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">0</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-product</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-product</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/product/**</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">2</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">RewritePath=/api/product/?(?&lt;segment&gt;.*),</span> <span class="string">/$\&#123;segment&#125;</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">AddResponseHeader=X-Response-Red,</span> <span class="string">Blue</span></span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/alibabaImage/image-20250402211000691.png" alt="image-20250402211000691"></p><blockquote><p>注意：</p><p>​只要文件后缀名为<code>XXXGatewayFilterFactory</code>,配置文件配置的时候就可以写<code>XXX</code>,可以省略<code>GatewayFilterFactory</code></p></blockquote><h3 id="Gateway解决跨域请求"><a href="#Gateway解决跨域请求" class="headerlink" title="Gateway解决跨域请求"></a>Gateway解决跨域请求</h3><p>由于我们的项目被月拆分越多，我们不可能在每一个项目都配置解决跨域请求，然而<code>spring</code>官网就给我在<code>Gateway</code>网关上统一配置解决方案</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">globalcors:</span></span><br><span class="line">        <span class="attr">cors-configurations:</span></span><br><span class="line">          <span class="string">&#x27;[/**]&#x27;</span><span class="string">:</span> <span class="comment">#允许所有请求可以访问</span></span><br><span class="line">            <span class="attr">allowed-origin-patterns:</span> <span class="string">&#x27;*&#x27;</span> <span class="comment"># 允许所有请求可以被访问</span></span><br><span class="line">            <span class="attr">allowed-headers:</span> <span class="string">&#x27;*&#x27;</span> <span class="comment"># 允许所有的请求头</span></span><br><span class="line">            <span class="attr">allowedMethods:</span> <span class="string">&#x27;*&#x27;</span> <span class="comment"># 允许所有的方法可以被访问</span></span><br></pre></td></tr></table></figure><p>也可以单独在某一个请求下面配置跨域</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">cors_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/service/**</span></span><br><span class="line">        <span class="attr">metadata:</span></span><br><span class="line">          <span class="attr">cors:</span></span><br><span class="line">            <span class="attr">allowedOrigins:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">            <span class="attr">allowedMethods:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">GET</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">POST</span></span><br><span class="line">            <span class="attr">allowedHeaders:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">            <span class="attr">maxAge:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure><p>效果</p><p><img src="/hexo-docs/images/alibabaImage/image-20250402212525786.png" alt="image-20250402212525786"></p><h3 id="微服务内部调用是否需要走网关"><a href="#微服务内部调用是否需要走网关" class="headerlink" title="微服务内部调用是否需要走网关"></a>微服务内部调用是否需要走网关</h3><p>在微服务架构中，<strong>服务网关</strong>通常用于处理外部请求的路由转发、权限校验、限流和监控等功能。然而，对于微服务内部的调用，是否需要经过网关，取决于具体的架构设计和需求。</p><p><strong>服务网关的作用</strong></p><p>服务网关主要用于接收外部请求，并将其转发到后端的微服务上，同时可以在网关中实现一系列的横切功能，如权限校验、限流和监控。通过将这些功能集中在网关中，可以避免在每个微服务中重复实现这些功能，从而减少代码冗余和维护成本。</p><p>内部调用是否需要走网关</p><p>对于微服务内部的调用，通常不需要经过网关。原因如下：</p><ol><li><strong>性能考虑</strong>：增加网关会增加一层转发，可能会导致性能下降。</li><li><strong>内部请求的特殊性</strong>：内部服务之间的调用通常不需要进行权限校验和限流等操作。</li><li>网关是直接对接前端的。</li></ol><p>例外情况</p><p>在某些情况下，可能会选择让内部调用也经过网关，例如：</p><ol><li><strong>统一监控和日志</strong>：如果希望对所有的服务调用进行统一的监控和日志记录，可以选择让内部调用也经过网关。</li><li><strong>简化架构</strong>：在某些复杂的架构中，通过网关可以简化服务间的调用逻辑和管理。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 后端 Spring Cloud Alibaba </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring Cloud </tag>
            
            <tag> Spring Cloud alibaba </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloud Netflix</title>
      <link href="/hexo-docs/2025/08/23/SpringCloud/netflix/chapter01/"/>
      <url>/hexo-docs/2025/08/23/SpringCloud/netflix/chapter01/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringCloud快速入门"><a href="#SpringCloud快速入门" class="headerlink" title="SpringCloud快速入门"></a>SpringCloud快速入门</h1><h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h2><blockquote><p>学习前提</p></blockquote><ul><li>熟练使用SpringBoot 微服务快速开发框架</li><li>了解过Dubbo + Zookeeper 分布式基础</li><li>电脑配置内存不低于8G(个人是16G)</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/01/image-20220210221321005.png" alt="image-20220210221321005"></p><blockquote><p>SpringCloud五大组件</p></blockquote><ul><li>参考CSDN博文：<a href="https://blog.csdn.net/weixin_41217541/article/details/104718834">https://blog.csdn.net/weixin_41217541/article/details/104718834</a></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/01/springcloud.png" alt="/images/SpringCloudNetflixImage"></p><table><thead><tr><th>组件</th><th>选型</th><th>备注</th></tr></thead><tbody><tr><td>网关</td><td>Zuul</td><td></td></tr><tr><td>服务注册与发现</td><td>Eureka Consul zookeeper</td><td></td></tr><tr><td>服务调用</td><td>Feign</td><td>根据注解和选择机器,拼接Url地址,发起请求 简化服务调用</td></tr><tr><td>负载均衡</td><td>Ribbon</td><td>服务调用负载均衡，配合Feign和Euraka使用</td></tr><tr><td>断路器</td><td>Hystrix</td><td>隔离、熔断以及降级的一个框架 服务线程池隔离，实现不同服务的调度隔离，避免服务雪崩</td></tr></tbody></table><ul><li>Eureka:服务启动时,Eureka会将服务注册到EurekaService,并且EurakeClient还可以返回过来从EurekaService拉去注册表,从而知道服务在哪里。</li><li>Ribbon:服务间发起请求的时候,基于Ribbon服务做到负载均衡,从一个服务的对台机器中选择一台。</li><li>Feign:基于fegin的动态代理机制,根据注解和选择机器,拼接Url地址,发起请求。</li><li>Hystrix:发起的请求是通过Hystrix的线程池来走,不同的服走不同的线程池,实现了不同的服务调度隔离,避免服务雪崩的问题。</li><li>Zuul:如果前端后端移动端调用后台系统,统一走zull网关进入,有zull网关转发请求给对应的服务。</li></ul><blockquote><p>常见面试题</p></blockquote><ol><li><p>什么是微服务？</p></li><li><p>微服务之间是如何独立通讯的？</p></li><li><p>SpringCloud 和 Dubbo有哪些区别？ </p></li><li><p>SpringBoot和SpringCloud，请你谈谈对他们的理解 </p></li><li><p>什么是服务熔断？什么是服务降级 </p></li><li><p>微服务的优缺点是分别是什么？说下你在项目开发中遇到的坑 </p></li><li><p>你所知道的微服务技术栈有哪些？请列举一二 </p></li><li><p>eureka和zookeeper都可以提供服务注册与发现的功能，请说说两个的区别？</p></li></ol><h2 id="2-微服务概述"><a href="#2-微服务概述" class="headerlink" title="2.微服务概述"></a>2.微服务概述</h2><blockquote><p>什么是微服务？</p></blockquote><p>微服务（Microservice Architecture）是近几年流行的一种架构思想，关于它的概念很 难一言以蔽之。究竟什么是微服务呢？我们在此引用 ThoughtWorks 公司的首席科学家 Martin Fowler 于2014年提出的一段话：</p><p><img src="/hexo-docs/images/SpringCloudNetflixImage/01/format.png" alt="/images/SpringCloudNetflixImage"></p><ul><li><p>原文：<a href="https://martinfowler.com/articles/microservices.html">https://martinfowler.com/articles/microservices.html</a> </p></li><li><p>汉化：<a href="https://www.cnblogs.com/liuning8023/p/4493156.html">https://www.cnblogs.com/liuning8023/p/4493156.html</a></p></li><li><p>就目前而言，对于微服务，业界并没有一个统一的，标准的定义 </p></li><li><p>但通常而言，微服务架构是一种架构模式，或者说是一种架构风格， 它提倡将单一的应用程序划分成一组小的服务，每个服务运行在其独立的自己的进程内，服务之间互相协调，互相配置，为用户提供最终价值。服务之间采用轻量级的通信机制互相沟通，每个服务都围绕着具体的业务进行构建，并且能够被 独立的部署到生产环境中，另外，应尽量避免统一的，集中式的服务管理机制，对具体的一个服务而言，应根据业务上下文，选择合适的语言，工具对其进行构建，可以有一个非常轻量级的集中式管理来 协调这些服务，可以使用不同的语言来编写服务，也可以使用不同的数据存储； </p></li><li><p>可能有的人觉得官方的话太过生涩，我们从技术维度来理解下：</p></li><li><p>微服务化的核心就是将传统的一站式应用，根据业务拆分成一个一个的服务，彻底地去耦合，每一个微服务提供单个业务功能的服务，一个服务做一件事情，从技术角度看就是一种小而独立的处理过程，类似进程的概念，能够自行单独启动或销毁，拥有自己独立的数据库。</p></li></ul><blockquote><p>微服务与微服务架构：</p></blockquote><p><strong>微服务</strong> </p><ul><li>强调的是服务的大小，他关注的是某一个点，是具体解决某一个问题&#x2F;提供落地对应服务的一个服务应用，狭义的看，可以看做是IDEA中的一个个微服务工程，或者Moudel</li></ul><p><strong>微服务架构</strong> </p><ul><li><p>一种新的架构形式，Martin Fowler，2014提出！ </p></li><li><p>微服务架构是一种架构模式，它提倡将单一应用程序划分成一组小的服务，服务之间互相协调，互相配合，为用户提供最终价值。每个服务运行在其独立的进程中，服务于服务间采用轻量级的通信机制互相协作，每个服务都围绕着具体的业务进行构建，并且能够被独立的部署到生产环境中，另外，应尽量避免统一的，集中式的服务管理机制，对具体的一个服务而言，应根据业务上下文，选择合适的语言，工具对其进行构建。</p></li></ul><p><strong>微服务优缺点</strong></p><ul><li><p>优点：</p><ul><li>每个服务足够内聚，足够小，代码容易理解，这样能聚焦一个指定的业务功能或业务需求； </li><li>开发简单，开发效率提高，一个服务可能就是专一的只干一件事； </li><li>微服务能够被小团队单独开发，这个小团队是2~5人的开发人员组成； </li><li>微服务是松耦合的，是有功能意义的服务，无论是在开发阶段或部署阶段都是独立的。 微服务能使用不同的语言开发。 </li><li>易于和第三方集成，微服务允许容易且灵活的方式集成自动部署，通过持续集成工具，如jenkins， Hudson，bamboo </li><li>微服务易于被一个开发人员理解，修改和维护，这样小团队能够更关注自己的工作成果。无需通过合作才能体现价值。 </li><li>微服务允许你利用融合最新技术。 微服务只是业务逻辑的代码，不会和HTML，CSS或其他界面混合 </li><li>每个微服务都有自己的存储能力，可以有自己的数据库，也可以有统一数据库</li></ul></li><li><p>缺点： </p><ul><li>开发人员要处理分布式系统的复杂性 </li><li>多服务运维难度，随着服务的增加，运维的压力也在增大 </li><li>系统部署依赖 </li><li>服务间通信成本 </li><li>数据一致性 </li><li>系统集成测试 </li><li>性能监控…..</li></ul></li></ul><blockquote><p>微服务技术栈有哪些？</p></blockquote><table><thead><tr><th>微服务条目</th><th>落地技术</th></tr></thead><tbody><tr><td>服务开发</td><td>SpringBoot,Spring,SpringMVC</td></tr><tr><td>服务配置与管理</td><td>Netflix公司的Archaius、阿里的Diamond等</td></tr><tr><td>服务注册与发现</td><td>Eureka、Consul、Zookeeper等</td></tr><tr><td>服务调用</td><td>Rest、RPC、gRPC</td></tr><tr><td>服务熔断器</td><td>Hystrix、Envoy等</td></tr><tr><td>负载均衡</td><td>Ribbon、Nginx等</td></tr><tr><td>服务接口调用（客户端调用服务的简化工具）</td><td>Feign等</td></tr><tr><td>消息队列</td><td>Kafka、RabbitMQ、ActiveMQ等</td></tr><tr><td>服务配置中心管理</td><td>SpringCloudConfig、Chef等</td></tr><tr><td>服务路由（API网关）</td><td>服务监控</td></tr><tr><td>服务监控</td><td>Zabbix、Nagios、Metrics、Specatator等</td></tr><tr><td>全链路追踪</td><td>Zipkin、Brave、Dapper等</td></tr><tr><td>服务部署</td><td>Docker、OpenStack、Kubernetes等</td></tr><tr><td>数据流操作开发包</td><td>SpringCloud Stream(封装与Redis，Rabbit，Kafka等发 送接收消息)</td></tr><tr><td>事件消息总线</td><td>SpringCloud Bus</td></tr></tbody></table><ul><li>Spring Cloud Alibaba</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/01/Spring%20Cloud%20Alibaba.png" alt="Spring Cloud Alibaba"></p><blockquote><p>为什么选择SpringCloud作为微服务架构？</p></blockquote><p>1、选型依据 </p><ul><li>整体解决方案和框架成熟度 </li><li>社区热度 </li><li>可维护性 </li><li>学习曲线</li></ul><p>2、当前各大IT公司用的微服务架构有哪些？ </p><ul><li>阿里：dubbo+HFS </li><li>京东：JSF </li><li>新浪：Motan </li><li>当当网 DubboX </li><li>…….</li></ul><p>3、各微服务框架对比</p><table><thead><tr><th>功能点&#x2F; 服务框架</th><th>Netflix&#x2F;SpringCloud</th><th>Motan</th><th>gRPC</th><th>Thrift</th><th>Dubbo&#x2F;DubboX</th></tr></thead><tbody><tr><td>功能定位</td><td>完整的微服务框架</td><td>RPC框架，但整合了ZK或Consul，实现集群环境的基本服务注册&#x2F;发现</td><td>RPC框 架</td><td>RPC框架</td><td>服务框架</td></tr><tr><td>支持Rest</td><td>是，Ribbon支持多种可插拔的序列化选择</td><td>否</td><td>否</td><td>否</td><td>否</td></tr><tr><td>支持RPC</td><td>否</td><td>是（Hession2）</td><td>是</td><td>是</td><td>是</td></tr><tr><td>支持多语言</td><td>是（Rest形式）？</td><td>否</td><td>是</td><td>是</td><td>否</td></tr><tr><td>负载均衡</td><td>是（服务端zuul+客户端 Ribbon），zuul-服务，动态路由，云端负载均衡 Eureka（针对中间层服务器）</td><td>是（客户端）</td><td>否</td><td>否</td><td>是（客户端）</td></tr><tr><td>配置服务</td><td>Netfix Archaius，Spring Cloud Config Server集中 配置</td><td>是（zookeeper提供）</td><td>否</td><td>否</td><td>否</td></tr><tr><td>服务调用链监控</td><td>是（zuul），zuul提供边缘服务，API网关</td><td>否</td><td>否</td><td>否</td><td>否</td></tr><tr><td>高可用&#x2F;容错</td><td>是（服务端Hystrix+客户端Ribbon）</td><td>是（客户端）</td><td>否</td><td>否</td><td>是（客户端）</td></tr><tr><td>典型应用案例</td><td>Netflix</td><td>Sina</td><td>Google</td><td>Facebook</td><td></td></tr><tr><td>社区活跃程度</td><td>高</td><td>一般</td><td>高</td><td>一般</td><td>2017年后重新开始维护，之前中断了5年</td></tr><tr><td>学习难度</td><td>中断</td><td>低</td><td>高</td><td>高</td><td>低</td></tr><tr><td>文档丰富程度</td><td>高</td><td>一般</td><td>一般</td><td>一般</td><td>高</td></tr><tr><td>其他</td><td>Spring Cloud Bus为我们 的应用程序带来了更多管理端点</td><td>支持降级</td><td>Netflix 内部在开发集成 gRPC</td><td>IDL定义</td><td>实践的公司比较 多</td></tr></tbody></table><h2 id="3-SpringCloud入门"><a href="#3-SpringCloud入门" class="headerlink" title="3.SpringCloud入门"></a>3.SpringCloud入门</h2><blockquote><p>SpringCloud是什么？</p></blockquote><ul><li>Spring官网:<a href="https://spring.io/">https://spring.io/</a></li><li>地址：<a href="https://spring.io.xy2401.com/">Spring (xy2401.com)</a></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/01/image-20220210213122366.png" alt="image-20220210213122366"></p><p><img src="/hexo-docs/images/SpringCloudNetflixImage/01/diagram-distributed-systems.svg" alt="/images/SpringCloudNetflixImage"></p><ul><li><p>SpringCloud, 基于SpringBoot提供了一套微服务解决方案，包括服务注册与发现，配置中心，全链路监控，服务网关，负载均衡，熔断器等组件，除了基于NetFlix的开源组件做高度抽象封装之外，还有一些选型中立的开源组件。 </p></li><li><p>SpringCloud利用SpringBoot的开发便利性，巧妙地简化了分布式系统基础设施的开发，SpringCloud为开发人员提供了快速构建分布式系统的一些工具，&#x3D;&#x3D;包括配置管理，服务发现，断路器，路由，微代理，事件总线，全局锁，决策竞选，分布式会话等等&#x3D;&#x3D;，他们都可以用SpringBoot的开发风格做到一键启动和部署。</p></li><li><p>SpringBoot并没有重复造轮子，它只是将目前各家公司开发的比较成熟，经得起实际考研的服务框架组合起来，通过SpringBoot风格进行再封装，屏蔽掉了复杂的配置和实现原理，最终给开发者留出了一套简单易懂，易部署和易维护的分布式系统开发工具包。</p></li><li><p>SpringCloud是分布式微服务架构下的一站式解决方案，是各个微服务架构落地技术的集合体，俗称微 服务全家桶。</p></li></ul><blockquote><p>SpringCloud和SpringBoot关系</p></blockquote><ul><li>SpringBoot专注于快速方便的开发单个个体微服务。</li><li>SpringCloud是关注全局的微服务协调整理治理框架，它将SpringBoot开发的一个个单体微服务整合并管理起来，为各个微服务之间提供：配置管理，服务发现，断路器，路由，微代理，事件总线，全局锁，决策竞选，分布式会话等等集成服务。</li><li>SpringBoot可以离开SpringClooud独立使用，开发项目，但是SpringCloud离不开SpringBoot，属于依赖关系。</li><li>SpringBoot专注于快速、方便的开发单个个体微服务，SpringCloud关注全局的服务治理框架。</li></ul><blockquote><h5 id="分布式-服务治理Dubbo"><a href="#分布式-服务治理Dubbo" class="headerlink" title="分布式+服务治理Dubbo"></a>分布式+服务治理Dubbo</h5></blockquote><ul><li>目前成熟的互联网架构，应用服务化拆分 + 消息中间件。</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/01/image-20220211113445309.png" alt="image-20220214150037631"></p><blockquote><p>Dubbo和SpringCloud对比</p></blockquote><ul><li>可以看一下社区活跃度：<ul><li><a href="https://github.com/dubbo">https://github.com/dubbo</a></li><li><a href="https://github.com/spring-cloud">https://github.com/spring-cloud</a></li></ul></li><li>对比结果：</li></ul><table><thead><tr><th></th><th>Dubbo</th><th>SpringCloud</th></tr></thead><tbody><tr><td>服务注册中心</td><td>Zookeeper</td><td>Spring Cloud Netfilx Eureka</td></tr><tr><td>服务调用方式</td><td>RPC</td><td>REST API</td></tr><tr><td>服务监控</td><td>Dubbo-monitor</td><td>Spring Boot Admin</td></tr><tr><td>断路器</td><td>不完善</td><td>Spring Cloud Netfilx Hystrix</td></tr><tr><td>服务网关</td><td>无</td><td>Spring Cloud Netfilx Zuul</td></tr><tr><td>分布式配置</td><td>无</td><td>Spring Cloud Config</td></tr><tr><td>服务跟踪</td><td>无</td><td>Spring Cloud Sleuth</td></tr><tr><td>消息总栈</td><td>无</td><td>Spring Cloud Bus</td></tr><tr><td>数据流</td><td>无</td><td>Spring Cloud Stream</td></tr><tr><td>批量任务</td><td>无</td><td>Spring Cloud Task</td></tr></tbody></table><ul><li><p>&#x3D;&#x3D;最大区别：SpringCloud抛弃了Dubbo的RPC通信，采用的是基于HTTP的REST方式&#x3D;&#x3D;。 </p></li><li><p>严格来说，这两种方式各有优劣。虽然从一定程度上来说，后者牺牲了服务调用的性能，但也避免了上 面提到的原生RPC带来的问题。而且REST相比RPC更为灵活，服务提供方和调用方的依赖只依靠一纸契约，不存在代码级别的强依赖，这在强调快速演化的微服务环境下，显得更加合适。</p></li></ul><blockquote><p>品牌机与组装机的区别 </p></blockquote><ul><li>很明显，Spring Cloud的功能比DUBBO更加强大，涵盖面更广，而且作为Spring的拳头项目，它也能够与Spring Framework、Spring Boot、Spring Data、Spring Batch等其他Spring项目完美融合，这些对 于微服务而言是至关重要的。使用Dubbo构建的微服务架构就像组装电脑，各环节我们的选择自由度很 高，但是最终结果很有可能因为一条内存质量不行就点不亮了，总是让人不怎么放心，但是如果你是一名高手，那这些都不是问题；而Spring Cloud就像品牌机，在Spring Source的整合下，做了大量的兼容性测试，保证了机器拥有更高的稳定性，但是如果要在使用非原装组件外的东西，就需要对其基础有足够的了解。</li></ul><blockquote><p>社区支持与更新力度 </p></blockquote><ul><li>最为重要的是，DUBBO停止了5年左右的更新，虽然2017.7重启了。对于技术发展的新需求，需要由开发者自行拓展升级（比如当当网弄出了DubboX），这对于很多想要采用微服务架构的中小软件组织，显然是不太合适的，中小公司没有这么强大的技术能力去修改Dubbo源码+周边的一整套解决方案，并不是每一个公司都有阿里的大牛+真实的线上生产环境测试过。 </li><li>设计模式+微服务拆分思想。</li></ul><blockquote><p>总结： </p></blockquote><ul><li>曾风靡国内的开源 RPC 服务框架Dubbo在重启维护后，令许多用户为之雀跃，但同时，也迎来了一些质疑的声音。互联网技术发展迅速，Dubbo是否还能跟上时代？Dubbo 与 Spring Cloud相比又有何优势和差异？是否会有相关举措保证Dubbo的后续更新频率？ </li><li>人物：Dubbo重启维护开发的刘军，主要负责人之一。<ul><li>刘军，阿里巴巴中间件高级研发工程师，主导了Dubbo 重启维护以后的几个发版计划，专注于高性能 RPC 框架和微服务相关领域。曾负责网易考拉RPC框架的研发及指导在内部使用，参与了服务治理平台、分布式跟踪系统、分布式一致性框架等从无到有的设计与开发过程。</li></ul></li><li>&#x3D;&#x3D;解决的问题域不一样：Dubbo的定位是一款RPC框架，Spring Cloud的目标是微服务架构下的一站式解决方案&#x3D;&#x3D;。</li></ul><blockquote><p>SpringCloud能干嘛？</p></blockquote><ul><li>Distributed&#x2F;versioned configuration （分布式&#x2F;版本控制配置） </li><li>Service registration and discovery（服务注册与发现） </li><li>Routing（路由） </li><li>Service-to-service calls（服务到服务的调用） </li><li>Load balancing（负载均衡配置） </li><li>Circuit Breakers（断路器） </li><li>Distributed messaging（分布式消息管理） </li><li>….</li></ul><blockquote><p>SpringCloud在哪获取？</p></blockquote><ul><li>官网：<a href="http://projects.spring.io/spring-cloud/">http://projects.spring.io/spring-cloud/</a></li><li>它的版本号有点特别：</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/01/image-20220210215814438.png" alt="image-20220210215814438"></p><ul><li>Spring Cloud是一个由众多独立子项目组成的大型综合项目，每个子项目有不同的发行节奏，都维护着自己的发布版本号。Spring Cloud通过一个资源清单BOM（Bill of Materials）来管理每个版本的子项目清单。为避免与子项目的发布号混淆，所以<code>没有采用版本号的方式，而是通过命名的方式</code>。</li><li>这些版本名称的命名方式<code>采用了伦敦地铁站的名称，同时根据字母表的顺序来对应版本时间顺序</code>，比如：最早的Release版本：Angel，第二个Release版本：Brixton，然后是Camden、Dalston、Edgware，Finchley,目前最新的是Hoxton 版本。</li></ul><blockquote><p>自学参考： </p></blockquote><ul><li>SpringCloud Netflix 中文文档：<a href="https://springcloud.cc/spring-cloud-netflix.html">https://springcloud.cc/spring-cloud-netflix.html</a></li><li>SpringCloud 中文API文档(官方文档翻译版)：<a href="https://springcloud.cc/spring-cloud-dalston.html">https://springcloud.cc/spring-cloud-dalston.html</a></li><li>SpringCloud中国社区：<a href="http://docs.springcloud.cn/">http://docs.springcloud.cn/</a></li><li>SpringCloud中文网：<a href="https://springcloud.cc/">https://springcloud.cc</a></li></ul><h2 id="4-Rest微服务构建"><a href="#4-Rest微服务构建" class="headerlink" title="4.Rest微服务构建"></a>4.Rest微服务构建</h2><blockquote><p>介绍</p></blockquote><ul><li>使用一个Dept部门模块做一个微服务通用案例。 </li><li>Consumer消费者（Client）通过REST调用Provider提供者（Server）提供的服务。 </li><li>回忆Spring，SpringMVC，MyBatis等以往学习的知识。。。 </li><li>Maven的分包分模块架构复习</li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">一个简单的Maven模块结构是这样的：</span><br><span class="line">-- app-parent：一个父项目（app-parent）聚合很多子项目（app-util，app-dao，appweb...）</span><br><span class="line">|-- pom.xml</span><br><span class="line">|</span><br><span class="line">|-- app-core</span><br><span class="line">||----pom.xml</span><br><span class="line">|</span><br><span class="line">|-- app-web</span><br><span class="line">||----pom.xml</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>一个父工程带着多个子Module子模块。</p><p>SpringCloud父工程（Project）下初次带着3个子模块（Module）</p><ul><li>springcloud-api 【封装的整体entity &#x2F; 接口 &#x2F; 公共配置等】 </li><li>springcloud-provider-dept-8001【服务提供者】 </li><li>springcloud-consumer-dept-80【服务消费者】</li></ul><blockquote><p>SpringCloud版本选择</p></blockquote><ul><li><strong>实际开发版本关系</strong></li></ul><table><thead><tr><th>spring-boot-starter-parent</th><th></th><th>spring-cloud-dependencles</th><th></th></tr></thead><tbody><tr><td><strong>版本号</strong></td><td><strong>发布日期</strong></td><td><strong>版本号</strong></td><td><strong>发布日期</strong></td></tr><tr><td>1.5.2.RELEASE</td><td>2017-03</td><td>Dalston.RC1</td><td>2017-x</td></tr><tr><td>1.5.9.RELEASE</td><td>2017-11</td><td>Edgware.RELEASE</td><td>2017-11</td></tr><tr><td>1.5.16.RELEASE</td><td>2018-04</td><td>Edgware.SR5</td><td>2018-10</td></tr><tr><td>1.5.20.RELEASE</td><td>2018-09</td><td>Edgware.SR5</td><td>2018-10</td></tr><tr><td>2.0.2.RELEASE</td><td>2018-05</td><td>Fomchiey.BULD-SNAPSHOT</td><td>2018-x</td></tr><tr><td>2.0.6.RELEASE</td><td>2018-10</td><td>Fomchiey-SR2</td><td>2018-10</td></tr><tr><td>2.1.4.RELEASE</td><td>2019-04</td><td>Greenwich.SR1</td><td>2019-03</td></tr><tr><td>3.4.5</td><td>2025-01</td><td>2024.0.0</td><td>2024</td></tr></tbody></table><ul><li><strong>使用后两个</strong></li></ul><blockquote><p>创建父工程</p></blockquote><ul><li>新建父工程Maven项目 springcloud-parent，切记Packageing是pom模式。</li><li>主要是定义POM文件，将后续各个子模块公用的jar包等统一提取出来，类似一个抽象父类。</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/01/image-20220211120018667.png" alt="image-20220211120018667"></p><ul><li>pom.xml</li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.13.2<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">log4j.version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">log4j.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.18.22<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--打包方式  pom--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--springCloud的依赖--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- jdk17 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2024.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--SpringBoot--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--数据库--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--SpringBoot 启动器--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志测试~--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>创建api公共模块</p></blockquote><ul><li>新建springcloud-api模块</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/01/image-20220213093123243.png" alt="image-20220213093123243"></p><ul><li>可以观察发现，在父工程中多了一个Modules。</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/01/image-20220213093440880.png" alt="image-20220213093440880"></p><ul><li>编写springcloud-api 的 pom.xml</li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--当前Module的名字--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--当前Module需要到的jar包，按自己需求添加，如果父项目已经包含了，可以不用写版本号--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>创建部门数据库脚本，数据库名：springcloud</li></ul><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">CREATE TABLE dept ( deptno BIGINT <span class="keyword">NOT</span> NULL PRIMARY KEY AUTO_INCREMENT, dname VARCHAR ( <span class="number">60</span> ), db_source VARCHAR ( <span class="number">60</span> ) );</span><br><span class="line"></span><br><span class="line">INSERT INTO dept ( dname, db_source )</span><br><span class="line">VALUES</span><br><span class="line">(</span><br><span class="line">&#x27;开发部&#x27;,</span><br><span class="line">DATABASE ());</span><br><span class="line">INSERT INTO dept ( dname, db_source )</span><br><span class="line">VALUES</span><br><span class="line">(</span><br><span class="line">&#x27;人事部&#x27;,</span><br><span class="line">DATABASE ());</span><br><span class="line">INSERT INTO dept ( dname, db_source )</span><br><span class="line">VALUES</span><br><span class="line">(</span><br><span class="line">&#x27;财务部&#x27;,</span><br><span class="line">DATABASE ());</span><br><span class="line">INSERT INTO dept ( dname, db_source )</span><br><span class="line">VALUES</span><br><span class="line">(</span><br><span class="line">&#x27;市场部&#x27;,</span><br><span class="line">DATABASE ());</span><br><span class="line">INSERT INTO dept ( dname, db_source )</span><br><span class="line">VALUES</span><br><span class="line">(</span><br><span class="line">&#x27;运维部&#x27;,</span><br><span class="line">DATABASE ());</span><br><span class="line"></span><br><span class="line">SELECT</span><br><span class="line">* </span><br><span class="line">FROM</span><br><span class="line">dept;</span><br></pre></td></tr></table></figure><ul><li>编写实体类，注意：实体类都序列化！</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.github.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.experimental.Accessors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span> <span class="comment">// 链式写法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dept</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">// Dept(实体类) orm mysql-&gt;Dept(表) 类表关系映射</span></span><br><span class="line">    <span class="keyword">private</span> Long deptno; <span class="comment">// 主键</span></span><br><span class="line">    <span class="keyword">private</span> String dname; <span class="comment">// 部门名称</span></span><br><span class="line">    <span class="comment">// 来自哪个数据库，因为微服务架构可以一个服务对应一个数据库，同一个信息被存到多个不同的数据库</span></span><br><span class="line">    <span class="keyword">private</span> String db_source;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dept</span><span class="params">(String dname)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dname = dname;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    链式写法：</span></span><br><span class="line"><span class="comment">        Dept dept = new Dept()</span></span><br><span class="line"><span class="comment">        dept.setDeptno(11L).setDname(&quot;school&quot;).setDb_source(&quot;DB01&quot;);</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>创建provider模块</p></blockquote><ul><li>新建springcloud-provider-dept-8001模块 </li><li>编辑pom.xml</li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-provider-dept-8001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--引入自定义的模块，我们就可以使用这个模块中的类了--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jetty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- spring-boot-devtools热部署 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>编辑 application.yml</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"><span class="comment"># mybatis的配置</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">config-location:</span> <span class="string">classpath:mybatis/mybatis-config.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.github.pojo</span></span><br><span class="line">  <span class="attr">mapper-locations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath:mybatis/mapper/**/*.xml</span></span><br><span class="line"><span class="comment"># spring的相关配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-provider-dept</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> <span class="comment"># 数据源</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.gjt.mm.mysql.Driver</span> <span class="comment"># mysql驱动</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/springcloud</span> <span class="comment">#数据库名称</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">dbcp2:</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">5</span> <span class="comment">#数据库连接池的最小维持连接数</span></span><br><span class="line">      <span class="attr">initial-size:</span> <span class="number">5</span> <span class="comment">#初始化连接数</span></span><br><span class="line">      <span class="attr">max-total:</span> <span class="number">5</span> <span class="comment">#最大连接数</span></span><br><span class="line">      <span class="attr">max-wait-millis:</span> <span class="number">200</span> <span class="comment">#等待连接获取的最大超时时间</span></span><br></pre></td></tr></table></figure><ul><li>根据配置新建mybatis-config.xml文件</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/01/image-20220213102426606.png" alt="image-20220213102426606"></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--开启二级缓存--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;cacheEnabled&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>编写部门的dao接口</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeptDao</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addDept</span><span class="params">(Dept dept)</span>; <span class="comment">// 添加一个部门</span></span><br><span class="line">    <span class="keyword">public</span> Dept <span class="title function_">queryById</span><span class="params">(Long id)</span>; <span class="comment">// 根据id查询部门</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Dept&gt; <span class="title function_">queryAll</span><span class="params">()</span>; <span class="comment">// 查询所有部门</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>接口对应的Mapper.xml文件 mybatis\mapper\DeptMapper.xml</li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.github.dao.DeptDao&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;addDept&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;Dept&quot;</span>&gt;</span></span><br><span class="line">        insert into dept (dname,db_source) values (#&#123;dname&#125;,DATABASE());</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryById&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Dept&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;Long&quot;</span>&gt;</span></span><br><span class="line">        select deptno,dname,db_source from dept where deptno = #&#123;deptno&#125;;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryAll&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Dept&quot;</span>&gt;</span></span><br><span class="line">        select deptno,dname,db_source from dept;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>创建Service服务层接口</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeptService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addDept</span><span class="params">(Dept dept)</span>; <span class="comment">// 添加一个部门</span></span><br><span class="line">    <span class="keyword">public</span> Dept <span class="title function_">queryById</span><span class="params">(Long id)</span>; <span class="comment">// 根据id查询部门</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Dept&gt; <span class="title function_">queryAll</span><span class="params">()</span>; <span class="comment">// 查询所有部门</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ServiceImpl实现类</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DeptService</span> &#123;</span><br><span class="line">    <span class="comment">// 自动注入</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptDao deptDao;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addDept</span><span class="params">(Dept dept)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> deptDao.addDept(dept);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Dept <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> deptDao.queryById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Dept&gt; <span class="title function_">queryAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> deptDao.queryAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ServiceImpl实现类</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/dept&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptService service;</span><br><span class="line">    <span class="comment">// @RequestBody</span></span><br><span class="line">    <span class="comment">// 如果参数是放在请求体中，传入后台的话，那么后台要用@RequestBody才能接收到</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addDept</span><span class="params">(<span class="meta">@RequestBody</span> Dept dept)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> service.addDept(dept);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Dept <span class="title function_">get</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> service.queryById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Dept&gt; <span class="title function_">queryAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> service.queryAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>编写DeptProvider的主启动类</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptProvider8001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DeptProvider8001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>启动测试，注意编写细节：</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/01/image-20220213104354049.png" alt="image-20220213104354049"></p><p><img src="/hexo-docs/images/SpringCloudNetflixImage/01/image-20220213103228463.png" alt="image-20220213103228463"></p><blockquote><p>创建consumer模块</p></blockquote><ul><li>新建springcloud-consumer-dept-80模块 </li><li>编辑pom.xml</li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-consumer-dept-80<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>部门微服务消费者<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--热部署--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>application.yml配置文件</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><ul><li>新建一个ConfigBean包注入 RestTemplate！</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>创建Controller包，编写DeptConsumerController类</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptConsumerController</span> &#123;</span><br><span class="line">    <span class="comment">// 理解：消费者，不应该有service层</span></span><br><span class="line">    <span class="comment">// 使用RestTemplate访问restful接口非常的简单粗暴且无脑</span></span><br><span class="line">    <span class="comment">// （url，requestMap，ResponseBean.class） 这三个参数分别代表</span></span><br><span class="line">    <span class="comment">// REST请求地址，请求参数，Http响应转换被转换成的对象类型</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REST_URL_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8001&quot;</span>;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consumer/dept/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(Dept dept)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">                restTemplate.postForObject(REST_URL_PREFIX+<span class="string">&quot;/dept/add&quot;</span>,dept,Boolean.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consumer/dept/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Dept <span class="title function_">get</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">                restTemplate.getForObject(REST_URL_PREFIX+<span class="string">&quot;/dept/get/&quot;</span>+id,Dept.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consumer/dept/list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Dept&gt; <span class="title function_">list</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">                restTemplate.getForObject(REST_URL_PREFIX+<span class="string">&quot;/dept/list&quot;</span>,List.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>了解RestTemplate：</p><ul><li>RestTemplate提供了多种便捷访问远程Http服务的方法，是一种简单便捷的访问restful服务模板类，是Spring提供的用于访问Rest服务的客户端模板工具集。</li><li>使用RestTemplate访问restful接口非常的简单粗暴且无脑 （url，requsetMap，ResponseBean.class）这三个参数分别代表REST请求地址，请求参数，Http响应转换被转换成的对象类型。</li></ul></li><li><p>主启动类</p></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptConsumer80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DeptConsumer80.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>测试访问，<code>先启动服务方：DeptProvider8001，再启动消费方：DeptConsumer80</code>：</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/01/image-20220213112941611.png" alt="image-20220213112941611"></p><p><img src="/hexo-docs/images/SpringCloudNetflixImage/01/image-20220213115009217.png" alt="image-20220213115009217"></p><h2 id="5-Eureka服务注册与发现"><a href="#5-Eureka服务注册与发现" class="headerlink" title="5.Eureka服务注册与发现"></a>5.Eureka服务注册与发现</h2><blockquote><p>什么是<a href="https://baike.baidu.com/item/Eureka/22402835">Eureka</a>？</p></blockquote><ul><li>Eureka（服务发现框架）</li><li>Netflix 在设计Eureka时，遵循的就是API原则！</li><li>CAP原则又称CAP定理，指的是在一个分布式系统中，一致性（Consistency）、可用性（Availability）、分区容错性（Partition tolerance）。CAP 原则指的是，这三个要素最多只能同时实现两点，不可能三者兼顾。</li><li>Eureka是Netflix的一个子模块，也是核心模块之一。Eureka是一个基于REST的服务，用于定位服务，以实现云端中间层服务发现和故障转移，服务注册与发现对于微服务来说是非常重要的，有了服务发现 与注册，只需要使用服务的标识符，就可以访问到服务，而不需要修改服务调用的配置文件了，功能类 似于Dubbo的注册中心，比如Zookeeper。</li></ul><blockquote><p>Eureka的基本架构：</p></blockquote><ul><li>Springcloud 封装了Netflix公司开发的Eureka模块来实现服务注册与发现 (对比Zookeeper)。</li><li>SpringCloud将它集成在其子项目spring-cloud-netflix中，以实现SpringCloud的服务发现功能。</li><li>Eureka采用了C-S的架构设计，EurekaServer作为服务注册功能的服务器，他是服务注册中心。</li><li>而系统中的其他微服务，使用Eureka的客户端连接到EurekaServer并维持心跳连接。这样系统的维护人员就可以通过EurekaServer来监控系统中各个微服务是否正常运行，Springcloud 的一些其他模块 (比如Zuul) 就可以通过EurekaServer来发现系统中的其他微服务，并执行相关的逻辑。</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220213163150726.png" alt="image-20220213163150726"></p><ul><li>和Dubbo架构对比：</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/architecture.png" alt="///images/SpringCloudNetflixImages/architecture.png"></p><ul><li>Eureka包含两个组件：Eureka Server和Eureka Client。</li><li>Eureka Server提供服务注册服务，各个节点启动后，会在Eureka Server中进行注册，这样EurekaServer中的服务注册表中将会存储所有可用服务节点的信息，服务节点的信息可以在界面中直观的看到。</li><li>Eureka Client是一个<a href="https://baike.baidu.com/item/java/85979">java</a>客户端，用于简化与Eureka Server的交互，客户端同时也就是一个内置的、使用轮询(round-robin)负载算法的<a href="https://baike.baidu.com/item/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8/8852239">负载均衡器</a>。</li><li>在应用启动后，将会向Eureka Server发送心跳,默认周期为30秒，如果Eureka Server在多个心跳周期内没有接收到某个节点的心跳，Eureka Server将会从服务注册表中把这个服务节点移除(默认90秒)。</li></ul><blockquote><p>三大角色：</p></blockquote><ul><li>Eureka Server：提供服务的注册于发现。 </li><li>Service Provider：将自身服务注册到Eureka中，从而使消费方能够找到。 </li><li>Service Consumer：服务消费方从Eureka中获取注册服务列表，从而找到消费服务。</li></ul><blockquote><p>服务构建</p></blockquote><ul><li>建立springcloud-eureka-7001模块 </li><li>编辑pom.xml</li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-eureka-7001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- eureka-server服务端 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--热部署--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>application.yml</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Eureka配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span> <span class="comment">#eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment">#是否将自己注册到Eureka服务器中，本身是服务器，无需注册</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span> <span class="comment">#false表示自己端就是注册中心，职责是维护服务实例，并不需要检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span> </span><br><span class="line">      <span class="attr">defaultzone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">      <span class="comment"># 设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个defaultzone地址</span></span><br></pre></td></tr></table></figure><ul><li>编写主启动类</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.github;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span> <span class="comment">// EurekaServer服务端启动类，接受其他微服务注册进来</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaServer7001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaServer7001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>启动，访问测试：</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220213203915542.png" alt="image-20220213203915542"></p><ul><li>System Status：系统信息；</li><li>DS Replicas：服务器副本； </li><li>Instances currently registered with Eureka：已注册的微服务列表；</li><li>General Info：一般信息；</li><li>Instance Info：实例信息。</li></ul><blockquote><p>Service Provider</p></blockquote><ul><li>将 8001 的服务入驻到 7001 的eureka中！</li></ul><ol><li>修改8001服务的pom文件，增加eureka的支持！</li></ol><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--将服务的provider注册到eureka中--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-eureka --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>yaml 中配置 eureka 的支持</li></ol><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Eureka配置：配置服务注册中心地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/</span></span><br></pre></td></tr></table></figure><ol start="3"><li>8001 的主启动类注解支持</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span> <span class="comment">// 本服务启动之后会自动注册进Eureka中！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptProvider8001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DeptProvider8001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>截止目前：服务端也有了，客户端也有了，<code>启动7001，再启动8001，测试访问</code>：</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220213210328915.png" alt="image-20220213210328915"></p><blockquote><p>actuator与注册微服务信息完善</p></blockquote><ul><li>主机名称：服务名称修改</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220213210438955.png" alt="image-20220213210438955"></p><ul><li>在8001的yaml中修改一下配置。</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Eureka配置：配置服务注册中心地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">springcloud-provider-dept8001</span> <span class="comment"># 与client平级</span></span><br></pre></td></tr></table></figure><ul><li>重启，刷新后查看结果！</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220213210743283.png" alt="image-20220213210743283"></p><ul><li>访问信息有IP信息提示</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220213210821598.png" alt="image-20220213210821598"></p><ul><li>yaml中在增加一个配置:</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Eureka配置：配置服务注册中心地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">springcloud-provider-dept8001</span> <span class="comment"># 与client平级</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment"># true表示访问路径可以显示IP地址</span></span><br></pre></td></tr></table></figure><ul><li>现在点击info，出现ERROR页面:</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220213211159537.png" alt="image-20220213211159537"></p><ul><li>修改8001的pom文件，新增依赖！</li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--actuator监控信息完善--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>然后回到8001的yaml配置文件中修改增加信息：</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># info配置</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">app.name:</span> <span class="string">subei-springcloud</span>  <span class="comment"># 项目的名称</span></span><br><span class="line">  <span class="attr">company.name:</span> <span class="string">www.subeily.top</span>  <span class="comment"># 公司的名称</span></span><br></pre></td></tr></table></figure><ul><li>重启项目测试：7001、8001</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220214112924279.png" alt="image-20220214112924279"></p><ul><li>如果还没出来，可以添加如下配置：</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">health,info</span></span><br><span class="line">  <span class="attr">info:</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><blockquote><p>Eureka的自我保护机制：好死不如赖活着</p></blockquote><ul><li>之前出现的这些红色情况，没出现的，修改一个服务名，故意制造错误！</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220214115519422.png" alt="image-20220214115519422"></p><ul><li><p>一句话总结就是：某时刻某一个微服务不可用，eureka不会立即清理，依旧会对该微服务的信息进行保存！</p></li><li><p>默认情况下，当eureka server在一定时间内没有收到实例的心跳，便会把该实例从注册表中删除（&#x3D;&#x3D;默认是90秒&#x3D;&#x3D;），但是，如果短时间内丢失大量的实例心跳，便会触发eureka server的自我保护机制，比如在开发测试时，需要频繁地重启微服务实例，但是我们很少会把eureka server一起重启（因为在开发过程中不会修改eureka注册中心），&#x3D;&#x3D;当一分钟内收到的心跳数大量减少时，会触发该保护机制。可以在eureka管理界面看到Renews threshold和Renews(last min)，当后者（最后一分钟收到的心跳数）小于前者（心跳阈值）的时候，触发保护机制&#x3D;&#x3D;，会出现红色的警告：<code>EMERGENCY!EUREKA MAY BE INCORRECTLY CLAIMING INSTANCES ARE UP WHEN THEY&#39;RE NOT.RENEWALS ARE LESSER THAN THRESHOLD AND HENCE THE INSTANCES ARE NOT BEGING EXPIRED JUST TO BE SAFE.</code></p></li><li><p>从警告中可以看到，eureka认为虽然收不到实例的心跳，但它认为实例还是健康的，eureka会保护这些实例，不会把它们从注册表中删掉。</p></li><li><p>该保护机制的目的是避免网络连接故障，在发生网络故障时，微服务和注册中心之间无法正常通信，但服务本身是健康的，不应该注销该服务，如果eureka因网络故障而把微服务误删了，那即使网络恢复了，该微服务也不会重新注册到eureka server了，因为只有在微服务启动的时候才会发起注册请求，后面只会发送心跳和服务列表请求，这样的话，该实例虽然是运行着，但永远不会被其它服务所感知。所以，eureka server在短时间内丢失过多的客户端心跳时，会进入自我保护模式，该模式下，eureka会保护注册表中的信息，不在注销任何微服务，当网络故障恢复后，eureka会自动退出保护模式。自我保护模式可以让集群更加健壮。</p></li><li><p>但是我们在开发测试阶段，需要频繁地重启发布，如果触发了保护机制，则旧的服务实例没有被删除，这时请求有可能跑到旧的实例中，而该实例已经关闭了，这就导致请求错误，影响开发测试。</p></li><li><p>所以，在开发测试阶段，可以把自我保护模式关闭，只需在eureka server配置文件中加上如下配置即可：<code>eureka.server.enable-self-preservation=false</code>【不推荐关闭自我保护机制】</p></li><li><p>详细可以参考：<a href="https://blog.csdn.net/wudiyong22/article/details/80827594">博客</a></p></li></ul><blockquote><p>8001服务发现Discovery</p></blockquote><ul><li>对于注册进eureka里面的微服务，可以通过服务发现来获得该服务的信息。【对外暴露服务】 </li><li>修改springcloud-provider-dept-8001工程中的DeptController，并新增一个方法。</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220214125858655.png" alt="image-20220214125858655"></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * DiscoveryClient 可以用来获取一些配置的信息，得到具体的微服务！</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient client;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 获取一些注册进来的微服务的信息~</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/discovery&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">discovery</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取微服务列表的清单</span></span><br><span class="line">    List&lt;String&gt; services = client.getServices();</span><br><span class="line">    System.out.println(<span class="string">&quot;discovery=&gt;services:&quot;</span> + services);</span><br><span class="line">    <span class="comment">// 得到一个具体的微服务信息,通过具体的微服务id，applicaioinName；</span></span><br><span class="line">    List&lt;ServiceInstance&gt; instances = client.getInstances(<span class="string">&quot;SPRINGCLOUD-PROVIDER-DEPT&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (ServiceInstance instance : instances) &#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">            instance.getHost() + <span class="string">&quot;\t&quot;</span> + <span class="comment">// 主机名称</span></span><br><span class="line">            instance.getPort() + <span class="string">&quot;\t&quot;</span> + <span class="comment">// 端口号</span></span><br><span class="line">            instance.getUri() + <span class="string">&quot;\t&quot;</span> + <span class="comment">// uri</span></span><br><span class="line">            instance.getServiceId() <span class="comment">// 服务id</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.client;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>主启动类增加一个注解：</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220214130051064.png" alt="image-20220214130051064"></p><ul><li>启动Eureka服务，启动8001提供者，访问测试 <a href="http://localhost:8001/dept/discovery">http://localhost:8001/dept/discovery</a></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220214131406463.png" alt="image-20220214131406463"></p><ul><li>后台输出：</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220214131422446.png" alt="image-20220214131422446"></p><blockquote><p>consumer访问服务：</p></blockquote><ul><li>进入springcloud-consumer-dept-80，修改DeptConsumerController增加一个方法</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/consumer/dept/discovery&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">discovery</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(REST_URL_PREFIX+<span class="string">&quot;/dept/discovery&quot;</span>,Object.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>启动 80 项目进行测试！<code>先启动8001服务，再启动80</code></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220214132540222.png" alt="image-20220214132540222"></p><blockquote><p>Eureka：集群环境配置</p></blockquote><ul><li>集群配置分析：</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220214134108853.png" alt="image-20220214134108853"></p><ul><li>新建工程springcloud-eureka-7002、springcloud-eureka-7003；</li><li>为pom.xml添加依赖 (与springcloud-eureka-7001相同)</li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- eureka-server服务端 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--热部署--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>application.yml配置(与springcloud-eureka-7001相同)</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7003</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Eureka配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span> <span class="comment">#eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment">#是否将自己注册到Eureka服务器中，本身是服务器，无需注册</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span> <span class="comment">#false表示自己端就是注册中心，职责是维护服务实例，并不需要检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultzone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">      <span class="comment"># 设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个defaultzone地址</span></span><br></pre></td></tr></table></figure><ul><li>主启动类(与springcloud-eureka-7001相同)</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span> <span class="comment">// EurekaServer服务端启动类，接受其他微服务注册进来</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaServer7003</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaServer7003.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>集群成员相互关联，修改映射配置 , windows域名映射。</li><li>配置一些自定义本机名字，找到本机hosts文件并打开：</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220214135915497.png" alt="image-20220214135915497"></p><ul><li>在hosts文件最后加上，要访问的本机名称，默认是localhost</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220214140136658.png" alt="image-20220214140136658"></p><ul><li>修改application.yml的配置，如图为springcloud-eureka-7001配置，springcloud-eureka-7002&#x2F;springcloud-eureka-7003同样分别修改为其对应的名称即可。</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220214140235957.png" alt="image-20220214140235957"></p><ul><li><p>在集群中使springcloud-eureka-7001关联springcloud-eureka-7002、springcloud-eureka-7003</p></li><li><p>完整的springcloud-eureka-7001下的application.yml如下</p></li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Eureka配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001.com</span> <span class="comment">#eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment">#是否将自己注册到Eureka服务器中，本身是服务器，无需注册</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span> <span class="comment">#false表示自己端就是注册中心，职责是维护服务实例，并不需要检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># 单机 defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">      <span class="comment"># 设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个defaultZone地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span></span><br></pre></td></tr></table></figure><ul><li>7002</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7002</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Eureka配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7002.com</span> <span class="comment">#eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment">#是否将自己注册到Eureka服务器中，本身是服务器，无需注册</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span> <span class="comment">#false表示自己端就是注册中心，职责是维护服务实例，并不需要检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># 单机 defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">      <span class="comment"># 设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个defaultZone地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7003.com:7003/eureka/</span></span><br></pre></td></tr></table></figure><ul><li>7003</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7003</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Eureka配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7003.com</span> <span class="comment">#eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment">#是否将自己注册到Eureka服务器中，本身是服务器，无需注册</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span> <span class="comment">#false表示自己端就是注册中心，职责是维护服务实例，并不需要检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># 单机 defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">      <span class="comment"># 设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个defaultZone地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/</span></span><br></pre></td></tr></table></figure><ul><li>将8001微服务发布到1台eureka集群配置中，发现在集群中的其余注册中心也可以看到，但是平时我们保险起见，都发布！<code>即通过springcloud-provider-dept-8001下的yml配置文件，修改Eureka配置：配置服务注册中心地址</code>：</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Eureka配置：配置服务注册中心地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># 注册中心地址7001-7003</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">springcloud-provider-dept-8001</span> <span class="comment"># 与client平级</span></span><br><span class="line"> <span class="comment">#   prefer-ip-address: true # true表示访问路径可以显示IP地址</span></span><br></pre></td></tr></table></figure><ul><li>启动集群测试！<code>7001、7002、7003、8001都要启动哦</code>！</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/02/image-20220214141214593.png" alt="image-20220214141214593"></p><blockquote><p>对比Zookeeper</p></blockquote><ol><li>回顾CAP原则</li></ol><ul><li><p>RDBMS (MySQL、Oracle、sqlServer) &#x3D;&#x3D;&#x3D;&gt; ACID</p></li><li><p>NoSQL (Redis、MongoDB) &#x3D;&#x3D;&#x3D;&gt; CAP</p></li></ul><ol start="2"><li>ACID是什么？</li></ol><ul><li>A (Atomicity) 原子性</li><li>C (Consistency) 一致性</li><li>I (Isolation) 隔离性</li><li>D (Durability) 持久性</li></ul><ol start="3"><li>CAP是什么?</li></ol><ul><li>C (Consistency) 强一致性</li><li>A (Availability) 可用性</li><li>P (Partition tolerance) 分区容错性</li></ul><ol start="4"><li>CAP的三进二：CA、AP、CP</li><li>CAP理论的核心</li></ol><ul><li>一个分布式系统不可能同时很好的满足一致性，可用性和分区容错性这三个需求；</li><li>根据CAP原理，将NoSQL数据库分成了满足CA原则，满足CP原则和满足AP原则三大类；<ul><li>CA：单点集群，满足一致性，可用性的系统，通常可扩展性较差；</li><li>CP：满足一致性，分区容错的系统，通常性能不是特别高；</li><li>AP：满足可用性，分区容错的系统，通常可能对一致性要求低一些；</li></ul></li></ul><blockquote><p>作为服务注册中心，Eureka比Zookeeper好在哪里？</p></blockquote><ul><li><p>著名的CAP理论指出，一个分布式系统不可能同时满足C (一致性) 、A (可用性) 、P (容错性)，由于分区容错性P再分布式系统中是必须要保证的，因此我们只能再A和C之间进行权衡。</p><ul><li>Zookeeper 保证的是 CP —&gt; 满足一致性，分区容错的系统，通常性能不是特别高；</li><li>Eureka 保证的是 AP —&gt; 满足可用性，分区容错的系统，通常可能对一致性要求低一些；</li></ul></li><li><p><code>Zookeeper保证的是CP</code></p><ul><li>当向注册中心查询服务列表时，我们可以容忍注册中心返回的是几分钟以前的注册信息，但不能接收服务直接down掉不可用。也就是说，服务注册功能对可用性的要求要高于一致性。但zookeeper会出现这样一种情况，当master节点因为网络故障与其他节点失去联系时，剩余节点会重新进行leader选举。问题在于，选举leader的时间太长，30-120s，且选举期间整个zookeeper集群是不可用的，这就导致在选举期间注册服务瘫痪。在云部署的环境下，因为网络问题使得zookeeper集群失去master节点是较大概率发生的事件，虽然服务最终能够恢复，但是，漫长的选举时间导致注册长期不可用，是不可容忍的。</li></ul></li><li><p><code>Eureka保证的是AP</code></p><ul><li>Eureka看明白了这一点，因此在设计时就优先保证可用性。Eureka各个节点都是平等的，几个节点挂掉不会影响正常节点的工作，剩余的节点依然可以提供注册和查询服务。而Eureka的客户端在向某个Eureka注册时，如果发现连接失败，则会自动切换至其他节点，只要有一台Eureka还在，就能保住注册服务的可用性，只不过查到的信息可能不是最新的，除此之外，Eureka还有之中自我保护机制，如果在15分钟内超过85%的节点都没有正常的心跳，那么Eureka就认为客户端与注册中心出现了网络故障，此时会出现以下几种情况：<ol><li>Eureka不在从注册列表中移除因为长时间没收到心跳而应该过期的服务；</li><li>Eureka仍然能够接受新服务的注册和查询请求，但是不会被同步到其他节点上 (即保证当前节点依然可用)；</li><li>当网络稳定时，当前实例新的注册信息会被同步到其他节点中。</li></ol></li></ul></li><li><p>因此，&#x3D;&#x3D;Eureka可以很好的应对因网络故障导致部分节点失去联系的情况，而不会像zookeeper那样使整个注册服务瘫痪&#x3D;&#x3D;。</p></li></ul><h2 id="6-Ribbon：负载均衡-基于客户端"><a href="#6-Ribbon：负载均衡-基于客户端" class="headerlink" title="6.Ribbon：负载均衡(基于客户端)"></a>6.Ribbon：负载均衡(基于客户端)</h2><blockquote><p>Ribbon是什么？</p></blockquote><ul><li><p>Spring Cloud Ribbon是基于Netflix Ribbon实现的一套客户端负载均衡的工具。 </p></li><li><p>简单的说，Ribbon是Netflix发布的开源项目，主要功能是提供客户端的软件负载均衡算法，将NetFlix的中间层服务连接在一起。Ribbon的客户端组件提供一系列完整的配置项如：连接超时、重试等等。简单的说，就是在配置文件中列出LoadBalancer（简称LB：负载均衡）后面所有的机器，Ribbon会自动的帮助你基于某种规则（如简单轮询，随机连接等等）去连接这些机器。我们也很容易使用Ribbon实现自定义的负载均衡算法！</p></li></ul><blockquote><p>Ribbon能干嘛？</p></blockquote><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220214150845147.png" alt="image-20220214150845147"></p><ul><li>LB，即负载均衡 (LoadBalancer) ，在微服务或分布式集群中经常用的一种应用。</li><li>负载均衡简单的说就是将用户的请求平摊的分配到多个服务上，从而达到系统的HA (高用)。</li><li>常见的负载均衡软件有 Nginx、Lvs等等。</li><li>Dubbo、SpringCloud 中均给我们提供了负载均衡，SpringCloud 的负载均衡算法可以自定义。</li><li>负载均衡简单分类：<ul><li>集中式LB<ul><li>即在服务的提供方和消费方之间使用独立的LB设施，如Nginx(反向代理服务器)，由该设施负责把访问请求通过某种策略转发至服务的提供方！</li></ul></li><li>进程式 LB<ul><li>将LB逻辑集成到消费方，消费方从服务注册中心获知有哪些地址可用，然后自己再从这些地址中选出一个合适的服务器。</li><li><code>Ribbon 就属于进程内LB</code>，它只是一个类库，集成于消费方进程，消费方通过它来获取到服务提供方的地址！</li></ul></li></ul></li><li>Ribbon的github地址：<a href="https://github.com/NetFlix/ribbon">https://github.com/NetFlix/ribbon</a></li></ul><blockquote><p>集成Ribbon</p></blockquote><ul><li><p>springcloud-consumer-dept-80向pom.xml中添加Ribbon和Eureka依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-ribbon --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-ribbon<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-eureka --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在application.yml文件中配置Eureka</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Eureka配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment"># false表示不向注册中心注册自己</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span></span><br></pre></td></tr></table></figure></li><li><p>主启动类加上@EnableEurekaClient注解，开启Eureka</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Ribbon 和 Eureka 整合以后，客户端可以直接调用，不用关心IP地址和端口号</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span> <span class="comment">// 开启Eureka 客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptConsumer80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DeptConsumer80.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>自定义Spring配置类：ConfigBean.java 配置负载均衡实现RestTemplate</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span> <span class="comment">// Spring Cloud Ribbon是基于Netflix Ribbon实现的一套客户端负载均衡的工具</span></span><br><span class="line"><span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>修改conroller：DeptConsumerController.java</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务提供方地址前缀</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Ribbon:我们这里的地址，应该是一个变量，通过服务名来访问</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    private static final String REST_URL_PREFIX = &quot;http://localhost:8001&quot;;</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REST_URL_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;http://SPRINGCLOUD-PROVIDER-DEPT&quot;</span>;</span><br></pre></td></tr></table></figure></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220219173650912.png" alt="image-20220219173650912"></p><ul><li>先启动3个Eureka集群后，再启动springcloud-provider-dept-8001并注册进eureka；</li><li>启动 DeptConsumerRibbon80；</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220219174149545.png" alt="image-20220219174149545"></p><ul><li>测试 <ul><li><a href="http://localhost/consumer/dept/get/1">http://localhost/consumer/dept/get/1</a> </li><li><a href="http://localhost/consumer/dept/list">http://localhost/consumer/dept/list</a></li></ul></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220219173905938.png" alt="image-20220219173905938"></p><ul><li>&#x3D;&#x3D;Ribbon和Eureka整合后Consumer可以直接调用服务而不用再关心地址和端口号&#x3D;&#x3D;！</li></ul><hr><blockquote><p>Ribbon负载均衡</p></blockquote><ul><li>架构说明：</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220219175148658.png" alt="image-20220219175148658"></p><ul><li><p>Ribbon在工作时分成两步：</p><ul><li>第一步先选择EurekaServer，它优先选择在同一个区域内负载均衡较少的Server。 </li><li>第二步在根据用户指定的策略，在从server去到的服务注册列表中选择一个地址。 </li><li>其中Ribbon提供了多种策略，比如轮询（默认），随机和根据响应时间加权重,,,等等</li></ul></li><li><p>测试： </p><ul><li>参考springcloud-provider-dept-8001，新建两份，分别为8002,8003！ </li><li>参照springcloud-provider-dept-8001，依次为另外两个Moudle添加pom.xml依赖 、resourece下的mybatis和application.yml配置，Java代码；</li><li>全部复制完毕，修改启动类名称，修改端口号名称！</li></ul></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220219175309813.png" alt="image-20220219175309813"></p><ul><li>新建8002&#x2F;8003数据库，各自微服务分别连接各自的数据库，复制springcloud！ <ul><li>新建springcloud02 </li><li>新建springcloud03</li></ul></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220219203740822.png" alt="image-20220219203740822"></p><ul><li>修改8002&#x2F;8003各自的YML文件 <ul><li>端口 </li><li>数据库连接 </li><li>实例名也需要修改</li></ul></li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">instance:</span></span><br><span class="line">  <span class="attr">instance-id:</span> <span class="string">springcloud-provider-dept-8003</span> <span class="comment"># 与client平级</span></span><br></pre></td></tr></table></figure><ul><li>对外暴露的统一的服务实例名【三个服务名字必须一致！】</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">application:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">springcloud-provider-dept</span></span><br></pre></td></tr></table></figure><ul><li><p>启动3个Eureka集群配置区 </p></li><li><p>启动3个Dept微服务并都测试通过 </p><ul><li><a href="http://localhost:8001/dept/list">http://localhost:8001/dept/list</a> </li><li><a href="http://localhost:8002/dept/list">http://localhost:8002/dept/list</a> </li><li><a href="http://localhost:8003/dept/list">http://localhost:8003/dept/list</a></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220220193255505.png" alt="image-20220220193255505"></p></li><li><p>启动springcloud-consumer-dept-80 </p></li><li><p>客户端通过Ribbon完成负载均衡并访问上一步的Dept微服务 </p><ul><li><a href="http://localhost/consumer/dept/list">http://localhost/consumer/dept/list</a> </li><li>多刷新几次注意观察结果！</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220220193217642.png" alt="image-20220220193217642"></p></li><li><p>总结：</p><ul><li>Ribbon其实就是一个软负载均衡的客户端组件，他可以和其他所需请求的客户端结合使用，和Eureka结合只是其中的一个实例。</li></ul></li></ul><blockquote><p>Ribbon核心组件IRule</p></blockquote><ul><li>IRule：根据特定算法从服务列表中选取一个要访问的服务！</li><li>RoundRobinRule【轮询】 </li><li>RandomRule【随机】 </li><li>AvailabilityFilterRule【会先过滤掉由于多次访问故障而处于断路器跳闸的服务，还有并发的连接 数量超过阈值的服务，然后对剩余的服务列表按照轮询策略进行访问】 </li><li>WeightedResponseTimeRule【根据平均响应时间计算所有服务的权重，响应时间越快服务权重越大，被选中的概率越高，刚启动时如果统计信息不足，则使用RoundRobinRule策略，等待统计信息足够，会切换到WeightedResponseTimeRule】 </li><li>RetryRule【先按照RoundRobinRule的策略获取服务，如果获取服务失败，则在指定时间内会进行重试，获取可用的服务】 </li><li>BestAvailableRule【会先过滤掉由于多次访问故障而处于断路器跳闸状态的服务，然后选择一个并发量最小的服务】 </li><li>ZoneAvoidanceRule【默认规则，复合判断server所在区域的性能和server的可用性选择服务器】</li><li>查看分析源码： <ol><li>IRule </li><li>ILoadBalancer</li><li>AbstractLoadBalancer</li><li>AbstractLoadBalancerRule：这个抽象父类十分重要！核心</li><li>RoundRobinRule</li></ol></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220222220612536.png" alt="image-20220222220612536"></p><p>分析一下方法：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Server <span class="title function_">choose</span><span class="params">(ILoadBalancer lb, Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (lb == <span class="literal">null</span>) &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;no load balancer&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">Server</span> <span class="variable">server</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (server == <span class="literal">null</span> &amp;&amp; count++ &lt; <span class="number">10</span>) &#123;</span><br><span class="line">                List&lt;Server&gt; reachableServers = lb.getReachableServers();</span><br><span class="line">                List&lt;Server&gt; allServers = lb.getAllServers();</span><br><span class="line">                <span class="type">int</span> <span class="variable">upCount</span> <span class="operator">=</span> reachableServers.size();</span><br><span class="line">                <span class="type">int</span> <span class="variable">serverCount</span> <span class="operator">=</span> allServers.size();</span><br><span class="line">                <span class="keyword">if</span> (upCount != <span class="number">0</span> &amp;&amp; serverCount != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">nextServerIndex</span> <span class="operator">=</span> <span class="built_in">this</span>.incrementAndGetModulo(serverCount);</span><br><span class="line">                    server = (Server)allServers.get(nextServerIndex);</span><br><span class="line">                    <span class="keyword">if</span> (server == <span class="literal">null</span>) &#123;</span><br><span class="line">                        Thread.<span class="keyword">yield</span>();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (server.isAlive() &amp;&amp; server.isReadyToServe()) &#123;</span><br><span class="line">                            <span class="keyword">return</span> server;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        server = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                log.warn(<span class="string">&quot;No up servers available from load balancer: &quot;</span> + lb);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (count &gt;= <span class="number">10</span>) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;No available alive servers after 10 tries from load balancer: &quot;</span> + lb);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> server;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>切换为随机策略实现试试，在ConfigBean中添加方法。</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * IRule:</span></span><br><span class="line"><span class="comment">     * RoundRobinRule 轮询策略</span></span><br><span class="line"><span class="comment">     * RandomRule 随机策略</span></span><br><span class="line"><span class="comment">     * AvailabilityFilteringRule ： 会先过滤掉，跳闸，访问故障的服务~，对剩下的进行轮询~</span></span><br><span class="line"><span class="comment">     * RetryRule ： 会先按照轮询获取服务~，如果服务获取失败，则会在指定的时间内进行，重试</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> IRule <span class="title function_">myRule</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();<span class="comment">//使用随机策略</span></span><br><span class="line">    <span class="comment">// return new RoundRobinRule();//使用轮询策略</span></span><br><span class="line">    <span class="comment">// return new AvailabilityFilteringRule();//使用轮询策略</span></span><br><span class="line">    <span class="comment">// return new RetryRule();//使用轮询策略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>重启80服务进行访问测试，查看运行结果！【注意，可能服务长时间不使用会崩】 </li><li>访问测试：<a href="http://localhost/consumer/dept/list">http://localhost/consumer/dept/list</a></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220222221100037.png" alt="image-20220222221100037"></p><ul><li>测试：new RetryRule() 算法 </li><li>RetryRule【先按照RoundRobinRule的策略获取服务，如果获取服务失败，则在指定时间内会进行重试，获取可用的服务】<ol><li>在运行期间关闭掉一个服务提供者8002 </li><li>消费者再次测试！发现404后继续访问测试！看结果！！！</li></ol></li><li>其余的不再挨个测试了，大家有时间可以去测试玩玩； </li><li>现在有一个新的需求，我们不需要这些默认的算法，我们需要自己重新定义，这该怎么办呢？</li></ul><blockquote><p>自定义Ribbon：</p></blockquote><ul><li>修改springcloud-consumer-dept-ribbon-80 </li><li>主启动类添加@RibbonClient注解；</li><li>在启动该微服务的时候就能去加载我们自定义的Ribbon配置类，从而使配置类生效，例如:</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RibbonClient(name=&quot;SPRINGCLOUD-PROVIDER-DEPT&quot;,configuration=MySelfRule.class)</span></span><br></pre></td></tr></table></figure><p><strong>注意配置细节</strong>:</p><ul><li><a href="https://docs.spring.io/spring-cloud-netflix/docs/2.2.11.BUILD-SNAPSHOT/reference/html/#customizing-the-ribbon-client">官方文档</a>明确给出了警告： </li><li>这个自定义配置类不能放在@ComponentScan所扫描的当前包以及子包下，否则我们自定义的这个配置类就会被所有的Ribbon客户端所共享，也就是说达不到特殊化定制的目的了！</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220222231901088.png" alt="image-20220222231901088"></p><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220222231927958.png" alt="image-20220222231927958"></p><p><strong>步骤</strong>：</p><ol><li>由于有以上配置细节原因，我们建立一个包：com.github.myrul，在这里新建一个自定义规则的Rubbion类。</li></ol><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220222232030128.png" alt="image-20220222232030128"></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySelfRule</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * IRule:</span></span><br><span class="line"><span class="comment">     * RoundRobinRule 轮询策略</span></span><br><span class="line"><span class="comment">     * RandomRule 随机策略</span></span><br><span class="line"><span class="comment">     * AvailabilityFilteringRule ： 会先过滤掉，跳闸，访问故障的服务~，对剩下的进行轮询~</span></span><br><span class="line"><span class="comment">     * RetryRule ： 会先按照轮询获取服务~，如果服务获取失败，则会在指定的时间内进行，重试</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> IRule <span class="title function_">myRule</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();<span class="comment">//使用随机策略</span></span><br><span class="line">        <span class="comment">// return new RoundRobinRule();//使用轮询策略</span></span><br><span class="line">        <span class="comment">// return new AvailabilityFilteringRule();//使用轮询策略</span></span><br><span class="line">        <span class="comment">// return new RetryRule();//使用轮询策略</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>在主启动类上配置自定义的Ribbon。</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span> <span class="comment">// 开启Eureka 客户端</span></span><br><span class="line"><span class="meta">@RibbonClient(name=&quot;SPRINGCLOUD-PROVIDER-DEPT&quot;,configuration= MySelfRule.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptConsumer80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DeptConsumer80.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>启动所有项目，访问测试，查看编写的随机算法，现在是否生效！</li></ol><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220223145416584.png" alt="image-20220223145416584"></p><blockquote><p>自定义规则深度解析 </p></blockquote><ol><li>问题：依旧轮询策略，但是加上新需求，每个服务器要求被调用5次，就是以前每一个机器一次，现在每个机器5次； </li><li>解析源码：RandomRule.java ， IDEA直接点击进去，复制出来，变成我们自己的类 MyRondomRule</li></ol><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220222232628236.png" alt="image-20220222232628236"></p><ul><li>分析阅读源码：</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RandomRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractLoadBalancerRule</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RandomRule</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;RCN_REDUNDANT_NULLCHECK_OF_NULL_VALUE&quot;&#125;)</span></span><br><span class="line">    <span class="comment">// ILoadBalancer选择的随机算法</span></span><br><span class="line">    <span class="keyword">public</span> Server <span class="title function_">choose</span><span class="params">(ILoadBalancer lb, Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lb == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Server</span> <span class="variable">server</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(server == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 查看线程是否中断了</span></span><br><span class="line">                <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Reachable： 可及；可到达；够得到</span></span><br><span class="line">                List&lt;Server&gt; upList = lb.getReachableServers(); <span class="comment">// 活着的服务</span></span><br><span class="line">                List&lt;Server&gt; allList = lb.getAllServers(); <span class="comment">// 获取所有的服务</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">serverCount</span> <span class="operator">=</span> allList.size();</span><br><span class="line">                <span class="keyword">if</span> (serverCount == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 生成区间随机数！</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="built_in">this</span>.chooseRandomInt(serverCount);</span><br><span class="line">                <span class="comment">// 从活着的服务中，随机取出一个</span></span><br><span class="line">                server = (Server)upList.get(index);</span><br><span class="line">                <span class="keyword">if</span> (server == <span class="literal">null</span>) &#123;</span><br><span class="line">                    Thread.<span class="keyword">yield</span>();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (server.isAlive()) &#123;</span><br><span class="line">                        <span class="keyword">return</span> server;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    server = <span class="literal">null</span>;</span><br><span class="line">                    Thread.<span class="keyword">yield</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> server;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 随机</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">chooseRandomInt</span><span class="params">(<span class="type">int</span> serverCount)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ThreadLocalRandom.current().nextInt(serverCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Server <span class="title function_">choose</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.choose(<span class="built_in">this</span>.getLoadBalancer(), key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initWithNiwsConfig</span><span class="params">(IClientConfig clientConfig)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>参考源码修改为我们需求要求的MyRondomRule.java</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.github.myrule;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.client.config.IClientConfig;</span><br><span class="line"><span class="keyword">import</span> com.netflix.loadbalancer.AbstractLoadBalancerRule;</span><br><span class="line"><span class="keyword">import</span> com.netflix.loadbalancer.ILoadBalancer;</span><br><span class="line"><span class="keyword">import</span> com.netflix.loadbalancer.Server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadLocalRandom;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRondomRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractLoadBalancerRule</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyRondomRule</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// total = 0 当total数等于5以后，我们指针才能往下走</span></span><br><span class="line">    <span class="comment">// index = 0 当前对外提供服务的服务器地址</span></span><br><span class="line">    <span class="comment">// 如果total等于5，则index+1，将total重置为0即可！</span></span><br><span class="line">    <span class="comment">// 问题：我们只有3台机器，所有total&gt;3 则将total置为0；</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">//总共被调用的次数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">currentIndex</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">//当前提供服务的机器序号！</span></span><br><span class="line">    <span class="comment">// ILoadBalancer选择的随机算法</span></span><br><span class="line">    <span class="keyword">public</span> Server <span class="title function_">choose</span><span class="params">(ILoadBalancer lb, Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lb == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Server</span> <span class="variable">server</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(server == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 查看线程是否中断了</span></span><br><span class="line">                <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Reachable： 可及；可到达；够得到</span></span><br><span class="line">                List&lt;Server&gt; upList = lb.getReachableServers(); <span class="comment">// 活着的服务</span></span><br><span class="line">                List&lt;Server&gt; allList = lb.getAllServers(); <span class="comment">// 获取所有的服务</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">serverCount</span> <span class="operator">=</span> allList.size();</span><br><span class="line">                <span class="keyword">if</span> (serverCount == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 生成区间随机数！</span></span><br><span class="line"><span class="comment">//                int index = this.chooseRandomInt(serverCount);</span></span><br><span class="line">                <span class="comment">// 从活着的服务中，随机取出一个</span></span><br><span class="line"><span class="comment">//                server = (Server)upList.get(index);</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// =====================================</span></span><br><span class="line">                <span class="keyword">if</span> (total&lt;<span class="number">5</span>)&#123;</span><br><span class="line">                    server = upList.get(currentIndex);</span><br><span class="line">                    total++;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    total = <span class="number">0</span>;</span><br><span class="line">                    currentIndex++;</span><br><span class="line">                    <span class="keyword">if</span> (currentIndex&gt;=upList.size())&#123;</span><br><span class="line">                        currentIndex = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    server = upList.get(currentIndex);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// =====================================</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (server == <span class="literal">null</span>) &#123;</span><br><span class="line">                    Thread.<span class="keyword">yield</span>();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (server.isAlive()) &#123;</span><br><span class="line">                        <span class="keyword">return</span> server;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    server = <span class="literal">null</span>;</span><br><span class="line">                    Thread.<span class="keyword">yield</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> server;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 随机</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">chooseRandomInt</span><span class="params">(<span class="type">int</span> serverCount)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ThreadLocalRandom.current().nextInt(serverCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Server <span class="title function_">choose</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.choose(<span class="built_in">this</span>.getLoadBalancer(), key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initWithNiwsConfig</span><span class="params">(IClientConfig clientConfig)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>调用，在我们自定义的IRule方法中返回刚才我们写好的随机算法类。</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySelfRule</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> IRule <span class="title function_">myRule</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// Ribbon默认是轮询，可以自定义为随机算法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyRondomRule</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>测试实现，<code>会连续五次之后才会切换轮询</code>：</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220223145454446.png" alt="image-20220223145454446"></p><h2 id="7-Feign：负载均衡-基于服务端"><a href="#7-Feign：负载均衡-基于服务端" class="headerlink" title="7.Feign：负载均衡(基于服务端)"></a>7.Feign：负载均衡(基于服务端)</h2><blockquote><p>简介</p></blockquote><ul><li><p>Feign是声明式Web Service客户端，它让微服务之间的调用变得更简单，类似controller调用service。SpringCloud集成了Ribbon和Eureka，可以使用Feigin提供负载均衡的http客户端。</p></li><li><p><strong>只需要创建一个接口，然后添加注解即可</strong>！</p></li></ul><p>Feign，主要是社区版，大家都习惯面向接口编程。这个是很多开发人员的规范。调用微服务访问两种方法：</p><ol><li>微服务名字 【ribbon】</li><li>接口和注解 【feign】</li></ol><p><strong>Feign能干什么？</strong></p><ul><li>Feign旨在使编写Java Http客户端变得更容易</li><li>前面在使用<strong>Ribbon</strong> + <strong>RestTemplate</strong>时，利用<strong>RestTemplate</strong>对Http请求的封装处理，形成了一套模板化的调用方法。但是在实际开发中，由于对服务依赖的调用可能不止一处，往往一个接口会被多处调用，所以通常都会针对每个微服务自行封装一个客户端类来包装这些依赖服务的调用。所以，<strong>Feign</strong>在此基础上做了进一步的封装，由他来帮助我们定义和实现依赖服务接口的定义，在Feign的实现下，我们只需要创建一个接口并使用注解的方式来配置它 (类似以前Dao接口上标注Mapper注解，现在是一个微服务接口上面标注一个Feign注解)，即可完成对服务提供方的接口绑定，简化了使用Spring Cloud Ribbon 时，自动封装服务调用客户端的开发量。</li></ul><p><strong>Feign默认集成了Ribbon</strong></p><ul><li>利用<strong>Ribbon</strong>维护了MicroServiceCloud-Dept的服务列表信息，并且通过轮询实现了客户端的负载均衡，而与<strong>Ribbon</strong>不同的是，通过<strong>Feign</strong>只需要定义服务绑定接口且以声明式的方法，优雅而简单的实现了服务调用。</li></ul><blockquote><p>Feign的使用步骤：</p></blockquote><ol><li>参考springcloud-consumer-dept-ribbon-80 </li><li>新建springcloud-consumer-dept-feign-80 <ol><li>修改主启动类名称；</li><li>将springcloud-consumer-dept-80的内容都拷贝到feign项目中；</li><li>删除myrule文件夹；</li><li>修改主启动类的名称为 FeignDeptConsumer80；</li></ol></li></ol><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220223150519033.png" alt="image-20220223150519033"></p><ol start="3"><li>springcloud-consumer-dept-feign-80修改pom.xml，添加对Feign的支持。</li></ol><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--Feign的依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-feign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="4"><li>修改springcloud-api工程 <ol><li>pom.xml添加feign的支持 </li><li>新建一个Service包</li></ol></li></ol><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220223150729085.png" alt="image-20220223150729085"></p><ul><li>编写接口 DeptClientService，并增加新的注解@FeignClient。</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;SPRINGCLOUD-PROVIDER-DEPT&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeptClientService</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/dept/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Dept <span class="title function_">queryById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>; <span class="comment">//根据id查询部门</span></span><br><span class="line">   </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/dept/list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Dept&gt; <span class="title function_">queryAll</span><span class="params">()</span>; <span class="comment">//查询所有部门</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/dept/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addDept</span><span class="params">(Dept dept)</span>; <span class="comment">//添加一个部门</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>记得清理一下mvn。</li></ul><ol start="5"><li>springcloud-consumer-dept-feign-80工程修改Controller，添加上一步新建的DeptClientService。</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptConsumerController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 理解：消费者，不应该有service层~</span></span><br><span class="line"><span class="comment">     * RestTemplate .... 供我们直接调用就可以了！ 注册到Spring中</span></span><br><span class="line"><span class="comment">     * (地址：url, 实体：Map ,Class&lt;T&gt; responseType)</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 提供多种便捷访问远程http服务的方法，简单的Restful服务模板~</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptClientService service;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消费方添加部门信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dept</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consumer/dept/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(Dept dept)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.service.addDept(dept);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消费方根据id查询部门信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consumer/dept/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Dept <span class="title function_">get</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.service.queryById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消费方查询部门信息列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consumer/dept/list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Dept&gt; <span class="title function_">list</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.service.queryAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="6"><li>microservicecloud-consumer-dept-feign工程修改主启动类，开启Feign使用！</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="comment">// feign客户端注解,并指定要扫描的包以及配置接口DeptClientService</span></span><br><span class="line"><span class="meta">@EnableFeignClients(basePackages = &#123;&quot;com.github.service&quot;&#125;)</span></span><br><span class="line"><span class="comment">// 切记不要加这个注解，不然会出现404访问不到</span></span><br><span class="line"><span class="comment">// @ComponentScan(&quot;com.github.service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignDeptConsumer80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(FeignDeptConsumer80.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="7"><li>测试！</li></ol><ul><li>启动eureka集群；</li><li>启动8001，8002，8003 </li><li>启动feign客户端 </li><li>测试： <a href="http://localhost/consumer/dept/list">http://localhost/consumer/dept/list</a></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/03/image-20220223153152855.png" alt="image-20220223153152855"></p><p>&#x3D;&#x3D;结论：Feign自带负载均衡配置项&#x3D;&#x3D;。</p><blockquote><p>小结</p></blockquote><ul><li>Feign通过接口的方法调用Rest服务 ( 之前是Ribbon+RestTemplate )；</li><li>该请求发送给Eureka服务器 （<a href="http://microservicecloud-provider-dept/dept/list%EF%BC%89%EF%BC%9B">http://MICROSERVICECLOUD-PROVIDER-DEPT/dept/list）；</a></li><li>通过Feign直接找到服务接口，由于在进行服务调用的时候融合了Ribbon技术，所以也支持负载均衡作用！ </li><li>feign其实不是做负载均衡的,负载均衡是ribbon的功能,feign只是集成了ribbon而已,但是负载均衡的功能还是feign内置的ribbon再做,而不是feign。feign的作用的替代RestTemplate,性能比较低，但是可以使代码可读性很强。</li></ul><h2 id="8-Hystrix：服务熔断"><a href="#8-Hystrix：服务熔断" class="headerlink" title="8.Hystrix：服务熔断"></a>8.Hystrix：服务熔断</h2><blockquote><p>分布式系统面临的问题：</p></blockquote><ul><li>复杂分布式体系结构中的应用程序有数十个依赖关系，每个依赖关系在某些时候将不可避免的失败！</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/Hystrix.png" alt="Hystrix"></p><p><strong>服务雪崩</strong> </p><ul><li>多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B和微服务C又调用其他的微服务，这就是所谓的 “扇出”、如果扇出的链路上某个微服务的调用响应时间过长或者不可用，对微服务A的调用就会占用越来越多的系统资源，进而引起系统崩溃，所谓的“雪崩效应”。</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/image-20220223181908141.png" alt="image-20220223181908141"></p><ul><li>对于高流量的应用来说，单一的后端依赖可能会导致所有服务器上的所有资源都在几十秒内饱和。比失败更糟糕的是，这些应用程序还可能导致服务之间的延迟增加，备份队列，线程和其他系统资源紧张，导致整个系统发生更多的级联故障，<strong>这些都表示需要对故障和延迟进行隔离和管理，以达到单个依赖关系的失败而不影响整个应用程序或系统运行</strong>。</li><li>此时，我们需要<strong>弃车保帅</strong>！</li></ul><blockquote><p>什么是Hystrix？</p></blockquote><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/hystrix-logo-tagline-640.png" alt="hystrix-logo-tagline-640"></p><ul><li><p><strong>Hystrix</strong>是一个应用于处理分布式系统的延迟和容错的开源库，在分布式环境中，许多服务依赖项中的一些不可避免地会失败。Hystrix 是一个库，它通过添加延迟容错和容错逻辑来帮助您控制这些分布式服务之间的交互。Hystrix 通过隔离服务之间的访问点、停止它们之间的级联故障并提供回退选项来做到这一点，所有这些都可以提高系统的整体弹性。</p></li><li><p>“<strong>断路器</strong>”本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障监控 (类似熔断保险丝) ，<strong>向调用方返回一个服务预期的，可处理的备选响应 (FallBack) ，而不是长时间的等待或者抛出调用方法无法处理的异常，这样就可以保证了服务调用方的线程不会被长时间，不必要的占用</strong>，从而避免了故障在分布式系统中的蔓延，乃至雪崩。</p></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/image-20220223182133992.png" alt="image-20220223182133992"></p><p><strong>Hystrix的历史</strong></p><ul><li>Hystrix 源于 Netflix API 团队于 2011 年开始的弹性工程工作。2012 年，Hystrix 不断发展和成熟，Netflix 内部的许多团队都采用了它。如今，Netflix 每天通过 Hystrix 执行数百亿个线程隔离和数千亿个信号量隔离调用。这极大地提高了正常运行时间和恢复能力。</li></ul><hr><blockquote><p>Hystrix 有什么用？</p></blockquote><p>Hystrix 旨在执行以下操作：</p><ul><li>通过第三方客户端库访问（通常通过网络）依赖关系，保护和控制延迟和故障。</li><li>停止复杂分布式系统中的级联故障。</li><li>快速失败并迅速恢复。</li><li>尽可能回退并优雅降级。</li><li>实现近乎实时的监控、警报和操作控制。</li></ul><hr><blockquote><p>Hystrix 解决了什么问题？</p></blockquote><ul><li><p>复杂分布式架构中的应用程序有几十个依赖项，每个依赖项都不可避免地会在某个时候失败。如果主机应用程序没有与这些外部故障隔离开来，它就有被它们一起关闭的风险。</p></li><li><p>例如，对于依赖于 30 个服务且每个服务的正常运行时间为 99.99% 的应用程序，您可以期待以下内容：</p></li></ul><blockquote><p>99.99 30 &#x3D; 99.7% 的正常运行时间<br>10 亿次请求的 0.3% &#x3D; 3,000,000 次故障 2<br>小时以上的停机时间&#x2F;月，即使所有依赖项都具有出色的正常运行时间。</p></blockquote><ul><li><p>现实通常更糟。</p></li><li><p>即使所有依赖项都表现良好，<strong>如果您不对整个系统进行弹性设计</strong>，即使对数十项服务中的每项服务造成 0.01% 的停机时间的总影响也相当于可能每月停机数小时。</p></li></ul><hr><ul><li>当一切正常时，请求流程可能如下所示：</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/soa-1-640.png" alt="soa-1-640"></p><ul><li>当许多后端系统之一变得潜在时，它可以阻止整个用户请求：</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/soa-2-640.png" alt="soa-2-640"></p><ul><li><p>在大流量的情况下，单个后端依赖变得潜在可能会导致所有服务器上的所有资源在几秒钟内变得饱和。</p></li><li><p>应用程序中通过网络或客户端库中可能导致网络请求的每个点都是潜在故障的根源。比故障更糟糕的是，这些应用程序还可能导致服务之间的延迟增加，这会备份队列、线程和其他系统资源，从而导致整个系统出现更多的级联故障。</p></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/soa-3-640.png" alt="soa-3-640"></p><ul><li><p>当通过第三方客户端执行网络访问时，这些问题会更加严重——一个“黑匣子”，其中实现细节被隐藏并且可以随时更改，并且每个客户端库的网络或资源配置都不同，并且通常难以监控和改变。</p></li><li><p>更糟糕的是传递依赖，它执行潜在的昂贵或容易出错的网络调用，而没有被应用程序显式调用。</p></li><li><p>网络连接失败或降级。服务和服务器出现故障或变慢。新的库或服务部署会改变行为或性能特征。客户端库有错误。</p></li><li><p>所有这些都代表了需要隔离和管理的故障和延迟，以便单个故障依赖项无法关闭整个应用程序或系统。</p></li></ul><blockquote><p>Hystrix 的设计原则是什么？</p></blockquote><p>Hystrix 通过以下方式工作：</p><ul><li>防止任何单个依赖项用完所有容器（例如 Tomcat）用户线程。</li><li>减轻负载并快速失败，而不是排队。</li><li>在可行的情况下提供回退，以保护用户免于失败。</li><li>使用隔离技术（例如隔板、泳道和断路器模式）来限制任何一种依赖项的影响。</li><li>通过近乎实时的指标、监控和警报优化发现时间</li><li>通过配置更改的低延迟传播和对 Hystrix 大部分方面的动态属性更改的支持来优化恢复时间，这允许您使用低延迟反馈循环进行实时操作修改。</li><li>防止整个依赖客户端执行中的故障，而不仅仅是网络流量中的故障。</li></ul><blockquote><p>Hystrix 如何实现其目标？</p></blockquote><ul><li>Hystrix 通过以下方式做到这一点：<ul><li>将所有对外部系统（或“依赖项”）的调用包装在一个<code>HystrixCommand</code>或<code>HystrixObservableCommand</code>对象中，该对象通常在单独的线程中执行（这是<a href="http://en.wikipedia.org/wiki/Command_pattern">命令模式</a>的一个示例）。</li><li>超时调用时间超过您定义的阈值。有一个默认值，但是对于大多数依赖项，您可以通过“属性”自定义设置这些超时，以便它们略高于每个依赖项测量的 99.5 %性能。</li><li>为每个依赖项维护一个小型线程池（或信号量）；如果它已满，发往该依赖项的请求将立即被拒绝而不是排队。</li><li>测量成功、失败（客户端抛出的异常）、超时和线程拒绝。</li><li>如果服务的错误百分比超过阈值，则手动或自动触发断路器以在一段时间内停止对特定服务的所有请求。</li><li>当请求失败、被拒绝、超时或短路时执行回退逻辑。</li><li>近乎实时地监控指标和配置更改。</li></ul></li><li>当您使用 Hystrix 包装每个底层依赖项时，如上图所示的架构将更改为类似于下图。每个依赖项相互隔离，限制在发生延迟时它可以饱和的资源，并包含在回退逻辑中，该逻辑决定当依赖项中发生任何类型的故障时做出什么响应：</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/soa-4-isolation-640.png" alt="soa-4-isolation-640"></p><ul><li><p>详细了解<a href="https://github.com/Netflix/Hystrix/wiki/How-it-Works">它的工作原理</a>和<a href="https://github.com/Netflix/Hystrix/wiki/How-To-Use">使用方法</a>。</p></li><li><p>&#x3D;&#x3D;以上概念参考于官方资料：<a href="https://github.com/Netflix/Hystrix/wiki">https://github.com/Netflix/Hystrix/wiki</a>&#x3D;&#x3D;。</p></li></ul><blockquote><p>服务熔断</p></blockquote><p><strong>什么是服务熔断</strong>?</p><ul><li><p><strong>熔断机制是赌赢雪崩效应的一种微服务链路保护机制</strong>。</p></li><li><p>当扇出链路的某个微服务不可用或者响应时间太长时，会进行服务的降级，<strong>进而熔断该节点微服务的调用，快速返回错误的响应信息</strong>。检测到该节点微服务调用响应正常后恢复调用链路。在SpringCloud框架里熔断机制通过Hystrix实现。Hystrix会监控微服务间调用的状况，当失败的调用到一定阀值缺省是<strong>5秒内20次调用失败，就会启动熔断机制</strong>。</p></li><li><p>熔断机制的注解是：<code>@HystrixCommand</code>。</p></li></ul><p><strong>服务熔断解决如下问题</strong>：</p><ul><li>当所依赖的对象不稳定时，能够起到快速失败的目的；</li><li>快速失败后，能够根据一定的算法动态试探所依赖对象是否恢复。</li></ul><p><strong>入门案例</strong>：</p><ul><li>参考springcloud-provider-dept-8001，新建springcloud-provider-dept-hystrix-8001，将之前8001的所有东西拷贝一份。</li></ul><ol><li>修改pom，添加Hystrix的依赖。</li></ol><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-hystrix --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>修改yml，修改eureka实例的id。</li></ol><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/image-20220223205606543.png" alt="image-20220223205606543"></p><ol start="3"><li>修改DeptController</li></ol><ul><li>@HystrixCommand报异常后如何处理</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 一旦调用服务方法失败并抛出了错误信息后</span></span><br><span class="line"><span class="comment">// 会自动调用HystrixCommand标注好的fallbackMethod调用类中指定方法</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;processHystrix_Get&quot;)</span></span><br></pre></td></tr></table></figure><ul><li>源码内容</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/dept&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptService service;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一旦调用服务方法失败并抛出了错误信息后</span></span><br><span class="line">    <span class="comment">// 会自动调用HystrixCommand标注好的fallbackMethod调用类中指定方法</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果根据id查询出现异常,则走hystrixGet这段备选代码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;hystrixGet&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Dept <span class="title function_">get</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="type">Dept</span> <span class="variable">dept</span> <span class="operator">=</span> service.queryById(id);</span><br><span class="line">        <span class="keyword">if</span> (dept==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;该id:&quot;</span>+id+<span class="string">&quot;没有对应的的信息&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dept;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询备选方案(熔断)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Dept <span class="title function_">hystrixGet</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Dept</span>().setDeptno(id)</span><br><span class="line">                .setDname(<span class="string">&quot;这个id=&gt;&quot;</span>+id+<span class="string">&quot;,没有对应的信息,null---@Hystrix~&quot;</span>)</span><br><span class="line">                .setDb_source(<span class="string">&quot;在MySQL中没有这个数据库&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>修改主启动类添加新注解 @EnableCircuitBreaker，修改主启动类的名称为 DeptProviderHystrix8001</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span> <span class="comment">// 本服务启动之后会自动注册进Eureka中！</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span> <span class="comment">// 开启服务发现客户端的注解，可以用来获取一些配置的信息，得到具体的微服务</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span> <span class="comment">//对hystrix 熔断机制的支持 【==========new=======】</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptProviderHystrix8001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DeptProviderHystrix8001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>测试 <ol><li>启动Eureka集群;</li><li>启动主启动类 DeptProviderHystrix8001;</li><li>启动客户端 springcloud-consumer-dept-80;</li><li>访问 <a href="http://localhost/consumer/dept/get/111">http://localhost/consumer/dept/get/111</a></li></ol></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/image-20220223210806933.png" alt="image-20220223210806933"></p><ul><li>使用熔断后，当访问一个不存在的id时，前台页展示数据如下:</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/image-20220223210917714.png" alt="image-20220223210917714"></p><ul><li>而不使用熔断的springcloud-provider-dept–8001模块访问相同地址会出现下面状况:</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/image-20220223211146475.png" alt="image-20220223211146475"></p><blockquote><p>服务降级</p></blockquote><p><strong>什么是服务降级</strong>?</p><ul><li><p>服务降级是指当服务器压力剧增的情况下，根据实际业务情况及流量，对一些服务和页面有策略的不处理，或换种简单的方式处理，从而释放服务器资源以保证核心业务正常运作或高效运作。说白了，<strong>就是尽可能的把系统资源让给优先级高的服务</strong>。</p></li><li><p>资源有限，而请求是无限的。如果在并发高峰期，不做服务降级处理，一方面肯定会影响整体服务的性能，严重的话可能会导致宕机某些重要的服务不可用。所以，一般在高峰期，为了保证核心功能服务的可用性，都要对某些服务降级处理。比如当双11活动时，把交易无关的服务统统降级，如查看蚂蚁深林，查看历史订单等等。</p></li></ul><p><strong>服务降级主要用于什么场景呢</strong>？</p><ul><li><p>当整个微服务架构整体的负载超出了预设的上限阈值或即将到来的流量预计将会超过预设的阈值时，为了保证重要或基本的服务能正常运行，可以将一些不重要或不紧急的服务或任务进行服务的 延迟使用或暂停使用。</p></li><li><p>降级的方式可以根据业务来，可以延迟服务，比如延迟给用户增加积分，只是放到一个缓存中，等服务平稳之后再执行；或者在粒度范围内关闭服务，比如关闭相关文章的推荐。</p></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/image-20220223211917403.png" alt="image-20220223211917403"></p><ul><li>由上图可得，<strong>当某一时间内服务A的访问量暴增，而B和C的访问量较少，为了缓解A服务的压力，这时候需要B和C暂时关闭一些服务功能，去承担A的部分服务，从而为A分担压力，叫做服务降级</strong>。</li></ul><p><strong>服务降级需要考虑的问题</strong></p><ul><li>1）那些服务是核心服务，哪些服务是非核心服务</li><li>2）那些服务可以支持降级，那些服务不能支持降级，降级策略是什么</li><li>3）除服务降级之外是否存在更复杂的业务放通场景，策略是什么？</li></ul><p><strong>自动降级分类</strong></p><ol><li><p>超时降级：主要配置好超时时间和超时重试次数和机制，并使用异步机制探测回复情况。</p></li><li><p>失败次数降级：主要是一些不稳定的api，当失败调用次数达到一定阀值自动降级，同样要使用异步机制探测回复情况。</p></li><li><p>故障降级：比如要调用的远程服务挂掉了（网络故障、DNS故障、http服务返回错误的状态码、rpc服务抛出异常），则可以直接降级。降级后的处理方案有：默认值（比如库存服务挂了，返回默认现货）、兜底数据（比如广告挂了，返回提前准备好的一些静态页面）、缓存（之前暂存的一些缓存数据）。</p></li><li><p>限流降级：秒杀或者抢购一些限购商品时，此时可能会因为访问量太大而导致系统崩溃，此时会使用限流来进行限制访问量，当达到限流阀值，后续请求会被降级；降级后的处理方案可以是：排队页面（将用户导流到排队页面等一会重试）、无货（直接告知用户没货了）、错误页（如活动太火爆了，稍后重试）。</p></li></ol><p><strong>入门案例</strong></p><ul><li>修改springcloud-api工程，根据已经有的DeptClientService接口新建一个实现了FallbackFactory接口的类DeptClientServiceFallbackFactory。</li><li>【注意：这个类上需要@Component注解！！！】</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptClientServiceFallbackFactory</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">create</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DeptClientService</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Dept <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Dept</span>().setDeptno(id)</span><br><span class="line">                        .setDname(<span class="string">&quot;该ID:&quot;</span> + id + <span class="string">&quot;没有对应的信息，Consumer客户端提供的降级信息，此刻服务Provider已经关闭！&quot;</span>)</span><br><span class="line">                        .setDb_source(<span class="string">&quot;No this database in MySQL.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> List&lt;Dept&gt; <span class="title function_">queryAll</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addDept</span><span class="params">(Dept dept)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>修改springcloud-api工程，DeptClientService接口在注解@FeignClient中添加fallbackFactory属性值。</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span> <span class="comment">// 注册到spring容器中</span></span><br><span class="line"><span class="comment">// @FeignClient:微服务客户端注解,value:指定微服务的名字,这样就可以使Feign客户端直接找到对应的微服务</span></span><br><span class="line"><span class="comment">// fallbackFactory指定降级配置类</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;SPRINGCLOUD-PROVIDER-DEPT&quot;,fallbackFactory = DeptClientServiceFallbackFactory.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeptClientService</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/dept/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Dept <span class="title function_">queryById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>; <span class="comment">//根据id查询部门</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/dept/list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Dept&gt; <span class="title function_">queryAll</span><span class="params">()</span>; <span class="comment">//查询所有部门</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/dept/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addDept</span><span class="params">(Dept dept)</span>; <span class="comment">//添加一个部门</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>springcloud-api工程<code>mvn clean install</code>；</li><li>springcloud-consumer-dept-feign-80工程修改YML；</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/image-20220224135408649.png" alt="image-20220224135408649"></p><p><strong>测试</strong> </p><ol><li><p>启动eureka集群； </p></li><li><p>启动 springcloud-provider-dept-hystrix-8001；</p></li><li><p>启动 springcloud-consumer-dept-feign-80；</p></li><li><p>正常访问测试：<a href="http://localhost/consumer/dept/get/1%EF%BC%9B">http://localhost/consumer/dept/get/1；</a></p><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/image-20220224140041962.png" alt="image-20220224140041962"></p></li><li><p>故意关闭微服务 springcloud-provider-dept-hystrix-8001；</p></li><li><p>客户端自己调用提示：<a href="http://localhost/consumer/dept/get/1">http://localhost/consumer/dept/get/1</a> </p><ul><li>此时服务端provider已经down了，但是我们做了服务降级处理，让客户端在服务端不可用时 也会获得提示信息而不会挂起耗死服务器。</li></ul></li></ol><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/2021062920504276.png" alt="在这里插入图片描述"></p><blockquote><p>服务熔断和降级的区别</p></blockquote><ul><li><strong>服务熔断—&gt;服务端</strong>：一般是某个服务故障或者异常引起，类似现实世界中的“保险丝”，当某个异常条件被触发，直接熔断整个服务，而不是一直等到此服务超时！</li><li><strong>服务降级—&gt;客户端</strong>：从整体网站请求负载考虑，当某个服务熔断或者关闭之后，服务将不再被调用，此时在客户端，我们可以准备一个 FallBackFactory ，返回一个默认的值(缺省值)。会导致整体的服务下降，但是好歹能用，比直接挂掉强。</li><li>触发原因不太一样，服务熔断一般是某个服务（下游服务）故障引起，而服务降级一般是从整体负荷考虑；管理目标的层次不太一样，熔断其实是一个框架级的处理，每个微服务都需要（无层级之分），而降级一般需要对业务有层级之分（比如降级一般是从最外围服务开始）。</li><li>实现方式不太一样，服务降级具有代码侵入性(由控制器完成&#x2F;或自动降级)，熔断一般称为<strong>自我熔断</strong>。</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/04/1641655-20200203200950188-1978691598.png" alt="/images/SpringCloudNetflixImage"></p><p><strong>熔断，降级，限流</strong>：</p><ul><li><p>限流：限制并发的请求访问量，超过阈值则拒绝；</p></li><li><p>降级：服务分优先级，牺牲非核心服务（不可用），保证核心服务稳定；从整体负荷考虑；</p></li><li><p>熔断：依赖的下游服务故障触发熔断，避免引发本系统崩溃；系统自动执行和恢复</p></li></ul><blockquote><p>Dashboard 流监控</p></blockquote><ul><li>除了隔离依赖服务的调用以外，Hystrix还提供了准实时的调用监控（Hystrix Dashboard），Hystrix会持续地记录所有通过Hystrix发起的请求的执行信息，并以统计报表和图形的形式展示给用户，包括每秒执行多少请求，多少成功，多少失败等等。 </li><li>Netflix通过hystrix-metrics-event-stream项目实现了对以上指标的监控，SpringCloud也提供了Hystrix Dashboard的整合，对监控内容转化成可视化界面！</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/05/diagram-distributed-systems.svg" alt="/images/SpringCloudNetflixImage"></p><ol><li>新建工程springcloud-consumer-hystrix-dashboard-9001</li><li>导入pom依赖</li></ol><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Hystrix依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--dashboard依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Ribbon--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-ribbon<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Eureka--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--实体类+web--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--热部署--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="3"><li>添加主启动类</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableHystrixDashboard</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptConsumerDashBoardApp9001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DeptConsumerDashBoardApp9001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>添加配置文件</li></ol><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">dashboard:</span></span><br><span class="line">    <span class="attr">proxy-stream-allow-list:</span> <span class="string">localhost</span></span><br></pre></td></tr></table></figure><ol start="5"><li>给springcloud-provider-dept-hystrix-8001模块下的主启动类添加如下代码,添加监控</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span> <span class="comment">// 本服务启动之后会自动注册进Eureka中！</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span> <span class="comment">// 开启服务发现客户端的注解，可以用来获取一些配置的信息，得到具体的微服务</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span> <span class="comment">//对hystrix 熔断机制的支持 【==========new=======】</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptProviderHystrix8001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DeptProviderHystrix8001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//增加一个 Servlet</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServletRegistrationBean <span class="title function_">hystrixMetricsStreamServlet</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ServletRegistrationBean</span> <span class="variable">registrationBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRegistrationBean</span>(<span class="keyword">new</span> <span class="title class_">HystrixMetricsStreamServlet</span>());</span><br><span class="line">        <span class="comment">//访问该页面就是监控页面</span></span><br><span class="line">        registrationBean.addUrlMappings(<span class="string">&quot;/actuator/hystrix.stream&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="6"><li><p>测试一</p><ul><li><p>启动springcloud-consumer-hystrix-dashboard-9001监控服务</p></li><li><p>访问：<a href="http://localhost:9001/hystrix">http://localhost:9001/hystrix</a></p><p><img src="/hexo-docs/images/SpringCloudNetflixImage/05/image-20220224200936842.png" alt="image-20220224200936842"></p></li><li><p>启动3个Eureka集群</p></li><li><p>启动springcloud-provider-dept-hystrix-8001</p></li><li><p>进入监控页面，访问：</p><ul><li><a href="http://localhost:8001/dept/get/1">http://localhost:8001/dept/get/1</a></li><li><a href="http://localhost:8001/actuator/hystrix.stream">http://localhost:8001/actuator/hystrix.stream</a> 【查看1秒一动的数据流】</li></ul></li></ul></li></ol><p><img src="/hexo-docs/images/SpringCloudNetflixImage/05/image-20220224201345128.png" alt="image-20220224201345128"></p><ol start="7"><li>监控测试<ul><li>多次刷新 <a href="http://localhost:8001/dept/get/1">http://localhost:8001/dept/get/1</a></li><li>观察监控窗口，就是那个豪猪页面；</li><li>添加监控地址：</li></ul></li></ol><p><img src="/hexo-docs/images/SpringCloudNetflixImage/05/image-20220224201635630.png" alt="image-20220224201635630"></p><ul><li>Delay: 该参数用来控制服务器上轮询监控信息的延迟时间，默认为2000毫秒，可以通过配置该属性来降低客户端的网络和CPU消耗 </li><li>Title：该参数对应了头部标题HystrixStream之后的内容，默认会使用具体监控实例URL，可以通过配置该信息来展示更合适的标题。</li><li>监控结果：</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/05/image-20220224201808829.png" alt="image-20220224201808829"></p><ul><li><p>如何看：</p><ul><li><p>7色：绿 &gt; 蓝 &gt; 青 &gt; 黄 &gt; 紫 &gt; 红</p><p><img src="/hexo-docs/images/SpringCloudNetflixImage/05/image-20220224201906162.png" alt="image-20220224201906162"></p></li><li><p>一圈：</p><ul><li>实心圆：公有两种含义，他通过颜色的变化代表了实例的健康程度。</li><li>它的健康程度从 绿色&lt;黄色&lt;橙色&lt;红色 递减。</li><li>该实心圆除了颜色的变化之外，它的大小也会根据实例的请求流量发生变化，流量越大，该实心圆就越大，所以通过该实心圆的展示，就可以在大量的实例中快速发现故障实例和高压力实例。</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/05/image-20220224202128990.png" alt="image-20220224202128990"></p></li><li><p>一线：</p><ul><li>曲线:用来记录2分钟内流量的相对变化,可以通过它来观察到流量的上升和下降趋势;</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/05/image-20220224202232243.png" alt="image-20220224202232243"></p></li><li><p>整图说明：</p></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/05/image-20220224203656549.png" alt="image-20220224203656549"></p></li><li><p>搞懂一个才能看懂复杂的</p></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/05/159998-20180606170211195-1652996172.png" alt="/images/SpringCloudNetflixImage"></p><h2 id="9-Zull路由网关"><a href="#9-Zull路由网关" class="headerlink" title="9.Zull路由网关"></a>9.Zull路由网关</h2><blockquote><p>概述</p></blockquote><p><strong>什么是zuul</strong>?</p><ul><li><p>Zull包含了对请求的<strong>路由</strong>(用来跳转的)和<strong>过滤</strong>两个最主要功能：</p></li><li><p>其中<strong>路由功能负责将外部请求转发到具体的微服务实例上，是实现外部访问统一入口的基础</strong>，而过<strong>滤器功能则负责对请求的处理过程进行干预，是实现请求校验，服务聚合等功能的基础</strong>。Zuul和Eureka进行整合，将Zuul自身注册为Eureka服务治理下的应用，同时从Eureka中获得其他服务的消息，也即以后的访问微服务都是通过Zuul跳转后获得。</p></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/05/image-20220224210505339.png" alt="image-20220224210505339"></p><ul><li><p><strong>注意</strong>：Zuul 服务最终还是会注册进 Eureka</p></li><li><p><strong>提供</strong>：代理 + 路由 + 过滤 三大功能！</p></li></ul><blockquote><p>Zuul 能干嘛？</p></blockquote><ul><li>路由</li><li>过滤</li></ul><p>官方文档：<a href="https://github.com/Netflix/zuul/">https://github.com/Netflix/zuul/</a></p><p><strong>入门案例</strong></p><ol><li>新建springcloud-zuul模块，并导入依赖</li></ol><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--导入zuul依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Hystrix依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--dashboard依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Ribbon--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-ribbon<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Eureka--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--实体类+web--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--热部署--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>application.yml</li></ul><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">4399</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-zuul</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Eureka的配置，服务注册到哪里</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">zuul4399.com</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment">#改为true后默认显示的是ip地址而不再是localhost  方便团队不同人使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># info配置</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">app.name:</span> <span class="string">subei-springcloud</span>  <span class="comment"># 项目的名称</span></span><br><span class="line">  <span class="attr">company.name:</span> <span class="string">www.subeily.top</span>  <span class="comment"># 公司的名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># zull 路由网关配置</span></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="comment"># 路由相关配置</span></span><br><span class="line">  <span class="comment"># 原来访问路由 eg:http://subeily.com:4399/springcloud-provider-dept/dept/get/2</span></span><br><span class="line">  <span class="comment"># zull路由配置后访问路由 eg: http://subeily.com:4399/subeily/mydept/dept/get/2</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">mydept.serviceId:</span> <span class="string">springcloud-provider-dept</span> <span class="comment"># eureka注册中心的服务提供方路由名称</span></span><br><span class="line">    <span class="attr">mydept.path:</span> <span class="string">/mydept/**</span> <span class="comment"># 将eureka注册中心的服务提供方路由名称 改为自定义路由名称</span></span><br><span class="line">  <span class="attr">ignored-services:</span> <span class="string">&quot;*&quot;</span> <span class="comment"># 不能再使用这个路径访问了，*： 忽略,隐藏全部的服务名称~</span></span><br><span class="line">  <span class="attr">prefix:</span> <span class="string">/subeily</span> <span class="comment"># 设置公共的前缀</span></span><br></pre></td></tr></table></figure><ul><li><p>hosts修改</p><ul><li>hosts文件的位置在C:\Windows\System32\drivers\etc\hosts</li></ul><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">127.0.0.1  subeily.com</span><br></pre></td></tr></table></figure></li><li><p>主启动类</p></li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span> <span class="comment">// 开启Zuul</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringCloudZuulApp4399</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SpringCloudZuulApp4399.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>启动：</p><ul><li>三个Eureka集群</li><li>服务提供者springcloud-provider-dept-8001</li><li>zuul服务</li><li>访问：<a href="http://localhost:7001/">http://localhost:7001/</a></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/05/image-20220224212021657.png" alt="image-20220224212021657"></p></li><li><p>可以看出Zull路由网关被注册到Eureka注册中心中了！</p></li><li><p>测试：</p><ul><li><p>不用路由：<a href="http://localhost:8001/dept/get/2">http://localhost:8001/dept/get/2</a> </p><p><img src="/hexo-docs/images/SpringCloudNetflixImage/05/image-20220224212247260.png" alt="image-20220224212247260"></p></li><li><p>使用路由：<a href="http://subeily.com:4399/springcloud-provider-dept/dept/get/2">http://subeily.com:4399/springcloud-provider-dept/dept/get/2</a></p><ul><li>网关&#x2F;微服务名字&#x2F;具体的服务</li></ul></li></ul></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/05/image-20220224212934768.png" alt="image-20220224212934768"></p><ul><li>上图是没有经过Zull路由网关配置时，服务接口访问的路由，可以看出直接用微服务(服务提供方)名称去访问，这样不安全，不能将微服务名称暴露！</li><li>所以经过Zull路由网关配置后，访问封装好的url：<a href="http://subeily.com:4399/subeily/mydept/dept/get/2">http://subeily.com:4399/subeily/mydept/dept/get/2</a></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/05/image-20220224213221611.png" alt="image-20220224213221611"></p><ul><li><p>微服务名称被替换并隐藏，换成了我们自定义的微服务名称mydept，同时加上了前缀subeily，这样就做到了对路由访问的加密处理。</p></li><li><p>详情参考springcloud中文社区zuul组件:<a href="https://www.springcloud.cc/spring-cloud-greenwich.html#_router_and_filter_zuul">Spring Cloud Greenwich 中文文档 参考手册 中文版</a></p></li></ul><h2 id="10-Spring-Cloud-Config-分布式配置"><a href="#10-Spring-Cloud-Config-分布式配置" class="headerlink" title="10.Spring Cloud Config 分布式配置"></a>10.Spring Cloud Config 分布式配置</h2><blockquote><p>概述</p></blockquote><p><strong>分布式系统面临的–配置文件问题</strong></p><ul><li>微服务意味着要将单体应用中的业务拆分成一个个子服务，每个服务的粒度相对较小，因此系统中会出现大量的服务，由于每个服务都需要必要的配置信息才能运行，所以一套集中式的，动态的配置管理设施是必不可少的。spring cloud提供了configServer来解决这个问题，我们每一个微服务自己带着一个application.yml，那上百个的配置文件修改起来，令人头疼！</li></ul><p><strong>SpringCloud config分布式配置中心</strong></p><p><img src="/hexo-docs/images/SpringCloudNetflixImage/06/springcloud10.png" alt="/images/SpringCloudNetflixImage"></p><ul><li>spring cloud config 为微服务架构中的微服务提供集中化的外部支持，配置服务器为各个不同微服务应用的所有环节提供了一个<strong>中心化的外部配置</strong>。</li><li>spring cloud config 分为<strong>服务端</strong>和<strong>客户端</strong>两部分。</li><li>服务端也称为 <strong>分布式配置中心</strong>，它是一个独立的微服务应用，用来连接配置服务器并为客户端提供获取配置信息，加密，解密信息等访问接口。</li><li>客户端则是<strong>通过指定的配置中心来管理应用资源，以及与业务相关的配置内容，并在启动的时候从配置中心获取和加载配置信息</strong>。配置服务器默认采用git来存储配置信息，这样就有助于对环境配置进行版本管理。并且可用通过git客户端工具来方便的管理和访问配置内容。</li></ul><p><strong>spring cloud config 分布式配置中心能干嘛？</strong></p><ul><li>集中式管理配置文件</li><li>不同环境，不同配置，动态化的配置更新，分环境部署，比如 &#x2F;dev &#x2F;test &#x2F;prod &#x2F;beta &#x2F;release</li><li>运行期间动态调整配置，不再需要在每个服务部署的机器上编写配置文件，服务会向配置中心统一拉取配置自己的信息</li><li>当配置发生变动时，服务不需要重启，即可感知到配置的变化，并应用新的配置</li><li>将配置信息以REST接口的形式暴露</li></ul><p><strong>spring cloud config 分布式配置中心与GitHub整合</strong></p><ul><li>由于spring cloud config 默认使用git来存储配置文件 (也有其他方式，比如自持SVN 和本地文件)，但是最推荐的还是git，而且使用的是 http&#x2F;https 访问的形式。</li></ul><blockquote><p>服务端</p></blockquote><ul><li><p>前提:</p><ul><li>在码云上新建仓库 springcloud-config，&#x3D;&#x3D;仓库要开源哦&#x3D;&#x3D;！！！<ul><li><a href="https://gitee.com/help/articles/4181#article-header0">生成&#x2F;添加SSH公钥</a></li></ul></li><li>拉取到本地，编写application.yaml配置文件</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/06/image-20220225172403569.png" alt="image-20220225172517418"></p></li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-config-dev</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-config-test</span></span><br></pre></td></tr></table></figure><ul><li>将本地git仓库springcloud-config文件夹下新建的application.yml提交到码云仓库:</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/06/image-20220225173808811.png" alt="image-20220225173808811"></p><p><img src="/hexo-docs/images/SpringCloudNetflixImage/06/image-20220225173832549.png" alt="image-20220225173832549"></p><ul><li>HTTP服务具有以下格式的资源：</li></ul><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/&#123;application&#125;/&#123;profile&#125;[/&#123;label&#125;]</span><br><span class="line">/&#123;application&#125;-&#123;profile&#125;.yml</span><br><span class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.yml</span><br><span class="line">/&#123;application&#125;-&#123;profile&#125;.properties</span><br><span class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.properties</span><br></pre></td></tr></table></figure><ul><li>新建模块 springcloud-config-server-3344，导入依赖</li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--web--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--config--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>编写配置文件</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3344</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-config-server</span></span><br><span class="line">  <span class="comment"># 连接码云远程仓库</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="comment"># 注意是https的而不是ssh</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://gitee.com/yang365/springcloud-config.git</span></span><br><span class="line">          <span class="comment"># 通过 config-server可以连接到git，访问其中的资源以及配置~</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不加这个配置会报Cannot execute request on any known server 这个错：连接Eureka服务端地址不对</span></span><br><span class="line"><span class="comment"># 或者直接注释掉eureka依赖 这里暂时用不到eureka</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><ul><li>主启动类</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableConfigServer</span>   <span class="comment">// 开启spring cloud config server服务</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigServer3344</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConfigServer3344.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>测试</p><ul><li><p>启动 ConfigServer3344 即可；</p></li><li><p>访问 <a href="http://localhost:3344/application-dev.yaml">http://localhost:3344/application-dev.yaml</a></p><p><img src="/hexo-docs/images/SpringCloudNetflixImage/06/image-20220225202051854.png" alt="image-20220225202051854"></p></li><li><p>访问 <a href="http://localhost:3344/application/test/master">http://localhost:3344/application/test/master</a></p><p><img src="/hexo-docs/images/SpringCloudNetflixImage/06/image-20220225202108065.png" alt="image-20220225202108065"></p></li><li><p>访问 <a href="http://localhost:3344/master/application-dev.yaml">http://localhost:3344/master/application-dev.yaml</a></p><p><img src="/hexo-docs/images/SpringCloudNetflixImage/06/image-20220225202123168.png" alt="image-20220225202123168"></p></li><li><p>访问不存在的配置</p></li></ul></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/06/image-20220225202246907.png" alt="image-20220225202246907"></p><blockquote><p>客户端</p></blockquote><ul><li>在本地库编写一个配置文件config-client.yaml，并且上传到码云仓库。</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8201</span></span><br><span class="line"><span class="comment">#spring配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-config-client</span></span><br><span class="line"><span class="comment">#Eureka的配置，服务注册到哪里</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8202</span></span><br><span class="line"><span class="comment">#spring配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-config-client</span></span><br><span class="line"><span class="comment">#Eureka的配置，服务注册到哪里</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span></span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/SpringCloudNetflixImage/06/image-20220225203405428.png" alt="image-20220225203405428"></p><p><img src="/hexo-docs/images/SpringCloudNetflixImage/06/image-20220225203555050.png" alt="image-20220225203555050"></p><ul><li>新建 springcloud-config-client-3355 模块，导入依赖</li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--——web--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--actuator完善监控信息--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>resources下创建application.yml和bootstrap.yml配置文件</li></ul><blockquote><p>其中bootstrap.yml是系统级别的配置文件，application.yml是用户级别的配置文件，系统级别更高级。因为要访问远程库的配置文件，所以一些重要的配置编写在系统级别的配置文件中。</p></blockquote><ul><li>bootstrap.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统级别的配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-client</span> <span class="comment"># 需要从git上读取的资源名称，不要后缀</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:3344</span></span><br></pre></td></tr></table></figure><ul><li>application.yml</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 用户级别的配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-config-client</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 不加这个配置会报Cannot execute request on any known server 这个错：连接Eureka服务端地址不对</span></span><br><span class="line"><span class="comment"># 或者直接注释掉eureka依赖 这里暂时用不到eureka</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><ul><li>创建controller包下的<strong>ConfigClientController.java</strong> 用于测试</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.application.name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String applicationName; <span class="comment">//获取微服务名称</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;eureka.client.service-url.defaultZone&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String eurekaServer; <span class="comment">//获取Eureka服务</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port; <span class="comment">//获取服务端的端口号</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/config&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfig</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;applicationName:&quot;</span>+applicationName +</span><br><span class="line">                <span class="string">&quot;eurekaServer:&quot;</span>+eurekaServer +</span><br><span class="line">                <span class="string">&quot;port:&quot;</span>+port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>编写主启动类</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClient3355</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConfigClient3355.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>测试一下，先启动3344，后启动客户端，然后访问 <a href="http://localhost:8201/config/">http://localhost:8201/config/</a></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/06/image-20220225204557627.png" alt="image-20220225204557627"></p><ul><li>在bootstrap.yaml文件中，切换一下环境dev-&gt;test</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统级别的配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-client</span> <span class="comment"># 需要从git上读取的资源名称，不要后缀</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:3344</span></span><br></pre></td></tr></table></figure><ul><li>重新测试，继续访问 <a href="http://localhost:8201/config">http://localhost:8201/config</a> 发现没用了。访问 <a href="http://localhost:8202/config">http://localhost:8202/config</a></li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/06/image-20220225204939567.png" alt="image-20220225204939567"></p><blockquote><p>实战一下</p><ul><li>需求：把之前的7001、8001配置文件修改成远程库读取配置文件，实现配置与编码解耦。</li></ul></blockquote><ul><li>本地新建config-dept.yaml和config-eureka.yaml并提交到码云仓库。</li></ul><p><img src="/hexo-docs/images/SpringCloudNetflixImage/06/image-20220225214805081.png" alt="image-20220225214805081"></p><ul><li>config-dept.yaml<ul><li>其中为了测试dev和test唯一的不同是连接的数据库不同。</li></ul></li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"><span class="comment"># mybatis的配置</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">config-location:</span> <span class="string">classpath:mybatis/mybatis-config.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.github.pojo</span></span><br><span class="line">  <span class="attr">mapper-locations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath:mybatis/mapper/**/*.xml</span></span><br><span class="line"><span class="comment"># spring的相关配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-config-dept</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> <span class="comment"># 数据源</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.gjt.mm.mysql.Driver</span> <span class="comment"># mysql驱动</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/springcloud?useSSL=false</span> <span class="comment">#数据库名称</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">dbcp2:</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">5</span> <span class="comment">#数据库连接池的最小维持连接数</span></span><br><span class="line">      <span class="attr">initial-size:</span> <span class="number">5</span> <span class="comment">#初始化连接数</span></span><br><span class="line">      <span class="attr">max-total:</span> <span class="number">5</span> <span class="comment">#最大连接数</span></span><br><span class="line">      <span class="attr">max-wait-millis:</span> <span class="number">200</span> <span class="comment">#等待连接获取的最大超时时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Eureka配置：配置服务注册中心地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># 注册中心地址7001-7003</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">springcloud-provider-dept-8001</span> <span class="comment"># 与client平级</span></span><br><span class="line"> <span class="comment">#   prefer-ip-address: true # true表示访问路径可以显示IP地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># info配置</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">app.name:</span> <span class="string">subei-springcloud</span>  <span class="comment"># 项目的名称</span></span><br><span class="line">  <span class="attr">company.name:</span> <span class="string">www.subeily.top</span>  <span class="comment"># 公司的名称</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"><span class="comment"># mybatis的配置</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">config-location:</span> <span class="string">classpath:mybatis/mybatis-config.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.github.pojo</span></span><br><span class="line">  <span class="attr">mapper-locations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath:mybatis/mapper/**/*.xml</span></span><br><span class="line"><span class="comment"># spring的相关配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-config-dept</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> <span class="comment"># 数据源</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.gjt.mm.mysql.Driver</span> <span class="comment"># mysql驱动</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/springcloud?useSSL=false</span> <span class="comment">#数据库名称</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">dbcp2:</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">5</span> <span class="comment">#数据库连接池的最小维持连接数</span></span><br><span class="line">      <span class="attr">initial-size:</span> <span class="number">5</span> <span class="comment">#初始化连接数</span></span><br><span class="line">      <span class="attr">max-total:</span> <span class="number">5</span> <span class="comment">#最大连接数</span></span><br><span class="line">      <span class="attr">max-wait-millis:</span> <span class="number">200</span> <span class="comment">#等待连接获取的最大超时时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Eureka配置：配置服务注册中心地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># 注册中心地址7001-7003</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">springcloud-provider-dept-8001</span> <span class="comment"># 与client平级</span></span><br><span class="line"> <span class="comment">#   prefer-ip-address: true # true表示访问路径可以显示IP地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># info配置</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">app.name:</span> <span class="string">subei-springcloud</span>  <span class="comment"># 项目的名称</span></span><br><span class="line">  <span class="attr">company.name:</span> <span class="string">www.subeily.top</span>  <span class="comment"># 公司的名称</span></span><br></pre></td></tr></table></figure><ul><li>config-eureka.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#spring配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-config-eureka</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># Eureka配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001.com</span> <span class="comment">#eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment">#是否将自己注册到Eureka服务器中，本身是服务器，无需注册</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span> <span class="comment">#false表示自己端就是注册中心，职责是维护服务实例，并不需要检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># 单机 defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">      <span class="comment"># 设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个defaultZone地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#spring配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-config-eureka</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># Eureka配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001.com</span> <span class="comment">#eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment">#是否将自己注册到Eureka服务器中，本身是服务器，无需注册</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span> <span class="comment">#false表示自己端就是注册中心，职责是维护服务实例，并不需要检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># 单机 defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">      <span class="comment"># 设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个defaultZone地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span></span><br></pre></td></tr></table></figure><ul><li><p>新建springcloud-config-eureka-7001模块，内容和之前的springcloud-eureka-7001一样</p></li><li><p>修改springcloud-config-eureka-7001的配置文件，换成远程库读取</p><ul><li>添加bootstrap.yaml系统配置文件</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统级别的配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-eureka</span> <span class="comment"># 需要从git上读取的资源名称，不要后缀</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:3344</span></span><br></pre></td></tr></table></figure><ul><li>修改application.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-config-eureka</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不加这个配置会报Cannot execute request on any known server 这个错：连接Eureka服务端地址不对</span></span><br><span class="line"><span class="comment"># 或者直接注释掉eureka依赖 这里暂时用不到eureka</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></li><li><p>新建springcloud-config-provider-dept-8001模块，内容和之前的springcloud-provider-dept-8001一样</p></li><li><p>修改springcloud-config-provider-dept-8001的配置文件，换成远程库读取</p><ul><li>添加bootstrap.yaml系统配置文件</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统级别的配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-dept</span> <span class="comment"># 需要从git上读取的资源名称，不要后缀</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:3344</span></span><br></pre></td></tr></table></figure><ul><li>修改application.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-config-provider-dept</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不加这个配置会报Cannot execute request on any known server 这个错：连接Eureka服务端地址不对</span></span><br><span class="line"><span class="comment"># 或者直接注释掉eureka依赖 这里暂时用不到eureka</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></li><li><p>&#x3D;&#x3D;在7001、8001的pom.xml中添加spring cloud config依赖&#x3D;&#x3D;。</p></li></ul><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--config--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><p>测试</p><ul><li>启动cofig3344服务端、客户端7001和8001</li><li>访问 <a href="http://localhost:3344/master/config-eureka-dev.yaml">http://localhost:3344/master/config-eureka-dev.yaml</a> ,<br><img src="/hexo-docs/images/SpringCloudNetflixImage/06/image-20220225220302796.png" alt="image-20220225220302796"></li></ul><blockquote><p>说明config服务端没问题</p></blockquote><ul><li>访问 <a href="http://localhost:7001/">http://localhost:7001/</a><br><img src="/hexo-docs/images/SpringCloudNetflixImage/06/image-20220225220633386.png" alt="image-20220225220633386"></li></ul><blockquote><p>说明远程配置读取成功</p></blockquote><ul><li>访问 <a href="http://localhost:8001/dept/get/2">http://localhost:8001/dept/get/2</a><br><img src="/hexo-docs/images/SpringCloudNetflixImage/06/image-20220225220714829.png" alt="image-20220225220714829"></li></ul><blockquote><p>说明8001也从远程库读取配置文件成功</p></blockquote><ul><li>修改客户端8001的配置文件，变成读取test版的配置文件</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统级别的配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-dept</span> <span class="comment"># 需要从git上读取的资源名称，不要后缀</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:3344</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不加这个配置会报Cannot execute request on any known server 这个错：连接Eureka服务端地址不对</span></span><br><span class="line"><span class="comment"># 或者直接注释掉eureka依赖 这里暂时用不到eureka</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><ul><li>重新启动访问 <a href="http://localhost:8001/dept/get/2">http://localhost:8001/dept/get/2</a><br><img src="/hexo-docs/images/SpringCloudNetflixImage/06/image-20220225221008365.png" alt="image-20220225221008365"></li></ul></li><li><p>测试成功。</p></li></ul><h2 id="总结导图"><a href="#总结导图" class="headerlink" title="总结导图"></a>总结导图</h2><p><img src="/hexo-docs/images/SpringCloudNetflixImage/spring_cloud_NetFlix.png" alt="spring cloud NetFlix"></p>]]></content>
      
      
      <categories>
          
          <category> 后端 Spring Cloud Netflix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring Cloud </tag>
            
            <tag> Spring Cloud Netflix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RDB+AOF</title>
      <link href="/hexo-docs/2025/08/13/redis/RDB+AOF/"/>
      <url>/hexo-docs/2025/08/13/redis/RDB+AOF/</url>
      
        <content type="html"><![CDATA[<h2 id="redis数据数据持久化"><a href="#redis数据数据持久化" class="headerlink" title="redis数据数据持久化"></a>redis数据数据持久化</h2><p><img src="/hexo-docs/images/redisImages/image-20250412134834950.png" alt="image-20250412134834950"></p><p>为什么要用数据持久化？</p><p>数据持久化可以在内存丢失或其他灾难性故障的情况下实现恢复。</p><p>数据持久化的两种方式</p><ol><li>AOF：以日志的形式来记录每个写操作，将redis执行过的所有写指令记录下来（读操作不记录），只许追加文件但不可以改写文件，redis启动之初会读取该文件重新构建数据，换言之，redis重启的话就根据日志文件的内容将写入指令从前到后执行一次以完成数据的恢复工作。</li><li>RDB（Redis 数据库）：RDB 持久性以指定的时间间隔执行数据集的时间点快照。</li></ol><h3 id="rdb（redis-database）"><a href="#rdb（redis-database）" class="headerlink" title="rdb（redis database）"></a>rdb（redis database）</h3><p><strong>能干嘛？</strong></p><p>在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是行话讲的Snapshot内存快照，它恢复时再将硬盘快照文件直接读回到内存里。Redis的数据都在内存中，保存备份时它执行的是全量快照，也就是说，把内存中的所有数据都记录到磁盘中，一锅端。</p><p>Rdb保存的是dump.rdb文件</p><p><img src="/hexo-docs/images/redisImages/image-20250412135541703.png" alt="image-20250412135541703"></p><p>Redis6.0.16以下</p><p><img src="/hexo-docs/images/redisImages/image-20250412135626311.png" alt="image-20250412135626311"></p><p>Redis6.2以及Redis-7.0.0</p><p><img src="/hexo-docs/images/redisImages/image-20250412135716317.png" alt="image-20250412135716317"></p><h4 id="自动触发"><a href="#自动触发" class="headerlink" title="自动触发"></a>自动触发</h4><ol><li>redis7版本，按照redis.conf里配置的save&lt;seconds&gt;&lt;changes&gt;</li></ol><p><img src="/hexo-docs/images/redisImages/image-20250412135904456.png" alt="image-20250412135904456"></p><ol start="2"><li>本案例5秒内2次修改</li></ol><p><img src="/hexo-docs/images/redisImages/image-20250412140300483.png" alt="image-20250412140300483"></p><ol start="3"><li>修改dump文件保存路径</li></ol><p><img src="/hexo-docs/images/redisImages/image-20250412140334001.png" alt="image-20250412140334001"></p><p><img src="/hexo-docs/images/redisImages/image-20250412140539111.png" alt="image-20250412140539111"></p><p><img src="/hexo-docs/images/redisImages/image-20250412143040215.png" alt="image-20250412143040215"></p><p><img src="/hexo-docs/images/redisImages/image-20250412143204897.png" alt="image-20250412143204897"></p><p>修改dump的默认文件名称</p><p><img src="/hexo-docs/images/redisImages/image-20250412143515348.png" alt="image-20250412143515348"></p><p>触发备份情况</p><ol><li><img src="/hexo-docs/images/redisImages/image-20250412143957147.png" alt="image-20250412143957147"></li><li><img src="/hexo-docs/images/redisImages/image-20250412144015323.png" alt="image-20250412144015323"></li></ol><p>如何恢复？</p><ol><li><p>将备份文件（dump6379.rdb）移动到redis安装目录并启动服务即可</p></li><li><p>备份成功后故意用flushdb清空redis，看看是否可以恢复数据</p><p><img src="/hexo-docs/images/redisImages/image-20250412144353554.png" alt="image-20250412144353554"></p><ol><li><p>结论</p><p>执行flushdb&#x2F;flushall命令也会产生dump.rdb文件，但是里面是空的，无意义</p></li></ol></li><li><p>物理恢复，一定服务和备份<strong>分级隔离</strong></p><p><img src="/hexo-docs/images/redisImages/image-20250412144525191.png" alt="image-20250412144525191">不可以把备份文件dump.rdb和生产redis服务器放在同一台机器，必须分开各自存储，以防生产机物理损坏后备份文件也挂了。</p></li></ol><p>注意：</p><p><img src="/hexo-docs/images/redisImages/image-20250412145620989.png" alt="image-20250412145620989"></p><p>执行quit命令就会写入dump文件，建议保存好数据，修改文件名或后缀名，或者备份文件，以免文件被覆盖</p><h4 id="手动触发"><a href="#手动触发" class="headerlink" title="手动触发"></a>手动触发</h4><p>redis提供了两个命令来生成RDB文件，分别是save和bgsave</p><p><strong>save（不推荐使用）</strong>：</p><p>在主程序中执行<strong>会阻塞</strong>当前redis服务器，直到持久化工作完成执行save命令期间，redis不能处理其他命令，线上禁止使用。</p><p><img src="/hexo-docs/images/redisImages/image-20250412160029456.png" alt="image-20250412160029456"></p><p><img src="/hexo-docs/images/redisImages/image-20250412160456020.png" alt="image-20250412160456020"></p><p><strong>bgsave（默认）</strong>：</p><p>redis会在后台异步进行快照操作，<strong>不阻塞</strong>快照同时还可以响应客户端请求，该触发方式会fork一个子进程由子进程复制持久化过程</p><p>redis会使用bgsave对当前内存中的所有数据做快照，这个操作是子进程在后台完成的，这就允许主进程同时可以修改数据。</p><p><strong>fork是什么？</strong></p><p> 在Linux程序中，fork()会产生一个和父进程完全相同的子进程，但子进程在此后多会exec系统调用，出于效率考虑，尽量避免膨胀。</p><p><img src="/hexo-docs/images/redisImages/image-20250412160045041.png" alt="image-20250412160045041"></p><p><img src="/hexo-docs/images/redisImages/image-20250412160715667.png" alt="image-20250412160715667"></p><p><strong>lastsave</strong>：可以通过lastsave命令获取最后一次成功执行快照的时间</p><p><img src="/hexo-docs/images/redisImages/image-20250412160833207.png" alt="image-20250412160833207"></p><h4 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h4><p><img src="/hexo-docs/images/redisImages/image-20250412162222408.png" alt="image-20250412162222408"></p><ol><li>适合大规模的数据恢复</li><li>按照业务定时备份</li><li>对数据完整性和一致性要求不高</li><li>RDB文件在内存中的加载速度要比 AOF 快得多</li></ol><h4 id="劣势"><a href="#劣势" class="headerlink" title="劣势"></a>劣势</h4><p><img src="/hexo-docs/images/redisImages/image-20250412162355639.png" alt="image-20250412162355639"></p><ol><li>在一定间隔时间做一次备份，所以如果redis意外down掉的话，就会丢失从当前至最近一次快照期间的数据，快照之间的数据会丢失</li><li>内存数据的全量同步，如果数据量太大会导致 I&#x2F;O 严重影响服务器性能</li><li>RDB 依赖于主进程的 fork，在更大的数据集中，这可能会导致服务请求的瞬间延迟。fork的时候内存中的数据被克隆了一份，大致2倍的膨胀性，需要考虑</li></ol><p><strong>数据丢失案例</strong>：</p><p>正常录入数据</p><p><img src="/hexo-docs/images/redisImages/image-20250412163907395.png" alt="image-20250412163907395"></p><p>使用kill -9杀死进程</p><p><img src="/hexo-docs/images/redisImages/image-20250412163947557.png" alt="image-20250412163947557"></p><p>重启服务后，查看数据是否丢失</p><p><img src="/hexo-docs/images/redisImages/image-20250412164019685.png" alt="image-20250412164019685"></p><h4 id="如何检测并修复dump-rdb文件"><a href="#如何检测并修复dump-rdb文件" class="headerlink" title="如何检测并修复dump.rdb文件"></a>如何检测并修复dump.rdb文件</h4><p><img src="/hexo-docs/images/redisImages/image-20250412164706643.png" alt="image-20250412164706643"></p><h4 id="哪些情况会触发RDB快照"><a href="#哪些情况会触发RDB快照" class="headerlink" title="哪些情况会触发RDB快照"></a>哪些情况会触发RDB快照</h4><ol><li>配置文件中默认的快照配置</li><li>手动 save&#x2F;bgsave 命令</li><li>执行 flushall&#x2F;flushdb 命令也会产生 dump.rdb 文件，但这里面是空的，无意义</li><li>执行 shutdown 且没有设置开启 AOF 持久化</li><li>主从复制时，主节点自动触发</li></ol><h4 id="如何禁用快照"><a href="#如何禁用快照" class="headerlink" title="如何禁用快照"></a>如何禁用快照</h4><ol><li><p>动态所有停止 RDB 保存规则的方法：<code>redis-cli config set save</code> “”</p></li><li><p>快照禁用</p><p><img src="/hexo-docs/images/redisImages/image-20250412165053214.png" alt="image-20250412165053214"></p></li></ol><h4 id="RDB-优化配置项"><a href="#RDB-优化配置项" class="headerlink" title="RDB 优化配置项"></a>RDB 优化配置项</h4><p>配置文件<code>SNAPSHOTTING</code>模块</p><p>save &lt;seconds&gt;&lt;changes&gt;</p><p><code>dbfilename</code></p><p><code>dir</code></p><p><code>stop-writes-on-bgsave-error</code></p><p><img src="/hexo-docs/images/redisImages/image-20250412170306543.png" alt="image-20250412170306543"></p><p>默认yes</p><p>如果配置成no，表示你不在乎数据不一致或者有其他的手段发现和控制这种不一致，那么在快照写入失败时，</p><p>也能确保redis继续接受新的写请求</p><p><code>rdbcompression</code></p><p><img src="/hexo-docs/images/redisImages/image-20250412170338012.png" alt="image-20250412170338012"></p><p>默认yes</p><p>对于存储到磁盘中的快照，可以设置是否进行压缩存储。如果是的话，redis会采用LZF算法进行压缩。 如果你不想消耗CPU来进行压缩的话，可以设置为关闭此功能 </p><p><code>rdbchecksum</code></p><p><img src="/hexo-docs/images/redisImages/image-20250412170442335.png" alt="image-20250412170442335"></p><p>默认yes</p><p>在存储快照后，还可以让redis使用CRC64算法来进行数据校验，但是这样做会增加大约10%的性能消耗，如果希望获取到最大的性能提升，可以关闭此功能</p><p><code>rdb-del-sync-files</code></p><p><img src="/hexo-docs/images/redisImages/image-20250412170506875.png" alt="image-20250412170506875"></p><p>rdb-del-sync-files：在没有持久性的情况下删除复制中使用的RDB文件启用。默认情况下no，此选项是禁用的。</p><h4 id="关闭RDB持久化"><a href="#关闭RDB持久化" class="headerlink" title="关闭RDB持久化"></a>关闭RDB持久化</h4><p><img src="/hexo-docs/images/redisImages/image-20250413151754846.png" alt="image-20250413151754846"></p><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p><img src="/hexo-docs/images/redisImages/image-20250412170541034.png" alt="image-20250412170541034"></p><h3 id="AOF（Append-Only-File）"><a href="#AOF（Append-Only-File）" class="headerlink" title="AOF（Append Only File）"></a>AOF（Append Only File）</h3><p>以日志的形式来记录每个写操作，将Redis执行过的所有写指令记录下来（读操作不记录），只许追加文件但不可以改写文件，redis启动之初会读取该文件重新构建数据，换言之，redis重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作</p><p>默认情况下，redis是没有开启AOF（append only file）的。开启AOF 功能需要设置配置：<code>appendonly yes</code></p><p>AOF 保存的是appendonly.aof文件</p><h4 id="AOF-持久化工作流程："><a href="#AOF-持久化工作流程：" class="headerlink" title="AOF 持久化工作流程："></a><strong>AOF 持久化工作流程</strong>：</h4><p><img src="/hexo-docs/images/redisImages/image-20250413140942560.png" alt="image-20250413140942560"></p><table><thead><tr><th>1</th><th>Client作为命令的来源，会有多个源头以及源源不断的请求命令。</th></tr></thead><tbody><tr><td>2</td><td>在这些命令到达Redis Server 以后并不是直接写入AOF文件，会将其这些命令先放入AOF缓存中进行保存。这里的AOF缓冲区实际上是内存中的一片区域，存在的目的是当这些命令达到一定量以后再写入磁盘，避免频繁的磁盘IO操作。</td></tr><tr><td>3</td><td>AOF缓冲会根据AOF缓冲区***同步文件的三种写回策略***将命令写入磁盘上的AOF文件。</td></tr><tr><td>4</td><td>随着写入AOF内容的增加为避免文件膨胀，会根据规则进行命令的合并(又称***AOF重写)***，从而起到AOF文件压缩的目的。</td></tr><tr><td>5</td><td>当Redis Server 服务器重启的时候会从AOF文件载入数据。</td></tr></tbody></table><h4 id="AOF缓冲区三种写回策略"><a href="#AOF缓冲区三种写回策略" class="headerlink" title="AOF缓冲区三种写回策略"></a>AOF缓冲区三种写回策略</h4><ol><li><p>always</p><p>同步写回，每个写命令执行完成立刻同步地将日志写回磁盘</p></li><li><p>everysec</p><p>每秒写回，每个写命令执行完，只是先把日志写到 AOF 文件的内存缓冲区，每隔1秒把缓冲区中的内容写入磁盘</p></li><li><p>no：操作系统控制的写回，每个写命令执行完，只是先把日志写到 AOF 文件的内存缓冲区，由操作系统决定何时将缓冲区内容写回磁盘</p></li></ol><p><strong>三种写回策略总结</strong>：</p><table><thead><tr><th align="center">配置项</th><th align="center">写回时机</th><th align="center">优点</th><th align="center">缺点</th></tr></thead><tbody><tr><td align="center">Always</td><td align="center">同步写回</td><td align="center">可靠性高，数据基本不丢失</td><td align="center">每个写命令都要落盘，性能影响较大</td></tr><tr><td align="center">Everysec</td><td align="center">每秒写回</td><td align="center">性能适中</td><td align="center">宕机时丢失1秒内的数据</td></tr><tr><td align="center">No</td><td align="center">操作系统控制的写回</td><td align="center">性能好</td><td align="center">宕机时丢失数据较多</td></tr></tbody></table><h4 id="AOF配置-启动-修复-恢复（redis6-vs-redis7中的区别）"><a href="#AOF配置-启动-修复-恢复（redis6-vs-redis7中的区别）" class="headerlink" title="AOF配置&#x2F;启动&#x2F;修复&#x2F;恢复（redis6 vs redis7中的区别）"></a>AOF配置&#x2F;启动&#x2F;修复&#x2F;恢复（redis6 vs redis7中的区别）</h4><p>配置文件说明（6 vs 7）</p><ol><li><p>如何开启 aof</p><p><img src="/hexo-docs/images/redisImages/image-20250413142055377.png" alt="image-20250413142055377"></p></li><li><p>使用默认写回方式，每秒钟</p><p><img src="/hexo-docs/images/redisImages/image-20250413142350177.png" alt="image-20250413142350177"></p></li><li><p>aof文件-保存路径</p><ol><li><p>redis6</p><p>aof 保存文件的位置和RDB保存文件的位置一样，都是通过 redis.conf 配置文件的dir配置</p><p><img src="/hexo-docs/images/redisImages/image-20250413142506831.png" alt="image-20250413142506831"></p></li><li><p>redis7之后最新</p><p><img src="/hexo-docs/images/redisImages/image-20250413143145004.png" alt="image-20250413143145004"></p><p>去除dumpfiles</p><p><img src="/hexo-docs/images/redisImages/image-20250413143241436.png" alt="image-20250413143241436"></p></li><li><p>aof文件-保存名称</p><ol><li><p>redis6：有且仅有一个</p></li><li><p>redis7：Multi Part AOF 的设计</p><p><img src="/hexo-docs/images/redisImages/image-20250413143617617.png" alt="image-20250413143617617"></p><p><img src="/hexo-docs/images/redisImages/image-20250413143420437.png" alt="image-20250413143420437"></p><ol><li>base 基本文件</li><li>incr 增量文件</li><li>manifest 清单文件</li></ol></li><li><p>redis7.0config 中对应的配置项</p><p><img src="/hexo-docs/images/redisImages/image-20250413143519513.png" alt="image-20250413143519513"></p></li></ol></li></ol><p>正常恢复</p><ol><li><p>启动：设置yes</p><p>修改默认的appendonly no ，改为 yes</p></li><li><p>写操作继续，生成 aof 文件到指定的目录</p></li><li><p>恢复1：重启redis 然后重新加载，结果 ok</p></li><li><p>恢复2：</p><ol><li>写入数据进redis，然后flushdb+shutdown服务器</li><li>新生成 dump和aof</li><li>备份新生成的 aof.bak，然后删除 dump&#x2F;aof 再恢复</li><li>重启redis然后重新加载试试</li><li>停止服务器，拿出我们的备份修改后再重新启动服务器看看</li></ol></li></ol></li></ol><h5 id="正常恢复："><a href="#正常恢复：" class="headerlink" title="正常恢复："></a>正常恢复：</h5><p> 可以看到我们的rdb和aof都已经写入成功</p><p><img src="/hexo-docs/images/redisImages/image-20250413150409480.png" alt="image-20250413150409480"></p><p><img src="/hexo-docs/images/redisImages/image-20250413152812181.png" alt="image-20250413152812181"></p><p>当我们在添加一个数据，看看这个数据被记录到那个文件里面了！</p><p> 我们先复制一份</p><p> <img src="/hexo-docs/images/redisImages/image-20250413150618569.png" alt="image-20250413150618569"></p><p> 我们关闭redis服务器</p><p> <img src="/hexo-docs/images/redisImages/image-20250413150853690.png" alt="image-20250413150853690"></p><p> 删除<code>appendonlydir</code>，因为我们模拟恢复，因为进行<code>flushdb</code>清空，然后<code>shutdown</code>关闭服务器的时候也会写入<code>appendonlydir</code>，所以我们要删除<code>appendonlydir</code>，因为这是个空文件</p><p> <img src="/hexo-docs/images/redisImages/image-20250413151115020.png" alt="image-20250413151115020"></p><p> 修改<code>appendonlydir.bak</code>文件，改为<code>apppendonlydir</code></p><p> <img src="/hexo-docs/images/redisImages/image-20250413151219297.png" alt="image-20250413151219297"></p><p> 在启动redis服务器试试，看看有没有恢复</p><p> <img src="/hexo-docs/images/redisImages/image-20250413151341369.png" alt="image-20250413151341369"></p><p>异常恢复</p><ol><li>故意乱写正常的 AOF 文件</li><li>模拟网络闪断写 error</li><li>重启 redis 之后就会进行 AOF 文件的载入，发现启动都不行</li><li>异常修复命令：<code>redis-check-aof --fix</code>进行修复</li><li>重启 ok</li></ol><h5 id="异常修复"><a href="#异常修复" class="headerlink" title="异常修复"></a>异常修复</h5><p>从上述可以看出我们的写入的数据会保存在，<code>appendonly.aof.1.incr.aof</code>中，如果我们在<code>appendonly.aof.1.incr.aof</code>里面乱加入一些东西，看看可以恢复吗？</p><p><img src="/hexo-docs/images/redisImages/image-20250413161250807.png" alt="image-20250413161250807"></p><p><img src="/hexo-docs/images/redisImages/image-20250413161351896.png" alt="image-20250413161351896"></p><p>我们把数据清空，在shutdown，然后重启redis-server</p><p><img src="/hexo-docs/images/redisImages/image-20250413161744835.png" alt="image-20250413161744835"></p><p>我们使用<code>redis-check-aof --fix 文件名进行修复</code></p><p><img src="/hexo-docs/images/redisImages/image-20250413161939967.png" alt="image-20250413161939967"></p><p>我们启动redis-server看看， 有没有</p><p><img src="/hexo-docs/images/redisImages/image-20250413162918039.png" alt="image-20250413162918039"></p><p>可以看到我们的redis修复成功了！</p><h4 id="优势-1"><a href="#优势-1" class="headerlink" title="优势"></a>优势</h4><p><img src="/hexo-docs/images/redisImages/image-20250413164812270.png" alt="image-20250413164812270"></p><p>更好的保护数据不丢失、性能高、可做紧急恢复</p><h4 id="劣势-1"><a href="#劣势-1" class="headerlink" title="劣势"></a>劣势</h4><p><img src="/hexo-docs/images/redisImages/image-20250413164920992.png" alt="image-20250413164920992"></p><ol><li>相同数据集的数据而言aof文件要远大于rdb文件，恢复速度慢于rdb</li><li>aof运行效率要，慢于rdb，每秒同步策略效率较好，不同于效率和rdb相同</li></ol><h4 id="AOF重写机制"><a href="#AOF重写机制" class="headerlink" title="AOF重写机制"></a>AOF重写机制</h4><p>由于AOF持久化是Redis不断将写命令记录到 AOF 文件中，随着Redis不断的进行，AOF 的文件会越来越大，文件越大，占用服务器内存越大以及 AOF 恢复要求时间越长。</p><p>为了解决这个问题，Redis新增了重写机制，当AOF文件的大小超过所设定的峰值时，Redis就会<strong>自动</strong>启动AOF文件的内容压缩，只保留可以恢复数据的最小指令集或者可以手动使用命令 bgrewriteaof 来重新。</p><p>一句话：启动 AOF文件的内容压缩，只保留可以恢复数据的最小指令集</p><p><strong>举个例子：</strong>比如有个key </p><p>一开始你 set k1 v1</p><p>然后改成 set k1 v2</p><p>最后改成 set k1 v3</p><p>如果不重写，那么这3条语句都在aof文件中，内容占空间不说启动的时候都要执行一遍，共计3条命令；</p><p>但是，我们实际效果只需要set k1 v3这一条，所以，开启重写后，只需要保存set k1 v3就可以了只需要保留最后一次修改值，相当于给aof文件瘦身减肥，性能更好。AOF重写不仅降低了文件的占用空间，同时更小的AOF也可以更快地被Redis加载。</p><h5 id="触发机制"><a href="#触发机制" class="headerlink" title="触发机制"></a>触发机制</h5><p><img src="/hexo-docs/images/redisImages/image-20250413165313170.png" alt="image-20250413165313170"></p><blockquote><p>注意 ，同时满足，且的关系才会触发</p><ol><li>根据上次重写后的aof大小，判断当前aof大小是不是增长了1倍</li><li>重写时满足的文件大小</li></ol></blockquote><h6 id="自动触发-1"><a href="#自动触发-1" class="headerlink" title="自动触发"></a>自动触发</h6><p>满足配置文件中的选项后，redis会记录上次重写时的aof大小，默认配置是当aof文件大小是上次rewrite后大小的一倍且文件大于64m时</p><p>示例：</p><ol><li><p>修改最小重写大小，因为做实例，所以改的少一点</p><p><img src="/hexo-docs/images/redisImages/image-20250413172308803.png" alt="image-20250413172308803"></p></li><li><p>关闭 rdb和aof的混合模式</p><p><img src="/hexo-docs/images/redisImages/image-20250413172712408.png" alt="image-20250413172712408"></p></li><li><p>删除以前的aof和rdb，排除干扰项</p><p><img src="/hexo-docs/images/redisImages/image-20250413172848044.png" alt="image-20250413172848044"></p></li><li><p>数据压缩进行测试</p><p><img src="/hexo-docs/images/redisImages/image-20250413173333430.png" alt="image-20250413173333430"></p></li><li><p><code>appendonly.aof.3.base.rdb</code>文件，就是存放着我们最后一次对key写入的数据</p></li></ol><h6 id="手动触发-1"><a href="#手动触发-1" class="headerlink" title="手动触发"></a>手动触发</h6><p>客户端向服务器发送<code>bgrewriteao</code>命令</p><p>示例：</p><p><img src="/hexo-docs/images/redisImages/image-20250413173744340.png" alt="image-20250413173744340"></p><h6 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h6><p><img src="/hexo-docs/images/redisImages/image-20250413173835423.png" alt="image-20250413173835423"></p><h5 id="重写原理"><a href="#重写原理" class="headerlink" title="重写原理"></a>重写原理</h5><ol><li>在重写开始前，redis会创建一个“重写子进程”，这个子进程会读取现有的AOF文件，并将其包含的指令进行分析压缩并写入到一个临时文件中。</li><li>与此同时，主进程会将新接收到的写指令一边累积到内存缓冲区中，一边继续写入到原有的AOF文件中，这样做是保证原有的AOF文件的可用性，避免在重写过程中出现意外。</li><li>当“重写子进程”完成重写工作后，它会给父进程发一个信号，父进程收到信号后就会将内存中缓存的写指令追加到新AOF文件中</li><li>当追加结束后，redis就会用新AOF文件来代替旧AOF文件，之后再有新的写指令，就都会追加到新的AOF文件中</li><li>重写aof文件的操作，并没有读取旧的aof文件，而是将整个内存中的数据库内容用命令的方式重写了一个新的aof文件，这点和快照有点类似</li></ol><h5 id="AOF-优化配置项"><a href="#AOF-优化配置项" class="headerlink" title="AOF 优化配置项"></a>AOF 优化配置项</h5><p>配置文件 append only mode 模块</p><p><img src="/hexo-docs/images/redisImages/image-20250413173933121.png" alt="image-20250413173933121"></p><h5 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h5><p><img src="/hexo-docs/images/redisImages/image-20250413173954069.png" alt="image-20250413173954069"></p><h3 id="RDB-AOF-混合持久化"><a href="#RDB-AOF-混合持久化" class="headerlink" title="RDB-AOF 混合持久化"></a>RDB-AOF 混合持久化</h3><p>RDB和AOF可以同时共存，但是AOF的优先级高于RDB的优先级</p><p><img src="/hexo-docs/images/redisImages/image-20250413175315000.png" alt="image-20250413175315000"></p><p><strong>如何选？</strong></p><p>RDB持久化方式能够在指定的时间间隔能对你的数据进行快照存储</p><p>AOF持久化方式记录每次对服务器写的操作，当服务器重启的时候会重新执行这些命令来恢复原始的数据，AOF命令以redis协议追加保存每次写的操作到文件末尾</p><p><strong>同时开启两种持久化方式</strong></p><p>在这种情况下，当redis重启的时候会优先载入 AOF 文件来恢复原始的数据，因为在通常情况下 AOF 文件保存的数据集要比 RDB 文件保存的数据集要完整</p><p>RDB的数据不实时，同时使用两者服务器重启也只会找 AOF 文件。那要不要只是用 AOF 呢？ 官网建议不要，因为 RDB 更适合用于备份数据（AOF在不断变化不好备份），留着 rdb 作为一个以防万一的手段。</p><p><strong>推荐方式</strong>：</p><p>结合了RDB和AOF的优点，既能快速加载又能避免丢失过多的数据。</p><ol><li><p>开启混合方式设置</p><p>设置aof-use-rdb-preamble的值为 yes  yes表示开启，设置为no表示禁用</p></li><li><p>RDB+AOF的混合方式———&gt; 结论：RDB镜像做全量持久化，AOF做增量持久化</p><p>先使用RDB进行快照存储，然后使用AOF持久化记录所有的写操作，当重写策略满足或手动触发重写的时候，将最新的数据存储为新的RDB记录。这样的话，重启服务的时候会从RDB和AOF两部分恢复数据，既保证了数据完整性，又提高了恢复数据的性能。简单来说：混合持久化方式产生的文件一部分是RDB格式，一部分是AOF格式。**—-》AOF包括了RDB头部+AOF混写**</p><p><img src="/hexo-docs/images/redisImages/image-20250413175941896.png" alt="image-20250413175941896"></p><h4 id="纯缓存模式"><a href="#纯缓存模式" class="headerlink" title="纯缓存模式"></a>纯缓存模式</h4><p>同时关闭 RDB+AOF</p><ol><li>save “”<ol><li>禁用 rdb</li><li>禁用 rdb 持久化模式下，我们仍然可以使用命令 save、bgsave 生成 rdb 文件</li></ol></li><li>appendonly no<ol><li>禁用 aof</li><li>禁用 aof 持久化模式下，我们仍然可以使用命令 bgrewriteaof 生成 aof文件</li></ol></li></ol></li></ol>]]></content>
      
      
      <categories>
          
          <category> 后端 Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LangChain4j</title>
      <link href="/hexo-docs/2025/08/13/LangChain4j/LangChain4j/"/>
      <url>/hexo-docs/2025/08/13/LangChain4j/LangChain4j/</url>
      
        <content type="html"><![CDATA[<h1 id="LangChain4j"><a href="#LangChain4j" class="headerlink" title="LangChain4j"></a>LangChain4j</h1><h2 id="理论概述"><a href="#理论概述" class="headerlink" title="理论概述"></a>理论概述</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>LangChain4j 等价于 LangChain For Java</p><p>LangChain4j 的目标是简化将 LLM 集成到 Java 应用程序中的过程。</p><p>具体方式如下：</p><ol><li><strong>统一 API：</strong> LLM 提供商（如 OpenAI 或 Google Vertex AI）和嵌入（向量）存储（如 Pinecone 或 Milvus） 使用专有 API。LangChain4j 提供统一的 API，避免了学习和实现每个特定 API 的需求。 要尝试不同的 LLM 或嵌入存储，您可以在它们之间轻松切换，无需重写代码。 LangChain4j 目前支持 <a href="https://docs.langchain4j.info/integrations/language-models/">15+ 个流行的 LLM 提供商</a> 和 <a href="https://docs.langchain4j.info/integrations/embedding-stores/">20+ 个嵌入存储</a>。</li><li><strong>全面的工具箱：</strong> 自 2023 年初以来，社区一直在构建众多 LLM 驱动的应用程序， 识别常见的抽象、模式和技术。LangChain4j 将这些提炼成一个即用型包。 我们的工具箱包含从低级提示模板、聊天记忆管理和函数调用 到高级模式如代理和 RAG 的工具。 对于每个抽象，我们提供一个接口以及基于常见技术的多个即用型实现。 无论您是在构建聊天机器人还是开发包含从数据摄取到检索完整管道的 RAG， LangChain4j 都提供多种选择。</li><li><strong>丰富的示例：</strong> 这些<a href="https://github.com/langchain4j/langchain4j-examples">示例</a>展示了如何开始创建各种 LLM 驱动的应用程序， 提供灵感并使您能够快速开始构建。</li></ol><p>LangChain4j 始于 2023 年初 ChatGPT 热潮期间。 我们注意到与众多 Python 和 JavaScript LLM 库和框架相比，缺少 Java 对应物， 我们必须解决这个问题！ 虽然我们的名字中有”LangChain”，但该项目是 LangChain、Haystack、 LlamaIndex 和更广泛社区的想法和概念的融合，并加入了我们自己的创新。</p><p>我们积极关注社区发展，旨在快速整合新技术和集成， 确保您保持最新状态。 该库正在积极开发中。虽然一些功能仍在开发中， 但核心功能已经就位，让您现在就可以开始构建 LLM 驱动的应用程序！</p><p>为了更容易集成，LangChain4j 还包括与 <a href="https://docs.langchain4j.info/tutorials/quarkus-integration">Quarkus</a> 和 <a href="https://docs.langchain4j.info/tutorials/spring-boot-integration">Spring Boot</a> 的集成。</p><p>AB法则（Before | After）</p><p>随着人工智能（AI）技术的迅猛发展，越来越多的开发者开始将目光投向AI应用的开发。然而，目前市场上大多数AI框架和工具如LangChain、PyTorch等主要支持Python，而Java开发者常常面临工具缺乏和学习门槛较高的问题，但是不用担心，谁让Java&#x2F;Spring群体强大那？，O(∩_∩)O</p><p>任何一个框架&#x2F;XXX云服务器，想要大面积推广，应该不会忘记庞大的Spring社区和Java程序员</p><p>Before（没有 LangChain4j 之前）</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250724185120589.png" alt="image-20250724185120589"></p><p>各干各的</p><p>After（有 LangChain4j 之后）</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250724185201404.png" alt="image-20250724185201404"></p><p>官网</p><ul><li>中文：<a href="https://docs.langchain4j.info/">https://docs.langchain4j.info/</a></li><li>英文：<a href="https://docs.langchain4j.dev/">https://docs.langchain4j.dev/</a></li></ul><h3 id="能干嘛"><a href="#能干嘛" class="headerlink" title="能干嘛"></a>能干嘛</h3><p>LLM 大模型能干嘛</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250724185519361.png" alt="image-20250724185519361"></p><ul><li>controller</li><li>service</li><li>dao&#x2F;mapper</li></ul><p>LLM 大模型应用技术架构</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250724185558979.png" alt="image-20250724185558979"></p><h3 id="去哪下"><a href="#去哪下" class="headerlink" title="去哪下"></a>去哪下</h3><ul><li>英文：<a href="https://docs.langchain4j.dev/get-started">https://docs.langchain4j.dev/get-started</a></li><li>中文：<a href="https://docs.langchain4j.info/get-started">https://docs.langchain4j.info/get-started</a></li></ul><h3 id="怎么玩"><a href="#怎么玩" class="headerlink" title="怎么玩"></a>怎么玩</h3><p>大模型开发分类</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250725183517344.png" alt="image-20250725183517344"></p><p>产品定位</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250725183538316.png" alt="image-20250725183538316"></p><h2 id="永远的HelloWorld"><a href="#永远的HelloWorld" class="headerlink" title="永远的HelloWorld"></a>永远的HelloWorld</h2><h3 id="前置约定"><a href="#前置约定" class="headerlink" title="前置约定"></a>前置约定</h3><p>LangChain4j支持的各种大模型语言模型（LLMS）</p><ul><li>中文：<a href="https://docs.langchain4j.info/integrations/language-models">https://docs.langchain4j.info/integrations/language-models</a></li><li>英文：<a href="https://docs.langchain4j.dev/integrations/language-models">https://docs.langchain4j.dev/integrations/language-models</a></li></ul><p>本次以阿里百炼平台（通义千问）为主并辅以DeepSeek模型</p><p>配置门道和关键点</p><ul><li>所有调用均基于 OpenAI 协议或者 SpringBoot 官方推荐整合规则，实现一致的接口设计与规范，确保了多模型切换的便利性，提供高度可拓展的开发支持</li></ul><h3 id="阿里云百炼平台入口"><a href="#阿里云百炼平台入口" class="headerlink" title="阿里云百炼平台入口"></a>阿里云百炼平台入口</h3><p>接入阿里百炼平台的通义模型：<a href="https://bailian.console.aliyun.com/">https://bailian.console.aliyun.com</a></p><p>大模型调用三件套</p><ol><li><p>获得 api-key</p><p>先登录并创建API-key</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250726174346286.png" alt="image-20250726174346286"></p><p>选择想要的模型，点击查看详情</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250726174411279.png" alt="image-20250726174411279"></p></li><li><p>获得模型名</p><p>点击模型广场，点击想要的模型，点击查看详情</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250726174411279.png" alt="image-20250726174411279"></p><p>选择你想要的模型复制下来</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250726174543338.png" alt="image-20250726174543338"></p><p>例如：模型名：<code>qwen-plus</code></p></li><li><p>获得 baseUrl 开发地址</p><p>点击查看api参考</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250726174810710.png" alt="image-20250726174810710"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250726174840160.png" alt="image-20250726174840160"></p></li></ol><p>假设你要换一个模型实例</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250726175149199.png" alt="image-20250726175149199"></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul><li><p>API Key</p><p>sk-xxx 你自己的 API Key</p></li><li><p>模型名</p><p>qwen-plus</p></li><li><p>调用地址</p><p>使用 SDK 调用时需配置的 base_url：<a href="https://dashscope.aliyuncs.com/compatible-mode/v1">https://dashscope.aliyuncs.com/compatible-mode/v1</a></p></li></ul><h3 id="IDEA-工具中建-project-父工程"><a href="#IDEA-工具中建-project-父工程" class="headerlink" title="IDEA 工具中建 project 父工程"></a>IDEA 工具中建 project 父工程</h3><p>LangChain4j</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250726175820182.png" alt="image-20250726175820182"></p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lazy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>LangChain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>LangChain4j父工程<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>17<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>3.5.0<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring AI --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-ai.version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">spring-ai.version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring AI Alibaba --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-ai-alibaba.version</span>&gt;</span>1.0.0-M6.1<span class="tag">&lt;/<span class="name">spring-ai-alibaba.version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- langchain4j --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">langchain4j.version</span>&gt;</span>1.0.1<span class="tag">&lt;/<span class="name">langchain4j.version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--langchain4j-community 引入阿里云百炼平台依赖管理清单--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">langchain4j-community.version</span>&gt;</span>1.0.1-beta6<span class="tag">&lt;/<span class="name">langchain4j-community.version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- maven plugin --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven-deploy-plugin.version</span>&gt;</span>3.1.1<span class="tag">&lt;/<span class="name">maven-deploy-plugin.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">flatten-maven-plugin.version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">flatten-maven-plugin.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven-compiler-plugin.version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">maven-compiler-plugin.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- Spring Boot --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- Spring AI --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-ai.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- Spring AI Alibaba --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-ai-alibaba.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--langchain4j的依赖清单，加载BOM后所有langchain4j版本号可以被统一管理起来</span></span><br><span class="line"><span class="comment">      https://docs.langchain4j.dev/get-started</span></span><br><span class="line"><span class="comment">      --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;langchain4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--引入阿里云百炼平台依赖管理清单</span></span><br><span class="line"><span class="comment">     https://docs.langchain4j.dev/integrations/language-models/dashscope</span></span><br><span class="line"><span class="comment">     --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-community-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;langchain4j-community.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-deploy-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;maven-deploy-plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skip</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;maven-compiler-plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">release</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">release</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">compilerArg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">compilerArg</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.mojo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flatten-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flatten-maven-plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">inherited</span>&gt;</span>true<span class="tag">&lt;/<span class="name">inherited</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>flatten<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>process-resources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>flatten<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">updatePomFile</span>&gt;</span>true<span class="tag">&lt;/<span class="name">updatePomFile</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">flattenMode</span>&gt;</span>ossrh<span class="tag">&lt;/<span class="name">flattenMode</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">pomElements</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span>remove<span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span>remove<span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">repositories</span>&gt;</span>remove<span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scm</span>&gt;</span>keep<span class="tag">&lt;/<span class="name">scm</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">url</span>&gt;</span>keep<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">organization</span>&gt;</span>resolve<span class="tag">&lt;/<span class="name">organization</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">pomElements</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>flatten.clean<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>clean<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>clean<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>aliyunmaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>public<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun nexus<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/LangChain4jImages/image-20250726181619866.png" alt="image-20250726181619866"></p><p><code>创建一个子maven项目</code>：<code>LangChain4j-helloWorld</code></p><p>改<code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lazy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>LangChain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>LangChain4j入门案例之HelloWorld<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>LangChain4j-helloWorld<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--langchain4j-open-ai 基础--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--所有调用均基于 OpenAI 协议标准，实现一致的接口设计与规范LangChain4j 提供与许多 LLM 提供商的集成</span></span><br><span class="line"><span class="comment">        从最简单的开始方式是从 OpenAI 集成开始https://docs.langchain4j.dev/get-started    --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--langchain4j 高阶--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--test--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/LangChain4jImages/image-20250726180458415.png" alt="image-20250726180458415"></p><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LangChain4j-helloWorld</span></span><br></pre></td></tr></table></figure><p>业务类</p><ul><li><p>ApiKey不建议明文，需配置进环境变量</p><ul><li><p>修改环境变量</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250726181133054.png" alt="image-20250726181133054"></p></li></ul></li><li><p>以防不生效，建议重启IDEA</p></li><li><p>如果遇到这种情况，重启电脑试试</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250726182712048.png" alt="image-20250726182712048"></p></li></ul><p>LLMConfig</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModelQWen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))<span class="comment">//从系统环境变量获得key</span></span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)<span class="comment">//模型名称</span></span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)<span class="comment">//模型接口地址</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/LangChain4jImages/image-20250726181642117.png" alt="image-20250726181642117"></p><p>HelloLangChainController</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloLangChainController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModelQWen;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/langchain4j/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(<span class="meta">@RequestParam(value = &quot;question&quot;,defaultValue = &quot;你是谁？&quot;)</span> String question)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> chatModelQWen.chat(question);</span><br><span class="line">        System.out.println(<span class="string">&quot;通过LangChain4j调用QWen返回结果：&quot;</span>+result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p><img src="/hexo-docs/images/LangChain4jImages/image-20250726183121805.png" alt="image-20250726183121805"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250726183235487.png" alt="image-20250726183235487"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250726183301694.png" alt="image-20250726183301694"></p><h3 id="如何同时存在多种大模型在系统里共存使用？"><a href="#如何同时存在多种大模型在系统里共存使用？" class="headerlink" title="如何同时存在多种大模型在系统里共存使用？"></a>如何同时存在多种大模型在系统里共存使用？</h3><h4 id="DeepSeek-API-文档"><a href="#DeepSeek-API-文档" class="headerlink" title="DeepSeek API 文档"></a>DeepSeek API 文档</h4><p><a href="https://platform.deepseek.com/usage">https://platform.deepseek.com/usage</a></p><p>API 文档：<a href="https://api-docs.deepseek.com/zh-cn/">https://api-docs.deepseek.com/zh-cn/</a></p><p>如果没有申请 API-key 先申请 api-key</p><ul><li><p>申请地址</p><p><a href="https://platform.deepseek.com/usage">https://platform.deepseek.com/usage</a></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250727170513864.png" alt="image-20250727170513864"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250727170536223.png" alt="image-20250727170536223"></p><p>如果申请成功了，跟上述那个一样把api-key配置到环境变量里面</p></li></ul><p>大模型调用三件套</p><ul><li><p>获得 Api-key</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250727170829705.png" alt="image-20250727170829705"></p></li><li><p>获得模型名</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250727170919576.png" alt="image-20250727170919576"></p></li><li><p>获得 baseUrl 开发地址</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250727170957194.png" alt="image-20250727170957194"></p></li></ul><blockquote><p>备注：</p><p>​通过指定 <code>model=&#39;deepseek-chat&#39;</code>  即可调用 DeepSeek-V3 （普通）</p><p>​通过指定 <code>model=&#39;deepseek-reasoner&#39;</code>即可调用 DeepSeek-R1（深度）。</p></blockquote><h4 id="多模型共存使用"><a href="#多模型共存使用" class="headerlink" title="多模型共存使用"></a>多模型共存使用</h4><p>新建<code>module</code></p><p><code>LangChain4j-02multi-model-together</code></p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--langchain4j-open-ai 基础--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--所有调用均基于 OpenAI 协议标准，实现一致的接口设计与规范LangChain4j 提供与许多 LLM 提供商的集成</span></span><br><span class="line"><span class="comment">    从最简单的开始方式是从 OpenAI 集成开始https://docs.langchain4j.dev/get-started    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--langchain4j 高阶--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--test--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9002</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LangChain4j-02multi-model-together</span></span><br></pre></td></tr></table></figure><p>业务类</p><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;QWen&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModelQWen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))<span class="comment">//从系统环境变量获得key</span></span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)<span class="comment">//模型名称</span></span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)<span class="comment">//模型接口地址</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;DeepSeek&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModelDeepSeek</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;deepseek-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;deepseek-chat&quot;</span>)</span><br><span class="line">                <span class="comment">//.modelName(&quot;deepseek-reasoner&quot;) //深度思考</span></span><br><span class="line">                .baseUrl(<span class="string">&quot;https://api.deepseek.com/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/LangChain4jImages/image-20250727172227837.png" alt="image-20250727172227837"></p><p><code>MultiModelController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiModelController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;QWen&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModelQWen;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;DeepSeek&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModelDeepSeek;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/multimodel/qwen&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">QWen</span><span class="params">(<span class="meta">@RequestParam(name = &quot;prompt&quot;,defaultValue = &quot;你是谁&quot;)</span> String prompt)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">chatQWen</span> <span class="operator">=</span> chatModelQWen.chat(prompt);</span><br><span class="line">        System.out.println(<span class="string">&quot;模型返回结果：\t&quot;</span>+chatQWen);</span><br><span class="line">        <span class="keyword">return</span> chatQWen;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/multimodel/deepseek&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">DeepSeek</span><span class="params">(<span class="meta">@RequestParam(name = &quot;prompt&quot;,defaultValue = &quot;你是谁&quot;)</span> String prompt)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">chatDeepSeek</span> <span class="operator">=</span> chatModelDeepSeek.chat(prompt);</span><br><span class="line">        System.out.println(<span class="string">&quot;模型返回结果：\t&quot;</span>+chatDeepSeek);</span><br><span class="line">        <span class="keyword">return</span> chatDeepSeek;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动项目，测试！</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250727172904730.png" alt="image-20250727172904730"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250727172945597.png" alt="image-20250727172945597"></p><p>访问deepseek报错了，重启试试</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250727173310184.png" alt="image-20250727173310184"></p><p>我们充点钱再试试！</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250727174049537.png" alt="image-20250727174049537"></p><h2 id="原生整合和SpringBoot整合"><a href="#原生整合和SpringBoot整合" class="headerlink" title="原生整合和SpringBoot整合"></a>原生整合和SpringBoot整合</h2><p>官网</p><ul><li>中文：<code>https://docs.langchain4j.info/tutorials/spring-boot-integration</code></li><li>英文：<code>https://docs.langchain4j.dev/tutorials/spring-boot-integration</code></li></ul><p><img src="/hexo-docs/images/LangChain4jImages/image-20250727175750576.png" alt="image-20250727175750576"></p><ul><li><p>低阶 api VS 高阶 api</p><ul><li><p>SpringBoot 整合低阶 api 所需要的 <code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-beta3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/LangChain4jImages/image-20250727175946749.png" alt="image-20250727175946749"></p></li><li><p>SpringBoot 整合高阶 api 所需要的 <code>pom</code></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250727180214932.png" alt="image-20250727180214932"></p></li><li><p>总结<br><img src="/hexo-docs/images/LangChain4jImages/image-20250727180250524.png" alt="image-20250727180250524"></p></li></ul></li></ul><h3 id="LangChain4j-原生-VS-LangChain4j-Boot整合"><a href="#LangChain4j-原生-VS-LangChain4j-Boot整合" class="headerlink" title="LangChain4j 原生 VS LangChain4j-Boot整合"></a>LangChain4j 原生 VS LangChain4j-Boot整合</h3><ul><li><p>LangChain4j 原生整合</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250727180515893.png" alt="image-20250727180515893"></p><p>LangChain4j-Boot整合</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250727180543192.png" alt="image-20250727180543192"></p><p>总结</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250727180250524.png" alt="image-20250727180250524"></p><p>LangChain4j 原生集成与使用 <strong>LangChain4j-Boot</strong>（Spring Boot Starter）进行整合的主要区别在于 <strong>易用性、配置管理、自动装配和与 Spring 生态的集成深度</strong>。以下是详细对比：</p><ol><li><strong>依赖管理</strong></li></ol><ul><li><p><strong>原生 LangChain4j</strong>：</p><ul><li><p>需手动添加核心库及模型提供者（如 OpenAI、HuggingFace）的依赖。</p></li><li><p>示例 Maven 依赖：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.31.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.31.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>LangChain4j-Boot</strong>：</p><ul><li><p>通过单一 Starter 依赖自动引入核心库和常用模块。</p></li><li><p>示例：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.microutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-boot-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span> <span class="comment">&lt;!-- 版本可能变化 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><ol start="2"><li><strong>配置方式</strong></li></ol><ul><li><p><strong>原生 LangChain4j</strong>：</p><ul><li><p>手动编码创建组件（如 <code>OpenAiChatModel</code>），需硬编码 API Key 或自行管理配置。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">OpenAiChatModel</span> <span class="variable">model</span> <span class="operator">=</span> OpenAiChatModel.builder()</span><br><span class="line">    .apiKey(<span class="string">&quot;sk-...&quot;</span>)</span><br><span class="line">    .modelName(<span class="string">&quot;gpt-4&quot;</span>)</span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>LangChain4j-Boot</strong>：</p><ul><li><p>通过 <code>application.yml</code>&#x2F;<code>application.properties</code> <strong>集中配置</strong>，支持多模型切换。</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">langchain4j:</span></span><br><span class="line">  <span class="attr">openai:</span></span><br><span class="line">    <span class="attr">api-key:</span> <span class="string">$&#123;OPENAI_API_KEY&#125;</span></span><br><span class="line">    <span class="attr">model:</span> <span class="string">gpt-4-turbo</span></span><br><span class="line">  <span class="attr">huggingface:</span></span><br><span class="line">    <span class="attr">api-key:</span> <span class="string">$&#123;HF_API_KEY&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>自动注入 Bean，无需手动构建：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ChatModel chatModel; <span class="comment">// 根据配置自动选择 OpenAI/HuggingFace</span></span><br></pre></td></tr></table></figure></li></ul></li></ul></li></ul><ol start="3"><li><strong>自动装配与扩展</strong></li></ol><ul><li><p><strong>原生 LangChain4j</strong>：</p><ul><li>需自行管理组件生命周期（如注入 <code>ChatMemory</code>、<code>Tool</code>）。<ul><li>需手动集成 Spring（如通过 <code>@Bean</code> 工厂方法）。</li></ul></li></ul></li><li><p><strong>LangChain4j-Boot</strong>：</p><ul><li><p><strong>自动装配</strong>：根据配置创建 <code>ChatModel</code>、<code>EmbeddingModel</code> 等 Bean。</p></li><li><p><strong>工具集成</strong>：自动扫描 <code>@Tool</code> 注解的 Bean 并注入 <code>AiServices</code>。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Tool(&quot;查询用户信息&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUserEmail</span><span class="params">(String username)</span> &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>对话内存</strong>：自动配置 <code>ChatMemory</code>（如 <code>InMemoryChatMemory</code>）并关联会话。</li></ul></li></ul></li></ul><ol start="4"><li><strong>Spring 生态集成</strong></li></ol><ul><li><p><strong>原生 LangChain4j</strong>：</p><ul><li>与 Spring 无深度整合，需自行实现：<ul><li>配置绑定（如 <code>@ConfigurationProperties</code>）。</li><li>异常处理、健康检查。</li></ul></li></ul></li><li><p><strong>LangChain4j-Boot</strong>：</p><ul><li><p><strong>配置绑定</strong>：通过 <code>@ConfigurationProperties</code> 映射配置项。</p></li><li><p><strong>健康检查</strong>：提供 <code>/health</code> 端点验证模型连接状态。</p></li><li><p><strong>AOP 支持</strong>：通过注解管理对话上下文（如 <code>@MemoryId</code> 标识用户会话）：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span> <span class="keyword">private</span> Assistant assistant;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat</span><span class="params">(String userId, String message)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> assistant.chat(userId, message); <span class="comment">// 自动关联 userId 的对话历史</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul><ol start="5"><li><strong>生产就绪特性</strong></li></ol><ul><li><strong>LangChain4j-Boot</strong> 额外提供：<ul><li><strong>监控指标</strong>：集成 Micrometer 统计 Token 使用量、延迟等。</li><li><strong>异常处理</strong>：统一处理模型调用异常（如 <code>ModelNotFoundException</code>）。</li><li><strong>多模型切换</strong>：通过配置动态切换模型（如测试用 OpenAI，生产用 Azure OpenAI）。</li></ul></li></ul><ol start="6"><li><strong>代码简洁性对比</strong></li></ol><ul><li><p><strong>原生实现示例</strong>（手动管理依赖和配置）：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> ChatModel <span class="title function_">openAiChatModel</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">            .apiKey(env.getProperty(<span class="string">&quot;openai.api-key&quot;</span>))</span><br><span class="line">            .modelName(<span class="string">&quot;gpt-4&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>LangChain4j-Boot 实现</strong>（零配置）：</li></ul><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAssistant</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span> <span class="keyword">private</span> ChatModel chatModel; <span class="comment">// 自动注入</span></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">answer</span><span class="params">(String question)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> chatModel.generate(question);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>总结：如何选择？</p><table><thead><tr><th align="left"><strong>场景</strong></th><th align="left"><strong>推荐方式</strong></th></tr></thead><tbody><tr><td align="left">快速原型验证、小型项目</td><td align="left">原生 LangChain4j</td></tr><tr><td align="left">Spring Boot 项目，需生产部署</td><td align="left">LangChain4j-Boot</td></tr><tr><td align="left">需要动态配置&#x2F;多模型支持</td><td align="left">LangChain4j-Boot</td></tr><tr><td align="left">深度集成 Spring 生态（AOP、监控）</td><td align="left">LangChain4j-Boot</td></tr></tbody></table><blockquote><p><strong>LangChain4j-Boot 的本质</strong>：通过 Spring Boot Starter 机制封装原生 LangChain4j，提供<strong>自动配置、依赖管理、生态集成</strong>，显著提升开发效率，降低样板代码量。</p></blockquote><h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>建<code>module</code>：<code>LangChain4j-03boot-integration</code></p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--langchain4j原生 基础--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--langchain4j原生 高阶--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--1 LangChain4j 整合boot底层支持--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--   https://docs.langchain4j.dev/tutorials/spring-boot-integration  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--2 LangChain4j 整合boot高阶支持--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--test--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>低阶api</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PopularIntegrationController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModelQWen;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/langchain4j/chat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chatQWen</span><span class="params">(<span class="meta">@RequestParam(value = &quot;prompt&quot;,defaultValue = &quot;你是谁&quot;)</span> String prompt)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> chatModelQWen.chat(prompt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250728175234465.png" alt="image-20250728175234465"></p><p>高阶api</p><p><code>ChatAssistantService</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.spring.AiService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@AiService</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChatAssistantService</span> &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">chat</span><span class="params">(String prompt)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>DeclarativeAIController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.ChatAssistantService;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeclarativeAIController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatAssistantService chatAssistantService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/declarative/chat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">declarativeChat</span><span class="params">(<span class="meta">@RequestParam(value = &quot;prompt&quot;,defaultValue = &quot;你是谁&quot;)</span> String prompt)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> chatAssistantService.chat(prompt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250728175842671.png" alt="image-20250728175842671"></p><p>高阶api集成官网解释</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250728175932197.png" alt="image-20250728175932197"></p><h2 id="低阶和高阶API"><a href="#低阶和高阶API" class="headerlink" title="低阶和高阶API"></a>低阶和高阶API</h2><h3 id="LangChain4j在两个抽象层提供不同的api"><a href="#LangChain4j在两个抽象层提供不同的api" class="headerlink" title="LangChain4j在两个抽象层提供不同的api"></a>LangChain4j在两个抽象层提供不同的api</h3><p><img src="/hexo-docs/images/LangChain4jImages/image-20250728181931183.png" alt="image-20250728181931183"></p><h4 id="低阶api"><a href="#低阶api" class="headerlink" title="低阶api"></a>低阶api</h4><p>如 <a href="https://docs.langchain4j.info/tutorials/chat-and-language-models">ChatLanguageModel</a>、<code>UserMessage</code>、<code>AiMessage</code>、<code>EmbeddingStore</code>、<code>Embedding</code> 等</p><p>优点：是可以自由组合适宜于各个组件但编码量高</p><ul><li><p>ChatModel</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250728182226123.png" alt="image-20250728182226123"></p><ul><li><p>low-level（低阶api）模型api，提供各种chat方法用于对话，可以接受单个或多个消息</p></li><li><p>ChatModel 提供的一种极其简便的方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">default</span> String <span class="title function_">chat</span><span class="params">(String userMessage)</span> &#123;</span><br><span class="line">    <span class="type">ChatRequest</span> <span class="variable">chatRequest</span> <span class="operator">=</span> ChatRequest.builder()</span><br><span class="line">            .messages(UserMessage.from(userMessage))</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    <span class="type">ChatResponse</span> <span class="variable">chatResponse</span> <span class="operator">=</span> chat(chatRequest);</span><br><span class="line">    <span class="keyword">return</span> chatResponse.aiMessage().text();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/langchain4j/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(<span class="meta">@RequestParam(value = &quot;prompt&quot;, defaultValue = &quot;你是谁&quot;)</span> String prompt)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> chatModel.chat(prompt);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;通过langchain4j调用模型返回结果：\n&quot;</span>+result);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h4 id="高阶api"><a href="#高阶api" class="headerlink" title="高阶api"></a>高阶api</h4><p><img src="/hexo-docs/images/LangChain4jImages/image-20250728182606770.png" alt="image-20250728182606770"></p><ul><li>AiServices、Tools等</li><li>程序员自己定义接口，通过AiServices 类里面的方法实现，优点是api封装度比较高，减少了代码的复杂性，但仍可以进行灵活的微调</li></ul><p><img src="/hexo-docs/images/LangChain4jImages/image-20250728182945998.png" alt="image-20250728182945998"></p><p>创建由提供的聊天模型支持的 AI 服务（所提供接口的实现）。这种方便的方法可用于创建简单的 AI 服务。对于更复杂的情况，请使用 builder。</p><p>LangChian4j提供大模型接口、提示词模板、结构化输出、对话记忆、文档加载、文档分割、向量模型、向量存储等组件</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250728183545824.png" alt="image-20250728183545824"></p><h3 id="代码案例"><a href="#代码案例" class="headerlink" title="代码案例"></a>代码案例</h3><h4 id="低阶api（token使用情况）"><a href="#低阶api（token使用情况）" class="headerlink" title="低阶api（token使用情况）"></a>低阶api（token使用情况）</h4><p>大模型中的 Token VS Web开发中的Token</p><ul><li><p>大模型中的token</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250729175655254.png" alt="image-20250729175655254"></p></li><li><p>Web开发中的token</p><p>在web开发中，“token”通常指的是用于认证和授权的一种加密字符串。它被用来确保用户身份的安全验证，比如JWT（JSON Web Token）。这类token一般由服务器生成，并发给客户端保存（例如存储在浏览器的本地存储或cookie中），之后每次请求都需要携带这个token来证明用户的身份。</p></li><li><p>区别</p><ul><li>目的不同：大模型中的token是为了将文本分割成可处理的单元，便于进行计算；而web开发中的token主要用于安全地传递用户身份信息</li><li>生成方式不同：前者通过特定的算法（如BPE）对文本进行分割得到；后者则通常是通过加密算法生成的唯一字符串。</li><li>应用场景不同：前者应用于文本分析、机器翻译等NLP任务；后者多见于用户登录系统、API访问控制等领域。</li></ul></li></ul><p>新建<code>module</code>：<code>LangChain4j-04low-high-api</code></p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;QWen&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModelQWen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))<span class="comment">//从系统环境变量获得key</span></span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)<span class="comment">//模型名称</span></span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)<span class="comment">//模型接口地址</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;DeepSeek&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModelDeepSeek</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;deepseek-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;deepseek-chat&quot;</span>)</span><br><span class="line">                <span class="comment">//.modelName(&quot;deepseek-reasoner&quot;) //深度思考</span></span><br><span class="line">                .baseUrl(<span class="string">&quot;https://api.deepseek.com/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LowApiController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.message.UserMessage;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.response.ChatResponse;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.output.TokenUsage;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LowApiController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;DeepSeek&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModelQWen;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/lowapi/api&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">api</span><span class="params">(<span class="meta">@RequestParam(name = &quot;prompt&quot;, defaultValue = &quot;你是谁&quot;)</span> String prompt)</span> &#123;</span><br><span class="line">        <span class="type">ChatResponse</span> <span class="variable">chatResponse</span> <span class="operator">=</span> chatModelQWen.chat(UserMessage.userMessage(prompt));<span class="comment">//使用带返回结果的api</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> chatResponse.aiMessage().text();</span><br><span class="line">        System.out.println(<span class="string">&quot;大模型调用返回结果：&quot;</span> + text);</span><br><span class="line">        <span class="type">TokenUsage</span> <span class="variable">token</span> <span class="operator">=</span> chatResponse.tokenUsage();</span><br><span class="line">        System.out.println(<span class="string">&quot;本次调用结果消耗的token：&quot;</span> + token);</span><br><span class="line">        <span class="keyword">return</span> text + <span class="string">&quot;\t\n&quot;</span> + token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250729180254807.png" alt="image-20250729180254807"></p><h4 id="高阶api-1"><a href="#高阶api-1" class="headerlink" title="高阶api"></a>高阶api</h4><p><img src="/hexo-docs/images/LangChain4jImages/image-20250729182807600.png" alt="image-20250729182807600"></p><h5 id="AI-Service-是如何工作的？"><a href="#AI-Service-是如何工作的？" class="headerlink" title="AI Service 是如何工作的？"></a>AI Service 是如何工作的？</h5><p><img src="/hexo-docs/images/LangChain4jImages/image-20250729182854035.png" alt="image-20250729182854035"></p><p>配置</p><ol><li><p>定义 AI Service 接口</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChatAssistant</span> &#123;</span><br><span class="line">    String <span class="title function_">chat</span><span class="params">(String prompt)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>LLMConfig 类配置调用三件套</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModelQwen</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                        .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                        .modelName(<span class="string">&quot;qwen-plus&quot;</span>)</span><br><span class="line">                        .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>AI Service 对应接口实现类落地</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.study.service.ChatAssistant;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.AiServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2025-05-27 22:04</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 知识出处 https://docs.langchain4j.dev/get-started</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Bean(name = &quot;qwen&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModelQwen</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                    .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                    .modelName(<span class="string">&quot;qwen-plus&quot;</span>)</span><br><span class="line">                    .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChatAssistant</span>&#123;</span><br><span class="line">    String <span class="title function_">chat</span><span class="params">(String prompt)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatAssistant <span class="title function_">chatAssistant</span><span class="params">(<span class="meta">@Qualifier(&quot;qwen&quot;)</span> ChatModel chatModelQwen)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> AiServices.create(ChatAssistant.class, chatModelQwen);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p><code>HighApiController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.ChatAssistant;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HighApiController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatAssistant chatAssistant;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/high/highapi&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">highApi</span><span class="params">(<span class="meta">@RequestParam(value = &quot;prompt&quot;,defaultValue = &quot;你是谁&quot;)</span> String prompt)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> chatAssistant.chat(prompt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250729183709764.png" alt="image-20250729183709764"></p><blockquote><p>注意：</p><p>​<code>@AiService</code> 注解是与SpringBoot整合的包才能使用，当前我们没有引用于SpringBoot整合的包，使用的是langchain4j原生的包，所以不能使用<code>@AiService</code>注解</p></blockquote><h2 id="模型参数配置"><a href="#模型参数配置" class="headerlink" title="模型参数配置"></a>模型参数配置</h2><p>官网：</p><ul><li>中文：<a href="https://docs.langchain4j.info/tutorials/model-parameters">https://docs.langchain4j.info/tutorials/model-parameters</a></li><li>英文：<a href="https://docs.langchain4j.dev/tutorials/model-parameters">https://docs.langchain4j.dev/tutorials/model-parameters</a></li></ul><p>建<code>module</code>：LangChain4j-05model-parameters</p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- langchain4j 基础 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- langchain4j 高阶 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- hutool-all --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9003</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LangChain4j-05model-parameters</span></span><br></pre></td></tr></table></figure><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModelQWen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))<span class="comment">//从系统环境变量获得key</span></span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)<span class="comment">//模型名称</span></span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)<span class="comment">//模型接口地址</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Controller</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModelParameterController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/modelparam/config&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">config</span><span class="params">(<span class="meta">@RequestParam(value = &quot;prompt&quot;,defaultValue = &quot;你是谁&quot;)</span> String prompt)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> chatModel.chat(prompt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="日志配置（Logging）"><a href="#日志配置（Logging）" class="headerlink" title="日志配置（Logging）"></a>日志配置（Logging）</h3><p><code>https://docs.langchain4j.info/tutorials/logging</code></p><ol><li><p>引入日志包</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250730164249220.png" alt="image-20250730164249220"></p></li><li><p>在<code>application.yaml</code>，开启日志</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250730164408784.png" alt="image-20250730164408784"></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">dev:</span></span><br><span class="line">      <span class="attr">langchain4j:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></table></figure></li><li><p>开启日志</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModelQWen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))<span class="comment">//从系统环境变量获得key</span></span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)<span class="comment">//模型名称</span></span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)<span class="comment">//模型接口地址</span></span><br><span class="line">                .logRequests(<span class="literal">true</span>) <span class="comment">//开启请求日志</span></span><br><span class="line">                .logResponses(<span class="literal">true</span>) <span class="comment">//开启响应日志</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250730164745583.png" alt="image-20250730164745583"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250730164906389.png" alt="image-20250730164906389"></p></li></ol><h3 id="监控（observability）"><a href="#监控（observability）" class="headerlink" title="监控（observability）"></a>监控（observability）</h3><p><a href="https://docs.langchain4j.info/tutorials/observability">https://docs.langchain4j.info/tutorials/observability</a></p><p><a href="https://docs.langchain4j.info/integrations/language-models">某些</a> <code>ChatLanguageModel</code> 和 <code>StreamingChatLanguageModel</code> 的实现 （参见”可观测性”列）允许配置 <code>ChatModelListener</code>（多个）来监听事件，例如：</p><ul><li>向 LLM 发送的请求</li><li>来自 LLM 的响应</li><li>错误</li></ul><p>我们就可以定义监听器，来监听这些事件的发生，如果发生意外，好做及时的处理！</p><p>结论</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250730174441031.png" alt="image-20250730174441031"></p><p>他是如何工作的？</p><ul><li>监听器被指定为 <code>List&lt;ChatModelListener&gt;</code>，并按照迭代顺序调用。</li><li>监听器同步调用，并在同一线程中调用。有关流式处理情况的更多详细信息，请参见下文。 第二个监听器直到第一个监听器返回后才会被调用。</li><li><code>ChatModelListener.onRequest()</code> 方法在调用 LLM 提供商 API 之前立即调用。</li><li><code>ChatModelListener.onRequest()</code> 方法每个请求只调用一次。 如果在调用 LLM 提供商 API 时发生错误并进行重试， <code>ChatModelListener.onRequest()</code> 将***不会***为每次重试调用。</li><li><code>ChatModelListener.onResponse()</code> 方法只调用一次， 在从 LLM 提供商收到成功响应后立即调用。</li><li><code>ChatModelListener.onError()</code> 方法只调用一次。 如果在调用 LLM 提供商 API 时发生错误并进行重试， <code>ChatModelListener.onError()</code> 将***不会***为每次重试调用。</li><li>如果从 <code>ChatModelListener</code> 方法之一抛出异常， 它将以 <code>WARN</code> 级别记录。后续监听器的执行将照常继续。</li><li>通过 <code>ChatModelRequestContext</code>、<code>ChatModelResponseContext</code> 和 <code>ChatModelErrorContext</code> 提供的 <code>ChatRequest</code> 是最终请求，包含在 <code>ChatLanguageModel</code> 上配置的默认 <code>ChatRequestParameters</code> 和特定于请求的 <code>ChatRequestParameters</code> 合并在一起。</li><li>对于 <code>StreamingChatLanguageModel</code>，<code>ChatModelListener.onResponse()</code> 和 <code>ChatModelListener.onError()</code> 在与 <code>ChatModelListener.onRequest()</code> 不同的线程上调用。 线程上下文目前不会自动传播，因此您可能希望使用 <code>attributes</code> 映射 从 <code>ChatModelListener.onRequest()</code> 传播任何必要的数据到 <code>ChatModelListener.onResponse()</code> 或 <code>ChatModelListener.onError()</code>。</li><li>对于 <code>StreamingChatLanguageModel</code>，<code>ChatModelListener.onResponse()</code> 在 <code>StreamingChatResponseHandler.onCompleteResponse()</code> 被调用之前调用。<code>ChatModelListener.onError()</code> 在 <code>StreamingChatResponseHandler.onError()</code> 被调用之前调用。</li></ul><h4 id="案例-1"><a href="#案例-1" class="headerlink" title="案例"></a>案例</h4><p>在上面的代码进行改造</p><p>创建一个<code>MyChatModelLinstener</code>监听器，并实现<code>ChatModelLinstener</code>接口</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.listener.ChatModelErrorContext;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.listener.ChatModelListener;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.listener.ChatModelRequestContext;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.listener.ChatModelResponseContext;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyChatModelListener</span> <span class="keyword">implements</span> <span class="title class_">ChatModelListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onRequest</span><span class="params">(ChatModelRequestContext requestContext)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestId</span> <span class="operator">=</span> IdUtil.simpleUUID();</span><br><span class="line">        requestContext.attributes().put(<span class="string">&quot;traceId&quot;</span>, requestId);</span><br><span class="line">        log.info(<span class="string">&quot;请求参数requestContext：&#123;&#125;&quot;</span>, requestContext+<span class="string">&quot;:&quot;</span>+requestId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(ChatModelResponseContext responseContext)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">traceId</span> <span class="operator">=</span> responseContext.attributes().get(<span class="string">&quot;traceId&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;返回结果responseContext:&#123;&#125;&quot;</span>,traceId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(ChatModelErrorContext errorContext)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;发生错误了errorContext:&#123;&#125;&quot;</span>,errorContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将监听器，添加到大模型配置类里面</p><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.listener.MyChatModelListener;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModelQWen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))<span class="comment">//从系统环境变量获得key</span></span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)<span class="comment">//模型名称</span></span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)<span class="comment">//模型接口地址</span></span><br><span class="line">                .logRequests(<span class="literal">true</span>) <span class="comment">//开启请求日志</span></span><br><span class="line">                .logResponses(<span class="literal">true</span>) <span class="comment">//开启响应日志</span></span><br><span class="line">                .listeners(List.of(<span class="keyword">new</span> <span class="title class_">MyChatModelListener</span>()))<span class="comment">//将我们写入的监听器，添加到里面</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于<code>listeners</code>方法传递的是List集合，所以我们使用List.of添加List集合里面在传入</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250730175000674.png" alt="image-20250730175000674"></p><p>测试</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250730175108302.png" alt="image-20250730175108302"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250730175301176.png" alt="image-20250730175301176"></p><h3 id="重试机制（Retry-Configuration）"><a href="#重试机制（Retry-Configuration）" class="headerlink" title="重试机制（Retry Configuration）"></a>重试机制（Retry Configuration）</h3><p><img src="/hexo-docs/images/LangChain4jImages/image-20250730175824264.png" alt="image-20250730175824264"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250730180026248.png" alt="image-20250730180026248"></p><p>改造<code>LLMConfig</code>，添加重试和超时配置</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.listener.MyChatModelListener;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModelQWen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))<span class="comment">//从系统环境变量获得key</span></span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)<span class="comment">//模型名称</span></span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)<span class="comment">//模型接口地址</span></span><br><span class="line">                .logRequests(<span class="literal">true</span>) <span class="comment">//开启请求日志</span></span><br><span class="line">                .logResponses(<span class="literal">true</span>) <span class="comment">//开启响应日志</span></span><br><span class="line">                .listeners(List.of(<span class="keyword">new</span> <span class="title class_">MyChatModelListener</span>()))</span><br><span class="line">                .maxRetries(<span class="number">3</span>)<span class="comment">//最大重试次数</span></span><br><span class="line">                .timeout(Duration.ofMillis(<span class="number">2000</span>))<span class="comment">//超时时间2秒</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p>正常的情况</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250730180457391.png" alt="image-20250730180457391"></p><p>异常情况</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250730181200571.png" alt="image-20250730181200571"></p><p>发现重试了4次，因为，重试的时候不包含第一次请求的</p><h3 id="超时控制（timeout）"><a href="#超时控制（timeout）" class="headerlink" title="超时控制（timeout）"></a>超时控制（timeout）</h3><p>向大模型发送请求，如过在指定的时间内没有收到响应，该请求被中断并且报<code>request timed out</code>(请求超时)</p><p>在重试机制演示了超时控制，所以不在演示</p><h3 id="自定义头"><a href="#自定义头" class="headerlink" title="自定义头"></a>自定义头</h3><p>在 <strong>LangChain4j</strong> 中，<code>customHeaders</code> 是一个用于向 HTTP 请求添加<strong>自定义请求头（HTTP Headers）</strong>的配置选项。它主要用于与外部 API（如 OpenAI、Azure OpenAI、Hugging Face 等模型服务）交互时，传递额外的元数据或认证信息。</p><p>核心作用：</p><ol><li><strong>自定义认证</strong>：添加 API 密钥、Token 或其他认证凭据。</li><li><strong>传递元数据</strong>：添加业务相关的标识（如请求来源、版本号）。</li><li><strong>兼容特定服务</strong>：适配某些 API 的特殊头部要求（如 <code>x-api-key</code>）。</li></ol><p>案例</p><p>改造<code>LLMConfig</code>类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.listener.MyChatModelListener;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModelQWen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))<span class="comment">//从系统环境变量获得key</span></span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)<span class="comment">//模型名称</span></span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)<span class="comment">//模型接口地址</span></span><br><span class="line">                .logRequests(<span class="literal">true</span>) <span class="comment">//开启请求日志</span></span><br><span class="line">                .logResponses(<span class="literal">true</span>) <span class="comment">//开启响应日志</span></span><br><span class="line">                .listeners(List.of(<span class="keyword">new</span> <span class="title class_">MyChatModelListener</span>()))</span><br><span class="line">                .maxRetries(<span class="number">3</span>)<span class="comment">//最大重试次数</span></span><br><span class="line">                .timeout(Duration.ofMillis(<span class="number">2000</span>))<span class="comment">//超时时间2秒</span></span><br><span class="line">                .customHeaders(Map.of(</span><br><span class="line">                        <span class="string">&quot;X-Custom-Header&quot;</span>, <span class="string">&quot;value1&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;User-Origin&quot;</span>, <span class="string">&quot;my-app&quot;</span></span><br><span class="line">                )) <span class="comment">//自定义头部信息</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250730183615607.png" alt="image-20250730183615607"></p><blockquote><p>注意事项：</p><ol><li><strong>优先级</strong>：若与 LangChain4j 默认头部（如 <code>Authorization</code>）冲突，<code>customHeaders</code> 中的值会<strong>覆盖默认值</strong>。</li><li><strong>安全性</strong>：避免在 <code>customHeaders</code> 中硬编码敏感信息（建议通过环境变量注入）。</li><li><strong>服务兼容性</strong>：不同 API 对头部的支持不同（如 OpenAI 用 <code>Authorization</code>，Azure 用 <code>api-key</code>）。</li><li>自定义头是添加到请求头上的，而不是响应头！</li></ol></blockquote><h2 id="多模态视觉理解"><a href="#多模态视觉理解" class="headerlink" title="多模态视觉理解"></a>多模态视觉理解</h2><p>“多模态视觉” 是指 <strong>计算机视觉技术与其他感知模态（如语言、声音、触觉等）相结合</strong> 的研究和应用领域。它的核心思想是模仿人类感知世界的方式——我们并非仅仅依靠眼睛看，而是<strong>综合运用视觉、听觉、触觉、语言理解等多种感官信息</strong>来理解和交互环境。</p><p>就是利用图片和文字跟 AI 进行对话！</p><h3 id="所有支持的语言模型比较表"><a href="#所有支持的语言模型比较表" class="headerlink" title="所有支持的语言模型比较表"></a>所有支持的语言模型比较表</h3><table><thead><tr><th>提供商</th><th><a href="https://docs.langchain4j.info/tutorials/response-streaming">流式处理</a></th><th><a href="https://docs.langchain4j.info/tutorials/tools">工具</a> (同步&#x2F;流式)</th><th><a href="https://docs.langchain4j.info/tutorials/structured-outputs#json-schema">JSON Schema</a></th><th><a href="https://docs.langchain4j.info/tutorials/ai-services#json-mode">JSON 模式</a></th><th>支持的<a href="https://docs.langchain4j.info/tutorials/chat-and-language-models/#multimodality">模态</a> (输入)</th><th><a href="https://docs.langchain4j.info/tutorials/observability">可观测性</a></th><th><a href="https://docs.langchain4j.info/tutorials/customizable-http-client">可自定义 HTTP 客户端</a></th><th>本地部署</th><th>支持原生镜像</th><th>备注</th></tr></thead><tbody><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/amazon-bedrock#chatlanguagemodel-using-converseapi">Amazon Bedrock (Converse API)</a></td><td>✅</td><td>✅&#x2F;✅</td><td></td><td></td><td>文本, 图像, PDF</td><td>✅</td><td></td><td></td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/amazon-bedrock#chatlanguagemodel-using-invokeapi">Amazon Bedrock (Invoke API)</a></td><td>✅</td><td>✅&#x2F;❌</td><td></td><td></td><td>文本</td><td>✅</td><td></td><td></td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/anthropic">Anthropic</a></td><td>✅</td><td>✅&#x2F;✅</td><td></td><td></td><td>文本, 图像</td><td>✅</td><td>🆘 <a href="https://github.com/langchain4j/langchain4j/issues/2469">#2469</a></td><td></td><td>✅</td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/azure-open-ai">Azure OpenAI</a></td><td>✅</td><td>✅&#x2F;✅</td><td>✅</td><td>✅</td><td>文本, 图像</td><td>✅</td><td></td><td></td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/chatglm">ChatGLM</a></td><td></td><td></td><td></td><td></td><td>文本</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/dashscope">DashScope</a></td><td>✅</td><td>✅&#x2F;✅</td><td></td><td></td><td>文本, 图像, 音频</td><td>✅</td><td></td><td></td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/github-models">GitHub Models</a></td><td>✅</td><td>✅&#x2F;✅</td><td>🔜 <a href="https://github.com/langchain4j/langchain4j/issues/1911">#1911</a></td><td>✅</td><td>文本, 图像</td><td>✅</td><td></td><td></td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/google-ai-gemini">Google AI Gemini</a></td><td>✅</td><td>✅&#x2F;✅</td><td>✅</td><td>✅</td><td>文本, 图像, 音频, 视频, PDF</td><td>✅</td><td></td><td></td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/google-vertex-ai-gemini">Google Vertex AI Gemini</a></td><td>✅</td><td>✅&#x2F;✅</td><td>🆘 <a href="https://github.com/langchain4j/langchain4j/issues/1717">#1717</a></td><td>✅</td><td>文本, 图像, 音频, 视频, PDF</td><td>✅</td><td></td><td></td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/google-palm">Google Vertex AI PaLM 2</a></td><td></td><td></td><td></td><td></td><td>文本</td><td></td><td></td><td></td><td>✅</td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/hugging-face">Hugging Face</a></td><td></td><td></td><td></td><td></td><td>文本</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/jlama">Jlama</a></td><td>✅</td><td>✅&#x2F;✅</td><td></td><td></td><td>文本</td><td></td><td></td><td>✅</td><td>✅</td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/local-ai">LocalAI</a></td><td>✅</td><td>✅&#x2F;✅</td><td></td><td></td><td>文本, 图像, 音频</td><td></td><td></td><td>✅</td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/mistral-ai">Mistral AI</a></td><td>✅</td><td>✅&#x2F;✅</td><td>✅</td><td>✅</td><td>文本</td><td></td><td>🆘 <a href="https://github.com/langchain4j/langchain4j/issues/2524">#2524</a></td><td></td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/ollama">Ollama</a></td><td>✅</td><td>✅&#x2F;✅</td><td>✅</td><td>✅</td><td>文本, 图像</td><td>✅</td><td>✅</td><td>✅</td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/open-ai">OpenAI</a></td><td>✅</td><td>✅&#x2F;✅</td><td>✅</td><td>✅</td><td>文本, 图像, 音频</td><td>✅</td><td>✅</td><td>兼容：Ollama, LM Studio, GPT4All, 等</td><td>✅</td><td>兼容：Groq, 等</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/qianfan">Qianfan</a></td><td>✅</td><td>✅&#x2F;✅</td><td></td><td></td><td>文本</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/workers-ai">Cloudflare Workers AI</a></td><td></td><td></td><td></td><td></td><td>文本</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/language-models/zhipu-ai">Zhipu AI</a></td><td>✅</td><td>✅&#x2F;✅</td><td></td><td></td><td>文本, 图像</td><td>✅</td><td></td><td></td><td></td><td></td></tr></tbody></table><p>图例：</p><ul><li>✅ 表示”支持”</li><li>🆘 表示”尚未支持；请帮助我们实现它”</li><li>🔜 表示”正在实现中；请等待”</li><li>❌ 表示”LLM 提供商不支持”</li></ul><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731163201758.png" alt="image-20250731163201758"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731163500077.png" alt="image-20250731163500077"></p><h3 id="选择模型"><a href="#选择模型" class="headerlink" title="选择模型"></a>选择模型</h3><p>我们用阿里云百炼平台，地址：<a href="https://bailian.console.aliyun.com/">https://bailian.console.aliyun.com/</a></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731163938529.png" alt="image-20250731163938529"></p><p>模型名字，点击要选择的模型，查看详情</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731164021669.png" alt="image-20250731164021669"></p><p>模型的api地址，点击查看api参考</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731164108219.png" alt="image-20250731164108219"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731164130447.png" alt="image-20250731164130447"></p><h3 id="code-案例"><a href="#code-案例" class="headerlink" title="code 案例"></a>code 案例</h3><h4 id="example-1（LangChain4j-原生）"><a href="#example-1（LangChain4j-原生）" class="headerlink" title="example 1（LangChain4j 原生）"></a>example 1（LangChain4j 原生）</h4><p>建<code>module</code>：LangChain4j-06chat-image</p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>引入图片到<code>resources/static/image</code></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731170056487.png" alt="image-20250731170056487"></p><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModelQWen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                <span class="comment">//qwen-vl-max 是一个多模态大模型，支持图片和文本的结合输入，适用于视觉-语言任务。</span></span><br><span class="line">                .modelName(<span class="string">&quot;qwen-vl-max&quot;</span>)</span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编码步骤</p><ol><li>图片转码：通过Base64编码将图片转化为字符串</li><li>提示词指定：结合<code>ImageContent</code>和<code>TextContent</code>一起发送到模型处理</li><li>API调用：使用<code>OpenAiChatModel</code>来构建请求，并通过<code>chat()</code>方法调用模型。请求内容包括文本提示和图片，模型会根据输入返回分析结果。</li><li>解析与输出：从<code>ChatResponse</code>中获取AI大模型的回复，打印出处理后的结果。</li></ol><p><code>controller</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.message.ImageContent;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.message.TextContent;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.message.UserMessage;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.response.ChatResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImageModelController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;classpath:static/yejing.png&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Resource resource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/image/call&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//1. 图片转码：通过Base64编码将图片转化为字符串</span></span><br><span class="line">        <span class="type">byte</span>[] byteArray = resource.getContentAsByteArray();</span><br><span class="line">        <span class="comment">//将图片转成base64编码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64Data</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(byteArray);</span><br><span class="line">        <span class="comment">//2.提示词指定：结合ImageContent和TextContent一起发送到模型处理</span></span><br><span class="line">        <span class="type">UserMessage</span> <span class="variable">userMessage</span> <span class="operator">=</span> UserMessage.from(</span><br><span class="line">                TextContent.from(<span class="string">&quot;从图片你能得到什么信息？&quot;</span>),</span><br><span class="line">                ImageContent.from(base64Data,<span class="string">&quot;image/png&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">//3.解析与输出：从ChatResponse中获取AI大模型的回复，打印出处理后的结果。</span></span><br><span class="line">        <span class="type">ChatResponse</span> <span class="variable">chatResponse</span> <span class="operator">=</span> chatModel.chat(userMessage);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> chatResponse.aiMessage().text();</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731172941409.png" alt="image-20250731172941409"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731173034251.png" alt="image-20250731173034251"></p><p>为什么用<code>AiMessage</code>?</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731172105810.png" alt="image-20250731172105810"></p><h4 id="example-2（LangChain4j跟第三方整合）"><a href="#example-2（LangChain4j跟第三方整合）" class="headerlink" title="example 2（LangChain4j跟第三方整合）"></a>example 2（LangChain4j跟第三方整合）</h4><p>地址：<a href="https://docs.langchain4j.info/integrations/language-models/dashscope">https://docs.langchain4j.info/integrations/language-models/dashscope</a></p><p>结合阿里巴巴通义万相进行图像理解，其支持视觉+语言的多模态任务</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731175525908.png" alt="image-20250731175525908"></p><p>切换通义万相-文生图模型<code>wanx2.1-t2i-turbo</code></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731180551041.png" alt="image-20250731180551041"></p><p>两种方式</p><ol><li><p>原生</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731175727807.png" alt="image-20250731175727807"></p></li><li><p>集成SpringBoot</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731175746397.png" alt="image-20250731175746397"></p></li></ol><p>我们在父工程的<code>pom</code>文件引入，物料管理清单</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">langchain4j-community.version</span>&gt;</span>1.0.1-beta6<span class="tag">&lt;/<span class="name">langchain4j-community.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-community-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;langchain4j-community.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在子项目下引入</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-community-dashscope-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>修改<code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.community.model.dashscope.WanxImageModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试通义万象来实现图片生成，</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> WanxImageModel <span class="title function_">wanxImageModel</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> WanxImageModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;wanx2.1-t2i-turbo&quot;</span>) <span class="comment">//图片生成 https://help.aliyun.com/zh/model-studio/text-to-image</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>WanxImageModelController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dashscope.aigc.imagesynthesis.ImageSynthesis;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dashscope.aigc.imagesynthesis.ImageSynthesisParam;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dashscope.aigc.imagesynthesis.ImageSynthesisResult;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dashscope.exception.NoApiKeyException;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dashscope.utils.JsonUtils;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.community.model.dashscope.WanxImageModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.image.Image;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.output.Response;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WanxImageModelController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WanxImageModel wanxImageModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/image/create&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createImageModel</span><span class="params">()</span> &#123;</span><br><span class="line">        Response&lt;Image&gt; imageResponse = wanxImageModel.generate(<span class="string">&quot;风景照&quot;</span>);</span><br><span class="line">        System.out.println(imageResponse.content().url());</span><br><span class="line">        <span class="keyword">return</span> imageResponse.content().toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/image/create2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">create2ImageModel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="string">&quot;图片风格为3D渲染，中国风，一个巨大的展开的卷轴在空中飘浮，金银色调，玉髓雕刻，&quot;</span> +</span><br><span class="line">                <span class="string">&quot;色彩细腻，广角镜头，blender 渲染，丰富细节，超高清&quot;</span>;</span><br><span class="line">        <span class="type">ImageSynthesisParam</span> <span class="variable">param</span> <span class="operator">=</span> ImageSynthesisParam.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .model(ImageSynthesis.Models.WANX_V1) <span class="comment">//wanx_v1模型</span></span><br><span class="line">                .prompt(prompt) <span class="comment">//图片要求</span></span><br><span class="line">                .style(<span class="string">&quot;&lt;watercolor&gt;&quot;</span>) <span class="comment">//水彩画</span></span><br><span class="line">                .n(<span class="number">1</span>)  <span class="comment">//数量</span></span><br><span class="line">                .size(<span class="string">&quot;1024*1024&quot;</span>) <span class="comment">//大小</span></span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">ImageSynthesis</span> <span class="variable">imageSynthesis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ImageSynthesis</span>();</span><br><span class="line">        ImageSynthesisResult result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = imageSynthesis.call(param);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoApiKeyException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> JsonUtils.toJson(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731182312800.png" alt="image-20250731182312800"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731182343441.png" alt="image-20250731182343441"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731182834973.png" alt="image-20250731182834973"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250731182905130.png" alt="image-20250731182905130"></p><h2 id="流式输出（streamingoutput）"><a href="#流式输出（streamingoutput）" class="headerlink" title="流式输出（streamingoutput）"></a>流式输出（streamingoutput）</h2><p>网址：<a href="https://docs.langchain4j.info/tutorials/response-streaming">https://docs.langchain4j.info/tutorials/response-streaming</a></p><p>是什么？</p><ul><li>是一种逐步返回大模型生成结果的技术，生成一点返回一点，允许服务器将响应内容分批次实时传输给客户端，而不是等待全部内容生成完毕后再一次性返回。这种机制能显著提升用户体验，尤其适用于大模型响应较慢的场景（如生成长文本或复杂推理结果）。</li></ul><p><img src="/hexo-docs/images/LangChain4jImages/image-20250801184653680.png" alt="image-20250801184653680"></p><h3 id="低阶api-1"><a href="#低阶api-1" class="headerlink" title="低阶api"></a>低阶api</h3><p>建module：<code>LangChain4j-07chat-stream</code></p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9007</span></span><br><span class="line">  <span class="comment"># 设置响应的字符编码，避免流式返回输出乱码</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">encoding:</span></span><br><span class="line">      <span class="attr">charset:</span> <span class="string">utf-8</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 启用http编码支持</span></span><br><span class="line">      <span class="attr">force:</span> <span class="literal">true</span> <span class="comment">#  HTTP 请求和响应上强制编码到配置的字符集</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LangChain4j-07chat-stream</span></span><br></pre></td></tr></table></figure><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.StreamingChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiStreamingChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通对话</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModelQWen</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)</span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置流式输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> StreamingChatModel <span class="title function_">streamingChatModelQWen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiStreamingChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)</span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>StreamChatModelController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.StreamingChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.response.ChatResponse;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.response.StreamingChatResponseHandler;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StreamChatModelController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModelQWen;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StreamingChatModel streamingChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/chat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getStreamingChatModel</span><span class="params">(<span class="meta">@RequestParam(value = &quot;prompt&quot;,</span></span></span><br><span class="line"><span class="meta"><span class="params">            defaultValue = &quot;说一下北京有什么好玩的地方？&quot;)</span> String prompt)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> chatModelQWen.chat(prompt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/streaming&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">streaming</span><span class="params">(<span class="meta">@RequestParam(value = &quot;prompt&quot;,</span></span></span><br><span class="line"><span class="meta"><span class="params">            defaultValue = &quot;说一下北京有什么好玩的地方？&quot;)</span> String prompt)</span> &#123;</span><br><span class="line">         streamingChatModel.chat(prompt,<span class="keyword">new</span> <span class="title class_">StreamingChatResponseHandler</span>() &#123;</span><br><span class="line"></span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPartialResponse</span><span class="params">(String partialResponse)</span> &#123;</span><br><span class="line">                 System.out.println(partialResponse);</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleteResponse</span><span class="params">(ChatResponse completeResponse)</span> &#123;</span><br><span class="line">                 System.out.println(completeResponse);</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">                 System.out.println(throwable);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p>普通的</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250801191108273.png" alt="image-20250801191108273"></p><p>流水输出</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250801191136710.png" alt="image-20250801191136710"></p><h3 id="高阶api（结合webFlux编程）"><a href="#高阶api（结合webFlux编程）" class="headerlink" title="高阶api（结合webFlux编程）"></a>高阶api（结合webFlux编程）</h3><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 高阶api --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- langchain4j 结合web Flux编程 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-reactor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9007</span></span><br><span class="line">  <span class="comment"># 设置响应的字符编码，避免流式返回输出乱码</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">encoding:</span></span><br><span class="line">      <span class="attr">charset:</span> <span class="string">utf-8</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 启用http编码支持</span></span><br><span class="line">      <span class="attr">force:</span> <span class="literal">true</span> <span class="comment">#  HTTP 请求和响应上强制编码到配置的字符集</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LangChain4j-07chat-stream</span></span><br></pre></td></tr></table></figure><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.StreamingChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiStreamingChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通对话</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModelQWen</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)</span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置流式输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> StreamingChatModel <span class="title function_">streamingChatModelQWen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiStreamingChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)</span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>StreamingChatModelController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.StreamingChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.response.ChatResponse;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.response.StreamingChatResponseHandler;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StreamChatModelFluxController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StreamingChatModel streamingChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/flux/chat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">chat</span><span class="params">(<span class="meta">@RequestParam(value = &quot;prompt&quot;</span></span></span><br><span class="line"><span class="meta"><span class="params">            ,defaultValue = &quot;北京有什么好玩的地方&quot;)</span> String prompt)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">chat</span> <span class="operator">=</span> chatModel.chat(prompt);</span><br><span class="line">        <span class="keyword">return</span> Flux.just(chat);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/flux/streaming&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">stringFlux</span><span class="params">(<span class="meta">@RequestParam(value = &quot;prompt&quot;</span></span></span><br><span class="line"><span class="meta"><span class="params">            ,defaultValue = &quot;西安有什么好玩的地方？&quot;)</span> String prompt)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Flux.create(fluxSink -&gt; streamingChatModel.chat(prompt, <span class="keyword">new</span> <span class="title class_">StreamingChatResponseHandler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPartialResponse</span><span class="params">(String partialResponse)</span> &#123;</span><br><span class="line">                fluxSink.next(partialResponse);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleteResponse</span><span class="params">(ChatResponse completeResponse)</span> &#123;</span><br><span class="line">                fluxSink.complete();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable error)</span> &#123;</span><br><span class="line">                fluxSink.error(error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250801192733281.png" alt="image-20250801192733281"></p><p>流式输出</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250801192819786.png" alt="image-20250801192819786"></p><h3 id="接口式编程（结合Flux）"><a href="#接口式编程（结合Flux）" class="headerlink" title="接口式编程（结合Flux）"></a>接口式编程（结合Flux）</h3><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 高阶api --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- langchain4j 结合web Flux编程 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-reactor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9007</span></span><br><span class="line">  <span class="comment"># 设置响应的字符编码，避免流式返回输出乱码</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">encoding:</span></span><br><span class="line">      <span class="attr">charset:</span> <span class="string">utf-8</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 启用http编码支持</span></span><br><span class="line">      <span class="attr">force:</span> <span class="literal">true</span> <span class="comment">#  HTTP 请求和响应上强制编码到配置的字符集</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LangChain4j-07chat-stream</span></span><br></pre></td></tr></table></figure><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.ChatAssistant;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.StreamingChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiStreamingChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.AiServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通对话</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModelQWen</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)</span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置流式输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> StreamingChatModel <span class="title function_">streamingChatModelQWen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiStreamingChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)</span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 流式接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatAssistant <span class="title function_">assistantStreaming</span><span class="params">(StreamingChatModel streamingChatModel)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> AiServices.create(ChatAssistant.class,streamingChatModel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ChatAssistant</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChatAssistant</span> &#123;</span><br><span class="line">    Flux&lt;String&gt; <span class="title function_">fluxChat</span><span class="params">(String prompt)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>StreamingChatModelWithInterfaceController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.ChatAssistant;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StreamingChatModelWithInterfaceController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatAssistant chatAssistant;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/interface/chat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat</span><span class="params">(<span class="meta">@RequestParam(value = &quot;prompt&quot;,</span></span></span><br><span class="line"><span class="meta"><span class="params">            defaultValue = &quot;介绍一下广州&quot;)</span> String prompt)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> chatModel.chat(prompt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/interface/streaming&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">streaming</span><span class="params">(<span class="meta">@RequestParam(value = &quot;prompt&quot;,</span></span></span><br><span class="line"><span class="meta"><span class="params">            defaultValue = &quot;介绍一下深圳&quot;)</span> String prompt)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> chatAssistant.fluxChat(prompt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250801194559792.png" alt="image-20250801194559792"></p><p>流式输出</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250801203906441.png" alt="image-20250801203906441"></p><h2 id="记忆缓存"><a href="#记忆缓存" class="headerlink" title="记忆缓存"></a>记忆缓存</h2><p>官网：<a href="https://docs.langchain4j.info/tutorials/chat-memory">https://docs.langchain4j.info/tutorials/chat-memory</a></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250802165149740.png" alt="image-20250802165149740"></p><p>记忆缓存是聊天系统中的一个重要组件，用于存储和管理对话的上下文信息。它的主要作用是让AI助手能够“记住”之前的对话内容，从而提供连贯和个性化的回复。</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250802165419653.png" alt="image-20250802165419653"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250802165504428.png" alt="image-20250802165504428"></p><h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><p>默认情况下，<code>ChatMemory</code>实现在内存中存储<code>ChatMessage</code>。</p><p>如果需要持久化，可以实现自定义的<code>ChatMemoryStore</code>， 将<code>ChatMessage</code>存储在您选择的任何持久化存储中：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PersistentChatMemoryStore</span> <span class="keyword">implements</span> <span class="title class_">ChatMemoryStore</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> List&lt;ChatMessage&gt; <span class="title function_">getMessages</span><span class="params">(Object memoryId)</span> &#123;</span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> 实现通过内存ID从持久化存储中获取所有消息。</span></span><br><span class="line">          <span class="comment">// 可以使用ChatMessageDeserializer.messageFromJson(String)和</span></span><br><span class="line">          <span class="comment">// ChatMessageDeserializer.messagesFromJson(String)辅助方法</span></span><br><span class="line">          <span class="comment">// 轻松地从JSON反序列化聊天消息。</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateMessages</span><span class="params">(Object memoryId, List&lt;ChatMessage&gt; messages)</span> &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> 实现通过内存ID更新持久化存储中的所有消息。</span></span><br><span class="line">            <span class="comment">// 可以使用ChatMessageSerializer.messageToJson(ChatMessage)和</span></span><br><span class="line">            <span class="comment">// ChatMessageSerializer.messagesToJson(List&lt;ChatMessage&gt;)辅助方法</span></span><br><span class="line">            <span class="comment">// 轻松地将聊天消息序列化为JSON。</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteMessages</span><span class="params">(Object memoryId)</span> &#123;</span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> 实现通过内存ID删除持久化存储中的所有消息。</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ChatMemory</span> <span class="variable">chatMemory</span> <span class="operator">=</span> MessageWindowChatMemory.builder()</span><br><span class="line">        .id(<span class="string">&quot;12345&quot;</span>)</span><br><span class="line">        .maxMessages(<span class="number">10</span>)</span><br><span class="line">        .chatMemoryStore(<span class="keyword">new</span> <span class="title class_">PersistentChatMemoryStore</span>())</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure><p>每当向<code>ChatMemory</code>添加新的<code>ChatMessage</code>时，都会调用<code>updateMessages()</code>方法。 这通常在与LLM的每次交互中发生两次： 一次是添加新的<code>UserMessage</code>时，另一次是添加新的<code>AiMessage</code>时。 <code>updateMessages()</code>方法预期会更新与给定内存ID关联的所有消息。 <code>ChatMessage</code>可以单独存储（例如，每条消息一条记录&#x2F;行&#x2F;对象） 或一起存储（例如，整个<code>ChatMemory</code>一条记录&#x2F;行&#x2F;对象）。</p><p>备注</p><p>请注意，从<code>ChatMemory</code>中淘汰的消息也将从<code>ChatMemoryStore</code>中淘汰。 当消息被淘汰时，会调用<code>updateMessages()</code>方法， 传入不包含被淘汰消息的消息列表。</p><p>当<code>ChatMemory</code>的用户请求所有消息时，会调用<code>getMessages()</code>方法。 这通常在与LLM的每次交互中发生一次。 <code>Object memoryId</code>参数的值对应于创建<code>ChatMemory</code>时指定的<code>id</code>。 它可以用来区分多个用户和&#x2F;或对话。 <code>getMessages()</code>方法预期会返回与给定内存ID关联的所有消息。</p><p>当调用<code>ChatMemory.clear()</code>时，会调用<code>deleteMessages()</code>方法。 如果您不使用此功能，可以将此方法留空。</p><h3 id="两种主要的ChatMemory实现类"><a href="#两种主要的ChatMemory实现类" class="headerlink" title="两种主要的ChatMemory实现类"></a>两种主要的ChatMemory实现类</h3><ol><li>MessageWindowChatMemory<ul><li>较简单的一种，<code>MessageWindowChatMemory</code>，作为滑动窗口运行， 保留最近的<code>N</code>条消息，并淘汰不再适合的旧消息。 然而，由于每条消息可能包含不同数量的令牌， <code>MessageWindowChatMemory</code>主要用于快速原型设计。</li></ul></li><li>TokenWindowChatMemory<ul><li>更复杂的选项是<code>TokenWindowChatMemory</code>， 它也作为滑动窗口运行，但专注于保留最近的<code>N</code>个<strong>令牌</strong>， 根据需要淘汰旧消息。 消息是不可分割的。如果一条消息不适合，它会被完全淘汰。 <code>TokenWindowChatMemory</code>需要一个<code>Tokenizer</code>来计算每个<code>ChatMessage</code>中的令牌数。</li></ul></li></ol><p>大模型中的Token VS Web开发中的Token</p><ul><li><p>大模型中的token</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250802165751231.png" alt="image-20250802165751231"></p></li><li><p>Web开发中的token</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250802165810527.png" alt="image-20250802165810527"></p></li><li><p>区别</p><ul><li>目的不同：大模型中的token是为了将文本分割成可处理的单元，便于进行计算；而Web开发中的token主要用于安全地传递用户身份信息</li><li>生成方式不同：前者通过特定的算法（如BPE）对文本进行分割得到；后者则通常是通过加密算法生成的唯一字符串。</li><li>应用场景不同：前者应用于文本分析、机器翻译等NLP任务；后者多见于用户登录系统、API 访问控制等领域。</li></ul></li></ul><h3 id="案例-2"><a href="#案例-2" class="headerlink" title="案例"></a>案例</h3><p>新建<code>module</code>：<code>LangChain4j-08chat-memory</code></p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.taget</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.taget</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.souce</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.souce</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- langchain4j low-api --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- langchain4j high-api --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9008</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">encoding:</span></span><br><span class="line">      <span class="attr">charset:</span> <span class="string">utf-8</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">force:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LangChain4j-08chat-memory</span></span><br></pre></td></tr></table></figure><p><code>ChatAssistant</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChatAssistant</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通聊天对话</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> prompt 消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 回复</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">chat</span><span class="params">(String prompt)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ChatMemoryAssistant</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.MemoryId;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.UserMessage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChatMemoryAssistant</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 带记忆缓存聊天</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> prompt 消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 回复</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">chatMemory</span><span class="params">(<span class="meta">@MemoryId</span> Long userId, <span class="meta">@UserMessage</span> String prompt)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>更换模型</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250802174808541.png" alt="image-20250802174808541"></p><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.ChatAssistant;</span><br><span class="line"><span class="keyword">import</span> com.lazy.service.ChatMemoryAssistant;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.memory.chat.MessageWindowChatMemory;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.memory.chat.TokenWindowChatMemory;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.TokenCountEstimator;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiTokenCountEstimator;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.AiServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;qwen-long&quot;</span>)</span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;chatAssistant&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ChatAssistant <span class="title function_">chatAssistant</span><span class="params">(ChatModel chatModel)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> AiServices.create(ChatAssistant.class, chatModel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;chatMessageMemoryChatMemory&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ChatMemoryAssistant <span class="title function_">chatMessageWindowChatMemory</span><span class="params">(ChatModel chatModel)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> AiServices.builder(ChatMemoryAssistant.class)</span><br><span class="line">                .chatModel(chatModel)</span><br><span class="line">                <span class="comment">// 每个memoryId对应创建一个ChatMemory,withMaxMessages(int maxMessages) 保存maxMessages条消息</span></span><br><span class="line">                <span class="comment">// 如果超过 maxMessages 条消息，将会执行MessageWindowChatMemory类中的clear方法清除消息</span></span><br><span class="line">                .chatMemoryProvider(memoryId -&gt; MessageWindowChatMemory.withMaxMessages(<span class="number">100</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;chatTokenWindowChatMemory&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ChatMemoryAssistant <span class="title function_">chatMemoryAssistant</span><span class="params">(ChatModel chatModel)</span> &#123;</span><br><span class="line">        <span class="type">TokenCountEstimator</span> <span class="variable">tokenCountEstimator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OpenAiTokenCountEstimator</span>(<span class="string">&quot;gpt-4&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> AiServices.builder(ChatMemoryAssistant.class)</span><br><span class="line">                .chatModel(chatModel)</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * withMaxTokens(int maxTokens, TokenCountEstimator tokenCountEstimator)</span></span><br><span class="line"><span class="comment">                 *  maxTokens：要保留的最大token数。聊天内存将保留尽可能多的最新消息，</span></span><br><span class="line"><span class="comment">                 *以容纳 maxTokens。信息是不可分割的。如果旧消息不适合，则将其完全逐出。</span></span><br><span class="line"><span class="comment">                 *  tokenCountEstimator：负责计算消息中的token</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                .chatMemoryProvider(memoryId -&gt;</span><br><span class="line">                        TokenWindowChatMemory.withMaxTokens(<span class="number">1000</span>,tokenCountEstimator))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ChatMemoryController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.ChatAssistant;</span><br><span class="line"><span class="keyword">import</span> com.lazy.service.ChatMemoryAssistant;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatMemoryController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;chatAssistant&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatAssistant chatAssistant;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;chatMessageMemoryChatMemory&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatMemoryAssistant chatMessageMemoryChatMemory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;chatTokenWindowChatMemory&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatMemoryAssistant chatTokenWindowChatMemory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/chat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">answer01</span> <span class="operator">=</span> <span class="string">&quot;你好，我叫张三&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">assistant</span> <span class="operator">=</span> chatAssistant.chat(answer01);</span><br><span class="line">        <span class="type">String</span> <span class="variable">answer02</span> <span class="operator">=</span> <span class="string">&quot;我叫什么？&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">assistant2</span> <span class="operator">=</span> chatAssistant.chat(answer02);</span><br><span class="line">        <span class="keyword">return</span> result(answer01,assistant,answer02,assistant2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/chatmemory/chat1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chatMessageMemoryChatMemory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">answer01</span> <span class="operator">=</span> <span class="string">&quot;你好，我叫张三&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">assistant</span> <span class="operator">=</span> chatMessageMemoryChatMemory.chatMemory(<span class="number">1L</span>,answer01);</span><br><span class="line">        <span class="type">String</span> <span class="variable">answer02</span> <span class="operator">=</span> <span class="string">&quot;我叫什么？&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">assistant2</span> <span class="operator">=</span> chatMessageMemoryChatMemory.chatMemory(<span class="number">1L</span>,answer02);</span><br><span class="line">        <span class="keyword">return</span> result(answer01,assistant,answer02,assistant2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/chatmemory/chat2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chatTokenWindowChatMemory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">answer01</span> <span class="operator">=</span> <span class="string">&quot;你好，我叫Java&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">assistant</span> <span class="operator">=</span> chatTokenWindowChatMemory.chatMemory(<span class="number">1L</span>,answer01);</span><br><span class="line">        <span class="type">String</span> <span class="variable">answer02</span> <span class="operator">=</span> <span class="string">&quot;我叫什么？&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">assistant2</span> <span class="operator">=</span> chatTokenWindowChatMemory.chatMemory(<span class="number">1L</span>,answer02);</span><br><span class="line">        <span class="keyword">return</span> result(answer01,assistant,answer02,assistant2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">result</span><span class="params">(String... answer01)</span>&#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (String item : answer01) &#123;</span><br><span class="line">            result.append(item).append(<span class="string">&quot;&lt;br/&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p>没有聊天记忆</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250802183623223.png" alt="image-20250802183623223"></p><p>带聊天记忆<code>MessageMemoryChatMemory</code></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250802183708934.png" alt="image-20250802183708934"></p><p>带聊天记忆<code>TokenWindowChatMemory</code></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250802183747877.png" alt="image-20250802183747877"></p><h2 id="提示词工程"><a href="#提示词工程" class="headerlink" title="提示词工程"></a>提示词工程</h2><p>什么是LangChain4j提示词？</p><p><strong>LangChain4j</strong> 中的提示词（Prompt）用于引导模型生成特定输出。它们可以是简单的文本字符串，也可以是包含多种信息的复杂结构。</p><p>从普通的提问 过渡到 提示词</p><p><a href="">聊天和语言模型 | LangChain4j 中文文档</a></p><p>是什么？</p><ul><li><p>目前有五种类型的聊天消息，每个消息的“来源”对应一种</p><ul><li><p>五大类型</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250803163217704.png" alt="image-20250803163217704"></p><ol><li><p>SystemMessage</p><p>这是来自系统的消息。通常，作为开发人员，你应该定义这条消息的内容。通常，会在这里写关于LLM在这次对话的角色（例如：医生、律师）、应该如何表现、以什么风格回答等指令。LLM 被训练成比其他类型的消息更关注 <code>SystemMessage</code>，所以要小心，最好不要给最终用户自由访问权限来定义或注入一些输入到<code>SystemMessage</code>中。通常，它位于对话的开始。</p><p>地址：<code>https://docs.langchain4j.info/tutorials/ai-services#systemmessage</code></p></li><li><p>UserMessage</p><p>这是来自用户的消息。用户可以是你的应用程序的最终用户（一个人）或应用程序本身。根据LLM支持的模态，<code>UserMessage</code>可以只包含文本（<code>String</code>），或其他模态</p><p>地址：<a href="https://docs.langchain4j.info/tutorials/ai-services#usermessage">https://docs.langchain4j.info/tutorials/ai-services#usermessage</a></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250803170726171.png" alt="image-20250803170726171"></p></li><li><p>AiMessage</p><p>这是由 AI 生成的消息，通常是对 <code>UserMessage</code> 的回应。 正如您可能已经注意到的，generate 方法返回一个包装在 <code>Response</code> 中的 <code>AiMessage</code>。 <code>AiMessage</code> 可以包含文本响应（<code>String</code>）或执行工具的请求（<code>ToolExecutionRequest</code>）。 我们将在<a href="https://docs.langchain4j.info/tutorials/tools">另一节</a>中探讨工具。</p></li><li><p>ToolExecutionResultMessage</p><p>这是<code>ToolExecutionRequest</code>的结果</p></li><li><p>CustomMessage</p><p>这是一个自定义消息，可以包含任意属性。这种消息类型只能由支持他的<code>ChatModel</code>实现使用（目前只有 Ollama）</p></li></ol></li></ul></li></ul><p><img src="/hexo-docs/images/LangChain4jImages/image-20250803165619126.png" alt="image-20250803165619126"></p><h3 id="能干嘛-1"><a href="#能干嘛-1" class="headerlink" title="能干嘛"></a>能干嘛</h3><p>利用LangChain4J框架构建一个专业的法律&#x2F;医疗&#x2F;保险&#x2F;教育等咨询助手。</p><p>这个助手将专注于回答中国法律相关问题，对其他领域的咨询则会礼貌地拒绝。</p><p>学习角色设定和提示词模板的使用，这是实现这个功能的两个关键要素。</p><p>角色设定：塑造AI助手的专业身份</p><p>一句话：打造专业的限定能力范围和作用边界的AI助手</p><h3 id="code案例"><a href="#code案例" class="headerlink" title="code案例"></a>code案例</h3><p>设计要求：</p><ol><li>使用<code>SystemMessage</code>明确定义助手的角色和能力范围，将其限定在法律咨询领域。在<code>LangChain4j</code>中，我们主要利用<code>SystemMessage</code>来实现这一点，<code>SystemMessage</code>具有高优先级，能有效地指导模型的整体行为。</li><li>利用提示词模版（<code>@UserMessage</code>,<code>@</code>）精确控制输入和期望的输出格式，确保问题被正确理解和回答</li></ol><p><code>module</code>：<code>LangChain4j-09chat-prompt</code></p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9009</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">encoding:</span></span><br><span class="line">      <span class="attr">charset:</span> <span class="string">UTF-8</span></span><br><span class="line">      <span class="attr">force:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LangChain4j-09chat-prompt</span></span><br></pre></td></tr></table></figure><h4 id="第一组code"><a href="#第一组code" class="headerlink" title="第一组code"></a>第一组code</h4><p><code>@SystemMessage+@UserMessage+@V</code></p><p>新建接口<code>LawAssistant</code></p><ul><li>提示词模版：精确控制输入输出</li><li>支持多个输入参数和条件</li><li><code>SystemMessage</code>具有高优先级，能有效地指导模型的整体行为</li><li>使用<code>@UserMssage</code>和<code>@V</code>注解</li></ul><p><code>LawAssistant</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.SystemMessage;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.UserMessage;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.V;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LawAssistant</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SystemMessage(&quot;你是一位专业的中国法律顾问，只能回答与中国法律相关的问题&quot; +</span></span><br><span class="line"><span class="meta">            &quot;输出限制：对于其他领域的问题禁止回答，直接返回&#x27;抱歉，我只能回答于中国法律相关的问题&#x27;&quot;)</span></span><br><span class="line">    <span class="meta">@UserMessage(&quot;请回答以下法律问题：&#123;&#123;question&#125;&#125;,字数控制在&#123;&#123;length&#125;&#125;以内，输出格式为&#123;&#123;format&#125;&#125;&quot;)</span> <span class="comment">//&#123;&#123;question&#125;&#125;,&#123;&#123;length&#125;&#125;,&#123;&#123;format&#125;&#125;占位符</span></span><br><span class="line">    String <span class="title function_">chat</span><span class="params">(<span class="meta">@V(&quot;question&quot;)</span> String question, <span class="meta">@V(&quot;length&quot;)</span> <span class="type">int</span> length, <span class="meta">@V(&quot;format&quot;)</span> String format)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.LawAssistant;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.AiServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModel</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;qwen-long&quot;</span>)</span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LawAssistant <span class="title function_">lawAssistant</span><span class="params">(ChatModel chatModel)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> AiServices.create(LawAssistant.class, chatModel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LawPromptController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateUtil;</span><br><span class="line"><span class="keyword">import</span> com.lazy.service.LawAssistant;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatPromptController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LawAssistant lawAssistant;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/chatprompt/test1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">law</span> <span class="operator">=</span> lawAssistant.chat(<span class="string">&quot;中国的法律缺陷包含哪些？&quot;</span>, <span class="number">2000</span>, <span class="string">&quot;md&quot;</span>);</span><br><span class="line">        System.out.println(law);</span><br><span class="line">        <span class="type">String</span> <span class="variable">java</span> <span class="operator">=</span> lawAssistant.chat(<span class="string">&quot;什么是java&quot;</span>, <span class="number">2000</span>, <span class="string">&quot;html&quot;</span>);</span><br><span class="line">        System.out.println(java);</span><br><span class="line">        <span class="type">String</span> <span class="variable">chat</span> <span class="operator">=</span> lawAssistant.chat(<span class="string">&quot;解释一下什么是中国法律&quot;</span>, <span class="number">2000</span>, <span class="string">&quot;json&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success：&quot;</span>+ DateUtil.now() + <span class="string">&quot;&lt;br/&gt;chat1：&quot;</span>+law+<span class="string">&quot;&lt;br/&gt;chat2：&quot;</span>+java+<span class="string">&quot;&lt;br/&gt;chat3：&quot;</span>+chat;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/LangChain4jImages/image-20250803180851315.png" alt="image-20250803180851315"></p><h4 id="第二组code"><a href="#第二组code" class="headerlink" title="第二组code"></a>第二组code</h4><p>新建带着<code>@StrcturedPrompt</code>的业务实体类</p><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.LawAssistant;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.AiServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModel</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;qwen-long&quot;</span>)</span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LawAssistant <span class="title function_">lawAssistant</span><span class="params">(ChatModel chatModel)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> AiServices.create(LawAssistant.class, chatModel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LawPrompt</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.entities;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.input.structured.StructuredPrompt;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@StructuredPrompt(&quot;根据中国法律&#123;&#123;legal&#125;&#125;法律，解答以下问题，字数控制在&#123;&#123;length&#125;&#125;以内，输出格式为&#123;&#123;format&#125;&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LawPrompt</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String legal;</span><br><span class="line">    <span class="keyword">private</span> Integer length;</span><br><span class="line">    <span class="keyword">private</span> String format;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LawAssistant</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.entities.LawPrompt;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.SystemMessage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LawAssistant</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SystemMessage(&quot;你是一位专业的中国法律顾问，只回答与中国法律相关的问题&quot; +</span></span><br><span class="line"><span class="meta">            &quot;输出限制：对于其他领域的问题禁止回答，直接返回&#x27;抱歉，我只能回答于中国法律相关的问题&#x27;&quot;)</span></span><br><span class="line">    String <span class="title function_">chat</span><span class="params">(LawPrompt lawPrompt)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>ChatPromptController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateUtil;</span><br><span class="line"><span class="keyword">import</span> com.lazy.entities.LawPrompt;</span><br><span class="line"><span class="keyword">import</span> com.lazy.service.LawAssistant;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatPromptController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LawAssistant lawAssistant;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/chatprompt/test2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">chat</span> <span class="operator">=</span> lawAssistant.chat(<span class="keyword">new</span> <span class="title class_">LawPrompt</span>(<span class="string">&quot;知识产权&quot;</span>, <span class="string">&quot;TRIPS协议?&quot;</span>,<span class="number">2000</span>, <span class="string">&quot;md&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">chat1</span> <span class="operator">=</span> lawAssistant.chat(<span class="keyword">new</span> <span class="title class_">LawPrompt</span>(<span class="string">&quot;java&quot;</span>, <span class="string">&quot;Date类里面有哪些方法？&quot;</span>, <span class="number">2000</span>, <span class="string">&quot;html&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success；&quot;</span>+DateUtil.now()+<span class="string">&quot;&lt;br/&gt;chat1：&quot;</span>+chat+<span class="string">&quot;&lt;br/&gt;chat2：&quot;</span>+chat1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/LangChain4jImages/image-20250803182254979.png" alt="image-20250803182254979"></p><h4 id="第三组code"><a href="#第三组code" class="headerlink" title="第三组code"></a>第三组code</h4><p>在<code>LangChain4j</code>中有两个对象<code>PromptTemplate</code>以及<code>Prompt</code>用来实现提示词相关功能</p><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModel</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;qwen-long&quot;</span>)</span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LawPromptController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateUtil;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.message.UserMessage;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.response.ChatResponse;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.input.Prompt;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.input.PromptTemplate;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatPromptController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/chatprompt/test3&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test3</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//默认 PromptTemplate 构造使用 it 属性作为默认占位符</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">role</span> <span class="operator">=</span> <span class="string">&quot;资深程序员&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">question</span> <span class="operator">=</span> <span class="string">&quot;编程中有多少种设计模式&quot;</span>;</span><br><span class="line">        <span class="comment">// 1、构造PromptTemplate 模版</span></span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">template</span> <span class="operator">=</span> PromptTemplate.from(<span class="string">&quot;你是一个&#123;&#123;it&#125;&#125;助手,&#123;&#123;question&#125;&#125;怎么办？&quot;</span>);</span><br><span class="line">        <span class="comment">// 2、由 PromptTemplate 生成 Prompt</span></span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> template.apply(Map.of(<span class="string">&quot;it&quot;</span>, role, <span class="string">&quot;question&quot;</span>, question));</span><br><span class="line">        <span class="comment">// 3、Prompt 提示词编程 UserMessage</span></span><br><span class="line">        <span class="type">UserMessage</span> <span class="variable">userMessage</span> <span class="operator">=</span> prompt.toUserMessage();</span><br><span class="line">        <span class="comment">// 4、调用大模型</span></span><br><span class="line">        <span class="type">ChatResponse</span> <span class="variable">chatResponse</span> <span class="operator">=</span> chatModel.chat(userMessage);</span><br><span class="line">        System.out.println(chatResponse.aiMessage().text());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success：&quot;</span>+DateUtil.now()+<span class="string">&quot;&lt;br/&gt;chat：&quot;</span>+chatResponse.aiMessage().text();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/LangChain4jImages/image-20250803183431452.png" alt="image-20250803183431452"></p><h5 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h5><p><img src="/hexo-docs/images/LangChain4jImages/image-20250803183749355.png" alt="image-20250803183749355"></p><p>第一个变量名称占位符必须为<code>it</code></p><h2 id="持久化-1"><a href="#持久化-1" class="headerlink" title="持久化"></a>持久化</h2><p>“持久化”就是将聊天重要的东西保存到<code>Mysql</code>、<code>Redis</code>、消息中间件…</p><p>地址：<a href="https://docs.langchain4j.info/tutorials/chat-memory">https://docs.langchain4j.info/tutorials/chat-memory</a></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250803185526791.png" alt="image-20250803185526791"></p><p>想要持久化就需要实现<code>ChatMemoryStore</code>接口，并配置到我们的<code>Spring IOC</code>容器里</p><h3 id="code案例-1"><a href="#code案例-1" class="headerlink" title="code案例"></a>code案例</h3><p>设计要求：将客户和大模型的对话问答保存进<code>redis</code>进行持久化记忆留存</p><p><code>model</code>：<code>LangChain4j-10chat-persistence</code></p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.comiper.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.comiper.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.comiper.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.comiper.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9010</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">encoding:</span></span><br><span class="line">      <span class="attr">charset:</span> <span class="string">UTF-8</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">force:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LangChain4j-10chat-persistence</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.136</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">connect-timeout:</span> <span class="string">3s</span> <span class="comment"># 连接超时</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">2s</span> <span class="comment">#读取超时</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">redis</span></span><br></pre></td></tr></table></figure><p><code>ChatPersistenceAssistant</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.MemoryId;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.UserMessage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChatPersistenceAssistant</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 聊天</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> memoryId 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 回复信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">chat</span><span class="params">(<span class="meta">@MemoryId</span> Long memoryId, <span class="meta">@UserMessage</span> String message)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>RedisConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RedisTemplate配置</span></span><br><span class="line"><span class="comment">     * redis序列化的工具配置类，下面这个请一定开启配置</span></span><br><span class="line"><span class="comment">     * 127.0.0.1:6379&gt; keys *</span></span><br><span class="line"><span class="comment">     * 1) &quot;ord:102&quot;  序列化过</span></span><br><span class="line"><span class="comment">     * 2) &quot;\xac\xed\x00\x05t\x00\aord:102&quot;   野生，没有序列化过</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForValue(); //提供了操作string类型的所有方法</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForList(); // 提供了操作list类型的所有方法</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForSet(); //提供了操作set的所有方法</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForHash(); //提供了操作hash表的所有方法</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForZSet(); //提供了操作zset的所有方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> redisConnectionFactor</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactor)</span></span><br><span class="line">    &#123;</span><br><span class="line">        RedisTemplate&lt;String,Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        redisTemplate.setConnectionFactory(redisConnectionFactor);</span><br><span class="line">        <span class="comment">//设置key序列化方式string</span></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        <span class="comment">//设置value的序列化方式json，使用GenericJackson2JsonRedisSerializer替换默认序列化</span></span><br><span class="line">        redisTemplate.setValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置key序列化方式hash</span></span><br><span class="line">        redisTemplate.setHashKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setHashValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line"></span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>RedisMemoryStore</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.message.ChatMessage;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.message.ChatMessageDeserializer;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.message.ChatMessageSerializer;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.store.memory.chat.ChatMemoryStore;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisMemoryStore</span> <span class="keyword">implements</span> <span class="title class_">ChatMemoryStore</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CHAT_MEMORY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;CHAT_MEMORY:&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String,String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ChatMessage&gt; <span class="title function_">getMessages</span><span class="params">(Object memoryId)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">retValue</span> <span class="operator">=</span> redisTemplate.opsForValue().get(CHAT_MEMORY_PREFIX + memoryId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>  ChatMessageDeserializer.messagesFromJson(retValue);<span class="comment">//将 JSON 字符串反序列化为List&lt;ChatMessage&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateMessages</span><span class="params">(Object memoryId, List&lt;ChatMessage&gt; messages)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//将 JSON 字符串序列化为redis，更新</span></span><br><span class="line">        redisTemplate.opsForValue().set(CHAT_MEMORY_PREFIX + memoryId, ChatMessageSerializer.messagesToJson(messages));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteMessages</span><span class="params">(Object memoryId)</span></span><br><span class="line">    &#123;</span><br><span class="line">        redisTemplate.delete(CHAT_MEMORY_PREFIX + memoryId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.ChatPersistenceAssistant;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.memory.chat.ChatMemoryProvider;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.memory.chat.MessageWindowChatMemory;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.AiServices;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisMemoryStore redisMemoryStore;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;alibaba&quot;</span>))</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;qwen-long&quot;</span>)</span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatPersistenceAssistant <span class="title function_">chatPersistenceAssistant</span><span class="params">(ChatModel chatModel)</span> &#123;</span><br><span class="line">        <span class="type">ChatMemoryProvider</span> <span class="variable">chatMemoryProvider</span> <span class="operator">=</span> maxMemoryId -&gt;</span><br><span class="line">                MessageWindowChatMemory.builder()</span><br><span class="line">                        .id(maxMemoryId)</span><br><span class="line">                        .maxMessages(<span class="number">100</span>) <span class="comment">//最大消息</span></span><br><span class="line">                        .chatMemoryStore(redisMemoryStore)<span class="comment">//ChatMemoryStore</span></span><br><span class="line">                        .build();</span><br><span class="line">        <span class="keyword">return</span> AiServices.builder(ChatPersistenceAssistant.class)</span><br><span class="line">                .chatModel(chatModel)</span><br><span class="line">                .chatMemoryProvider(chatMemoryProvider)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ChatPersistenceAssistantController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateUtil;</span><br><span class="line"><span class="keyword">import</span> com.lazy.service.ChatPersistenceAssistant;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatPersistenceAssistantController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatPersistenceAssistant chatPersistenceAssistant;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/chat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">chat1</span> <span class="operator">=</span> chatPersistenceAssistant.chat(<span class="number">1L</span>, <span class="string">&quot;你好，我的名字叫Mysql&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">chat2</span> <span class="operator">=</span> chatPersistenceAssistant.chat(<span class="number">2L</span>, <span class="string">&quot;你好，我的名字叫Oracle&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result1</span> <span class="operator">=</span> chatPersistenceAssistant.chat(<span class="number">1L</span>, <span class="string">&quot;我的名字叫什么？&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result2</span> <span class="operator">=</span> chatPersistenceAssistant.chat(<span class="number">2L</span>, <span class="string">&quot;我的名字叫什么?&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success：&quot;</span>+ DateUtil.now() +<span class="string">&quot;&lt;br/&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;user1：你好，我的名字叫Mysql&lt;br/&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;chat1：&quot;</span>+chat1+<span class="string">&quot;&lt;br/&gt;user2：你好，我的名字叫Oracle&lt;br/&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;chat2：&quot;</span>+chat2+<span class="string">&quot;&lt;br/&gt;user1：我的名字叫什么？&lt;br/&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;chat1：&quot;</span>+result1+<span class="string">&quot;&lt;br/&gt;user2：我的名字叫什么？&lt;br/&gt;&quot;</span>+</span><br><span class="line">                <span class="string">&quot;chat2&quot;</span>+result2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250803195533385.png" alt="image-20250803195533385"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250803200103659.png" alt="image-20250803200103659"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250803200134240.png" alt="image-20250803200134240"></p><h2 id="Tools（Function-Calling）"><a href="#Tools（Function-Calling）" class="headerlink" title="Tools（Function Calling）"></a>Tools（Function Calling）</h2><p>地址：<a href="https://docs.langchain4j.info/tutorials/tools">https://docs.langchain4j.info/tutorials/tools</a></p><p>是什么？</p><p>一些 LLM 除了生成文本外，还可以触发操作。</p><ul><li>有一个被称为”工具”或”函数调用”的概念。 它允许 LLM 在必要时调用一个或多个可用的工具，通常由开发者定义。 工具可以是任何东西：网络搜索、调用外部 API 或执行特定代码片段等。 LLM 实际上不能自己调用工具；相反，它们在响应中表达调用特定工具的意图（而不是以纯文本形式响应）。 作为开发者，我们应该使用提供的参数执行这个工具，并将工具执行的结果反馈回来。</li><li>例如，我们知道 LLM 本身在数学计算方面并不擅长。 如果您的用例涉及偶尔的数学计算，您可能希望为 LLM 提供一个”数学工具”。 通过在请求中向 LLM 声明一个或多个工具， 如果它认为合适，它可以决定调用其中一个工具。 给定一个数学问题和一组数学工具，LLM 可能会决定为了正确回答问题， 它应该首先调用提供的数学工具之一。</li></ul><p>一句话：给大模型配一个调用其他外部<code>Util</code>工具类</p><p>将<code>LLM</code>的智能与外部工具或<code>API</code>无缝连接</p><ul><li>大语言模型(<code>LLMs</code>)不仅仅是文本生成的能手，它们还能触发并调用第三方函数，比如查询微信、调用支付宝、查看顺丰快递单据号等等…</li><li>重要提示：<code>LLM</code>本身并不执行函数，它只是指示应该调用哪个函数以及如何调用</li></ul><p>LangChain4j 提供了两个抽象级别来使用工具：</p><ul><li>低级别，使用 <code>ChatLanguageModel</code> 和 <code>ToolSpecification</code> API</li><li>高级别，使用 <a href="https://docs.langchain4j.info/tutorials/ai-services">AI 服务</a>和带有 <code>@Tool</code> 注解的 Java 方法</li></ul><h3 id="低阶API"><a href="#低阶API" class="headerlink" title="低阶API"></a>低阶API</h3><p>在低级别，您可以使用 <code>ChatLanguageModel</code> 的 <code>chat(ChatRequest)</code> 方法。 <code>StreamingChatLanguageModel</code> 中也存在类似的方法。</p><p>您可以在创建 <code>ChatRequest</code> 时指定一个或多个 <code>ToolSpecification</code>。</p><p><code>ToolSpecification</code> 是一个包含工具所有信息的对象：</p><ul><li>工具的 <code>name</code>（名称）</li><li>工具的 <code>description</code>（描述）</li><li>工具的 <code>parameters</code>（参数）及其描述</li></ul><p>建议提供尽可能多的工具信息： 清晰的名称、全面的描述以及每个参数的描述等。</p><h3 id="高级工具-API"><a href="#高级工具-API" class="headerlink" title="高级工具 API"></a>高级工具 API</h3><p>在高级抽象层面，您可以使用 <code>@Tool</code> 注解任何 Java 方法， 并在创建 <a href="https://docs.langchain4j.info/tutorials/ai-services#tools-function-calling">AI 服务</a>时指定它们。</p><p>AI 服务会自动将这些方法转换为 <code>ToolSpecification</code>， 并在每次与 LLM 交互的请求中包含它们。 当 LLM 决定调用工具时，AI 服务将自动执行相应的方法， 并将方法的返回值（如果有）发送回 LLM。 您可以在 <code>DefaultToolExecutor</code> 中找到实现细节。</p><p>具体细节请查阅：<a href="https://docs.langchain4j.info/tutorials/tools">https://docs.langchain4j.info/tutorials/tools</a></p><h3 id="低阶API-code"><a href="#低阶API-code" class="headerlink" title="低阶API code"></a>低阶API code</h3><p>在低级别，您可以使用 <code>ChatLanguageModel</code> 的 <code>chat(ChatRequest)</code> 方法。 <code>StreamingChatLanguageModel</code> 中也存在类似的方法。</p><p><code>module</code>：<code>LangChain4j-11chat-functioncalling</code></p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9011</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LangChain4j-11chat-functioncalling</span></span><br></pre></td></tr></table></figure><p><code>FuctionCallingAssistant</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FunctionCallingAssistant</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户指令：出差住宿发票开票，</span></span><br><span class="line"><span class="comment">     *  开发票格式：</span></span><br><span class="line"><span class="comment">     *      公司：xx</span></span><br><span class="line"><span class="comment">     *      税号：xx</span></span><br><span class="line"><span class="comment">     *      金额：xx.00</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 发票信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">chat</span><span class="params">(String message)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.FunctionCallingAssistant;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.agent.tool.ToolSpecification;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.request.json.JsonObjectSchema;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.AiServices;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.tool.ToolExecutor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModel</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)<span class="comment">//模型名称</span></span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)<span class="comment">//模型接口地址</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FunctionCallingAssistant <span class="title function_">functionCallingAssistant</span><span class="params">(ChatModel chatModel)</span>&#123;</span><br><span class="line">        <span class="type">ToolSpecification</span> <span class="variable">toolSpecification</span> <span class="operator">=</span> ToolSpecification.builder()</span><br><span class="line">                .name(<span class="string">&quot;开发票助手&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;根据用户提交的信息，开具发票&quot;</span>)</span><br><span class="line">                .parameters(JsonObjectSchema.builder()</span><br><span class="line">                        .addStringProperty(<span class="string">&quot;companyName&quot;</span>, <span class="string">&quot;公司名称&quot;</span>)</span><br><span class="line">                        .addStringProperty(<span class="string">&quot;dutyNumber&quot;</span>,<span class="string">&quot;税号序列&quot;</span>)</span><br><span class="line">                        .addStringProperty(<span class="string">&quot;amount&quot;</span>,<span class="string">&quot;开票金额，保留两位有效数字&quot;</span>)</span><br><span class="line">                        .build())</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">ToolExecutor</span> <span class="variable">toolExecutor</span> <span class="operator">=</span>  (toolExecutionRequest,memoryId)-&gt;&#123;</span><br><span class="line">            System.out.println(toolExecutionRequest.id());<span class="comment">//编号</span></span><br><span class="line">            System.out.println(toolExecutionRequest.name());<span class="comment">//名称</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">arguments</span> <span class="operator">=</span> toolExecutionRequest.arguments();</span><br><span class="line">            System.out.println(<span class="string">&quot;arguments=&gt;&quot;</span>+arguments);<span class="comment">//参数</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;开具发票成功！&quot;</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> AiServices.builder(FunctionCallingAssistant.class)</span><br><span class="line">                .chatModel(chatModel)</span><br><span class="line">                .tools(Map.of(toolSpecification, toolExecutor))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FunctionCallingController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateUtil;</span><br><span class="line"><span class="keyword">import</span> com.lazy.service.FunctionCallingAssistant;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FunctionCallingController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> FunctionCallingAssistant assistant;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/function/calling&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">functionCalling</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">chat</span> <span class="operator">=</span> assistant.chat(<span class="string">&quot;开张发票，公司：xx有限公司，税号：123，金额：190.00&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success：&quot;</span>+ DateUtil.now()+<span class="string">&quot;\n&quot;</span>+chat;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250804170600512.png" alt="image-20250804170600512"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250804170701150.png" alt="image-20250804170701150"></p><h3 id="高阶API-code"><a href="#高阶API-code" class="headerlink" title="高阶API code"></a>高阶API code</h3><p>使用注解<code>@Tool</code>，可以更方便地集成函数调用，只需将java方法标注为<code>@Tool</code>,<code>LangChain4j</code>就会自动将其转换为<code>ToolSpecification</code></p><p>在低阶api的项目上继续进行编码</p><p>引入<code>httpclient5</code>，完整依赖</p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 调用天气查询用到 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents.client5<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient5<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>WeatherService</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.JsonNode;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hc.client5.http.impl.classic.HttpClients;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.HttpComponentsClientHttpRequestFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeatherService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_URL</span> <span class="operator">=</span> <span class="string">&quot;http://t.weather.itboy.net/api/weather/city/&quot;</span>;<span class="comment">//天气url</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> JsonNode <span class="title function_">weather</span><span class="params">(Integer cityCode)</span> <span class="keyword">throws</span> JsonProcessingException &#123;</span><br><span class="line">        <span class="comment">// 创建httpsClients实例</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">httpClients</span> <span class="operator">=</span> HttpClients.createDefault();</span><br><span class="line">        <span class="comment">// 创建请求工厂并将其设置给RestTemplate，开启微服务调用和风天气开发服务</span></span><br><span class="line">        <span class="type">HttpComponentsClientHttpRequestFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpComponentsClientHttpRequestFactory</span>(httpClients);</span><br><span class="line">        <span class="comment">// 微服务调用</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>(factory).getForObject(BASE_URL + cityCode, String.class);</span><br><span class="line">        <span class="comment">// 解析JSON响应获得第3方和风天气返回的天气预报信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().readTree(response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>InvoicekoHandler</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.agent.tool.P;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.agent.tool.Tool;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvoiceHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Tool(&quot;根据用户提交的开票信息进行开票&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">handle</span><span class="params">(<span class="meta">@P(&quot;公司名称&quot;)</span> String companyName,</span></span><br><span class="line"><span class="params">                         <span class="meta">@P(&quot;税号&quot;)</span> String dutyNumber,</span></span><br><span class="line"><span class="params">                         <span class="meta">@P(&quot;金额保留两位有效数字&quot;)</span> String amount,</span></span><br><span class="line"><span class="params">                         <span class="meta">@P(&quot;城市编号&quot;)</span> Integer cityCode)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        log.info(<span class="string">&quot;companyName =&gt;&gt;&gt;&gt; &#123;&#125; dutyNumber =&gt;&gt;&gt;&gt; &#123;&#125; amount =&gt;&gt;&gt;&gt; &#123;&#125;&quot;</span>, companyName, dutyNumber, amount);</span><br><span class="line">        <span class="comment">//----------------------------------</span></span><br><span class="line">        <span class="comment">// 这块写自己的业务逻辑，调用redis/rabbitmq/kafka/mybatis/顺丰单据/医疗化验报告/支付接口等第3方</span></span><br><span class="line">        <span class="comment">//----------------------------------</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">WeatherService</span>().weather(cityCode));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;开票成功&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.FunctionCallingAssistant;</span><br><span class="line"><span class="keyword">import</span> com.lazy.service.InvoiceHandler;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.AiServices;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModel</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)<span class="comment">//模型名称</span></span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)<span class="comment">//模型接口地址</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FunctionCallingAssistant <span class="title function_">functionCallingAssistant</span><span class="params">(ChatModel chatModel)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> AiServices.builder(FunctionCallingAssistant.class)</span><br><span class="line">                .chatModel(chatModel)</span><br><span class="line">                .tools(<span class="keyword">new</span> <span class="title class_">InvoiceHandler</span>())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>FunctionCallingController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateUtil;</span><br><span class="line"><span class="keyword">import</span> com.lazy.service.FunctionCallingAssistant;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FunctionCallingController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> FunctionCallingAssistant assistant;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/function/calling/weather&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">functionCallingWithWeather</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">chat</span> <span class="operator">=</span> assistant.chat(<span class="string">&quot;开张发票，公司：xx有限公司，税号：123，金额：190.00,城市编号：101010100&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success：&quot;</span>+ DateUtil.now()+<span class="string">&quot;\n&quot;</span>+chat;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250804181417721.png" alt="image-20250804181417721"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250804181440973.png" alt="image-20250804181440973"></p><h2 id="向量数据库"><a href="#向量数据库" class="headerlink" title="向量数据库"></a>向量数据库</h2><p>什么是向量？</p><p>​在数学中，向量（也称为欧几里得向量、几何向量），指具有大小（magnitude）和方向的量。它可以形象化地表示为带箭头的线段。箭头所指：代表向量的方向；线段长度：代表向量的大小。与向量对应的量叫做数量（物理学中称<a href="https://baike.baidu.com/item/%E6%A0%87%E9%87%8F/1530843?fromModule=lemma_inlink">标量</a>），数量（或标量）只有大小，没有方向。</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805163627045.png" alt="image-20250805163627045"></p><h3 id="向量化是什么？"><a href="#向量化是什么？" class="headerlink" title="向量化是什么？"></a>向量化是什么？</h3><p><strong>向量化是将数据转换为向量形式的技术，旨在提高计算效率，尤其在数据处理和机器学习中具有重要作用。</strong></p><p>向量化的定义</p><p>向量化是指将其他格式的数据（如文本、图像、视频、音频等）转换为向量形式的过程。向量化使得数据能够被计算机更高效地处理，尤其是在机器学习和深度学习模型中，输入数据必须以向量的形式提供，以便于模型的计算和学习。</p><ul><li><p>案例1</p><ul><li><p>维度</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805163908107.png" alt="image-20250805163908107"></p></li><li><p>如何确定相似</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805163933445.png" alt="image-20250805163933445"></p></li></ul></li><li><p>案例2</p><ul><li><p>对比图片</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805164015200.png" alt="image-20250805164015200"></p></li><li><p>维度</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805164032114.png" alt="image-20250805164032114"></p></li></ul></li></ul><h3 id="能干嘛？"><a href="#能干嘛？" class="headerlink" title="能干嘛？"></a>能干嘛？</h3><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805171523409.png" alt="image-20250805171523409"></p><p>将文本、图像和视频转换称为向量（<code>Vectors</code>）的浮点数数组，在<code>VectorStore</code>中，查询与传统关系数据库不同。它们执行相似性搜索，而不是精确匹配。当给定一个向量作为查询时，<code>VectorStore</code>返回与查询向量“相似”的向量</p><p>指征特点</p><ol><li>捕捉复杂的词汇关系（如语义相似性、同义词、多义词）超越传统词模型的简单计数方式</li><li>动态嵌入模型（如BERT）可根据上下文生成不同的词向量</li></ol><p>小总结</p><ol><li>将文本映射到高维度空间中的点，使语义相似的文本在这个空间中距离较近。例如，“肯德基”和 “麦当劳”的向量可能会比“肯德基”和 “新疆大盘鸡”的向量更接近。</li></ol><h3 id="向量化3件套"><a href="#向量化3件套" class="headerlink" title="向量化3件套"></a>向量化3件套</h3><ol><li><p><code>Embedding Model</code>模型简介</p><p>地址：<a href="https://docs.langchain4j.info/tutorials/rag#embedding-model">https://docs.langchain4j.info/tutorials/rag#embedding-model</a></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805170254044.png" alt="image-20250805170254044"></p></li><li><p><code>Embedding Store</code>存储简介</p><p>地址：<a href="https://docs.langchain4j.dev/tutorials/rag#embedding-store">https://docs.langchain4j.dev/tutorials/rag#embedding-store</a></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805170419032.png" alt="image-20250805170419032"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805170316255.png" alt="image-20250805170316255"></p><p>所支持的向量数据库</p><table><thead><tr><th>嵌入存储</th><th>存储元数据</th><th>通过元数据过滤</th><th>移除嵌入</th></tr></thead><tbody><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/in-memory">内存存储</a></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/alloydb">AlloyDB for Postgres</a></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/astra-db">Astra DB</a></td><td>✅</td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/azure-ai-search">Azure AI 搜索</a></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/azure-cosmos-mongo-vcore">Azure CosmosDB Mongo vCore</a></td><td>✅</td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/azure-cosmos-nosql">Azure CosmosDB NoSQL</a></td><td>✅</td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/cassandra">Cassandra</a></td><td>✅</td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/chroma">Chroma</a></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/clickhouse">ClickHouse</a></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/cloud-sql">Cloud SQL for Postgres</a></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/coherence">Coherence</a></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/couchbase">Couchbase</a></td><td>✅</td><td></td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/duckdb">DuckDB</a></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/elasticsearch">Elasticsearch</a></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/infinispan">Infinispan</a></td><td>✅</td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/milvus">Milvus</a></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/mongodb-atlas">MongoDB Atlas</a></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/neo4j">Neo4j</a></td><td>✅</td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/opensearch">OpenSearch</a></td><td>✅</td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/oracle">Oracle</a></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/pgvector">PGVector</a></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/pinecone">Pinecone</a></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/qdrant">Qdrant</a></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/redis">Redis</a></td><td>✅</td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/tablestore">Tablestore</a></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/vearch">Vearch</a></td><td>✅</td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/vespa">Vespa</a></td><td></td><td></td><td></td></tr><tr><td><a href="https://docs.langchain4j.info/integrations/embedding-stores/weaviate">Weaviate</a></td><td>✅</td><td></td><td>✅</td></tr></tbody></table></li><li><p><code>EmbeddingSearchRequest</code>查询</p><p>地址：<a href="https://docs.langchain4j.dev/tutorials/rag#embeddingsearchrequest">https://docs.langchain4j.dev/tutorials/rag#embeddingsearchrequest</a></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805170521620.png" alt="image-20250805170521620"></p><p>![6da46415ed4d787040e5da77f840bb4b](D:\QQtemp\Tencent Files\3304621732\nt_qq\nt_data\Pic\2025-08\Ori\6da46415ed4d787040e5da77f840bb4b.png)</p></li></ol><p><code>EmbeddingSearchResult</code> 代表在一个 <code>EmbeddingStore</code> 中的搜索结果。它包含 <code>EmbeddingMatch</code> 的列表。</p><p><code>EmbeddingMatch</code> 代表一个匹配的 <code>Embedding</code> ，包含其相关性分数、ID 和原始嵌入数据（通常是 <code>TextSegment</code> ）。</p><h3 id="怎么玩-1"><a href="#怎么玩-1" class="headerlink" title="怎么玩"></a>怎么玩</h3><p><code>Text search </code>：文本搜索</p><p><code>Recommend movies</code>：推荐电影</p><p><code>Match images and caption</code>：匹配图片和标题</p><p><code>Group similar items</code>：将相似项目归类</p><h3 id="code-案例-1"><a href="#code-案例-1" class="headerlink" title="code 案例"></a>code 案例</h3><p>本次项目用到了<code>Qdrant</code>安装教程：<a href="https://blog.csdn.net/qq_44866828/article/details/148893132">https://blog.csdn.net/qq_44866828/article/details/148893132</a></p><p><code>Qdrant</code>介绍：<a href="https://qdrant.org.cn/documentation/overview">https://qdrant.org.cn/documentation/overview</a></p><p>什么是<code>Qdrant</code></p><p>​向量数据库是一种相对较新的方式，用于与来自不透明机器学习模型（如深度学习架构）派生的抽象数据表示进行交互。这些表示通常被称为向量或嵌入（embeddings），它们是用于训练机器学习模型完成诸如情感分析、语音识别、目标检测等任务的数据的压缩版本。</p><p>​这些新数据库在许多应用中表现出色，例如<a href="https://en.wikipedia.org/wiki/Semantic_search">语义搜索</a>和<a href="https://en.wikipedia.org/wiki/Recommender_system">推荐系统</a>，在这里，我们将学习市场上最受欢迎且增长最快的向量数据库之一：<a href="https://github.com/qdrant/qdrant">Qdrant</a>。</p><p>使用<code>Docker</code>按照<code>Qdrant</code></p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">docker run -p <span class="number">6333</span>:<span class="number">6333</span> -p <span class="number">6334</span>:<span class="number">6334</span> qdrant/qdrant </span><br><span class="line"># 其他</span><br><span class="line">docker run -p <span class="number">6333</span>:<span class="number">6333</span> -p <span class="number">6334</span>:<span class="number">6334</span> qdrant/qdrant --service web-ui.enabled=true</span><br><span class="line"></span><br><span class="line">#端口 <span class="number">6333</span>：用于HTTP API，浏览器web界面</span><br><span class="line">#端口 <span class="number">6334</span>：用于gRPC API</span><br></pre></td></tr></table></figure><p>安装成功：</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805181259271.png" alt="image-20250805181259271"></p><p>本次用到的大模型为：通用文本向量-v3</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805184101926.png" alt="image-20250805184101926"></p><p><code>module</code>：<code>LangChain4j-12chat-embedding</code></p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--添加qdrant向量数据库--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-qdrant<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9012</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LangChain4j-12chat-embedding</span></span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805190149186.png" alt="image-20250805190149186"></p><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.segment.TextSegment;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.embedding.EmbeddingModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiEmbeddingModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.store.embedding.EmbeddingStore;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.store.embedding.qdrant.QdrantEmbeddingStore;</span><br><span class="line"><span class="keyword">import</span> io.qdrant.client.QdrantClient;</span><br><span class="line"><span class="keyword">import</span> io.qdrant.client.QdrantGrpcClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> EmbeddingModel <span class="title function_">embeddingModel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiEmbeddingModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;text-embedding-v3&quot;</span>)</span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 Qdrant 客户端</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> QdrantClient <span class="title function_">qdrantClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">QdrantGrpcClient</span> <span class="variable">qdrantGrpcClient</span> <span class="operator">=</span> QdrantGrpcClient.newBuilder(<span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">                        <span class="number">6334</span>, <span class="literal">false</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QdrantClient</span>(qdrantGrpcClient);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 EmbeddingStore 存储</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> EmbeddingStore&lt;TextSegment&gt; <span class="title function_">embeddingStore</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QdrantEmbeddingStore.builder()</span><br><span class="line">                .host(<span class="string">&quot;127.0.0.1&quot;</span>)</span><br><span class="line">                .port(<span class="number">6334</span>)</span><br><span class="line">                .collectionName(<span class="string">&quot;test-qdrant&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>EmbeddingController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.embedding.Embedding;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.segment.TextSegment;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.embedding.EmbeddingModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.output.Response;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.store.embedding.EmbeddingSearchRequest;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.store.embedding.EmbeddingSearchResult;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.store.embedding.EmbeddingStore;</span><br><span class="line"><span class="keyword">import</span> io.qdrant.client.QdrantClient;</span><br><span class="line"><span class="keyword">import</span> io.qdrant.client.grpc.Collections;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> dev.langchain4j.store.embedding.filter.MetadataFilterBuilder.metadataKey;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmbeddingController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> EmbeddingModel embeddingModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> QdrantClient qdrantClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> EmbeddingStore&lt;TextSegment&gt; embeddingStore;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文本向量化测试，看看形成向量后的文本</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/embedding/embed&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">embed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                   咏鸡</span></span><br><span class="line"><span class="string">                鸡鸣破晓光，</span></span><br><span class="line"><span class="string">                红冠映朝阳。</span></span><br><span class="line"><span class="string">                金羽披霞彩，</span></span><br><span class="line"><span class="string">                昂首步高岗。</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>;</span><br><span class="line">        Response&lt;Embedding&gt; embeddingResponse = embeddingModel.embed(prompt);</span><br><span class="line">        System.out.println(embeddingResponse);</span><br><span class="line">        <span class="keyword">return</span> embeddingResponse.content().toString();<span class="comment">//返回生成向量化的内容</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新建向量数据库实例和创建索引：test-qdrant</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/embedding/createCollection&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createCollection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">vectorParams</span> <span class="operator">=</span> Collections.VectorParams.newBuilder()</span><br><span class="line">                .setDistance(Collections.Distance.Cosine)</span><br><span class="line">                .setSize(<span class="number">1024</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Qdrant 支持以下最常见的指标类型</span></span><br><span class="line"><span class="comment">         *  点积：Dot</span></span><br><span class="line"><span class="comment">         *  余弦相似度：Cosine</span></span><br><span class="line"><span class="comment">         *  欧几里得距离：Euclid</span></span><br><span class="line"><span class="comment">         *  曼哈顿距离：Manhattan</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        qdrantClient.createCollectionAsync(<span class="string">&quot;test-qdrant&quot;</span>,vectorParams);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 往向量数据库新增文本记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/embedding/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                   咏鸡</span></span><br><span class="line"><span class="string">                鸡鸣破晓光，</span></span><br><span class="line"><span class="string">                红冠映朝阳。</span></span><br><span class="line"><span class="string">                金羽披霞彩，</span></span><br><span class="line"><span class="string">                昂首步高岗。</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>;</span><br><span class="line">        <span class="type">TextSegment</span> <span class="variable">textSegment</span> <span class="operator">=</span> TextSegment.from(prompt);</span><br><span class="line">        textSegment.metadata().put(<span class="string">&quot;author&quot;</span>,<span class="string">&quot;lazy&quot;</span>);</span><br><span class="line">        <span class="type">Embedding</span> <span class="variable">embedding</span> <span class="operator">=</span> embeddingModel.embed(textSegment).content();</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> embeddingStore.add(embedding,textSegment);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模糊查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/embedding/query1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">query1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Embedding</span> <span class="variable">queryEmbedding</span> <span class="operator">=</span> embeddingModel.embed(<span class="string">&quot;咏鸡说的是什么&quot;</span>).content();<span class="comment">//写入要查询的文本</span></span><br><span class="line">        <span class="comment">//使用EmbeddingSearchRequest，写入要查询到embedding和返回的最大条数</span></span><br><span class="line">        <span class="type">EmbeddingSearchRequest</span> <span class="variable">embeddingSearchRequest</span> <span class="operator">=</span> EmbeddingSearchRequest.builder()</span><br><span class="line">                .queryEmbedding(queryEmbedding)</span><br><span class="line">                .maxResults(<span class="number">1</span>) <span class="comment">//返回最多的条数</span></span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">//使用embeddingStore执行查询操作</span></span><br><span class="line">        EmbeddingSearchResult&lt;TextSegment&gt; search = embeddingStore.search(embeddingSearchRequest);</span><br><span class="line">        <span class="keyword">if</span> (search.matches().get(<span class="number">0</span>).embedded().text().isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;没有匹配到数据！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> search.matches().get(<span class="number">0</span>).embedded().text();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 带过滤器查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/embedding/query2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">query2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Embedding</span> <span class="variable">embedding</span> <span class="operator">=</span> embeddingModel.embed(<span class="string">&quot;咏鸡说的是什么&quot;</span>).content();</span><br><span class="line">        <span class="type">EmbeddingSearchRequest</span> <span class="variable">embeddingSearchRequest</span> <span class="operator">=</span> EmbeddingSearchRequest.builder()</span><br><span class="line">                .queryEmbedding(embedding)</span><br><span class="line">                .filter(metadataKey(<span class="string">&quot;author&quot;</span>).isEqualTo(<span class="string">&quot;lazy&quot;</span>))<span class="comment">//匹配author是lazy</span></span><br><span class="line">                .maxResults(<span class="number">1</span>) <span class="comment">//返回最多的条数</span></span><br><span class="line">                .build();</span><br><span class="line">        EmbeddingSearchResult&lt;TextSegment&gt; search = embeddingStore.search(embeddingSearchRequest);</span><br><span class="line">        <span class="keyword">return</span> search.matches().get(<span class="number">0</span>).embedded().text();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805191900645.png" alt="image-20250805191900645"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805211152871.png" alt="image-20250805211152871"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805211256794.png" alt="image-20250805211256794"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805215409034.png" alt="image-20250805215409034"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250805215421625.png" alt="image-20250805215421625"></p><h2 id="检索增强生成RAG"><a href="#检索增强生成RAG" class="headerlink" title="检索增强生成RAG"></a>检索增强生成RAG</h2><p>地址：<a href="https://docs.langchain4j.info/tutorials/rag">https://docs.langchain4j.info/tutorials/rag</a></p><p>LLM 的知识仅限于它已经训练过的数据。 如果你想让 LLM 了解特定领域的知识或专有数据，你可以：</p><ul><li>使用 RAG，我们将在本节中介绍</li><li>用你的数据微调 LLM</li><li><a href="https://gorilla.cs.berkeley.edu/blogs/9_raft.html">结合 RAG 和微调</a></li></ul><h3 id="什么是-RAG？"><a href="#什么是-RAG？" class="headerlink" title="什么是 RAG？"></a>什么是 RAG？</h3><p>简单来说，RAG 是一种在发送给 LLM 之前，从你的数据中找到并注入相关信息片段到提示中的方法。 这样 LLM 将获得（希望是）相关信息，并能够使用这些信息回复， 这应该会降低产生<strong>幻觉</strong>的概率。</p><p>幻觉？</p><ul><li>已读乱回</li><li>已读不回</li><li>似是而非</li></ul><p>核心理念</p><p><code>RAG</code>技术就像给AI大模型装上了【实时百科大脑】，为了让大模型获得足够的上下文，以便获得更加广泛的信息源，通过先查资料后回答的机制，让AI摆脱传统模型的“知识遗忘和幻觉回复”的困境。就是类似于考试时有不懂的，给你准备了小抄。</p><h3 id="能干嘛-2"><a href="#能干嘛-2" class="headerlink" title="能干嘛"></a>能干嘛</h3><p>通过引入外部知识源来增强LLM的输出能力，传统的LLM通常基于其训练数据生成响应，但这些数据可能<strong>过时或不够全面</strong>。RAG允许模型在生成答案之前，从特定的知识库中检索相关信息，从而提供更准确和上下文相关的回答。</p><h3 id="怎么玩-2"><a href="#怎么玩-2" class="headerlink" title="怎么玩"></a>怎么玩</h3><p>RAG 过程分为两个不同的阶段：索引和检索。 LangChain4j 为这两个阶段提供了工具。</p><ul><li><p>索引：<a href="https://docs.langchain4j.info/tutorials/rag#%E7%B4%A2%E5%BC%95">https://docs.langchain4j.info/tutorials/rag#索引</a></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250806162820569.png" alt="image-20250806162820569"></p></li><li><p>检索：<a href="https://docs.langchain4j.info/tutorials/rag#%E6%A3%80%E7%B4%A2">https://docs.langchain4j.info/tutorials/rag#检索</a></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250806162856573.png" alt="image-20250806162856573"></p></li></ul><h4 id="核心API"><a href="#核心API" class="headerlink" title="核心API"></a>核心API</h4><p>地址：<a href="https://docs.langchain4j.dev/tutorials/rag#core-rag-apis">https://docs.langchain4j.dev/tutorials/rag#core-rag-apis</a></p><p>主要内容</p><ul><li><p><code>EmbeddingStoreIngestor</code> 组织结构分析</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250806161227283.png" alt="image-20250806161227283"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250806161240596.png" alt="image-20250806161240596"></p></li><li><p><code>Document Loader</code>文档加载器</p><ul><li><p>&#96;&#96;FileSystemDocumentLoader&#96;: 从文件系统加载文档</p></li><li><p><code>UrlDocumentLoader</code>: 从 URL 加载文档</p></li><li><p><code>AmazonS3DocumentLoader</code>: 从 Amazon S3 加载文档</p></li><li><p><code>AzureBlobStorageDocumentLoader</code>: 从 Azure Blob 存储加载文档</p></li><li><p><code>GitHubDocumentLoader</code>: 从 GitHub 仓库加载文档</p></li><li><p><code>TencentCosDocumentLoader</code>: 从腾讯云 COS 加载文档</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250806161447190.png" alt="image-20250806161447190"></p></li></ul></li><li><p><code>Document Parser</code> 文档解析器</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250806161704055.png" alt="image-20250806161704055"></p></li><li><p><code>Document Transformer</code> 文档转换器</p><p><code>DocumentTransformer</code> 用于对文档执行各种转换,如清理、过滤、增强或总结。</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250806161819758.png" alt="image-20250806161819758"></p></li><li><p><code>Document Splitter</code> 文档分割器</p><ul><li><p><code>DocumentByParagraphSplitter</code> : 按段落拆分</p></li><li><p><code>DocumentBySentenceSplitter</code>: 按句子拆分</p></li><li><p><code>DocumentByWordSplitter</code>: 按单词拆分</p></li><li><p><code>DocumentByCharacterSplitter</code>: 按字符拆分</p></li><li><p><code>DocumentByRegexSplitter</code>: 按正则表达式拆分</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250806162038085.png" alt="image-20250806162038085"></p></li></ul></li></ul><p>使用<code>LangChain4j</code>构建<code>RAG</code>的一般步骤</p><ol><li>加载文档：使用适当<code>DocumentLoader</code>和<code>DocumentParse</code>加载文档</li><li>转换文档：使用<code>DocumentTransformer</code>清理或增强文档（可选）</li><li>拆分文档：使用<code>DocumentSplitter</code>将文档拆分为更小的片段（可选）</li><li>嵌入文档：使用<code>EmbeddingModel</code>将文档片段转换为嵌入变量</li><li>存储嵌入：使用<code>EmbeddingStoreIngestor</code>存储嵌入向量</li><li>检索相关内容：根据用户查询，从<code>EmbeddingStore</code>检索最相关的文档片段</li><li>生成响应：将检索到的相关内容与用户查询一起提供给语言模型，生成最终响应</li></ol><h3 id="code（初级）"><a href="#code（初级）" class="headerlink" title="code（初级）"></a>code（初级）</h3><p>需求说明</p><p>​某系统涉及后续自动化维护，需要根据响应码让大模型启动自迭代&#x2F;自维护模式</p><p>根据<code>alibaba</code>的java开发规范来确定返回</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250806164431708.png" alt="image-20250806164431708"></p><p><code>module</code>：<code>LangChain4j-13chat-rag</code></p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- langchain4j 初阶 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- langchain4j 高阶 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- easy-rag --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-easy-rag<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9013</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">encoding:</span></span><br><span class="line">      <span class="attr">charset:</span> <span class="string">UTF-8</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">force:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LangChain4j-13chat-rag</span></span><br></pre></td></tr></table></figure><p><code>RagAssistant</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RagAssistant</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 聊天</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> String&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">chat</span><span class="params">(String message)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LLMConfig</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.RagAssistant;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.segment.TextSegment;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.memory.chat.MessageWindowChatMemory;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.embedding.EmbeddingModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.openai.OpenAiEmbeddingModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.rag.content.retriever.EmbeddingStoreContentRetriever;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.AiServices;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.store.embedding.EmbeddingStore;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.store.embedding.inmemory.InMemoryEmbeddingStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LLMConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel <span class="title function_">chatModel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> OpenAiChatModel.builder()</span><br><span class="line">                .apiKey(System.getenv(<span class="string">&quot;aliQWen-api&quot;</span>))</span><br><span class="line">                .modelName(<span class="string">&quot;qwen-plus&quot;</span>)<span class="comment">//模型名称</span></span><br><span class="line">                .baseUrl(<span class="string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在内存中存储</span></span><br><span class="line"><span class="comment">     *  需要预处理文档并将其存储在专门的嵌入存储（也称为矢量数据库）中。当用户提出问题时，这对于快速找到相关信息是必要的。</span></span><br><span class="line"><span class="comment">     *  我们可以使用我们支持的 15 多个嵌入存储中的任何一个，但为了简单起见，我们将使用内存中的嵌入存储：</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> InMemoryEmbeddingStore&lt;TextSegment&gt; <span class="title function_">inMemoryEmbeddingStore</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InMemoryEmbeddingStore</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RagAssistant <span class="title function_">ragAssistant</span><span class="params">(ChatModel chatModel, EmbeddingStore&lt;TextSegment&gt; embeddingStore)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> AiServices.builder(RagAssistant.class)</span><br><span class="line">                .chatModel(chatModel)</span><br><span class="line">                .chatMemory(MessageWindowChatMemory.withMaxMessages(<span class="number">50</span>)) <span class="comment">//最大条消息</span></span><br><span class="line">                .contentRetriever(EmbeddingStoreContentRetriever.from(embeddingStore))<span class="comment">//引入外部知识源</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RagController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.document.Document;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.document.loader.FileSystemDocumentLoader;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.document.parser.apache.tika.ApacheTikaDocumentParser;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.data.segment.TextSegment;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.ChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.store.embedding.EmbeddingStoreIngestor;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.store.embedding.inmemory.InMemoryEmbeddingStore;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RagController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> InMemoryEmbeddingStore&lt;TextSegment&gt; inMemoryEmbeddingStore;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/rag/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">addRag</span><span class="params">()</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line"><span class="comment">//        Document document = FileSystemDocumentLoader</span></span><br><span class="line"><span class="comment">//                .loadDocument(&quot;C:\\Users\\MacBookPro\\Downloads\\阿里巴巴java开发规范（嵩山版）.pdf&quot;);//第一种方式</span></span><br><span class="line">        <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApacheTikaDocumentParser</span>().parse(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(</span><br><span class="line">                <span class="string">&quot;C:\\Users\\MacBookPro\\Downloads\\阿里巴巴java开发规范（嵩山版）.pdf&quot;</span>));<span class="comment">//第二种方式</span></span><br><span class="line">        EmbeddingStoreIngestor.ingest(document, inMemoryEmbeddingStore);<span class="comment">//添加文档到内存里面</span></span><br><span class="line">        <span class="keyword">return</span> chatModel.chat(<span class="string">&quot;DTO是什么?&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250806172449724.png" alt="image-20250806172449724"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250806174643310.png" alt="image-20250806174643310"></p><h2 id="MCP协议"><a href="#MCP协议" class="headerlink" title="MCP协议"></a>MCP协议</h2><p>为什么有<code>MCP</code>？</p><p>大模型需要 MCP（Model Context Protocol，模型上下文协议）是为了解决传统集成方式下 LLM（大语言模型）与外部世界连接的低效和碎片化问题。以下是核心痛点和 MCP 的解决方案分析：</p><p>⚠️ <strong>一、无 MCP 前的核心痛点</strong></p><ol><li><strong>数据孤岛与静态知识局限</strong><ul><li>LLM 依赖训练时的静态数据，无法访问实时信息（如最新天气、股价、航班动态），导致回答过时或错误。</li><li>例如：旅行规划场景中，AI 无法查询实时机票价格或酒店房态，只能提供基于历史数据的建议。</li></ul></li><li><strong>集成复杂度高（M×N 问题）</strong><ul><li><strong>点对点集成</strong>：每个工具（如数据库、API）需单独开发适配接口。若存在 M 个模型和 N 个工具，需开发 M×N 个定制连接，维护成本爆炸式增长。</li><li><strong>协议碎片化</strong>：不同工具使用不同接口（SQL、REST API、GraphQL），开发者需学习多种协议，小公司难以接入高德地图等闭源服务。</li></ul></li><li><strong>动态性与灵活性缺失</strong><ul><li>工具功能变更（如新增参数）需重写集成代码，无法自动适配。</li><li>缺乏统一发现机制：AI 无法动态感知可用工具，需硬编码工具描述到提示词中。</li></ul></li><li><strong>安全与维护风险</strong><ul><li>分散的权限管理和认证机制增加安全漏洞风险。</li><li>紧耦合设计导致单点故障：某接口变更可能引发全线崩溃。</li></ul></li></ol><p>⚡<strong>二、MCP 的解决方案与核心价值</strong></p><p>MCP 通过 <strong>标准化协议</strong> 重构 LLM 与外部资源的交互方式，类比为 “AI 世界的 USB-C 接口”：</p><table><thead><tr><th align="left"><strong>痛点维度</strong></th><th align="left"><strong>传统方案</strong></th><th align="left"><strong>MCP 方案</strong></th><th align="left"><strong>优势</strong></th></tr></thead><tbody><tr><td align="left"><strong>集成复杂度</strong></td><td align="left">M×N 定制适配</td><td align="left">工具一次封装 → 所有 AI 自动兼容</td><td align="left">成本从 O(M×N) 降至 O(M+N)110</td></tr><tr><td align="left"><strong>动态扩展</strong></td><td align="left">硬编码接口，变更需重写代码</td><td align="left">工具主动声明能力，Client 自动发现2</td><td align="left">无缝兼容升级</td></tr><tr><td align="left"><strong>实时性</strong></td><td align="left">依赖轮询，延迟显著</td><td align="left">毫秒级数据流更新（如 SSE 推送）2</td><td align="left">决策滞后从小时级压缩到秒级</td></tr><tr><td align="left"><strong>开发效率</strong></td><td align="left">每对接新工具需数月</td><td align="left">小公司 1 天完成调试（如高德地图）2</td><td align="left">降低 90% 开发时间</td></tr><tr><td align="left"><strong>安全与标准化</strong></td><td align="left">分散权限管理</td><td align="left">统一认证框架（OAuth2&#x2F;API Key）69</td><td align="left">集中化风险控制</td></tr></tbody></table><p>💡 <strong>MCP 核心架构</strong></p><ol><li><strong>MCP Server</strong><ul><li>封装工具&#x2F;数据源（如天气查询、支付接口），暴露标准化能力（<code>list_tools</code>、<code>call_tool</code>）。</li><li>示例：创建天气查询 Server，仅需 10 行 Python 代码（使用 <code>@tool</code> 装饰器）。</li></ul></li><li><strong>MCP Client</strong><ul><li>嵌入 LLM 应用（如 Claude Desktop），动态发现可用工具并组装提示词。</li><li>自动转换用户请求为 MCP 标准调用（JSON-RPC 2.0 格式）。</li></ul></li><li><strong>协议层</strong><ul><li>传输无关：支持 HTTP&#x2F;Stdio&#x2F;WebSocket，统一本地工具与远程 API 调用。</li><li>错误处理：结构化错误码替代 HTTP 状态码，提升健壮性。</li></ul></li></ol><p><img src="/hexo-docs/images/LangChain4jImages/image-20250806181105577.png" alt="image-20250806181105577"></p><h3 id="MCP入门概念"><a href="#MCP入门概念" class="headerlink" title="MCP入门概念"></a>MCP入门概念</h3><ul><li><p>是什么？</p><ul><li><p><code>MCP</code>协议官网：<a href="https://modelcontextprotocol.io/docs/getting-started/intro">https://modelcontextprotocol.io/docs/getting-started/intro</a></p><p>MCP是一种开放协议，它标准化了应用程序向大型语言模型（LLMs）提供上下文的方式。将MCP想象成AI应用的USB-C端口。就像USB-C提供了一种标准化的方式将您的设备连接到各种外围设备和配件一样，MCP提供了一种标准化的方式将AI模型连接到不同的数据源和工具。MCP使您能够在LLMs之上构建代理和复杂的流程，并将您的模型与外界连接起来。</p><p>MCP提供：</p><ul><li><p>一个不断增长的预构建集成列表，您的LLM可以直接插入其中</p></li><li><p>一种为AI应用构建自定义集成的方式</p></li><li><p>一个任何人都可以自由实施和使用的开放协议</p></li><li><p>在不同应用之间切换的灵活性，并随身携带您的上下文</p></li></ul></li><li><p><code>LangChain4j</code>支持<code>MCP</code>协议官网：<code>https://docs.langchain4j.info/tutorials/mcp</code></p><ul><li><p>LangChain4j 支持模型上下文协议 (MCP)，用于与符合 MCP 的服务器通信，这些服务器可以提供和执行工具。有关该协议的一般信息可以在 <a href="https://modelcontextprotocol.io/">MCP 网站</a> 上找到。</p><p>该协议指定了两种传输类型，两种都受支持：</p><ul><li><code>HTTP</code>：客户端请求一个 SSE 通道来接收来自服务器的事件，然后通过 HTTP POST 请求发送命令。</li><li><code>stdio</code>：客户端可以将 MCP 服务器作为本地子进程运行，并通过标准输入&#x2F;输出直接与其通信。</li></ul></li></ul></li><li><p>一句话</p><ul><li><p>大模型版的<code>OpenFeign</code>，<code>OpenFeign</code>用于微服务之间通讯，<code>MCP</code>用户大模型之间的通讯</p><p>MCP就像是AI世界的”万能适配器”。</p><p>想象你有很多不同类型的服务和数据库，每个都有自己独特的”说话方式”。AI需要和这些服务交流时就很麻烦因为要学习每个服务的”语言”。</p><p>MCP解决了这个问题 - 它就像一个统一的翻译官，让AI只需学一种”语言”就能和所有服务交流。</p><p>这样开发者不用为每个服务单独开发连接方式，AI也能更容易获取它需要的信息。</p><p>如果你是一个后端同学，那么应该接触或听说过gRPC。gRPC通过标准化的通信方式可以实现不同语言开发的服务之间进行通信，那么MCP专门为AI模型设计的”翻译官和接口管理器”，让AI能以统一方式与各种应用或数据源交互。</p></li></ul></li></ul></li></ul><p>能干嘛？</p><ul><li>提供了一种标准化的方式来连接<code>LLMs</code>需要的上下文，<code>MCP</code>就类似于一个<code>Agent</code>时代的<code>Type-C</code>协议，希望能将不同来源的数据、工具、服务统一起来供大模型调用</li></ul><p>没有<code>MCP</code>的时候，自己整自己的</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807155426250.png" alt="image-20250807155426250"></p><p>有了<code>MCP</code>，统一了标准</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807155452972.png" alt="image-20250807155452972"></p><blockquote><p>总结</p><p>MCP 厉害的地方在于，不用重复造轮子。</p><p>过去每个软件（比如微信、Excel）都要单独给 AI 做接口，</p><p>现在 MCP 统一了标准，就像所有电器都用 USB-C 充电口，AI 一个接口就能连接所有工具</p></blockquote><p><code>MCP</code>就是比<code>FunctionCalling</code>的更高一级抽象，也是实现智能体<code>Agent</code>的基础</p><p>举个例子：</p><p>​<img src="/hexo-docs/images/LangChain4jImages/image-20250807170137391.png" alt="image-20250807170137391"></p><p>解释</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807170159553.png" alt="image-20250807170159553"></p><p>怎么玩？</p><p>地址：<a href="http://mcp.so/zh">http://mcp.so/zh</a></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807184506099.png" alt="image-20250807184506099"></p><h3 id="MCP知识架构"><a href="#MCP知识架构" class="headerlink" title="MCP知识架构"></a><code>MCP</code>知识架构</h3><p><code>MCP</code>遵循客户端-服务端包含以下几个核心部分</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807170302534.png" alt="image-20250807170302534"></p><ul><li><code>MCP</code>主机（<code>MCP Hosts</code>）：发起请求的<code>AI</code>应用程序，比如聊天机器人、<code>AI</code>驱动的<code>IDE</code>等</li><li><code>MCP</code>客户端（<code>MCP Clients</code>）：在主机程序内部，与<code>MCP</code>服务器保持<code>1:1</code>的连接</li><li><code>MCP</code>服务端（<code>MCP Servers</code>）：为<code>MCP</code>客户端提供上下文、工具和提示信息</li><li>本地资源（<code>Local Resources</code>）：本地计算机可供<code>MCP</code>服务器安全访问的资源，如文件、数据库。</li><li>远程资源（<code>Remote Resources</code>）：<code>MCP</code>服务器可以连接到的远程资源，如通过<code>API</code>提供的数据</li></ul><p>在<code>MCP</code>通信协议中，一般有两种模式</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807170726771.png" alt="image-20250807170726771"></p><ol><li><p><code>STDIO</code>（标准输入&#x2F;输出）</p><p>支持标准输入和输出流通信，主要用于本地集成、命令行工具等场景。</p></li><li><p><code>SSE(Server-Sent Events)</code></p><p>支持使用<code>HTTP POST</code>请求进行服务器到客户端流式处理，以实现客户端到服务器的通信。</p></li></ol><p>两者对比</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807170924432.png" alt="image-20250807170924432"></p><h3 id="案例实战"><a href="#案例实战" class="headerlink" title="案例实战"></a>案例实战</h3><p>需求说明</p><ul><li>本次调用<code>MCPServer</code>百度地图，地址：<a href="http://mcp.so/zh/server/baidu-map/baidu-maps%EF%BC%8Chttps://mcp.so/zh/server/baidu-map/baidu-maps?tab=content#%E5%B7%A5%E5%85%B7%E5%88%97%E8%A1%A8">http://mcp.so/zh/server/baidu-map/baidu-maps，https://mcp.so/zh/server/baidu-map/baidu-maps?tab=content#工具列表</a></li></ul><p>前置环境</p><ul><li><p>原理说明</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807184957104.png" alt="image-20250807184957104"></p></li><li><p>下载<code>nodejs</code></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807185109714.png" alt="image-20250807185109714"></p><p>下载安装成功后</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807185146148.png" alt="image-20250807185146148"></p></li><li><p>注册百度地图账号+申请<code>API-Key</code></p><p>地址：<a href="https://lbsyun.baidu.com/apiconsole/key">https://lbsyun.baidu.com/apiconsole/key</a></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807190548444.png" alt="image-20250807190548444"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807191039763.png" alt="image-20250807191039763"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807191056574.png" alt="image-20250807191056574"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807191109657.png" alt="image-20250807191109657"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807191118899.png" alt="image-20250807191118899"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807191215205.png" alt="image-20250807191215205"></p></li></ul><p>将<code>API-Key</code>配置环境变量里面，配置完成之后一定要重启，不然报错！</p><p>如何编写<code>MCP</code>程序？</p><p>地址：<a href="https://docs.langchain4j.info/tutorials/mcp">https://docs.langchain4j.info/tutorials/mcp</a></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807191610869.png" alt="image-20250807191610869"></p><p><code>module</code>：<code>LangChain4j-14chat-mcp</code></p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 实现流式输出 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-reactor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--DashScope (Qwen)接入阿里云百炼平台</span></span><br><span class="line"><span class="comment">       https://docs.langchain4j.dev/integrations/language-models/dashscope</span></span><br><span class="line"><span class="comment">   --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-community-dashscope-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- MCP Client依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-mcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9014</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">encoding:</span></span><br><span class="line">      <span class="attr">charset:</span> <span class="string">UTF-8</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">force:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">LangChain4j-14chat-mcp</span></span><br><span class="line"><span class="attr">langchain4j:</span></span><br><span class="line">  <span class="attr">community:</span></span><br><span class="line">    <span class="attr">dashscope:</span></span><br><span class="line">      <span class="attr">streaming-chat-model:</span></span><br><span class="line">        <span class="attr">api-key:</span> <span class="string">$&#123;aliQWen-api&#125;</span></span><br><span class="line">        <span class="attr">model-name:</span> <span class="string">qwen-plus</span></span><br><span class="line">      <span class="attr">chat-model:</span></span><br><span class="line">        <span class="attr">api-key:</span> <span class="string">$&#123;aliQWen-api&#125;</span></span><br><span class="line">        <span class="attr">model-name:</span> <span class="string">qwen-plus</span></span><br><span class="line"><span class="comment"># 只有日志级别调整为debug级别，同时配置以上 langchain 日志输出开关才有效</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">dev:</span></span><br><span class="line">      <span class="attr">langchain4j:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure><p><code>McpService</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">McpService</span> &#123;</span><br><span class="line">    Flux&lt;String&gt; <span class="title function_">chat</span><span class="params">(String question)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>McpCallServerController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.McpService;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.mcp.McpToolProvider;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.mcp.client.DefaultMcpClient;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.mcp.client.McpClient;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.mcp.client.transport.McpTransport;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.mcp.client.transport.stdio.StdioMcpTransport;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.model.chat.StreamingChatModel;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.AiServices;</span><br><span class="line"><span class="keyword">import</span> dev.langchain4j.service.tool.ToolProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">McpCallServerController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StreamingChatModel streamingChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/mcp/chat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">chat</span><span class="params">(<span class="meta">@RequestParam(&quot;question&quot;)</span> String question)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/**1.构建McpTransport协议</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 1.1 cmd：启动 Windows 命令行解释器。</span></span><br><span class="line"><span class="comment">         * 1.2 /c：告诉 cmd 执行完后面的命令后关闭自身。</span></span><br><span class="line"><span class="comment">         * 1.3 npx：npx = npm execute package，Node.js 的一个工具，用于执行 npm 包中的可执行文件。</span></span><br><span class="line"><span class="comment">         * 1.4 -y 或 --yes：自动确认操作（类似于默认接受所有提示）。</span></span><br><span class="line"><span class="comment">         * 1.5 <span class="doctag">@baidumap</span>/mcp-server-baidu-map：要通过 npx 执行的 npm 包名</span></span><br><span class="line"><span class="comment">         * 1.6 BAIDU_MAP_API_KEY 是访问百度地图开放平台API的AK</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">McpTransport</span> <span class="variable">transport</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StdioMcpTransport</span>.Builder()</span><br><span class="line">                .command(List.of(<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="string">&quot;npx&quot;</span>, <span class="string">&quot;-y&quot;</span>, <span class="string">&quot;@baidumap/mcp-server-baidu-map&quot;</span>))</span><br><span class="line">                .environment(Map.of(<span class="string">&quot;BAIDU_MAP_API_KEY&quot;</span>, System.getenv(<span class="string">&quot;BAIDU_MAP_API_KEY&quot;</span>)))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.构建McpClient客户端</span></span><br><span class="line">        <span class="type">McpClient</span> <span class="variable">mcpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMcpClient</span>.Builder()</span><br><span class="line">                .transport(transport)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.创建工具集和原生的FunctionCalling类似</span></span><br><span class="line">        <span class="type">ToolProvider</span> <span class="variable">toolProvider</span> <span class="operator">=</span> McpToolProvider.builder()</span><br><span class="line">                .mcpClients(mcpClient)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.通过AiServivces给我们自定义接口McpService构建实现类并将工具集和大模型赋值给AiService</span></span><br><span class="line">        <span class="type">McpService</span> <span class="variable">mcpService</span> <span class="operator">=</span> AiServices.builder(McpService.class)</span><br><span class="line">                .streamingChatModel(streamingChatModel)</span><br><span class="line">                .toolProvider(toolProvider)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.调用我们定义的HighApi接口,通过大模型对百度mcpserver调用</span></span><br><span class="line">        <span class="keyword">return</span> mcpService.chat(question);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先尝试在<code>cmd</code> 中执行 <code>npx -y @baidumap/mcp-server-baidu-map</code> 命令，查看 MCP 服务端是否能够正常启动。如果不能正常启动，需要查看错误信息并解决。我在此遇到问题，错误信息是「请求 npm 淘宝源下的 baidu map mcp server 失败，原因是证书过期」，于是我将 npm 镜像源又切回默认，然后再尝试执行，提示 Baidu Map MCP Server running on stdio，正常启动 MCP 服务端。</p><p>测试</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250808160104933.png" alt="image-20250808160104933"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250808160228423.png" alt="image-20250808160228423"></p><p>复习</p><ul><li><p><code>Function Calling</code>，为了让大模型使用<code>Util</code>工具</p></li><li><p><code>RAG</code>，为了让大模型获取足够的上下文</p></li><li><p><code>MCP</code>，为了让大模型之间的调用</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807213432451.png" alt="image-20250807213432451"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807213443872.png" alt="image-20250807213443872"></p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807213536712.png" alt="image-20250807213536712"></p><p>原理说明</p><p><img src="/hexo-docs/images/LangChain4jImages/image-20250807213549809.png" alt="image-20250807213549809"></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 后端 AI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LangChain4j </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BigKey和缓存双写</title>
      <link href="/hexo-docs/2025/08/13/redis/bigkey%E5%92%8C%E7%BC%93%E5%AD%98%E5%8F%8C%E5%86%99/"/>
      <url>/hexo-docs/2025/08/13/redis/bigkey%E5%92%8C%E7%BC%93%E5%AD%98%E5%8F%8C%E5%86%99/</url>
      
        <content type="html"><![CDATA[<h2 id="Redis为什么是单线程"><a href="#Redis为什么是单线程" class="headerlink" title="Redis为什么是单线程"></a>Redis为什么是单线程</h2><p>这种问法其实并不严谨，为啥这么说呢?</p><p>Redis的版本很多3.x、4.x、6.x，版本不同架构也是不同的，不限定版本问是否单线程也不太严谨。</p><ol><li><p>版本3.x ，最早版本，也就是大家口口相传的redis是单线程，阳哥2016年讲解的redis就是3.X的版本。</p></li><li><p>版本4.x，严格意义来说也不是单线程，而是负责处理客户端请求的线程是单线程，但是开始加了点多线程的东西(异步删除)。—貌似</p></li><li><p>2020年5月版本的6.0.x后及2022年出的7.0版本后，告别了大家印象中的单线程，用一种全新的多线程来解决问题。—实锤</p></li></ol><p>几个里程碑的redis版本！</p><p><img src="/hexo-docs/images/redisImages/image-20250628182302953.png" alt="image-20250628182302953"></p><p>5.0版本是直接升级到6.0版本，对于这个激进的升级，Redis之父antirez表现得很有信心和兴奋，</p><p>所以第一时间发文来阐述6.0的一些重大功能”Redis 6.0.0 GA is out!”</p><p>当然，Redis7.0后版本更加厉害</p><ul><li>Redis是单线程<ul><li>主要是指Redis的网络IO和键值对读写是由一个线程来完成的，Redis在处理客户端的请求时包括获取 (socket 读)、解析、执行、内容返回 (socket 写) 等都由一个顺序串行的主线程处理，这就是所谓的“单线程”。这也是Redis对外提供键值存储服务的主要流程。</li></ul></li></ul><p><img src="/hexo-docs/images/redisImages/image-20250628182400234.png" alt="image-20250628182400234"></p><p>但Redis的其他功能，比如持久化RDB、AOF、异步删除、集群数据同步等等，其实是由额外的线程执行的。</p><p>Redis命令工作线程是单线程的，但是，整个Redis来说，是多线程的；</p><blockquote><p><code>redis</code>为什么是单线程的？</p><p>​<code>redis</code>4之前一直都是单线程，redis4之后陆续加入多线程</p></blockquote><p>简单来说，Redis4.0之前一直采用单线程的主要原因有以下三个：</p><ol><li>使用单线程模型是 Redis 的开发和维护更简单，因为单线程模型方便开发和调试；</li><li>即使使用单线程模型也并发的处理多客户端的请求，主要使用的是IO多路复用和非阻塞IO；</li><li>对于Redis系统来说，主要的性能瓶颈是内存或者网络带宽而并非 CPU。</li></ol><p>既然单线程那么好，为什么还要引入多线程特性？</p><p>​正常情况下使用 del 指令可以很快的删除数据，而当被删除的 key 是一个非常大的对象时，例如时包含了成千上万个元素的 hash 集合时，那么 del 指令就会造成 Redis 主线程卡顿。</p><p>​这就是redis3.x单线程时代最经典的故障，大key删除的头疼问题，</p><p>​由于redis是单线程的，del bigKey …..</p><p>​等待很久这个线程才会释放，类似加了一个synchronized锁，你可以想象高并发下，程序堵成什么样子？</p><p>如何解决？</p><p>比如当我（Redis）需要删除一个很大的数据时，因为是单线程原子命令操作，这就会导致 Redis 服务卡顿，</p><p>于是在 Redis 4.0 中就新增了多线程的模块，当然此版本中的多线程主要是为了解决删除数据效率比较低的问题的。</p><table><thead><tr><th align="left">unlink key</th></tr></thead><tbody><tr><td align="left">flushdb async</td></tr><tr><td align="left">flushall async</td></tr><tr><td align="left">把删除工作交给了后台的小弟（子线程）异步来删除数据了。</td></tr></tbody></table><p>因为Redis是单个主线程处理，redis之父antirez一直强调”Lazy Redis is better Redis”.</p><p>而lazy free的本质就是把某些cost(主要时间复制度，占用主线程cpu时间片)较高删除操作，</p><p>从redis主线程剥离让bio子线程来处理，极大地减少主线阻塞时间。从而减少删除导致性能和稳定性问题。</p><p>redis7是否启用多线程？</p><p>Redis7将所有数据放在内存中，内存的响应时长大约为100纳秒，对于小数据包，Redis服务器可以处理8W到10W的QPS，</p><p>这也是Redis处理的极限了，对于80%的公司来说，单线程的Redis已经足够使用了。</p><p>在Redis6.0及7后，多线程机制默认是关闭的，如果需要使用多线程功能，需要在redis.conf中完成两个设置</p><p><img src="/hexo-docs/images/redisImages/image-20250629160220758.png" alt="image-20250629160220758"></p><p><img src="/hexo-docs/images/redisImages/image-20250629160236686.png" alt="image-20250629160236686"></p><ol><li><p>设置io-thread-do-reads配置项为yes，表示启动多线程。</p></li><li><p>设置线程个数。关于线程数的设置，官方的建议是如果为 4 核的 CPU，建议线程数设置为 2 或 3，如果为 8 核 CPU 建议线程数设置为 6，线程数一定要小于机器核数，线程数并不是越大越好。</p></li></ol><h2 id="BigKey"><a href="#BigKey" class="headerlink" title="BigKey"></a>BigKey</h2><p>多大的key才算<code>bigKey</code>?</p><p>阿里云开发规范</p><p><img src="/hexo-docs/images/redisImages/image-20250628182947629.png" alt="image-20250628182947629"></p><h3 id="String和二级结构"><a href="#String和二级结构" class="headerlink" title="String和二级结构"></a>String和二级结构</h3><ol><li>string是value，最大512MB但是&gt;&#x3D;10KB就是bigkey</li><li>list、hash、set、和zset，个数超过5000就是bigkey<ol><li><p>list</p><p>一个列表最多可以包含2的32次方-1个元素（4294967295，每个列表超过40亿个元素）</p></li><li><p>hash</p><p>Redis中每个hash可以存储2的32次方-1键值对（40多亿）</p></li><li><p>set</p><p>集合中最大的成员数2的32次方-1（4294967295，每个集合可存储40多亿个成员）</p></li></ol></li></ol><h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>大批量往redis里插入100w测试数据key</p><ol><li><p>在linux bash下面执行，插入100w<img src="/hexo-docs/images/redisImages/image-20250629160602408.png" alt="image-20250629160602408"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"># 生成<span class="number">100</span>W条redis批量设置kv的语句(key=kn,value=vn)写入到/tmp目录下的redisTest.txt文件中</span><br><span class="line"><span class="keyword">for</span>((i=<span class="number">1</span>;i&lt;=<span class="number">100</span>*<span class="number">10000</span>;i++)); <span class="keyword">do</span> echo <span class="string">&quot;set k$i v$i&quot;</span> &gt;&gt; /tmp/redisTest.txt ;done;</span><br></pre></td></tr></table></figure></li><li><p>通过redis提供的管道<code>--pipe</code>命令插入100w大批量数据</p><p>结合自己机器的地址：</p><p>cat &#x2F;tmp&#x2F;redisTest.txt | &#x2F;opt&#x2F;redis-7.0.0&#x2F;src&#x2F;redis-cli -h 127.0.0.1 -p 6379 -a 111111 –pipe</p><p>多出来的5条，是之前阳哥自己的其它测试数据 ，参考阳哥机器硬件，100w数据插入redis花费5.8秒左右</p><p><img src="/hexo-docs/images/redisImages/image-20250629160827447.png" alt="image-20250629160827447"></p></li></ol><p>使用<code>keys *</code>查询试试需要多少秒？</p><p><img src="/hexo-docs/images/redisImages/image-20250629160924560.png" alt="image-20250629160924560"></p><p><code>keys *</code>这个指令有致命的弊端，在实际环境中最好不要使用</p><p><img src="/hexo-docs/images/redisImages/image-20250629161002193.png" alt="image-20250629161002193"></p><p>不用<code>keys *</code>避免卡顿，那用什么？</p><p>scan命令</p><p><img src="/hexo-docs/images/redisImages/image-20250629161142416.png" alt="image-20250629161142416"></p><p><img src="/hexo-docs/images/redisImages/image-20250629161156963.png" alt="image-20250629161156963"></p><p>特点：</p><p>SCAN 命令是一个基于游标的迭代器，每次被调用之后， 都会向用户返回一个新的游标， 用户在下次迭代时需要使用这个新游标作为 SCAN 命令的游标参数， 以此来延续之前的迭代过程。</p><p>SCAN 返回一个包含两个元素的数组， </p><p>第一个元素是用于进行下一次迭代的新游标， </p><p>第二个元素则是一个数组， 这个数组中包含了所有被迭代的元素。如果新游标返回零表示迭代已结束。</p><p>SCAN的遍历顺序</p><p>非常特别，它不是从第一维数组的第零位一直遍历到末尾，而是采用了高位进位加法来遍历。之所以使用这样特殊的方式进行遍历，是考虑到字典的扩容和缩容时避免槽位的遍历重复和遗漏。</p><p>使用：</p><p><img src="/hexo-docs/images/redisImages/image-20250629161236694.png" alt="image-20250629161236694"></p><h3 id="生产调优"><a href="#生产调优" class="headerlink" title="生产调优"></a>生产调优</h3><p><code>redis.conf</code>文件<code>LAZY FREEING</code>相关说明</p><ol><li><p>阻塞和非阻塞删除命令</p><p><img src="/hexo-docs/images/redisImages/image-20250629161434048.png" alt="image-20250629161434048"></p></li><li><p>优化配置</p><p><img src="/hexo-docs/images/redisImages/image-20250629161507801.png" alt="image-20250629161507801"></p></li></ol><h2 id="缓存双写一致性"><a href="#缓存双写一致性" class="headerlink" title="缓存双写一致性"></a>缓存双写一致性</h2><p>如果redis中有数据：需要和数据库中的值相同</p><p>如果redis中无数据：数据库中的值要是最新值，且准备回写redis</p><p>缓存按照操作来分，细分2种</p><ol><li>只读缓存</li><li>读写缓存<ol><li>同步直写策略<ol><li>写数据库也同步写redis缓存，缓存和数据库中的数据一致。</li><li>对于读写缓存来说，要想保证缓存和数据库中的数据一致，就要采用同步直写策略</li></ol></li><li>异步缓写策略<ol><li>正常业务运行中，mysql数据变动了，但是可以在业务上容许出现一定时间后才作用于redis，比如仓库、物流系统</li><li>异常情况出现了，不得不将失败的动作重新修补，有可能需要借助消息中间件，实现消息重写</li></ol></li></ol></li></ol><p><img src="/hexo-docs/images/redisImages/image-20250629162252115.png" alt="image-20250629162252115"></p><p>问题，上面业务逻辑你用java代码如何写？</p><p>采用双检加锁策略</p><p>多个线程同时去查询数据库的这条数据，那么我们可以在第一个查询数据的请求上使用一个 互斥锁来锁住它。</p><p>其他的线程走到这一步拿不到锁就等着，等第一个线程查询到了数据，然后做缓存。</p><p>后面的线程进来发现已经有缓存了，就直接走缓存。 </p><p><img src="/hexo-docs/images/redisImages/image-20250629162233989.png" alt="image-20250629162233989"></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CACHE_KEY_USER</span> <span class="operator">=</span> <span class="string">&quot;user:&quot;</span>;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 业务逻辑没有写错，对于小厂中厂(QPS《=1000)可以使用，但是大厂不行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findUserById</span><span class="params">(Integer id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_KEY_USER+id;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1 先从redis里面查询，如果有直接返回结果，如果没有再去查询mysql</span></span><br><span class="line">        user = (User) redisTemplate.opsForValue().get(key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(user == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//2 redis里面无，继续查询mysql</span></span><br><span class="line">            user = userMapper.selectByPrimaryKey(id);</span><br><span class="line">            <span class="keyword">if</span>(user == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//3.1 redis+mysql 都无数据</span></span><br><span class="line">                <span class="comment">//你具体细化，防止多次穿透，我们业务规定，记录下导致穿透的这个key回写redis</span></span><br><span class="line">                <span class="keyword">return</span> user;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//3.2 mysql有，需要将数据写回redis，保证下一次的缓存命中率</span></span><br><span class="line">                redisTemplate.opsForValue().set(key,user);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加强补充，避免突然key失效了，打爆mysql，做一下预防，尽量不出现击穿的情况。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findUserById2</span><span class="params">(Integer id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_KEY_USER+id;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1 先从redis里面查询，如果有直接返回结果，如果没有再去查询mysql，</span></span><br><span class="line">        <span class="comment">// 第1次查询redis，加锁前</span></span><br><span class="line">        user = (User) redisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//2 大厂用，对于高QPS的优化，进来就先加锁，保证一个请求操作，让外面的redis等待一下，避免击穿mysql</span></span><br><span class="line">            <span class="keyword">synchronized</span> (UserService.class)&#123;</span><br><span class="line">                <span class="comment">//第2次查询redis，加锁后</span></span><br><span class="line">                user = (User) redisTemplate.opsForValue().get(key);</span><br><span class="line">                <span class="comment">//3 二次查redis还是null，可以去查mysql了(mysql默认有数据)</span></span><br><span class="line">                <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//4 查询mysql拿数据(mysql默认有数据)</span></span><br><span class="line">                    user = userMapper.selectByPrimaryKey(id);</span><br><span class="line">                    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="comment">//5 mysql里面有数据的，需要回写redis，完成数据一致性的同步工作</span></span><br><span class="line">                        redisTemplate.opsForValue().setIfAbsent(key,user,<span class="number">7L</span>,TimeUnit.DAYS);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="数据库和缓存一致性的几种更新策略"><a href="#数据库和缓存一致性的几种更新策略" class="headerlink" title="数据库和缓存一致性的几种更新策略"></a>数据库和缓存一致性的几种更新策略</h3><p>目的：达到最终一致性</p><p>给缓存设置过期时间，定期清理缓存并回写，是保证最终一致性的解决方案。</p><p>​我们可以对存入缓存的数据设置过期时间，所有的 <strong>写操作以数据库为准</strong> ，对缓存操作只是尽最大努力即可。也就是说如果数据库写成功，缓存更新失败，那么只要到达过期时间，则后面的读请求自然会从数据库中读取新值然后回填缓存，达到一致性，切记，要以mysql的数据库写入库为准。</p><p>上述方案和后续落地案例是调研后的主流+成熟的做法，但是考虑到各个公司业务系统的差距，</p><p>不是100%绝对正确，不保证绝对适配全部情况，请同学们自行酌情选择打法，合适自己的最好。</p><p>可以停机的情况</p><ol><li>挂牌报错，凌晨升级，温馨提示，服务降级</li><li>单线程，这样重量级的数据操作最好不要多线程</li></ol><h3 id="4种更新策略"><a href="#4种更新策略" class="headerlink" title="4种更新策略"></a>4种更新策略</h3><ol><li><p>先更新数据库，在更新缓存</p><ol><li><p>异常问题1</p><ol><li>先更新mysql的某商品的库存，当前商品的库存是100，更新为99个。</li><li>先更新mysql修改为99成功，然后更新redis。</li><li>此时假设异常出现，更新redis失败了，这导致mysql里面的库存是99而redis里面的还是100 。</li><li>上述发生，会让数据库里面和缓存redis里面数据不一致，读到redis脏数据</li></ol></li><li><p>异常问题2</p><p>【先更新数据库，再更新缓存】，A、B两个线程发起调用</p><p><strong>【正常逻辑】</strong></p><p>1 A update mysql 100</p><p>2 A update redis 100</p><p>3 B update mysql 80</p><p>4 B update redis 80</p><p><strong>【异常逻辑】多线程环境下，A、B两个线程有快有慢，有前有后有并行</strong></p><p>1 A update mysql 100</p><p>3 B update mysql 80</p><p>4 B update redis 80</p><p>2 A update redis 100</p><p> &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</p><p>最终结果，mysql和redis数据不一致，o(╥﹏╥)o，</p><p>mysql80,redis100</p></li></ol></li><li><p>先更新缓存，在更新数据库</p><ol><li><p>不太推荐</p><p>业务上一般把mysql作为底单数据库（兜底），保证最后解释</p></li><li><p>异常问题</p><p>【先更新缓存，再更新数据库】，A、B两个线程发起调用</p><p><strong>【正常逻辑】</strong></p><p>1 A update redis 100</p><p>2 A update mysql 100</p><p>3 B update redis 80</p><p>4 B update mysql 80</p><p><strong>【异常逻辑】多线程环境下，A、B两个线程有快有慢有并行</strong></p><p>A update redis  100</p><p>B update redis  80</p><p>B update mysql 80</p><p>A update mysql 100</p><p>—-mysql100,redis80</p></li></ol></li><li><p>先删除缓存，在更新数据库</p><ol><li><p>异常问题</p><ol><li><p>步骤分析1，先删除缓存，再更新数据库</p><p>A线程先成功删除了redis里面的数据，然后去更新mysql，此时mysql正在更新中，还没有结束。（比如网络延时）</p><p>B突然出现要来读取缓存数据。</p><p>20秒模拟网络延迟！</p><p><img src="/hexo-docs/images/redisImages/image-20250629163042012.png" alt="image-20250629163042012"></p></li><li><p>步骤分析2，先删除缓存，再更新数据库</p><ol><li><p>此时redis里面的数据是空的，B线程来读取，先去读redis里数据(已经被A线程delete掉了)，此处出来2个问题：</p><ol><li>B从mysql获得了旧值</li><li>B线程发现redis里没有(缓存缺失)马上去mysql里面读取，从数据库里面读取来的是旧值。</li></ol></li><li><p>B会把获得的旧值写回redis </p><p>获得旧值数据后返回前台并回写进redis(刚被A线程删除的旧数据有极大可能又被写回了)。</p></li></ol><p><img src="/hexo-docs/images/redisImages/image-20250629163248162.png" alt="image-20250629163248162"></p></li><li><p>步骤分析3，先删除缓存，再更新数据库</p><p>A线程更新完mysql，发现redis里面的缓存是脏数据，A线程直接懵逼了，o(╥﹏╥)o</p><p>两个并发操作，一个是更新操作，另一个是查询操作，</p><p>A删除缓存后，B查询操作没有命中缓存，B先把老数据读出来后放到缓存中，然后A更新操作更新了数据库。</p><p>于是，在缓存中的数据还是老的数据，导致缓存中的数据是脏的，而且还一直这样脏下去了。</p></li><li><p>总结流程：</p><ol><li><p>请求A进行写操作，删除redis缓存后，工作正在进行中，更新mysql……A还么有彻底更新完mysql，还没commit</p></li><li><p>请求B开工查询，查询redis发现缓存不存在(被A从redis中删除了)</p></li><li><p>请求B继续，去数据库查询得到了mysql中的旧值(A还没有更新完)</p></li><li><p>请求B将旧值写回redis缓存</p></li><li><p>请求A将新值写入mysql数据库</p></li></ol><p><span style="color:#CC0000;"> <strong>上述情况就会导致不一致的情形出现。</strong> </span></p><table><thead><tr><th>时间</th><th>线程A</th><th>线程B</th><th>出现的问题</th></tr></thead><tbody><tr><td>t1</td><td>请求A进行写操作，删除缓存成功后，工作正在mysql进行中……</td><td></td><td></td></tr><tr><td>t2</td><td></td><td>1 缓存中读取不到，立刻读mysql，由于A还没有对mysql更新完，读到的是旧值 2 还把从mysql读取的旧值，写回了redis</td><td>1 A还没有更新完mysql，导致B读到了旧值 2 线程B遵守回写机制，把旧值写回redis，导致其它请求读取的还是旧值，A白干了。</td></tr><tr><td>t3</td><td>A更新完mysql数据库的值，over</td><td></td><td>redis是被B写回的旧值，mysql是被A更新的新值。出现了，数据不一致问题。</td></tr></tbody></table><ol><li><p>总结一下：</p><p>先删除缓存，再更新数据库  如果数据库更新失败或超时或返回不及时，导致B线程请求访问缓存时发现redis里面没数据，缓存缺失，B再去读取mysql时，从数据库中读取到旧值，还写回redis，导致A白干了，o(╥﹏╥)o</p></li></ol></li><li><p>解决方案</p><p>采用延时双删策略</p><p><img src="/hexo-docs/images/redisImages/image-20250629164039054.png" alt="image-20250629164039054"></p><p><img src="/hexo-docs/images/redisImages/image-20250629164057376.png" alt="image-20250629164057376"></p></li></ol></li></ol></li><li><p>先更新数据库，再删除缓存</p><ol><li><p>异常问题</p><p> 先更新数据库，再删除缓存</p><table><thead><tr><th>时间</th><th>线程A</th><th>线程B</th><th>出现的问题</th></tr></thead><tbody><tr><td>t1</td><td>更新数据库中的值……</td><td></td><td></td></tr><tr><td>t2</td><td></td><td>缓存中立刻命中，此时B读取的是缓存旧值。</td><td>A还没有来得及删除缓存的值，导致B缓存命中读到旧值。</td></tr><tr><td>t3</td><td>更新缓存的数据，over</td><td></td><td></td></tr></tbody></table><table><thead><tr><th>先更新数据库，再删除缓存</th><th>假如缓存删除失败或者来不及，导致请求再次访问redis时缓存命中，读取到的是缓存旧值。</th></tr></thead></table></li><li><p>解决方案</p><p><img src="/hexo-docs/images/redisImages/image-20250629164315717.png" alt="image-20250629164315717"></p><ol><li>可以把要删除的缓存值或者是要更新的数据库值暂存到消息队列中（例如使用Kafka&#x2F;RabbitMQ等）。</li><li>当程序没有能够成功地删除缓存值或者是更新数据库值时，可以从消息队列中重新读取这些值，然后再次进行删除或更新。</li><li>如果能够成功地删除或更新，我们就要把这些值从消息队列中去除，以免重复操作，此时，我们也可以保证数据库和缓存的数据一致了，否则还需要再次进行重试</li><li>如果重试超过的一定次数后还是没有成功，我们就需要向业务层发送报错信息了，通知运维人员。</li></ol></li><li><p>类似经典的分布式事务问题，只有一个权威答案</p><ol><li>最终一致性<ol><li>流量充值，先下发短信实际充值可能滞后5分钟，可以接受</li><li>电商发货，短信下发但是物流明天见</li></ol></li></ol></li></ol></li></ol><h3 id="4种更新总结"><a href="#4种更新总结" class="headerlink" title="4种更新总结"></a>4种更新总结</h3><p>建议：优先**使用先更新数据库，再删除缓存的方案(先更库→后删存)**。理由如下：</p><ol><li>先删除缓存值再更新数据库，有可能导致请求因缓存缺失而访问数据库，给数据库带来压力导致打满mysql。</li><li>如果业务应用中读取数据库和写缓存的时间不好估算，那么，延迟双删中的等待时间就不好设置。</li></ol><p> 多补充一句：如果<strong>使用先更新数据库，再删除缓存的方案</strong></p><p>如果业务层要求必须读取一致性的数据，那么我们就需要在更新数据库时，先在Redis缓存客户端暂停并发读请求，等数据库更新完、缓存值删除后，再读取数据，从而保证数据一致性，这是理论可以达到的效果，但</p><p>实际，不推荐，因为真实生产环境中，分布式下很难做到实时一致性，一般都是最终一致性，请大家参考。</p><table><thead><tr><th>策略</th><th>高并发多线程条件下</th><th>问题</th><th>现象</th><th>解决方案</th></tr></thead><tbody><tr><td>先删除redis缓存，再更新mysql</td><td>无</td><td>缓存删除成功但数据库更新失败</td><td>Java程序从数据库中读到旧值</td><td>再次更新数据库，重试</td></tr><tr><td></td><td>有</td><td>缓存删除成功但数据库更新中……有并发读请求</td><td>并发请求从数据库读到旧值并回写到redis，导致后续都是从redis读取到旧值</td><td>延迟双删</td></tr><tr><td><strong>先更新mysql，再删除redis缓存</strong></td><td>无</td><td>数据库更新成功，但缓存删除失败</td><td>Java程序从redis中读到旧值</td><td>再次删除缓存，重试</td></tr><tr><td></td><td>有</td><td>数据库更新成功但缓存删除中……有并发读请求</td><td>并发请求从缓存读到旧值</td><td>等待redis删除完成，这段时间有数据不一致，短暂存在。</td></tr></tbody></table><h3 id="Canal"><a href="#Canal" class="headerlink" title="Canal"></a>Canal</h3><p><a href="https://github.com/alibaba/canal">canal</a></p><p>是什么？</p><ul><li>主要用途是基于 MySQL 数据库增量日志解析，提供增量数据订阅和消费</li></ul><p>能干嘛？</p><ul><li>数据库镜像</li><li>数据库实时备份</li><li>索引构建和实时维护（拆分异构索引、倒排索引等）</li><li>业务cache刷新</li><li>带业务逻辑的增量数据处理</li></ul><p>工作原理</p><ol><li><p>传统MySQL主从复制工作原理</p><p><img src="/hexo-docs/images/redisImages/image-20250629165208291.png" alt="image-20250629165208291"></p><p>MySQL的主从复制将经过如下步骤：</p><ol><li>当 master 主服务器上的数据发生改变时，则将其改变写入二进制事件日志文件中；</li><li>salve 从服务器会在一定时间间隔内对 master 主服务器上的二进制日志进行探测，探测其是否发生过改变，</li></ol><p>如果探测到 master 主服务器的二进制事件日志发生了改变，则开始一个 I&#x2F;O Thread 请求 master 二进制事件日志；</p><ol start="3"><li>同时 master 主服务器为每个 I&#x2F;O Thread 启动一个dump Thread，用于向其发送二进制事件日志；</li><li>slave 从服务器将接收到的二进制事件日志保存至自己本地的中继日志文件中；</li><li>salve 从服务器将启动 SQL Thread 从中继日志中读取二进制日志，在本地重放，使得其数据和主服务器保持一致；</li><li>最后 I&#x2F;O Thread 和 SQL Thread 将进入睡眠状态，等待下一次被唤醒；</li></ol></li><li><p>cana工作原理</p><ul><li><p>canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave ，向 MySQL master 发送 dump 协议</p></li><li><p>MySQL master 收到 dump 请求，开始推送 binary log 给 slave (即 canal )</p></li><li><p>canal 解析 binary log 对象(原始为 byte 流)</p></li></ul></li></ol><h3 id="redis与mysql数据双写一致性案例"><a href="#redis与mysql数据双写一致性案例" class="headerlink" title="redis与mysql数据双写一致性案例"></a>redis与mysql数据双写一致性案例</h3><p>配置</p><ol><li><p>mysql</p><ol><li><p>查询mysql版本：<code>SELECT VERSION();</code></p><p><img src="/hexo-docs/images/redisImages/image-20250629165619477.png" alt="image-20250629165619477"></p></li><li><p>查看的主机二进制日志：<code>SHOW MASTER STATUS;</code></p><p><img src="/hexo-docs/images/redisImages/image-20250629165745534.png" alt="image-20250629165745534"></p></li><li><p>查看<code>SHOW VARIABLES LIKE &#39;log_bin&#39;;</code></p><p><img src="/hexo-docs/images/redisImages/image-20250629165914631.png" alt="image-20250629165914631"></p></li><li><p>开启<code>MySQL的binlog写入功能</code></p><ol><li><p>最好提前备份</p></li><li><p>my.ini</p><p><img src="/hexo-docs/images/redisImages/image-20250629170538008.png" alt="image-20250629170538008"></p><p>window <code>my.ini</code></p><p>linux      <code>my.conf</code></p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">log<span class="operator">-</span>bin<span class="operator">=</span>mysql<span class="operator">-</span>bin #开启 binlog</span><br><span class="line">binlog<span class="operator">-</span>format<span class="operator">=</span><span class="type">ROW</span> #选择 <span class="type">ROW</span> 模式</span><br><span class="line">server_id<span class="operator">=</span><span class="number">1</span>    #配置MySQL replaction需要定义，不要和canal的 slaveId重复</span><br></pre></td></tr></table></figure><ol><li>ROW模式 除了记录sql语句之外，还会记录每个字段的变化情况，能够清楚的记录每行数据的变化历史，但会占用较多的空间。</li><li>STATEMENT模式只记录了sql语句，但是没有记录上下文信息，在进行数据恢复的时候可能会导致数据的丢失情况；</li><li>MIX模式比较灵活的记录，理论上说当遇到了表结构变更的时候，就会记录为statement模式。当遇到了数据更新或者删除情况下就会变为row模式；</li></ol></li><li><p>重启<code>MySQL</code></p><ol><li>打开“服务”管理器：按 <em>Win + R</em> 键，输入 <em>services.msc</em> 并按回车。</li><li>找到 MySQL 服务（例如 <em>MySQL80</em>）。</li><li>右键点击该服务，选择“重新启动”。</li></ol></li><li><p>再次查看<code>SHOW VARIABLES LIKE &#39;log_bin</code></p><p><img src="/hexo-docs/images/redisImages/image-20250629170945363.png" alt="image-20250629170945363"></p></li><li><p>授权<code>canal</code>连接<code>MySQL</code>账号</p><ol><li><p><code>MySQL</code>默认的用户在<code>MySQL</code>库的<code>user</code>表里</p><p><img src="/hexo-docs/images/redisImages/image-20250629171222487.png" alt="image-20250629171222487"></p></li><li><p>默认没有canal账户，在此处新建+授权</p><p>sql<br>DROP USER IF EXISTS ‘canal‘@’%’;<br>CREATE USER ‘canal‘@’%’ IDENTIFIED BY ‘canal’;<br>GRANT ALL PRIVILEGES ON <em>.</em> TO ‘canal‘@’%’ IDENTIFIED BY ‘canal’;<br>FLUSH PRIVILEGES;<br>SELECT * FROM mysql.user;</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">如果提示`1290 - The MySQL server is running with the --skip-grant-tables option so it cannot execute this statement`</span><br><span class="line"></span><br><span class="line">sql</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line">DROP USER IF EXISTS &#x27;canal&#x27;@&#x27;%&#x27;;</span><br><span class="line">CREATE USER &#x27;canal&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;canal&#x27;;  </span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO &#x27;canal&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;canal&#x27;;  </span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line">SELECT * FROM mysql.user;</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250629171914663.png" alt="image-20250629171914663"></p><p>canal就添加好了！</p></li></ol></li><li><p><code>canal</code>服务端</p><ol><li><p>下载</p><p><a href="https://github.com/alibaba/canal/releases/download/canal-1.1.8/canal.deployer-1.1.8.tar.gz">https://github.com/alibaba/canal/releases/download/canal-1.1.8/canal.deployer-1.1.8.tar.gz</a></p></li><li><p>上传到<code>linux</code>的某个位置</p><p>我上传到根目录的<code>mycanal</code></p><p><img src="/hexo-docs/images/redisImages/image-20250629183608075.png" alt="image-20250629183608075"></p></li><li><p>解压文件</p><p><img src="/hexo-docs/images/redisImages/image-20250629183855880.png" alt="image-20250629183855880"></p></li><li><p>配置<code>instance.properties</code></p><p>进入到<code>/mycanal/conf/example</code>找到<code>instance.properties</code></p><p>使用vim编辑<code>instance.properties</code></p><p><img src="/hexo-docs/images/redisImages/image-20250629184300692.png" alt="image-20250629184300692"></p><p><img src="/hexo-docs/images/redisImages/image-20250629184350656.png" alt="image-20250629184350656"></p></li><li><p>在<code>/mycanal/bin</code>目录下执行，<code>./startup.sh</code></p><p><img src="/hexo-docs/images/redisImages/image-20250629184800033.png" alt="image-20250629184800033"></p></li><li><p>查看</p><p>判断<code>canal</code>启动是否成功</p><ol><li><p>查看server日志<code>/mycanal/logs/canal/canal.log</code></p><p><img src="/hexo-docs/images/redisImages/image-20250629185018703.png" alt="image-20250629185018703"></p></li><li><p>查看样例<code>example</code>的日志<code>/mycanal/logs/example/example.log</code></p><p><img src="/hexo-docs/images/redisImages/image-20250629185223183.png" alt="image-20250629185223183"></p></li></ol></li><li><p>代码编写</p><ol><li><p>pom</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--jedis--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- redis --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Mysql数据库驱动--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringBoot集成druid连接池--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--canal--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.otter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>canal.client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/db01?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">test-while-idle:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Redis7_study</span></span><br></pre></td></tr></table></figure></li><li><p><code>RedisUtlis</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.utlis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> Lazy</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisUtils</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span>  <span class="variable">REDIS_IP_ADDR</span> <span class="operator">=</span> <span class="string">&quot;192.168.0.13&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span>  <span class="variable">REDIS_pwd</span> <span class="operator">=</span> <span class="string">&quot;redis&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> JedisPool jedisPool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        JedisPoolConfig jedisPoolConfig=<span class="keyword">new</span> <span class="title class_">JedisPoolConfig</span>();</span><br><span class="line">        jedisPoolConfig.setMaxTotal(<span class="number">20</span>);</span><br><span class="line">        jedisPoolConfig.setMaxIdle(<span class="number">10</span>);</span><br><span class="line">        jedisPool=<span class="keyword">new</span> <span class="title class_">JedisPool</span>(jedisPoolConfig,REDIS_IP_ADDR,<span class="number">6379</span>,<span class="number">10000</span>,REDIS_pwd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Jedis <span class="title function_">getJedis</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span>!=jedisPool)&#123;</span><br><span class="line">            <span class="keyword">return</span> jedisPool.getResource();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;Jedispool is not ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>测试类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnector;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnectors;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.*;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.Message;</span><br><span class="line"><span class="keyword">import</span> com.lazy.utlis.RedisUtils;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Lazy</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisCanalClientExample</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">_60SECONDS</span> <span class="operator">=</span> <span class="number">60</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span>  <span class="variable">REDIS_IP_ADDR</span> <span class="operator">=</span> <span class="string">&quot;192.168.0.133&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">redisInsert</span><span class="params">(List&lt;Column&gt; columns)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        <span class="keyword">for</span> (Column column : columns)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(column.getName() + <span class="string">&quot; : &quot;</span> + column.getValue() + <span class="string">&quot;    update=&quot;</span> + column.getUpdated());</span><br><span class="line">            jsonObject.put(column.getName(),column.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(columns.size() &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span>(<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> RedisUtils.getJedis())</span><br><span class="line">            &#123;</span><br><span class="line">                jedis.set(columns.get(<span class="number">0</span>).getValue(),jsonObject.toJSONString());</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">redisDelete</span><span class="params">(List&lt;Column&gt; columns)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        <span class="keyword">for</span> (Column column : columns)</span><br><span class="line">        &#123;</span><br><span class="line">            jsonObject.put(column.getName(),column.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(columns.size() &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span>(<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> RedisUtils.getJedis())</span><br><span class="line">            &#123;</span><br><span class="line">                jedis.del(columns.get(<span class="number">0</span>).getValue());</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">redisUpdate</span><span class="params">(List&lt;Column&gt; columns)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        <span class="keyword">for</span> (Column column : columns)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(column.getName() + <span class="string">&quot; : &quot;</span> + column.getValue() + <span class="string">&quot;    update=&quot;</span> + column.getUpdated());</span><br><span class="line">            jsonObject.put(column.getName(),column.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(columns.size() &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span>(<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> RedisUtils.getJedis())</span><br><span class="line">            &#123;</span><br><span class="line">                jedis.set(columns.get(<span class="number">0</span>).getValue(),jsonObject.toJSONString());</span><br><span class="line">                System.out.println(<span class="string">&quot;---------update after: &quot;</span>+jedis.get(columns.get(<span class="number">0</span>).getValue()));</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printEntry</span><span class="params">(List&lt;Entry&gt; entrys)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Entry entry : entrys) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry.getEntryType() == EntryType.TRANSACTIONBEGIN || entry.getEntryType() == EntryType.TRANSACTIONEND) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">RowChange</span> <span class="variable">rowChage</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//获取变更的row数据</span></span><br><span class="line">                rowChage = RowChange.parseFrom(entry.getStoreValue());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ERROR ## parser of eromanga-event has an error,data:&quot;</span> + entry.toString(),e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//获取变动类型</span></span><br><span class="line">            <span class="type">EventType</span> <span class="variable">eventType</span> <span class="operator">=</span> rowChage.getEventType();</span><br><span class="line">            System.out.println(String.format(<span class="string">&quot;================&amp;gt; binlog[%s:%s] , name[%s,%s] , eventType : %s&quot;</span>,</span><br><span class="line">                    entry.getHeader().getLogfileName(), entry.getHeader().getLogfileOffset(),</span><br><span class="line">                    entry.getHeader().getSchemaName(), entry.getHeader().getTableName(), eventType));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (RowData rowData : rowChage.getRowDatasList()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (eventType == EventType.INSERT) &#123;</span><br><span class="line">                    redisInsert(rowData.getAfterColumnsList());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (eventType == EventType.DELETE) &#123;</span><br><span class="line">                    redisDelete(rowData.getBeforeColumnsList());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;<span class="comment">//EventType.UPDATE</span></span><br><span class="line">                    redisUpdate(rowData.getAfterColumnsList());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;---------O(∩_∩)O哈哈~ initCanal() main方法-----------&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//=================================</span></span><br><span class="line">        <span class="comment">// 创建链接canal服务端</span></span><br><span class="line">        <span class="type">CanalConnector</span> <span class="variable">connector</span> <span class="operator">=</span> CanalConnectors.newSingleConnector(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(REDIS_IP_ADDR,</span><br><span class="line">                <span class="number">11111</span>), <span class="string">&quot;example&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">batchSize</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">        <span class="comment">//空闲空转计数器</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">emptyCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;---------------------canal init OK，开始监听mysql变化------&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connector.connect();</span><br><span class="line">            <span class="comment">//connector.subscribe(&quot;.*\\..*&quot;);</span></span><br><span class="line">            connector.subscribe(<span class="string">&quot;db01.dept&quot;</span>);</span><br><span class="line">            connector.rollback();</span><br><span class="line">            <span class="type">int</span> <span class="variable">totalEmptyCount</span> <span class="operator">=</span> <span class="number">10</span> * _60SECONDS;</span><br><span class="line">            <span class="keyword">while</span> (emptyCount &lt; totalEmptyCount) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;我是canal，每秒一次正在监听:&quot;</span>+ UUID.randomUUID().toString());</span><br><span class="line">                <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> connector.getWithoutAck(batchSize); <span class="comment">// 获取指定数量的数据</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">batchId</span> <span class="operator">=</span> message.getId();</span><br><span class="line">                <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> message.getEntries().size();</span><br><span class="line">                <span class="keyword">if</span> (batchId == -<span class="number">1</span> || size == <span class="number">0</span>) &#123;</span><br><span class="line">                    emptyCount++;</span><br><span class="line">                    <span class="keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="number">1</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//计数器重新置零</span></span><br><span class="line">                    emptyCount = <span class="number">0</span>;</span><br><span class="line">                    printEntry(message.getEntries());</span><br><span class="line">                &#125;</span><br><span class="line">                connector.ack(batchId); <span class="comment">// 提交确认</span></span><br><span class="line">                <span class="comment">// connector.rollback(batchId); // 处理失败, 回滚数据</span></span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;已经监听了&quot;</span>+totalEmptyCount+<span class="string">&quot;秒，无任何消息，请重启重试......&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            connector.disconnect();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>效果</p><ol><li><p>增</p><p><img src="/hexo-docs/images/redisImages/image-20250629190307707.png" alt="image-20250629190307707"></p></li><li><p>删</p><p><img src="/hexo-docs/images/redisImages/image-20250629190320876.png" alt="image-20250629190320876"></p></li><li><p>改</p><p><img src="/hexo-docs/images/redisImages/image-20250629190257806.png" alt="image-20250629190257806"></p></li></ol></li></ol></li></ol></li></ol></li></ol></li></ol><p>​</p><p>java程序下<code>connector.subscribe</code>配置的过滤正则</p><p><img src="/hexo-docs/images/redisImages/image-20250629190522893.png" alt="image-20250629190522893"></p><p>关闭资源代码简写</p><p><img src="/hexo-docs/images/redisImages/image-20250629190548572.png" alt="image-20250629190548572"></p>]]></content>
      
      
      <categories>
          
          <category> 后端 Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RedLock算法和底层源码分析和缓存淘汰策略</title>
      <link href="/hexo-docs/2025/08/13/redis/Redlock%E7%AE%97%E6%B3%95%E5%92%8C%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%92%8C%E7%BC%93%E5%AD%98%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5/"/>
      <url>/hexo-docs/2025/08/13/redis/Redlock%E7%AE%97%E6%B3%95%E5%92%8C%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%92%8C%E7%BC%93%E5%AD%98%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5/</url>
      
        <content type="html"><![CDATA[<p>上一章自研的redis锁对于一般中小公司，不是特别高并发场景足够用了，单机redis小业务也撑得住。但是对于特别高并发场景的话，就得使用<code>Redisson</code>了</p><h2 id="Redis分布式锁-RedLock红锁算法（Distributed-locks-with-Redis）"><a href="#Redis分布式锁-RedLock红锁算法（Distributed-locks-with-Redis）" class="headerlink" title="Redis分布式锁-RedLock红锁算法（Distributed locks with Redis）"></a>Redis分布式锁-RedLock红锁算法（Distributed locks with Redis）</h2><p>官网：<a href="https://redis.io/docs/latest/develop/clients/patterns/distributed-locks/">Redis 的分布式锁 |文档</a></p><p>说明：</p><p><img src="/hexo-docs/images/redisImages/image-20250712181141261.png" alt="image-20250712181141261"></p><p>为什么学习这个？怎样产生的？</p><p><img src="/hexo-docs/images/redisImages/image-20250712181218952.png" alt="image-20250712181218952"></p><p><img src="/hexo-docs/images/redisImages/image-20250712181230862.png" alt="image-20250712181230862"></p><p>线程 1 首先获取锁成功，将键值对写入 redis 的 master 节点，在 redis 将该键值对同步到 slave 节点之前，master 发生了故障；redis 触发故障转移，其中一个 slave 升级为新的 master，此时新上位的master并不包含线程1写入的键值对，因此线程 2 尝试获取锁也可以成功拿到锁，此时相当于有两个线程获取到了锁，可能会导致各种预期之外的情况发生，例如最常见的脏数据。</p><p> 我们加的是排它独占锁，同一时间只能有一个建redis锁成功并持有锁，严禁出现2个以上的请求线程拿到锁。危险的！</p><h3 id="RedLock算法设计理念"><a href="#RedLock算法设计理念" class="headerlink" title="RedLock算法设计理念"></a>RedLock算法设计理念</h3><p>Redis也提供了Redlock算法，用来实现<strong>基于多个实例的</strong>分布式锁。锁变量由多个实例维护，即使有实例发生了故障，锁变量仍然是存在的，客户端还是可以完成锁操作。Redlock算法是实现高可靠分布式锁的一种有效解决方案，可以在实际开发中使用。</p><p><img src="/hexo-docs/images/redisImages/image-20250712181356201.png" alt="image-20250712181356201"></p><p>该方案也是基于（set 加锁、Lua 脚本解锁）进行改良的，所以redis之父antirez 只描述了差异的地方，大致方案如下。</p><p>假设我们有N个Redis主节点，例如 N &#x3D; 5这些节点是完全独立的，我们不使用复制或任何其他隐式协调系统，</p><p>为了取到锁客户端执行以下操作：</p><ol><li>获取当前时间，以毫秒为单位；</li><li>依次尝试从5个实例，使用相同的 key 和随机值（例如 UUID）获取锁。当向Redis 请求获取锁时，客户端应该设置一个超时时间，这个超时时间应该小于锁的失效时间。例如你的锁自动失效时间为 10 秒，则超时时间应该在 5-50 毫秒之间。这样可以防止客户端在试图与一个宕机的 Redis 节点对话时长时间处于阻塞状态。如果一个实例不可用，客户端应该尽快尝试去另外一个 Redis 实例请求获取锁；</li><li>客户端通过当前时间减去步骤 1 记录的时间来计算获取锁使用的时间。当且仅当从大多数（N&#x2F;2+1，这里是 3 个节点）的 Redis 节点都取到锁，并且获取锁使用的时间小于锁失效时间时，锁才算获取成功；</li><li>如果取到了锁，其真正有效时间等于初始有效时间减去获取锁所使用的时间（步骤 3 计算的结果）。</li><li>如果由于某些原因未能获得锁（无法在至少 N&#x2F;2 + 1 个 Redis 实例获取锁、或获取锁的时间超过了有效时间），客户端应该在所有的 Redis 实例上进行解锁（即便某些Redis实例根本就没有加锁成功，防止某些节点获取到锁但是客户端没有得到响应而导致接下来的一段时间不能被重新获取锁）。</li></ol><p>该方案为了解决数据不一致的问题，直接舍弃了异步复制只使用 master 节点，同时由于舍弃了 slave，为了保证可用性，引入了 N 个节点，官方建议是 5。本次演示用3台实例来做说明。</p><p>客户端只有在满足下面的这两个条件时，才能认为是加锁成功。</p><p>条件1：客户端从超过半数（大于等于N&#x2F;2+1）的Redis实例上成功获取到了锁；</p><p>条件2：客户端获取锁的总耗时没有超过锁的有效时间。</p><h3 id="解决方案（容错公式）："><a href="#解决方案（容错公式）：" class="headerlink" title="解决方案（容错公式）："></a>解决方案（容错公式）：</h3><p><img src="/hexo-docs/images/redisImages/image-20250712181551663.png" alt="image-20250712181551663"></p><p> 为什么是奇数？ N &#x3D; 2X + 1  (N是最终部署机器数，X是容错机器数)</p><ol><li><p>先知道什么是容错?</p><p>失败了多少个机器实例后我还是可以容忍的，所谓的容忍就是数据一致性还是可以Ok的，CP数据一致性还是可以满足 加入在集群环境中，redis失败1台，可接受。2X+1 &#x3D; 2 * 1+1 &#x3D;3，部署3台，死了1个剩下2个可以正常工作，那就部署3台。 加入在集群环境中，redis失败2台，可接受。2X+1 &#x3D; 2 * 2+1 &#x3D;5，部署5台，死了2个剩下3个可以正常工作，那就部署5台。</p></li><li><p>为什么是奇数？ </p><p>最少的机器，最多的产出效果 加入在集群环境中，redis失败1台，可接受。2N+2&#x3D; 2 * 1+2 &#x3D;4，部署4台 加入在集群环境中，redis失败2台，可接受。2N+2 &#x3D; 2 * 2+2 &#x3D;6，部署6台</p></li></ol><p>redisson实现：</p><p>redisson是java的redis客户端之一，提供了一些api方便操作redis</p><ul><li>github：<a href="https://github.com/redisson/redisson">https://github.com/redisson/redisson</a></li><li>官网：<a href="https://redisson.pro/">https://redisson.pro</a></li></ul><h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>基于redis分布式锁继续进行修改，引入<code>redisson</code></p><ol><li><p>添加<code>redisson</code>配置</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引入redisson --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.50.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>添加<code>redisson</code>配置</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.config.Config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置redis序列化</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lettuceConnectionFactory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(LettuceConnectionFactory lettuceConnectionFactory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(lettuceConnectionFactory);</span><br><span class="line">        <span class="comment">//设置key的序列化方式string</span></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        <span class="comment">//设置value序列化方式json</span></span><br><span class="line">        redisTemplate.setValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setHashKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setHashValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 引入redisson</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Redisson</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Redisson <span class="title function_">redisson</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">redissonConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        redissonConfig.useSingleServer().setAddress(<span class="string">&quot;redis://192.168.0.136:6379&quot;</span>)</span><br><span class="line">                .setDatabase(<span class="number">0</span>).setPassword(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> (Redisson) Redisson.create(redissonConfig);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>service</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.factory.DistributedLockFactory;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RLock;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> Redisson redisson;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">saleByRedisson</span><span class="params">()</span> &#123;</span><br><span class="line">        String retMessage;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> redisson.getLock(<span class="string">&quot;redisLock&quot;</span>);<span class="comment">//获得锁</span></span><br><span class="line">        redisLock.lock();<span class="comment">//添加锁</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//判断库存信息是否足够</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//如果库存大于0扣减库存</span></span><br><span class="line">            <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;卖出一个商品，库存剩余：&quot;</span> + inventoryNumber;</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了！&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            redisLock.unlock();<span class="comment">//解锁</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage + <span class="string">&quot;端口号：&quot;</span> + port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>controller</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.InventoryService;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> InventoryService inventoryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/inventory/saleByRedisson&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">saleByRedisson</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> inventoryService.saleByRedisson();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>测试</p><p><img src="/hexo-docs/images/redisImages/image-20250713185156596.png" alt="image-20250713185156596"></p></li></ol><p>bug：</p><p><img src="/hexo-docs/images/redisImages/image-20250713185555257.png" alt="image-20250713185555257"></p><p>只能解自己的锁，不能解别人的锁，所以我们更改，<code>InventoryService</code>解锁的时候添加一个判断</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.factory.DistributedLockFactory;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RLock;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> Redisson redisson;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">saleByRedisson</span><span class="params">()</span> &#123;</span><br><span class="line">        String retMessage;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> redisson.getLock(<span class="string">&quot;redisLock&quot;</span>);<span class="comment">//获得锁</span></span><br><span class="line">        redisLock.lock();<span class="comment">//添加锁</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//判断库存信息是否足够</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//如果库存大于0扣减库存</span></span><br><span class="line">            <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;卖出一个商品，库存剩余：&quot;</span> + inventoryNumber;</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了！&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//当前锁已锁定，并且是当前线程持有的才能解锁</span></span><br><span class="line">            <span class="keyword">if</span> (redisLock.isLocked() &amp;&amp; redisLock.isHeldByCurrentThread()) &#123;</span><br><span class="line">                redisLock.unlock();<span class="comment">//解锁</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage + <span class="string">&quot;端口号：&quot;</span> + port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250713185958904.png" alt="image-20250713185958904"></p><h3 id="Redisson源码分析"><a href="#Redisson源码分析" class="headerlink" title="Redisson源码分析"></a>Redisson源码分析</h3><ul><li>加锁</li><li>可重入</li><li>续命</li><li>解锁</li></ul><p><code>Redis</code>分布式锁过期了，但是业务逻辑还没处理完怎么办？</p><ul><li><p>守护线程“续命”</p><p>额外起一个线程，定期检查线程是否还持有锁，如果有则延长过期时间。</p><p>Redisson 里面就实现了这个方案，使用“看门狗”定期检查（每1&#x2F;3的锁时间检查1次），如果线程还持有锁，则刷新过期时间；</p></li></ul><p>在获得锁成功后，给锁加一个 <code>watchdog</code>，<code>watchdog</code>会起一个定时任务，在锁没有被释放且要快过期的时候会续期</p><p><img src="/hexo-docs/images/redisImages/image-20250714151449443.png" alt="image-20250714151449443"></p><h4 id="源码分析1"><a href="#源码分析1" class="headerlink" title="源码分析1"></a>源码分析1</h4><p>通过redisson新建出来的锁key，默认是30秒</p><p><img src="/hexo-docs/images/redisImages/image-20250714151823752.png" alt="image-20250714151823752"></p><p><img src="/hexo-docs/images/redisImages/image-20250714151848520.png" alt="image-20250714151848520"></p><h4 id="源码分析2"><a href="#源码分析2" class="headerlink" title="源码分析2"></a>源码分析2</h4><p><code>RedissonLock.java</code></p><p><code>lock()--tryAcquire()--tryAcquireAsync()</code></p><p>加锁流程：</p><p>加锁—尝试去加锁–尝试去异步加锁</p><p><img src="/hexo-docs/images/redisImages/image-20250714153309055.png" alt="image-20250714153309055"></p><h4 id="源码分析3"><a href="#源码分析3" class="headerlink" title="源码分析3"></a>源码分析3</h4><p><img src="/hexo-docs/images/redisImages/image-20250714153403106.png" alt="image-20250714153403106"></p><p>解释</p><ul><li>通过<code>exists</code>判断，如果锁不存在，则设置值和过期时间，加锁成功</li><li>通过<code>hexists</code>判断，如果锁已存在，并且锁的是当前线程，则证明是重入锁，加锁成功</li><li>如果锁已存在，但锁的不是当前线程，则证明有其他线程持有锁。返回当前锁的过期时间（代表了锁key的剩余生存时间），加锁失败</li></ul><h4 id="源码分析4"><a href="#源码分析4" class="headerlink" title="源码分析4"></a>源码分析4</h4><p><img src="/hexo-docs/images/redisImages/image-20250714153641986.png" alt="image-20250714153641986"></p><p>这里面初始化了一个定时器，dely 的时间是 internalLockLeaseTime&#x2F;3。在 Redisson 中，internalLockLeaseTime 是 30s，也就是每隔 10s 续期一次，每次 30s。</p><p><img src="/hexo-docs/images/redisImages/image-20250714153653985.png" alt="image-20250714153653985"></p><h5 id="watch-dong自动延期机制"><a href="#watch-dong自动延期机制" class="headerlink" title="watch dong自动延期机制"></a>watch dong自动延期机制</h5><p>客户端A加锁成功，就会启动一个watch dog看门狗，他是一个后台线程，会每隔10秒检查一下，如果客户端A还持有锁key，那么就会不断的延长锁key的生存时间，默认每次续命又从30秒新开始</p><p><img src="/hexo-docs/images/redisImages/image-20250714153727435.png" alt="image-20250714153727435"></p><h5 id="自动续期lua脚本分析"><a href="#自动续期lua脚本分析" class="headerlink" title="自动续期lua脚本分析"></a>自动续期lua脚本分析</h5><p><img src="/hexo-docs/images/redisImages/image-20250714153754434.png" alt="image-20250714153754434"></p><h4 id="解锁"><a href="#解锁" class="headerlink" title="解锁"></a>解锁</h4><p><img src="/hexo-docs/images/redisImages/image-20250714153819284.png" alt="image-20250714153819284"></p><h3 id="多机案例"><a href="#多机案例" class="headerlink" title="多机案例"></a>多机案例</h3><p><img src="/hexo-docs/images/redisImages/image-20250714163658481.png" alt="image-20250714163658481"></p><p><img src="/hexo-docs/images/redisImages/image-20250714163707610.png" alt="image-20250714163707610"></p><p>这个锁的算法实现了多redis实例的情况，相对于单redis节点来说，优点在于 防止了 单节点故障造成整个服务停止运行的情况且在多节点中锁的设计，及多节点同时崩溃等各种意外情况有自己独特的设计方法。</p><p>Redisson 分布式锁支持 MultiLock 机制可以将多个锁合并为一个大锁，对一个大锁进行统一的申请加锁以及释放锁。</p><p>最低保证分布式锁的有效性及安全性的要求如下：</p><ol><li><p>互斥；任何时刻只能有一个client获取锁</p></li><li><p>释放死锁；即使锁定资源的服务崩溃或者分区，仍然能释放锁</p></li><li><p>容错性；只要多数redis节点（一半以上）在使用，client就可以获取和释放锁</p></li></ol><p>网上讲的基于故障转移实现的redis主从无法真正实现Redlock:</p><ul><li>因为redis在进行主从复制时是异步完成的，比如在clientA获取锁后，主redis复制数据到从redis过程中崩溃了，导致没有复制到从redis中，然后从redis选举出一个升级为主redis,造成新的主redis没有clientA 设置的锁，这是clientB尝试获取锁，并且能够成功获取锁，导致互斥失效；</li></ul><p><img src="/hexo-docs/images/redisImages/image-20250714163822288.png" alt="image-20250714163822288"></p><h4 id="案例："><a href="#案例：" class="headerlink" title="案例："></a>案例：</h4><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.19.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">9090</span></span><br><span class="line"><span class="attr">spring.application.name</span>=<span class="string">redlock</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.swagger2.enabled</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.redis.database</span>=<span class="string">0</span></span><br><span class="line"><span class="attr">spring.redis.password</span>=<span class="string"></span></span><br><span class="line"><span class="attr">spring.redis.timeout</span>=<span class="string">3000</span></span><br><span class="line"><span class="attr">spring.redis.mode</span>=<span class="string">single</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.redis.pool.conn-timeout</span>=<span class="string">3000</span></span><br><span class="line"><span class="attr">spring.redis.pool.so-timeout</span>=<span class="string">3000</span></span><br><span class="line"><span class="attr">spring.redis.pool.size</span>=<span class="string">10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.redis.single.address1</span>=<span class="string">192.168.111.185:6381</span></span><br><span class="line"><span class="attr">spring.redis.single.address2</span>=<span class="string">192.168.111.185:6382</span></span><br><span class="line"><span class="attr">spring.redis.single.address3</span>=<span class="string">192.168.111.185:6383</span></span><br></pre></td></tr></table></figure><p>配置类</p><p><code>CacheConfiguration</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.redlock.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.redisson.config.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnExpression;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(RedisProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisProperties redisProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    RedissonClient <span class="title function_">redissonClient1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">node</span> <span class="operator">=</span> redisProperties.getSingle().getAddress1();</span><br><span class="line">        node = node.startsWith(<span class="string">&quot;redis://&quot;</span>) ? node : <span class="string">&quot;redis://&quot;</span> + node;</span><br><span class="line">        <span class="type">SingleServerConfig</span> <span class="variable">serverConfig</span> <span class="operator">=</span> config.useSingleServer()</span><br><span class="line">                .setAddress(node)</span><br><span class="line">                .setTimeout(redisProperties.getPool().getConnTimeout())</span><br><span class="line">                .setConnectionPoolSize(redisProperties.getPool().getSize())</span><br><span class="line">                .setConnectionMinimumIdleSize(redisProperties.getPool().getMinIdle());</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(redisProperties.getPassword())) &#123;</span><br><span class="line">            serverConfig.setPassword(redisProperties.getPassword());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    RedissonClient <span class="title function_">redissonClient2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">node</span> <span class="operator">=</span> redisProperties.getSingle().getAddress2();</span><br><span class="line">        node = node.startsWith(<span class="string">&quot;redis://&quot;</span>) ? node : <span class="string">&quot;redis://&quot;</span> + node;</span><br><span class="line">        <span class="type">SingleServerConfig</span> <span class="variable">serverConfig</span> <span class="operator">=</span> config.useSingleServer()</span><br><span class="line">                .setAddress(node)</span><br><span class="line">                .setTimeout(redisProperties.getPool().getConnTimeout())</span><br><span class="line">                .setConnectionPoolSize(redisProperties.getPool().getSize())</span><br><span class="line">                .setConnectionMinimumIdleSize(redisProperties.getPool().getMinIdle());</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(redisProperties.getPassword())) &#123;</span><br><span class="line">            serverConfig.setPassword(redisProperties.getPassword());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    RedissonClient <span class="title function_">redissonClient3</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">node</span> <span class="operator">=</span> redisProperties.getSingle().getAddress3();</span><br><span class="line">        node = node.startsWith(<span class="string">&quot;redis://&quot;</span>) ? node : <span class="string">&quot;redis://&quot;</span> + node;</span><br><span class="line">        <span class="type">SingleServerConfig</span> <span class="variable">serverConfig</span> <span class="operator">=</span> config.useSingleServer()</span><br><span class="line">                .setAddress(node)</span><br><span class="line">                .setTimeout(redisProperties.getPool().getConnTimeout())</span><br><span class="line">                .setConnectionPoolSize(redisProperties.getPool().getSize())</span><br><span class="line">                .setConnectionMinimumIdleSize(redisProperties.getPool().getMinIdle());</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(redisProperties.getPassword())) &#123;</span><br><span class="line">            serverConfig.setPassword(redisProperties.getPassword());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/*@Bean</span></span><br><span class="line"><span class="comment">    public Redisson redisson()</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        Config config = new Config();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        config.useSingleServer().setAddress(&quot;redis://192.168.111.147:6379&quot;).setDatabase(0);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        return (Redisson) Redisson.create(config);</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RedisPoolProperties</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.redlock.config;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisPoolProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxIdle;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> minIdle;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxActive;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxWait;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> connTimeout;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> soTimeout;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 池大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RedisProperties</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.redlock.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.redis&quot;, ignoreUnknownFields = false)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> database;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 等待节点回复命令的时间。该时间从命令发送成功时开始计时</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> timeout;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String mode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 池配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> RedisPoolProperties pool;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单机信息配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> RedisSingleProperties single;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RedisSingleProperties</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.redlock.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisSingleProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span>  String address1;</span><br><span class="line">    <span class="keyword">private</span>  String address2;</span><br><span class="line">    <span class="keyword">private</span>  String address3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>controller</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.RedissonMultiLock;</span><br><span class="line"><span class="keyword">import</span> org.redisson.RedissonRedLock;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RLock;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.redisson.config.Config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.data.redis.RedisProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedLockController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CACHE_KEY_REDLOCK</span> <span class="operator">=</span> <span class="string">&quot;ATGUIGU_REDLOCK&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedissonClient redissonClient1;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedissonClient redissonClient2;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedissonClient redissonClient3;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> isLockBoolean;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/multiLock&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMultiLock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span>  IdUtil.simpleUUID();</span><br><span class="line">        <span class="type">String</span> <span class="variable">uuidValue</span> <span class="operator">=</span> uuid+<span class="string">&quot;:&quot;</span>+Thread.currentThread().getId();</span><br><span class="line"></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock1</span> <span class="operator">=</span> redissonClient1.getLock(CACHE_KEY_REDLOCK);</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock2</span> <span class="operator">=</span> redissonClient2.getLock(CACHE_KEY_REDLOCK);</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock3</span> <span class="operator">=</span> redissonClient3.getLock(CACHE_KEY_REDLOCK);</span><br><span class="line"></span><br><span class="line">        <span class="type">RedissonMultiLock</span> <span class="variable">redLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedissonMultiLock</span>(lock1, lock2, lock3);</span><br><span class="line">        redLock.lock();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(uuidValue+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;---come in biz multiLock&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="number">30</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">            System.out.println(uuidValue+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;---task is over multiLock&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.error(<span class="string">&quot;multiLock exception &quot;</span>,e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            redLock.unlock();</span><br><span class="line">            log.info(<span class="string">&quot;释放分布式锁成功key:&#123;&#125;&quot;</span>, CACHE_KEY_REDLOCK);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;multiLock task is over  &quot;</span>+uuidValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><p><img src="/hexo-docs/images/redisImages/image-20250714164332807.png" alt="image-20250714164332807"></p><h2 id="Redis缓存过期淘汰策略"><a href="#Redis缓存过期淘汰策略" class="headerlink" title="Redis缓存过期淘汰策略"></a>Redis缓存过期淘汰策略</h2><p>Redis内存满了怎么办？</p><ul><li><p>redis默认内存多少？在哪里查看？如何设置修改？</p><ul><li><p>查看Redis最大占用内存</p><p><img src="/hexo-docs/images/redisImages/image-20250715165451104.png" alt="image-20250715165451104"></p><p>打开redis配置文件，设置maxmemory参数，maxmemory是bytes字节类型，注意转换。</p></li><li><p>redis默认内存多少可以用？</p><p>如果不设置最大内存大小或者设置最大内存大小为0，在64位操作系统下不限制内存大小，在32位操作系统下最多使用3GB内存</p><blockquote><p>注意：在64bit 系统下，maxmemory 设置为 0 表示不限制 Redis 内存使用</p></blockquote></li><li><p>一般生产上如何配置？</p><p>一般推荐Redis设置内存为最大物理内存的四分之三</p></li><li><p>如何修改 Redis 内存设置</p><ul><li><p>通过修改文件配置（永久）</p><p><img src="/hexo-docs/images/redisImages/image-20250715165856889.png" alt="image-20250715165856889"></p></li><li><p>通过命令修改（临时）</p><p><img src="/hexo-docs/images/redisImages/image-20250715165915081.png" alt="image-20250715165915081"></p></li></ul></li><li><p>什么命令查看 redis 内存使用情况？</p><ul><li><code>info memory</code></li><li><code>config get maxmemory</code></li></ul></li></ul></li></ul><p>真要打满了会怎么样？如果 Redis 内存使用超出了设置的最大值会怎样？</p><ul><li><p>改改配置，故意把最大值设为1个byte试试</p><p><img src="/hexo-docs/images/redisImages/image-20250715170147445.png" alt="image-20250715170147445"></p><p><img src="/hexo-docs/images/redisImages/image-20250715170155798.png" alt="image-20250715170155798"></p><ul><li>结论<ul><li>设置了maxmemory 的选项，假如 redis 内存使用达到了上限</li><li>没有加上过期时间就会导致数据写满maxmemory 为了避免类似情况，引出内存淘汰策略</li></ul></li></ul></li></ul><p>往 redis 里写的数据是怎么没了的？它如何删除的?</p><ul><li><p>redis过期键的删除策略</p><ul><li><p>如果一个键是过期的，那它到了过期时间之后是不是马上就从内存中被被删除呢？？</p><p>如果回答yes，立即删除，你自己走还是面试官送你走？</p><p>如果不是，那过期后到底什么时候被删除呢？？是个什么操作？</p></li></ul></li><li><p>三种不同的删除策略</p></li></ul><h3 id="立即删除"><a href="#立即删除" class="headerlink" title="立即删除"></a>立即删除</h3><p>Redis不可能时时刻刻遍历所有被设置了生存时间的key，来检测数据是否已经到达过期时间，然后对它进行删除。</p><p>​立即删除能保证内存中数据的最大新鲜度，因为它保证过期键值会在过期后马上被删除，其所占用的内存也会随之释放。但是立即删除对cpu是最不友好的。因为删除操作会占用cpu的时间，如果刚好碰上了cpu很忙的时候，比如正在做交集或排序等计算的时候，就会给cpu造成额外的压力，让CPU心累，时时需要删除，忙死。。。。。。。</p><p>这会产生大量的性能消耗，同时也会影响数据的读取操作。</p><blockquote><p>总结：<br>​对CPU不友好，用处理器性能换取存储空间（拿时间换空间）</p></blockquote><h3 id="惰性删除"><a href="#惰性删除" class="headerlink" title="惰性删除"></a>惰性删除</h3><p>数据到达过期时间，不做处理。等下次访问该数据时，</p><p>如果未过期，返回数据 ；</p><p>发现已过期，删除，返回不存在。</p><p>惰性删除策略的缺点是，它对内存是最不友好的。</p><p>如果一个键已经过期，而这个键又仍然保留在redis中，那么只要这个过期键不被删除，它所占用的内存就不会释放。</p><p>​在使用惰性删除策略时，如果数据库中有非常多的过期键，而这些过期键又恰好没有被访问到的话，那么它们也许永远也不会被删除(除非用户手动执行FLUSHDB)，我们甚至可以将这种情况看作是一种内存泄漏–无用的垃圾数据占用了大量的内存，而服务器却不会自己去释放它们，这对于运行状态非常依赖于内存的Redis服务器来说,肯定不是一个好消息</p><blockquote><p>总结：</p><p>​对memory不友好，用存储空间换取处理器性能（拿空间换时间）</p></blockquote><p>  开启惰性淘汰，在redis配置文件<code>lazyfree-lazy-eviction yes</code></p><ul><li><p>上面两种方案都走极端</p><ul><li><p>定期删除</p><p>定期抽样key，判断是否过期</p><p>有漏网之鱼</p></li></ul></li></ul><p>  上述步骤，有漏洞吗？</p><ol><li>定期删除时，从来没有被抽查到</li><li>惰性删除时，也从来没有被点中使用过</li></ol><p>   上述两个步骤=&#x3D;&#x3D;&#x3D;=&#x3D;&gt; 大量过期的key堆积在内存中，导致redis内存空间紧张或者很快耗尽</p><p>   必须要有一个更好的兜底方案……</p><h2 id="Redis缓存淘汰策略"><a href="#Redis缓存淘汰策略" class="headerlink" title="Redis缓存淘汰策略"></a>Redis缓存淘汰策略</h2><p>在<code>MEMORY MANAGEMENT</code>标签下</p><p><img src="/hexo-docs/images/redisImages/image-20250715173414780.png" alt="image-20250715173414780"></p><h3 id="Lru和Lfu算法的区别是什么"><a href="#Lru和Lfu算法的区别是什么" class="headerlink" title="Lru和Lfu算法的区别是什么"></a>Lru和Lfu算法的区别是什么</h3><p><strong>区别</strong></p><p>LRU：最近最少使用页面置换算法，淘汰最长时间未被使用的页面，看页面最后一次被使用到发生调度的时间长短，首先淘汰最长时间未被使用的页面。</p><p>LFU：最近最不常用页面置换算法，淘汰一定时期内被访问次数最少的页，看一定时间段内页面被使用的频率，淘汰一定时期内被访问次数最少的页</p><p><strong>举例</strong></p><p>某次时期Time为10分钟,如果每分钟进行一次调页,主存块为3,若所需页面走向为2 1 2 1 2 3 4</p><p>假设到页面4时会发生缺页中断</p><p>若按LRU算法,应换页面1(1页面最久未被使用)，但按LFU算法应换页面3(十分钟内,页面3只使用了一次)</p><p>可见LRU关键是看页面最后一次被使用到发生调度的时间长短,而LFU关键是看一定时间段内页面被使用的频率!</p><h3 id="有哪些（redis7版本）？"><a href="#有哪些（redis7版本）？" class="headerlink" title="有哪些（redis7版本）？"></a>有哪些（redis7版本）？</h3><ol><li>noeviction：不会驱逐任何key，表示即使内存达到上限也不进行置换，所有能引起内存增加的命令都会返回error</li><li>allkeys-lru：对所有key使用LRU算法进行删除，优先删除掉最近最不经常使用的key，用以保存新数据</li><li>volatile-lru：对所有设置了过期时间的key使用LRU算法进行删除</li><li>allkeys-random：对所有key随机删除</li><li>volatile-random：对所有设置了过期时间的key随机删除</li><li>volatile-ttl：删除马上要过期的key</li><li>allkeys-lfu：对所有key使用LFU算法进行删除</li><li>volatile-lfu：对所有设置了过期时间的key使用LFU算法进行删除</li></ol><p>2个维度：</p><ul><li>过期键中筛选<ul><li><code>volatile-lru</code>、<code>volatile-random</code></li></ul></li><li>所有键中删选<ul><li><code>noeviction</code>、<code>allkeys-lru</code>、<code>volatile-lru</code>、<code>allkeys-random</code>、<code>allkeys-lfu</code>、<code>volatile-lfu</code></li></ul></li></ul><p>4个方面</p><ul><li>LRU</li><li>LFU</li><li>random</li><li>ttl</li></ul><p>平时使用哪一种？</p><ul><li>在所有的 key 都是最近最经常使用，那么就需要选择 allkeys-lru 进行置换最近最不经常使用的 key，如果不确定使用哪种策略，那么推荐使用 allkeys-lru</li><li>如果所有的 key 的访问概率都是差不多的，那么可以选用 allkeys-random 策略去置换数据</li><li>如果对数据有足够的了解，能够为 key 指定 hint （通过expire&#x2F;ttl指定），那么可以选择 volatile-ttl 进行置换</li></ul><p>如何配置、修改</p><ul><li><p>直接使用config命令（临时）</p></li><li><p>直接redis.conf 配置文件（永久）</p><p><img src="/hexo-docs/images/redisImages/image-20250715175029639.png" alt="image-20250715175029639"></p></li></ul><h3 id="redis缓存淘汰策略配置性能建议"><a href="#redis缓存淘汰策略配置性能建议" class="headerlink" title="redis缓存淘汰策略配置性能建议"></a>redis缓存淘汰策略配置性能建议</h3><ol><li>避免存储bigkey</li><li>开启惰性淘汰，<code>lazyfree-lazy-eviction yes</code></li></ol><p><img src="/hexo-docs/images/redisImages/image-20250715175055684.png" alt="image-20250715175055684"></p>]]></content>
      
      
      <categories>
          
          <category> 后端 Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>epoll函数和IO多路复用深度解析</title>
      <link href="/hexo-docs/2025/08/13/redis/epoll%E5%87%BD%E6%95%B0%E5%92%8CIO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/"/>
      <url>/hexo-docs/2025/08/13/redis/epoll%E5%87%BD%E6%95%B0%E5%92%8CIO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h2 id="epoll-函数和-IO-多路复用深度解析"><a href="#epoll-函数和-IO-多路复用深度解析" class="headerlink" title="epoll 函数和 IO 多路复用深度解析"></a>epoll 函数和 IO 多路复用深度解析</h2><h3 id="没有-epoll-和-IO-多路复用之前"><a href="#没有-epoll-和-IO-多路复用之前" class="headerlink" title="没有 epoll 和 IO 多路复用之前"></a>没有 epoll 和 IO 多路复用之前</h3><h4 id="多路复用要解决的问题"><a href="#多路复用要解决的问题" class="headerlink" title="多路复用要解决的问题"></a>多路复用要解决的问题</h4><p>并发多客户端连接，在多路复用之前最简单和典型的方案：同步阻塞网络IO模型</p><p>这种模式的特点就是用一个进程来处理一个网络连接(一个用户请求)，比如一段典型的示例代码如下。</p><p>直接调用 <code>recv</code> 函数从一个 socket 上读取数据。</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> ...</span><br><span class="line"></span><br><span class="line"> recv(sock, ...) <span class="comment">//从用户角度来看非常简单，一个recv一用，要接收的数据就到我们手里了。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们来总结一下这种方式：</p><p>优点：</p><p>就是这种方式非常容易让人理解，写起代码来非常的自然，符合人的直线型思维。</p><p>缺点：</p><p>就是性能差，每个用户请求到来都得占用一个进程来处理，来一个请求就要分配一个进程跟进处理，</p><p>类似一个学生配一个老师，一位患者配一个医生，可能吗？进程是一个很笨重的东西。一台服务器上创建不了多少个进程。</p><h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p>进程在 Linux 上是一个开销不小的家伙，先不说创建，光是上下文切换一次就得几个微秒。所以为了高效地对海量用户提供服务，必须要让一个进程能同时处理很多个 tcp 连接才行。现在假设一个进程保持了 10000 条连接，那么如何发现哪条连接上有数据可读了、哪条连接可写了 ？</p><p>我们当然可以采用循环遍历的方式来发现 IO 事件，但这种方式太低级了。</p><p>我们希望有一种更高效的机制，在很多连接中的某条上有 IO 事件发生的时候直接快速把它找出来。</p><p>其实这个事情 Linux 操作系统已经替我们都做好了，它就是我们所熟知的 IO 多路复用机制。</p><p>这里的复用指的就是对进程的复用</p><h3 id="IO-多路复用模型"><a href="#IO-多路复用模型" class="headerlink" title="IO 多路复用模型"></a>IO 多路复用模型</h3><h4 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h4><ul><li><p>IO：网络 I&#x2F;O</p></li><li><p>多路：多个客户端连接（连接就是套接字描述符，即 socket 或者 channel），指的是多条 TCP 连接</p></li><li><p>复用：用一个进程来处理多条的连接，使用单进程就能实现同时处理多个客户端的连接</p></li><li><p>一句话</p><ul><li><p>实现了用一个进程来处理大量的用户连接</p></li><li><p>IO 多路复用类似于一个规范和接口，落地实现</p><ul><li>可以分 <code>select -&gt; poll -&gt; epoll</code>三个阶段来描述</li></ul></li><li><p>动画演示</p><p><code>IO multiplexing.gif</code></p><p><img src="data:image/gif;base64,R0lGODlhkAF3APfKAAEBAQsLCxMTExwcHCMjIysrKzMzMzw8PERERExMTFRUVFtbW2NjY21tbXJycn5+fv8CAv8NDf8kJP8sLP80NP88PP9DQ/9MTP9UVP9bW/9jY/9sbP9zc/98fAHtARPvExzxHCXxJS7xLjXyNTzyPETzREvzS1X0VVr0WmP1Y2z1bHT2dHv3e+2WAO+aAu+eDvClHPGrLfGuNPKwN/KxOvO1RfO3SfO5TPS7VPS+W/XAXvXBY/XFa/bHcfbJdfbLfAEB/xER/xwc/yUl/yws/zQ0/zw8/0RE/0tL/1NT/1xc/2Nj/2xs/3R0/3x8/5wV758c8KMm8KYt8acw8a4/8q5B87BF87NM87ZS87hX9Lpc9L1i9b9o9cFs9cRz9sd59sh99oSEhImJiZKSkpycnKOjo6ysrLOzs7y8vP+EhP+MjP+Skv+cnP+lpf+rq/+0tP+7u4T3hIT4hIv3i4z4jJL4kpr5mqP5o6v6q7T6tL37vffOg/jPhPfRi/jSjfjUkvnXmfnYnPncpvneq/rgr/ritPvlvYOD/4yM/5OT/5qa/6Sk/6ur/7Oz/729/8uE986L99CP99GR99KU+NWb+Nag+dml+dyr+d+z+uC2+uO9+8XFxcrKytPT09vb2//ExP/MzP/T0//c3MT7xMv8y9T81Nv92/vnwfvoxfzry/zu0/3x3MPD/8zM/9TU/9zc/+fF++jH++rM/OzT/O/Y/fDd/eLi4uzs7P/k5P/s7OX95ev+6/305P736v747uTk/+zs//Pk/fbq/vju/vX19f/09PT+9P768/T0//rz/v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAQyAAAAIf5URmlsZSBzb3VyY2U6IGh0dHA6Ly9jb21tb25zLndpa2ltZWRpYS5vcmcvd2lraS9GaWxlOlRlbGVwaG9ueV9tdWx0aXBsZXhlcl9zeXN0ZW0uZ2lmACH/C05FVFNDQVBFMi4wAwEAAAAsAAAAAJABdwAACP4AlQkcSLCgwYMIEypcyLChw4cQI0qcSLGixYsYM2rcyLGjx48Nb3XyRJCYp07EQKpcyXKgLU4wOXlK2bKmzZs4czYME4ABTWWbChjgpLOo0YPEGhBAgOAAgjI/j0qdSrWqQQYCFtwSSOwBAAW2rIpleSvBA65jEnQay7at2463mCbYqgzNAQIOPJnZSgwNGmV6w94iQ/StYYS2CpgZSCzBJsBkwpBZq8zWGTRjxKDxFPmMSTMp+z7utFfZYMqHU6v2uOmAgwOCHShQQKZMApK3GJzlhIAMMTELCq9OvYkAamUJ0HRi4CAMgwWPzxhgEAZBgQdjGBxAQyZBWFsLxP4APQD6wYLjw9Orh2jbTAGSZ2gr2PSAwdayi4k5oK5A+Pq2vxnwky0KmMGAGCnldtYYCPxFxgBnALbAGQ44kJInCURIDAMNPKAAev+FKCJBsnViwBm2HFgGAp2El1InBRRmV4NRjVgVMQsoQNAmCjgwgFMIJHAAGcroRgwxaaVkRn8JjJHSJgZQJp1jNlY5Io4WDjmGAp6E8SECiyljhoACnUGAd1aKRYwBYRDkHAJjxAQTMbYcUIYy+jkgEHCtPUYMGQjQZMYAWqVpaHqePFWkdmak+AAaCRB1SwMM4LnJAtr5d6hRnRAQIZ7SrfgXnmhEiAYCj5VFZG5hnMFiZf7MCYSGAgxEuemthkH6lwNnEtNJAmW4N5kYBIjXYhi3LGAhrkYNesZJgIZBTBgTdlLGhMpcu1ZioylQRhmKdRLGAERyosAYZUnL7LpWUUiSbY9xwoBM2iFQHxq3hPHAVmcsEBa7OJFxwMAHTJjgawc08Fi2yAKlwIsPwLTAAQnst8ktDoixVRn2AezxxyCHLPLIJJds8skop6zyyiy37PLLY3nCSY0w14zRSzTbzNYmwOas888PcZKAbyK/cQEFHeDCUjECbRCKQ8WoQcEbCyFpAFRAZx3RnwYQ3dAbGCCt9EpMK7MBKFCvQYEbCMGRxieipJEG08XkQncuditTdv4xZeMtUN515yJQ4EyrkYYyaoQS+OB1lz2QKBZAwIHjCFkNmtaYN8S11wq5/UkocjONN92N683434IrA7jfeo+OeAeIK8666nkTJMoFEGxAuUChJC5Q3MWEkgEFHOSyAQYWpIFLB58os4YayrBhwQVthDLBGp+oUQEFbOCSBgUXuAEKBROAgkEbHVCAAdrSY7DB2AK9McEEFjxd9RhX+5z5/niS0bX+yugd2pQRt1yEQgPEywUHkKc85kVPDcWQHvVEcT1QqMEC3PMeBSwgPvKZrw3fW1/0LOA++CkDDvOrwAAJ0gYOFMR43VNDGzaggU9UQBRsUEPcPtEGC8ABF/4ZQGEo2pCBULiNDRzAIQaUkQbYXeACaRCFG1yohgt8wooDKUYHLKC2NhSETrYIoxg94YACkMETYkyjGtfIxjamEYD86wgY3UjHOraxSwUYAxrFGJUpFqQYG1gDLmRIQxviUIdvc4MF3gBEIboBA6F4QxrY0AFRtOECr1PGE5X3BheuwQJXhEMW01CBLhqkDRpwXChEUQHBGW4DXqQALkBRww4UgwMVYIMbNKA9ZXxiA2pwQyhA8QY4bJGJToQA2kJRgUxi8XcVqIAaJDA5xpyhARXKZjYNkBVtevOb4AznNxvwqTi2xAzYFKc616nOAwSgR9lEw0+IqEpctNJ5Hf6ApTJkSctP2BKXuuQlBXzJS2ES05gWyCQGlBnAZq7BhRcQpUDsKU1q7u4TGWgD00RRxAo8TW76lCUuNpCGNSiDAxLAAAK/p7o3sCENF9BAB9pwQSYe7gIRoNoVEQdRiZ4wpRmoQP0YQxozGPWoZnhAAWiD1KY61ajBeqpUzXAt8ZiTJdNiQFSn6tStclWqYSjA0JA6k4GAIgNs+F1HP5qGkOJipGmAXgdSutKB5sKlMJUpTROqBidGwA3F+ERCH6oMDPgUDkCNpv2y2Ab35XMNuUiD+4KoAS9OABdRswDa4LCBDvT1EwONm2cxUAENyO2GasAALiyggQzQ8HBqcP6hDweHS6Yhlm0LERoD/rWSaY3hqlgVg1Vr0gkFLIAkCSlGYzsbyMhO9g2VVcZli7EGFZ6ws5+dgDIGyYHUllZuFAjFGlR7gQxkgAMZgG1PB5c+207AiwaBg+EAu12avqEYcBCFMjRKQNwG9nmfyAV8s4c9UDyvDW0QRSi694ZIqqF7ygBF8xg5uDdQrb6LRYhuedtb7AC3t2EYLkuEdtyGZC8N/MWFffH7NP5acnCfALCABULgTxg4mAleMC4a/IYHK03CyqCw3iz8tzaskFmbQMBubTItEX/YI2FQ14gTwADkPhknnUBAAziMVQ9f2SNNbgmGqvzlnHCCDFzu8v5vy8yR3zj5I504I5txcqScdGXNc9ZIiOGIkTrnmV1defOfJ+LmQT/Zt4a+SJP5nGibBbrRFSk0pON450kTes+W3l+lMx0R4XI6c5v+tOaEy2hRpywpbTI1Q/Kk6p/9ZgAEIFKrEzIGAhAAz7M2TCc8cxNOEAAAADiAlXM9EBgBuwAg+nIveOGLmzTbIb1Y9rMT0hoE2WQTAwC2AYZNbGV06tjJ/vAxBFEDGfBAFSzxRbN3kIqGpOIFMJABDtqtkDFZuyX6CYAAnNTtkoRBAAKQcpmPUYg+rOIYgPjBMY6xilOsQhmrUEUqeAHxYyiDFxT3RSpSsfCJH4MXqEhFL/4uHvKF94AHx+iDKkCO7otL/OEDQUULdqCMQvSg5ZWzd6kVbYAE9NsgxHDKzjGHCj7AvBeBOIYhclCDHvBiBze4AQ944QNDpNwPveDDDXLwB1XAIBCn+AEOaMAHVfTABjcAhCpoQANVpL0HNciBIZTxB3nrAObKkDnNe6FyhpzhAPfu7QAQ8PMvCmXoWhNEDwriCx0MIuWB4IEPVkEDXgjC6GUPRA04voNCxMDyN5B4IATxB18EwgbK4MMelGEDGpTeEDT/Aw7cfoqYt8D1OdjDyLlii03IKSZldIDvYzL838Nk+J2gi0NsEYACIN7StxjAAJQfEuPLafjF/332Y/6SZhsJYgfTLsQqZmDxPvyAB4JQxgx4kYodGELhPIgBD35wgx/QQBmq+MEP/FCIUwBCED5QA6n3A6znAui2dspgfspwA3MnEKjgAjHgAzwQetbUABZ4gelkAO/kABiITR14gRyILQ9hBgEwAKNSeMpwBgB3gg1xLRVigRwIgx84gzMoT4eiCjrABxaHCrNXA1b3A32AfurHC73AAz0ACMpgf3vwBzfwB/fHC4RQCORWA35wCpqXeqtnAzAACAR3AwlIgDdQew7YAjyAfzTQgHjSe5vge2y4CcGHBmsYh3I4h2u4AAKAKg/BAAAQAKmGgg4QAAGgJw5hFwLAAHR4iP6csIaJeIhx2H02snRolwOF4AuAcAM2MG87kH4yQHGa93Cp0AM5sAM/kApPyAc4sAM7gANxxwM0kAp/YAOrUH84YImBkIA+wHpoKHMwoIo+QHEL8XcNEzTZBgCFwhCJAWyBgoK3YADaRn0JYQsJAG5AswqGYAj0dgypYAjotgojx3HK0Av0BnGnYAgH13LUeAoYN44St2yo4Auq0AuqYI0WxwsPpwrTdgzjaAinsHv1xiaIR4LI6IgFMQYCAGwEECY/VwYFCQADcCcM4QnMCAACwIIoKEdjInAPAY0lGHgKURvMESwo+C0cApKr9m8BUIwV6RGcAHjOmJFmsAmldv4kYeAkz9doR0JqMYkGpZGScMZrNxFqKBhmPIkyQpmSmDaUJoNoKSlpSFkyj8aTR9mUIwOUhbdoUkkyVFl4IXaVWLmVS+lpXCkyWdlvVhmWIDOW/QaWZmlnNWkRaElsZbmWvYZmdOZlRsmRbAYMrOAIr5AMNuEKyOAQwNAKjgCYCpFlDiCQYOaVFcmUc/YLiqAESLAEjuCXKvEKr6AMS9AKDfEKTnAER4AEihCY1IYAiclkM8mTcVlmwLAIigAMysAITYAMyNAIieAIysAKjaAIrYAMjgCbrsCZr+Cav9CarTCYiaAImdkKibAIv/ALSYAEv3AIrsAKicAIgekKjP6wCKxAmsjgBEIwmk4wBLipEEm2ZAlBDLfQliWRMUP5AH3oli15Mo7gBLCpDLUJDIywBEzQBK6wBJOpBL/gBNh5CMrJBEvgBE7QCkKwCI3ABE6QBE3gCPy5BIfwCtH5CkhwCEzQoYygDIhABEyQBK4gEK8gBEcAm6+QCJyZW1TmiL+xAGHAbRIxJgewMCj4d9txEZ3gAAvAOSizCExQEMCQBJWJCImwBIgADEXwC43gBK7gBK+ACEjgCsnABIxQBK2JBKzwCo7QCIwADIpwBCB6CMqABESwCMnACkkAoksADFwqEK4ABEhQOUVlBmeAVGW0AFuVp0b1AAUZAHgJEf4QCWx28lWI+lVlIAYhxqiOKlxiQAaJOqmU+lWR0aiPKlxRBqmRWqmJWgYRKWyR9ocSGQZH5aeIegYocSiMIKADoQiuUASBiQiHsAQf2qT/2QhmygRCgARIUARNYATK8AuJ0ARMkAi6WqxkeghOcKZAUKKuQKaI0KxxqgyvEAQpqgz6mZlcQSHhpIHK4k0NcADABgA+URGbsJCFyE7sKk61YgDwKhTwagBCAU/teq/4+k0KQK/x2q/yyq8GoADplK/itAABYJCaAhHJUq6mSbA2aCi/wJ+/kAyNoAQa6pxOkKS3WpxNsASLAKJIwAiN4LHCOpyswApHUASwugjLSv6tQ3AIv8AIbTqtZ1qeyMCri4AMiWAELSoQt7BHtrBHZGRGQBu0QYsGBQAAB8meC9sTRTtGbPS0YSS1Rhu0nXC1WJu1I0G1QFu0aOS1dkS1adS1Wlu2WusJX1tHYgu1QWuwPcGeyvAgAGAAm9C1UTu1fHQrrsAERVAEStCbjPCrSrC3H2oEv6AMiyCd1hqsG9oKZAoMiGAER+AEfGsES3AEjqAIVZoEiLAERXAEjaAMidCsScAKAzGgRvC5iXCf6ek/WIMU1gKTF2ELwTKfxHYLRmW7D9EXZUCjKIMMz3mfyQAMxYmfgXmfyMC6wPsLxysQy0ubxQkMwJAMwEubyf5bnH5Jm9pqmc5LvNN7P/lTNXJJaHBbEuOrOfjzuue7viLCM+rLvvCrHjJTvvFbv/Z7v/ibv/q7v/zbv/77vwAcwAI8wARcwAZ8wOqhngi8wBlBH+HmEOvJwHhCvx9jCnZAB3pgDDaBB7rQELpQB3RAB3mgwQnhCbPxwApBDGdAHSj8vz3KABQJM6YwByywAiqAByQMEqMwCsqwAqXQEKPgASKgAiVgBzl8EJ6QIy18EMZmrhQslws7t77LMrpgBzisDHqgAsawC3SAAndgDHdAByswwndgCliMB8pACivgw7owxqaQByqgAqNgDHmQAixQCqVQAiRQCiswCniQAv5x0MF6EAcs8MUDEcRajAIiYMYKkcQfEhFmwLCK2b8mAmwBEMMtkwcsQMLGUArGUAcrYAcsMAopYAJzYAKmIAd3sAtxcAekgAIsYAcpMAogkAd1fAc2/MeirAK7kAIosAslYMN2EAd2oAx0MAKn/MMCQQoekALKoAIewMMLkcRqQajkyodPvJb5BgAIMMkocwcqUBC6UAI/PAdzkAJGPAK6oAcrQAoswMom4MmFPALGgAcmkAemUAqjoAe6QAcloAxzEAfKYAK1nMYmYMxabAJ6cMjN/MwesNBcsQljMNEUPdFldAAzWdEavdG14gC6C8C5YQAOsNEkXdIkPTOHkv4HKKDMxnDH9AzQcXDDyqDOppACdyDQKvABIjACIbACJKAMu4AHK4ACK4DLcbAC/xwHAm0CHvDDpPDPNDzQEK0MQezMKBDN1vQAWr3VWu0ABjAAusHVD+AAYk3WWx0GCVvA9CHWY83VZl3Wbs3VsmsouzDUo1DFKaALKBAHaizLdzDTurALLHACeaAMdoACeaDGefDTFqwHTx0CdlAKd0ACxnDUxmACI9DHhw3QLCDVDI0CejACqFwSR1LaR2ILDWAA8mTarN3api3Brh3bsh3bt6ILcUACI6ACpmAMeoACua0LLLDQJ7ALylDHxK0Lc0ACJUAHpoACymAMdqDcIP5MAiSgAifgxyutArg8Atdt2HTwzNKcxjs9AigQ3gmBMTtaE362lNkMM0dcEe+NEMYQ3wxB3waB3pj8EZ4Qqd5sap4w0VMswQOB3zYBjcB2roV3CwoAbAvQ3vl7Kfn9EekqjYXHCcM4AGkt4AIRtDjhCeT6FR9tagYOAHOh4WLRGtVckbyBABlu4kWhH4LWb1Hm4mqSmksZlTQuFUVZkYyZ4zpul0FJaj4+FW+Za6s55DpR5Lmmlkj+4g8Q43AZZQ6ev7fQ321m43fZ5AKxCTBMZz1elV/OZrLwCF1gCdzLEpQQDA0RDF7gBV3QBZhw5gVhC68R4WAG5CiI42U2C/6TcAmY8AhmvhKYcAnKIAm00BCy8ARZkAmZUAsLQeDqjec/d+RXFgyUEAsCQQuPkAzB8AhZMAnJIAmPwAWWMAyUcOiYYAnKoAlcwAWwEAxbcAm0cAlaoAWYgAyWkAVcIAuzcAVXMAuuXglZ8AVqjgltPgnDMBCJ/gUPAelYFeY/B+1PlgmQwL3DkAyRMAmyMAma8AVwrgXBYAmXEAzcDgtacAmy0AWxUAWyYOyyYAmA/gXvzgXJAAmbvgVcAAnvPgnKQAlYgAm7ruxP4AXDcO1f5NqovR2zvfAMX9oYg2tVyagNP/EU39q3cglgwL2cngVqTgmT8AWEfgXBEAtgIP4L1Q4JWyALtQDoWLDqXHAJsxAMsxALtDAJWqAMkxAJyrAFUoDps3DzlLDpXIDpAiELUDAFV1AFsFASaKDV+uL0Y20ABEAdZw2fVg/1+hJlUI/18Pn0We8hED/pYqAAVf/1V7/1XX/WWn/2X9/2Vp/1c50msNAFS68Mw/AFtYAFwoDzH48JynAFwhAMX2AJ/P4IUnAFWUAFkNDyyQALk3Dsj0AJkHDzOa8MWhAFsqAMP9/vkLDzda8Mie4FyiDnxLAJYpAZFH36ZWQA2IH6E336p//6sY/6s58Zsw/7Gt3ixMYJqf/6rv/7tw/8uJ/6tQ/7sQ/7KG0oyTAJXXAJmv4gCZAQDGAABpfwBcbu91YQDMuvBUuPCSCvCZAAC1egDLRACZcAC1tQBdxuCXpPCV+ADFqwBV5wCfbe74/g+QKvBZqgCbMg50jMAACRgJMyggUNHkSYUOFChg0dPoQYUeJEihUtXsSYUSPFZJe8cJk0TBktSFwoJbMkSxmkZMpkTWrZ8csXTMEgKUuWyQtNnV4mQZoF61EwSrAodXlUS5kmTMooKSVYq0sXLiZFMvS0IEGnjV29fgUbVuxYsmXNngWbdStatm3dvoUbV+7crlkVcKWbV+9evn39+t3kAO9fwoUNH0acuCCxW4odP4YcWfJkypUtX8acWfNmzm0DAgAh+QQFMgBHACH+VEZpbGUgc291cmNlOiBodHRwOi8vY29tbW9ucy53aWtpbWVkaWEub3JnL3dpa2kvRmlsZTpUZWxlcGhvbnlfbXVsdGlwbGV4ZXJfc3lzdGVtLmdpZgAsAAAAAJABdwCGAgICCgoKERERHR0dJSUlNTU1Ozs7Q0NDS0tLUlJSXFxcY2NjbGxsc3NzfX197ZcA7pkB758O8KUc8asr8q408q868rA28rE787VE87dJ87lM9LtT9L5b9cBf9cJj9cVs9sdy9sl09st8goKCioqKlJSUnZ2dpKSkqqqqtra2u7u7986C+M+F99GK+NKN+NWT+NeZ+dmd+dyl+t6r+uCv+uK1++W8xMTEzc3N0tLS3Nzc++fB++nF/OvL/O7U/e/Y/fLc5OTk6+vr/fTk/vbp/vjq////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB/6AR4KDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy86xGRvT4+a/29/r+/6X4PeJnz1RBRwIBKlSWcBHBg0f6CZJo6KBEiBbvFcRIcWLDhSCLfTyU8KFJghE1nlzJciPKQQ9DyiQWpKYiiDBb6tSZMiXKmDlHzhzKq4HRRDh/CjTpU+nKnktV9vT4kqhVXSiyokCaMapLp2CZfoUqlWrVq2hnnSW5U6rXsP5tXU6dKjSt3VVrEb1UGtFj0JJx+XKkerdwvbqGE7/Lq7hxO8SOI0ueTLmy5cuYM2vezLmz58+gQ4seTbq06dOoE+tIISS1a185DoxoDYkILiK4Zw4gkJkAb1IqCsx2JCMDhQ8+THng0ahHBAkUODAHiSNHZhw4TAUfvqhGCyBHYIQQ9GMHeCA/etgGf4TIEEE9esC3TYTHdCI75B8J4eGIix9D8JBce+mxB98DHBxRAwg/LASZYziNooIB3CHSwwoGxnCEDRxk8MEQH2SgwYch2OBfC0ewoAEH/0kAww4ibHABCz6AIOILP1xwgQ8avBBCBhyY+AIFG3BgYA8P9P53RAsDAsQYhA92MgIBDSgywweGdDCDfzB8EAIQFwAxA4Yr+BADBvJ5UMMEYmrgQw8xyOACEcX5J8IRGlzgwob9vbDBDxqYCB8EFLzAwQogPdmYop8YEEACicyQ4CA1AEGBIC+I8IEMR1AwhA8d2HAnCBN8IEIGK1hwhA8iiNBCDTzEGQIGS96pAQTJ5XiEj0dsIOgRPUAwQQgfaKCfk1EaxqiUBDCgyA8eIArsnxiYuEILm3Y6BBFevnDEChWs8EKPqhJBQw0zZICBCzucWSueLm6Ywa7j+ToIkv2B+as/QFHGFHAGOEBbIjt0WOSWMGSQwQY8eMCpp0fEECawIP5w4IEIPZSrogcebADkBxfw8EIGQGgQQocZaOgCCL3WMAgPEEigQQYh2Ibssnf9K8qEAjcChA02NNmDDQ0CYduxTQKxg3nACjKEDTsMMcQOQatX36pE/GCDfkSA1yAhVANtszoBGHBDIzpLlnYiwQUwSXA9vwbJCQkMUMLAXHXkr96HBDHCAAucIAkOB8QtNyQpDBAAAqw5xLfajw8SRAoGAEDA2ZKshvfhj4wQAACPorA5IRHunYgQJyDweQAlcJ5KbACArkB2ekUOZSI3qB57Ajq4ngoJnw+Aee2ZlU6ICgKAboLvrxewQAIJ0M5W8ZHnroACB/TOPCom6BDEAv4ISF+I8ZAjcsMBDASBg+Dbr6ID+OLnRP0h56ff/ivvh1+R7YvqXX8Q94NF/uJHvshE6H8BjMUAScc/xeAEgQlUIPzkhxmIQDCCClRA9PxSwX5cEIMZ1F8Bb/dBEIYQB0IY3WSEEIQSmjAW3zuAAhaQmQVgz34vtAXyOjOA+OXwh0AMohCHSMQiGvGISEyiEpfIxCY68YlQjKIUp0jFKlrxiljMoha3yMUuevGLYAyjGMdIxjKa8YxoTKMa18jGNrrxjXCMoxznSMc62vGOeMyjHvfIxz768Y+ADKQgB0nIQhrykIhMpCIXychGOvKRkIykJCdJyUpa8pKYzGQkAgEBACH5BAUyAD0AIf5URmlsZSBzb3VyY2U6IGh0dHA6Ly9jb21tb25zLndpa2ltZWRpYS5vcmcvd2lraS9GaWxlOlRlbGVwaG9ueV9tdWx0aXBsZXhlcl9zeXN0ZW0uZ2lmACwAAAAAkAF3AIUBAQENDQ0TExMcHBwjIyMqKio0NDQ7OztHR0dKSkpSUlJbW1tjY2NsbGxycnJ9fX0BAf8TE/8cHP8lJf8vL/81Nf88PP9ERP9MTP9TU/9bW/9kZP9sbP90dP97e/+BgYGNjY2UlJSampqjo6Ourq6xsbG7u7uCgv+Njf+Tk/+bm/+kpP+rq/+zs/+8vP/FxcXLy8vU1NTe3t7ExP/MzP/U1P/c3P/g4ODu7u7k5P/s7P/y8vL///8AAAAAAAAAAAAG/sCecEgsGo/IpHLJbDqf0Kh0Sq1ar9isdsvter/gsHhMLpvP6LR6zW673/C4fE6v2+/4vH7P7/v/gIGCg4SFhoeIiYqLjI2Oj5CRkpOUlZaXmJmam5ydnp+goaKjpKWmp6ipqqusra6vsLGys7S1tre4ubq7vL2+v8DBwsPExcbHyMnKy8zNzs/Q0dLT1NXW19jZ2tvc3d7f4OHi4+Tl5ufo6err7O3u77I88vD0bPLzUDx49/XO9/pN/gEkg2+JwIH9kv1jwg9fw4ZCHAKcx69HRYoLLVaMiBFhwmMZkWzUd/CgRo0lU6okGfKix4/GYMhUUnBIx5U3V558iLKg/kmYyxoITVLTZU6WAnua7LiTpc2fQI+9mEpT4sOjSo8uZIrxJEekUUFuFJm0ZFOkW3GmbPo0aVhiIav67DqwLsSsSzNSLOJW1YAQL/vxeCBgSlyYL3aMpXdvhwkph4FCdTf5yeKwZtllfptlszrPnK/01Rw5dJXK6FCbPj36nOrVoi+PKw1bC+1vt2t3lu0tt+7dNXHz/s3FtzXjUWKIuEGc7/Djz6nESMBAxhMdM1zYOFPjOo0Z3XMhhzZeCgwE1ZvoSKEBAwcXY2xs3zCjSQ4PF/KrWIXjBXOD0ZEXoAyJTQEDddYtsYIKOvTAAgdCtJBCfTO0oAINPczQYA31/tmwwgo59LACDTrUkIIK29GQAog5tJfDCd+pwIIQNbDAAnxDeCDBfidMgGMp/YWwgAIwBMRDCduYEBwSL1AnAgw7JKdAeknM4EGDQsDHwgYcdFADBxdsoMF9M6KQgg0cbNBBBzRIsEILHXiQQQcucLmBBzlkcIENGJzAwZ8zplABBxmEl4MEFjRoQwrhibLAAw0oYEAAABQwAgmYZqpppiWIUMA2Bly66aiYjjAAAAEcoEADDyjwxAcFKCBCEitASIQOGcCHAgocnKBDBTbAWYMHi17QXQcsUKADCxfMYIMLLbCggwoX9JCCBz1gMMEKGWZg7ZgY4GgDBNWiIsCp/gCkW+kDDrTr7rvvurpNAAvAa++76Ko7QGFPHBCAvEewoMF2QpxZQcEecMBtBTnYsEEL2HYgwQUYVODBwTmo0AEHKbRwAgodWNADCthiAEF3NYh8bQ+5CmFDBIn2kEMLBIvy5AsjNFAAAAbAcMPPQAcddAzdyCD00TfIQODOBTgwgkwgvFpACErk8Od2LQx8AYge8LpwDjp0sAG3KGSwQp0rYLzCDDNcQIEKNVZLMssTnJADC96m0AHLP0rMrQoV1HcKDjLk/AJnJjRQwg1RRjGCAVQv8WUFFWhQXwsVD8zBjBaEyGyINnhgwQUn1FCtDihUcIEHHVRgwQYXuLCCsLEaoLCB6jOqgK0GP95H+QUpYJlK45wR77gBszqhA9hDLC98D8I/zzz0Q0zvPJYhYv889UU439wuIkD+/fg9HBg5+c3dUCT67Lfv/vvwxy///PTXb//9+Oev//789+///wAMoAAHSMACGvCACEygAhfIwAY68IEQjKAEJ0jBClrwghjMoAY3yMEOevCDIAyhCEdIwhKa8IQoTKEKV8jCFrrwhTCMoQxnSMMa2vCG3QgCACH5BAUyAD4AIf5URmlsZSBzb3VyY2U6IGh0dHA6Ly9jb21tb25zLndpa2ltZWRpYS5vcmcvd2lraS9GaWxlOlRlbGVwaG9ueV9tdWx0aXBsZXhlcl9zeXN0ZW0uZ2lmACwAAAAAkAF3AIUBAQEMDAwSEhIbGxsjIyMrKyszMzM7OztDQ0NLS0tSUlJbW1tjY2NtbW1zc3N7e3sB7QES7xIb8Bsk8SQt8S018jU88jxD80NM80xT9FNb9Ftj9WNs9Wx09nR89nyCgoKNjY2dnZ2goKCtra20tLS8vLyE94SF+IWL94uN+I2T+JOb+Zuj+aOs+qyz+rO8+7zCwsLLy8vQ0NDb29vE+8TM+8zT/NPc/dzj4+Ps7Ozl/eXr/uvy8vL///8AAAAAAAAG/kCfcEgsGo/IpHLJbDqf0Kh0Sq1ar9isdsvter/gsHhMLpvP6LR6zW673/C4fE6v2+/4vH7P7/v/gIGCg4SFhoeIiYqLjI2Oj5CRkpOUlZaXmJmam5ydnp+goaKjpKWmp6ipqqusra6vsLGys7S1tre4ubq7vL2+v8DBwsPExcbHyMnKy8zNzs/Q0dLT1NXW19jZ2tvc3d7f4OHi4+Tl5ufo6err7O3u7/Dx8vP09fb3+Pn6+/z9/v8AAwocSLCgwYMIEypcyLChw4cQI0qcSLGixYsYM2rcyJFIj48d4X0E6WRkjzMnS44MGcpkE5Mkw4CMqQRmylQr9eWM4nLJ/kqSP4P6mBkU5lCbNoX0VEr0JqmkOo1CWXpk50mkRrFq3VoUaFFSIHhw3TqjG46xWnk8eDKi7YgkNI9eRTt37FG5d6XuNNUgB12kMLgRiPHXJo4FUBwohhszp8ukSOVGbpp3LlPKo0YUtjlCwDYCJDbDDPFkBg4cNbtCzroaa+XHli/jPSV1CYkDa7U5OBCYSe0ne5G0ho13smjLjaHibHL7QY5tOBwg6O2TSvDUN/dm95gye3fHQ5kWcSo7V/Pn3HA0mA7mekASCJx/U8++i3uA8OWDU5+Aupa4AsHnAHrh0OcfSz7kR6A4BiIoxHnnNMgRDjwkiFuF6OSwW2A5/qCGUQMkkGDABwtGuOEIuVlEQgEFEEBiOxoSwOKBEjUAAAAElPAOCQPc+IGKBdwoAAIxtFPCAQLcaACNDuWwAAABHABCWe7M8MEBAQDQAIZSlJgPCAEYAIKH8VhZQAAiTBHDA0XuwwACCzAJTwkKIMCAFDgwoECbTeiwwgkvnOGCDk3soIIKKbjgCgJU3iODAVTMwEACfCpxQwoedMBBC2PQQIMPHdTQBA0QUMDBBSs46ImklC7hJ6c+vMDBDoZuwIIPLKjQgaIs3BArpzVkasMOu97gAgccfOrCBh3YcMMFFtjQAQ0tbGACoS+Y4MGtQ9QAwQY+aECBDap2kieR/kq84AER5K7QwQoe0LABBidgoIMJLOxwAgs1ZODBChvQIIELx7KgKQsbwDsrBxrsgIGmK5iQqgoV1CuqEN5qACoEn5bLyQMGGJCiEQgXscMFoqpgAgcq+FDBDbLacG295G5bgQ8tXODCDTfQ8IIOKlzgAwrrYjCwDzVg4IMKHPiQQaAYf7sx1B5vcsAAdyLxggbkCuGBDTcv7QEHt1agww0btLBuBxFQUMEEHdy8g9oavMuBCR0ITbTTEJBrgwVLd+A01d6CuwHHVWuCA8hvJUGsBjT4ucENGphQg91lE+pBBpyuoIELl7tw8w0rvJD0BCvY0ALgKAiOQQXJeh74nODdQvB0BRf4mvglPHxgAAlM6HCCBbD7SoMGsN+rqAbYbrCDDzqkcMEFKlAuxAoWXJBC0BYw/EILGdhAdgcWZPApCyn4kOwQNrhdAeS7X5KD78DHL878B9RvfzgxLKD//uDIQaMASMACGvCACEygAhfIwAY68IEQjKAEJ0jBClrwghjMoAY3yMEOevCDIAyhCEdIwhKa8IQohEMQAAAh+QQFMgBEACH+VEZpbGUgc291cmNlOiBodHRwOi8vY29tbW9ucy53aWtpbWVkaWEub3JnL3dpa2kvRmlsZTpUZWxlcGhvbnlfbXVsdGlwbGV4ZXJfc3lzdGVtLmdpZgAsAAAAAJABdwCGAgICDQ0NFRUVGhoaIyMjLS0tMzMzPDw8Q0NDSkpKVlZWXV1dZGRkampqfX19mxTwnhnwoiXwpi3xrT7yr0LzsEXzs0zztlPzuFf0ulv0vWT1v2j1wWz1xHP2x3r2yH72hYWFiYmJkZGRm5uboaGhtLS0uLi4y4T3zoz3z4340I/30ZL30ZT41Zv416H52aX526v53rL64Lb647z7w8PDysrK09PT3Nzc5sP76Mb76cv87NL879n98N394+Pj7Ozs8+T99un+8/Pz////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB/6ARIKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+/wADChxIsKDBgwgTKlzIsKHDhxAjSpxIsaLFixgzatzIsaPHjyBDihxJsqTJkyhTqlzJsqXLlzBjypxJs6bNmzhz6tzJs6fPn0CDCh1KtKjRo0iTKl3KtKnTp1CjSp1KtarVq1izat3KtavXr2DDih1LtqzZs/1+KNjIQAhaRP5DhvhQwODiggU/4r4tFHcIEQchLoIA0dfvXiKF/4oQHDjxW8cgFlscLMixWcsOJFcEEbhy38ufB0VmTMhyWNOKSZcODRZ16smdV+vlqtf1682xZfudfbUw70KZVRvybdgq8UTBYSc6bty2aM0UOSvy3Zw6ouS4lzOXSrz4odHKtVuX5F3neOTQJ0pfdP4R65wgbPxGdMNHZB83JtYPEQI/o7g1OEDee+wRKMp8cDlnTgNuMRLCAgcgwMAIE4nAwAEHMJAeIj8sQImCuiHYSW3lJQiiPCYEAAAABNQwEQ0DrDgADaScGFp3iH1GYo7d6dgjdab5WKI9B6zoIUUJrP6YgCkg/rbbj1BGKSWPvAnJDwgBCEAhRSEEEMCGoYggJpie8UXimTgKmeaTT+bopmds8kNDAATYUFENAgjg4ikO9CneIDeqiaagQMa5Y5Vn8vODAAZcRAABpwghaYMmTpnomj26edyOcJ4ojwFLWhQhkwYOV2ihPFIZqJSoIuqpPAUccJEBjdZY6mEZvYrrRLfuipGIvgYr7LDEFmvsscgmq+yyzDaL0g8+OCtRDQyUIC1EPzhwgLWO7HACBy+c0kIPjQDRQQcccBDDtcBkawC3i/CwAgwxnODCKDLAQMQKPDSiwwMXyCADuez+8gMI7y4ChAs5CMLDCUQEccIFLP4QwcIJGoTbQr8x3DsDBxvkAIQGMPAAQwYZyEAEDBdwoAMPFlSwQwc4uJBBB0AQIcO5KxCyAwQdFDyMDw4knMgMEBeywgo6rDCDB+pmsPALQbAwQw4Z68BBDhPosLMOMJzwggc6uMABESl8QIQGHZwAds8uXBCDBjoMogMEZws9jAED1IUIDB4UEgQGQRDRwgof6GsBEDp4sEMKaGegQw8ouGABEThsUDIQO+TQAwsYGI7C2hI0zEMGRLgAsQY4DPKzBBVU0LrevhRtgICIaD07ER70YEHhLajwwbq/B9HBCz2fIIEFF1CAwuWYs3DuxS2kEHr1a0dQ9w4XGL56w6uC/Bw07b/40AACNCrSguYzrIBCEB8k7kEMHuhbQeEsZNCwDPXjgEIOlwNCC2CAAw1QwGkw+F0LgqaBm8EABRBrwep2t4MHZGAGM9gB+XbhAwYgYE+LgEG6KkYEHqSAAy1YWd0gR4Qd9EwQMThXDILAwp11IAY2ZEEKdJCDEwgwB2Y7AblwsK6NDQII6RrhBnPRwQSAcIkCaWL6oDiQAD2RigL5ARa3yEVrBAIAOw==" alt="img"></p></li></ul></li></ul><h4 id="redis-单线程如何处理那么多并发客户端连接，为什么单线程，为什么块"><a href="#redis-单线程如何处理那么多并发客户端连接，为什么单线程，为什么块" class="headerlink" title="redis 单线程如何处理那么多并发客户端连接，为什么单线程，为什么块"></a>redis 单线程如何处理那么多并发客户端连接，为什么单线程，为什么块</h4><p>Redis的IO多路复用</p><p>Redis利用epoll函数来实现IO多路复用，将连接信息和事件放到队列中，一次放到文件事件分派器，事件分派器将事件分发给事件处理器。</p><p><img src="/hexo-docs/images/redisImages/image-20250721165723132.png" alt="image-20250721165723132"></p><p>Redis 是跑在单线程中的，所有的操作都是按照顺序线性执行的，但是由于读写操作等待用户输入或输出都是阻塞的，所以 I&#x2F;O 操作在一般情况下往往不能直接返回，这会导致某一文件的 I&#x2F;O 阻塞导致整个进程无法对其它客户提供服务，而 I&#x2F;O 多路复用就是为了解决这个问题而出现</p><p>所谓 I&#x2F;O 多路复用机制，就是说通过一种机制，可以监视多个描述符，一旦某个描述符就绪（一般是读就绪或写就绪），能够通知程序进行相应的读写操作。这种机制的使用需要 select 、 poll 、 epoll 来配合。多个连接共用一个阻塞对象，应用程序只需要在一个阻塞对象上等待，无需阻塞等待所有连接。当某条连接有新的数据可以处理时，操作系统通知应用程序，线程从阻塞状态返回，开始进行业务处理。</p><p>Redis 服务采用 Reactor 的方式来实现文件事件处理器（每一个网络连接其实都对应一个文件描述符） </p><p>Redis基于Reactor模式开发了网络事件处理器，这个处理器被称为文件事件处理器。它的组成结构为4部分：</p><p>多个套接字、</p><p>IO多路复用程序、</p><p>文件事件分派器、</p><p>事件处理器。</p><p>因为文件事件分派器队列的消费是单线程的，所以Redis才叫单线程模型</p><h4 id="参考《Redis-设计与实现》"><a href="#参考《Redis-设计与实现》" class="headerlink" title="参考《Redis 设计与实现》"></a>参考《<code>Redis</code> 设计与实现》</h4><p><img src="/hexo-docs/images/redisImages/image-20250721165833527.png" alt="image-20250721165833527"></p><h5 id="结论-1"><a href="#结论-1" class="headerlink" title="结论"></a>结论</h5><p>从Redis6开始，将网络数据读写、请求协议解析通过多个IO线程的来处理 ，对于真正的命令执行来说，仍然使用单线程操作，一举两得，便宜占尽！！！ o(￣▽￣)ｄ</p><p><img src="/hexo-docs/images/redisImages/image-20250721165857096.png" alt="image-20250721165857096"></p><h4 id="从吃米线开始，读读read…"><a href="#从吃米线开始，读读read…" class="headerlink" title="从吃米线开始，读读read…"></a>从吃米线开始，读读read…</h4><h5 id="从吃米线开始，读读read…-1"><a href="#从吃米线开始，读读read…-1" class="headerlink" title="从吃米线开始，读读read…"></a>从吃米线开始，读读read…</h5><p>上午开会，错过了公司食堂的饭点， 中午就和公司的首席架构师一起去楼下的米线店去吃米线。我们到了一看，果然很多人在排队。</p><p>架构师马上发话了：嚯，请求排队啊！你看这位收银点菜的，像不像nginx的反向代理？只收请求，不处理，把请求都发给后厨去处理。</p><p>我们交了钱，拿着号离开了点餐收银台，找了个座位坐下等餐。</p><p>架构师：你看，这就是异步处理，我们下了单就可以离开等待，米线做好了会通过小喇叭“回调”我们去取餐；</p><p>如果同步处理，我们就得在收银台站着等餐，后面的请求无法处理，客户等不及肯定会离开了。</p><p>接下里架构师盯着手中的纸质号牌。</p><p>架构师：你看，这个纸质号牌在后厨“服务器”那里也有，这不就是表示会话的ID吗？</p><p>有了它就可以把大家给区分开，就不会把我的排骨米线送给别人了。过了一会， 排队的人越来越多，已经有人表示不满了，可是收银员已经满头大汗，忙到极致了。</p><p>架构师：你看他这个系统缺乏弹性扩容， 现在这么多人，应该增加收银台，可以没有其他收银设备，老板再着急也没用。</p><p>老板看到在收银这里帮不了忙，后厨的订单也累积得越来越多， 赶紧跑到后厨亲自去做米线去了。</p><p>架构师又发话了：幸亏这个系统的后台有并行处理能力，可以随意地增加资源来处理请求（做米线）。</p><p>我说：他就这点儿资源了，除了老板没人再会做米线了。</p><p>不知不觉，我们等了20分钟， 但是米线还没上来。</p><p>架构师：你看，系统的处理能力达到极限，超时了吧。</p><p>这时候收银台前排队的人已经不多了，但是还有很多人在等米线。</p><p>老板跑过来让这个打扫卫生的去收银，让收银小妹也到后厨帮忙。打扫卫生的做收银也磕磕绊绊的，没有原来的小妹灵活。</p><p>架构师：这就叫服务降级，为了保证米线的服务，把别的服务都给关闭了。</p><p>又过了20分钟，后厨的厨师叫道：237号， 您点的排骨米线没有排骨了，能换成番茄的吗？</p><p>架构师低声对我说：瞧瞧， 人太多， 系统异常了。然后他站了起来：不行，系统得进行补偿操作：退费。</p><p>说完，他拉着我，饿着肚子，头也不回地走了。</p><h5 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h5><p>调用者要一直等待调用结果的通知后才能进行后续的执行，现在就要，我可以等，等出结果为止</p><h5 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h5><ul><li>指被调用方先返回应答让调用者先回去，然后再计算调用结果，计算完最终结果后再通知并返回给调用方</li><li>异步调用要想获得结果一般通过回调</li></ul><h5 id="同步与异步的理解"><a href="#同步与异步的理解" class="headerlink" title="同步与异步的理解"></a>同步与异步的理解</h5><p>同步、异步的讨论对象是被调用者（服务提供者），重点在于获得调用结果的消息通知方式上</p><h5 id="阻塞"><a href="#阻塞" class="headerlink" title="阻塞"></a>阻塞</h5><p>调用方一直在等待而且别的事情什么都不做，当前进&#x2F;线程会被挂起，啥都不干</p><h5 id="非阻塞"><a href="#非阻塞" class="headerlink" title="非阻塞"></a>非阻塞</h5><p>调用在发出去后，调用方先去忙别的事情，不会阻塞当前进&#x2F;线程，而会立即返回</p><h5 id="阻塞与非阻塞的理解"><a href="#阻塞与非阻塞的理解" class="headerlink" title="阻塞与非阻塞的理解"></a>阻塞与非阻塞的理解</h5><p>阻塞、非阻塞的讨论对象是调用者（服务请求者），重点在于等消息时候的行为，调用者是否能干其他事</p><h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>4种组合方式</p><ul><li>同步阻塞：<ul><li>服务员说快到你了，先别离开我后台看一眼马上通知你。客户在海底捞火锅前台干等着，啥都不干</li></ul></li><li>同步非阻塞：<ul><li>服务员说快到你了，先别离开。客户在海底捞火锅前台边刷抖音边等着叫号</li></ul></li><li>异步阻塞：<ul><li>服务员说还要再等等，你先去逛逛，一会儿通知你。客户怕过号在海底捞火锅前台拿着排号小票啥都不干，一直等着店员通知</li></ul></li><li>异步非阻塞<ul><li>服务员说还要再等等，你先去逛逛，一会儿通知你。拿着排号小票+刷着抖音，等着店员通知</li></ul></li></ul><h4 id="Unix-网络编程中的五种-IO-模型"><a href="#Unix-网络编程中的五种-IO-模型" class="headerlink" title="Unix 网络编程中的五种 IO 模型"></a>Unix 网络编程中的五种 IO 模型</h4><ol><li>Blocking IO ：阻塞 IO</li><li>NoneBlocking：非阻塞 IO</li><li>IO multiplexing：IO 多路复用</li><li>signal driven IO：信号驱动 IO</li><li>asynchronous IO：异步 IO</li></ol><h3 id="java验证"><a href="#java验证" class="headerlink" title="java验证"></a>java验证</h3><h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>一个redisServer+2个Client</p><h4 id="BIO"><a href="#BIO" class="headerlink" title="BIO"></a>BIO</h4><p>当用户进程调用了recvfrom这个系统调用，kernel就开始了IO的第一个阶段：准备数据（对于网络IO来说，很多时候数据在一开始还没有到达。比如，还没有收到一个完整的UDP包。这个时候kernel就要等待足够的数据到来）。这个过程需要等待，也就是说数据被拷贝到操作系统内核的缓冲区中是需要一个过程的。而在用户进程这边，整个进程会被阻塞（当然，是进程自己选择的阻塞）。当kernel一直等到数据准备好了，它就会将数据从kernel中拷贝到用户内存，然后kernel返回结果，用户进程才解除block的状态，重新运行起来。所以，<strong>BIO的特点就是在IO执行的两个阶段都被block了。</strong></p><p><img src="/hexo-docs/images/redisImages/image-20250722171743375.png" alt="image-20250722171743375"></p><p><img src="/hexo-docs/images/redisImages/image-20250722171804256.png" alt="image-20250722171804256"></p><h5 id="先演示-accept"><a href="#先演示-accept" class="headerlink" title="先演示 accept"></a>先演示 accept</h5><ul><li><p>accept监听</p></li><li><p>代码案例</p><p><code>RedisServer</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.iomultiplex.bio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">6380</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;==== 111 等待连接 ====&quot;</span>);</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">accept</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">            System.out.println(<span class="string">&quot;==== 222 成功连接 ====&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RedisClient01</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.iomultiplex.bio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClient01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=== RedisClient01 connection success ====&quot;</span>);</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6380</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RedisClient02</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.iomultiplex.bio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClient02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=== RedisClient02 connection success ====&quot;</span>);</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6380</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先启动我们的<code>RedisServer</code>，在依次启动<code>RedisClient01</code>和<code>RedisClient02</code>测试</p></li></ul><p><code>RedisServer</code></p><p>  <img src="/hexo-docs/images/redisImages/image-20250722173327027.png" alt="image-20250722173327027"></p><p><code>RedisClient01</code></p><p><img src="/hexo-docs/images/redisImages/image-20250722173346354.png" alt="image-20250722173346354"></p><p><code>RedisClient02</code></p><p><img src="/hexo-docs/images/redisImages/image-20250722173409433.png" alt="image-20250722173409433"></p><p>再看看我们的<code>RedisServer</code></p><p><img src="/hexo-docs/images/redisImages/image-20250722173429815.png" alt="image-20250722173429815"></p><p>我们启动了<code>RedisClient01</code>和<code>RedisClient02</code>，应该显示，两个连接成功，为什么只显示一个连接成功？接着看我们的read</p><h5 id="在演示-read"><a href="#在演示-read" class="headerlink" title="在演示 read"></a>在演示 read</h5><ul><li><p>read 读取</p></li><li><p>代码案例</p><ul><li><p>1</p><p>先启动 <code>RedisServerBIO</code>，在启动<code>RedisClient01</code>验证后再启动2号客户端</p><p><code>RedisServerBIO</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.iomultiplex.bio.read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisServerBIO</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">6380</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;=== 111 等待连接 ===&quot;</span>);</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> serverSocket.accept();<span class="comment">//阻塞 1 ，等待客户端连接</span></span><br><span class="line">            System.out.println(<span class="string">&quot;=== 222 成功连接 ====&quot;</span>);</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> socket.getInputStream();<span class="comment">//获得输入流</span></span><br><span class="line">            <span class="type">int</span> length;</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            System.out.println(<span class="string">&quot;=== 333 等待读取&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> ((length = inputStream.read(bytes)) != -<span class="number">1</span>) &#123;<span class="comment">//阻塞 2 ，等待客户端发送数据</span></span><br><span class="line">                System.out.println(<span class="string">&quot;=== 444 成功读取：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(bytes, <span class="number">0</span>, length));</span><br><span class="line">                System.out.println(<span class="string">&quot;=======&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            inputStream.close();</span><br><span class="line">            socket.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RedisClient01</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.iomultiplex.bio.read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClient01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">6380</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;RedisClient01 Connected to RedisServerBIO&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            <span class="keyword">if</span> (string.equalsIgnoreCase(<span class="string">&quot;quit&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            socket.getOutputStream().write(string.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;输入quit退出&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RedisClient02</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.iomultiplex.bio.read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClient02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">6380</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;RedisClient02 Connected to RedisServerBIO&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            <span class="keyword">if</span> (string.equalsIgnoreCase(<span class="string">&quot;quit&quot;</span>))&#123; </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            socket.getOutputStream().write(string.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;输入quit退出&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先启动<code>RedisServerBIO</code>，再启动<code>RedisClient01</code>和<code>RedisClient02</code>，测试</p><p><code>RedisServerBIO</code></p><p><img src="/hexo-docs/images/redisImages/image-20250722175025041.png" alt="image-20250722175025041"></p><p><code>RedisClient01</code></p><p><img src="/hexo-docs/images/redisImages/image-20250722175228055.png" alt="image-20250722175228055"></p><p>输入内容</p><p><img src="/hexo-docs/images/redisImages/image-20250722175250860.png" alt="image-20250722175250860"></p><p><code>RedisServerBIO</code></p><p><img src="/hexo-docs/images/redisImages/image-20250722175310389.png" alt="image-20250722175310389"></p><p>再启动<code>RedisClient02</code>，并输入内容</p><p><img src="/hexo-docs/images/redisImages/image-20250722175347302.png" alt="image-20250722175347302"></p><p><code>RedisServerBIO</code></p><p><img src="/hexo-docs/images/redisImages/image-20250722175418138.png" alt="image-20250722175418138"></p></li><li><p>存在的问题</p><p>上面的模型存在很大的问题，如果客户端与服务端建立了连接，</p><p>如果这个连接的客户端迟迟不发数据，程就会一直堵塞在read()方法上，这样其他客户端也不能进行连接，</p><p>也就是一次只能处理一个客户端，对客户很不友好</p><p>知道问题所在了，请问如何解决？？</p></li><li><p>2</p><p>多线程模式</p><p>​利用多线程</p><p>​只要连接了一个socket，操作系统分配一个线程来处理，这样read()方法堵塞在每个具体线程上而不堵塞主线程，</p><p>​就能操作多个socket了，哪个线程中的socket有数据，就读哪个socket，各取所需，灵活统一。</p><p>​程序服务端只负责监听是否有客户端连接，使用 accept() 阻塞</p><p>​客户端1连接服务端，就开辟一个线程（thread1）来执行 read() 方法，程序服务端继续监听</p><p>​客户端2连接服务端，也开辟一个线程（thread2）来执行 read() 方法，程序服务端继续监听</p><p>​客户端3连接服务端，也开辟一个线程（thread3）来执行 read() 方法，程序服务端继续监听</p><p>​。。。。。。</p><p>​任何一个线程上的socket有数据发送过来，read()就能立马读到，cpu就能进行处理。</p><p><code>RedisServerBIOMultiThread</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.iomultiplex.bio.mythread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisServerBIOMultiThread</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">6380</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;=== 等待连接 ===&quot;</span>);</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> serverSocket.accept();<span class="comment">//阻塞，等待客户端连接</span></span><br><span class="line">            System.out.println(<span class="string">&quot;=== 成功连接 ===&quot;</span>);</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">                    <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                    System.out.println(<span class="string">&quot;=== 等待读取 ===&quot;</span>);</span><br><span class="line">                    <span class="keyword">while</span> ((length = inputStream.read(bytes)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;=== 成功读取 ===&quot;</span>);</span><br><span class="line">                        System.out.println(<span class="string">&quot;内容为：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="number">0</span>,length));</span><br><span class="line">                    &#125;</span><br><span class="line">                    inputStream.close();</span><br><span class="line">                    socket.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,Thread.currentThread().getName()).start();</span><br><span class="line">            System.out.println(Thread.currentThread().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RedisClient01</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.iomultiplex.bio.mythread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClient01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;RedisClient01 连接 RedisServerBIOMultiThread 成功&quot;</span>);</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6380</span>);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            <span class="keyword">if</span> (string.equalsIgnoreCase(<span class="string">&quot;quit&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            outputStream.write(string.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;输入quit退出！&quot;</span>);</span><br><span class="line">            outputStream.close();</span><br><span class="line">            socket.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RedisClient02</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.iomultiplex.bio.mythread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClient02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;RedisClient02 连接 RedisServerBIOMultiThread 成功&quot;</span>);</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6380</span>);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            <span class="keyword">if</span> (string.equalsIgnoreCase(<span class="string">&quot;quit&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            outputStream.write(string.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;输入quit退出！&quot;</span>);</span><br><span class="line">            outputStream.close();</span><br><span class="line">            socket.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RedisServerBIOMultiThread</code></p><p><img src="/hexo-docs/images/redisImages/image-20250722181457966.png" alt="image-20250722181457966"></p><p><code>RedisClient01</code></p><p><img src="/hexo-docs/images/redisImages/image-20250722181536938.png" alt="image-20250722181536938"></p><p><code>RedisServerBIOMultiThread</code></p><p><img src="/hexo-docs/images/redisImages/image-20250722181701254.png" alt="image-20250722181701254"></p><p><code>RedisClient02</code></p><p><img src="/hexo-docs/images/redisImages/image-20250722181626426.png" alt="image-20250722181626426"></p><p><code>RedisServerBIOMultiThread</code></p><p><img src="/hexo-docs/images/redisImages/image-20250722181732453.png" alt="image-20250722181732453"></p></li><li><p>存在的问题</p><p>多线程模型</p><p>每来一个客户端，就要开辟一个线程，如果来1万个客户端，那就要开辟1万个线程。</p><p>在操作系统中用户态不能直接开辟线程，需要调用内核来创建的一个线程，</p><p>这其中还涉及到用户状态的切换（上下文的切换），十分耗资源。</p><p>知道问题所在了，请问如何解决？？</p><ul><li><p>解决</p><p>第一个办法：使用线程池</p><p>这个在客户端连接少的情况下可以使用，但是用户量大的情况下，你不知道线程池要多大，太大了内存可能不够，也不可行。</p><p>第二个办法：NIO（非阻塞式IO）方式</p><p>因为read()方法堵塞了，所有要开辟多个线程，如果什么方法能使read()方法不堵塞，这样就不用开辟多个线程了，这就用到了另一个IO模型，NIO（非阻塞式IO）</p></li></ul></li></ul></li></ul><h5 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h5><p>tomcat7之前就是用 BIO 多线程来解决多连接</p><h5 id="目前我们的两个痛点"><a href="#目前我们的两个痛点" class="headerlink" title="目前我们的两个痛点"></a>目前我们的两个痛点</h5><p>两个痛点</p><ul><li>accept</li><li>read</li><li>在阻塞式 I&#x2F;O 模型中，应用程序在调用 <code>recvfrom</code> 开始到它返回有数据报准备好这段时间是阻塞的，<code>recvfrom</code> 返回成功后，应用程序才能开始处理数据报</li></ul><p>阻塞式 IO 小总结</p><p><img src="/hexo-docs/images/redisImages/image-20250722182156454.png" alt="image-20250722182156454"></p><p>思考</p><p>每个线程分配一个连接，必然会产生多个，既然是多个 <code>socket</code> 连接必然需要放入进容器，纳入统一管理</p><h4 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h4><p>当用户进程发出read操作时，如果kernel中的数据还没有准备好，那么它并不会block用户进程，而是立刻返回一个error。从用户进程角度讲 ，它发起一个read操作后，并不需要等待，而是马上就得到了一个结果。用户进程判断结果是一个error时，它就知道数据还没有准备好，于是它可以再次发送read操作。一旦kernel中的数据准备好了，并且又再次收到了用户进程的system call，那么它马上就将数据拷贝到了用户内存，然后返回。<strong>所以，NIO特点是用户进程需要不断的主动询问内核数据准备好了吗？一句话，用轮询替代阻塞！</strong></p><p><img src="/hexo-docs/images/redisImages/image-20250723165325836.png" alt="image-20250723165325836"></p><p>在NIO模式中，一切都是非阻塞的：</p><p>accept()方法是非阻塞的，如果没有客户端连接，就返回无连接标识</p><p>read()方法是非阻塞的，如果read()方法读取不到数据就返回空闲中标识，如果读取到数据时只阻塞read()方法读数据的时间</p><p>在NIO模式中，只有一个线程：</p><p>当一个客户端与服务端进行连接，这个socket就会加入到一个数组中，隔一段时间遍历一次，</p><p>看这个socket的read()方法能否读到数据，这样一个线程就能处理多个客户端的连接和读取了</p><h5 id="代码案例"><a href="#代码案例" class="headerlink" title="代码案例"></a>代码案例</h5><p>上述以前的socket是阻塞的，另外发开了一套 <code>API</code> ServerSocketChannel</p><p><img src="/hexo-docs/images/redisImages/image-20250723165450855.png" alt="image-20250723165450855"></p><p><code>RedisServerNIO</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.iomultiplex.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.ServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisServerNIO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> ArrayList&lt;SocketChannel&gt; socketList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=== Redis Server NIO 启动等待中...===&quot;</span>);</span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverSocket</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        serverSocket.socket().bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6380</span>));</span><br><span class="line">        serverSocket.configureBlocking(<span class="literal">false</span>);<span class="comment">//设置为非阻塞模式</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (SocketChannel element : socketList) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> element.read(buffer);</span><br><span class="line">                <span class="keyword">if</span> (read &gt; <span class="number">0</span>) &#123;<span class="comment">//当有数据的时候</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;=== 读取数据：&quot;</span>+read);</span><br><span class="line">                    buffer.flip();</span><br><span class="line">                    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[read];</span><br><span class="line">                    buffer.get(bytes);</span><br><span class="line">                    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(bytes));</span><br><span class="line">                    buffer.clear();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">SocketChannel</span> <span class="variable">socketChannel</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">            <span class="keyword">if</span> (socketChannel != <span class="literal">null</span>) &#123; <span class="comment">//如果不等于空，成功连接</span></span><br><span class="line">                System.out.println(<span class="string">&quot;=== 成功连接：&quot;</span>);</span><br><span class="line">                socketChannel.configureBlocking(<span class="literal">false</span>);<span class="comment">//设置为非阻塞模式</span></span><br><span class="line">                socketList.add(socketChannel);</span><br><span class="line">                System.out.println(<span class="string">&quot;socketList 容量为：&quot;</span>+socketList.size());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RedisClient01</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.iomultiplex.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClient01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;RedisClient01 开始&quot;</span>);</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6380</span>);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            System.out.println(<span class="string">&quot;请输入数据：&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            <span class="keyword">if</span> (string.equalsIgnoreCase(<span class="string">&quot;quit&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            outputStream.write(string.getBytes());<span class="comment">//写入数据</span></span><br><span class="line">            System.out.println(<span class="string">&quot;输入quit退出！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        outputStream.close();</span><br><span class="line">        socket.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RedisClient02</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.iomultiplex.nio;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisClient02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;RedisClient01 开始&quot;</span>);</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6380</span>);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            System.out.println(<span class="string">&quot;请输入数据：&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            <span class="keyword">if</span> (string.equalsIgnoreCase(<span class="string">&quot;quit&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            outputStream.write(string.getBytes());<span class="comment">//写入数据</span></span><br><span class="line">            System.out.println(<span class="string">&quot;输入quit退出！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        outputStream.close();</span><br><span class="line">        socket.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果</p><p><code>RedisServerNIO</code></p><p><img src="/hexo-docs/images/redisImages/image-20250723170650738.png" alt="image-20250723170650738"></p><p><code>RedisClient01</code></p><p><img src="/hexo-docs/images/redisImages/image-20250723170726565.png" alt="image-20250723170726565"></p><p><code>RedisClient02</code></p><p><img src="/hexo-docs/images/redisImages/image-20250723170743851.png" alt="image-20250723170743851"></p><p><code>RedisServerNIO</code></p><p><img src="/hexo-docs/images/redisImages/image-20250723170805419.png" alt="image-20250723170805419"></p><h5 id="存在的问题和优缺点"><a href="#存在的问题和优缺点" class="headerlink" title="存在的问题和优缺点"></a>存在的问题和优缺点</h5><p>NIO成功的解决了BIO需要开启多线程的问题，NIO中一个线程就能解决多个socket，但是还存在2个问题。</p><p><strong>问题一：</strong></p><p>这个模型在客户端少的时候十分好用，但是客户端如果很多，</p><p>比如有1万个客户端进行连接，那么每次循环就要遍历1万个socket，如果一万个socket中只有10个socket有数据，也会遍历一万个socket，就会做很多无用功，每次遍历遇到 read 返回 -1 时仍然是一次浪费资源的系统调用。</p><p><strong>问题二：</strong></p><p>而且这个遍历过程是在用户态进行的，用户态判断socket是否有数据还是调用内核的read()方法实现的，这就涉及到用户态和内核态的切换，每遍历一个就要切换一次，开销很大因为这些问题的存在。</p><p>优点：不会阻塞在内核的等待数据过程，每次发起的 I&#x2F;O 请求可以立即返回，不用阻塞等待，实时性较好。</p><p>缺点：轮询将会不断地询问内核，这将占用大量的 CPU 时间，系统资源利用率较低，所以一般 Web 服务器不使用这种 I&#x2F;O 模型。</p><p>结论：让Linux内核搞定上述需求，我们将一批文件描述符通过一次系统调用传给内核由内核层去遍历，才能真正解决这个问题。IO多路复用应运而生，也即将上述工作直接放进Linux内核，不再两态转换而是直接从内核获得结果，<strong>因为内核是非阻塞的。</strong></p><p>非阻塞式IO小总结</p><p><img src="/hexo-docs/images/redisImages/image-20250722182156454.png" alt="image-20250722182156454"></p><p>问题升级：</p><p>如何用单线程处理大量的连接？(使用IO多路复用)</p><h4 id="IO-Multiplexing（IO-多路复用）"><a href="#IO-Multiplexing（IO-多路复用）" class="headerlink" title="IO Multiplexing（IO 多路复用）"></a>IO Multiplexing（IO 多路复用）</h4><h5 id="是什么-1"><a href="#是什么-1" class="headerlink" title="是什么"></a>是什么</h5><p><img src="/hexo-docs/images/redisImages/image-20250723183906773.png" alt="image-20250723183906773"></p><p>I&#x2F;O多路复用在英文中其实叫 I&#x2F;O multiplexing </p><p><img src="/hexo-docs/images/redisImages/image-20250723183931129.png" alt="image-20250723183931129"></p><p>多个Socket复用一根网线这个功能是在内核＋驱动层实现的</p><p>I&#x2F;O multiplexing 这里面的 multiplexing 指的其实是在单个线程通过记录跟踪每一个Sock(I&#x2F;O流)的状态来同时管理多个I&#x2F;O流. 目的是尽量多的提高服务器的吞吐能力。</p><p><img src="/hexo-docs/images/redisImages/image-20250723183946081.png" alt="image-20250723183946081"></p><p>大家都用过nginx，nginx使用epoll接收请求，ngnix会有很多链接进来， epoll会把他们都监视起来，然后像拨开关一样，谁有数据就拨向谁，然后调用相应的代码处理。redis类似同理</p><p><code>FileDescriptor</code></p><p> 文件描述符（File descriptor）是计算机科学中的一个术语，是一个用于表述指向文件的引用的抽象化概念。文件描述符在形式上是一个非负整数。实际上，它是一个索引值，指向内核为每一个进程所维护的该进程打开文件的记录表。当程序打开一个现有文件或者创建一个新文件时，内核向进程返回一个文件描述符。在程序设计中，一些涉及底层的程序编写往往会围绕着文件描述符展开。但是文件描述符这一概念往往只适用于UNIX、Linux这样的操作系统。</p><p><img src="/hexo-docs/images/redisImages/image-20250723184027965.png" alt="image-20250723184027965"></p><p>IO 多路复用</p><p>视多个描述符，一旦某个描述符就绪（一般是读就绪或者写就绪），能够通知程序进行相应的读写操作。可以基于一个阻塞对象并同时在多个描述符上等待就绪，而不是使用多个线程(每个文件描述符一个线程，每次new一个线程)，这样可以大大节省系统资源。所以，I&#x2F;O 多路复用的特点是通过一种机制一个进程能同时等待多个文件描述符而这些文件描述符（套接字描述符）其中的任意一个进入读就绪状态，select，poll，epoll等函数就可以返回。</p><p><img src="/hexo-docs/images/redisImages/image-20250723184051642.png" alt="image-20250723184051642"></p><h5 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h5><p>模拟一个tcp服务器处理30个客户socket，一个监考老师监考多个学生，谁举手就应答谁。</p><p>假设你是一个监考老师，让30个学生解答一道竞赛考题，然后负责验收学生答卷，你有下面几个选择：</p><p>第一种选择：按顺序逐个验收，先验收A，然后是B，之后是C、D。。。这中间如果有一个学生卡住，全班都会被耽误,你用循环挨个处理socket，根本不具有并发能力。 </p><p>第二种选择：你创建30个分身线程，每个分身线程检查一个学生的答案是否正确。 这种类似于为每一个用户创建一个进程或者线程处理连接。</p><p>第三种选择，你站在讲台上等，谁解答完谁举手。这时C、D举手，表示他们解答问题完毕，你下去依次检查C、D的答案，然后继续回到讲台上等。此时E、A又举手，然后去处理E和A。。。这种就是IO复用模型。Linux下的select、poll和epoll就是干这个的。</p><p>将用户socket对应的fd注册进epoll，然后epoll帮你监听哪些socket上有消息到达，这样就避免了大量的无用操作。此时的socket应该采用非阻塞模式。这样，整个过程只在调用select、poll、epoll这些调用的时候才会阻塞，收发客户消息是不会阻塞的，整个进程或者线程就被充分利用起来，这就是事件驱动，所谓的reactor反应模式。</p><h5 id="能干嘛"><a href="#能干嘛" class="headerlink" title="能干嘛"></a>能干嘛</h5><p>Redis 单线程如何处理那么多并发客户端连接，为什么单线程，为什么快</p><ul><li><p>Redis的IO多路复用</p><ul><li><p>Redis利用epoll来实现IO多路复用，将连接信息和事件放到队列中，依次放到事件分派器，事件分派器将事件分发给事件处理器。</p><p><img src="/hexo-docs/images/redisImages/image-20250723184140922.png" alt="image-20250723184140922"></p><p>Redis 服务采用 Reactor 的方式来实现文件事件处理器（每一个网络连接其实都对应一个文件描述符) </p><p>​所谓 I&#x2F;O 多路复用机制，就是说通过一种机制，可以监视多个描述符，一旦某个描述符就绪（一般是读就绪或写就绪），能够通知程序进行相应的读写操作。这种机制的使用需要 select 、 poll 、 epoll 来配合。多个连接共用一个阻塞对象，应用程序只需要在一个阻塞对象上等待，无需阻塞等待所有连接。当某条连接有新的数据可以处理时，操作系统通知应用程序，线程从阻塞状态返回，开始进行业务处理。</p><p>​所谓 I&#x2F;O 多路复用机制，就是说通过一种考试监考机制，一个老师可以监视多个考生，一旦某个考生举手想要交卷了，能够通知监考老师进行相应的收卷子或批改检查操作。所以这种机制需要调用班主任(select&#x2F;poll&#x2F;epoll)来配合。多个考生被同一个班主任监考，收完一个考试的卷子再处理其它人，无需等待所有考生，谁先举手就先响应谁，当又有考生举手要交卷，监考老师看到后从讲台走到考生位置，开始进行收卷处理。</p></li></ul></li></ul><p>Reactor 设计模式</p><p>是什么</p><ul><li><p>​基于 I&#x2F;O 复用模型：多个连接共用一个阻塞对象，应用程序只需要在一个阻塞对象上等待，无需阻塞等待所有连接。当某条连接有新的数据可以处理时，操作系统通知应用程序，线程从阻塞状态返回，开始进行业务处理。</p><p>​Reactor 模式，是指通过一个或多个输入同时传递给服务处理器的服务请求的事件驱动处理模式。服务端程序处理传入多路请求，并将它们同步分派给请求对应的处理线程，Reactor 模式也叫 Dispatcher 模式。即 I&#x2F;O 多了复用统一监听事件，收到事件后分发(Dispatch 给某进程)，是编写高性能网络服务器的必备技术。</p><p><img src="/hexo-docs/images/redisImages/image-20250723184442547.png" alt="image-20250723184442547"></p><p>Reactor 模式中有 2 个关键组成：</p><p>1）Reactor：Reactor 在一个单独的线程中运行，负责监听和分发事件，分发给适当的处理程序来对 IO 事件做出反应。 它就像公司的电话接线员，它接听来自客户的电话并将线路转移到适当的联系人；</p><p>2）Handlers：处理程序执行 I&#x2F;O 事件要完成的实际事件，类似于客户想要与之交谈的公司中的实际办理人。Reactor 通过调度适当的处理程序来响应 I&#x2F;O 事件，处理程序执行非阻塞操作。</p></li><li><p>每个网络连接其实都对应一个文件描述符</p><p><img src="/hexo-docs/images/redisImages/image-20250723184529026.png" alt="image-20250723184529026"></p><p>Redis 服务采用 Reactor 的方式来实现文件事件处理器（每一个网络连接其实都对应一个文件描述符）</p><p>Redis基于Reactor模式开发了网络事件处理器，这个处理器被称为文件事件处理器。</p><p>它的组成结构为4部分：</p><p>多个套接字、</p><p>IO多路复用程序、</p><p>文件事件分派器、</p><p>事件处理器。因为文件事件分派器队列的消费是单线程的，所以Redis才叫单线程模型</p></li></ul><h5 id="select、poll、epoll-都是-I-O-多路复用的具体的实现"><a href="#select、poll、epoll-都是-I-O-多路复用的具体的实现" class="headerlink" title="select、poll、epoll 都是 I&#x2F;O 多路复用的具体的实现"></a>select、poll、epoll 都是 I&#x2F;O 多路复用的具体的实现</h5><p>C语言 struct 结构体语法简介</p><p><img src="/hexo-docs/images/redisImages/image-20250723184740611.png" alt="image-20250723184740611"></p><p><img src="/hexo-docs/images/redisImages/image-20250723184751292.png" alt="image-20250723184751292"></p><p>select 方法</p><ul><li><p>Linux 官网或者 man</p><p><img src="/hexo-docs/images/redisImages/image-20250723184834546.png" alt="image-20250723184834546"></p><p>select 函数监视的文件描述符分3类，分别是readfds、writefds和exceptfds，将用户传入的数组拷贝到内核空间</p><p>调用后select函数会阻塞，直到有描述符就绪（有数据 可读、可写、或者有except）或超时（timeout指定等待时间，如果立即返回设为null即可），函数返回。</p><p>当select函数返回后，可以通过遍历fdset，来找到就绪的描述符。</p><p>官网：<a href="https://man7.org/linux/man-pages/man2/select.2.html">https://man7.org/linux/man-pages/man2/select.2.html</a></p><p>select 是第一个实现（1983 左右在BSD里面实现的）</p></li><li><p>用户态我们自己写的java代码思想</p><p><img src="/hexo-docs/images/redisImages/image-20250723185036920.png" alt="image-20250723185036920"></p></li><li><p>C 语言代码</p><p><img src="/hexo-docs/images/redisImages/image-20250723185055165.png" alt="image-20250723185055165"></p><p><img src="/hexo-docs/images/redisImages/image-20250723185104663.png" alt="image-20250723185104663"></p><p><img src="/hexo-docs/images/redisImages/image-20250723185113871.png" alt="image-20250723185113871"></p></li><li><p>优点</p><p>select 其实就是把NIO中用户态要遍历的fd数组(我们的每一个socket链接，安装进ArrayList里面的那个)拷贝到了内核态，让内核态来遍历，因为用户态判断socket是否有数据还是要调用内核态的，所有拷贝到内核态后，这样遍历判断的时候就不用一直用户态和内核态频繁切换了</p><p>从代码中可以看出，select系统调用后，返回了一个置位后的&amp;rset，这样用户态只需进行很简单的二进制比较，就能很快知道哪些socket需要read数据，有效提高了效率</p><p><img src="/hexo-docs/images/redisImages/image-20250723185145446.png" alt="image-20250723185145446"></p></li><li><p>缺点</p><p><img src="/hexo-docs/images/redisImages/image-20250723185221023.png" alt="image-20250723185221023"></p><ol><li>bitmap最大1024位，一个进程最多只能处理1024个客户端</li><li>&amp;rset不可重用，每次socket有数据就相应的位会被置位</li><li>文件描述符数组拷贝到了内核态(只不过无系统调用切换上下文的开销。（内核层可优化为异步事件通知）)，仍然有开销。select 调用需要传入 fd 数组，需要拷贝一份到内核，高并发场景下这样的拷贝消耗的资源是惊人的。（可优化为不复制）</li><li>select并没有通知用户态哪一个socket有数据，仍然需要O(n)的遍历。select 仅仅返回可读文件描述符的个数，具体哪个可读还是要用户自己遍历。（可优化为只返回给用户就绪的文件描述符，无需用户做无效的遍历）</li></ol><p>我们自己模拟写的是，RedisServerNIO.java,只不过将它内核化了。</p></li><li><p>select 小结论</p><p>select方式，既做到了一个线程处理多个客户端连接（文件描述符），又减少了系统调用的开销（多个文件描述符只有一次 select 的系统调用 + N次就绪状态的文件描述符的 read 系统调用</p></li></ul><h5 id="poll-方法"><a href="#poll-方法" class="headerlink" title="poll 方法"></a>poll 方法</h5><p>Linux 官网或者 man</p><p><img src="/hexo-docs/images/redisImages/image-20250723190312309.png" alt="image-20250723190312309"></p><p>1997 年实现了 poll</p><p>官网：<a href="https://man7.org/linux/man-pages/man2/poll.2.html">https://man7.org/linux/man-pages/man2/poll.2.html</a></p><p>C 语言代码</p><p><img src="/hexo-docs/images/redisImages/image-20250723190424306.png" alt="image-20250723190424306"></p><p><img src="/hexo-docs/images/redisImages/image-20250723190432890.png" alt="image-20250723190432890"></p><p><img src="/hexo-docs/images/redisImages/image-20250723190445858.png" alt="image-20250723190445858"></p><p>优点</p><ol><li>poll使用pollfd数组来代替select中的bitmap，数组没有1024的限制，可以一次管理更多的client。它和 select 的主要区别就是，去掉了 select 只能监听 1024 个文件描述符的限制。</li><li>当pollfds数组中有事件发生，相应的revents置位为1，遍历的时候又置位回零，实现了pollfd数组的重用</li></ol><p>问题</p><p>poll 解决了select缺点中的前两条，其本质原理还是select的方法，还存在select中原来的问题</p><ol><li>pollfds数组拷贝到了内核态，仍然有开销</li><li>poll并没有通知用户态哪一个socket有数据，仍然需要O(n)的遍历</li></ol><h5 id="epoll-方法"><a href="#epoll-方法" class="headerlink" title="epoll 方法"></a>epoll 方法</h5><p>Linux 官网或者 man</p><p><img src="/hexo-docs/images/redisImages/image-20250723190615538.png" alt="image-20250723190615538"></p><p><img src="/hexo-docs/images/redisImages/image-20250723190623761.png" alt="image-20250723190623761"></p><p><img src="/hexo-docs/images/redisImages/image-20250723190631959.png" alt="image-20250723190631959"></p><table><thead><tr><th>int epoll_create(int size)</th><th>参数size并不是限制了epoll所能监听的描述符最大个数，只是对内核初始分配内部数据结构的一个建议</th></tr></thead><tbody><tr><td>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)</td><td>见上图</td></tr><tr><td>int epoll_wait(int epfd, struct epoll_event * events, int maxevents, int timeout)</td><td>等待epfd上的io事件，最多返回maxevents个事件。参数events用来从内核得到事件的集合，maxevents告之内核这个events有多大。</td></tr></tbody></table><p>在2002年被大神 Davide Libenzi (戴维德·利本兹)发明出来了</p><p>三步调用</p><ul><li><p>epoll_create</p><ul><li><p>创建一个epoll句柄</p><p><img src="/hexo-docs/images/redisImages/image-20250723190825824.png" alt="image-20250723190825824"></p></li></ul></li><li><p>epoll_ctl</p><ul><li>向内核添加、修改或删除要监控的文件描述符</li></ul><p><img src="/hexo-docs/images/redisImages/image-20250723190903214.png" alt="image-20250723190903214"></p></li><li><p>epoll_wait</p><ul><li><p>类似发起了 select() 调用</p><p><img src="/hexo-docs/images/redisImages/image-20250723190948106.png" alt="image-20250723190948106"></p></li></ul></li></ul><p>C 语言代码</p><p><img src="/hexo-docs/images/redisImages/image-20250723191005378.png" alt="image-20250723191005378"></p><p><img src="/hexo-docs/images/redisImages/image-20250723191021305.png" alt="image-20250723191021305"></p><p>结论</p><p>​多路复用快的原因在于，操作系统提供了这样的系统调用，使得原来的 while 循环里多次系统调用，</p><p>变成了一次系统调用 + 内核层遍历这些文件描述符。</p><p>​epoll是现在最先进的IO多路复用器，Redis、Nginx，linux中的Java NIO都使用的是epoll。</p><p>这里“多路”指的是多个网络连接，“复用”指的是复用同一个线程。</p><ol><li>一个socket的生命周期中只有一次从用户态拷贝到内核态的过程，开销小</li><li>使用event事件通知机制，每次socket中有数据会主动通知内核，并加入到就绪链表中，不需要遍历所有的socket</li></ol><p>​在多路复用IO模型中，会有一个内核线程不断地去轮询多个 socket 的状态，只有当真正读写事件发送时，才真正调用实际的IO读写操作。因为在多路复用IO模型中，只需要使用一个线程就可以管理多个socket，系统不需要建立新的进程或者线程，也不必维护这些线程和进程，并且只有真正有读写事件进行时，才会使用IO资源，所以它大大减少来资源占用。多路I&#x2F;O复用模型是利用 select、poll、epoll 可以同时监察多个流的 I&#x2F;O 事件的能力，在空闲的时候，会把当前线程阻塞掉，当有一个或多个流有 I&#x2F;O 事件时，就从阻塞态中唤醒，于是程序就会轮询一遍所有的流（epoll 是只轮询那些真正发出了事件的流），并且只依次顺序的处理就绪的流，这种做法就避免了大量的无用操作。 采用多路 I&#x2F;O 复用技术可以让单个线程高效的处理多个连接请求（尽量减少网络 IO 的时间消耗），且 Redis 在内存中操作数据的速度非常快，也就是说内存内的操作不会成为影响Redis性能的瓶颈</p><h5 id="三个方法对比"><a href="#三个方法对比" class="headerlink" title="三个方法对比"></a>三个方法对比</h5><p><img src="/hexo-docs/images/redisImages/image-20250723191111492.png" alt="image-20250723191111492"></p><h4 id="5种-I-O-模型总结"><a href="#5种-I-O-模型总结" class="headerlink" title="5种 I&#x2F;O 模型总结"></a>5种 I&#x2F;O 模型总结</h4><p> 多路复用快的原因在于，操作系统提供了这样的系统调用，使得原来的 while 循环里多次系统调用，</p><p>变成了一次系统调用 + 内核层遍历这些文件描述符。 </p><p>所谓 I&#x2F;O 多路复用机制，就是说通过一种机制，可以监视多个描述符，一旦某个描述符就绪（一般是读就绪或写就绪），能够通知程序进行相应的读写操作。这种机制的使用需要 select 、 poll 、 epoll 来配合。多个连接共用一个阻塞对象，应用程序只需要在一个阻塞对象上等待，无需阻塞等待所有连接。当某条连接有新的数据可以处理时，操作系统通知应用程序，线程从阻塞状态返回，开始进行业务处理；</p><p><img src="/hexo-docs/images/redisImages/image-20250723191208911.png" alt="image-20250723191208911"></p><h4 id="为什么3个都保有"><a href="#为什么3个都保有" class="headerlink" title="为什么3个都保有"></a>为什么3个都保有</h4><p><img src="/hexo-docs/images/redisImages/image-20250723191232748.png" alt="image-20250723191232748"></p><h3 id="案例实战（微信抢红包）"><a href="#案例实战（微信抢红包）" class="headerlink" title="案例实战（微信抢红包）"></a>案例实战（微信抢红包）</h3><h4 id="业务描述"><a href="#业务描述" class="headerlink" title="业务描述"></a>业务描述</h4><p><img src="/hexo-docs/images/redisImages/image-20250724170119462.png" alt="image-20250724170119462"></p><h4 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h4><ol><li>各种节假日，发红包+抢红包，不说了，100%高并发业务要求，不能用mysql来做</li><li>一个总的大红包，会有可能拆分成多个小红包，总金额&#x3D; 分金额1+分金额2+分金额3……分金额N</li><li>每个人只能抢一次，你需要有记录，比如100块钱，被拆分成10个红包发出去，总计有10个红包，抢一个少一个，总数显示(10&#x2F;6)直到完，需要记录那些人抢到了红包，重复抢作弊不可以。</li><li>有可能还需要你计时，完整抢完，从发出到全部over，耗时多少？</li><li>红包过期，或者群主人品差，没人抢红包，原封不动退回。</li><li>红包过期，剩余金额可能需要回退到发红包主账户下。</li></ol><p>由于是高并发不能用mysql来做，只能用redis，那需要要redis的什么数据类型？</p><h4 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h4><p>难点：</p><ol><li>拆分算法如何</li></ol><p>  红包其实就是金额，拆分算法如何 ？给你100块，分成10个小红包(金额有可能小概率相同，有2个红包都是2.58)，</p><p>  如何拆分随机金额设定每个红包里面安装多少钱?</p><ol start="2"><li><p>次数限制</p><p>   每个人只能抢一次，次数限制</p></li><li><p>原子性</p></li></ol><p>  每抢走一个红包就减少一个(类似减库存)，那这个就需要保证库存的———————–原子性，不加锁实现</p><p>你认为存在redis什么数据类型里面？set ？hash？ list？</p><h5 id="关键点"><a href="#关键点" class="headerlink" title="关键点"></a>关键点</h5><ul><li>发红包</li><li>抢红包<ul><li>抢，不加锁且原子性，还能支持高并发</li><li>每人一次且有抢红包记录</li></ul></li><li>记红包<ul><li>记录每个人抢了多少</li></ul></li><li>拆红包<ul><li>拆红包算法<ol><li>所有人抢到金额之和等于红包金额，不能超过，也不能少于</li><li>每个人至少抢到一分钱</li><li>要保证所有人抢到金额的几率相等</li></ol></li></ul></li></ul><h5 id="结论-2"><a href="#结论-2" class="headerlink" title="结论"></a>结论</h5><p>抢红包业务通用算法</p><p><strong>二倍均值法</strong></p><p>剩余红包金额为M，剩余人数为N，那么有如下公式：</p><p>每次抢到的金额 &#x3D; 随机区间 （0， (剩余红包金额M ÷ 剩余人数N ) X 2）</p><p>这个公式，保证了每次随机金额的平均值是相等的，不会因为抢红包的先后顺序而造成不公平。</p><p>举个例子：</p><p>假设有10个人，红包总额100元。</p><p>第1次：</p><p>100÷10 X2 &#x3D; 20, 所以第一个人的随机范围是（0，20 )，平均可以抢到10元。假设第一个人随机到10元，那么剩余金额是100-10 &#x3D; 90 元。</p><p>第2次：</p><p>90÷9 X2 &#x3D; 20, 所以第二个人的随机范围同样是（0，20 )，平均可以抢到10元。假设第二个人随机到10元，那么剩余金额是90-10 &#x3D; 80 元。</p><p>第3次：</p><p>80÷8 X2 &#x3D; 20, 所以第三个人的随机范围同样是（0，20 )，平均可以抢到10元。 以此类推，每一次随机范围的均值是相等的。</p><p>数据类型</p><table><thead><tr><th align="center">发红包</th><th align="center">抢红包</th><th align="center">记红包</th><th align="center">拆红包算法</th></tr></thead><tbody><tr><td align="center">list</td><td align="center">list</td><td align="center">hash</td><td align="center">二倍均值法</td></tr></tbody></table><h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><p>改代码没有<code>service</code>只有<code>controller</code></p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringBoot通用依赖模块--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringBoot与Redis整合依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- redis 连接池 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>23.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7777</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis_distributed_lock2</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.136</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">lettuce:</span></span><br><span class="line">        <span class="attr">pool:</span></span><br><span class="line">          <span class="attr">max-idle:</span> <span class="number">8</span></span><br><span class="line">          <span class="attr">max-wait:</span> <span class="string">-1ms</span></span><br><span class="line">          <span class="attr">max-active:</span> <span class="number">8</span></span><br><span class="line">          <span class="attr">min-idle:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">database:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p><code>controller</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> com.google.common.primitives.Ints;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedPackageController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RED_PACKAGE_KEY</span> <span class="operator">=</span> <span class="string">&quot;redPackage:&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RED_PACKAGE_CONSUMER_KEY</span> <span class="operator">=</span> <span class="string">&quot;redPackage:consumer:&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String,Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/send&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">send</span><span class="params">(Integer totalMoney,Integer redPackageNumber)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//拆红包，总金额拆分成多少个红包，每个小红包里面包多少钱</span></span><br><span class="line">        Integer[] splitPackages = splitRedPackage(totalMoney, redPackageNumber);</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RED_PACKAGE_KEY + IdUtil.simpleUUID();</span><br><span class="line">        <span class="comment">//采用list存储红包并设置过期时间</span></span><br><span class="line">        redisTemplate.opsForList().leftPushAll(key, splitPackages);</span><br><span class="line">        redisTemplate.expire(key,<span class="number">1</span>, TimeUnit.DAYS);</span><br><span class="line">        <span class="comment">//将数组转成字符串显示</span></span><br><span class="line">        <span class="keyword">return</span> key + <span class="string">&quot;\t\t&quot;</span>+ Ints.asList(Arrays.stream(splitPackages).mapToInt(Integer::valueOf).toArray());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/rob&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">redPackage</span><span class="params">(String redPackageKey,String userId)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//验证某个用户是否抢过红包</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">redPackage</span> <span class="operator">=</span> redisTemplate.opsForHash().get(RED_PACKAGE_CONSUMER_KEY + redPackageKey, userId);</span><br><span class="line">        <span class="keyword">if</span> (redPackage != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;errorCode:-2,   message: &quot;</span>+<span class="string">&quot;\t&quot;</span>+userId+<span class="string">&quot; 用户你已经抢过红包了&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//从 list 里面出队一个红包，抢到一个</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">partRedPackage</span> <span class="operator">=</span> redisTemplate.opsForList().leftPop(RED_PACKAGE_KEY + redPackageKey);</span><br><span class="line">        <span class="keyword">if</span> ( partRedPackage == <span class="literal">null</span> ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;errorCode:-1,红包抢完了&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//抢到手后，记录进去hash表示谁抢到了多少钱的某一个红包</span></span><br><span class="line">        redisTemplate.opsForHash().put(RED_PACKAGE_CONSUMER_KEY + redPackageKey, userId, partRedPackage);</span><br><span class="line">        System.out.println(<span class="string">&quot;用户: &quot;</span>+userId+<span class="string">&quot;\t 抢到多少钱红包: &quot;</span>+partRedPackage);</span><br><span class="line">        <span class="comment">//TODO 后续异步进mysql或者RabbitMQ进一步处理</span></span><br><span class="line">        <span class="keyword">return</span> String.valueOf(partRedPackage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拆完红包总金额+每个小红包金额别太离谱</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> totalMoney</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> redPackageNumber</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer[] splitRedPackage(Integer totalMoney,Integer redPackageNumber)&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">useMoney</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        Integer[] redPackageNumbers = <span class="keyword">new</span> <span class="title class_">Integer</span>[redPackageNumber];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; redPackageNumber; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == redPackageNumber-<span class="number">1</span>) &#123;</span><br><span class="line">                redPackageNumbers[i] = totalMoney - useMoney;<span class="comment">//如果为最后一个红包把剩余的金额放到里面</span></span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//二倍均值算法，每次拆分后塞进子红包的金额 = 随机区间(0,(剩余红包金额M ÷ 未被抢的剩余红包个数N)×2)</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">avgMoney</span> <span class="operator">=</span> ((totalMoney-useMoney)/(redPackageNumber-i))*<span class="number">2</span>;</span><br><span class="line">                redPackageNumbers[i] = <span class="number">1</span> + <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(avgMoney);</span><br><span class="line">            &#125;</span><br><span class="line">            useMoney += redPackageNumbers[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redPackageNumbers;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果</p><p>发红包</p><p><img src="/hexo-docs/images/redisImages/image-20250724173311185.png" alt="image-20250724173311185"></p><p>抢红包</p><p><img src="/hexo-docs/images/redisImages/image-20250724173732374.png" alt="image-20250724173732374"></p><p>抢完红包</p><p><img src="/hexo-docs/images/redisImages/image-20250724173814301.png" alt="image-20250724173814301"></p><p>抢过红包</p><p><img src="/hexo-docs/images/redisImages/image-20250724173832149.png" alt="image-20250724173832149"></p><p><img src="/hexo-docs/images/redisImages/image-20250724173842305.png" alt="image-20250724173842305"></p><p><img src="/hexo-docs/images/redisImages/image-20250724173931290.png" alt="image-20250724173931290"></p><h4 id="如何批量删除？"><a href="#如何批量删除？" class="headerlink" title="如何批量删除？"></a>如何批量删除？</h4><p>当需要删除符合特定模式的键时，可以结合 <em>KEYS</em> 或 <em>SCAN</em> 命令。</p><p><strong>使用 KEYS + xargs：</strong></p><p>redis-cli KEYS “pattern*” | xargs redis-cli DEL</p><ul><li>示例：删除所有以 <em>user:</em> 开头的键：</li></ul><p>redis-cli KEYS “user:*” | xargs redis-cli DEL</p><p><strong>使用 SCAN + xargs（推荐生产环境）：</strong></p><p>redis-cli –scan –pattern “cache:*” | xargs -L 1000 redis-cli DEL</p><ul><li>SCAN 命令避免了 KEYS 的阻塞问题，更适合大规模数据。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 后端 Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HyperLogLog&amp;Geo&amp;Bitmap</title>
      <link href="/hexo-docs/2025/08/13/redis/hyperloglogGeoBitmap/"/>
      <url>/hexo-docs/2025/08/13/redis/hyperloglogGeoBitmap/</url>
      
        <content type="html"><![CDATA[<h2 id="统计类型有哪些？"><a href="#统计类型有哪些？" class="headerlink" title="统计类型有哪些？"></a>统计类型有哪些？</h2><ul><li><p>亿级系统中常见的四种统计</p><ul><li><p>聚合统计</p><p>统计多个集合元素的聚合结果，就是前面的交集差集等集合统计</p><p><img src="/hexo-docs/images/redisImages/image-20250630182439434.png" alt="image-20250630182439434"></p></li><li><p>排序统计（zset）</p><p>在面对需要展示最新列表、排行榜等场景时，如果数据更新频繁或者需要分页显示，建议使用ZSet</p><p><img src="/hexo-docs/images/redisImages/image-20250630182620433.png" alt="image-20250630182620433"></p><p>因为可以使用分页，正反排序</p></li><li><p>二值统计（bitmap）</p><p>集合元素的取值就只有0和1两种，在钉钉上班签到打开的场景中，我们只用记录有签到（1）和没签到（0）</p></li><li><p>基数统计（hyperloglog）</p><p>指 <strong>统计一个集合不重复元素个数</strong></p></li></ul></li></ul><h2 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h2><p>名词解释</p><ul><li><p>什么是<code>UV</code>?</p><ul><li>Unique Visitor，独立访客，一般理解为客户端<code>IP</code></li><li>需要去重考虑，例如一个人一天访问了10次网站，一天的<code>UV</code>就是1</li></ul></li><li><p>什么是<code>PV</code>?</p><ul><li>Page View，页面浏览量</li><li>不用去重，例如一个人一天访问了10次网站，一天的<code>PV</code>就是10</li></ul></li><li><p>什么是<code>DAU</code>?</p><ul><li><p>Daily  Active User</p><ul><li><p>日活跃用户量</p><p>登录或者使用了某个产品的用户数（去重复登录的用户），避免恶意刷单</p></li><li><p>常用于反映网站，互联网应用或者网络游戏的运营情况</p></li></ul></li></ul></li><li><p>什么是<code>MAU</code>？</p><ul><li><p>Monthly Active User</p><p>月活跃用户量</p></li></ul></li></ul><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>很多计数类场景，比如 每日注册 IP 数、每日访问 IP 数、页面实时访问数 PV、访问用户数 UV等。</p><p>因为主要的目标高效、巨量地进行计数，所以对存储的数据的内容并不太关心。</p><p>也就是说它只能用于统计巨量数量，不太涉及具体的统计对象的内容和精准性。</p><p>统计单日一个页面的访问量(PV)，单次访问就算一次。</p><p>统计单日一个页面的用户访问量(UV)，即按照用户为维度计算，单个用户一天内多次访问也只算一次。</p><p>多个key的合并统计，某个门户网站的所有模块的PV聚合统计就是整个网站的总PV。</p><h2 id="HyperLogLog是什么？"><a href="#HyperLogLog是什么？" class="headerlink" title="HyperLogLog是什么？"></a>HyperLogLog是什么？</h2><p>基数（HyperLogLog）：是一种数据集，去重复后的真实个数</p><p>例如：</p><p>​（全集）&#x3D;2,4,6,8,77,39,4,8,10</p><p>​去掉重复的内容</p><p>​基数 &#x3D; {2,4,6,8,77,39,10} &#x3D; 7</p><p>去重复统计功能的基数算法-就是<code>HyperLogLog</code></p><p><img src="/hexo-docs/images/redisImages/image-20250701165444246.png" alt="image-20250701165444246"></p><p>基数统计：用于统计一个集合中不重复的元素个数，就是对集合去重复后剩余元素的计算</p><p>一句话：去重脱水后的真实数据</p><p>基本命令：</p><p><img src="/hexo-docs/images/redisImages/image-20250701165630737.png" alt="image-20250701165630737"></p><p><img src="/hexo-docs/images/redisImages/image-20250701165643622.png" alt="image-20250701165643622"></p><h3 id="原理说明"><a href="#原理说明" class="headerlink" title="原理说明"></a>原理说明</h3><ul><li>只是进行不重复的基数统计，不是集合也不保存数据，只记录数量而不是具体内容</li><li>有误差<ul><li>HyperLogLog提供不精确的去重计数方案</li><li>牺牲准确率来换取时间，误差仅仅是0.81%左右</li></ul></li><li>误差出处<ul><li><a href="http://antirez.com/news/75">http://antirez.com/news/75</a></li></ul></li></ul><h2 id="HyperLogLog-案例"><a href="#HyperLogLog-案例" class="headerlink" title="HyperLogLog 案例"></a>HyperLogLog 案例</h2><p>统计<code>UV</code>(需要去重)的访问量</p><p><code>HyperLogLogService</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HyperLogLogService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String,Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * PostConstruct：页面初始化完成之后立即执行该方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initIp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            String ip;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">200</span>; i++) &#123;</span><br><span class="line">                <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">                ip = random.nextInt(<span class="number">256</span>) + <span class="string">&quot;.&quot;</span></span><br><span class="line">                        + random.nextInt(<span class="number">256</span>) + <span class="string">&quot;.&quot;</span></span><br><span class="line">                        + random.nextInt(<span class="number">256</span>) + <span class="string">&quot;.&quot;</span></span><br><span class="line">                        + random.nextInt(<span class="number">256</span>);</span><br><span class="line">                <span class="type">Long</span> <span class="variable">hll</span> <span class="operator">=</span> redisTemplate.opsForHyperLogLog().add(<span class="string">&quot;hll&quot;</span>,ip);</span><br><span class="line">                log.info(<span class="string">&quot;ip=&#123;&#125;，改ip访问首页的次数是&#123;&#125;&quot;</span>,ip,hll);</span><br><span class="line">                <span class="comment">//模拟用户访问</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">uv</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHyperLogLog().size(<span class="string">&quot;hll&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>HyperLogLogController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.HyperLogLogService;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HyperLogLogController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> HyperLogLogService hyperLogLogService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/uv&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">uv</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> hyperLogLogService.uv();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果</p><p><img src="/hexo-docs/images/redisImages/image-20250701171958060.png" alt="image-20250701171958060"></p><p><img src="/hexo-docs/images/redisImages/image-20250701172010589.png" alt="image-20250701172010589"></p><h2 id="GEO"><a href="#GEO" class="headerlink" title="GEO"></a>GEO</h2><p>经纬度</p><p>经度与纬度的合称组成一个坐标系统。又称为地理坐标系统，它是一种利用三度空间的球面来定义地球上的空间的球面坐标系统，能够标示地球上的任何一个位置。</p><p>经线和纬线</p><p>是人们为了在地球上确定位置和方向的，在地球仪和地图上画出来的，地面上并线。</p><p>和经线相垂直的线叫做纬线(纬线指示东西方向)。纬线是一条条长度不等的圆圈。最长的纬线就是赤道。 </p><p>因为经线指示南北方向，所以经线又叫子午线。 国际上规定，把通过英国格林尼治天文台原址的经线叫做0°所以经线也叫本初子午线。在地球上经线指示南北方向，纬线指示东西方向。</p><p>东西半球分界线：东经160° 西经20°</p><p>经度和维度</p><p>经度(longitude)：<strong>东经为正数，西经为负数。东西经</strong></p><p>纬度(latitude)：<strong>北纬为正数，南纬为负数。南北纬</strong></p><p><img src="/hexo-docs/images/redisImages/image-20250701175834150.png" alt="image-20250701175834150"></p><h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><h4 id="GEOADD添加经纬度坐标"><a href="#GEOADD添加经纬度坐标" class="headerlink" title="GEOADD添加经纬度坐标"></a><code>GEOADD</code>添加经纬度坐标</h4><p><img src="/hexo-docs/images/redisImages/image-20250701180309617.png" alt="image-20250701180309617"></p><p><img src="/hexo-docs/images/redisImages/image-20250701180323735.png" alt="image-20250701180323735"></p><p><code>GEOADD city 116.403963 39.915119 &quot;天安门&quot; 116.403414 39.924091 &quot;故宫&quot; 116.024067 40.362639 &quot;长城&quot;</code></p><p>处理中文乱码</p><p><img src="/hexo-docs/images/redisImages/image-20250701181926979.png" alt="image-20250701181926979"></p><h4 id="GEOPOS返回经纬度"><a href="#GEOPOS返回经纬度" class="headerlink" title="GEOPOS返回经纬度"></a><code>GEOPOS</code>返回经纬度</h4><p><img src="/hexo-docs/images/redisImages/image-20250701180348924.png" alt="image-20250701180348924"></p><p><img src="/hexo-docs/images/redisImages/image-20250701180356965.png" alt="image-20250701180356965"></p><p><code>GEOPOS city 天安门 故宫</code></p><h4 id="GEOHASH返回坐标的geohash表示"><a href="#GEOHASH返回坐标的geohash表示" class="headerlink" title="GEOHASH返回坐标的geohash表示"></a><code>GEOHASH</code>返回坐标的<code>geohash</code>表示</h4><p><code>geohash算法生成的base32编码值</code></p><p><img src="/hexo-docs/images/redisImages/image-20250701180431448.png" alt="image-20250701180431448"></p><p><img src="/hexo-docs/images/redisImages/image-20250701180441115.png" alt="image-20250701180441115"></p><p><code>GEOHASH city 天安门 故宫 长城</code></p><h4 id="GEODIST两个位置之间的距离"><a href="#GEODIST两个位置之间的距离" class="headerlink" title="GEODIST两个位置之间的距离"></a><code>GEODIST</code>两个位置之间的距离</h4><p><img src="/hexo-docs/images/redisImages/image-20250701180528876.png" alt="image-20250701180528876"></p><p><img src="/hexo-docs/images/redisImages/image-20250701180537106.png" alt="image-20250701180537106"></p><p><code>GEODIST city 天安门 长城 km</code></p><p>后面参数是距离单位：</p><p>m 米</p><p>km 千米</p><p>ft 英尺</p><p>mi 英里</p><h4 id="GEORADIUS以半径为中心，查找附近的XXX"><a href="#GEORADIUS以半径为中心，查找附近的XXX" class="headerlink" title="GEORADIUS以半径为中心，查找附近的XXX"></a><code>GEORADIUS</code>以半径为中心，查找附近的XXX</h4><p><code>georadius</code>以给定的经纬度为中心， 返回键包含的位置元素当中， 与中心的距离不超过给定最大距离的所有位置元素。</p><p><code>GEORADIUS city 116.418017 39.914402 10 km withdist withcoord count 10 withhash desc</code></p><p><code>GEORADIUS city 116.418017 39.914402 10 km withdist withcoord count 10 desc</code></p><p>WITHDIST: 在返回位置元素的同时， 将位置元素与中心之间的距离也一并返回。 距离的单位和用户给定的范围单位保持一致。</p><p>WITHCOORD: 将位置元素的经度和维度也一并返回。</p><p>WITHHASH: 以 52 位有符号整数的形式， 返回位置元素经过原始 geohash 编码的有序集合分值。 这个选项主要用于底层应用或者调试， 实际中的作用并不大</p><p>COUNT 限定返回的记录数。</p><p><img src="/hexo-docs/images/redisImages/image-20250701180712723.png" alt="image-20250701180712723"></p><h4 id="GEORADIUSBYMEMBER"><a href="#GEORADIUSBYMEMBER" class="headerlink" title="GEORADIUSBYMEMBER"></a><code>GEORADIUSBYMEMBER</code></h4><p><img src="/hexo-docs/images/redisImages/image-20250701180726862.png" alt="image-20250701180726862"></p><p><img src="/hexo-docs/images/redisImages/image-20250701180734871.png" alt="image-20250701180734871"></p><h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p><code>GEOService</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.geo.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisGeoCommands;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GEOService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CITY</span> <span class="operator">=</span> <span class="string">&quot;city&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加经纬度坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">geoAdd</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Point&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;天安门&quot;</span>, <span class="keyword">new</span> <span class="title class_">Point</span>(<span class="number">116.403963</span>, <span class="number">39.915119</span>));</span><br><span class="line">        map.put(<span class="string">&quot;故宫&quot;</span>, <span class="keyword">new</span> <span class="title class_">Point</span>(<span class="number">116.403414</span>, <span class="number">39.924091</span>));</span><br><span class="line">        map.put(<span class="string">&quot;长城&quot;</span>, <span class="keyword">new</span> <span class="title class_">Point</span>(<span class="number">116.024067</span>, <span class="number">40.362639</span>));</span><br><span class="line">        redisTemplate.opsForGeo().add(CITY, map);</span><br><span class="line">        <span class="keyword">return</span> map.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据名称获得经纬度的坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> member 地方名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Point</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Point <span class="title function_">position</span><span class="params">(String member)</span>&#123;</span><br><span class="line">        List&lt;Point&gt; pointList = redisTemplate.opsForGeo().position(CITY, member);</span><br><span class="line">        <span class="keyword">if</span> (pointList != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> pointList.get(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据名称获得 hash值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> member 地方名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hash</span><span class="params">(String member)</span>&#123;</span><br><span class="line">        List&lt;String&gt; listHash = redisTemplate.opsForGeo().hash(CITY, member);</span><br><span class="line">        <span class="keyword">if</span> (listHash != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> listHash.get(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> member;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得两个位置之间给定的距离公里</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> member1 地方名称1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> member2 地方名称2</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Distance</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Distance <span class="title function_">distance</span><span class="params">(String member1, String member2)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForGeo().distance(CITY, member1, member2, Metrics.KILOMETERS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过经度，纬度查找附近的,北京王府井位置116.418017,39.914402</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> GeoResults</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; resultsByMember()&#123;</span><br><span class="line">        <span class="type">Circle</span> <span class="variable">circle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Circle</span>(<span class="number">116.418017</span>, <span class="number">39.914402</span>, Metrics.KILOMETERS.getMultiplier());</span><br><span class="line">        <span class="comment">//返回50条,升序</span></span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForGeo().radius(CITY, circle, RedisGeoCommands.GeoRadiusCommandArgs</span><br><span class="line">                .newGeoRadiusArgs().includeDistance().includeCoordinates().sortAscending().limit(<span class="number">50</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>GEOController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.GEOService;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> jakarta.websocket.server.PathParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.geo.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisGeoCommands;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GEOController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> GEOService geoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">geoAdd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> geoService.geoAdd();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/position&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Point <span class="title function_">position</span><span class="params">(<span class="meta">@PathParam(&quot;member&quot;)</span> String member)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> geoService.position(member);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hash&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hash</span><span class="params">(<span class="meta">@PathParam(&quot;member&quot;)</span>String member)</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> geoService.hash(member);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/distance&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Distance <span class="title function_">distance</span><span class="params">(<span class="meta">@PathParam(&quot;member1&quot;)</span>String member1,<span class="meta">@PathParam(&quot;member2&quot;)</span> String member2)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> geoService.distance(member1, member2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/resultsByMember&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; resultsByMember()&#123;</span><br><span class="line">        <span class="keyword">return</span> geoService.resultsByMember();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果</p><p><img src="/hexo-docs/images/redisImages/image-20250701184025361.png" alt="image-20250701184025361"></p><p><img src="/hexo-docs/images/redisImages/image-20250701184321171.png" alt="image-20250701184321171"></p><p><img src="/hexo-docs/images/redisImages/image-20250701184340915.png" alt="image-20250701184340915"></p><p><img src="/hexo-docs/images/redisImages/image-20250701184421375.png" alt="image-20250701184421375"></p><p><img src="/hexo-docs/images/redisImages/image-20250701184523390.png" alt="image-20250701184523390"></p><h2 id="bitmap"><a href="#bitmap" class="headerlink" title="bitmap"></a>bitmap</h2><p>由0和1状态表现的二进制的bit数组</p><ul><li>能干嘛<ul><li>用于状态统计</li></ul></li></ul><p>命令</p><ul><li><p><code>setbit</code></p><ul><li><img src="/hexo-docs/images/redisImages/image-20250703111837545.png" alt="image-20250703111837545"></li><li><code>setbit 键 偏移位 只能零或者1</code></li></ul><p>Bitmap的偏移量是从零开始算的</p><ul><li><p><code>gitbit key offset</code></p></li><li><p><code>setbit</code>和<code>gitbit</code>案例说明</p><ul><li>按天</li></ul><p>  <img src="/hexo-docs/images/redisImages/image-20250703112136942.png" alt="image-20250703112136942"></p><ul><li><p>按照年</p><ul><li><p>按年去存储一个用户的签到情况，365 天只需要 365 &#x2F; 8 ≈ 46 Byte，1000W 用户量一年也只需要 44 MB 就足够了。</p><p>假如是亿级的系统，</p><p>每天使用1个1亿位的Bitmap约占12MB的内存（10^8&#x2F;8&#x2F;1024&#x2F;1024），10天的Bitmap的内存开销约为120MB，内存压力不算太高。在实际使用时，最好对Bitmap设置过期时间，让Redis自动删除不再需要的签到记录以节省内存开销。</p></li></ul></li></ul></li></ul></li><li><p><code>strlen</code>：统计字节数占用多少</p><ul><li><img src="/hexo-docs/images/redisImages/image-20250703112416306.png" alt="image-20250703112416306"></li><li>不是字符串长度而是占据几个字节，超过8位后自己按照8位一组一byte再扩容</li></ul></li><li><p><code>bitcount</code></p><ul><li><p>全部键里面含有1的有多少个？</p><ul><li><img src="/hexo-docs/images/redisImages/image-20250703112506864.png" alt="image-20250703112506864"></li></ul></li><li><p>一年365天，全年天天登陆占用多少字节</p><p><img src="/hexo-docs/images/redisImages/image-20250703112549848.png" alt="image-20250703112549848"></p></li></ul></li><li><p><code>bitop</code></p><ul><li><p>连续2天都签到的用户</p><p>加入某个网站或者系统，它的用户有1000W，做个用户id和位置的映射</p><p>比如0号位对应用户id：uid-092iok-lkj</p><p>比如1号位对应用户id：uid-7388c-xxx</p><p><img src="/hexo-docs/images/redisImages/image-20250703112629437.png" alt="image-20250703112629437"></p></li></ul></li></ul><h2 id="布隆过滤器"><a href="#布隆过滤器" class="headerlink" title="布隆过滤器"></a>布隆过滤器</h2><p>由一个初值都为零的bit数组和多个哈希函数构成，用来快速判断集合中是否存在某个元素</p><p><img src="/hexo-docs/images/redisImages/image-20250703112915859.png" alt="image-20250703112915859"></p><ul><li><p>设计思想：</p><ul><li>本质就是判断具体数据是否存在于一个大的集合中</li></ul></li><li><p>备注</p><ul><li><p>布隆过滤器是一种类似<span style="color:#CC0000;">set的数据结构</span>，只是统计结果在巨量数据下有点瑕疵，不够完美。</p></li><li><p>布隆过滤器（英语：Bloom Filter）是 1970 年由布隆提出的。</p><p>它实际上是一个很长的二进制数组(00000000)+一系列随机hash算法映射函数，主要用于判断一个元素是否在集合中。</p><p>通常我们会遇到很多要判断一个元素是否在某个集合中的业务场景，一般想到的是将集合中所有元素保存起来，然后通过比较确定。</p><p>链表、树、哈希表等等数据结构都是这种思路。但是随着集合中元素的增加，我们需要的存储空间也会呈现线性增长，最终达到瓶颈。同时检索速度也越来越慢，上述三种结构的检索时间复杂度分别为O(n),O(logn),O(1)。这个时候，布隆过滤器（Bloom Filter）就应运而生</p><p><img src="/hexo-docs/images/redisImages/image-20250703113110565.png" alt="image-20250703113110565"></p></li></ul></li></ul><p>布隆过滤器高效地插入和查询，占用空间少，返回的结果是不够确定+不够完美</p><p><img src="/hexo-docs/images/redisImages/image-20250703112915859.png" alt="image-20250703112915859"></p><table><thead><tr><th align="center">目的</th><th align="center">减少内存占用</th></tr></thead><tbody><tr><td align="center">方式</td><td align="center">不保存数据信息，只是在内存中做一个是否存在的标记flag</td></tr></tbody></table><p>一个元素如果判断结果：存在时，元素不一定存在，但是判断结果为不存在时，则一定不存在。</p><p>布隆过滤器可以添加元素，但是不能删除元素，由于设计<code>hashcode</code>判断依据，删掉元素会导致误判率增加。</p><blockquote><ul><li>总结：</li><li>有，是可能有</li><li>无，是肯定无<ul><li>可以保证的是，如果布隆过滤器判断一个元素不在一个集合中，那这个元素一定不会在集合中</li></ul></li></ul></blockquote><p>原理：<a href="https://blog.csdn.net/qq_41125219/article/details/119982158">布隆(Bloom Filter)过滤器——全面讲解，建议收藏-CSDN博客</a></p><p>使用场景</p><ul><li><p>解决缓存穿透的问题，和<code>redis</code>集合<code>bitmap</code>使用</p></li><li><p>黑名单校验，识别垃圾邮件</p><ul><li><p>发现存在黑名单中的，就执行特定操作。比如：识别垃圾邮件，只要是邮箱在黑名单中的邮件，就识别为垃圾邮件。</p><p>假设黑名单的数量是数以亿计的，存放起来就是非常耗费存储空间的，布隆过滤器则是一个较好的解决方案。</p><p>把所有黑名单都放在布隆过滤器中，在收到邮件时，判断邮件地址是否在布隆过滤器中即可。</p></li></ul></li><li><p>安全连接网址，全球上10亿的网址判断</p></li></ul><p>案例：</p><p>白名单的可以访问，不在白名单的不能访问</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- redis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 连接池 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Mysql数据库驱动--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--SpringBoot集成druid连接池--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mybatis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--通用Mapper--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>tk.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/db01?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">test-while-idle:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Redis7_study</span></span><br><span class="line">  <span class="attr">swagger2:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span> <span class="comment"># 是否开启swagger</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.133</span> <span class="comment"># redis IP 地址</span></span><br><span class="line">      <span class="attr">database:</span> <span class="number">0</span> <span class="comment"># redis 0号数据库</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span> <span class="comment"># redis 端口</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">redis</span> <span class="comment"># redis 密码</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.lazy.pojo</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span></span><br></pre></td></tr></table></figure><p><code>实体类</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Table;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Table(name = &quot;t_customer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Customer</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String cname;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">    <span class="keyword">private</span> Boolean sex;</span><br><span class="line">    <span class="keyword">private</span> Date birth;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>service</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.mapper.CustomerMapper;</span><br><span class="line"><span class="keyword">import</span> com.lazy.pojo.Customer;</span><br><span class="line"><span class="keyword">import</span> com.lazy.utlis.CheckUtils;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CustomerMapper customerMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CUSTOMER_KEY</span> <span class="operator">=</span> <span class="string">&quot;customer:&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CheckUtils checkUtils;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCustomer</span><span class="params">(Customer customer)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> customerMapper.insert(customer);</span><br><span class="line">        <span class="keyword">if</span> (result &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            customer  = customerMapper.selectByPrimaryKey(customer.getId());</span><br><span class="line">            redisTemplate.opsForValue().set(CUSTOMER_KEY + customer.getId(), customer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Customer <span class="title function_">findCustomerById</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        Customer customer;</span><br><span class="line">        customer = (Customer) redisTemplate.opsForValue().get(CUSTOMER_KEY + id);</span><br><span class="line">        <span class="keyword">if</span> (customer == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//缓存没有,查询数据库</span></span><br><span class="line">            customer = customerMapper.selectByPrimaryKey(id);</span><br><span class="line">            <span class="keyword">if</span> (customer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//缓存有，缓存到redis中</span></span><br><span class="line">                redisTemplate.opsForValue().set(CUSTOMER_KEY + id, customer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> customer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Customer <span class="title function_">findCustomerByIdWithBloomFilter</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CUSTOMER_KEY + id;</span><br><span class="line">        Customer customer;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!checkUtils.checkWithBloomFilter(<span class="string">&quot;whitelistCustomer&quot;</span>, key))&#123;</span><br><span class="line">            log.info(<span class="string">&quot;白名单暂无此信息：&#123;&#125;&quot;</span>,key);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        customer = (Customer) redisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="keyword">if</span> (customer == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//缓存没有,查询数据库</span></span><br><span class="line">            customer = customerMapper.selectByPrimaryKey(id);</span><br><span class="line">            <span class="keyword">if</span> (customer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//缓存有，缓存到redis中</span></span><br><span class="line">                redisTemplate.opsForValue().set(CUSTOMER_KEY + id, customer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> customer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>controller</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.pojo.Customer;</span><br><span class="line"><span class="keyword">import</span> com.lazy.service.CustomerService;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.ZoneId;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CustomerService customerService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/customer/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Customer <span class="title function_">addCustomer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Customer</span> <span class="variable">customer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Customer</span>();</span><br><span class="line">        customer.setId(<span class="number">1</span>);</span><br><span class="line">        customer.setAge(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">60</span>));</span><br><span class="line">        customer.setSex(<span class="literal">true</span>);</span><br><span class="line">        customer.setPhone(<span class="string">&quot;131412421&quot;</span>);</span><br><span class="line">        customer.setCname(<span class="string">&quot;zs&quot;</span>);</span><br><span class="line">        customer.setBirth(Date.from(LocalDateTime.now().atZone(ZoneId.systemDefault()).toInstant()));</span><br><span class="line">        customerService.addCustomer(customer);</span><br><span class="line">        <span class="keyword">return</span> customer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/customer/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Customer <span class="title function_">getCustomerById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> customerService.findCustomerById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/customerWithBloomFilter/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Customer <span class="title function_">getCustomerByIdWithBloomFilter</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> customerService.findCustomerByIdWithBloomFilter(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>检查是否是在白名单工具类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.utlis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查是否有白名单</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CheckUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">checkWithBloomFilter</span><span class="params">(String checkItem,String key)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hashValue</span> <span class="operator">=</span> Math.abs(key.hashCode());<span class="comment">//获得hashcode值</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">index</span> <span class="operator">=</span> (<span class="type">long</span>)(hashValue % Math.pow(<span class="number">2</span>,<span class="number">32</span>));<span class="comment">//得到对应槽位，2的32次方是int类型</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">existOk</span> <span class="operator">=</span> redisTemplate.opsForValue().getBit(checkItem, index);</span><br><span class="line">        log.info(<span class="string">&quot;key：&#123;&#125;,对应的坑位是：&#123;&#125;,是否存在:&#123;&#125;&quot;</span>,key,index,existOk);</span><br><span class="line">        <span class="keyword">return</span> existOk;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 后端 Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis基础</title>
      <link href="/hexo-docs/2025/08/13/redis/index/"/>
      <url>/hexo-docs/2025/08/13/redis/index/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是Redis？"><a href="#什么是Redis？" class="headerlink" title="什么是Redis？"></a>什么是Redis？</h2><p>Redis 是一个内存数据存储，被数百万开发者用作缓存、向量数据库、文档数据库、流式引擎和消息代理。Redis 具有内置的复制和不同级别的磁盘持久化。它支持复杂的数据类型（例如，字符串、散列、列表、集合、有序集合和 JSON），并为这些数据类型定义了原子操作。</p><p>Redis 通常被称为数据结构服务器。这意味着 Redis 通过一组命令提供对可变数据结构的访问，这些命令通过 TCP 套接字和简单协议使用服务器-客户端模型发送。因此，不同的进程可以以共享的方式查询和修改相同的数据结构。</p><p>Redis 实现的数据结构具有一些特殊的属性：</p><ol><li>Redis 会将其存储在磁盘上，即使它们总是被服务器内存中读取和修改。这意味着 Redis 速度快，但同时也非易失性。</li><li>数据结构的实现强调内存效率，因此 Redis 内部的数据结构可能比使用高级编程语言建模的相同数据结构模型使用更少的内存。</li><li>Redis 提供了一系列数据库中常见的功能，如复制、可调的持久性级别、集群和高度可用性。</li></ol><h2 id="下载Redis"><a href="#下载Redis" class="headerlink" title="下载Redis"></a>下载Redis</h2><blockquote><p><strong>命名规则：</strong></p><p>​版本号第二位如果是奇数，则为非稳定版本，如2.7、2.9、3.1</p><p>​版本号第二位如果是偶数，则为文档版本，如2.6、2.8、3.0、3.2</p><p>​当前奇数版本就是下一个稳定版本的开发版本，如2.9版本是3.0版本的开发版本</p></blockquote><p><a href="https://redis.io/downloads/">下载Redis</a></p><h2 id="redis解决中文乱码"><a href="#redis解决中文乱码" class="headerlink" title="redis解决中文乱码"></a>redis解决中文乱码</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">redis-cli -a 密码 --raw</span><br></pre></td></tr></table></figure><h2 id="Linux安装Redis"><a href="#Linux安装Redis" class="headerlink" title="Linux安装Redis"></a>Linux安装Redis</h2><ol><li><p><code>getconf LONG_BIT</code>命令先看看是多少位的，一定要是64位</p></li><li><p>Centos7安装<code>Redis</code>，先具备gcc环境</p><ol><li><p>查看是否具有<code>gcc</code>环境<code>gcc -v</code></p><p><img src="/hexo-docs/images/redisImages/image-20250406143055527.png" alt="image-20250406143055527"></p></li><li><p>如果没有<code>gcc</code>环境，则通过<code>yum -y install gcc-c++</code>命令来安装<code>gcc</code></p></li></ol></li><li><p><code>Redis</code>官方建议版本升级到6.0.8以上</p><p><img src="/hexo-docs/images/redisImages/redis.png"></p></li><li><p>下载命令<code>wget https://download.redis.io/releases/redis-7.0.0.tar.gz</code></p><p><img src="/hexo-docs/images/redisImages/redis%E5%AE%89%E8%A3%85.png"></p></li><li><p>进入<code>/opt</code>目录下解压<code>redis</code>，解压命令<code>tar -zxvf redis-7.0.0.tar.gz</code></p><ol><li><p>解压后</p><p><img src="/hexo-docs/images/redisImages/image-20250406143750928.png" alt="image-20250406143750928"></p></li></ol></li><li><p>进入目录<code>cd redis-7.0.0</code></p></li><li><p>在<code>redis-7.0.0</code>目录执行<code>make</code>命令</p><p><img src="/hexo-docs/images/redisImages/image-20250406144027413.png" alt="image-20250406144027413"></p></li><li><p>查看默认安装目录：<code>usr/local/bin</code></p><ol><li><p>安装完后查看</p><p><img src="/hexo-docs/images/redisImages/image-20250406144621148.png" alt="image-20250406144621148"></p></li><li><p><code>redis-benchmark</code>：性能测试工具，服务启动后运行该命令，看看自己笔记本性能如何</p></li><li><p><code>redis-check-aof</code>：修复有问题的AOF文件</p></li><li><p><code>redis-check-dump</code>：修复有问题的dump.rdb文件</p></li><li><p><span style="color:#990000;"><code>redis-cli</code>：客户端，操作入口</span></p></li><li><p><code>redis-sentinel</code>：redis集群使用</p></li><li><p><span style="color:#990000;"><code>redis-server</code>：redis服务器启动命令</span></p></li></ol></li><li><p>将默认的<code>redis.conf</code>拷贝到自己定义好的一个路径下，比如<code>/myredis</code>(如果改坏的话有备份)</p><p><img src="/hexo-docs/images/redisImages/image-20250406144745776.png" alt="image-20250406144745776"></p></li><li><p>修改<code>/myredis</code>目录下<code>redis.conf</code>配置文件做初始化设置</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">redis.conf配置文件，改完后确保生效，记得重启，记得重启</span><br><span class="line"></span><br><span class="line">   <span class="number">1</span> 默认daemonize no              改为  daemonize yes</span><br><span class="line"></span><br><span class="line">   <span class="number">2</span> 默认protected-<span class="built_in">mode</span>  yes    改为  protected-<span class="built_in">mode</span> no</span><br><span class="line"></span><br><span class="line">   <span class="number">3</span> 默认bind <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>             改为  直接注释掉(默认bind <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>只能本机访问)或改成本机IP地址，否则影响远程IP连接</span><br><span class="line"></span><br><span class="line">   <span class="number">4</span> 添加redis密码                      改为 requirepass 你自己设置的密码</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250406144910139.png" alt="image-20250406144910139"></p><p><code>daemonize yes</code>：在后台启动</p><p><img src="/hexo-docs/images/redisImages/image-20250406144931933.png" alt="image-20250406144931933"></p><p><code>proteccted-mode no</code>：关闭保护模式</p><p><img src="/hexo-docs/images/redisImages/image-20250406144946561.png" alt="image-20250406144946561"></p><p><code>requirepass 密码</code>：添加redis密码</p></li><li><p>启动服务</p><p><code>/usr/local/bin</code>目录下运行<code>redis-server</code>，启用<code>/myredis</code>目录下的<code>redis.conf</code>文件</p></li><li><p>连接服务</p><p><img src="/hexo-docs/images/redisImages/image-20250406145135039.png" alt="image-20250406145135039"></p><p>Warning: Using a password with ‘-a’ or ‘-u’ option on the command line interface may not be safe.</p><p>我看着不爽，怎么办？</p><p>warning 这串输出并不是普通输出，</p><p>shell的标准输出包含两种：</p><p>1（标准输出）</p><p>2（标准错误）我们的命令，即包含1也包含2，2即是我们想要去除的提示。</p><p>解决办法将标准错误去除即可，追加2&gt;&#x2F;dev&#x2F;null，将标准错误丢弃即可，就没有烦人的警告了。</p><p><img src="/hexo-docs/images/redisImages/image-20250406145229817.png" alt="image-20250406145229817"></p></li><li><p>关闭</p><ol><li>单实例关闭：<code>redis-cli -a redis密码 shutdown</code></li><li>多实例关闭，指定端口关闭：<code>redis-cli -p 6379 shutdown</code></li></ol></li></ol><h2 id="Redis卸载步骤"><a href="#Redis卸载步骤" class="headerlink" title="Redis卸载步骤"></a>Redis卸载步骤</h2><ol><li><p>停止<code>redis-server</code>服务</p><p><img src="/hexo-docs/images/redisImages/image-20250406145603470.png" alt="image-20250406145603470"></p></li><li><p>删除<code>/usr/local/lib</code>目录下与<code>redis</code>相关的文件</p><ol><li>ls -l &#x2F;usr&#x2F;local&#x2F;bin&#x2F;redis-*</li><li>rm -rf &#x2F;usr&#x2F;local&#x2F;bin&#x2F;redis-*</li><li><img src="/hexo-docs/images/redisImages/image-20250406145719940.png" alt="image-20250406145719940"></li></ol></li></ol><p>​</p><h2 id="Redis7新特性"><a href="#Redis7新特性" class="headerlink" title="Redis7新特性"></a>Redis7新特性</h2><table><thead><tr><th>多AOF文件支持</th><th>7.0 版本中一个比较大的变化就是 aof 文件由一个变成了多个，主要分为两种类型：基本文件(base files)、增量文件(incr files)，请注意这些文件名称是复数形式说明每一类文件不仅仅只有一个。在此之外还引入了一个清单文件(manifest) 用于跟踪文件以及文件的创建和应用顺序（恢复）</th></tr></thead><tbody><tr><td>config命令增强</td><td>对于Config Set 和Get命令，支持在一次调用过程中传递多个配置参数。例如，现在我们可以在执行一次Config Set命令中更改多个参数： config set maxmemory 10000001 maxmemory-clients 50% port 6399</td></tr><tr><td>限制客户端内存使用Client-eviction</td><td>一旦 Redis 连接较多，再加上每个连接的内存占用都比较大的时候， Redis总连接内存占用可能会达到maxmemory的上限，可以增加允许限制所有客户端的总内存使用量配置项，redis.config 中对应的配置项&#x2F;&#x2F; 两种配置形式：指定内存大小、基于 maxmemory 的百分比。maxmemory-clients 1gmaxmemory-clients 10%</td></tr><tr><td>listpack紧凑列表调整</td><td>listpack 是用来替代 ziplist 的新数据结构，在 7.0 版本已经没有 ziplist 的配置了（6.0版本仅部分数据类型作为过渡阶段在使用）listpack 已经替换了 ziplist 类似 hash-max-ziplist-entries 的配置</td></tr><tr><td>访问安全性增强ACLV2</td><td>在redis.conf配置文件中，protected-mode默认为yes，只有当你希望你的客户端在没有授权的情况下可以连接到Redis server的时候可以将protected-mode设置为no</td></tr><tr><td>Redis Functions</td><td>Redis函数，一种新的通过服务端脚本扩展Redis的方式，函数与数据本身一起存储。简言之，redis自己要去抢夺Lua脚本的饭碗</td></tr><tr><td>RDB保存时间调整</td><td>将持久化文件RDB的保存规则发生了改变，尤其是时间记录频度变化</td></tr><tr><td>命令新增和变动</td><td>Zset (有序集合)增加 ZMPOP、BZMPOP、ZINTERCARD 等命令Set (集合)增加 SINTERCARD 命令LIST (列表)增加 LMPOP、BLMPOP ，从提供的键名列表中的第一个非空列表键中弹出一个或多个元素。</td></tr><tr><td>性能资源利用率、安全、等改进</td><td>自身底层部分优化改动，Redis核心在许多方面进行了重构和改进主动碎片整理V2：增强版主动碎片整理，配合Jemalloc版本更新，更快更智能，延时更低HyperLogLog改进：在Redis5.0中，HyperLogLog算法得到改进，优化了计数统计时的内存使用效率，7更加优秀更好的内存统计报告</td></tr></tbody></table><p>Redis 命令</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">redis  执行了make install后，redis的课执行文件都会自动复制到 /usr/local/bin 目录</span><br><span class="line">redis-server        redis服务器</span><br><span class="line">redis-cli            redis命令行客户端</span><br><span class="line">redis-benchmark        redis性能测试工具</span><br><span class="line">redis-check-aof        aof文件修复工具</span><br><span class="line">redis-check-dump    rdb文件检查工具</span><br></pre></td></tr></table></figure><h2 id="启动Redis"><a href="#启动Redis" class="headerlink" title="启动Redis"></a>启动Redis</h2><ol><li><p>启动配置文件</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">redis-server /myredis/redis7.conf # /myredis/redis7.conf 为配置文件名</span><br></pre></td></tr></table></figure></li><li><p>启动</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">redis-cli</span><br><span class="line">auth 用户名</span><br></pre></td></tr></table></figure></li><li><p>或</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">redis-cli -a 用户名 -p 端口号</span><br></pre></td></tr></table></figure></li></ol><blockquote><p>不输入 <code>-p 端口号</code> 默认会找 <code>6379</code></p></blockquote><p>停止</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">redis-cli shutdown</span><br></pre></td></tr></table></figure><h2 id="添加中文支持"><a href="#添加中文支持" class="headerlink" title="添加中文支持"></a>添加中文支持</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">redis-cli -a 密码 -p 端口号 --raw  # --raw 添加中文支持</span><br></pre></td></tr></table></figure><h2 id="Redis十大数据类型："><a href="#Redis十大数据类型：" class="headerlink" title="Redis十大数据类型："></a>Redis十大数据类型：</h2><h3 id="字符串（String）"><a href="#字符串（String）" class="headerlink" title="字符串（String）"></a>字符串（String）</h3><p><code>String</code>是<code>redis</code>最基本的类型，一个<code>key</code>对应一个<code>value</code></p><p><code>String</code>类型是二进制安全的（支持序列号），意思是<code>redis</code>的<code>String</code>可以包含任何数据，比如<code>jpg</code>图片或者序列号对象</p><p><code>String</code>类型是<code>Redis</code>最基本的数据类型，一个<code>Redis</code>中字符串<code>value</code>最多可以是512MB</p><h4 id="Redis键（key）"><a href="#Redis键（key）" class="headerlink" title="Redis键（key）"></a>Redis键（key）</h4><p><img src="/hexo-docs/images/redisImages/key.png"></p><ol><li><code>keys *</code>：查看当前库所有的key</li><li><code>exists key</code>：判断某个key是否存在</li><li><code>type key</code>：查看你的key是什么类型</li><li><code>del key</code>：删除指定的key数据</li><li><code>unlink key</code>：非阻塞删除，仅仅将keys从keyspace元数据中删除，真正的删除会在后续异步中操作</li><li><code>ttl key</code>：查看还有多少秒过期，-1表示永不过期，-2表示已过期</li><li><code>expire key 秒钟</code>：为给定的key设置过期时间</li><li><code>move key dbindex【0-15】</code>：将当前数据库的key移动到给定的数据库<code>dbindex【0-15】</code>当中</li><li><code>select dbindex</code>：切换数据库【0-15】，默认为0</li><li><code>dbsize</code>：查看当前数据库key的数量</li><li><code>flushdb</code>：清空当前库</li><li><code>flushall</code>：通杀全部库</li><li><code>help @*</code>：* 表示所有命令，都可以通过help来查看帮助文档</li></ol><blockquote><p>命令不区分大小写，但是名字区分大小写</p></blockquote><h4 id="String-类型的-API"><a href="#String-类型的-API" class="headerlink" title="String 类型的 API"></a>String 类型的 API</h4><p><img src="/hexo-docs/images/redisImages/string%E5%91%BD%E4%BB%A4.png"></p><h5 id="set-指令"><a href="#set-指令" class="headerlink" title="set 指令"></a>set 指令</h5><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> key value [NX|XX] [GET] [EX seconds|PX milliseconds|EXAT unix-<span class="built_in">time</span>-seconds|PXAT unix-<span class="built_in">time</span>-milliseconds|KEEPTTL]</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250406163641212.png" alt="image-20250406163641212"></p><ol><li><code>set key value [ex seconds]</code> ：设置带有过期时间的键值对 单位：秒,效果等同于<code>setex key seconds value</code>，成功返回“OK”，如果对在有效时间内存在的键值对重新使用该命令，则value会被覆盖，有效时间也会被覆盖，并重新开始计时。</li><li><code>set key value [px milliseconds] </code>：设置带有过期时间的键值对  单位：毫秒,效果等同于<code>psetex key milliseconds value</code>，成功返回“OK”。如果对在有效时间内存在的键值对重新使用该命令，则value会被覆盖，有效时间也会被覆盖，并重新开始计时。</li><li><code>set key value nx</code>： 设置key-value的键值对，如果之前该键key不存在，则设置执行操作，返回值“OK”,如果之前键值对存在，则不会执行操作，返回“（nil）”，效果等同于<code>setnx key value</code>，但是后者成功返回值1，失败返回值0。</li><li><code>set key value xx</code>： 设置key-value的键值对,只有之前该键值key对已经存在的时候才会执行操作（value会被覆盖），返回“OK”，若之前不存在则不会执行，返回“nil”。</li></ol><h5 id="同时设置-获取多个键值"><a href="#同时设置-获取多个键值" class="headerlink" title="同时设置&#x2F;获取多个键值"></a>同时设置&#x2F;获取多个键值</h5><p>设置多个值</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">mset k1 v1 k2 v2 .... #输出 v1 v2</span><br></pre></td></tr></table></figure><p><code>msetnx</code>：如果不存在创建成功</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">msetnx k1 v1 k2 v2 ...</span><br></pre></td></tr></table></figure><blockquote><p>假如k1已经存在，k4不存在，则都不执行成功</p></blockquote><p>获取多个值</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">mget k1 k2 ...</span><br></pre></td></tr></table></figure><p><code>mget</code>：都存在才会执行成功</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">mget k1 k2 k3 k4 k5 ....</span><br></pre></td></tr></table></figure><h5 id="获取指定区间范围内的值"><a href="#获取指定区间范围内的值" class="headerlink" title="获取指定区间范围内的值"></a>获取指定区间范围内的值</h5><p><code>getrange</code>：获取指定区间的值</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">getrange k1 <span class="number">0</span> <span class="number">4</span> # 获取k1的 <span class="number">0</span> <span class="number">5</span>是区间的范围，默认从<span class="number">0</span>开始</span><br></pre></td></tr></table></figure><p><code>setrange</code>：设置指定区间的值</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">setrange k1 <span class="number">3</span> xxxx #设置k1从<span class="number">3</span>往后的值为xxx</span><br></pre></td></tr></table></figure><h5 id="数值的增减"><a href="#数值的增减" class="headerlink" title="数值的增减"></a>数值的增减</h5><blockquote><p>注意：一定要是数字才能进行加减</p></blockquote><h6 id="递增数字"><a href="#递增数字" class="headerlink" title="递增数字"></a>递增数字</h6><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">incr key</span><br></pre></td></tr></table></figure><h6 id="增加指定的整数"><a href="#增加指定的整数" class="headerlink" title="增加指定的整数"></a>增加指定的整数</h6><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">incrby key x</span><br><span class="line"><span class="function">key: 代表变量名</span></span><br><span class="line"><span class="function"><span class="title">x</span>：代表增加的数字</span></span><br></pre></td></tr></table></figure><h6 id="递减数值"><a href="#递减数值" class="headerlink" title="递减数值"></a>递减数值</h6><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">decr key</span><br></pre></td></tr></table></figure><h6 id="减少指定的整数"><a href="#减少指定的整数" class="headerlink" title="减少指定的整数"></a>减少指定的整数</h6><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">decrby key x</span><br><span class="line">key：代表变量名</span><br><span class="line">x：代表递减的数字</span><br></pre></td></tr></table></figure><h5 id="获取字符串的长度"><a href="#获取字符串的长度" class="headerlink" title="获取字符串的长度"></a>获取字符串的长度</h5><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">strlen key</span><br><span class="line">key：表示变量名</span><br></pre></td></tr></table></figure><h5 id="字符串长度和内容追加"><a href="#字符串长度和内容追加" class="headerlink" title="字符串长度和内容追加"></a>字符串长度和内容追加</h5><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="built_in">append</span> key value</span><br><span class="line">key：表示变量名</span><br><span class="line">value：表示要增加的字符</span><br></pre></td></tr></table></figure><h5 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h5><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">setnx key value # 如果不存在把变量和值加上</span><br><span class="line">key：变量名</span><br><span class="line">value：值</span><br><span class="line">setex(<span class="built_in">set</span> with expire)键秒值/setnx(<span class="built_in">set</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exist</span>)</span><br></pre></td></tr></table></figure><p><code>set key vlaue 【ex seconds】【px milliseconds】 【nx|xx】</code></p><p><code>ex：key在多少秒后过期</code><br><code>px：key在多少毫秒之后过期</code><br><code>nx：当key不存在的时候，才创建key，效果等同于setnx</code><br><code>xx：当key存在的时候，覆盖key</code></p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">setex k1 <span class="built_in">time</span> value</span><br><span class="line">k1：表示变量名</span><br><span class="line"><span class="built_in">time</span>：表示过期事件</span><br><span class="line">value：表示变量名的值</span><br></pre></td></tr></table></figure><p><code>setnx</code>：只有在key不存在设置key值</p><h6 id="getset-先get在set-先获取值，在设置值"><a href="#getset-先get在set-先获取值，在设置值" class="headerlink" title="getset(先get在set)先获取值，在设置值"></a>getset(先get在set)先获取值，在设置值</h6><p>getset：将给定key的值设为value，并返回key的旧值（old value）。简单一句话，先get然后立即set</p><h3 id="列表（List）"><a href="#列表（List）" class="headerlink" title="列表（List）"></a>列表（List）</h3><blockquote><p>特点：单key多value</p></blockquote><p><code>Redis</code>列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）</p><p>它的底层实际是个双端链表，最多可以包含 2³²-1 个元素（4294967295，每个列表超过40亿个元素）,主要功能有push&#x2F;pop等，一般用在栈、队列、消息队列等场景。left、right都可以插入添加：</p><p>如果键不存在，创建新的链表</p><p>如果键已存在，新增内容</p><p>如果值全移除，对应的键也就消失了。</p><blockquote><p>它的底层实际是个双向链表，对两端的操作性能很高，通过索引下标的操作中间的节点性能会较差</p></blockquote><p><img src="/hexo-docs/images/redisImages/list.png"></p><p><img src="/hexo-docs/images/redisImages/list%E5%91%BD%E4%BB%A4.png"></p><h4 id="常用操作命令-L是从左到右，R是从右到左"><a href="#常用操作命令-L是从左到右，R是从右到左" class="headerlink" title="常用操作命令(L是从左到右，R是从右到左)"></a>常用操作命令(L是从左到右，R是从右到左)</h4><ol><li><code>lpop key count</code>：移除并获取到第count个元素</li><li><code>lpush key value 【value2】</code>：将一个或多个值插入到列表头部</li><li><code>lpushx key value</code>：将一个或多个值插入到已存在的列表头部</li><li><code>lrange key start stop</code>：获取列表指定范围内的元素，start是开始，stop结束</li><li><code>lrem key count value</code>：移除列表重复的元素，count移除几个重复的元素，value元素值</li><li><code>lset key index value</code>：通过索引设置列表元素的值，index索引，value要设定的值</li><li><code>ltrim key start stop</code>：截取指定索引区间的元素，格式是 ltrim list的key 起始索引，结束索引</li><li><code>rpop key count</code>：移除并获取列表最后count个元素</li><li><code>rpoplpush source destination</code>：移除列表的最后一个元素，并将该元素添加到另一个列表并返回，就是将source的头一个元素，给destination的尾元素</li><li><code>rpush key value [value2]</code>：在列表中添加一个或多个值</li><li><code>rpushx key value</code>：为已存在的列表添加值</li><li><code>llen key</code>：获取列表中元素的个数</li><li><code>lindex key index</code>：按照索引下标获得元素（从上到下），key表示变量名，index表示索引</li><li><code>linsert key before/after oldValue newValue</code>：已有值插入的新值，key变量名，before&#x2F;after 前或后，oldValue：key的已有值，newValue要插入的值</li></ol><p><code>rpush/lpush/lrange</code></p><p><img src="/hexo-docs/images/redisImages/image-20250406172123946.png" alt="image-20250406172123946"></p><p><code>rpop/lpop</code></p><p><img src="/hexo-docs/images/redisImages/image-20250406172356511.png" alt="image-20250406172356511"></p><p><code>lrem/lset</code></p><p><img src="/hexo-docs/images/redisImages/image-20250406172732940.png" alt="image-20250406172732940"></p><p><code>ltrim</code></p><p><img src="/hexo-docs/images/redisImages/image-20250406173052157.png" alt="image-20250406173052157"></p><p><code>rpoplpush</code></p><p><img src="/hexo-docs/images/redisImages/image-20250406173317366.png" alt="image-20250406173317366"></p><p><code>llen/lindex</code></p><p><img src="/hexo-docs/images/redisImages/image-20250406173508097.png" alt="image-20250406173508097"></p><p><code>linsert</code></p><p><img src="/hexo-docs/images/redisImages/image-20250406173742983.png" alt="image-20250406173742983"></p><h3 id="哈希表（Hash）"><a href="#哈希表（Hash）" class="headerlink" title="哈希表（Hash）"></a>哈希表（Hash）</h3><p>特点：KV模式不变，但V是一个键值对</p><p><code>Redis hash</code>是一个<code>String</code>类型的<code>field</code>（字段）和<code>value</code>（值）的映射表，hash特别适合用于存储对象。</p><p><code>Redis</code>中每个<code>hash</code>可以存储  键值对（40多亿）</p><h4 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h4><p><img src="/hexo-docs/images/redisImages/hash%E5%91%BD%E4%BB%A4.png"></p><p><code>hset key filed value</code>：设置值</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">hset user:<span class="number">001</span> id <span class="number">11</span> name z3 age <span class="number">25</span></span><br></pre></td></tr></table></figure><p><code>hget key filed value</code> ：获取值</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">hget user:<span class="number">001</span> name</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250406175251833.png" alt="image-20250406175251833"></p><p><strong><code>hmset/hmget</code>可以进行批处理</strong></p><p><code>hmset key filed value</code>：设置值</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">hmest user:<span class="number">001</span> id <span class="number">12</span> name li4 age <span class="number">26</span> </span><br></pre></td></tr></table></figure><p><code>hmget key filed value</code>：获取值</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">hmget user:<span class="number">001</span> id name age</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250406175459761.png" alt="image-20250406175459761"></p><p><code>hgetall key</code>：遍历key的所有属性和值</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">hgetall user:<span class="number">001</span></span><br></pre></td></tr></table></figure><p><code>hdel key filed value</code>：删除指定的元素</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">hdel user:<span class="number">001</span> age</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250406175551830.png" alt="image-20250406175551830"></p><p><code>hlen key</code>：获取key的长度</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">hlen user:<span class="number">001</span></span><br></pre></td></tr></table></figure><p><code>hexists key</code>：在key里面的某个值的key</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">hexists user:<span class="number">001</span> name</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250406175725012.png" alt="image-20250406175725012"></p><p><code>hkeys key</code>：获取key里面的属性</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">hkeys hash1</span><br></pre></td></tr></table></figure><p><code>hvals key</code>：获取key里面的所有value值</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">hvals hash2</span><br></pre></td></tr></table></figure><p><code>hincrby key filed value</code>：对某个整数的值加value</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">hincrby user:<span class="number">001</span> age <span class="number">1</span></span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250406175903212.png" alt="image-20250406175903212"></p><p><code>hincrbyfloat key filed value</code>：对某个浮点数的值加value</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">hincrbyfloat user:<span class="number">001</span> score <span class="number">0</span>.<span class="number">5</span></span><br></pre></td></tr></table></figure><p><code>hsetnx key fuked value</code>：不存在赋值成功&#x2F;新建成功，存在了无效</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">hsetnx user:<span class="number">001</span> email zzssww@qq.com</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250406180220994.png" alt="image-20250406180220994"></p><h3 id="集合（Set）"><a href="#集合（Set）" class="headerlink" title="集合（Set）"></a>集合（Set）</h3><p>特点：单值多value，且无重复</p><p><code>Redis</code>的<code>Set</code>是<code>String</code>类型的无序集合，集合成员是唯一的，这就意味着不能出现重复的数据，集合对象的编码可以是 <code>intset</code> 或者 <code>hashtable</code></p><p><code>Redis</code> 中 <code>Set</code>集合是通过哈希表实现的，所以添加，删除，查找的复杂度都是 O(1) 。</p><p>集合中最大的成员数 2³²-1 (4294967295，每个集合可存储40多亿个成员)</p><p><code>sadd key member[member ...]</code>：添加元素，自动去重</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">sadd set1 <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p><code>smembers key</code>：遍历集合中的所有元素</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">smembers set1</span><br></pre></td></tr></table></figure><p><code>sismember key member</code>：判断member属性值是否在集合中</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">sismember set1 <span class="number">1</span></span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250409154617663.png" alt="image-20250409154617663"></p><p><code>srem key member[member ...]</code>：删除member元素</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">srem set1 <span class="number">1</span></span><br></pre></td></tr></table></figure><p><code>scard key</code>：获取集合里面的元素个数</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">scard set1</span><br></pre></td></tr></table></figure><p><code>srandmember key [数字]</code>：从集合中随机展现设置的数字个数元素，元素不删除</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">srandomember set1 <span class="number">1</span> # 从set1集合展现<span class="number">1</span>个元素</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250409154749391.png" alt="image-20250409154749391"></p><p><code>spop key [数字]</code>：从集合中随机弹出一个元素，出一个删一个</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">spop set1 <span class="number">1</span> #随机弹出一个元素</span><br></pre></td></tr></table></figure><p><code>smove key1 key2 member</code>：在key1里已存在的某个值，将key1里已存在的某个值赋值给key2集合运算</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">smove set1 set2 <span class="number">7</span> #将set1中的<span class="number">7</span>移动到set2里面</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250409154951035.png" alt="image-20250409154951035"></p><h4 id="集合运算"><a href="#集合运算" class="headerlink" title="集合运算"></a>集合运算</h4><p>A、B 两个集合，A的元素是abc12，B的元素是123ax</p><ol><li><p>集合的差集运算 A-B</p><p>属于A但不属于B的元素构成的集合</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">sdiff key [key...]</span><br><span class="line">例：</span><br><span class="line">sdiff set2 set1 # set2 和 set1 的差集</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250409155136630.png" alt="image-20250409155136630"></p></li><li><p>集合的并集运算 A ∪ B</p><p>属于A或者属于B的元素合并后的集合</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">sunion key [key...]</span><br><span class="line">例：</span><br><span class="line">sunion set1 set2 # set1 和 set2 的并集</span><br></pre></td></tr></table></figure></li><li><p>集合的交集运算 A ∩ B</p><p>属于 A 同时也属于 B 的共同拥有的元素构成的集合</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">sinter key [key...]</span><br><span class="line">例：</span><br><span class="line">sinter set1 set2 # set1 和 set2 的交集</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250409155245778.png" alt="image-20250409155245778"></p></li></ol><p><code>sintercard numkeys key [key...][limit limit]</code></p><p>redis7新命令</p><p>它不返回结果集，而只返回结果的基数（去重以后的数字个数）。返回由所有给定集合的交集产生的集合的基数（返回重复的个数）</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">sinetercard <span class="number">2</span> set1 set2 limit <span class="number">1</span> # <span class="number">2</span>个key set1 和 set2 只显示 <span class="number">1</span>个</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250409155446974.png" alt="image-20250409155446974"></p><h3 id="有序集合（ZSet（sorted-set））"><a href="#有序集合（ZSet（sorted-set））" class="headerlink" title="有序集合（ZSet（sorted set））"></a>有序集合（ZSet（sorted set））</h3><p><code>zset</code>(<code>sorted set</code>：有序集合)</p><p>在 set 基础上，每个val值前加一个score分数值。之前set是k1 v1 v2 v3</p><p>现在zset是k1 score v1 score2 v2</p><p><code>Redis zset</code>和<code>set</code>一样也是<code>String</code>类型元素的集合，且不允许重复的成员。</p><blockquote><p>不同的是每个元素都会关联一个<code>double</code>类型的分数，<code>redis</code>正是通过分数来为集合中的成员进行从小到大的排序。</p></blockquote><blockquote><p><code>zset</code>的成员是唯一的，但分数<code>(score)</code>却可以重复</p></blockquote><blockquote><p><code>zset</code>集合是通过哈希表实现的，所以添加、删除、查找的复杂度都是O（1）。集合中最大的成员数为 2³²-1</p></blockquote><p>向有序集合中加入一个元素和该元素的分数</p><p>添加元素：</p><p><code>zadd key score member [score member...]</code></p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">zadd zset1 <span class="number">60</span> v1 <span class="number">80</span> v2 <span class="number">90</span> v3 <span class="number">100</span> v5</span><br></pre></td></tr></table></figure><p>按照元素分数从小到大的顺序，返回索引从start到stop之间的所有元素：</p><p><code>zrange key start stop [withscores]</code></p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">zrange zset <span class="number">0</span> -<span class="number">1</span> # 遍历所有</span><br><span class="line">zrange zset <span class="number">0</span> -<span class="number">1</span> withscores # 遍历所有包括分数</span><br></pre></td></tr></table></figure><p>逆序按照元素分数从小到大的顺序，返回索引从start到stop之间的所有元素</p><p><code>zrevrange</code></p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">zrevrange zset <span class="number">0</span> -<span class="number">1</span> withscores # 逆序遍历包括分数</span><br><span class="line">zrevrange zset <span class="number">0</span> -<span class="number">1</span> # 逆序遍历所有</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250409170419443.png" alt="image-20250409170419443"></p><p>获取指定分数范围的元素：</p><p><code>zrangebyscore key min max [withscores] [limit offset count]</code></p><p>withscores：包括变量名</p><p>(：不包含</p><p>limit：作用是返回限制，limit开始下标步，多少步</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">zrangebyscore zset1 <span class="number">60</span> <span class="number">90</span> # 按照分数找变量名</span><br><span class="line">zrangebyscore zset1 <span class="number">60</span> <span class="number">90</span> withscores # 按照分数遍历变量和值</span><br><span class="line">zrangebyscore zset1 （<span class="number">60</span> <span class="number">90</span> withscores # 按分数遍历变量和值，不包含<span class="number">60</span></span><br><span class="line">zrangebyscore zset1 （<span class="number">60</span> <span class="number">90</span> withscores limit <span class="number">0</span> <span class="number">1</span>  # 按照分数遍历变量和值，不包含<span class="number">60</span>，返回一个键值对</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250409171225792.png" alt="image-20250409171225792"></p><p>获取元素的分数：</p><p><code>zscore key member</code></p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">zscore zset1 v1 # 获取 v1 元素的分数</span><br></pre></td></tr></table></figure><p>获取集合中元素的数量：</p><p><code>zcard key</code></p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">zcard zset1 # 获取 zset1 的集合数量</span><br></pre></td></tr></table></figure><p>某score下对应的value值，作用是删除元素</p><p><code>zrem key</code></p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">zrem zset1 v5 # 删除 v5 元素</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250409171654381.png" alt="image-20250409171654381"></p><p>增加某个元素的分数：</p><p><code>zincrby key incrmenet member</code></p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">zincrby zset1 <span class="number">3</span> v1 # 给v1的值增加<span class="number">3</span>分</span><br></pre></td></tr></table></figure><p>获得指定分数范围内的元素个数：</p><p><code>zcount key min max</code></p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">zcount zset1 <span class="number">60</span> <span class="number">100</span> # 获取 <span class="number">60</span> 到 <span class="number">100</span> 分数的值有多少个</span><br></pre></td></tr></table></figure><p>从键名列表中的第一个非空排序集中弹出一个或多个元素，它们是成员分数对</p><p><code>zmpop</code> redis 7.0 新命令</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">zmpop <span class="number">1</span> zset min count <span class="number">1</span> # 把最小的键值对给弹出，显示弹出的键值对</span><br></pre></td></tr></table></figure><p>获得下标值：</p><p><code>zrange key values</code></p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">zrange zset <span class="number">0</span> -<span class="number">1</span> # 获得 zset的变量名</span><br></pre></td></tr></table></figure><p>逆序获得下标值</p><p><code>zrevrank key values</code></p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">zrevrank zset v1 # 获得逆序的下标值</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250409172544136.png" alt="image-20250409172544136"></p><h3 id="位图（bitmap）"><a href="#位图（bitmap）" class="headerlink" title="位图（bitmap）"></a>位图（bitmap）</h3><p><code>Bit arrays （or simply bitmaps，我们可以称之为位图）</code></p><img src="/images/redisImages/bitmaps.png" style="zoom:60%;" /><p>一个字节(一个byte)&#x3D;8位</p><p>上图由许许多多的小格子组成，每一个格子里面只能放1或者0，用它来判断Y&#x2F;N状态，说的专业点，就是每一个小格子就是一个个bit</p><p>由0和1状态表现的二进制位的bit数组</p><p>说明：用String类型作为底层数据结构实现的一种统计二值状态的数据类型</p><p>位图本质是数组，它是基于String数据类型的按位的操作。该数组由多个二进制位组成，每个二进制位都对应一个偏移量(我们称之为一个索引)。</p><p>Bitmap支持的最大位数是2^32位，它可以极大的节约存储空间，使用512M内存就可以存储多达42.9亿的字节信息(2^32 &#x3D; 4294967296)</p><p><code>setbit</code>设置bit：</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">setbit key offset value</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250409180618769.png" alt="image-20250409180618769"></p><p><img src="/hexo-docs/images/redisImages/image-20250409180842482.png" alt="image-20250409180842482"></p><p><code>gitbit</code>获取某个bit的值：</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">getbit key offset</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250409180948310.png" alt="image-20250409180948310"></p><p><code>strlen</code>统计字节占用多少：</p><p>不是字符串长度而是占据几个字节，超过8位后自己按照8位一组一byte再扩容</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">strlen key</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250409181059541.png" alt="image-20250409181059541"></p><p><code>bitcount</code>全部键里面含有多少1：</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">bitcount key</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250409181139433.png" alt="image-20250409181139433"></p><p><code>bitop</code>：</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">bitop and destkey key key # 两个key合并放到destkey里面</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250409181646736.png" alt="image-20250409181646736"></p><p><img src="/hexo-docs/images/redisImages/image-20250409181818185.png" alt="image-20250409181818185"></p><h3 id="基数统计（HyperLogLog）属于String-类型"><a href="#基数统计（HyperLogLog）属于String-类型" class="headerlink" title="基数统计（HyperLogLog）属于String 类型"></a>基数统计（HyperLogLog）属于String 类型</h3><p><img src="/hexo-docs/images/redisImages/image-20250409182113564.png" alt="image-20250409182113564"></p><p><code>HyperLogLog</code>是用来做**<u>基数统计</u>**的算法，<code>HyperLogLog</code>的优点是，在输入元素的数量或者体积非常大时，计算基数所需的空间总是固定且很小的。</p><p>在<code>Redis</code>里面，每个<code>HyperLogLog</code>键只需要花费 12KB 内存，就可以计算接近 2^64 个不同元素的基数，这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比。</p><p>但是，因为<code>HyperLogLog</code>只会根据输入元素来计算基数，而不会存储元素本身，所以<code>HyperLogLog</code>不能像集合那样，返回输入的各个元素。</p><p><code>PFADD</code>将所有元素参数添加到 HyperLogLog 数据结构中：</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">PFADD key element [element ...]</span><br></pre></td></tr></table></figure><p><code>PFCOUNT</code>返回给定 HyperLogLog 的基数估算值：</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">PFCOUNT key [key ...]</span><br></pre></td></tr></table></figure><p><code>PFMERGE</code>将多个 HyperLogLog 合并为一个 HyperLogLog ，合并后的 HyperLogLog 的基数估算值是通过对所有 给定 HyperLogLog 进行并集计算得出的：</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">PFMERGE destkey sourcekey [sourcekey ...]</span><br></pre></td></tr></table></figure><p>演示：</p><p><img src="/hexo-docs/images/redisImages/image-20250410160818942.png" alt="image-20250410160818942"></p><h3 id="地理空间（GEO）"><a href="#地理空间（GEO）" class="headerlink" title="地理空间（GEO）"></a>地理空间（GEO）</h3><p>移动互联网时代LBS应用越来越多，交友软件中附近的小姐姐、外卖软件中附近的美食店铺、高德地图附近的核酸检查点等等，那这种附近各种形形色色的XXX地址位置选择是如何实现的？</p><p>地球上的地理位置是使用二维的经纬度表示，经度范围 (-180, 180]，纬度范围 (-90, 90]，只要我们确定一个点的经纬度就可以名取得他在地球的位置。</p><p>例如滴滴打车，最直观的操作就是实时记录更新各个车的位置，</p><p>然后当我们要找车时，在数据库中查找距离我们(坐标x0,y0)附近r公里范围内部的车辆</p><p>使用如下SQL即可：</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">select taxi from position where x0-r &lt; x &lt; x0 + r and y0-r &lt; y &lt; y0+r</span><br></pre></td></tr></table></figure><p>但是这样会有什么问题呢？</p><p>1.查询性能问题，如果并发高，数据量大这种查询是要搞垮数据库的</p><p>2.这个查询的是一个矩形访问，而不是以我为中心r公里为半径的圆形访问。</p><p>3.精准度的问题，我们知道地球不是平面坐标系，而是一个圆球，这种矩形计算在长距离计算时会有很大误差</p><p><code>Redis GEO</code>主要用于存储地理位置信息，并对于存储的信息进行操作，包括：</p><ol><li>添加地理位置的坐标</li><li>获取地理位置的坐标</li><li>计算两个位置之间的距离</li><li>根据用户给定的经纬度坐标来获取指定范围内的地理位置集合</li></ol><p><img src="/hexo-docs/images/redisImages/image-20250410162957806.png" alt="image-20250410162957806"></p><p>命令：</p><p><strong>GEOADD</strong>：添加地理位置</p><p><img src="/hexo-docs/images/redisImages/image-20250410163315401.png" alt="image-20250410163315401"></p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">GEOADD city <span class="number">116</span>.<span class="number">403963</span> <span class="number">39</span>.<span class="number">915119</span> &quot;天安门&quot; <span class="number">116</span>.<span class="number">403414</span> <span class="number">39</span>.<span class="number">924091</span> &quot;故宫&quot; <span class="number">116</span>.<span class="number">024067</span> <span class="number">40</span>.<span class="number">362639</span> &quot;长城&quot;</span><br></pre></td></tr></table></figure><p><strong>GEOPOS</strong>：获取指定的经纬度</p><p><img src="/hexo-docs/images/redisImages/image-20250410163507481.png" alt="image-20250410163507481"></p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">GEOPOS city 天安门 故宫 长城</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250410163723293.png" alt="image-20250410163723293"></p><p><strong>GEOHASN</strong>：使用hash值来保存地理位置的坐标</p><p><img src="/hexo-docs/images/redisImages/image-20250410163750436.png" alt="image-20250410163750436"></p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">GEOHASH city 天安门 故宫 长城</span><br></pre></td></tr></table></figure><p><strong>GEOLIST</strong>：返回两个给定位置之间的距离</p><p><img src="/hexo-docs/images/redisImages/image-20250410164012610.png" alt="image-20250410164012610"></p><p>后面参数是距离单位：</p><ol><li>m 米</li><li>km 千米</li><li>ft 英尺</li><li>mi 英里</li></ol><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">GEODIST city 天安门 故宫 km</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250410164156033.png" alt="image-20250410164156033"></p><p>**GEORADIUS(以半径为中心)**： 以给定的经纬度为中心， 返回键包含的位置元素当中， 与中心的距离不超过给定最大距离的所有位置元素。</p> <figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">GEORADIUS city <span class="number">116</span>.<span class="number">418017</span> <span class="number">39</span>.<span class="number">914402</span> <span class="number">10</span> km withdist withcoord count <span class="number">10</span> withhash desc</span><br><span class="line">GEORADIUS city <span class="number">116</span>.<span class="number">418017</span> <span class="number">39</span>.<span class="number">914402</span> <span class="number">10</span> km withdist withcoord withhash count <span class="number">10</span> desc</span><br></pre></td></tr></table></figure><ol><li>WITHDIST: 在返回位置元素的同时， 将位置元素与中心之间的距离也一并返回。 距离的单位和用户给定的范围单位保持一致。</li><li>WITHCOORD: 将位置元素的经度和维度也一并返回。</li><li>WITHHASH: 以 52 位有符号整数的形式， 返回位置元素经过原始 geohash 编码的有序集合分值。 这个选项主要用于底层应用或者调试， 实际中的作用并不大COUNT 限定返回的记录数。</li></ol><p><img src="/hexo-docs/images/redisImages/image-20250410164811698.png" alt="image-20250410164811698"></p><p><strong>GEORADIUSBYMEMBER</strong>：找出位于指定范围内的元素，中心点是由给定的位置元素决定的</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">GEORADIUSBYMEMBER  city 天安门 <span class="number">10</span> km withdist withcoord count <span class="number">10</span> withhash # 找出以天安门为中心，附近<span class="number">10</span>km的地方</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250410165223579.png" alt="image-20250410165223579"></p><h3 id="流（Stream"><a href="#流（Stream" class="headerlink" title="流（Stream)"></a>流（Stream)</h3><p><code>Redis Stream</code>是 <code>Redis 5.0</code>版本新增加的数据结构。</p><p><code>Redis Stream</code>主要用于消息队列（MQ，Message Queue），Redis 本身是有一个 Redis 发布订阅 （pub&#x2F;sub）来实现消息队列的功能，但它有个缺点就是消息无法持久化，如果出现网络断开，Redis 宕机等，消息就会被丢弃。</p><p>简单来说发布订阅（pub&#x2F;sub）可以分发消息，但无法记录历史消息。</p><p>而 Redis Stream 提供了消息的持久化和主备复制功能，可以让任何客户端访问任何时刻的数据，并且能记住每一个客户端的访问位置，还能保证消息不丢失。</p><p>Redis版的MQ消息中间件+阻塞队列</p><p><strong>能干嘛？</strong></p><p>实现消息队列，它支持消息的持久化，支持自动生成全局唯一ID、支持ack确认消息的模式、支持消费组模式等，让消息队列更加的稳定和可靠</p><h4 id="底层结构和原理说明"><a href="#底层结构和原理说明" class="headerlink" title="底层结构和原理说明"></a>底层结构和原理说明</h4><p><img src="/hexo-docs/images/redisImages/image-20250410172029685.png" alt="image-20250410172029685"></p><table><thead><tr><th>1</th><th>Message Content</th><th>消息内容</th></tr></thead><tbody><tr><td>2</td><td>Consumer group</td><td>消费组，通过XGROUP CREATE 命令创建，同一个消费组可以有多个消费者</td></tr><tr><td>3</td><td>Last_delivered_id</td><td>游标，每个消费组会有个游标 last_delivered_id，任意一个消费者读取了消息都会使游标 last_delivered_id 往前移动。</td></tr><tr><td>4</td><td>Consumer</td><td>消费者，消费组中的消费者</td></tr><tr><td>5</td><td>Pending_ids</td><td>消费者会有一个状态变量，用于记录被当前消费已读取但未ack的消息Id，如果客户端没有ack，这个变量里面的消息ID会越来越多，一旦某个消息被ack它就开始减少。这个pending_ids变量在Redis官方被称之为 PEL(Pending Entries List)，记录了当前已经被客户端读取的消息，但是还没有 ack (Acknowledge character：确认字符），它用来确保客户端至少消费了消息一次，而不会在网络传输的中途丢失了没处理</td></tr></tbody></table><h4 id="基本命令理论简介"><a href="#基本命令理论简介" class="headerlink" title="基本命令理论简介"></a>基本命令理论简介</h4><p><strong>队列相关指令</strong></p><p><img src="/hexo-docs/images/redisImages/image-20250410172141313.png" alt="image-20250410172141313"></p><p><strong>消费组相关指令</strong></p><p><img src="/hexo-docs/images/redisImages/image-20250410172214112.png" alt="image-20250410172214112"></p><p><strong>四个特殊符号</strong></p><ol><li>-：最小可能出现的id</li><li>+：最大可能出现的id</li><li>$：$表示只消费新的消息，当前流中最大的id，可用于将要到来的信息</li><li>&gt;：用于<code>XREADGROUP</code>命令，表现迄今还没有发送组中使用者的消息，会更新消费组的最后ID</li><li>*：用于<code>XADD</code>命令中，让系统自动生成id</li></ol><h4 id="基本命令实操"><a href="#基本命令实操" class="headerlink" title="基本命令实操"></a>基本命令实操</h4><h5 id="队列相关指令"><a href="#队列相关指令" class="headerlink" title="队列相关指令"></a>队列相关指令</h5><p><strong>XADD</strong>：添加消息队列到末尾</p><p>XADD 用于向Stream 队列中添加消息，如果指定的Stream 队列不存在，则该命令执行时会新建一个Stream 队列</p><p>* 号表示服务器自动生成 MessageID(类似mysql里面主键auto_increment)，后面顺序跟着一堆 业务key&#x2F;value</p><p>信息条目指的是序列号，在相同的毫秒下序列号从0开始递增，序列号是64位长度，理论上在同一毫秒内生成的数据量无法到达这个级别，因此不用担心序列号会不够用。millisecondsTime指的是Redis节点服务器的本地时间，如果存在当前的毫秒时间戳比以前已经存在的数据的时间戳小的话（本地时间钟后跳），那么系统将会采用以前相同的毫秒创建新的ID，也即redis 在增加信息条目时会检查当前 id 与上一条目的 id， 自动纠正错误的情况，一定要保证后面的 id 比前面大，一个流中信息条目的ID必须是单调增的，这是流的基础。<br><strong>客户端显示传入规则:</strong></p><p>Redis对于ID有强制要求，格式必须是时间戳-自增Id这样的方式，且后续ID不能小于前一个ID<br>Stream的消息内容，也就是图中的Message Content它的结构类似Hash结构，以key-value的形式存在。</p><p><img src="/hexo-docs/images/redisImages/image-20250410174747266.png" alt="image-20250410174747266"></p><blockquote><p>注意：</p><ol><li>消息ID必须要比上个ID大</li><li>默认用型号表示自动生成规矩</li><li>*：用于XDD命令中，让系统自动生成ID</li></ol></blockquote><p><strong>xrange</strong>：用于获取消息列表（可以指定范围），忽略删除的消息</p><ol><li>start 表示开始值，- 代表最小值</li><li>end 表示结束值，+ 代表最大值</li><li>count 表示最多获取多少个值</li></ol><p><img src="/hexo-docs/images/redisImages/image-20250410175418702.png" alt="image-20250410175418702"></p><p><strong>xrevrange</strong>：与<code>xrange</code>的区别在于，获取消息列表元素的方向是相反的，end在前，start在后</p><p><img src="/hexo-docs/images/redisImages/image-20250410175614939.png" alt="image-20250410175614939"></p><p><strong>xdel</strong>：删除一条消息</p><p><img src="/hexo-docs/images/redisImages/image-20250410175725471.png" alt="image-20250410175725471"></p><p><strong>xlen</strong>：用于获取stream队列的消息的长度</p><p><img src="/hexo-docs/images/redisImages/image-20250410175746217.png" alt="image-20250410175746217"></p><p><strong>xtrim</strong>：用于对stream的长度进行截取，如超长会进行截取</p><ol><li><code>maxlen</code>：允许的最大长度，对流进行修剪限制长度</li><li><code>minid</code>：允许的最小id，从某id值开始比该id值小的将会被抛弃</li></ol><p><img src="/hexo-docs/images/redisImages/image-20250410180149257.png" alt="image-20250410180149257"></p><p><img src="/hexo-docs/images/redisImages/image-20250410181006834.png" alt="image-20250410181006834"></p><p><strong>xread</strong>：用于获取消息（阻塞&#x2F;非阻塞），只会返回大于指定ID的消息</p><p><img src="/hexo-docs/images/redisImages/image-20250410173811155.png" alt="image-20250410173811155"></p><ol><li><p>非阻塞</p><ol><li>$代表特殊ID，表示以当前Stream已经存储的最大的ID作为最后一个ID，当前Stream中不存在大于当前最大ID的消息，因此此时返回nil</li><li>0-0代表从最小的ID开始获取Stream中的消息，当不指定count，将会返回Stream中的所有消息，注意也可以使用0（00&#x2F;000也都是可以的……）</li></ol><p><img src="/hexo-docs/images/redisImages/image-20250410181716134.png" alt="image-20250410181716134"></p></li><li><p>阻塞</p></li></ol><p><img src="/hexo-docs/images/redisImages/image-20250410182230965.png" alt="image-20250410182230965"></p><p>总结：</p><p>​Stream的基础方法，使用xadd存入消息和xread循环阻塞读取消息的方式可以实现简易版的消息队列，交互流程如下</p><p><img src="/hexo-docs/images/redisImages/image-20250410173936545.png" alt="image-20250410173936545"></p><p>对比list结构</p><p><img src="/hexo-docs/images/redisImages/image-20250410173951159.png" alt="image-20250410173951159"></p><h5 id="消费组相关指令"><a href="#消费组相关指令" class="headerlink" title="消费组相关指令"></a>消费组相关指令</h5><p><code>xgroup create</code>：用于创建消费组</p><p><img src="/hexo-docs/images/redisImages/image-20250410184052182.png" alt="image-20250410184052182"></p><ol><li>$表示从Stream尾部开始消费</li><li>0表示从Stream头部开始消费</li><li>创建消费者组的时候必须指定 ID, ID 为 0 表示从头开始消费，为 $ 表示只消费新的消息，队尾新来</li></ol><p><code>xreadgroup group</code></p><ol><li><p>“&gt;”，表示从第一条尚未被消费的消息开始读取</p></li><li><p>消费组group内的消费组consumer从mystream消息队列中读取所有消息</p></li><li><p>但是，不同消费组的消费者可以消费同一条消息</p><p><img src="/hexo-docs/images/redisImages/image-20250410184654314.png" alt="image-20250410184654314"></p></li><li><p>消费组的目的？</p><p>让组内的多个消费者共同分担读取消息，所以，我们通常会让每个消费者读取部分消息，从而实现消息读取负载在多个消费者间是均衡分布的</p></li></ol><p><img src="/hexo-docs/images/redisImages/image-20250410185005071.png" alt="image-20250410185005071"></p><table><thead><tr><th>1问题</th><th>基于 Stream 实现的消息队列，如何保证消费者在发生故障或宕机再次重启后，仍然可以读取未处理完的消息？</th></tr></thead><tbody><tr><td>2</td><td>Streams 会自动使用内部队列（也称为 PENDING List）留存消费组里每个消费者读取的消息保底措施，直到消费者使用 XACK 命令通知 Streams“消息已经处理完成”。</td></tr><tr><td>3</td><td>消费确认增加了消息的可靠性，一般在业务处理完成之后，需要执行 XACK 命令确认消息已经被消费完成</td></tr></tbody></table><p><img src="/hexo-docs/images/redisImages/image-20250410183229300.png" alt="image-20250410183229300"></p><p><code>xpending</code>：</p><ol><li>查询每个消费组内所有消费者”已读取，但尚未确认”的消息</li><li>查看某个消费者具体读取了哪些数据</li></ol><p><img src="/hexo-docs/images/redisImages/image-20250410185349874.png" alt="image-20250410185349874"></p><p><code>xack</code>：向消息队列确认消息处理已完成</p><p><img src="/hexo-docs/images/redisImages/image-20250411220813033.png" alt="image-20250411220813033"></p><p><code>xinfo</code>：用于打印 stream\consumer\group\的详细信息</p><p><img src="/hexo-docs/images/redisImages/image-20250411220856782.png" alt="image-20250411220856782"></p><h3 id="位域（bitfield）"><a href="#位域（bitfield）" class="headerlink" title="位域（bitfield）"></a>位域（bitfield）</h3><p>通过 <code>bitfield</code>命令可以一次性操作多个比特位域（指的是连续的多个比特位），它会执行一系列操作并返回一个响应数组，这个数组中的元素对应参数列表中的相应操作的执行结果。</p><p>说白了就是通过<code>bitfield</code>命令我们可以一次性对比多个比特位域进行操作。</p><p><img src="/hexo-docs/images/redisImages/image-20250411223808858.png" alt="image-20250411223808858"></p><p>能干嘛？</p><ol><li>位域修改</li><li>溢出控制</li></ol><p><img src="/hexo-docs/images/redisImages/image-20250411221002550.png" alt="image-20250411221002550"></p><p><a href="https://ascii.org.cn/">ascii码 | ascii码对照表</a></p><p>返回指定位域：</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">bitfield key [get <span class="built_in">type</span> offset]</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250411221551010.png" alt="image-20250411221551010"></p><ol><li>i：有符号数</li><li>u：无符号数</li><li>i8：读取8位</li></ol><p>hello 等价于 01101000 01100101 01101100 01101100 01101111</p><p><img src="/hexo-docs/images/redisImages/image-20250411221656767.png" alt="image-20250411221656767"></p><p>设置指定位域并返回它的原值</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">bitfield key [<span class="built_in">set</span> <span class="built_in">type</span> offset value]</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250411222138274.png" alt="image-20250411222138274"></p><p>二进制加一，默认情况下，<code>incrby</code> 使用wrap参数：</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">bitfield key [incrby <span class="built_in">type</span> offset increment]</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250411222525532.png" alt="image-20250411222525532"></p><p>溢出控制<code>overflow[wrap|sat|fail]</code></p><ol><li><p>wrap：使用回绕（wrap around）方法处理有符号数和无符号数的溢出情况</p><p><img src="/hexo-docs/images/redisImages/image-20250411223252108.png" alt="image-20250411223252108"></p></li><li><p>sat：使用饱和计算（saturation arithmetic）方法处理溢出，下溢计算的结果为最小的整数值，而上溢计算的结果为最大的整数值</p><p><img src="/hexo-docs/images/redisImages/image-20250411223309327.png" alt="image-20250411223309327"></p></li><li><p>fail：命令将拒绝执行哪些会导致上溢或者下溢情况出现的计算，并向用户返回空值表示计算未被执行</p><p><img src="/hexo-docs/images/redisImages/image-20250411223324513.png" alt="image-20250411223324513"></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 后端 Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pub&amp;sub(发布&amp;订阅)</title>
      <link href="/hexo-docs/2025/08/13/redis/pub&amp;sub/"/>
      <url>/hexo-docs/2025/08/13/redis/pub&amp;sub/</url>
      
        <content type="html"><![CDATA[<h2 id="发布-订阅"><a href="#发布-订阅" class="headerlink" title="发布&#x2F;订阅"></a>发布&#x2F;订阅</h2><p>是一种消息通信模式：发送者（publish）发送消息，订阅者（subscribe）接受消息，可以实现进程间的消息传递</p><p><code>Redis</code>  可以实现消息中间件 MQ 的功能，通过发布订阅实现消息的引导和分流。<strong>不推荐使用该功能</strong>，专业的事情交给专业的中间件，redis就做好分布式缓存功能</p><p><strong>能干嘛？</strong></p><ul><li><p>redis 客户端可以订阅任意数量的频道，类似我们微信关注多个公众号</p><ul><li><img src="/hexo-docs/images/redisImages/image-20250416152204885.png" alt="image-20250416152204885"></li><li>当有新的消息通过 publish 命令发送给频道 channel1 时<ul><li><img src="/hexo-docs/images/redisImages/image-20250416152303136.png" alt="image-20250416152303136"></li></ul></li></ul><p>总结：</p><p>发布&#x2F;订阅其实是一个轻量的队列，只不过数据不会被持久化，一般用来处理实时性较高的异步消息</p><p><img src="/hexo-docs/images/redisImages/image-20250416152345866.png" alt="image-20250416152345866"></p></li></ul><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3>  <figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">subscribe channel [channel...]</span><br></pre></td></tr></table></figure><ul><li>订阅给定的一个或多个频道的信息</li><li>推荐先执行订阅后再发布，订阅成功之前发布的消息是收不到的</li><li>订阅的客户端每次可以收到一个3个参数的消息<ul><li>消息的种类</li><li>始发频道的名称</li><li>实际的消息内容<ul><li><img src="/hexo-docs/images/redisImages/image-20250416153326379.png" alt="image-20250416153326379"></li></ul></li></ul></li></ul>  <figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">publish channel message </span><br></pre></td></tr></table></figure><ul><li>发布消息到指定的频道</li></ul>  <figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">psubscribe pattern[pattern...]</span><br></pre></td></tr></table></figure><ul><li><p>按照模式批量订阅，订阅一个或多个符合给定模式（支持*号？号之类的）频道</p><ul><li><img src="/hexo-docs/images/redisImages/image-20250416153815078.png" alt="image-20250416153815078"></li></ul></li></ul><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">pubsub subcommand [argument [argument ...]]</span><br></pre></td></tr></table></figure><ul><li>查看订阅与发布系统状态</li></ul><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">pubsub channels  </span><br></pre></td></tr></table></figure><ul><li><p>由活跃频道组成的列表</p></li><li><p><img src="/hexo-docs/images/redisImages/image-20250416154153634.png" alt="image-20250416154153634"></p></li></ul><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">pubsub numsub [channel [channel...]]</span><br></pre></td></tr></table></figure><ul><li>某个频道有几个订阅者</li></ul><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">pubsub numpay</span><br></pre></td></tr></table></figure><ul><li>只统计使用 pubscribe 命令执行的，返回客户端订阅的唯一模式的数量</li><li><img src="/hexo-docs/images/redisImages/image-20250416154647155.png" alt="image-20250416154647155"></li></ul><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">unsubscribe [channel [channel...]]</span><br></pre></td></tr></table></figure><ul><li>取消订阅</li></ul><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">punsubscribe [pattern [pattern...]]</span><br></pre></td></tr></table></figure><ul><li>退订所有给定模式的频道</li></ul><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul><li>redis 可以实现消息中间件 MQ 的功能，通过发布订阅实现消息的引导和分流。<strong>不推荐使用该功能，专业的事情交给专业的中间件出来，redis就做好分布式缓存功能</strong></li><li>pub&#x2F;sub 缺点<ul><li>发布的消息在 redis 系统中不能持久化，因此，必须先订阅，再等待消息发布。如果先发布了消息，那么该消息由于没有订阅者，消息将被直接丢弃</li><li>消息只管发送对于发布者而言消息是即发即失的，不管接收，也没有 ack 机制，无法保证消息的消费成功。</li><li>以上的缺点导致redis的pub&#x2F;sub模式就像个小玩具，在生产环境中几乎无用武之地，为此redis 5.0 版本新增了 stream 数据结构，不但支持多播，还支持数据持久化，相比 pub&#x2F;sub 更加的强大</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> 后端 Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis经典五大类型源码及底层实现</title>
      <link href="/hexo-docs/2025/08/13/redis/redis%E7%BB%8F%E5%85%B8%E4%BA%94%E5%A4%A7%E7%B1%BB%E5%9E%8B%E5%8F%8A%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/"/>
      <url>/hexo-docs/2025/08/13/redis/redis%E7%BB%8F%E5%85%B8%E4%BA%94%E5%A4%A7%E7%B1%BB%E5%9E%8B%E5%8F%8A%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="Redis经典五大类型源码及底层实现"><a href="#Redis经典五大类型源码及底层实现" class="headerlink" title="Redis经典五大类型源码及底层实现"></a>Redis经典五大类型源码及底层实现</h2><p>本源码基于redis7.0.5</p><p>Redis数据类型和底层数据结构</p><ul><li>SDS动态字符串</li><li>双向链表</li><li>压缩列表ziplist</li><li>哈希表hashtable</li><li>跳表skiplist</li><li>整数集合intset</li><li>快速列表quicklist</li><li>紧凑列表listpack</li></ul><p>源码在哪里？</p><p>github ：<a href="https://github.com/redis/redis">https://github.com/redis/redis</a></p><p><img src="/hexo-docs/images/redisImages/image-20250716165354378.png" alt="image-20250716165354378"></p><h3 id="Redis核心部分"><a href="#Redis核心部分" class="headerlink" title="Redis核心部分"></a>Redis核心部分</h3><p>src源码包下面该如何看？</p><h4 id="Redis基本数据结构（骨架）"><a href="#Redis基本数据结构（骨架）" class="headerlink" title="Redis基本数据结构（骨架）"></a>Redis基本数据结构（骨架）</h4><ul><li><p>Github官网说明</p><p><img src="/hexo-docs/images/redisImages/image-20250716170131856.png" alt="image-20250716170131856"></p><ul><li>Redis对象object.c</li><li>字符串t_string.c</li><li>列表t_list.c</li><li>字典t_hash.c</li><li>集合及有序集合t_set.c和t_zset.c</li><li>数据流t_stream.c：Streams的底层实现结构listpack.c和rax.c</li></ul></li><li><p>简单动态字符串sds.c</p></li><li><p>整数集合intset.c</p></li><li><p>压缩列表ziplist.c</p></li><li><p>快速链表quicklist.c</p></li><li><p>listpack（紧凑列表）</p></li><li><p>字典dict.c</p></li></ul><h4 id="Redis数据库的实现"><a href="#Redis数据库的实现" class="headerlink" title="Redis数据库的实现"></a>Redis数据库的实现</h4><ul><li>数据库的底层实现db.c</li><li>持久化rdb.c和aof.c</li></ul><h4 id="Redis服务端和客户端实现"><a href="#Redis服务端和客户端实现" class="headerlink" title="Redis服务端和客户端实现"></a>Redis服务端和客户端实现</h4><ul><li>事件驱动ae.c和ae_epoll.c</li><li>网络连接anet.c和networking.c</li><li>服务端程序server.c</li><li>客户端程序redis-cli.c</li></ul><h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><ul><li>主从复制replication.c</li><li>哨兵sentinel.c</li><li>集群cluster.c</li><li>其他数据结构，如hyperloglog.c、geo.c等</li><li>其他功能，如pub&#x2F;sub、Lua脚本</li></ul><h2 id="平时说的redis的字典数据库KV键到底是什么"><a href="#平时说的redis的字典数据库KV键到底是什么" class="headerlink" title="平时说的redis的字典数据库KV键到底是什么"></a>平时说的redis的字典数据库KV键到底是什么</h2><ul><li><p>怎样实现键值对（key-value）数据库的</p><ul><li>redis是key-value存储系统<ul><li>key一般都是String类型的字符串对象</li><li>value类型则为redis对象（redisObject）<ul><li>value可以是字符串对象，也可以是集合数据类型的对象，比如List对象、Hash对象、Set对象和Zset对象</li></ul></li></ul></li></ul><p><img src="/hexo-docs/images/redisImages/image-20250716170742811.png" alt="image-20250716170742811"></p></li><li><p>10大类型说明（粗分）</p><ul><li><p>传统的5大类型</p><ul><li>String</li><li>List</li><li>Hash</li><li>Set</li><li>ZSet</li></ul></li><li><p>新介绍的5大类型</p><ul><li><p>bitmap：实质String</p></li><li><p>hyperloglog：实质String</p></li><li><p>GEO：实质Zset</p></li><li><p>Stream：实质Stream</p></li><li><p>BITFIELD：看具体key</p><p><img src="/hexo-docs/images/redisImages/image-20250716170949148.png" alt="image-20250716170949148"></p><p><img src="/hexo-docs/images/redisImages/image-20250716170957043.png" alt="image-20250716170957043"></p><p><img src="/hexo-docs/images/redisImages/image-20250716171058106.png" alt="image-20250716171058106"></p></li></ul></li><li><p>上帝视角</p><p><img src="/hexo-docs/images/redisImages/image-20250716171235555.png" alt="image-20250716171235555"></p></li><li><p>Redis定义了redisObject结构体来表示string、hash、list、set、zset等数据类型</p><ul><li><p>C语言struct结构体语法简介</p><p><img src="/hexo-docs/images/redisImages/image-20250716171632672.png" alt="image-20250716171632672"></p><p><img src="/hexo-docs/images/redisImages/image-20250716171746488.png" alt="image-20250716171746488"></p></li><li><p>Redis中每个对象都是一个redisObject结构</p></li><li><p>字典、KV是什么（重点）</p><ul><li><p>每个键值对都会有一个dictEntry</p></li><li><p>源码位置：dict.h</p></li><li><p>重点：从dictEntry到RedisObject</p><p><img src="/hexo-docs/images/redisImages/image-20250716171937938.png" alt="image-20250716171937938"></p><p><img src="/hexo-docs/images/redisImages/image-20250716171957848.png" alt="image-20250716171957848"></p></li></ul></li><li><p>这些键值对是如何保存进Redis并进行读取操作，O(1)复杂度</p><p><img src="/hexo-docs/images/redisImages/image-20250716172245094.png" alt="image-20250716172245094"></p></li><li><p>redisObject+Redis数据类型+Redis所有编码方式（底层实现）三者之间的关系</p><p><img src="/hexo-docs/images/redisImages/image-20250716172324587.png" alt="image-20250716172324587"></p><p><img src="/hexo-docs/images/redisImages/image-20250716172342336.png" alt="image-20250716172342336"></p></li></ul></li></ul></li></ul><h2 id="5大结构底层C语言源码分析"><a href="#5大结构底层C语言源码分析" class="headerlink" title="5大结构底层C语言源码分析"></a>5大结构底层C语言源码分析</h2><p>重点：redis数据类型与数据结构总纲图</p><ol><li>SDS动态字符串</li><li>双向链表</li><li>压缩列表ziplist</li><li>哈希表hashtable</li><li>跳表skiplist</li><li>整数集合intset</li><li>快速列表quicklist</li><li>紧凑列表listpack</li></ol><p>redis6.0.5</p><p><img src="/hexo-docs/images/redisImages/image-20250717175335798.png" alt="image-20250717175335798"></p><p>redis7</p><p><img src="/hexo-docs/images/redisImages/image-20250717175358840.png" alt="image-20250717175358840"></p><p>源码分析总体数据结构大纲</p><ul><li><p>redisObject操作底层定义来自哪里？</p><p>通常我们了解的数据结构有字符串、双端链表、字典、压缩列表、整数集合等，但是Redis为了加快读写速度，并没有直接使用这些数据结构，而是在此基础上又包装了一层称之为RedisObject。</p><p>RedisObject 有五种对象：字符串对象（String）、列表对象（List）、哈希对象（Hash）、集合对象（Set）和有序集合对象（ZSet）。</p><p><img src="/hexo-docs/images/redisImages/image-20250717175715503.png" alt="image-20250717175715503"></p><p><img src="/hexo-docs/images/redisImages/image-20250717175735825.png" alt="image-20250717175735825"></p></li></ul><p>每个键值对都会有一个dictEntry</p><ul><li><p>set hello word为例，因为Redis是KV键值对的数据库，每个键值对都会有一个dictEntry(源码位置：dict.h)，</p><p>里面指向了key和value的指针，next 指向下一个 dictEntry。</p><p>key 是字符串，但是 Redis 没有直接使用 C 的字符数组，而是存储在redis自定义的 SDS中。</p><p><strong>value 既不是直接作为字符串存储，也不是直接存储在 SDS 中，而是存储在redisObject 中</strong>。</p><p>实际上五种常用的数据类型的任何一种，都是通过 redisObject 来存储的。</p><p><img src="/hexo-docs/images/redisImages/image-20250717175910184.png" alt="image-20250717175910184"></p><p>看看类型<code>type key</code></p><p>​<img src="/hexo-docs/images/redisImages/image-20250717181148922.png" alt="image-20250717181148922"></p><p>看看编码<code>object encoding key</code></p></li></ul><p><img src="/hexo-docs/images/redisImages/image-20250717181253912.png" alt="image-20250717181253912"></p><p>redisObject结构的作用</p><p>为了便于操作，Redis采用redisObjec结构来统一五种不同的数据类型，这样所有的数据类型就都可以以相同的形式在函数间传递而不用使用特定的类型结构。同时，为了识别不同的数据类型，redisObjec中定义了type和encoding字段对不同的数据类型加以区别。简单地说，redisObjec就是string、hash、list、set、zset的父类，可以在函数间传递时隐藏具体的类型信息，所以作者抽象了redisObjec结构来到达同样的目的。</p><p><img src="/hexo-docs/images/redisImages/image-20250717181404448.png" alt="image-20250717181404448"></p><ul><li><p>RedisObject各字段的含义</p><p><img src="/hexo-docs/images/redisImages/image-20250717181445493.png" alt="image-20250717181445493"></p><ol><li>4位的type表示具体的数据类型</li><li>4位的encoding表示该类型的物理编码方式见下表，同一种数据类型可能有不同的编码方式。</li></ol><p>(比如String就提供了3种:int embstr raw)</p><p><img src="/hexo-docs/images/redisImages/image-20250717181509011.png" alt="image-20250717181509011"></p></li></ul><ol start="3"><li><p>lru字段表示当内存超限时采用LRU算法清除内存中的对象。</p></li><li><p>refcount表示对象的引用计数。</p></li><li><p>ptr指针指向真正的底层数据结构的指针。</p></li></ol><p>案例</p><p><code>set age 17</code></p><p><img src="/hexo-docs/images/redisImages/image-20250717181559043.png" alt="image-20250717181559043"></p><table><thead><tr><th align="center">type</th><th align="center">类型</th></tr></thead><tbody><tr><td align="center">encoding</td><td align="center">编码，此处是数字类型</td></tr><tr><td align="center">lru</td><td align="center">最近被访问的时间</td></tr><tr><td align="center">refcount</td><td align="center">等于1，表示当前对象被引用的次数</td></tr><tr><td align="center">ptr</td><td align="center">value值是多少，当前就是17</td></tr></tbody></table><h3 id="经典5大数据结构解析"><a href="#经典5大数据结构解析" class="headerlink" title="经典5大数据结构解析"></a>经典5大数据结构解析</h3><p>各个类型的数据结构的编码映射和定义</p><p><img src="/hexo-docs/images/redisImages/image-20250717181734422.png" alt="image-20250717181734422"></p><p><code>Debug object key</code></p><p>命令</p><p><img src="/hexo-docs/images/redisImages/image-20250717181814642.png" alt="image-20250717181814642"></p><p>开启前</p><p><img src="/hexo-docs/images/redisImages/image-20250717182024992.png" alt="image-20250717182024992"></p><p>开启后</p><p><img src="/hexo-docs/images/redisImages/image-20250717182218853.png" alt="image-20250717182218853"></p><p><img src="/hexo-docs/images/redisImages/image-20250717182429283.png" alt="image-20250717182429283"></p><ul><li>value at: 内存地址</li><li>refcount: 引用次数</li><li>encoding: 物理编码类型</li><li>serializedlength: 序列化后的长度（注意这里的长度是序列化后的长度，保存为rdb文件时使用了该算法，不是真正存贮在内存的大小),会对字串做一些可能的压缩以便底层优化</li><li>lru：记录最近使用时间戳</li><li>lru_seconds_idle（秒）：空闲时间</li></ul><h3 id="String数据结构介绍"><a href="#String数据结构介绍" class="headerlink" title="String数据结构介绍"></a>String数据结构介绍</h3><p>RedisObject内部对应3大物理编码</p><p><img src="/hexo-docs/images/redisImages/image-20250718172440375.png" alt="image-20250718172440375"></p><h4 id="int"><a href="#int" class="headerlink" title="int"></a>int</h4><p>保存long型（长整型）的64位（8个字节）有符号整数</p><p><img src="/hexo-docs/images/redisImages/image-20250718172632631.png" alt="image-20250718172632631"></p><blockquote><p>只有整数才会使用int，如果是浮点数，Redis内部其实先将浮点数转化为字符串值，然后在保存。</p></blockquote><h4 id="embstr"><a href="#embstr" class="headerlink" title="embstr"></a>embstr</h4><p>代表<code>embstr</code>格式的 SDS (Simple Dynamic String 简单动态字符串)，保存长度小于44字节的字符串</p><p>embstr 顾名思义即：embedded string，表示嵌入式的 String</p><h4 id="raw"><a href="#raw" class="headerlink" title="raw"></a>raw</h4><p>保存长度大于44字节的字符串</p><h4 id="案例测试"><a href="#案例测试" class="headerlink" title="案例测试"></a>案例测试</h4><p><img src="/hexo-docs/images/redisImages/image-20250718173724656.png" alt="image-20250718173724656"> </p><h4 id="C语言中字符串的展现"><a href="#C语言中字符串的展现" class="headerlink" title="C语言中字符串的展现"></a>C语言中字符串的展现</h4><p><img src="/hexo-docs/images/redisImages/image-20250718173756472.png" alt="image-20250718173756472"></p><p><img src="/hexo-docs/images/redisImages/image-20250718173811739.png" alt="image-20250718173811739"></p><p><img src="/hexo-docs/images/redisImages/image-20250718173820486.png" alt="image-20250718173820486"></p><p>用空间换取时间</p><h4 id="SDS简单动态字符串"><a href="#SDS简单动态字符串" class="headerlink" title="SDS简单动态字符串"></a>SDS简单动态字符串</h4><p>sds.h源码分析</p><p><img src="/hexo-docs/images/redisImages/image-20250718173923812.png" alt="image-20250718173923812"></p><p>说明</p><p><img src="/hexo-docs/images/redisImages/image-20250718173951302.png" alt="image-20250718173951302"></p><p>Redis中字符串的实现,SDS有多种结构（sds.h）：</p><p>sdshdr5、(2^5&#x3D;32byte)</p><p>sdshdr8、(2 ^ 8&#x3D;256byte)</p><p>sdshdr16、(2 ^ 16&#x3D;65536byte&#x3D;64KB)</p><p>sdshdr32、 (2 ^ 32byte&#x3D;4GB)</p><p>sdshdr64，2的64次方byte＝17179869184G用于存储不同的长度的字符串。</p><p>len 表示 SDS 的长度，使我们在获取字符串长度的时候可以在 O(1)情况下拿到，而不是像 C 那样需要遍历一遍字符串。</p><p>alloc 可以用来计算 free 就是字符串已经分配的未使用的空间，有了这个值就可以引入预分配空间的算法了，而不用去考虑内存分配的问题。</p><p>buf 表示字符串数组，真存数据的。</p><p><img src="/hexo-docs/images/redisImages/image-20250718174421071.png" alt="image-20250718174421071"></p><p>官网：<a href="https://github.com/antirez/sds">https://github.com/antirez/sds</a></p><h4 id="Redis为什么重新设计一个SDS数据结构？"><a href="#Redis为什么重新设计一个SDS数据结构？" class="headerlink" title="Redis为什么重新设计一个SDS数据结构？"></a>Redis为什么重新设计一个SDS数据结构？</h4><p><img src="/hexo-docs/images/redisImages/image-20250718174214155.png" alt="image-20250718174214155"></p><p>C语言没有Java里面的String类型，只能是靠自己的char[]来实现，字符串在 C 语言中的存储方式，想要获取 「Redis」的长度，需要从头开始遍历，直到遇到 ‘\0’ 为止。所以，Redis 没有直接使用 C 语言传统的字符串标识，而是自己构建了一种名为简单动态字符串 SDS（simple dynamic string）的抽象类型，并将 SDS 作为 Redis 的默认字符串。</p><p><img src="/hexo-docs/images/redisImages/image-20250718174234621.png" alt="image-20250718174234621"></p><table><thead><tr><th>C语言</th><th>SDS</th><th></th></tr></thead><tbody><tr><td><strong>字符串长度处理</strong></td><td>需要从头开始遍历，直到遇到 ‘\0’ 为止，时间复杂度O(N)</td><td>记录当前字符串的长度，直接读取即可，时间复杂度 O(1)</td></tr><tr><td><strong>内存重新分配</strong></td><td>分配内存空间超过后，会导致数组下标越级或者内存分配溢出</td><td>空间预分配SDS 修改后，len 长度小于 1M，那么将会额外分配与 len 相同长度的未使用空间。如果修改后长度大于 1M，那么将分配1M的使用空间。惰性空间释放有空间分配对应的就有空间释放。SDS 缩短时并不会回收多余的内存空间，而是使用 free 字段将多出来的空间记录下来。如果后续有变更操作，直接使用 free 中记录的空间，减少了内存的分配。</td></tr><tr><td><strong>二进制安全</strong></td><td>二进制数据并不是规则的字符串格式，可能会包含一些特殊的字符，比如 ‘\0’ 等。前面提到过，C中字符串遇到 ‘\0’ 会结束，那 ‘\0’ 之后的数据就读取不上了</td><td>根据 len 长度来判断字符串结束的，二进制安全的问题就解决了</td></tr></tbody></table><h4 id="3-大物理编码方式"><a href="#3-大物理编码方式" class="headerlink" title="3 大物理编码方式"></a>3 大物理编码方式</h4><p><img src="/hexo-docs/images/redisImages/image-20250718180957953.png" alt="image-20250718180957953"></p><h5 id="int-编码格式"><a href="#int-编码格式" class="headerlink" title="int 编码格式"></a>int 编码格式</h5><p><img src="/hexo-docs/images/redisImages/image-20250718181512946.png" alt="image-20250718181512946"></p><p>命令示例： set k2 123</p><p>当字符串键值的内容可以用一个64位有符号整形来表示时，Redis会将键值转化为long型来进行存储，此时即对应 OBJ_ENCODING_INT 编码类型。内部的内存结构表示如下:</p><p><img src="/hexo-docs/images/redisImages/image-20250718181206307.png" alt="image-20250718181206307"></p><p>Redis 启动时会预先建立 10000 个分别存储 0<del>9999 的 redisObject 变量作为共享对象，这就意味着如果 set字符串的键值在 0</del>10000 之间的话，则可以 <strong>直接指向共享对象 而不需要再建立新对象，此时键值不占空间！</strong></p><p>set k1 123</p><p>set k2 123</p><p><img src="/hexo-docs/images/redisImages/image-20250718181233064.png" alt="image-20250718181233064"></p><p>redis源码：server.h，笔记下面有</p><p><img src="/hexo-docs/images/redisImages/image-20250718181534080.png" alt="image-20250718181534080"></p><p>redis6源代码：object.c笔记下面还有</p><p><img src="/hexo-docs/images/redisImages/image-20250718181635588.png" alt="image-20250718181635588"></p><p>redis7源代码：object.c笔记下面还有</p><p><img src="/hexo-docs/images/redisImages/image-20250718181709091.png" alt="image-20250718181709091"></p><p><img src="/hexo-docs/images/redisImages/image-20250718181718725.png" alt="image-20250718181718725"></p><blockquote><p>如果值一样，且是int类型的编码格式，就直接引用之前的，不会再去开辟新的空间！前提是值不能超过10000，0~9999才可以！</p></blockquote><h5 id="embstr-编码格式"><a href="#embstr-编码格式" class="headerlink" title="embstr 编码格式"></a>embstr 编码格式</h5><p><img src="/hexo-docs/images/redisImages/image-20250718181937055.png" alt="image-20250718181937055"></p><p>redis源代码：object.c</p><p><img src="/hexo-docs/images/redisImages/image-20250718182001674.png" alt="image-20250718182001674"></p><p>对于长度小于 44的字符串，Redis 对键值采用OBJ_ENCODING_EMBSTR 方式，EMBSTR 顾名思义即：embedded string，表示嵌入式的String。从内存结构上来讲 即字符串 sds结构体与其对应的 redisObject 对象分配在同一块连续的内存空间，字符串sds嵌入在redisObject对象之中一样。</p><p><img src="/hexo-docs/images/redisImages/image-20250718182025751.png" alt="image-20250718182025751"></p><p><img src="/hexo-docs/images/redisImages/image-20250718182036492.png" alt="image-20250718182036492"></p><p>进一步createEmbddedStringObject方法</p><p><img src="/hexo-docs/images/redisImages/image-20250718182445621.png" alt="image-20250718182445621"></p><blockquote><p>没有申请新的redisObject对象，只是在之前redisObject对象下加了一个1，内存紧凑。实现了内存的高度连续！减少碎片，不占空间</p></blockquote><h5 id="raw编码格式"><a href="#raw编码格式" class="headerlink" title="raw编码格式"></a>raw编码格式</h5><p><img src="/hexo-docs/images/redisImages/image-20250718182644113.png" alt="image-20250718182644113"></p><p>set k3 大于44长度的一个字符串，随便写</p><p><img src="/hexo-docs/images/redisImages/image-20250718182732390.png" alt="image-20250718182732390"></p><p>当字符串的键值为长度大于44的超长字符串时，Redis 则会将键值的内部编码方式改为OBJ_ENCODING_RAW格式，这与OBJ_ENCODING_EMBSTR编码方式的不同之处在于，此时动态字符串sds的内存与其依赖的redisObject的内存不再连续了</p><p><img src="/hexo-docs/images/redisImages/image-20250718182753983.png" alt="image-20250718182753983"></p><h5 id="明明没有超过阈值，为什么变成-raw-了"><a href="#明明没有超过阈值，为什么变成-raw-了" class="headerlink" title="明明没有超过阈值，为什么变成 raw 了"></a>明明没有超过阈值，为什么变成 raw 了</h5><p><img src="/hexo-docs/images/redisImages/image-20250718182842208.png" alt="image-20250718182842208"></p><p>如果先添加一个字符，在拼接一个字符，直接去最大“raw”</p><p>判断不出来，就取最大Raw</p><h5 id="转变逻辑图"><a href="#转变逻辑图" class="headerlink" title="转变逻辑图"></a>转变逻辑图</h5><p><img src="/hexo-docs/images/redisImages/image-20250718183008200.png" alt="image-20250718183008200"></p><h5 id="案例结论"><a href="#案例结论" class="headerlink" title="案例结论"></a>案例结论</h5><p>只有整数才会使用 int，如果是浮点数， Redis 内部其实先将浮点数转化为字符串值，然后再保存。</p><p>embstr 与 raw 类型底层的数据结构其实都是 SDS (简单动态字符串，Redis 内部定义 sdshdr 一种结构)。</p><p>那这两者的区别见下图：</p><table><thead><tr><th align="left">1 int</th><th align="left">Long类型整数时，RedisObject中的ptr指针直接赋值为整数数据，不再额外的指针再指向整数了，节省了指针的空间开销。</th></tr></thead><tbody><tr><td align="left">2 embstr</td><td align="left">当保存的是字符串数据且字符串小于等于44字节时，embstr类型将会调用内存分配函数，只分配一块连续的内存空间，空间中依次包含 redisObject 与 sdshdr 两个数据结构，让元数据、指针和SDS是一块连续的内存区域，这样就可以避免内存碎片</td></tr><tr><td align="left">3 raw</td><td align="left">当字符串大于44字节时，SDS的数据量变多变大了，SDS和RedisObject布局分家各自过，会给SDS分配多的空间并用指针指向SDS结构，raw 类型将会调用两次内存分配函数，分配两块内存空间，一块用于包含 redisObject结构，而另一块用于包含 sdshdr 结构</td></tr></tbody></table><p><img src="/hexo-docs/images/redisImages/image-20250718183057653.png" alt="image-20250718183057653"></p><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>redis 内部会根据用户给的不同键值而使用不同的编码格式，自适应地选择较优化的内部编码格式，而这一切对用户完全透明！</p><h3 id="Hash数据结果介绍"><a href="#Hash数据结果介绍" class="headerlink" title="Hash数据结果介绍"></a>Hash数据结果介绍</h3><h4 id="hash的两种编码格式"><a href="#hash的两种编码格式" class="headerlink" title="hash的两种编码格式"></a>hash的两种编码格式</h4><p>redis6</p><ul><li>ziplist</li><li>hashtable</li></ul><p>redis7</p><ul><li>listpack</li><li>hashtable</li></ul><h4 id="redis6（案例）"><a href="#redis6（案例）" class="headerlink" title="redis6（案例）"></a>redis6（案例）</h4><h5 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h5><p><strong>hash-max-ziplist-entries：使用压缩列表保存时哈希集合中的最大元素个数。</strong></p><p><strong>hash-max-ziplist-value：使用压缩列表保存时哈希集合中单个元素的最大长度。</strong></p><p>Hash类型键的字段个数 小于 hash-max-ziplist-entries 并且每个字段名和字段值的长度 小于 hash-max-ziplist-value 时，</p><p>Redis才会使用 OBJ_ENCODING_ZIPLIST来存储该键，前述条件任意一个不满足则会转换为 OBJ_ENCODING_HT（hashtable）的编码方式</p><p><img src="/hexo-docs/images/redisImages/image-20250719170734724.png" alt="image-20250719170734724"></p><p><img src="/hexo-docs/images/redisImages/image-20250719170758547.png" alt="image-20250719170758547">;</p><h5 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h5><p>hash-max-ziplist-entries：使用压缩列表保存时哈希集合中的最大元素个数</p><p>hash-max-ziplist-value：使用压缩列表保存时哈希集合中单个元素的最大长度。</p><h5 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h5><ol><li>哈希对象保存的键值对数量小于512个</li><li>所有的键值对和值的字符串长度都小于等于64byte（一个英文字母一个字节）时用ziplist，反之用hashtable</li></ol><p>ziplist升级到hashtable可以，反过来降级不可以</p><ul><li>一旦从压缩列表转为了哈希表，Hash类型就会一直用哈希表进行保存而不会再转回压缩列表了。</li><li>在节省内存空间方面哈希表就没有压缩列表高效了。</li></ul><h5 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h5><p><img src="/hexo-docs/images/redisImages/image-20250719171909980.png" alt="image-20250719171909980"></p><h5 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h5><p>t_hash.c</p><ul><li><p>在 redis 中，hashtable 被称为字典（dictionary），它是一个数组+链表的结构</p></li><li><p>OBJ_ENCODING_HT（hashtable）编码分析</p><ul><li><p>OBJ_ENCODING_HT 这种编码方式内部才是真正的哈希表结构，或称为字典结构，其可以实现O(1)复杂度的读写操作，因此效率很高。</p><p>在 Redis内部，从 OBJ_ENCODING_HT类型到底层真正的散列表数据结构是一层层嵌套下去的，组织关系见面图：</p><p><img src="/hexo-docs/images/redisImages/image-20250719172057855.png" alt="image-20250719172057855"></p><p><img src="/hexo-docs/images/redisImages/image-20250719172106542.png" alt="image-20250719172106542"></p><p>源代码：dict.h</p><p><img src="/hexo-docs/images/redisImages/image-20250719172131076.png" alt="image-20250719172131076"></p><p><img src="/hexo-docs/images/redisImages/image-20250719172152713.png" alt="image-20250719172152713"></p><p><img src="/hexo-docs/images/redisImages/image-20250719172207049.png" alt="image-20250719172207049"></p><ul><li>每个键值对都会有一个dictEntry</li></ul></li></ul></li><li><p>hset 命令解读</p><p><img src="/hexo-docs/images/redisImages/image-20250719172335753.png" alt="image-20250719172335753"></p><ul><li><p>类型</p><p><img src="/hexo-docs/images/redisImages/image-20250719172409193.png" alt="image-20250719172409193"></p></li></ul></li></ul><p>ziplist.c</p><ul><li><p>ziplist，什么样？</p><p>源代码：ziplist.c</p><p>为了节约内存而开发的，它是由连续内存块组成的顺序型数据结构，有点类似于数组</p><p>ziplist是一个经过特殊编码的双向链表，它不存储指向前一个链表节点prev和指向下一个链表节点的指针next而是存储上一个节点长度和当前节点长度，通过牺牲部分读写性能，来换取高效的内存空间利用率，节约内存，是一种时间换空间的思想。只用在字段个数少，字段值小的场景里面</p><p><img src="/hexo-docs/images/redisImages/image-20250719172514866.png" alt="image-20250719172514866"></p><p><img src="/hexo-docs/images/redisImages/image-20250719172539546.png" alt="image-20250719172539546"></p><p><img src="/hexo-docs/images/redisImages/image-20250719172556712.png" alt="image-20250719172556712"></p><ul><li><p>ziplist 各个组成单元什么意思</p><p><img src="/hexo-docs/images/redisImages/image-20250719172628534.png" alt="image-20250719172628534"></p></li></ul></li><li><p>zlentry，压缩列表节点的构成</p><ul><li><p>官网源码</p><p><img src="/hexo-docs/images/redisImages/image-20250719230633635.png" alt="image-20250719230633635"></p></li><li><p>zlentry 实体结构解析</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 再内存中并没有存下下面结构体zlentry的内容，只是为了方便，在代码中定义了这样的结构体，包含了一些其他信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zlentry</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> prevrawlensize, prevrawlen;            <span class="comment">//用来计算前面节点的地址</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> lensize, len;                          <span class="comment">//本节点的长度</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> headersize;                            <span class="comment">//头部大小</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> encoding;                             <span class="comment">//编码</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *p;</span><br><span class="line">&#125; zlentry;</span><br></pre></td></tr></table></figure></li><li><p>ziplist 存取情况</p><p><img src="/hexo-docs/images/redisImages/image-20250719230929887.png" alt="image-20250719230929887"></p><p><img src="/hexo-docs/images/redisImages/image-20250719230939536.png" alt="image-20250719230939536"></p><table><thead><tr><th align="center">prevlen</th><th align="center">记录了前一个节点的长度；</th></tr></thead><tbody><tr><td align="center">encoding</td><td align="center">记录了当前节点实际数据的类型以及长度</td></tr><tr><td align="center">data</td><td align="center">记录了当前节点的实际数据</td></tr></tbody></table><ul><li><p>zlentry 解析</p><p>压缩列表zlentry节点结构：每个zlentry由前一个节点的长度、encoding和entry-data三部分组成</p><p><img src="/hexo-docs/images/redisImages/image-20250719231031510.png" alt="image-20250719231031510"></p><p>前节点：(前节点占用的内存字节数)表示前1个zlentry的长度，privious_entry_length有两种取值情况：1字节或5字节。取值1字节时，表示上一个entry的长度小于254字节。虽然1字节的值能表示的数值范围是0到255，但是压缩列表中zlend的取值默认是255，因此，就默认用255表示整个压缩列表的结束，其他表示长度的地方就不能再用255这个值了。所以，当上一个entry长度小于254字节时，prev_len取值为1字节，否则，就取值为5字节。记录长度的好处：占用内存小，1或者5个字节</p><p>enncoding：记录节点的content保存数据的类型和长度。</p><p>content：保存实际数据内容</p><p><img src="/hexo-docs/images/redisImages/image-20250719231058329.png" alt="image-20250719231058329"></p></li><li><p>为什么 zlentry 这么设计？数组和链表数据结构对比</p><p>privious_entry_length，encoding长度都可以根据编码方式推算，真正变化的是content，而content长度记录在encoding里 ，因此entry的长度就知道了。entry总长度 &#x3D; privious_entry_length字节数+encoding字节数+content字节数</p><p><img src="/hexo-docs/images/redisImages/image-20250719231153304.png" alt="image-20250719231153304"></p><p>为什么entry这么设计？记录前一个节点的长度？</p><p>链表在内存中，一般是不连续的，遍历相对比较慢，而ziplist可以很好的解决这个问题。如果知道了当前的起始地址，因为entry是连续的，entry后一定是另一个entry，想知道下一个entry的地址，只要将当前的起始地址加上当前entry总长度。如果还想遍历下一个entry，只要继续同样的操作。</p></li></ul></li><li><p><strong>明明有链表了，为什么出来一个压缩链表？</strong></p><ol><li><p>普通的双向链表会有两个指针，在存储数据很小的情况下，我们存储的实际数据的大小可能还没有指针占用的内存大，得不偿失。ziplist 是一个特殊的双向链表没有维护双向指针:previous next；而是存储上一个 entry的长度和当前entry的长度，通过长度推算下一个元素在什么地方。牺牲读取的性能，获得高效的存储空间，因为(简短字符串的情况)存储指针比存储entry长度更费内存。这是典型的“时间换空间”。</p></li><li><p>链表在内存中一般是不连续的，遍历相对比较慢而ziplist可以很好的解决这个问题，普通数组的遍历是根据数组里存储的数据类型找到下一个元素的(例如int类型的数组访问下一个元素时每次只需要移动一个sizeof(int)就行)，但是ziplist的每个节点的长度是可以不一样的，而我们面对不同长度的节点又不可能直接sizeof(entry)，所以ziplist只好将一些必要的偏移量信息记录在了每一个节点里，使之能跳到上一个节点或下一个节点。</p><p>备注:sizeof实际上是获取了数据在内存中所占用的存储空间，以字节为单位来计数。</p></li><li><p>头节点里有头节点里同时还有一个参数 len，和string类型提到的 SDS 类似，这里是用来记录链表长度的。因此获取链表长度时不用再遍历整个链表，直接拿到len值就可以了，这个时间复杂度是 O(1)</p></li></ol></li><li><p>ziplist 总结</p><p>ziplist为了节省内存，采用了紧凑的连续存储。</p><p>ziplist是一个双向链表，可以在时间复杂度为 O(1) 下从头部、尾部进行 pop 或 push。</p><p>新增或更新元素可能会出现连锁更新现象(致命缺点导致被listpack替换)。</p><p>不能保存过多的元素，否则查询效率就会降低，数量小和内容小的情况下可以使用。</p></li></ul></li></ul><h4 id="redis7（案例）"><a href="#redis7（案例）" class="headerlink" title="redis7（案例）"></a>redis7（案例）</h4><h5 id="案例-1"><a href="#案例-1" class="headerlink" title="案例"></a>案例</h5><p><strong>hash-max-listpack-entries：使用压缩列表保存时哈希集合中的最大元素个数。</strong></p><p><strong>hash-max-listpack-value：使用压缩列表保存时哈希集合中单个元素的最大长度。</strong></p><p>Hash类型键的字段个数 小于 hash-max-listpack-entries且每个字段名和字段值的长度 小于 hash-max-listpack-value 时，</p><p>Redis才会使用OBJ_ENCODING_LISTPACK来存储该键，前述条件任意一个不满足则会转换为 OBJ_ENCODING_HT（hashtable）的编码方式 </p><p><img src="/hexo-docs/images/redisImages/image-20250720164040253.png" alt="image-20250720164040253"></p><p><img src="/hexo-docs/images/redisImages/image-20250720164419983.png" alt="image-20250720164419983"></p><p><img src="/hexo-docs/images/redisImages/image-20250720164515154.png" alt="image-20250720164515154"></p><p><img src="/hexo-docs/images/redisImages/image-20250720165008568.png" alt="image-20250720165008568"></p><p><img src="/hexo-docs/images/redisImages/image-20250720165109650.png" alt="image-20250720165109650"></p><h5 id="结构-1"><a href="#结构-1" class="headerlink" title="结构"></a>结构</h5><p>hash-max-listpack-entries：使用紧凑列表保存时哈希集合中的最大元素个数</p><p>hash-max-listpack-value：使用紧凑列表保存时哈希集合中单个元素的最大长度</p><h5 id="结论-1"><a href="#结论-1" class="headerlink" title="结论"></a>结论</h5><ol><li>哈希对象保存的键值对数量小于512个</li><li>所有的键值对的键和值的字符串长度都小于等于64byte（一个英文字母一个字节）时用listpack，反之用hashtable</li></ol><p>listpack升级到hashtable可以，反过来降级不可以</p><h5 id="流程（同redis6，只不过ziplist改为listpack）"><a href="#流程（同redis6，只不过ziplist改为listpack）" class="headerlink" title="流程（同redis6，只不过ziplist改为listpack）"></a>流程（同redis6，只不过ziplist改为listpack）</h5><p><img src="/hexo-docs/images/redisImages/image-20250720165549111.png" alt="image-20250720165549111"></p><h5 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h5><p>源码说明</p><ul><li><p>实现：object.c</p><p><img src="/hexo-docs/images/redisImages/image-20250720165652847.png" alt="image-20250720165652847"></p></li><li><p>实现：listpack.c</p><p><img src="/hexo-docs/images/redisImages/image-20250720165725665.png" alt="image-20250720165725665"></p><p>lpNew 函数创建了一个空的 listpack，一开始分配的大小是 LP_HDR_SIZE 再加 1 个字节。LP_HDR_SIZE 宏定义是在 listpack.c 中，它默认是 6 个字节，其中 4 个字节是记录 listpack 的总字节数，2 个字节是记录 listpack 的元素数量。此外，listpack 的最后一个字节是用来标识 listpack 的结束，其默认值是宏定义 LP_EOF。和 ziplist 列表项的结束标记一样，LP_EOF 的值也是 255</p></li><li><p>实现2：object.c</p><p><img src="/hexo-docs/images/redisImages/image-20250720165803047.png" alt="image-20250720165803047"></p></li></ul><p><strong>明明有了ziplist了，为什么出来一个listpack紧凑列表？</strong></p><p><img src="/hexo-docs/images/redisImages/image-20250720165842959.png" alt="image-20250720165842959"></p><p>压缩列表里的每个节点中的 prelen 属性都记录了【前一个节点的长度】，而且 prelen 属性的空间大小跟前一个节点长度值有关，比如：</p><ul><li>如果<strong>前一个节点的长度小于 254 字节</strong>，那么 prelen 属性需要用 <strong>1字节的空间</strong>来保存这个长度值</li><li>如果<strong>前一个节点的长度大于等于 254 字节</strong>，那么 prelen 属性需要用 <strong>5字节的空间</strong>来保存这个长度值</li></ul><p>ziplist的连锁更新问题</p><p>​压缩列表新增某个元素或修改某个元素时，如果空间不不够，压缩列表占用的内存空间就需要重新分配。而当新插入的元素较大时，可能会导致后续元素的 prevlen 占用空间都发生变化，从而引起「连锁更新」问题，导致每个元素的空间都要重新分配，造成访问压缩列表性能的下降。</p><p>案例说明：<strong>压缩列表每个节点正因为需要保存前一个节点的长度字段，就会有连锁更新的隐患</strong></p><p>第一步：现在假设一个压缩列表中有多个连续的、长度在 250～253 之间的节点，如下图：</p><p><img src="/hexo-docs/images/redisImages/image-20250720170312513.png" alt="image-20250720170312513"></p><p>因为这些节点长度值小于 254 字节，所以 prevlen 属性需要用 1 字节的空间来保存这个长度值，一切OK，O(∩_∩)O哈哈~</p><p>第二步：这时，如果将一个长度大于等于 254 字节的新节点加入到压缩列表的表头节点，即新节点将成为entry1的前置节点，如下图：</p><p><img src="/hexo-docs/images/redisImages/image-20250720170340969.png" alt="image-20250720170340969"></p><p>因为entry1节点的prevlen属性只有1个字节大小，无法保存新节点的长度，此时就需要对压缩列表的空间重分配操作并将entry1节点的prevlen 属性从原来的 1 字节大小扩展为 5 字节大小。</p><p>第三步：连续更新问题出现</p><p><img src="/hexo-docs/images/redisImages/image-20250720170407334.png" alt="image-20250720170407334"></p><p>entry1节点原本的长度在250～253之间，因为刚才的扩展空间，此时entry1节点的长度就大于等于254，因此原本entry2节点保存entry1节点的 prevlen属性也必须从1字节扩展至5字节大小。entry1节点影响entry2节点，entry2节点影响entry3节点……一直持续到结尾。这种在特殊情况下产生的连续多次空间扩展操作就叫做「连锁更新」</p><p>结论</p><p>listpack 是 Redis 设计用来取代掉 ziplist 的数据结构，它通过每个节点记录自己的长度且放在节点的尾部，来彻底解决掉了 ziplist 存在的连锁更新的问题</p><p>listpack结构</p><p><img src="/hexo-docs/images/redisImages/image-20250720171528498.png" alt="image-20250720171528498"></p><ul><li><p>官网：<a href="https://github.com/antirez/listpack/blob/master/listpack.md">https://github.com/antirez/listpack/blob/master/listpack.md</a></p></li><li><p>listpack由4部分组成：total Bytes、Num Elem、Entry以及End</p><p><img src="/hexo-docs/images/redisImages/image-20250720170710779.png" alt="image-20250720170710779"></p><table><thead><tr><th>Total Bytes</th><th>为整个listpack的空间大小，占用4个字节，每个listpack最多占用4294967295Bytes。</th></tr></thead><tbody><tr><td>num-elements</td><td>为listpack中的元素个数，即Entry的个数占用2个字节</td></tr><tr><td>element-1~element-N</td><td>为每个具体的元素</td></tr><tr><td>listpack-end-byte</td><td>为listpack结束标志，占用1个字节，内容为0xFF。</td></tr></tbody></table><p><img src="/hexo-docs/images/redisImages/image-20250720170735027.png" alt="image-20250720170735027"></p></li><li><p>entry 结构</p><ul><li><p>当前元素的编码类型（entry-encoding）</p></li><li><p>元素数据（entry-data）</p></li><li><p>以及编码类型和元素数据这两部分的长度（entry-len）</p></li><li><p>listpackEntry结构定义：listpack.h</p><p><img src="/hexo-docs/images/redisImages/image-20250720170855675.png" alt="image-20250720170855675"></p></li></ul></li></ul><p>ziplist 内存布局 VS listpack 内存布局</p><p><img src="/hexo-docs/images/redisImages/image-20250720170930879.png" alt="image-20250720170930879"></p><p>和ziplist 列表项类似，listpack 列表项也包含了元数据信息和数据本身。不过，为了避免ziplist引起的连锁更新问题，listpack 中的每个列表项</p><p>不再像ziplist列表项那样保存其前一个列表项的长度。</p><p><img src="/hexo-docs/images/redisImages/image-20250720170952949.png" alt="image-20250720170952949"></p><h5 id="hash-的两种编码格式"><a href="#hash-的两种编码格式" class="headerlink" title="hash 的两种编码格式"></a>hash 的两种编码格式</h5><ul><li>redis 6<ul><li>ziplist</li><li>hashtable</li></ul></li><li>redis 7<ul><li>listpack</li><li>hashtable</li></ul></li></ul><h3 id="List-数据结构介绍"><a href="#List-数据结构介绍" class="headerlink" title="List 数据结构介绍"></a>List 数据结构介绍</h3><h4 id="redis-6（案例）"><a href="#redis-6（案例）" class="headerlink" title="redis 6（案例）"></a>redis 6（案例）</h4><p><img src="/hexo-docs/images/redisImages/image-20250720171137367.png" alt="image-20250720171137367"></p><ol><li><p>ziplist压缩配置：list-compress-depth 0</p><p>表示一个quicklist两端不被压缩的节点个数。这里的节点是指quicklist双向链表的节点，而不是指ziplist里面的数据项个数</p><p>参数list-compress-depth的取值含义如下：</p><p>​0: 是个特殊值，表示都不压缩。这是Redis的默认值。</p><p>​1: 表示quicklist两端各有1个节点不压缩，中间的节点压缩。</p><p>​2: 表示quicklist两端各有2个节点不压缩，中间的节点压缩。</p><p>​3: 表示quicklist两端各有3个节点不压缩，中间的节点压缩。</p></li></ol><p>依此类推…</p><ol start="2"><li>ziplist中entry配置：list-max-ziplist-size -2</li></ol><p>​当取正值的时候，表示按照数据项个数来限定每个quicklist节点上的ziplist长度。比如，当这个参数配置成5的时候，表示每个quicklist节点的ziplist最多包含5个数据项。当取负值的时候，表示按照占用字节数来限定每个quicklist节点上的ziplist长度。这时，它只能取-1到-5这五个值，</p><p>每个值含义如下：</p><p>-5: 每个quicklist节点上的ziplist大小不能超过64 Kb。（注：1kb &#x3D;&gt; 1024 bytes）</p><p>-4: 每个quicklist节点上的ziplist大小不能超过32 Kb。</p><p>-3: 每个quicklist节点上的ziplist大小不能超过16 Kb。</p><p>-2: 每个quicklist节点上的ziplist大小不能超过8 Kb。（-2是Redis给出的默认值）</p><p>-1: 每个quicklist节点上的ziplist大小不能超过4 Kb。</p><h5 id="redis-6版本前的List的一种编码格式"><a href="#redis-6版本前的List的一种编码格式" class="headerlink" title="redis 6版本前的List的一种编码格式"></a>redis 6版本前的List的一种编码格式</h5><p>list用quicklist来存储，quicklist存储了一个双向链表，每个节点都是ziplist</p><p><img src="/hexo-docs/images/redisImages/image-20250720171355626.png" alt="image-20250720171355626"></p><p>在Redis3.0之前，list采用的底层数据结构是ziplist压缩列表+linkedList双向链表</p><p>然后在高版本的Redis中底层数据结构是quicklist(替换了ziplist+linkedList)，而quicklist也用到了ziplist</p><p>结论：quicklist就是「双向链表 + 压缩列表」组合，因为一个 quicklist 就是一个链表，而链表中的每个元素又是一个压缩列表</p><p><img src="/hexo-docs/images/redisImages/image-20250720171412731.png" alt="image-20250720171412731"></p><h5 id="quicklist总纲"><a href="#quicklist总纲" class="headerlink" title="quicklist总纲"></a>quicklist总纲</h5><p>quicklist 实际上是 zipList 和 linkedList 的混合体，它将 linkedList按段切分，每一段使用 zipList 来紧凑存储，多个 zipList 之间使用双向指针串接起来。</p><p><img src="/hexo-docs/images/redisImages/image-20250720171646305.png" alt="image-20250720171646305"></p><p>是 ziplist 和 linkedlist 的结合体</p><h5 id="源码分析-2"><a href="#源码分析-2" class="headerlink" title="源码分析"></a>源码分析</h5><ul><li><p>quicklist.h，head和tail指向双向列表的表头和表尾</p><ul><li><p>quicklist 结构</p><p><img src="/hexo-docs/images/redisImages/image-20250720171806258.png" alt="image-20250720171806258"></p><p><img src="/hexo-docs/images/redisImages/image-20250720171814235.png" alt="image-20250720171814235"></p></li><li><p>quicklistNode 结构</p><p><img src="/hexo-docs/images/redisImages/image-20250720171846382.png" alt="image-20250720171846382"></p><p><img src="/hexo-docs/images/redisImages/image-20250720171856481.png" alt="image-20250720171856481"></p></li><li><p>quicklistNode 中的 *zl 指向一个 ziplist 一个ziplist 可以存放多个元素</p><p><img src="/hexo-docs/images/redisImages/image-20250720171944856.png" alt="image-20250720171944856"></p></li></ul></li></ul><h4 id="redis-7（案例）"><a href="#redis-7（案例）" class="headerlink" title="redis 7（案例）"></a>redis 7（案例）</h4><p><img src="/hexo-docs/images/redisImages/image-20250720172224873.png" alt="image-20250720172224873"></p><p>listpack紧凑列表</p><p>是用来替代 ziplist 的新数据结构，在 7.0 版本已经没有 ziplist 的配置了（6.0版本仅部分数据类型作为过渡阶段在使用）</p><h5 id="源码说明"><a href="#源码说明" class="headerlink" title="源码说明"></a>源码说明</h5><p>实现：t_list.c</p><ul><li><p>本图最下方有lpush命令执行后直接调用pushGenericCommand命令</p><p><img src="/hexo-docs/images/redisImages/image-20250720172316427.png" alt="image-20250720172316427"></p><ul><li><p>看看 redis 6 的相同文件 t_list.c</p><p><img src="/hexo-docs/images/redisImages/image-20250720172457864.png" alt="image-20250720172457864"></p></li></ul></li><li><p>实现：object.c</p><p><img src="/hexo-docs/images/redisImages/image-20250720172522705.png" alt="image-20250720172522705"></p></li><li><p>redis 7的 list 的一种编码格式</p><ul><li><p>list 用 quicklist 来存储，quicklist 存储了一个双向链表，每个节点都是一个listpack</p></li><li><p>quicklist</p><p>是 listpack 和 linkedlist 的结合体</p></li></ul></li></ul><h3 id="Set-数据结构介绍"><a href="#Set-数据结构介绍" class="headerlink" title="Set 数据结构介绍"></a>Set 数据结构介绍</h3><h4 id="案例-2"><a href="#案例-2" class="headerlink" title="案例"></a>案例</h4><p>Redis用intset或hashtable存储set。如果元素都是整数类型，就用intset存储。</p><p>如果不是整数类型，就用hashtable（数组+链表的存来储结构）。key就是元素的值，value为null。</p><p><img src="/hexo-docs/images/redisImages/image-20250720172727901.png" alt="image-20250720172727901"></p><p>set-proc-title 修改进程标题以显示一些运行时信息</p><h4 id="Set-的两种编码方式"><a href="#Set-的两种编码方式" class="headerlink" title="Set 的两种编码方式"></a>Set 的两种编码方式</h4><ol><li>inset</li><li>hashtable</li></ol><h4 id="源码分析-3"><a href="#源码分析-3" class="headerlink" title="源码分析"></a>源码分析</h4><p>t_set.c</p><p><img src="/hexo-docs/images/redisImages/image-20250720172835076.png" alt="image-20250720172835076"></p><p><img src="/hexo-docs/images/redisImages/image-20250720172852165.png" alt="image-20250720172852165"></p><h3 id="ZSet-数据结构介绍"><a href="#ZSet-数据结构介绍" class="headerlink" title="ZSet 数据结构介绍"></a>ZSet 数据结构介绍</h3><h4 id="案例-3"><a href="#案例-3" class="headerlink" title="案例"></a>案例</h4><h5 id="redis-6"><a href="#redis-6" class="headerlink" title="redis 6"></a>redis 6</h5><p>当有序集合中包含的元素数量超过服务器属性 server.zset_max_ziplist_entries 的值（默认值为 128 ），</p><p>或者有序集合中新添加元素的 member 的长度大于服务器属性 server.zset_max_ziplist_value 的值（默认值为 64 ）时，</p><p>redis会使用跳跃表作为有序集合的底层实现。</p><p>否则会使用ziplist作为有序集合的底层实现</p><p><img src="/hexo-docs/images/redisImages/image-20250720172941555.png" alt="image-20250720172941555"></p><p><img src="/hexo-docs/images/redisImages/image-20250720172954650.png" alt="image-20250720172954650"></p><h5 id="redis-7"><a href="#redis-7" class="headerlink" title="redis 7"></a>redis 7</h5><p><img src="/hexo-docs/images/redisImages/image-20250720173025379.png" alt="image-20250720173025379"></p><p><img src="/hexo-docs/images/redisImages/image-20250720173035219.png" alt="image-20250720173035219"></p><h4 id="ZSet-的两种编码格式"><a href="#ZSet-的两种编码格式" class="headerlink" title="ZSet 的两种编码格式"></a>ZSet 的两种编码格式</h4><ul><li>redis 6<ul><li>ziplist</li><li>skiplist</li></ul></li><li>redis 7<ul><li>listpack</li><li>skiplist</li></ul></li></ul><h4 id="redis-6-源码分析"><a href="#redis-6-源码分析" class="headerlink" title="redis 6 源码分析"></a>redis 6 源码分析</h4><p>t_zset.c</p><p><img src="/hexo-docs/images/redisImages/image-20250720173208670.png" alt="image-20250720173208670"></p><p><img src="/hexo-docs/images/redisImages/image-20250720173227370.png" alt="image-20250720173227370"></p><h4 id="redis-7-源码分析"><a href="#redis-7-源码分析" class="headerlink" title="redis 7 源码分析"></a>redis 7 源码分析</h4><p>t_zset.c</p><p><img src="/hexo-docs/images/redisImages/image-20250720173301672.png" alt="image-20250720173301672"></p><h3 id="小总结"><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h3><h4 id="redis-6-类型-物理编码-对应表"><a href="#redis-6-类型-物理编码-对应表" class="headerlink" title="redis 6 类型-物理编码-对应表"></a>redis 6 类型-物理编码-对应表</h4><p><img src="/hexo-docs/images/redisImages/image-20250720173412806.png" alt="image-20250720173412806"></p><h4 id="redis-6-数据类型对应的底层数据结构"><a href="#redis-6-数据类型对应的底层数据结构" class="headerlink" title="redis 6 数据类型对应的底层数据结构"></a>redis 6 数据类型对应的底层数据结构</h4><ol><li><p>字符串</p><p>int：8个字节的长整型。</p><p>embstr：小于等于44个字节的字符串。</p><p>raw：大于44个字节的字符串。</p><p>Redis会根据当前值的类型和长度决定使用哪种内部编码实现。</p></li><li><p>哈希</p><p>ziplist(压缩列表)：当哈希类型元素个数小于hash-max-ziplist-entries 配置(默认512个)、同时所有值都小于hash-max-ziplist-value配置(默认64 字节)时，Redis会使用ziplist作为哈希的内部实现，ziplist使用更加紧凑的 结构实现多个元素的连续存储，所以在节省内存方面比hashtable更加优秀。</p><p>hashtable(哈希表)：当哈希类型无法满足ziplist的条件时，Redis会使 用hashtable作为哈希的内部实现，因为此时ziplist的读写效率会下降，而hashtable的读写时间复杂度为O(1)。</p></li><li><p>列表</p><p>ziplist(压缩列表)：当列表的元素个数小于list-max-ziplist-entries配置 (默认512个)，同时列表中每个元素的值都小于list-max-ziplist-value配置时 (默认64字节)，Redis会选用ziplist来作为列表的内部实现来减少内存的使用。</p><p>linkedlist(链表)：当列表类型无法满足ziplist的条件时，Redis会使用 linkedlist作为列表的内部实现。quicklist ziplist和linkedlist的结合以ziplist为节点的链表(linkedlist)</p></li><li><p>集合</p><p>intset(整数集合)：当集合中的元素都是整数且元素个数小于set-max-intset-entries配置(默认512个)时，Redis会用intset来作为集合的内部实现，从而减少内存的使用。hashtable(哈希表)：当集合类型无法满足intset的条件时，Redis会使用hashtable作为集合的内部实现。</p></li><li><p>有序集合</p><p>ziplist(压缩列表)：当有序集合的元素个数小于zset-max-ziplist- entries配置(默认128个)，同时每个元素的值都小于zset-max-ziplist-value配 置(默认64字节)时，Redis会用ziplist来作为有序集合的内部实现，ziplist 可以有效减少内存的使用。</p><p>skiplist(跳跃表):当ziplist条件不满足时，有序集合会使用skiplist作 为内部实现，因为此时ziplist的读写效率会下降。</p></li></ol><h4 id="redis-6-数据类型以及数据结构的关系"><a href="#redis-6-数据类型以及数据结构的关系" class="headerlink" title="redis 6 数据类型以及数据结构的关系"></a>redis 6 数据类型以及数据结构的关系</h4><p><img src="/hexo-docs/images/redisImages/image-20250720173713526.png" alt="image-20250720173713526"></p><h4 id="redis-7数据类型以及数据结构的关系"><a href="#redis-7数据类型以及数据结构的关系" class="headerlink" title="redis 7数据类型以及数据结构的关系"></a>redis 7数据类型以及数据结构的关系</h4><p><img src="/hexo-docs/images/redisImages/image-20250720173754323.png" alt="image-20250720173754323"></p><h4 id="redis-数据类型以及数据结构的时间复杂度"><a href="#redis-数据类型以及数据结构的时间复杂度" class="headerlink" title="redis 数据类型以及数据结构的时间复杂度"></a>redis 数据类型以及数据结构的时间复杂度</h4><p><img src="/hexo-docs/images/redisImages/image-20250720173829537.png" alt="image-20250720173829537"></p><h3 id="skiplist面试题"><a href="#skiplist面试题" class="headerlink" title="skiplist面试题"></a>skiplist面试题</h3><h4 id="为什么引出跳表"><a href="#为什么引出跳表" class="headerlink" title="为什么引出跳表"></a>为什么引出跳表</h4><p>先从一个单链表来讲</p><ul><li><p>对于一个单链表来讲，即便链表中存储的数据是有序的，如果我们要想在其中查找某个数据，也只能从头到尾遍历链表。</p></li><li><p>这样查找效率就会很低，时间复杂度会很高O(N)</p><p><img src="/hexo-docs/images/redisImages/image-20250721162119847.png" alt="image-20250721162119847"></p></li></ul><h4 id="痛点"><a href="#痛点" class="headerlink" title="痛点"></a>痛点</h4><p><img src="/hexo-docs/images/redisImages/image-20250721162155118.png" alt="image-20250721162155118"></p><p> 解决方法：升维，也叫空间换时间。</p><ul><li><p>优化 1</p><p><img src="/hexo-docs/images/redisImages/image-20250721162221385.png" alt="image-20250721162221385"></p><p>这个例子里，我们看出，加来一层索引之后，查找一个结点需要遍历的结点个数减少了，也就是说查找效率提高了。</p></li><li><p>优化 2</p><ul><li><p>画了一个包含 64 个结点的链表，按照前面讲的这种思路，建立了五级索引</p><p><img src="/hexo-docs/images/redisImages/image-20250721162337117.png" alt="image-20250721162337117"></p></li></ul></li></ul><h4 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h4><p>跳表是可以实现二分查找的有序链表</p><p>skiplist是一种以空间换取时间的结构。</p><p>由于链表，无法进行二分查找，因此借鉴数据库索引的思想，提取出链表中关键节点（索引），先在关键节点上查找，再进入下层链表查找，提取多层关键节点，就形成了跳跃表</p><p>但是：由于索引也要占据一定空间的，所以，索引添加的越多，空间占用的越多</p><blockquote><p>总结来讲</p><p>​跳表 &#x3D; 链表 + 多级索引</p></blockquote><h4 id="跳表时间-空间复杂度介绍"><a href="#跳表时间-空间复杂度介绍" class="headerlink" title="跳表时间+空间复杂度介绍"></a>跳表时间+空间复杂度介绍</h4><ul><li><p>跳表的时间复杂度</p><p>跳表查询的时间复杂度分析，如果链表里有N个结点，会有多少级索引呢？</p><p>按照我们前面讲的，两两取首。每两个结点会抽出一个结点作为上一级索引的结点，以此估算：</p><p>第一级索引的结点个数大约就是n&#x2F;2，</p><p>第二级索引的结点个数大约就是n&#x2F;4，</p><p>第三级索引的结点个数大约就是n&#x2F;8，依次类推……</p><p>也就是说，第k级索引的结点个数是第k-1级索引的结点个数的1&#x2F;2，那第k级索引结点的个数就是n&#x2F;(2^k)</p><p><img src="/hexo-docs/images/redisImages/image-20250721162527062.png" alt="image-20250721162527062"></p><p><img src="/hexo-docs/images/redisImages/image-20250721162534143.png" alt="image-20250721162534143"></p><p><img src="/hexo-docs/images/redisImages/image-20250721162543774.png" alt="image-20250721162543774"></p><p><img src="/hexo-docs/images/redisImages/image-20250721162559150.png" alt="image-20250721162559150"></p><p>时间复杂度是 O(logN)</p></li><li><p>跳表的空间复杂度</p><p>跳表查询的空间复杂度分析</p><p>比起单纯的单链表，跳表需要存储多级索引，肯定要消耗更多的存储空间。那到底需要消耗多少额外的存储空间呢？</p><p>我们来分析一下跳表的空间复杂度。</p><p>第一步：首先原始链表长度为n，</p><p>第二步：两两取首，每层索引的结点数：n&#x2F;2, n&#x2F;4, n&#x2F;8 … , 8, 4, 2 每上升一级就减少一半，直到剩下2个结点,以此类推；如果我们把每层索引的结点数写出来，就是一个等比数列。</p><p><img src="/hexo-docs/images/redisImages/image-20250721162654157.png" alt="image-20250721162654157"></p><p>这几级索引的结点总和就是n&#x2F;2+n&#x2F;4+n&#x2F;8…+8+4+2&#x3D;n-2。所以，跳表的空间复杂度是O(n) 。也就是说，如果将包含n个结点的单链表构造成跳表，我们需要额外再用接近n个结点的存储空间。</p></li><li><p>优缺点</p><p><strong>优点：</strong></p><p>跳表是一个最典型的空间换时间解决方案，而且只有在数据量较大的情况下才能体现出来优势。而且应该是读多写少的情况下才能使用，所以它的适用范围应该还是比较有限的</p><p><strong>缺点：</strong> </p><p>维护成本相对要高，</p><p>在单链表中，一旦定位好要插入的位置，插入结点的时间复杂度是很低的，就是O(1) </p><p>但是：</p><p>新增或者删除时需要把所有索引都更新一遍，为了保证原始链表中数据的有序性，我们需要先找</p><p>到要动作的位置，这个查找操作就会比较耗时最后在新增和删除的过程中的更新，时间复杂度也是O(log n)</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 后端 Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Replica(主从复制)</title>
      <link href="/hexo-docs/2025/08/13/redis/replica/"/>
      <url>/hexo-docs/2025/08/13/redis/replica/</url>
      
        <content type="html"><![CDATA[<h2 id="复制（replica）"><a href="#复制（replica）" class="headerlink" title="复制（replica）"></a>复制（replica）</h2><p>就是主从复制，master以写为主，slave以读为主。当master数据变化的时候，自动将新的数据异步同步到其他slave数据库</p><p>优点：</p><ul><li>读写分离</li><li>容灾恢复</li><li>数据备份</li><li>水平扩容支撑高并发</li></ul><p>如何使用</p><ul><li>配从（库）不配主（库）</li><li>权限细节，重要<ul><li>master 如果配置了 requirepass 参数，需要密码登录</li><li>那么 slave 就要配置 masterauth 来设置校验密码，否则的话 master 会拒绝 slave的访问请求<ul><li><img src="/hexo-docs/images/redisImages/image-20250416160335729.png" alt="image-20250416160335729"></li></ul></li></ul></li><li>基本操作命令<ul><li>info replication：可以查看复制节点的主从关系和配置信息</li><li>replicaof 主库IP 主库端口：一般写入进 redis.conf 配置文件内</li><li>slaveof 主库IP 主库端口<ul><li>每次与 master 断开之后，都需要重新连接，除非你配置进 redis.conf 文件</li><li>在运行期间修改 slave 节点的信息，如果该数据库已经是某个主数据库的从数据库，那么会停止和原主数据库的同步关系<strong>转而和新的主数据库同步，重新拜主数据库</strong></li></ul></li><li>slaveof no one：使当前数据库停止与其他数据库的同步，<strong>转成主数据库，自立为王</strong></li></ul></li></ul><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><ul><li>架构说明<ul><li>一个 master 两个 slave</li><li>拷贝多个redis.conf 文件<ul><li>redis6379.conf</li><li>redis6380.conf</li><li>redis6381.conf<ul><li><img src="/hexo-docs/images/redisImages/image-20250416165241212.png" alt="image-20250416165241212"></li><li><img src="/hexo-docs/images/redisImages/image-20250416165307679.png" alt="image-20250416165307679"></li><li><img src="/hexo-docs/images/redisImages/image-20250416165412427.png" alt="image-20250416165412427"></li></ul></li></ul></li><li>修改配置文件<ul><li>以redis6380为例，redis6381跟redis6380一样<ul><li><img src="/hexo-docs/images/redisImages/image-20250416165619557.png" alt="image-20250416165619557"></li><li><img src="/hexo-docs/images/redisImages/image-20250416165720318.png" alt="image-20250416165720318"></li><li><img src="/hexo-docs/images/redisImages/image-20250416165819294.png" alt="image-20250416165819294"></li><li><img src="/hexo-docs/images/redisImages/image-20250416165901873.png" alt="image-20250416165901873"></li><li><img src="/hexo-docs/images/redisImages/image-20250416170002549.png" alt="image-20250416170002549"></li><li><img src="/hexo-docs/images/redisImages/image-20250416170101192.png" alt="image-20250416170101192"></li><li><img src="/hexo-docs/images/redisImages/image-20250416170152373.png" alt="image-20250416170152373"></li><li><img src="/hexo-docs/images/redisImages/image-20250416170236656.png" alt="image-20250416170236656"></li><li><img src="/hexo-docs/images/redisImages/image-20250416170351266.png" alt="image-20250416170351266"></li><li><img src="/hexo-docs/images/redisImages/image-20250416170415481.png" alt="image-20250416170415481"></li><li><img src="/hexo-docs/images/redisImages/image-20250416170638143.png" alt="image-20250416170638143"></li></ul></li></ul></li><li>效果，启动redis6379、redis6380、redis6381，并查看（如果连接不上试试ping命令 ，看看是否可以和主机ping通，如果ping不通关闭防火墙<code>systemctl stop firewalld</code>）<ul><li>如果端口号不是 6379 启动的时候加上端口号，如果不加默认6379<ul><li><img src="/hexo-docs/images/redisImages/image-20250418211505189.png" alt="image-20250418211505189"></li></ul></li><li>启动两个从机<ul><li><img src="/hexo-docs/images/redisImages/image-20250418211822625.png" alt="image-20250418211822625"></li><li><img src="/hexo-docs/images/redisImages/image-20250418224045300.png" alt="image-20250418224045300"></li><li>主机日志查看 连接<ul><li><img src="/hexo-docs/images/redisImages/image-20250418224709693.png" alt="image-20250418224709693"></li></ul></li><li>从机日志查看连接<ul><li><img src="/hexo-docs/images/redisImages/image-20250418224817758.png" alt="image-20250418224817758"></li></ul></li><li>主机<ul><li><img src="/hexo-docs/images/redisImages/image-20250418224136632.png" alt="image-20250418224136632"></li></ul></li><li><img src="/hexo-docs/images/redisImages/image-20250418224349195.png" alt="image-20250418224349195"></li><li>使用从机访问试试<ul><li><img src="/hexo-docs/images/redisImages/image-20250418224431124.png" alt="image-20250418224431124"></li></ul></li></ul></li></ul></li></ul></li></ul><p>问题：</p><ol><li><p>从机可以执行写命令吗？</p><p><img src="/hexo-docs/images/redisImages/image-20250418225224247.png" alt="image-20250418225224247"></p></li><li><p>从机切入点问题</p><p>slave是从头开始复制还是从切入点开始复制?</p><p> master启动，写到k3</p><p> slave1跟着master同时启动，跟着写到k3</p><p> slave2写到k3后才启动，那之前的是否也可以复制？</p><p>  Y，首次一锅端，后续跟随，master写，slave跟</p></li><li><p>主机shutdown后，从机会不会上位</p><p>从机不动，原地待命，从机数据可以正常使用；等待主机重启动归来</p></li><li><p>主机shutdown后，重启后主从关系还在吗？从机还能否顺利复制？</p><p><img src="/hexo-docs/images/redisImages/image-20250418225407582.png" alt="image-20250418225407582"></p></li><li><p>某台从机down后，master继续，从机重启后它能跟上主机吗？</p><p>可以</p></li></ol><h3 id="命令操作主从关系"><a href="#命令操作主从关系" class="headerlink" title="命令操作主从关系"></a>命令操作主从关系</h3><p><img src="/hexo-docs/images/redisImages/image-20250418225601215.png" alt="image-20250418225601215"></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>配置，持久稳定</p><p>命令，当次生效</p><h3 id="链式复制"><a href="#链式复制" class="headerlink" title="链式复制"></a>链式复制</h3><p>上一个slave可以是下一个slave的master，slave同样可以接受其他slaves的连接和同步请求，那么该slave作为了链条中下一个的master，可以有效减轻主master的写压力</p><p>中途变更转向：会清除之前的数据，重新建立拷贝最新的</p><p>我们这三个形成链式结构</p><p><img src="/hexo-docs/images/redisImages/image-20250419130824794.png" alt="image-20250419130824794"></p><ol><li><p>修改<code>192.168.0.132</code>的配置文件(永久生效)</p><p><img src="/hexo-docs/images/redisImages/image-20250419131714791.png" alt="image-20250419131714791"></p><p><img src="/hexo-docs/images/redisImages/image-20250419131834418.png" alt="image-20250419131834418"></p><p>在6379写入信息</p><p><img src="/hexo-docs/images/redisImages/image-20250419131946540.png" alt="image-20250419131946540"></p><p><img src="/hexo-docs/images/redisImages/image-20250419132018603.png" alt="image-20250419132018603"></p><p><img src="/hexo-docs/images/redisImages/image-20250419132033066.png" alt="image-20250419132033066"></p></li><li><p><code>slaveof 主库IP 主库端口</code></p><p><img src="/hexo-docs/images/redisImages/image-20250419132251235.png" alt="image-20250419132251235"></p><p><img src="/hexo-docs/images/redisImages/image-20250419132337419.png" alt="image-20250419132337419"></p></li></ol><p>6380的主IP是6379，从IP是6381，6380是否可以写入信息？</p><p><img src="/hexo-docs/images/redisImages/image-20250419132140369.png" alt="image-20250419132140369"></p><p>不可以！</p><h3 id="从机变主机"><a href="#从机变主机" class="headerlink" title="从机变主机"></a>从机变主机</h3><p>可以通过 <code>slaveof no one</code>使当前数据库停止与其他数据库的同步，转成主数据库</p><p><img src="/hexo-docs/images/redisImages/image-20250419132930604.png" alt="image-20250419132930604"></p><blockquote><p>注意：</p><p>​这个命令不是长期有效的，如果<code>shutdown</code>后，在启动不会生效</p></blockquote><h3 id="复制原理和工作流程"><a href="#复制原理和工作流程" class="headerlink" title="复制原理和工作流程"></a>复制原理和工作流程</h3><h4 id="slave启动，同步初请"><a href="#slave启动，同步初请" class="headerlink" title="slave启动，同步初请"></a>slave启动，同步初请</h4><p>slave启动成功连接到master后会发送一个sync命令</p><p>slave首次全新连接master，一次完全同步（全量复制）将被自动执行，slave自身原有数据会被master数据覆盖清除</p><h4 id="首次连接，全量复制"><a href="#首次连接，全量复制" class="headerlink" title="首次连接，全量复制"></a>首次连接，全量复制</h4><p>master节点收到sync命令后会开始在后台保存快照（即RDB持久化，主从复制时会触发RDB），同时收集所有接受到的用于修改数据集命令缓存起来，master节点执行RDB持久化完后，master将rdb快照文件和所有缓存的命令发送到所有slave，以完成一次完全同步。</p><p>而slave服务在接受到数据库文件数据后，将其存盘并加载到内存中，从而完成复制初始化</p><h4 id="心跳持续，保持通信"><a href="#心跳持续，保持通信" class="headerlink" title="心跳持续，保持通信"></a>心跳持续，保持通信</h4><p><code>repl-ping-replica-period 10</code></p><p>master发出PING包的周期，默认是10秒</p><p><img src="/hexo-docs/images/redisImages/image-20250419133730232.png" alt="image-20250419133730232"></p><h4 id="进入平稳，增量复制"><a href="#进入平稳，增量复制" class="headerlink" title="进入平稳，增量复制"></a>进入平稳，增量复制</h4><p>master继续将新的所有收集到的修改命令自动依次传给slave，完成同步</p><h4 id="从机下线，重连续传"><a href="#从机下线，重连续传" class="headerlink" title="从机下线，重连续传"></a>从机下线，重连续传</h4><p>master会检查backlog里面的offset，master和slave都会保存一个复制的offset还有一个masterId，offset是保存在backlog中的。<strong>master只会把已经复制的offset后面的数据复制给slave</strong></p><h3 id="复制的缺点"><a href="#复制的缺点" class="headerlink" title="复制的缺点"></a>复制的缺点</h3><h4 id="复制延时，信号衰减"><a href="#复制延时，信号衰减" class="headerlink" title="复制延时，信号衰减"></a>复制延时，信号衰减</h4><p>由于所有的写操作都是先在Master上操作，然后同步更新到Slave上，所以从Master同步到Slave机器有一定的延迟，当系统很繁忙的时候，延迟问题会更加严重，Slave机器数量的增加也会使这个问题更加严重。</p><p><img src="/hexo-docs/images/redisImages/image-20250419134221438.png" alt="image-20250419134221438"></p><h4 id="master挂了如何办？"><a href="#master挂了如何办？" class="headerlink" title="master挂了如何办？"></a>master挂了如何办？</h4><p>默认情况下，不会在slave节点中自动重选一个master</p><p>那每次都要人工干预？</p><p><strong>无人值守安装变成刚需</strong></p>]]></content>
      
      
      <categories>
          
          <category> 后端 Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis分布式锁</title>
      <link href="/hexo-docs/2025/08/13/redis/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
      <url>/hexo-docs/2025/08/13/redis/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</url>
      
        <content type="html"><![CDATA[<h2 id="redis分布式锁"><a href="#redis分布式锁" class="headerlink" title="redis分布式锁"></a>redis分布式锁</h2><p>目的：解决多个服务原子性的问题</p><p>在很多场景中，我们为了保证数据的最终一致性，需要很多的技术方案来支持，比如分布式事务、分布式锁等。那具体什么是分布式锁，分布式锁应用在哪些业务场景、如何来实现分布式锁呢？</p><p>锁的种类</p><ul><li>单机版同一个jvm虚拟机内，synchronized或者Lock接口</li><li>分布式多个不同虚拟机，单机的线程锁机制不再起作用，资源类在不同的服务器之间共享了</li></ul><p>一个靠谱分布式锁需要具备的条件和刚需</p><ul><li><p>独占性</p><p>OnlyOne，任何时刻只能有且仅有一个线程持有</p></li><li><p>高可用</p><p>若redis集群环境下，不能因为某一个节点挂了而出现获取锁和释放锁失败的情况</p><p>高并发请求下，依旧性能ok好使</p></li><li><p>防死锁</p><p>杜绝死锁，必须有超时控制机制或者撤销操作，有个兜底终止跳出方案</p></li><li><p>不乱抢</p><p>不能私下unlock（解）别人的锁，只能自己加锁自己释放</p></li><li><p>重入性</p><p>同一个节点的同一个线程如何获得锁之后，它也可以再次获得这个锁。</p></li></ul><p>分布式锁</p><p><img src="/hexo-docs/images/redisImages/image-20250706154309003.png" alt="image-20250706154309003"></p><h2 id="案例1"><a href="#案例1" class="headerlink" title="案例1"></a>案例1</h2><p>使用场景：多个服务间保证同一时刻同一时间段内同一用户只能有一个请求（防止关键业务出现并发攻击）</p><p>两个服务，分别是<code>redis_distributed_lock2</code>和<code>redis_distributed_lock3</code>代码一样端口号不一样</p><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--SpringBoot通用依赖模块--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--SpringBoot与Redis整合依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--通用基础配置boottest/lombok/hutool--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.36<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7777</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis_distributed_lock2</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.134</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">lettuce:</span></span><br><span class="line">        <span class="attr">pool:</span></span><br><span class="line">          <span class="attr">max-idle:</span> <span class="number">8</span></span><br><span class="line">          <span class="attr">max-wait:</span> <span class="string">-1ms</span></span><br><span class="line">          <span class="attr">max-active:</span> <span class="number">8</span></span><br><span class="line">          <span class="attr">min-idle:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">database:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p><code>config</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(LettuceConnectionFactory lettuceConnectionFactory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(lettuceConnectionFactory);</span><br><span class="line">        <span class="comment">//设置key的序列化方式string</span></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        <span class="comment">//设置value序列化方式json</span></span><br><span class="line">        redisTemplate.setValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setHashKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setHashValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>service</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span>(inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>,String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span>+inventoryNumber;</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;服务端口号：&quot;</span>+port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>controller</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.InventoryService;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> InventoryService inventoryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/inventory/sale&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> inventoryService.sale();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>nginx配置</p><p><img src="/hexo-docs/images/redisImages/image-20250706164748316.png" alt="image-20250706164748316"></p><p>使用<code>start nginx</code>启动即可</p><p>测试：</p><p><img src="/hexo-docs/images/redisImages/image-20250706165511889.png" alt="image-20250706165511889"></p><p>没问题！使用压测工具同时开启100个线程访问</p><p><img src="/hexo-docs/images/redisImages/image-20250706165259013.png" alt="image-20250706165259013"></p><p><img src="/hexo-docs/images/redisImages/image-20250706165312138.png" alt="image-20250706165312138"></p><p>加了lock还是出现超卖的现象，在分布式下毫无意义，因为lock只适用于单服务！</p><h3 id="第一次改造-递归重试"><a href="#第一次改造-递归重试" class="headerlink" title="第一次改造(递归重试)"></a>第一次改造(递归重试)</h3><p>接下来改造我们的<code>service</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;lock&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> IdUtil.simpleUUID()+<span class="string">&quot;:&quot;</span>+Thread.currentThread().getId();<span class="comment">//uuid+当前线程id</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, value);</span><br><span class="line">        <span class="comment">//判断是否获得锁</span></span><br><span class="line">        <span class="keyword">if</span> (Boolean.FALSE.equals(flag))&#123;</span><br><span class="line">            <span class="comment">//未获得锁，停留20毫秒继续抢</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">20</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.sale();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//获得锁</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//1 查询库存信息</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">                <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">                <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">                <span class="comment">//3 扣减库存</span></span><br><span class="line">                <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">                    retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">                    System.out.println(retMessage);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//删除锁</span></span><br><span class="line">                stringRedisTemplate.delete(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动测试，我们要把值修改为5000，我们要使用1秒2w线程数进行压测</p><p><img src="/hexo-docs/images/redisImages/image-20250706172931582.png" alt="image-20250706172931582"></p><p><img src="/hexo-docs/images/redisImages/image-20250706172953495.png" alt="image-20250706172953495"></p><p><img src="/hexo-docs/images/redisImages/image-20250706173002069.png" alt="image-20250706173002069"></p><p>这是我们的锁</p><p><img src="/hexo-docs/images/redisImages/image-20250706173123232.png" alt="image-20250706173123232"></p><p>递归是一种思想没错，但是容易导致<code>StackOverflowError</code>，不太推荐，需要进一步完善，另外，高并发唤醒后推荐用white判断而不是if</p><h3 id="第二次改造（while替代）"><a href="#第二次改造（while替代）" class="headerlink" title="第二次改造（while替代）"></a>第二次改造（while替代）</h3><p>继续改造<code>service</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;lock&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> IdUtil.simpleUUID()+<span class="string">&quot;:&quot;</span>+Thread.currentThread().getId();<span class="comment">//uuid+当前线程id</span></span><br><span class="line">        <span class="keyword">while</span> (Boolean.FALSE.equals(stringRedisTemplate.opsForValue().setIfAbsent(key, value))) &#123;</span><br><span class="line">            <span class="comment">//休眠20毫秒</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">20</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获得锁</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//删除锁</span></span><br><span class="line">            stringRedisTemplate.delete(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续进行压测，压测1轮3000</p><p><img src="/hexo-docs/images/redisImages/image-20250706175549309.png" alt="image-20250706175549309"></p><p><img src="/hexo-docs/images/redisImages/image-20250706175558294.png" alt="image-20250706175558294"></p><p><img src="/hexo-docs/images/redisImages/image-20250706175612817.png" alt="image-20250706175612817"></p><p>问题：</p><ul><li>部署了微服务的java程序机器挂了，代码层面根本没有走到finally这块，没办法保证解锁（无过期时间改key一直存在），这个key没有被删除，需要加入一个过期时间限定key</li></ul><h3 id="第三次改造（宕机与过期-防止死锁）"><a href="#第三次改造（宕机与过期-防止死锁）" class="headerlink" title="第三次改造（宕机与过期+防止死锁）"></a>第三次改造（宕机与过期+防止死锁）</h3><p>设置key的过期时间，设置过期时间为30秒</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;lock&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> IdUtil.simpleUUID()+<span class="string">&quot;:&quot;</span>+Thread.currentThread().getId();<span class="comment">//uuid+当前线程id</span></span><br><span class="line">        <span class="keyword">while</span> (Boolean.FALSE.equals(stringRedisTemplate.opsForValue().setIfAbsent(key, value,<span class="number">30L</span>, TimeUnit.SECONDS))) &#123;</span><br><span class="line">            <span class="comment">//休眠20毫秒</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">20</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获得锁</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//删除锁</span></span><br><span class="line">            stringRedisTemplate.delete(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在进行压测</p><p><img src="/hexo-docs/images/redisImages/image-20250706180901881.png" alt="image-20250706180901881"></p><p>结论：</p><ul><li>加锁和过期时间必须设置同一行，保证原子性</li></ul><h3 id="第四次改造（防止误删key的问题）"><a href="#第四次改造（防止误删key的问题）" class="headerlink" title="第四次改造（防止误删key的问题）"></a>第四次改造（防止误删key的问题）</h3><p><img src="/hexo-docs/images/redisImages/image-20250706182055589.png" alt="image-20250706182055589"></p><p>只能删除自己的，不许删除别人的锁</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;lock&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> IdUtil.simpleUUID()+<span class="string">&quot;:&quot;</span>+Thread.currentThread().getId();<span class="comment">//uuid+当前线程id</span></span><br><span class="line">        <span class="keyword">while</span> (Boolean.FALSE.equals(stringRedisTemplate.opsForValue().setIfAbsent(key, value,<span class="number">30L</span>, TimeUnit.SECONDS))) &#123;</span><br><span class="line">            <span class="comment">//休眠20毫秒</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">20</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获得锁</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//判断不为空，才能进行equals判断</span></span><br><span class="line">            <span class="keyword">if</span> (Objects.requireNonNull(stringRedisTemplate.opsForValue().get(key)).equalsIgnoreCase(value)) &#123;</span><br><span class="line">                <span class="comment">//删除锁</span></span><br><span class="line">                stringRedisTemplate.delete(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>存在问题，最后判断和删除不是原子性操作，需要使用lua脚本确保一致性操作</p><h3 id="第五次改造（保证原子性，使用lua脚本）"><a href="#第五次改造（保证原子性，使用lua脚本）" class="headerlink" title="第五次改造（保证原子性，使用lua脚本）"></a>第五次改造（保证原子性，使用lua脚本）</h3><p><img src="/hexo-docs/images/redisImages/image-20250707101521381.png" alt="image-20250707101521381"></p><h4 id="Lua脚本"><a href="#Lua脚本" class="headerlink" title="Lua脚本"></a>Lua脚本</h4><p>redis调用Lua脚本通过eval命令保证代码执行的原子性，直接用return返回脚本执行后的结果值</p><p>eval命令</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">EVAL script numkeys key [key ...] arg [arg ...]</span><br><span class="line">#numkeys 代表参数个数</span><br><span class="line">#key 是键</span><br><span class="line">#arg 是具体key的值</span><br></pre></td></tr></table></figure><p>hello world入门</p><ol><li><p>hello lua</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; EVAL &quot;return &#x27;hello lua&#x27;&quot; <span class="number">0</span> </span><br><span class="line">&quot;hello lua&quot;</span><br></pre></td></tr></table></figure></li><li><p>set k1 v1 get k1</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; EVAL &quot;redis.<span class="keyword">call</span>(&#x27;<span class="built_in">set</span>&#x27;,&#x27;k1&#x27;,&#x27;v1&#x27;) return redis.<span class="keyword">call</span>(&#x27;get&#x27;,&#x27;k1&#x27;)&quot; <span class="number">0</span></span><br><span class="line">&quot;v1&quot;</span><br></pre></td></tr></table></figure></li><li><p>mset</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; EVAL &quot;return redis.<span class="keyword">call</span>(&#x27;mset&#x27;,KEYS[<span class="number">1</span>],ARGV[<span class="number">1</span>],KEYS[<span class="number">2</span>],ARGV[<span class="number">2</span>]) &quot; <span class="number">2</span> k1 k2 v1 v2</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get k1</span><br><span class="line">&quot;v1&quot;</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get k2</span><br><span class="line">&quot;v2&quot;</span><br></pre></td></tr></table></figure></li></ol><p>Lua脚本进一步</p><ul><li><p>条件判断语法</p><p><img src="/hexo-docs/images/redisImages/image-20250707102719142.png" alt="image-20250707102719142"></p></li><li><p>条件判断案例</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get keys</span><br><span class="line">&quot;<span class="number">1</span>&quot;</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; EVAL &quot;<span class="keyword">if</span> redis.<span class="keyword">call</span>(&#x27;get&#x27;,KEYS[<span class="number">1</span>])==ARGV[<span class="number">1</span>] then return redis.<span class="keyword">call</span>(&#x27;<span class="built_in">del</span>&#x27;,KEYS[<span class="number">1</span>]) <span class="keyword">else</span> return <span class="number">0</span> end&quot; <span class="number">1</span> keys <span class="number">2</span></span><br><span class="line">(integer) <span class="number">0</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; EVAL &quot;<span class="keyword">if</span> redis.<span class="keyword">call</span>(&#x27;get&#x27;,KEYS[<span class="number">1</span>])==ARGV[<span class="number">1</span>] then return redis.<span class="keyword">call</span>(&#x27;<span class="built_in">del</span>&#x27;,KEYS[<span class="number">1</span>]) <span class="keyword">else</span> return <span class="number">0</span> end&quot; <span class="number">1</span> keys <span class="number">1</span></span><br><span class="line">(integer) <span class="number">1</span></span><br></pre></td></tr></table></figure></li></ul><p>改造</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;lock&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> IdUtil.simpleUUID()+<span class="string">&quot;:&quot;</span>+Thread.currentThread().getId();<span class="comment">//uuid+当前线程id</span></span><br><span class="line">        <span class="keyword">while</span> (Boolean.FALSE.equals(stringRedisTemplate.opsForValue().setIfAbsent(key, value,<span class="number">30L</span>, TimeUnit.SECONDS))) &#123;</span><br><span class="line">            <span class="comment">//休眠20毫秒</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">20</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获得锁</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//添加lua脚本，确保原子性</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">luaScript</span> <span class="operator">=</span> <span class="string">&quot;if redis.call(&#x27;get&#x27;,KEYS[1]) == ARGV[1] then &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return redis.call(&#x27;del&#x27;,KEYS[1]) &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;else return 0 end&quot;</span>;</span><br><span class="line">            stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(luaScript,Boolean.class), List.of(key),value);<span class="comment">//使用该构造方法，不然报错</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get lock</span><br><span class="line">&quot;<span class="number">7</span>f5195a7954d468aa32830d9ebedcdd6:<span class="number">244</span>&quot;</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get lock</span><br><span class="line">&quot;<span class="number">4721213967994</span>ef28ce98ee6ed3a68bc:<span class="number">76</span>&quot;</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get lock</span><br><span class="line">&quot;e9d20717da254f5b930fc04b6e983974:<span class="number">47</span>&quot;</span><br></pre></td></tr></table></figure><p>保证了程序的原子性！</p><h3 id="第六次改造"><a href="#第六次改造" class="headerlink" title="第六次改造"></a>第六次改造</h3><p>while判断并自旋重试获得锁+setnx含自然过期时间+Lua脚本删除锁命令</p><p>问题</p><ul><li>如何兼顾锁的可重入性问题？</li></ul><p>一个靠谱分布式锁需要具备的条件和刚需</p><ul><li>独占性</li><li>高可用</li><li>防死锁</li><li>不乱抢</li><li>重入性</li></ul><h4 id="可重入锁（又名递归锁）"><a href="#可重入锁（又名递归锁）" class="headerlink" title="可重入锁（又名递归锁）"></a>可重入锁（又名递归锁）</h4><p>是指在同一个线程在外层方法获取锁的时候，再进入该线程的内层方法会自动获取锁(前提，锁对象得是同一个对象)，不会因为之前已经获取过还没释放而阻塞。</p><p>如果是1个有 synchronized 修饰的递归调用方法，程序第2次进入被自己阻塞了岂不是天大的笑话，出现了作茧自缚。</p><p>所以Java中ReentrantLock和synchronized都是可重入锁，可重入锁的一个优点是可一定程度避免死锁。</p><p>可重入锁种类</p><ul><li><p>隐式锁（即synchronized关键字使用的锁）默认是可重入锁</p><p>指的是可重复可递归调用的锁，在外层使用锁之后，在内层仍然可以使用，并且不发生死锁，这样的锁就叫做可重入锁。</p><p>简单的来说就是：在一个synchronized修饰的方法或代码块的内部调用本类的其他synchronized修饰的方法或代码块时，是永远可以得到锁的</p><p>与可重入锁相反，不可重入锁不可递归调用，递归调用就发生死锁。</p><ul><li><p>同步块</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReEntryLockDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockBlock</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">           <span class="keyword">synchronized</span> (obj)&#123;</span><br><span class="line">               System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---外层调用&quot;</span>);</span><br><span class="line">               <span class="keyword">synchronized</span> (obj)&#123;</span><br><span class="line">                   System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---中层调用&quot;</span>);</span><br><span class="line">                   <span class="keyword">synchronized</span> (obj)&#123;</span><br><span class="line">                       System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---内层调用&quot;</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ReEntryLockDemo</span> <span class="variable">reEntryLockDemo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReEntryLockDemo</span>();</span><br><span class="line">        reEntryLockDemo.lockBlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>同步方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReEntryLockDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">lockMethod</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---外层调用&quot;</span>);</span><br><span class="line">        lockMethod2();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">lockMethod2</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---中层调用&quot;</span>);</span><br><span class="line">        lockMethod3();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">lockMethod3</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---内层调用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ReEntryLockDemo</span> <span class="variable">reEntryLockDemo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReEntryLockDemo</span>();</span><br><span class="line">        reEntryLockDemo.lockMethod();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Synchronized的重入的实现原理</p><p><span style="color:#FF3333;">每个锁对象拥有一个锁计数器和一个指向持有该锁的线程的指针。</span></p><p>当执行monitorenter时，如果目标锁对象的计数器为零，那么说明它没有被其他线程所持有，Java虚拟机会将该锁对象的持有线程设置为当前线程，并且将其计数器加1。</p><p>在目标锁对象的计数器不为零的情况下，如果锁对象的持有线程是当前线程，那么Java虚拟机可以将其计数器加1，否则需要等待，甚至持有线程释放该锁。</p><p>当执行monitorexit时，Java虚拟机则需将锁对象的计数器减1。计数器为零代表锁已被释放。</p></li><li><p>显示锁（即Lock）也有ReentrantLock这样的可重入锁。</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        myLock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---外层调用&quot;</span>);</span><br><span class="line">            myLock.lock();</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---中层调用&quot;</span>);</span><br><span class="line">                myLock.lock();</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---内层调用&quot;</span>);</span><br><span class="line">                &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">//这里故意注释，实现加锁次数和释放次数不一样</span></span><br><span class="line">                    <span class="comment">//由于加锁次数和释放次数不一样，第二个线程始终无法获取到锁，导致一直在等待。</span></span><br><span class="line">                    myLock.unlock(); <span class="comment">// 正常情况，加锁几次就要解锁几次</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                myLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            myLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>切记，一般而言，lock了几次就要unlock几次。</p></li></ul></li><li><p>上述可重入锁问题，redis中那个数据类型可以代替？</p><ul><li><p>K，K，V</p><p><img src="/hexo-docs/images/redisImages/image-20250707174427391.png" alt="image-20250707174427391"></p><p>hset zzyyRedisLock 29f0ee01ac77414fb8b0861271902a94:1</p><ul><li><p>总结</p><p>setnx，只能解决有无的问题，够用但是不够完美</p><p>hset，不但解决有无，还解决可重入问题</p></li></ul></li></ul></li><li><p>思考+设计模式（一横一纵）</p><ul><li><p>目前有2条支线，目的是保证同一个时候只能有一个线程持有锁进去redis做扣减库存动作</p><ul><li><p>2个分支</p><ul><li><p>保证加锁&#x2F;解锁，lock&#x2F;unlock</p><p>一个靠谱分布式锁需要具备的条件和刚需</p><ul><li>独占性</li><li>高可用</li><li>防死锁</li><li>不乱抢</li><li>重入性</li></ul></li><li><p>扣减库存redis命令的原子性</p><p><img src="/hexo-docs/images/redisImages/image-20250707181751904.png" alt="image-20250707181751904"></p></li></ul></li></ul></li></ul></li><li><p>Lua脚本</p><ul><li><p>redis命令过程分析</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; EXISTS lock</span><br><span class="line">(integer) <span class="number">0</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; HSET lock <span class="number">1</span>a2b3c <span class="number">1</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; HINCRBY lock <span class="number">1</span>a2b3c <span class="number">1</span></span><br><span class="line">(integer) <span class="number">2</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; HGET lock <span class="number">1</span>a2b3c</span><br><span class="line">&quot;<span class="number">2</span>&quot;</span><br></pre></td></tr></table></figure></li><li><p>加锁Lua脚本lock</p><ul><li><p>先判断redis分布式锁这个key是否存在</p><ul><li><p>exists key</p><ul><li><p>返回0说明不存在，hset新建当前线程属于自己的锁 uuid:threadId</p><p><img src="/hexo-docs/images/redisImages/image-20250707182254870.png" alt="image-20250707182254870"></p></li><li><p>返回1说明已经有锁，需进一步判断是不是当前线程自己的</p><ul><li>hexists key uuid:threadID<ul><li>返回0说明不是自己的</li><li>返回1说明是自己的锁，自增1次表示重入</li></ul></li></ul></li></ul></li></ul></li><li><p>上述设计修改为Lua脚本</p><ul><li><p>v1</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.<span class="keyword">call</span>(&#x27;exists&#x27;,&#x27;key&#x27;) == <span class="number">0</span> then</span><br><span class="line">  redis.<span class="keyword">call</span>(&#x27;hset&#x27;,&#x27;key&#x27;,&#x27;uuid:threadid&#x27;,<span class="number">1</span>)</span><br><span class="line">  redis.<span class="keyword">call</span>(&#x27;expire&#x27;,&#x27;key&#x27;,<span class="number">30</span>)</span><br><span class="line">  return <span class="number">1</span></span><br><span class="line">elseif redis.<span class="keyword">call</span>(&#x27;hexists&#x27;,&#x27;key&#x27;,&#x27;uuid:threadid&#x27;) == <span class="number">1</span> then</span><br><span class="line">  redis.<span class="keyword">call</span>(&#x27;hincrby&#x27;,&#x27;key&#x27;,&#x27;uuid:threadid&#x27;,<span class="number">1</span>)</span><br><span class="line">  redis.<span class="keyword">call</span>(&#x27;expire&#x27;,&#x27;key&#x27;,<span class="number">30</span>)</span><br><span class="line">  return <span class="number">1</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  return <span class="number">0</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>相同部分是否可以替换处理？？？</p><p>hincrby命令可否替代hset命令</p></li><li><p>v2</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.<span class="keyword">call</span>(&#x27;exists&#x27;,&#x27;key&#x27;) == <span class="number">0</span> or redis.<span class="keyword">call</span>(&#x27;hexists&#x27;,&#x27;key&#x27;,&#x27;uuid:threadid&#x27;) == <span class="number">1</span> then</span><br><span class="line">  redis.<span class="keyword">call</span>(&#x27;hincrby&#x27;,&#x27;key&#x27;,&#x27;uuid:threadid&#x27;,<span class="number">1</span>)</span><br><span class="line">  redis.<span class="keyword">call</span>(&#x27;expire&#x27;,&#x27;key&#x27;,<span class="number">30</span>)</span><br><span class="line">  return <span class="number">1</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  return <span class="number">0</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure></li><li><p>v3</p><table><thead><tr><th>key</th><th>KEYS[1]</th><th>lock</th></tr></thead><tbody><tr><td>value</td><td>ARGV[1]</td><td>2f586ae740a94736894ab9d51880ed9d:1</td></tr><tr><td>过期时间值</td><td>ARGV[2]</td><td>30  秒</td></tr></tbody></table> <figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.<span class="keyword">call</span>(&#x27;exists&#x27;,KEYS[<span class="number">1</span>]) == <span class="number">0</span> or redis.<span class="keyword">call</span>(&#x27;hexists&#x27;,KEYS[<span class="number">1</span>],ARGV[<span class="number">1</span>]) == <span class="number">1</span> then </span><br><span class="line"> redis.<span class="keyword">call</span>(&#x27;hincrby&#x27;,KEYS[<span class="number">1</span>],ARGV[<span class="number">1</span>],<span class="number">1</span>) </span><br><span class="line"> redis.<span class="keyword">call</span>(&#x27;expire&#x27;,KEYS[<span class="number">1</span>],ARGV[<span class="number">2</span>]) </span><br><span class="line"> return <span class="number">1</span> </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"> return <span class="number">0</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p>解锁Lua脚本unlock</p><ul><li><p>设计思路：有锁且还是自己的锁</p><ul><li><p>hexists key uuid:threadID</p><ul><li>返回零，说明根本没有锁，程序块返回nil</li><li>不是零，说明有锁是自己的锁，直接调用<code>hincrby -1</code>表示每次减个1，解锁一次。直到它变为零表示可以删除该锁key,del锁key</li></ul></li><li><p>设计脚本</p><ul><li><p>v1</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.<span class="keyword">call</span>(&#x27;HEXISTS&#x27;,lock,uuid:threadID) == <span class="number">0</span> then</span><br><span class="line"> return nil</span><br><span class="line">elseif redis.<span class="keyword">call</span>(&#x27;HINCRBY&#x27;,lock,uuid:threadID,-<span class="number">1</span>) == <span class="number">0</span> then</span><br><span class="line"> return redis.<span class="keyword">call</span>(&#x27;<span class="built_in">del</span>&#x27;,lock)</span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line"> return <span class="number">0</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure></li><li><p>v2</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.<span class="keyword">call</span>(&#x27;HEXISTS&#x27;,KEYS[<span class="number">1</span>],ARGV[<span class="number">1</span>]) == <span class="number">0</span> then</span><br><span class="line"> return nil</span><br><span class="line">elseif redis.<span class="keyword">call</span>(&#x27;HINCRBY&#x27;,KEYS[<span class="number">1</span>],ARGV[<span class="number">1</span>],-<span class="number">1</span>) == <span class="number">0</span> then</span><br><span class="line"> return redis.<span class="keyword">call</span>(&#x27;<span class="built_in">del</span>&#x27;,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"> return <span class="number">0</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure></li></ul></li></ul></li></ul></li></ul></li></ul><h3 id="第七次改造（确保可重入性和原子性）"><a href="#第七次改造（确保可重入性和原子性）" class="headerlink" title="第七次改造（确保可重入性和原子性）"></a>第七次改造（确保可重入性和原子性）</h3><p><code>RedisDistributedLock</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.locks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisDistributedLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String lockName;<span class="comment">//KEYS[1]</span></span><br><span class="line">    <span class="keyword">private</span> String uuidValue;<span class="comment">//ARGV[1]</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span>   expireTime;<span class="comment">//ARGV[2]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisDistributedLock</span><span class="params">(StringRedisTemplate stringRedisTemplate, String lockName)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">        <span class="built_in">this</span>.lockName = lockName;</span><br><span class="line">        <span class="built_in">this</span>.uuidValue = IdUtil.simpleUUID()+<span class="string">&quot;:&quot;</span>+Thread.currentThread().getId();<span class="comment">//UUID:ThreadID</span></span><br><span class="line">        <span class="built_in">this</span>.expireTime = <span class="number">30L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>&#123;</span><br><span class="line">        tryLock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;tryLock(-<span class="number">1L</span>,TimeUnit.SECONDS);&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;e.printStackTrace();&#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 干活的，实现加锁功能，实现这一个干活的就OK，全盘通用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException&#123;</span><br><span class="line">        <span class="keyword">if</span>(time != -<span class="number">1L</span>)&#123;</span><br><span class="line">            <span class="built_in">this</span>.expireTime = unit.toSeconds(time);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;if redis.call(&#x27;exists&#x27;,KEYS[1]) == 0 or redis.call(&#x27;hexists&#x27;,KEYS[1],ARGV[1]) == 1 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;hincrby&#x27;,KEYS[1],ARGV[1],1) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;expire&#x27;,KEYS[1],ARGV[2]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 1 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 0 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;script: &quot;</span>+script);</span><br><span class="line">        System.out.println(<span class="string">&quot;lockName: &quot;</span>+lockName);</span><br><span class="line">        System.out.println(<span class="string">&quot;uuidValue: &quot;</span>+uuidValue);</span><br><span class="line">        System.out.println(<span class="string">&quot;expireTime: &quot;</span>+expireTime);</span><br><span class="line">        <span class="keyword">while</span> (Boolean.FALSE.equals(stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime)))) &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">50</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *干活的，实现解锁功能</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;if redis.call(&#x27;HEXISTS&#x27;,KEYS[1],ARGV[1]) == 0 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;   return nil &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;elseif redis.call(&#x27;HINCRBY&#x27;,KEYS[1],ARGV[1],-1) == 0 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;   return redis.call(&#x27;del&#x27;,KEYS[1]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;   return 0 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        <span class="comment">// nil = false 1 = true 0 = false</span></span><br><span class="line">        System.out.println(<span class="string">&quot;lockName: &quot;</span>+lockName);</span><br><span class="line">        System.out.println(<span class="string">&quot;uuidValue: &quot;</span>+uuidValue);</span><br><span class="line">        System.out.println(<span class="string">&quot;expireTime: &quot;</span>+expireTime);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class), Arrays.asList(lockName),uuidValue,String.valueOf(expireTime));</span><br><span class="line">        <span class="keyword">if</span>(flag == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;This lock doesn&#x27;t EXIST&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//===下面的redis分布式锁暂时用不到=======================================</span></span><br><span class="line">    <span class="comment">//===下面的redis分布式锁暂时用不到=======================================</span></span><br><span class="line">    <span class="comment">//===下面的redis分布式锁暂时用不到=======================================</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>service</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> com.lazy.locks.RedisDistributedLock;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisDistributedLock</span>(stringRedisTemplate,<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span>(inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>,String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span>+inventoryNumber;</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage+<span class="string">&quot;服务端口号：&quot;</span>+port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250708182329476.png" alt="image-20250708182329476"></p><p>为了有更好的兼容性我们引入了工程设计模式</p><p><code>DistributedLockFactory</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.locks.RedisDistributedLock;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="keyword">private</span> String lockName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Lock <span class="title function_">getDistributedLock</span><span class="params">(String lockType)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lockType == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (lockType.equalsIgnoreCase(<span class="string">&quot;redis&quot;</span>))&#123;</span><br><span class="line">            <span class="built_in">this</span>.lockName = <span class="string">&quot;redisLock&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisDistributedLock</span>(stringRedisTemplate,lockName);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (lockType.equalsIgnoreCase(<span class="string">&quot;mysql&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//TODO mysql版本的分布式锁实现</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(lockType.equalsIgnoreCase(<span class="string">&quot;zookeeper&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//TODO zookeeper版本的分布式锁实现</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>service</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.factory.DistributedFactory;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DistributedFactory distributedFactory;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Lock</span> <span class="variable">redisLock</span> <span class="operator">=</span> distributedFactory.getDistributedLock(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        redisLock.lock();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span>(inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>,String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，QD库存剩余: &quot;</span>+inventoryNumber;</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            redisLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage+<span class="string">&quot;服务端口号：&quot;</span>+port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250708191029076.png" alt="image-20250708191029076"></p><p>看着好像没问题</p><h4 id="可重入测试重点"><a href="#可重入测试重点" class="headerlink" title="可重入测试重点"></a>可重入测试重点</h4><p>我们在<code>service</code>增加一个方法试试</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.factory.DistributedFactory;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DistributedFactory distributedFactory;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Lock</span> <span class="variable">redisLock</span> <span class="operator">=</span> distributedFactory.getDistributedLock(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        redisLock.lock();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span>(inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>,String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，QD库存剩余: &quot;</span>+inventoryNumber;</span><br><span class="line">                testLock();</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            redisLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage+<span class="string">&quot;服务端口号：&quot;</span>+port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Lock</span> <span class="variable">redisLock</span> <span class="operator">=</span> distributedFactory.getDistributedLock(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line">        redisLock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;测试可重入性方法&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            redisLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动测试试试</p><p><img src="/hexo-docs/images/redisImages/image-20250708194225270.png" alt="image-20250708194225270"></p><p><code>DistributedLockFactory</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> com.lazy.locks.RedisDistributedLock;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedLockFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="keyword">private</span> String lockName;</span><br><span class="line">    <span class="keyword">private</span> String uuidValue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DistributedLockFactory</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>.uuidValue = IdUtil.simpleUUID();<span class="comment">//UUID</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Lock <span class="title function_">getDistributedLock</span><span class="params">(String lockType)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(lockType == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(lockType.equalsIgnoreCase(<span class="string">&quot;REDIS&quot;</span>))&#123;</span><br><span class="line">            lockName = <span class="string">&quot;zzyyRedisLock&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisDistributedLock</span>(stringRedisTemplate,lockName,uuidValue);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(lockType.equalsIgnoreCase(<span class="string">&quot;ZOOKEEPER&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//TODO zookeeper版本的分布式锁实现</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(lockType.equalsIgnoreCase(<span class="string">&quot;MYSQL&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//TODO mysql版本的分布式锁实现</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RedisDistributedLock</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.locks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisDistributedLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="keyword">private</span> String lockName;</span><br><span class="line">    <span class="keyword">private</span> String uuidValue;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span>   expireTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisDistributedLock</span><span class="params">(StringRedisTemplate stringRedisTemplate, String lockName,String uuidValue)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">        <span class="built_in">this</span>.lockName = lockName;</span><br><span class="line">        <span class="built_in">this</span>.uuidValue = uuidValue+<span class="string">&quot;:&quot;</span>+Thread.currentThread().getId();</span><br><span class="line">        <span class="built_in">this</span>.expireTime = <span class="number">30L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>.tryLock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.tryLock(-<span class="number">1L</span>,TimeUnit.SECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(time != -<span class="number">1L</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            expireTime = unit.toSeconds(time);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;if redis.call(&#x27;exists&#x27;,KEYS[1]) == 0 or redis.call(&#x27;hexists&#x27;,KEYS[1],ARGV[1]) == 1 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;hincrby&#x27;,KEYS[1],ARGV[1],1) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;expire&#x27;,KEYS[1],ARGV[2]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 1 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 0 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;lockName: &quot;</span>+lockName+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;uuidValue: &quot;</span>+uuidValue);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123; TimeUnit.MILLISECONDS.sleep(<span class="number">60</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;if redis.call(&#x27;HEXISTS&#x27;,KEYS[1],ARGV[1]) == 0 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return nil &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;elseif redis.call(&#x27;HINCRBY&#x27;,KEYS[1],ARGV[1],-1) == 0 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return redis.call(&#x27;del&#x27;,KEYS[1]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 0 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;lockName: &quot;</span>+lockName+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;uuidValue: &quot;</span>+uuidValue);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime));</span><br><span class="line">        <span class="keyword">if</span>(flag == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;没有这个锁，HEXISTS查询无&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//=========================================================</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试通过！</p><h3 id="第八次改造（添加自动续期）"><a href="#第八次改造（添加自动续期）" class="headerlink" title="第八次改造（添加自动续期）"></a>第八次改造（添加自动续期）</h3><p>确保<code>redisLock</code>过期时间大于业务执行时间的问题，在第一次改造上修改</p><p><code>service</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.factory.DistributedLockFactory;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DistributedLockFactory distributedFactory;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Lock</span> <span class="variable">redisLock</span> <span class="operator">=</span> distributedFactory.getDistributedLock(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        redisLock.lock();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span>(inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>,String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，QD库存剩余: &quot;</span>+inventoryNumber;</span><br><span class="line">                <span class="comment">//暂停120秒</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">120</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            redisLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage+<span class="string">&quot;服务端口号：&quot;</span>+port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RedisDistributedLock</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.locks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisDistributedLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String lockName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String uuidValue;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> expireTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisDistributedLock</span><span class="params">(StringRedisTemplate stringRedisTemplate, String lockName, String uuidValue)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">        <span class="built_in">this</span>.lockName = lockName;</span><br><span class="line">        <span class="built_in">this</span>.uuidValue = uuidValue + <span class="string">&quot;:&quot;</span> + Thread.currentThread().getId();</span><br><span class="line">        <span class="built_in">this</span>.expireTime = <span class="number">30L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.tryLock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.tryLock(-<span class="number">1L</span>, TimeUnit.SECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (time != -<span class="number">1L</span>) &#123;</span><br><span class="line">            expireTime = unit.toSeconds(time);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;if redis.call(&#x27;exists&#x27;,KEYS[1]) == 0 or redis.call(&#x27;hexists&#x27;,KEYS[1],ARGV[1]) == 1 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;hincrby&#x27;,KEYS[1],ARGV[1],1) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;expire&#x27;,KEYS[1],ARGV[2]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 1 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 0 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;lockName: &quot;</span> + lockName + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;uuidValue: &quot;</span> + uuidValue);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class), Collections.singletonList(lockName), uuidValue, String.valueOf(expireTime))) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">60</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        renewExpire();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;if redis.call(&#x27;HEXISTS&#x27;,KEYS[1],ARGV[1]) == 0 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return nil &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;elseif redis.call(&#x27;HINCRBY&#x27;,KEYS[1],ARGV[1],-1) == 0 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return redis.call(&#x27;del&#x27;,KEYS[1]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 0 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;lockName: &quot;</span> + lockName + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;uuidValue: &quot;</span> + uuidValue);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class), Collections.singletonList(lockName), uuidValue, String.valueOf(expireTime));</span><br><span class="line">        <span class="keyword">if</span> (flag == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;没有这个锁，HEXISTS查询无&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">renewExpire</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;if redis.call(&#x27;HEXISTS&#x27;,KEYS[1],ARGV[1]) == 1 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return redis.call(&#x27;expire&#x27;,KEYS[1],ARGV[2]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 0 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line"><span class="comment">//定时任务每隔10秒后执行一次</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Timer</span>().schedule(<span class="keyword">new</span> <span class="title class_">TimerTask</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Boolean.TRUE.equals(stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime)))) &#123;</span><br><span class="line">                    renewExpire();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,(<span class="built_in">this</span>.expireTime * <span class="number">1000</span>)/<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//=========================================================</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果！</p><p><img src="/hexo-docs/images/redisImages/image-20250711185139011.png" alt="image-20250711185139011"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol><li>第一版：<code>synchronized</code>单机版OK，上分布式死翘翘</li><li>第二版：<code>nginx</code>分布式微服务单机锁不行</li><li>第三版：取消单机锁改为上<code>redis</code>分布式锁<code>setnx</code><ol><li>只加了锁，没有释放锁，出异常的话，可能无法释放锁，必须要在代码层面<code>finally</code>释放锁</li><li>宕机了，部署了微服务代码层面根本没有走到<code>finally</code>这块，没办法保证解锁，这个<code>key</code>没有被删除，需要有<code>lockKey</code>的过期时间设定</li></ol></li><li>第四版：为<code>redis</code>的分布式锁<code>key</code>，增加过期时间，此外，还必须要<code>setnx</code>+过期时间必须同一行</li><li>第五版：必须规定只能删除自己的锁，不能删除别人的锁</li><li>第六版：<code>unlock</code>变为<code>lua</code>脚本保证</li><li>第七版：锁重入，<code>hset</code>替代<code>setnx</code>+<code>lock</code>变为<code>lua</code>脚本保证</li><li>第八版：自动续期</li></ol>]]></content>
      
      
      <categories>
          
          <category> 后端 Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>管道&amp;事务</title>
      <link href="/hexo-docs/2025/08/13/redis/transactions&amp;pipeline/"/>
      <url>/hexo-docs/2025/08/13/redis/transactions&amp;pipeline/</url>
      
        <content type="html"><![CDATA[<h2 id="Redis事务"><a href="#Redis事务" class="headerlink" title="Redis事务"></a>Redis事务</h2><p>可以一次执行多个命令，本质是一组命令的集合。一个事务中的所有命令都会序列化，<strong>按顺序地串行化而不会被其他命令插入，不许加塞</strong></p><p>能干嘛？</p><p>一个队列中，一次性、顺序性、排他性的执行一系列命令</p><h3 id="redis事务-vs-数据库事务"><a href="#redis事务-vs-数据库事务" class="headerlink" title="redis事务 vs 数据库事务"></a>redis事务 vs 数据库事务</h3><table><thead><tr><th>1 单独的隔离操作</th><th>Redis的事务仅仅是保证事务里的操作会被连续独占的执行，redis命令执行是单线程架构，在执行完事务内所有指令前是不可能再去同时执行其他客户端的请求的</th></tr></thead><tbody><tr><td>2 没有隔离级别的概念</td><td>因为事务提交前任何指令都不会被实际执行，也就不存在”事务内的查询要看到事务里的更新，在事务外查询不能看到”这种问题了</td></tr><tr><td>3不保证原子性</td><td>Redis的事务不保证原子性，也就是不保证所有指令同时成功或同时失败，只有决定是否开始执行全部指令的能力，没有执行到一半进行回滚的能力</td></tr><tr><td>4 排它性</td><td>Redis会保证一个事务内的命令依次执行，而不会被其它命令插入</td></tr></tbody></table><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><table><thead><tr><th align="center">序号</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">1</td><td align="center">discard：取消事务，放弃执行事务块内的所以命令</td></tr><tr><td align="center">2</td><td align="center">exec：执行所有事务块内的命令</td></tr><tr><td align="center">3</td><td align="center">multi：标记一个事务块的开始</td></tr><tr><td align="center">4</td><td align="center">unwatch：取消watch命令对所有key的监视</td></tr><tr><td align="center">5</td><td align="center">watch key [key….]：监视一个（或多个）key，如果在事务执行之前这个（或这些）key 被其他命令所改动，那么事务将被打断</td></tr></tbody></table><h3 id="正常执行-multi-开启事务-exec-执行事务"><a href="#正常执行-multi-开启事务-exec-执行事务" class="headerlink" title="正常执行(multi(开启事务)+exec(执行事务))"></a>正常执行(multi(开启事务)+exec(执行事务))</h3><p><img src="/hexo-docs/images/redisImages/image-20250415204940730.png" alt="image-20250415204940730"></p><h3 id="放弃事务-discard"><a href="#放弃事务-discard" class="headerlink" title="放弃事务(discard)"></a>放弃事务(discard)</h3><p><img src="/hexo-docs/images/redisImages/image-20250415205124361.png" alt="image-20250415205124361"></p><h3 id="在事务中数据报错都不会执行"><a href="#在事务中数据报错都不会执行" class="headerlink" title="在事务中数据报错都不会执行"></a>在事务中数据报错都不会执行</h3><p><img src="/hexo-docs/images/redisImages/image-20250415205319774.png" alt="image-20250415205319774"></p><h3 id="在事务中数据报错了，不影响别的数据执行"><a href="#在事务中数据报错了，不影响别的数据执行" class="headerlink" title="在事务中数据报错了，不影响别的数据执行"></a>在事务中数据报错了，不影响别的数据执行</h3><p><img src="/hexo-docs/images/redisImages/image-20250415205925403.png" alt="image-20250415205925403"></p><p>Redis不提供事务回滚的功能，开发者必须在事务执行出错后，自行恢复数据库状态</p><blockquote><p>注意：</p><p>​<code>redis</code>事务和传统数据库事务区别，不一定要么一起成功要么一起失败</p></blockquote><h3 id="监控（watch）"><a href="#监控（watch）" class="headerlink" title="监控（watch）"></a>监控（watch）</h3><p><code>redis</code>使用watch来提供乐观锁定，类似与<code>CAS</code>（<code>check-and-set</code>）</p><ul><li>悲观锁：<ul><li>悲观锁(Pessimistic Lock), 顾名思义，就是很悲观，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会block直到它拿到锁。</li></ul></li><li>乐观锁：<ul><li>乐观锁(Optimistic Lock), 顾名思义，就是很乐观，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据。</li><li>乐观锁策略:提交版本必须  大于  记录当前版本才能执行更新</li></ul></li><li>CAS：<ul><li>在 Redis 中，CAS（Check-And-Set）是一种使用乐观锁来保证数据一致性的方法。它的基本思想是：在执行某个操作之前，先检查数据是否被其他客户端修改过，如果没有，则执行操作；如果有，则放弃操作并重试。</li></ul></li></ul><p>watch：初始化 k1 和 balance 两个 key，先监控在开启 <code>multi</code>，保证两 key 变动在同一事务内</p><p><img src="/hexo-docs/images/redisImages/image-20250415210930539.png" alt="image-20250415210930539"></p><p>有加塞篡改</p><p><img src="/hexo-docs/images/redisImages/image-20250415211255820.png" alt="image-20250415211255820"></p><h3 id="unwatch"><a href="#unwatch" class="headerlink" title="unwatch"></a>unwatch</h3><p>用于取消 WATCH 命令对所有 key 的监视。</p><p><img src="/hexo-docs/images/redisImages/image-20250415211808180.png" alt="image-20250415211808180"></p><p>一旦执行了exec之前加的监控锁都会被取消掉了</p><p>当客户端连接丢失的时候（比如退出链接），所有东西都会被取消监视</p><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul><li>开启：以 <code>multi</code>开始一个事务</li><li>入队：将多个命令入队到事务中，接到这些命令并不会立即执行，而是放到等待执行的事务队列里面</li><li>执行：由<code>exec</code>命令触发事务</li></ul><h2 id="Redis管道-Pipeline"><a href="#Redis管道-Pipeline" class="headerlink" title="Redis管道(Pipeline)"></a>Redis管道(Pipeline)</h2><p>Redis是一种基于客户端-服务端模型以及请求&#x2F;响应协议的TCP服务。一个请求会遵循以下步骤：</p><p>1 客户端向服务端发送命令分四步(发送命令→命令排队→命令执行→返回结果)，并监听Socket返回，通常以阻塞模式等待服务端响应。</p><p>2 服务端处理命令，并将结果返回给客户端。</p><p><strong>上述两步称为：Round Trip Time(简称RTT,数据包往返于两端的时间)，问题笔记最下方</strong></p><p><img src="/hexo-docs/images/redisImages/image-20250415214547842.png" alt="image-20250415214547842"></p><p>如果同时需要执行大量的命令，那么就要等待上一条命令应答后再执行，这中间不仅仅多了RTT（Round Time Trip），而且还频繁调用系统IO，发送网络请求，同时需要redis调用多次read()和write()系统方法，系统方法会将数据从用户态转移到内核态，这样就会对进程上下文有比较大的影响了，性能不太好，o(╥﹏╥)o</p><p>管道是什么？</p><ul><li>Pipline 是为了解决 RTT 往返回时，仅仅是将命令一次性发送，对整个 Redis 的执行不造成其他任何影响</li></ul><p>一句话：</p><ul><li>批处理命令变化优化措施，类似 Redis 的原生批命令（mset和mget）</li></ul><h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p><img src="/hexo-docs/images/redisImages/image-20250415220303463.png" alt="image-20250415220303463"></p><p><img src="/hexo-docs/images/redisImages/image-20250415220543199.png" alt="image-20250415220543199"></p><p><strong>一定要在 redis 外面执行</strong></p><p><img src="/hexo-docs/images/redisImages/image-20250415220620665.png" alt="image-20250415220620665"></p><h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><p>事务的原子性</p><ul><li>原子性（Atomicity）<br>原子性是指事务包含的所有操作要么全部成功，要么全部失败回滚，因此事务的操作如果成功就必须要完全应用到数据库，如果操作失败则不能对数据库有任何影响。</li><li>一致性（Consistency）<br>事务开始前和结束后，数据库的完整性约束没有被破坏。比如A向B转账，不可能A扣了钱，B却没收到。</li><li>隔离性（Isolation）<br>隔离性是当多个用户并发访问数据库时，比如操作同一张表时，数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，多个并发事务之间要相互隔离。<br>同一时间，只允许一个事务请求同一数据，不同的事务之间彼此没有任何干扰。比如A正在从一张银行卡中取钱，在A取钱的过程结束前，B不能向这张卡转账。 </li><li>持久性（Durability）<br>持久性是指一个事务一旦被提交了，那么对数据库中的数据的改变就是永久性的，即便是在数据库系统遇到故障的情况下也不会丢失提交事务的操作。</li></ul><p>Pipeline与原生批处理命令对比</p><ul><li>原生批量命令是原子性（例如：mset、mget），pipeline 是非原子性</li><li>原生批量命令一次只能执行一种命令，pipeline支持批量执行不同命令</li><li>原生批命令是服务端实现的，而pipeline需要服务端与客户端共同完成</li></ul><p>Pipeline 与事务对比</p><ul><li>事务具有原子性，管道不具有原子性</li><li>管道一次性将多个命令发送到服务器，事务是一条一条的发，事务只有在接收到exec命令后才会执行，管道不会</li><li>执行事务时会阻塞其他命令的执行，而执行管道中的命令时不会</li></ul><p>使用Pipeline注意事项</p><ul><li>pipeline 缓冲的指令只是会依次执行，不保证原子性，如果执行中指令发送异常，将会继续执行后续的指令</li><li>使用 pipeline 组装的命令个数不能太多，不然数据量过大客户端阻塞的时间可能过久，同时服务端此时也被迫回复一个队列答复，占用很多内存。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 后端 Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>哨兵&amp;集群</title>
      <link href="/hexo-docs/2025/08/13/redis/sentinel&amp;cluster/"/>
      <url>/hexo-docs/2025/08/13/redis/sentinel&amp;cluster/</url>
      
        <content type="html"><![CDATA[<h1 id="哨兵（sentinel）-集群（cluster）"><a href="#哨兵（sentinel）-集群（cluster）" class="headerlink" title="哨兵（sentinel）&amp;集群（cluster）"></a>哨兵（sentinel）&amp;集群（cluster）</h1><h2 id="哨兵（sentinel）"><a href="#哨兵（sentinel）" class="headerlink" title="哨兵（sentinel）"></a>哨兵（sentinel）</h2><p>吹哨人巡查监控后台master主机是否故障，如果故障了根据<strong>投票数</strong>自动将某一个从库转换为新主库，继续对外服务</p><p>作用</p><ol><li>监控redis运行状态，包括master和slave</li><li><strong>当master down机，能自动将slave切换成新master</strong></li></ol><p><img src="/hexo-docs/images/redisImages/image-20250419141201643.png" alt="image-20250419141201643"></p><p>Redis Sentinel是Redis 的高可用性解决方案，由一个或多个Sentinel（哨兵）实例组成。它可以监视任意多个主服务器，以及这些主服务器属下的所有从服务器，并在被监视的主服务器进入下线状态时，自动将下线主服务器属下的某个从服务器升级为新的主服务器，它的主要功能如下：</p><ol><li><p>主从监控</p><p>Sentinel会不断地检查你的主服务器和从服务器是否运作正常。</p></li><li><p>消息通知</p><p>当被监控的某个 Redis 服务器出现问题时， Sentinel可以通过API向管理员或者其他应用程序发送通知。</p></li><li><p>故障转移</p><p>如果master异常，则会进行主从切换，将其中一个slave作为新master，当主服务器不能正常工作时，Sentinel会自动进行故障迁移，也就是主从切换。</p></li><li><p>配置中心</p><p>客户端通过连接哨兵来获得当前redis服务的主节点地址</p></li></ol><h2 id="哨兵原理"><a href="#哨兵原理" class="headerlink" title="哨兵原理"></a>哨兵原理</h2><p>Sentinel 使用的算法核心是 Raft 算法，主要用途就是用于分布式系统，系统容错，以及Leader选举，每个Sentinel都需要定期的执行以下任务：</p><ul><li>每个 Sentinel 会自动发现其他 Sentinel 和从服务器，它以每秒钟一次的频率向它所知的主服务器、从服务器以及其他 Sentinel 实例发送一个 PING 命令。</li><li>如果一个实例（instance）距离最后一次有效回复 PING 命令的时间超过 down-after-milliseconds 选项所指定的值， 那么这个实例会被 Sentinel 标记为主观下线。 有效回复可以是： +PONG 、 -LOADING 或者 -MASTERDOWN 。</li><li>如果一个主服务器被标记为主观下线， 那么正在监视这个主服务器的所有Sentinel要以每秒一次的频率确认主服务器的确进入了主观下线状态。</li><li>如果一个主服务器被标记为主观下线， 并且有足够数量的Sentinel（至少要达到配置文件指定的数量）在指定的时间范围内同意这一判断， 那么这个主服务器被标记为客观下线。</li><li>在一般情况下， 每个Sentinel会以每 10 秒一次的频率向它已知的所有主服务器和从服务器发送 INFO 命令。 当一个主服务器被Sentinel标记为客观下线时，Sentinel向下线主服务器的所有从服务器发送 INFO 命令的频率会从 10 秒一次改为每秒一次。</li><li>当没有足够数量的Sentinel同意主服务器已经下线， 主服务器的客观下线状态就会被移除。 当主服务器重新向Sentinel的 PING 命令返回有效回复时， 主服务器的主管下线状态就会被移除.</li></ul><p><img src="/hexo-docs/images/redisImages/image-20250419144503922.png" alt="image-20250419144503922"></p><h2 id="sentinel配置文件"><a href="#sentinel配置文件" class="headerlink" title="sentinel配置文件"></a>sentinel配置文件</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"># 哨兵sentinel实例运行的端口，默认<span class="number">26379</span>  </span><br><span class="line">port <span class="number">26379</span></span><br><span class="line"># 是否设置为后台启动。</span><br><span class="line">daemonize no</span><br><span class="line">#pid文件地址</span><br><span class="line">pidfile /var/run/redis-sentinel.pid</span><br><span class="line">#日志文件地址</span><br><span class="line">logfile &quot;&quot;</span><br><span class="line"># 指定sentinel工作目录</span><br><span class="line"><span class="built_in">dir</span> /tmp</span><br><span class="line"># 哨兵sentinel监控的redis主节点的 </span><br><span class="line">## ip：主机ip地址</span><br><span class="line">## port：哨兵端口号</span><br><span class="line">## master-name：可以自己命名的主节点名字（只能由字母A-z、数字<span class="number">0</span>-<span class="number">9</span> 、这三个字符&quot;.-_&quot;组成。）</span><br><span class="line">## quorum：当这些quorum个数sentinel哨兵认为master主节点失联 那么这时 客观上认为主节点失联了  </span><br><span class="line"># sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;  </span><br><span class="line">sentinel monitor mymaster <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> <span class="number">6379</span> <span class="number">2</span></span><br><span class="line"># 指定主节点应答哨兵sentinel的最大时间间隔，超过这个时间，哨兵主观上认为主节点下线，默认<span class="number">30</span>秒  </span><br><span class="line"># sentinel auth-pass &lt;master-name&gt; &lt;password&gt;  </span><br><span class="line">sentinel down-after-milliseconds mymaster <span class="number">30000</span></span><br><span class="line">acllog-max-len <span class="number">128</span></span><br><span class="line"># 指定了在发生failover主备切换时，最多可以有多少个slave同时对新的master进行同步。这个数字越小，完成failover所需的时间就越长；反之，但是如果这个数字越大，就意味着越多的slave因为replication而不可用。可以通过将这个值设为<span class="number">1</span>，来保证每次只有一个slave，处于不能处理命令请求的状态。</span><br><span class="line"># sentinel parallel-syncs &lt;master-name&gt; &lt;numslaves&gt;</span><br><span class="line">sentinel parallel-syncs mymaster <span class="number">1</span></span><br><span class="line"># 故障转移的超时时间failover-timeout，默认三分钟，可以用在以下这些方面：</span><br><span class="line">## <span class="number">1</span>. 同一个sentinel对同一个master两次failover之间的间隔时间。  </span><br><span class="line">## <span class="number">2</span>. 当一个slave从一个错误的master那里同步数据时开始，直到slave被纠正为从正确的master那里同步数据时结束。  </span><br><span class="line">## <span class="number">3</span>. 当想要取消一个正在进行的failover时所需要的时间。</span><br><span class="line">## <span class="number">4</span>.当进行failover时，配置所有slaves指向新的master所需的最大时间。不过，即使过了这个超时，slaves依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来同步数据了</span><br><span class="line"># sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;  </span><br><span class="line">sentinel failover-timeout mymaster <span class="number">180000</span></span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br><span class="line">SENTINEL resolve-hostnames no</span><br><span class="line">SENTINEL announce-hostnames no</span><br></pre></td></tr></table></figure><p>重点参数</p><ol><li><p>bind</p><p>服务监听地址，用于客户端连接，默认本机地址</p></li><li><p>daemonize</p><p>是否以后台damon方式运行</p></li><li><p>protected-mode</p><p>安全保护模式</p></li><li><p>port</p><p>端口</p></li><li><p>logfile</p><p>日志文件路径</p></li><li><p>pidfile</p><p>pid文件路径</p></li><li><p>dir</p><p>工作目录</p></li><li><p>sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</p><ol><li>设置要监控的master服务器</li><li>quorum表示最少有几个哨兵认可客观下线，同意故障迁移的法定票数。</li></ol></li><li><p>sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</p><p>master设置了密码，连接master服务的密码</p></li><li><p>其他参数（默认就行）</p><ol><li><p>sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;：</p><p>指定多少毫秒之后，主节点没有应答哨兵，此时哨兵主观上认为主节点下线</p></li><li><p>sentinel parallel-syncs &lt;master-name&gt; &lt;nums&gt;：</p><p>表示允许并行同步的slave个数，当Master挂了后，哨兵会选出新的Master，此时，剩余的slave会向新的master发起同步数据</p></li><li><p>sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;：</p><p>故障转移的超时时间，进行故障转移时，如果超过设置的毫秒，表示故障转移失败</p></li><li><p>sentinel notification-script &lt;master-name&gt; &lt;script-path&gt; ：</p><p>配置当某一事件发生时所需要执行的脚本</p></li><li><p>sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;：</p><p>客户端重新配置主节点参数脚本</p></li></ol></li></ol><p>示例：</p><p>三个哨兵实例需要三台虚拟机，考虑到机器性能有限，这里将三个哨兵实例配置到一台虚拟机上，配置三份不同的哨兵配置文件即可：sentinel26379.conf、sentinel26380.conf、sentinel26381.conf，将它们存放到&#x2F;myredis下。</p><p>&#x2F;myredi目录下新建或者拷贝<code>sentinel.conf</code>文件，名字不能错，如果没有则新建文件</p><p><code>sentinel.conf</code>文件</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"># Example sentinel.conf</span><br><span class="line"></span><br><span class="line"># By default protected <span class="built_in">mode</span> is disabled <span class="keyword">in</span> sentinel <span class="built_in">mode</span>. Sentinel is reachable</span><br><span class="line"># from interfaces different than localhost. Make sure the sentinel instance is</span><br><span class="line"># protected from the outside world via firewalling or other means.</span><br><span class="line">protected-<span class="built_in">mode</span> no</span><br><span class="line"></span><br><span class="line"># port &lt;sentinel-port&gt;</span><br><span class="line"># The port that this sentinel instance will run on</span><br><span class="line">port <span class="number">26379</span></span><br><span class="line"></span><br><span class="line"># By default Redis Sentinel does <span class="keyword">not</span> run as a daemon. Use &#x27;yes&#x27; <span class="keyword">if</span> you need it.</span><br><span class="line"># Note that Redis will write a pid file <span class="keyword">in</span> /var/run/redis-sentinel.pid when</span><br><span class="line"># daemonized.</span><br><span class="line">daemonize no</span><br><span class="line"></span><br><span class="line"># When running daemonized, Redis Sentinel writes a pid file <span class="keyword">in</span></span><br><span class="line"># /var/run/redis-sentinel.pid by default. You can specify a custom pid file</span><br><span class="line"># location here.</span><br><span class="line">pidfile /var/run/redis-sentinel.pid</span><br><span class="line"></span><br><span class="line"># Specify the server verbosity level.</span><br><span class="line"># This can be one of:</span><br><span class="line"># debug (a lot of information, useful <span class="keyword">for</span> development/testing)</span><br><span class="line"># verbose (many rarely useful info, but <span class="keyword">not</span> a mess like the debug level)</span><br><span class="line"># notice (moderately verbose, what you want <span class="keyword">in</span> production probably)</span><br><span class="line"># warning (only very important / critical messages are logged)</span><br><span class="line"># nothing (nothing is logged)</span><br><span class="line">loglevel notice</span><br><span class="line"></span><br><span class="line"># Specify the log file name. Also the empty string can be used to force</span><br><span class="line"># Sentinel to log on the standard output. Note that <span class="keyword">if</span> you use standard</span><br><span class="line"># output <span class="keyword">for</span> logging but daemonize, logs will be sent to /dev/null</span><br><span class="line">logfile &quot;&quot;</span><br><span class="line"></span><br><span class="line"># To enable logging to the system logger, just <span class="built_in">set</span> &#x27;syslog-enabled&#x27; to yes,</span><br><span class="line"># and optionally update the other syslog parameters to suit your needs.</span><br><span class="line"># syslog-enabled no</span><br><span class="line"></span><br><span class="line"># Specify the syslog identity.</span><br><span class="line"># syslog-ident sentinel</span><br><span class="line"></span><br><span class="line"># Specify the syslog facility. Must be USER or between LOCAL0-LOCAL7.</span><br><span class="line"># syslog-facility local0</span><br><span class="line"></span><br><span class="line"># sentinel announce-ip &lt;ip&gt;</span><br><span class="line"># sentinel announce-port &lt;port&gt;</span><br><span class="line">#</span><br><span class="line"># The above two configuration directives are useful <span class="keyword">in</span> environments where,</span><br><span class="line"># because of NAT, Sentinel is reachable from outside via a non-local address.</span><br><span class="line">#</span><br><span class="line"># When announce-ip is provided, the Sentinel will claim the specified IP address</span><br><span class="line"># <span class="keyword">in</span> HELLO messages used to gossip its presence, instead of auto-detecting the</span><br><span class="line"># local address as it usually does.</span><br><span class="line">#</span><br><span class="line"># Similarly when announce-port is provided and is valid and non-zero, Sentinel</span><br><span class="line"># will announce the specified TCP port.</span><br><span class="line">#</span><br><span class="line"># The two options don&#x27;t need to be used together, <span class="keyword">if</span> only announce-ip is</span><br><span class="line"># provided, the Sentinel will announce the specified IP and the server port</span><br><span class="line"># as specified by the &quot;port&quot; option. <span class="keyword">If</span> only announce-port is provided, the</span><br><span class="line"># Sentinel will announce the auto-detected local IP and the specified port.</span><br><span class="line">#</span><br><span class="line"># Example:</span><br><span class="line">#</span><br><span class="line"># sentinel announce-ip <span class="number">1</span>.<span class="number">2</span>.<span class="number">3</span>.<span class="number">4</span></span><br><span class="line"></span><br><span class="line"># <span class="built_in">dir</span> &lt;working-directory&gt;</span><br><span class="line"># Every long running process should have a well-<span class="keyword">defined</span> working directory.</span><br><span class="line"># <span class="keyword">For</span> Redis Sentinel to <span class="built_in">chdir</span> to /tmp <span class="built_in">at</span> startup is the simplest thing</span><br><span class="line"># <span class="keyword">for</span> the process to don&#x27;t interfere with administrative tasks such as</span><br><span class="line"># unmounting filesystems.</span><br><span class="line"><span class="built_in">dir</span> /tmp</span><br><span class="line"></span><br><span class="line"># sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span><br><span class="line">#</span><br><span class="line"># Tells Sentinel to monitor this master, and to consider it <span class="keyword">in</span> O_DOWN</span><br><span class="line"># (Objectively Down) state only <span class="keyword">if</span> <span class="built_in">at</span> least &lt;quorum&gt; sentinels agree.</span><br><span class="line">#</span><br><span class="line"># Note that whatever is the ODOWN quorum, a Sentinel will require to</span><br><span class="line"># be elected by the majority of the known Sentinels <span class="keyword">in</span> order to</span><br><span class="line"># <span class="built_in">start</span> a failover, so no failover can be performed <span class="keyword">in</span> minority.</span><br><span class="line">#</span><br><span class="line"># Replicas are auto-discovered, so you don&#x27;t need to specify replicas <span class="keyword">in</span></span><br><span class="line"># any way. Sentinel itself will rewrite this configuration file adding</span><br><span class="line"># the replicas using additional configuration options.</span><br><span class="line"># Also note that the configuration file is rewritten when a</span><br><span class="line"># replica is promoted to master.</span><br><span class="line">#</span><br><span class="line"># Note: master name should <span class="keyword">not</span> include special characters or spaces.</span><br><span class="line"># The valid charset is A-z <span class="number">0</span>-<span class="number">9</span> and the three characters &quot;.-_&quot;.</span><br><span class="line">sentinel monitor mymaster <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> <span class="number">6379</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"># sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</span><br><span class="line">#</span><br><span class="line"># <span class="built_in">Set</span> the password to use to authenticate with the master and replicas.</span><br><span class="line"># Useful <span class="keyword">if</span> there is a password <span class="built_in">set</span> <span class="keyword">in</span> the Redis instances to monitor.</span><br><span class="line">#</span><br><span class="line"># Note that the master password is also used <span class="keyword">for</span> replicas, so it is <span class="keyword">not</span></span><br><span class="line"># possible to <span class="built_in">set</span> a different password <span class="keyword">in</span> masters and replicas instances</span><br><span class="line"># <span class="keyword">if</span> you want to be able to monitor these instances with Sentinel.</span><br><span class="line">#</span><br><span class="line"># However you can have Redis instances without the authentication enabled</span><br><span class="line"># mixed with Redis instances requiring the authentication (as long as the</span><br><span class="line"># password <span class="built_in">set</span> is the same <span class="keyword">for</span> all the instances requiring the password) as</span><br><span class="line"># the AUTH command will have no effect <span class="keyword">in</span> Redis instances with authentication</span><br><span class="line"># switched off.</span><br><span class="line">#</span><br><span class="line"># Example:</span><br><span class="line">#</span><br><span class="line"># sentinel auth-pass mymaster MySUPER--secret-<span class="number">0123</span>passw0rd</span><br><span class="line"></span><br><span class="line"># sentinel auth-user &lt;master-name&gt; &lt;username&gt;</span><br><span class="line">#</span><br><span class="line"># This is useful <span class="keyword">in</span> order to authenticate to instances having ACL capabilities,</span><br><span class="line"># that is, running Redis <span class="number">6</span>.<span class="number">0</span> or greater. When just auth-pass is provided the</span><br><span class="line"># Sentinel instance will authenticate to Redis using the old &quot;AUTH &lt;pass&gt;&quot;</span><br><span class="line"># method. When also an username is provided, it will use &quot;AUTH &lt;user&gt; &lt;pass&gt;&quot;.</span><br><span class="line"># <span class="keyword">In</span> the Redis servers side, the ACL to provide just minimal access to</span><br><span class="line"># Sentinel instances, should be configured along the following lines:</span><br><span class="line">#</span><br><span class="line">#     user sentinel-user &gt;somepassword +client +subscribe +publish \</span><br><span class="line">#                        +<span class="built_in">ping</span> +info +multi +slaveof +config +client +exec on</span><br><span class="line"></span><br><span class="line"># sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;</span><br><span class="line">#</span><br><span class="line"># Number of milliseconds the master (or any attached replica or sentinel) should</span><br><span class="line"># be unreachable (as <span class="keyword">in</span>, <span class="keyword">not</span> acceptable reply to <span class="built_in">PING</span>, continuously, <span class="keyword">for</span> the</span><br><span class="line"># specified period) <span class="keyword">in</span> order to consider it <span class="keyword">in</span> S_DOWN state (Subjectively</span><br><span class="line"># Down).</span><br><span class="line">#</span><br><span class="line"># Default is <span class="number">30</span> seconds.</span><br><span class="line">sentinel down-after-milliseconds mymaster <span class="number">30000</span></span><br><span class="line"></span><br><span class="line"># IMPORTANT NOTE: starting with Redis <span class="number">6</span>.<span class="number">2</span> ACL capability is supported <span class="keyword">for</span></span><br><span class="line"># Sentinel <span class="built_in">mode</span>, please refer to the Redis website https://redis.io/topics/acl</span><br><span class="line"># <span class="keyword">for</span> <span class="built_in">more</span> details.</span><br><span class="line"></span><br><span class="line"># Sentinel&#x27;s ACL users are <span class="keyword">defined</span> <span class="keyword">in</span> the following <span class="built_in">format</span>:</span><br><span class="line">#</span><br><span class="line">#   user &lt;username&gt; ... acl rules ...</span><br><span class="line">#</span><br><span class="line"># <span class="keyword">For</span> example:</span><br><span class="line">#</span><br><span class="line">#   user worker +@admin +@connection ~* on &gt;ffa9203c493aa99</span><br><span class="line">#</span><br><span class="line"># <span class="keyword">For</span> <span class="built_in">more</span> information about ACL configuration please refer to the Redis</span><br><span class="line"># website <span class="built_in">at</span> https://redis.io/topics/acl and redis server configuration </span><br><span class="line"># template redis.conf.</span><br><span class="line"></span><br><span class="line"># ACL LOG</span><br><span class="line">#</span><br><span class="line"># The ACL Log tracks failed commands and authentication events associated</span><br><span class="line"># with ACLs. The ACL Log is useful to troubleshoot failed commands blocked </span><br><span class="line"># by ACLs. The ACL Log is stored <span class="keyword">in</span> memory. You can reclaim memory with </span><br><span class="line"># ACL LOG RESET. Define the maximum entry length of the ACL Log below.</span><br><span class="line">acllog-max-len <span class="number">128</span></span><br><span class="line"></span><br><span class="line"># Using an external ACL file</span><br><span class="line">#</span><br><span class="line"># Instead of configuring users here <span class="keyword">in</span> this file, it is possible to use</span><br><span class="line"># a stand-alone file just listing users. The two methods cannot be mixed:</span><br><span class="line"># <span class="keyword">if</span> you configure users here and <span class="built_in">at</span> the same <span class="built_in">time</span> you activate the external</span><br><span class="line"># ACL file, the server will refuse to <span class="built_in">start</span>.</span><br><span class="line">#</span><br><span class="line"># The <span class="built_in">format</span> of the external ACL user file is exactly the same as the</span><br><span class="line"># <span class="built_in">format</span> that is used inside redis.conf to describe users.</span><br><span class="line">#</span><br><span class="line"># aclfile /etc/redis/sentinel-users.acl</span><br><span class="line"></span><br><span class="line"># requirepass &lt;password&gt;</span><br><span class="line">#</span><br><span class="line"># You can configure Sentinel itself to require a password, however when doing</span><br><span class="line"># so Sentinel will try to authenticate with the same password to all the</span><br><span class="line"># other Sentinels. So you need to configure all your Sentinels <span class="keyword">in</span> a given</span><br><span class="line"># group with the same &quot;requirepass&quot; password. Check the following documentation</span><br><span class="line"># <span class="keyword">for</span> <span class="built_in">more</span> info: https://redis.io/topics/sentinel</span><br><span class="line">#</span><br><span class="line"># IMPORTANT NOTE: starting with Redis <span class="number">6</span>.<span class="number">2</span> &quot;requirepass&quot; is a compatibility</span><br><span class="line"># layer on top of the ACL system. The option effect will be just setting</span><br><span class="line"># the password <span class="keyword">for</span> the default user. Clients will still authenticate using</span><br><span class="line"># AUTH &lt;password&gt; as usually, or <span class="built_in">more</span> explicitly with AUTH default &lt;password&gt;</span><br><span class="line"># <span class="keyword">if</span> they follow the new protocol: both will work.</span><br><span class="line">#</span><br><span class="line"># New config files are advised to use separate authentication control <span class="keyword">for</span></span><br><span class="line"># incoming connections (via ACL), and <span class="keyword">for</span> outgoing connections (via</span><br><span class="line"># sentinel-user and sentinel-pass) </span><br><span class="line">#</span><br><span class="line"># The requirepass is <span class="keyword">not</span> compatible with aclfile option and the ACL LOAD</span><br><span class="line"># command, these will cause requirepass to be ignored.</span><br><span class="line"></span><br><span class="line"># sentinel sentinel-user &lt;username&gt;</span><br><span class="line">#</span><br><span class="line"># You can configure Sentinel to authenticate with other Sentinels with specific</span><br><span class="line"># user name. </span><br><span class="line"></span><br><span class="line"># sentinel sentinel-pass &lt;password&gt;</span><br><span class="line">#</span><br><span class="line"># The password <span class="keyword">for</span> Sentinel to authenticate with other Sentinels. <span class="keyword">If</span> sentinel-user</span><br><span class="line"># is <span class="keyword">not</span> configured, Sentinel will use &#x27;default&#x27; user with sentinel-pass to authenticate.</span><br><span class="line"></span><br><span class="line"># sentinel parallel-syncs &lt;master-name&gt; &lt;numreplicas&gt;</span><br><span class="line">#</span><br><span class="line"># How many replicas we can reconfigure to point to the new replica simultaneously</span><br><span class="line"># during the failover. Use a low number <span class="keyword">if</span> you use the replicas to serve query</span><br><span class="line"># to avoid that all the replicas will be unreachable <span class="built_in">at</span> about the same</span><br><span class="line"># <span class="built_in">time</span> while performing the synchronization with the master.</span><br><span class="line">sentinel parallel-syncs mymaster <span class="number">1</span></span><br><span class="line"></span><br><span class="line"># sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;</span><br><span class="line">#</span><br><span class="line"># Specifies the failover timeout <span class="keyword">in</span> milliseconds. It is used <span class="keyword">in</span> many ways:</span><br><span class="line">#</span><br><span class="line"># - The <span class="built_in">time</span> needed to re-<span class="built_in">start</span> a failover after a previous failover was</span><br><span class="line">#   already tried against the same master by a given Sentinel, is two</span><br><span class="line">#   times the failover timeout.</span><br><span class="line">#</span><br><span class="line"># - The <span class="built_in">time</span> needed <span class="keyword">for</span> a replica replicating to a wrong master according</span><br><span class="line">#   to a Sentinel current configuration, to be forced to replicate</span><br><span class="line">#   with the right master, is exactly the failover timeout (counting since</span><br><span class="line">#   the moment a Sentinel detected the misconfiguration).</span><br><span class="line">#</span><br><span class="line"># - The <span class="built_in">time</span> needed to cancel a failover that is already <span class="keyword">in</span> progress but</span><br><span class="line">#   did <span class="keyword">not</span> produced any configuration change (SLAVEOF NO ONE yet <span class="keyword">not</span></span><br><span class="line">#   acknowledged by the promoted replica).</span><br><span class="line">#</span><br><span class="line"># - The maximum <span class="built_in">time</span> a failover <span class="keyword">in</span> progress waits <span class="keyword">for</span> all the replicas to be</span><br><span class="line">#   reconfigured as replicas of the new master. However even after this <span class="built_in">time</span></span><br><span class="line">#   the replicas will be reconfigured by the Sentinels anyway, but <span class="keyword">not</span> with</span><br><span class="line">#   the exact parallel-syncs progression as specified.</span><br><span class="line">#</span><br><span class="line"># Default is <span class="number">3</span> minutes.</span><br><span class="line">sentinel failover-timeout mymaster <span class="number">180000</span></span><br><span class="line"></span><br><span class="line"># SCRIPTS EXECUTION</span><br><span class="line">#</span><br><span class="line"># sentinel notification-script and sentinel reconfig-script are used <span class="keyword">in</span> order</span><br><span class="line"># to configure scripts that are called to notify the system administrator</span><br><span class="line"># or to reconfigure clients after a failover. The scripts are executed</span><br><span class="line"># with the following rules <span class="keyword">for</span> error handling:</span><br><span class="line">#</span><br><span class="line"># <span class="keyword">If</span> script exits with &quot;<span class="number">1</span>&quot; the execution is retried later (up to a maximum</span><br><span class="line"># number of times currently <span class="built_in">set</span> to <span class="number">10</span>).</span><br><span class="line">#</span><br><span class="line"># <span class="keyword">If</span> script exits with &quot;<span class="number">2</span>&quot; (or an higher value) the script execution is</span><br><span class="line"># <span class="keyword">not</span> retried.</span><br><span class="line">#</span><br><span class="line"># <span class="keyword">If</span> script terminates because it receives a signal the behavior is the same</span><br><span class="line"># as <span class="keyword">exit</span> code <span class="number">1</span>.</span><br><span class="line">#</span><br><span class="line"># A script has a maximum running <span class="built_in">time</span> of <span class="number">60</span> seconds. After this limit is</span><br><span class="line"># reached the script is terminated with a SIGKILL and the execution retried.</span><br><span class="line"></span><br><span class="line"># NOTIFICATION SCRIPT</span><br><span class="line">#</span><br><span class="line"># sentinel notification-script &lt;master-name&gt; &lt;script-<span class="built_in">path</span>&gt;</span><br><span class="line"># </span><br><span class="line"># <span class="keyword">Call</span> the specified notification script <span class="keyword">for</span> any sentinel event that is</span><br><span class="line"># generated <span class="keyword">in</span> the WARNING level (<span class="keyword">for</span> instance -sdown, -odown, and so forth).</span><br><span class="line"># This script should notify the system administrator via email, SMS, or any</span><br><span class="line"># other messaging system, that there is something wrong with the monitored</span><br><span class="line"># Redis systems.</span><br><span class="line">#</span><br><span class="line"># The script is called with just two arguments: the first is the event <span class="built_in">type</span></span><br><span class="line"># and the second the event description.</span><br><span class="line">#</span><br><span class="line"># The script must <span class="keyword">exist</span> and be executable <span class="keyword">in</span> order <span class="keyword">for</span> sentinel to <span class="built_in">start</span> <span class="keyword">if</span></span><br><span class="line"># this option is provided.</span><br><span class="line">#</span><br><span class="line"># Example:</span><br><span class="line">#</span><br><span class="line"># sentinel notification-script mymaster /var/redis/notify.sh</span><br><span class="line"></span><br><span class="line"># CLIENTS RECONFIGURATION SCRIPT</span><br><span class="line">#</span><br><span class="line"># sentinel client-reconfig-script &lt;master-name&gt; &lt;script-<span class="built_in">path</span>&gt;</span><br><span class="line">#</span><br><span class="line"># When the master changed because of a failover a script can be called <span class="keyword">in</span></span><br><span class="line"># order to perform application-specific tasks to notify the clients that the</span><br><span class="line"># configuration has changed and the master is <span class="built_in">at</span> a different address.</span><br><span class="line"># </span><br><span class="line"># The following arguments are passed to the script:</span><br><span class="line">#</span><br><span class="line"># &lt;master-name&gt; &lt;role&gt; &lt;state&gt; &lt;from-ip&gt; &lt;from-port&gt; &lt;to-ip&gt; &lt;to-port&gt;</span><br><span class="line">#</span><br><span class="line"># &lt;state&gt; is currently always &quot;<span class="built_in">start</span>&quot;</span><br><span class="line"># &lt;role&gt; is either &quot;leader&quot; or &quot;observer&quot;</span><br><span class="line"># </span><br><span class="line"># The arguments from-ip, from-port, to-ip, to-port are used to communicate</span><br><span class="line"># the old address of the master and the new address of the elected replica</span><br><span class="line"># (now a master).</span><br><span class="line">#</span><br><span class="line"># This script should be resistant to multiple invocations.</span><br><span class="line">#</span><br><span class="line"># Example:</span><br><span class="line">#</span><br><span class="line"># sentinel client-reconfig-script mymaster /var/redis/reconfig.sh</span><br><span class="line"></span><br><span class="line"># SECURITY</span><br><span class="line">#</span><br><span class="line"># By default SENTINEL <span class="built_in">SET</span> will <span class="keyword">not</span> be able to change the notification-script</span><br><span class="line"># and client-reconfig-script <span class="built_in">at</span> runtime. This avoids a trivial security issue</span><br><span class="line"># where clients can <span class="built_in">set</span> the script to anything and trigger a failover <span class="keyword">in</span> order</span><br><span class="line"># to get the program executed.</span><br><span class="line"></span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br><span class="line"></span><br><span class="line"># REDIS COMMANDS RENAMING (DEPRECATED)</span><br><span class="line">#</span><br><span class="line"># WARNING: avoid using this option <span class="keyword">if</span> possible, instead use ACLs.</span><br><span class="line">#</span><br><span class="line"># Sometimes the Redis server has certain commands, that are needed <span class="keyword">for</span> Sentinel</span><br><span class="line"># to work correctly, renamed to unguessable strings. This is often the case</span><br><span class="line"># of CONFIG and SLAVEOF <span class="keyword">in</span> the context of providers that provide Redis as</span><br><span class="line"># a service, and don&#x27;t want the customers to reconfigure the instances outside</span><br><span class="line"># of the administration console.</span><br><span class="line">#</span><br><span class="line"># <span class="keyword">In</span> such case it is possible to tell Sentinel to use different command names</span><br><span class="line"># instead of the normal ones. <span class="keyword">For</span> example <span class="keyword">if</span> the master &quot;mymaster&quot;, and the</span><br><span class="line"># associated replicas, have &quot;CONFIG&quot; all renamed to &quot;GUESSME&quot;, I could use:</span><br><span class="line">#</span><br><span class="line"># SENTINEL <span class="built_in">rename</span>-command mymaster CONFIG GUESSME</span><br><span class="line">#</span><br><span class="line"># After such configuration is <span class="built_in">set</span>, every <span class="built_in">time</span> Sentinel would use CONFIG it will</span><br><span class="line"># use GUESSME instead. Note that there is no actual need to respect the command</span><br><span class="line"># case, so writing &quot;config guessme&quot; is the same <span class="keyword">in</span> the example above.</span><br><span class="line">#</span><br><span class="line"># SENTINEL <span class="built_in">SET</span> can also be used <span class="keyword">in</span> order to perform this configuration <span class="built_in">at</span> runtime.</span><br><span class="line">#</span><br><span class="line"># <span class="keyword">In</span> order to <span class="built_in">set</span> a command back to its original name (undo the renaming), it</span><br><span class="line"># is possible to just <span class="built_in">rename</span> a command to itself:</span><br><span class="line">#</span><br><span class="line"># SENTINEL <span class="built_in">rename</span>-command mymaster CONFIG CONFIG</span><br><span class="line"></span><br><span class="line"># HOSTNAMES SUPPORT</span><br><span class="line">#</span><br><span class="line"># Normally Sentinel uses only IP addresses and requires SENTINEL MONITOR</span><br><span class="line"># to specify an IP address. Also, it requires the Redis replica-announce-ip</span><br><span class="line"># keyword to specify only IP addresses.</span><br><span class="line">#</span><br><span class="line"># You may enable hostnames support by enabling resolve-hostnames. Note</span><br><span class="line"># that you must make sure your DNS is configured properly and that DNS</span><br><span class="line"># resolution does <span class="keyword">not</span> introduce very long delays.</span><br><span class="line">#</span><br><span class="line">SENTINEL resolve-hostnames no</span><br><span class="line"></span><br><span class="line"># When resolve-hostnames is enabled, Sentinel still uses IP addresses</span><br><span class="line"># when exposing instances to users, configuration files, etc. <span class="keyword">If</span> you want</span><br><span class="line"># to retain the hostnames when announced, enable announce-hostnames below.</span><br><span class="line">#</span><br><span class="line">SENTINEL announce-hostnames no</span><br><span class="line"></span><br><span class="line"># When master_reboot_down_after_period is <span class="built_in">set</span> to <span class="number">0</span>, Sentinel does <span class="keyword">not</span> fail over</span><br><span class="line"># when receiving a -LOADING response from a master. This was the only supported</span><br><span class="line"># behavior before version <span class="number">7</span>.<span class="number">0</span>.</span><br><span class="line">#</span><br><span class="line"># Otherwise, Sentinel will use this value as the <span class="built_in">time</span> (<span class="keyword">in</span> ms) it is willing to</span><br><span class="line"># accept a -LOADING response after a master has been rebooted, before failing</span><br><span class="line"># over.</span><br><span class="line"></span><br><span class="line">SENTINEL master-reboot-down-after-period mymaster <span class="number">0</span></span><br></pre></td></tr></table></figure><h3 id="配置sentinel"><a href="#配置sentinel" class="headerlink" title="配置sentinel"></a>配置sentinel</h3><p>在6379下的<code>/myredis</code>文件夹下创建sentinel26379.conf、sentinel26380.conf、sentinel26381.conf，并写入</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">bind <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span></span><br><span class="line">daemonize yes</span><br><span class="line">protected-<span class="built_in">mode</span> no</span><br><span class="line">port <span class="number">26379</span></span><br><span class="line">logfile &quot;/myredis/sentinel26379.log&quot;</span><br><span class="line">pidfile /var/run/redis-sentinel26379.pid</span><br><span class="line"><span class="built_in">dir</span> /myredis</span><br><span class="line">sentinel monitor mymaster ip <span class="number">6379</span> <span class="number">2</span> # <span class="number">2</span>是票数</span><br><span class="line">sentinel auth-pass mymaster redis密码</span><br></pre></td></tr></table></figure><p><code>sentinel26379.conf</code></p><p><img src="/hexo-docs/images/redisImages/image-20250419151445198.png" alt="image-20250419151445198"></p><p><code>sentinel26380.conf</code></p><p><img src="/hexo-docs/images/redisImages/image-20250419151552672.png" alt="image-20250419151552672"></p><p><code>sentinel26381.conf</code></p><p><img src="/hexo-docs/images/redisImages/image-20250419151707674.png" alt="image-20250419151707674"></p><h3 id="配置主机6379的访问密码"><a href="#配置主机6379的访问密码" class="headerlink" title="配置主机6379的访问密码"></a>配置主机6379的访问密码</h3><p>因为我们的6380和6381都配置的主机的访问密码了，所以只配置6379的主机访问密码就可以！</p><p><img src="/hexo-docs/images/redisImages/image-20250419152347804.png" alt="image-20250419152347804"></p><blockquote><p>注意：</p><p>​6379后续可能会变成从机，需要设置访问新主机的密码， 请设置masterauth项访问密码为redis，不然后续可能报错master_link_status:down</p></blockquote><p>启动6379、6380、6381服务</p><p><img src="/hexo-docs/images/redisImages/image-20250419152810794.png" alt="image-20250419152810794"></p><h3 id="启动sentinel"><a href="#启动sentinel" class="headerlink" title="启动sentinel"></a>启动sentinel</h3><p>通过<code>redis-sentinel sentinel文件 --sentinel</code>启动</p><p><img src="/hexo-docs/images/redisImages/image-20250419153023197.png" alt="image-20250419153023197"></p><p><img src="/hexo-docs/images/redisImages/image-20250419153118226.png" alt="image-20250419153118226"></p><p>当我们模拟主机挂了，看看从机是否会上位</p><p><img src="/hexo-docs/images/redisImages/image-20250419155106107.png" alt="image-20250419155106107"></p><p>稍等一下</p><p><img src="/hexo-docs/images/redisImages/image-20250419155137363.png" alt="image-20250419155137363"></p><p>主机挂了，从机会进行投票，选择一个进行上位</p><p><img src="/hexo-docs/images/redisImages/image-20250419155242345.png" alt="image-20250419155242345"></p><p>可以看到我们的6381已经上位了，当我们打开6379.log文件查看</p><p><img src="/hexo-docs/images/redisImages/image-20250419155854459.png" alt="image-20250419155854459"></p><p>我们的6379没启动，可以看出6379已经不是master变成slave了</p><p><img src="/hexo-docs/images/redisImages/image-20250419160012203.png" alt="image-20250419160012203"></p><p>可以看到可以正常访问数据</p><p><img src="/hexo-docs/images/redisImages/image-20250419160112468.png" alt="image-20250419160112468"></p><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><blockquote><ol><li>文件的内容，在运行期间会被自动sentinel动态进行更改</li><li>master-slave 切换后，master_redis.conf、slave_redis.conf和sentinel.conf的内容都会发生改变，即master_redis.conf 中会多一行slaveof的配置，sentinel.conf 的监控目标会随之调换</li></ol></blockquote><p><img src="/hexo-docs/images/redisImages/image-20250419161603929.png" alt="image-20250419161603929"></p><p><img src="/hexo-docs/images/redisImages/image-20250419161744675.png" alt="image-20250419161744675"></p><h2 id="运行流程和选举原理"><a href="#运行流程和选举原理" class="headerlink" title="运行流程和选举原理"></a>运行流程和选举原理</h2><p>当一个主从配置中的master失效之后，sentinel可以选举出一个新的master用于自动接替原master的工作，主从配置中的其他redis服务器自动指向新的master同步数据。一般建议sentinel采取奇数台，防止某一台sentinel无法连接到master导致误切换</p><h3 id="运行流程，故障切换"><a href="#运行流程，故障切换" class="headerlink" title="运行流程，故障切换"></a>运行流程，故障切换</h3><h4 id="三个哨兵监控一主二从，正常运行中"><a href="#三个哨兵监控一主二从，正常运行中" class="headerlink" title="三个哨兵监控一主二从，正常运行中"></a>三个哨兵监控一主二从，正常运行中</h4><p><img src="/hexo-docs/images/redisImages/image-20250419170201516.png" alt="image-20250419170201516"></p><h4 id="SDown主观下线（Subjectively-Down）"><a href="#SDown主观下线（Subjectively-Down）" class="headerlink" title="SDown主观下线（Subjectively Down）:"></a><code>SDown主观下线（Subjectively Down）</code>:</h4><p>SDown（主观不可用）是<strong>单个sentinel自己主观上</strong>检测到的关于master的状态，从sentinel的角度来看，如果发送了PING心跳后，在一定时间内没有收到合法的回复，就达到 SDOWN 的条件</p><p>sentinel 配置文件中的 down-after-milisenconds 设置了判断主观下线的时间长度</p><p>说明：</p><p>所谓主观下线（Subjectively Down， 简称 SDOWN）指的是单个Sentinel实例对服务器做出的下线判断，即单个sentinel认为某个服务下线（有可能是接收不到订阅，之间的网络不通等等原因）。主观下线就是说如果服务器在[sentinel down-after-milliseconds]给定的毫秒数之内没有回应PING命令或者返回一个错误消息， 那么这个Sentinel会主观的(单方面的)认为这个master不可以用了，o(╥﹏╥)o</p><p><img src="/hexo-docs/images/redisImages/image-20250419171025830.png" alt="image-20250419171025830"></p><p>sentinel down-after-milliseconds &lt;masterName&gt; &lt;timeout&gt;</p><p> 表示master被当前sentinel实例认定为失效的间隔时间，这个配置其实就是进行主观下线的一个依据</p><p>master在多长时间内一直没有给Sentine返回有效信息，则认定该master主观下线。也就是说如果多久没联系上redis-servevr，认为这个redis-server进入到失效（SDOWN）状态。</p><h4 id="ODown客观下线（Objectively-Down）"><a href="#ODown客观下线（Objectively-Down）" class="headerlink" title="ODown客观下线（Objectively Down）"></a>ODown客观下线（Objectively Down）</h4><p>ODOWN 需要一定数量的 sentinel，<strong>多个哨兵达成一致意见</strong>才能认为一个master客观上已经宕掉</p><p>说明：</p><p>四个参数含义：</p><p>masterName是对某个master+slave组合的一个区分标识(一套sentinel可以监听多组master+slave这样的组合)</p><p><img src="/hexo-docs/images/redisImages/image-20250419171311689.png" alt="image-20250419171311689"></p><p><strong>quorum这个参数是进行客观下线的一个依据</strong>，法定人数&#x2F;法定票数</p><p>意思是至少有quorum个sentinel认为这个master有故障才会对这个master进行下线以及故障转移。因为有的时候，某个sentinel节点可能因为自身网络原因导致无法连接master，而此时master并没有出现故障，所以这就需要多个sentinel都一致认为该master有问题，才可以进行下一步操作，这就保证了公平性和高可用。</p><h4 id="选举出领导者哨兵（哨兵中选出兵王（leader））"><a href="#选举出领导者哨兵（哨兵中选出兵王（leader））" class="headerlink" title="选举出领导者哨兵（哨兵中选出兵王（leader））"></a>选举出领导者哨兵（哨兵中选出兵王（leader））</h4><p>当主节点被判断客观下线以后，各个哨兵节点会进行协商，先选举出一个<strong>领导者哨兵节点（兵王）</strong>并由该领导者节点，也即被选举出的兵王进行failover(故障迁移)</p><p>哨兵领导者，兵王如何选举出来的？</p><p>Raft算法</p><p><img src="/hexo-docs/images/redisImages/image-20250419171634394.png" alt="image-20250419171634394"></p><p>监视该主节点的所有哨兵都有可能被选为领导者，选举使用的算法是Raft算法；Raft算法的基本思路<strong>是先到先得</strong>：</p><p>即在一轮选举中，哨兵A向B发送成为领导者的申请，如果B没有同意过其他哨兵，则会同意A成为领导者</p><h3 id="由兵王（leader）开始推动故障切换流程并选出一个新的master"><a href="#由兵王（leader）开始推动故障切换流程并选出一个新的master" class="headerlink" title="由兵王（leader）开始推动故障切换流程并选出一个新的master"></a>由兵王（leader）开始推动故障切换流程并选出一个新的master</h3><h4 id="3个步骤"><a href="#3个步骤" class="headerlink" title="3个步骤"></a>3个步骤</h4><ol><li><p>选出新的主节点</p><ol><li><p>某个slave被选中成为新的master</p></li><li><p>选出新的master的规则，剩余slave节点健康前提下</p><ol><li><p><img src="/hexo-docs/images/redisImages/image-20250419171951635.png" alt="image-20250419171951635"></p></li><li><p>redis.conf文件中，优先级slave-priority或者 replica-priority 最高的从节点（数字越小优先级越高）</p><ol><li><img src="/hexo-docs/images/redisImages/image-20250419172102701.png" alt="image-20250419172102701"></li></ol></li><li><p>复制偏移位置offset最大的从节点</p></li><li><p>最小Run ID 的从节点</p><p>字典顺序，ASCII 码</p></li></ol></li></ol></li><li><p>从机加入到主机上</p><ol><li>执行slaveof no one 命令让选出来的从节点成为新的主节点，并通过slaveof命令让其他节点成为从节点</li><li>sentinel leader 会对选举出的新master执行slaveof no one操作，将其提升为master节点</li><li>sentinel leader 向其他slave 发送命令，让剩余的slave成为新的master节点的slave</li></ol></li><li><p>主机up上线会挂在已经上位的主机上</p><ol><li>将之前已下线的老master设置为新选出的新master的从节点，当老master重新上线后，它会成为新的master的从节点</li><li>sentinel leader 会让原来的master降级为slave并恢复正常工作。</li></ol></li></ol><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>上述的failover操作均由sentinel自己独自完成，无效人工干预。</p><h3 id="使用建议"><a href="#使用建议" class="headerlink" title="使用建议"></a>使用建议</h3><ol><li><p>哨兵节点的数量为多个，哨兵本身应该集群，保证高可用</p></li><li><p>哨兵节点的数量应该是奇数</p></li><li><p>如果哨兵节点部署在 Docker 等容器里面，尤其要注意端口的正确映射</p></li><li><p>哨兵集群+主从复制，并不保证数据零丢失</p><p>承上启下引出集群</p></li></ol><h2 id="集群（cluster）"><a href="#集群（cluster）" class="headerlink" title="集群（cluster）"></a>集群（cluster）</h2><p><strong>由于数据量过大</strong>，单个Master复制集难以承担，因此需要对多个复制集进行集群，形成水平扩展每个复制集只负责存储整个数据集的一部分，这就是Redis的集群，其作用是提供在多个Redis节点间共享数据的程序集。</p><p><img src="/hexo-docs/images/redisImages/image-20250420144656123.png" alt="image-20250420144656123"></p><p><img src="/hexo-docs/images/redisImages/image-20250420145102259.png" alt="image-20250420145102259"></p><p>redis 集群是一个提供在多个redis节点间共享数据的程序集</p><p><strong>redis集群可以支持多个master</strong></p><p>能干嘛？</p><ol><li>redis 集群支持多个 master，每个master又可以挂在多个 slave <ol><li>读写分离</li><li>支持数据的高可用</li><li>支持海量数据的读写存储操作</li></ol></li><li>由于 cluster 自带 sentinel 的故障转移机制，内置了高可用的支持，<strong>无需再去使用哨兵功能</strong></li><li>客户端与redis的节点连接，不再需要连接集群中所有的节点，只需要任意连接集群中的一个可用节点即可</li><li><strong>槽位slot</strong>负责分配到各个物理服务节点，由对应的集群来负责维护节点、插槽和数据之间的关系</li></ol><h3 id="集群算法-分片-槽位slot"><a href="#集群算法-分片-槽位slot" class="headerlink" title="集群算法-分片-槽位slot"></a>集群算法-分片-槽位slot</h3><p>集群的秘钥空间被分成 16384个槽，有效地设置了 16384 个主节点的集群大小限（但是，建议的最大节点大小约1000个节点）。</p><p>集群中的每个主节点处理16384个哈希槽的一个子集。当没有集群重新配置正在进行时（即哈希槽从一个节点移动到另一个节点），集群是稳定的。当集群稳定时，单个哈希槽将由单个节点提供服务（但是，服务节点可以有一个或多个副本），在网络分裂或故障的情况下替换它，并且可以用于扩展 读取陈旧数据是可接受的操作。</p><h4 id="redis集群的槽位slot"><a href="#redis集群的槽位slot" class="headerlink" title="redis集群的槽位slot"></a>redis集群的槽位slot</h4><p><img src="/hexo-docs/images/redisImages/image-20250420150015063.png" alt="image-20250420150015063"></p><p><img src="/hexo-docs/images/redisImages/image-20250420150036286.png" alt="image-20250420150036286"></p><h4 id="redis集群的分片"><a href="#redis集群的分片" class="headerlink" title="redis集群的分片"></a>redis集群的分片</h4><p>分片是什么？</p><p>​使用Redis集群时我们会将存储的数据分散到多台redis机器上，这称为分片。简言之，集群中的每个Redis实例都被认为是整个数据的一个分片。</p><p>如何找到给定key的分片？</p><p>​为了找到给定key的分片，我们对key进行CRC16(key)算法处理并通过对总分片数量取模。然后，使用确定性哈希函数，这意味着给定的key将多次始终映射到同一个分片，我们可以推断将来读取特定key的位置。</p><p><img src="/hexo-docs/images/redisImages/image-20250420150133953.png" alt="image-20250420150133953"></p><h4 id="redis集群的槽位和分片的优势"><a href="#redis集群的槽位和分片的优势" class="headerlink" title="redis集群的槽位和分片的优势"></a>redis集群的槽位和分片的优势</h4><p><strong>最大优势，方便扩缩容和数据分派查找</strong></p><p>这种结构很容易添加或者删除节点，比如如果我想添加个节点D，我需要从节点 A,B,C中得到部分槽到 D上 。如果我想移除节点A，需要将 A 中的槽移到B和C节点上，然后将没有任何槽的A节点从集群中移除即可。由于从一个节点将哈希槽移动到另一个节点并不会停止服务，所以无论添加删除或者改变某个节点的哈希槽的数量都不会造成集群不可用的状态。</p><p><img src="/hexo-docs/images/redisImages/image-20250420150223731.png" alt="image-20250420150223731"></p><h4 id="slot槽位映射，一般业界有3种解决方案"><a href="#slot槽位映射，一般业界有3种解决方案" class="headerlink" title="slot槽位映射，一般业界有3种解决方案"></a>slot槽位映射，一般业界有3种解决方案</h4><h5 id="哈希取余分区"><a href="#哈希取余分区" class="headerlink" title="哈希取余分区"></a>哈希取余分区</h5><p><img src="/hexo-docs/images/redisImages/image-20250420150634747.png" alt="image-20250420150634747"></p><p>2亿条记录就是2亿个k,v，我们单机不行必须要分布式多机，假设有3台机器构成一个集群，用户每次读写操作都是根据公式：hash(key) % N个机器台数，计算出哈希值，用来决定数据映射到哪一个节点上。</p><p><strong>优点：</strong></p><p>​简单粗暴，直接有效，只需要预估好数据规划好节点，例如3台、8台、10台，就能保证一段时间的数据支撑。使用Hash算法让固定的一部分请求落到同一台服务器上，这样每台服务器固定处理一部分请求（并维护这些请求的信息），起到负载均衡+分而治之的作用。</p><p><strong>缺点：</strong></p><p>原来规划好的节点，进行扩容或者缩容就比较麻烦了额，不管扩缩，每次数据变动导致节点有变动，映射关系需要重新进行计算，在服务器个数固定不变时没有问题，如果需要弹性扩容或故障停机的情况下，原来的取模公式就会发生变化：Hash(key)&#x2F;3会变成Hash(key) &#x2F;?。此时地址经过取余运算的结果将发生很大变化，根据公式获取的服务器也会变得不可控。</p><p>某个redis机器宕机了，由于台数数量变化，会导致hash取余全部数据重新洗牌。</p><h5 id="一致性哈希算法分区"><a href="#一致性哈希算法分区" class="headerlink" title="一致性哈希算法分区"></a>一致性哈希算法分区</h5><p>　一致性哈希算法在1997年由麻省理工学院中提出的，设计目标是为了解决分布式缓存数据变动和映射问题，某个机器宕机了，分母数量改变了，自然取余数不OK了。</p><p>能干嘛？</p><p>提出一致性Hash 解决方案。目的是当服务器个数发生变动时，尽量减少影响客户端到服务器的映射关系</p><h6 id="三大步骤"><a href="#三大步骤" class="headerlink" title="三大步骤"></a>三大步骤</h6><ol><li><p>算法构建一致性哈希环</p><p> 一致性哈希算法必然有个hash函数并按照算法产生hash值，这个算法的所有可能哈希值会构成一个全量集，这个集合可以成为一个hash空间[0,2^32-1]，这个是一个线性空间，但是在算法中，我们通过适当的逻辑控制将它首尾相连(0 &#x3D; 2^32),这样让它逻辑上形成了一个环形空间。</p><p>  它也是按照使用取模的方法，前面笔记介绍的节点取模法是对节点（服务器）的数量进行取模。而一致性Hash算法是对2^32取模，简单来说，一致性Hash算法将整个哈希值空间组织成一个虚拟的圆环，如假设某哈希函数H的值空间为0-2^32-1（即哈希值是一个32位无符号整形），整个哈希环如下图：整个空间按顺时针方向组织，圆环的正上方的点代表0，0点右侧的第一个点代表1，以此类推，2、3、4、……直到2^32-1，也就是说0点左侧的第一个点代表2^32-1， 0和2^32-1在零点中方向重合，我们把这个由2^32个点组成的圆环称为Hash环。</p><p><img src="/hexo-docs/images/redisImages/image-20250420151020699.png" alt="image-20250420151020699"></p></li><li><p>redis服务器IP节点映射</p><p>将集群中各个IP节点映射到环上的某一个位置。</p><p>将各个服务器使用Hash进行一个哈希，具体可以选择服务器的IP或主机名作为关键字进行哈希，这样每台机器就能确定其在哈希环上的位置。假如4个节点NodeA、B、C、D，经过IP地址的哈希函数计算(hash(ip))，使用IP地址哈希后在环空间的位置如下： </p><p><img src="/hexo-docs/images/redisImages/image-20250420151105848.png" alt="image-20250420151105848"></p></li><li><p>key落到服务器的落键规则</p><p>当我们需要存储一个kv键值对时，首先计算key的hash值，hash(key)，将这个key使用相同的函数Hash计算出哈希值并确定此数据在环上的位置，<strong>从此位置沿环顺时针“行走”</strong>，第一台遇到的服务器就是其应该定位到的服务器，并将该键值对存储在该节点上。</p><p>如我们有Object A、Object B、Object C、Object D四个数据对象，经过哈希计算后，在环空间上的位置如下：根据一致性Hash算法，数据A会被定为到Node A上，B被定为到Node B上，C被定为到Node C上，D被定为到Node D上。</p><p><img src="/hexo-docs/images/redisImages/image-20250420151205941.png" alt="image-20250420151205941"></p></li></ol><h6 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h6><ol><li><p>一致性哈希算法的<strong>容错性</strong></p><p>假设Node C宕机，可以看到此时对象A、B、D不会受到影响。一般的，在一致性Hash算法中，如果一台服务器不可用，则受影响的数据仅仅是此服务器到其环空间中前一台服务器（即沿着逆时针方向行走遇到的第一台服务器）之间数据，其它不会受到影响。简单说，就是C挂了，受到影响的只是B、C之间的数据且这些数据会转移到D进行存储。</p><p><img src="/hexo-docs/images/redisImages/image-20250420151324945.png" alt="image-20250420151324945"></p></li><li><p>一致性哈希算法的<strong>扩展性</strong></p><p>数据量增加了，需要增加一台节点NodeX，X的位置在A和B之间，那收到影响的也就是A到X之间的数据，重新把A到X的数据录入到X上即可，</p><p>不会导致hash取余全部数据重新洗牌（数据丢失）。</p><p><img src="/hexo-docs/images/redisImages/image-20250420151402839.png" alt="image-20250420151402839"></p><h6 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h6><p>一致性哈希算法的<strong>数据倾斜</strong>问题</p><p>一致性Hash算法在服务<strong>节点太少时</strong>，容易因为节点分布不均匀而造成<strong>数据倾斜</strong>（被缓存的对象大部分集中缓存在某一台服务器上）问题，</p><p>例如系统中只有两台服务器：</p><p><img src="/hexo-docs/images/redisImages/image-20250420151446354.png" alt="image-20250420151446354"></p><h6 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h6><p>为了在节点数目发生改变时尽可能少的迁移数据</p><p>将所有的存储节点排列在收尾相接的Hash环上，每个key在计算Hash后会顺时针找到临近的存储节点存放。</p><p>而当有节点加入或退出时仅影响该节点在Hash环上顺时针相邻的后续节点。 </p><p>优点：</p><p>​加入和删除节点只影响哈希环中顺时针方向的相邻的节点，对其他节点无影响。</p><p>缺点：</p><p>​数据的分布和节点的位置有关，因为这些节点不是均匀的分布在哈希环上的，所以数据在进行存储时达不到均匀分布的效果。</p></li></ol><h5 id="哈希槽分区（HASH-SLOT-CRC16-key-mod-16384）"><a href="#哈希槽分区（HASH-SLOT-CRC16-key-mod-16384）" class="headerlink" title="哈希槽分区（HASH_SLOT&#x3D;CRC16(key) mod 16384）"></a>哈希槽分区（HASH_SLOT&#x3D;CRC16(key) mod 16384）</h5><ol><li><p>为什么会出现？</p><p>一致性哈希算法的数据倾斜问题</p><p>哈希槽实质就是一个数组，数组[0,2^14 -1]形成hash slot空间。</p></li><li><p>能干什么</p><p>解决均匀分配的问题，在数据和节点之间又加入了一层，把这层称为哈希槽（slot），用于管理数据和节点之间的关系，现在就相当于节点上放的是槽，槽里放的是数据。</p><p><img src="/hexo-docs/images/redisImages/image-20250420151718731.png" alt="image-20250420151718731"></p><p>槽解决的是粒度问题，相当于把粒度变大了，这样便于数据移动。哈希解决的是映射问题，使用key的哈希值来计算所在的槽，便于数据分配</p></li><li><p>多少个hash槽</p><p>一个集群只能有16384个槽，编号0-16383（0-2^14-1）。这些槽会分配给集群中的所有主节点，分配策略没有要求。</p><p>集群会记录节点和槽的对应关系，解决了节点和槽的关系后，接下来就需要对key求哈希值，然后对16384取模，余数是几key就落入对应的槽里。HASH_SLOT &#x3D; CRC16(key) mod 16384。以槽为单位移动数据，因为槽的数目是固定的，处理起来比较容易，这样数据移动问题就解决了。</p></li></ol><h6 id="哈希槽计算"><a href="#哈希槽计算" class="headerlink" title="哈希槽计算"></a>哈希槽计算</h6><p>Redis 集群中内置了 16384 个哈希槽，redis 会根据节点数量大致均等的将哈希槽映射到不同的节点。当需要在 Redis 集群中放置一个 key-value时，redis先对key使用crc16算法算出一个结果然后用结果对16384求余数[ CRC16(key) % 16384]，这样每个 key 都会对应一个编号在 0-16383 之间的哈希槽，也就是映射到某个节点上。如下代码，key之A 、B在Node2， key之C落在Node3上</p><p> <img src="/hexo-docs/images/redisImages/image-20250420151847491.png" alt="image-20250420151847491"></p><h6 id="为什么redis集群的最大槽数是16384个？"><a href="#为什么redis集群的最大槽数是16384个？" class="headerlink" title="为什么redis集群的最大槽数是16384个？"></a>为什么redis集群的最大槽数是16384个？</h6><p>Redis集群并没有使用一致性hash而是引入了哈希槽的概念。Redis 集群有16384个哈希槽，每个key通过CRC16校验后对16384取模来决定放置哪个槽，集群的每个节点负责一部分hash槽。但为什么哈希槽的数量是16384（2^14）个呢？</p><p>CRC16算法产生的hash值有16bit，该算法可以产生2^16&#x3D;65536个值。换句话说值是分布在0~65535之间，有更大的65536不用为什么只用16384就够？作者在做mod运算的时候，为什么不mod65536，而选择mod16384？ HASH_SLOT &#x3D; CRC16(key) mod 65536为什么没启用</p><ol><li><p>如果槽位为65536，发送心跳信息的消息头达8k，发送的心跳包过于庞大。</p><p>在消息头中最占空间的是myslots[CLUSTER_SLOTS&#x2F;8]。 当槽位为65536时，这块的大小是: 65536÷8÷1024&#x3D;8kb 在消息头中最占空间的是myslots[CLUSTER_SLOTS&#x2F;8]。 当槽位为16384时，这块的大小是: 16384÷8÷1024&#x3D;2kb 因为每秒钟，redis节点需要发送一定数量的ping消息作为心跳包，如果槽位为65536，这个ping消息的消息头太大了，浪费带宽。</p></li><li><p>redis的集群主节点数量基本不可能超过1000个。</p><p>集群节点越多，心跳包的消息体内携带的数据越多。如果节点过1000个，也会导致网络拥堵。因此redis作者不建议redis cluster节点数量超过1000个。 那么，对于节点数在1000以内的redis cluster集群，16384个槽位够用了。没有必要拓展到65536个。</p></li><li><p>槽位越小，节点少的情况下，压缩比高，容易传输</p><p>Redis主节点的配置信息中它所负责的哈希槽是通过一张bitmap的形式来保存的，在传输过程中会对bitmap进行压缩，但是如果bitmap的填充率slots &#x2F; N很高的话(N表示节点数)，bitmap的压缩率就很低。 如果节点数很少，而哈希槽数量很多的话，bitmap的压缩率就很低。</p></li></ol><p><img src="/hexo-docs/images/redisImages/image-20250420152134809.png" alt="image-20250420152134809"></p><h6 id="结论-1"><a href="#结论-1" class="headerlink" title="结论"></a>结论</h6><p><img src="/hexo-docs/images/redisImages/image-20250420152156297.png" alt="image-20250420152156297"></p><p>redis集群<strong>不保证强一致性</strong>，这意味着在特定的条件下，redis集群可能会丢掉一些被系统收到的写入请求命令</p><h4 id="3主3从redis集群的配置"><a href="#3主3从redis集群的配置" class="headerlink" title="3主3从redis集群的配置"></a>3主3从redis集群的配置</h4><p>找3台真实的虚拟机，各自新建 <code>mkdir -p /myredis/cluster</code></p><p>IP: 192.168.0.128+端口6381&#x2F;6382</p><p>新建 <code>redisCluster6381.conf 和 redisCluster6382.conf</code></p><p> vim &#x2F;myredis&#x2F;cluster&#x2F;redisCluster6381.conf</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">bind <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span></span><br><span class="line">daemonize yes</span><br><span class="line">protected-<span class="built_in">mode</span> no</span><br><span class="line">port <span class="number">6381</span> # 端口</span><br><span class="line">logfile &quot;/myredis/cluster/cluster6381.log&quot;</span><br><span class="line">pidfile /myredis/cluster6381.pid</span><br><span class="line"><span class="built_in">dir</span> /myredis/cluster</span><br><span class="line">dbfilename dump6381.rdb</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename &quot;appendonly6381.aof&quot;</span><br><span class="line">requirepass redis # redis密码</span><br><span class="line">masterauth redis # 集群密码</span><br><span class="line"></span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-<span class="number">6381</span>.conf</span><br><span class="line">cluster-node-timeout <span class="number">5000</span></span><br></pre></td></tr></table></figure><p><code>redisCluster6381.conf</code></p><p><img src="/hexo-docs/images/redisImages/image-20250420173301308.png" alt="image-20250420173301308"></p><p><code>redisCluster6382.conf</code></p><p><img src="/hexo-docs/images/redisImages/image-20250420173442658.png" alt="image-20250420173442658"></p><p>IP: 192.168.0.131+端口6383&#x2F;6384</p><p>新建 <code>redisCluster6383.conf 和 redisCluster6384.conf</code>和 <code>mkdir -p /myredis/cluster</code>文件</p><p> vim &#x2F;myredis&#x2F;cluster&#x2F;redisCluster6383.conf和 vim &#x2F;myredis&#x2F;cluster&#x2F;redisCluster6384.conf</p><p><code>redisCluster6383.conf</code></p><p><img src="/hexo-docs/images/redisImages/image-20250420174046619.png" alt="image-20250420174046619"></p><p><code>redisCluster6384.conf</code></p><p><img src="/hexo-docs/images/redisImages/image-20250420174254659.png" alt="image-20250420174254659"></p><p>IP: 192.168.0.132+端口6385&#x2F;6386</p><p>新建 <code>redisCluster6385.conf 和 redisCluster6386.conf</code>和 <code>mkdir -p /myredis/cluster</code>文件</p><p> vim &#x2F;myredis&#x2F;cluster&#x2F;redisCluster6385.conf和 vim &#x2F;myredis&#x2F;cluster&#x2F;redisCluster6386.conf</p><p><code>redisCluster6385.conf</code></p><p><img src="/hexo-docs/images/redisImages/image-20250420174650382.png" alt="image-20250420174650382"></p><p><code>redisCluster6386.conf</code></p><p><img src="/hexo-docs/images/redisImages/image-20250420174829002.png" alt="image-20250420174829002"></p><p>启动redis实例：<code>redis-server /myredis/cluster/redisCluster6381.conf</code>~&#96;redis-server &#x2F;myredis&#x2F;cluster&#x2F;redisCluster6386.conf&#96;</p><p><img src="/hexo-docs/images/redisImages/image-20250420175132094.png" alt="image-20250420175132094"></p><p>…</p><p>通过<code>redis-cli</code>命令为6台机器构建集群关系</p><p>​构建主从关系命令</p><blockquote><p>注意，注意，注意自己的真实IP地址 </p></blockquote><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">redis-cli -a redis --cluster create --cluster-replicas <span class="number">1</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">128</span>:<span class="number">6381</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">128</span>:<span class="number">6382</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">131</span>:<span class="number">6383</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">131</span>:<span class="number">6384</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">132</span>:<span class="number">6385</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">132</span>:<span class="number">6386</span></span><br><span class="line">#--cluster-replicas <span class="number">1</span> 表示为每个master创建一个slave节点 </span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250420180547496.png" alt="image-20250420180547496"></p><p>需要关闭3台机器的防火墙，关闭临时防火墙<code>systemctl stop firewalld </code></p><p><img src="/hexo-docs/images/redisImages/image-20250420180818518.png" alt="image-20250420180818518"></p><p>yes问是否3主3从？</p><p><img src="/hexo-docs/images/redisImages/image-20250420181335750.png" alt="image-20250420181335750"></p><p>以6381为切入点，<strong>查看并检验集群状态</strong></p><p>查看节点状态</p><p><img src="/hexo-docs/images/redisImages/image-20250420181609201.png" alt="image-20250420181609201"></p><p>使用<code>cluster nodes</code>查看</p><p><img src="/hexo-docs/images/redisImages/image-20250420181847937.png" alt="image-20250420181847937"></p><p>查看单个集群配置<code>cluster info</code></p><p><img src="/hexo-docs/images/redisImages/image-20250420182026748.png" alt="image-20250420182026748"></p><ul><li><p><code>cluster_state</code>：状态是<code>ok</code>节点是否能够接收查询。<code>fail</code>如果至少有一个未绑定的散列槽（没有关联的节点），处于错误状态（为其服务的节点被标记为 FAIL 标记），或者该节点无法到达大多数主节点。</p></li><li><p><code>cluster_slots_assigned</code>：与某个节点关联的槽数（不是未绑定的）。这个数字应该是16384，节点才能正常工作，这意味着每个散列槽应该映射到一个节点。</p></li><li><p><code>cluster_slots_ok</code>：映射到不处于<code>FAIL</code>或<code>PFAIL</code>处于状态的节点的散列槽的数量。</p></li><li><p><code>cluster_slots_pfail</code>：映射到处于<code>PFAIL</code>状态的节点的散列槽的数量。请注意，只要<code>PFAIL</code>状态不由<code>FAIL</code>故障检测算法提升，这些散列槽仍可正常工作。<code>PFAIL</code>仅意味着我们目前无法与节点通话，但可能只是一个暂时的错误。</p></li><li><p><code>cluster_slots_fail</code>：映射到处于<code>FAIL</code>状态的节点的散列槽的数量。如果此数字不为零，则该节点无法提供查询，除非在配置中<code>cluster-require-full-coverage</code>设置为<code>no</code>。</p></li><li><p><code>cluster_known_nodes</code>：群集中已知节点的总数，包括<code>HANDSHAKE</code>当前可能不是群集适当成员的状态节点。</p></li><li><p><code>cluster_size</code>：服务群集中至少一个散列槽的主节点的数量。</p></li><li><p><code>cluster_current_epoch</code>：局部<code>Current Epoch</code>变量。这用于在故障转移期间创建独特的增加版本号。</p></li><li><p><code>cluster_my_epoch</code>：我们正在与之交谈的<code>Config Epoch</code>节点。这是分配给此节点的当前配置版本。</p></li><li><p><code>cluster_stats_messages_sent</code>：通过集群节点到节点二进制总线发送的消息数量。</p></li><li><p><code>cluster_stats_messages_received</code>：通过集群节点到节点二进制总线接收的消息数量。</p></li></ul><h4 id="3主3从redis集群读写"><a href="#3主3从redis集群读写" class="headerlink" title="3主3从redis集群读写"></a>3主3从redis集群读写</h4><ol><li><p>对6381新增两个key，看看效果如何</p><p><img src="/hexo-docs/images/redisImages/image-20250420183826495.png" alt="image-20250420183826495"></p></li><li><p>为什么报错</p><p>一定注意槽位的范围区间，需要路由到位</p><p><img src="/hexo-docs/images/redisImages/image-20250420183854983.png" alt="image-20250420183854983"></p></li><li><p>如何解决</p><p>防止失效加参数-c并新增两个key</p><p><img src="/hexo-docs/images/redisImages/image-20250420184110078.png" alt="image-20250420184110078"></p><p><img src="/hexo-docs/images/redisImages/image-20250420184234189.png" alt="image-20250420184234189"></p><p>可以看到k1重定向到我们的6385号机器了</p></li><li><p>如何查看集群信息</p><p><img src="/hexo-docs/images/redisImages/image-20250420184408490.png" alt="image-20250420184408490"></p></li><li><p>查看某个key该属于对应的槽位值，<code>cluster keyslot</code>键名称</p><p><img src="/hexo-docs/images/redisImages/image-20250420184533589.png" alt="image-20250420184533589"></p><blockquote><p>注意：</p><p>如果重定向到某一台机器，只能在某一台机器查看，不能在当前机器查看，因为没有数据</p></blockquote></li></ol><h4 id="主从切换容错切换"><a href="#主从切换容错切换" class="headerlink" title="主从切换容错切换"></a>主从切换容错切换</h4><ol><li><p>容错切换迁移</p><ol><li><p>主6381和从机切换，先停止主机6381</p><ol><li>6381主机停了，对应的真实从机上位</li><li>6381作为1号主机分配的从机以实际情况为准，具体几号就是几号（这里是6384）</li></ol></li><li><p>再次查看集群信息，本次6381主6384从</p><ol><li><p>发现6384，已经成功上位变成主机了！</p><p><img src="/hexo-docs/images/redisImages/image-20250420191315525.png" alt="image-20250420191315525"></p></li></ol></li><li><p>随后，6381原来的主机回来了，是否会上位！</p><p><img src="/hexo-docs/images/redisImages/image-20250420191703559.png" alt="image-20250420191703559"></p></li></ol></li><li><p>集群不保证数据一致性100%OK，一定会有数据丢失清空</p><p>redis集群不保证强一致性，这意味着在特定的条件下，redis集群可能会丢掉一些被系统收到的写入请求命令</p></li><li><p>手动故障转移 or 节点从属调整该如何处理</p><p>使用：<code>cluster failover</code>可以从从节点变成主节点。</p><p>当前我们的6381是从节点，我们要把他变成主节点</p><p><img src="/hexo-docs/images/redisImages/image-20250420192123271.png" alt="image-20250420192123271"></p></li></ol><h4 id="主从扩容案例"><a href="#主从扩容案例" class="headerlink" title="主从扩容案例"></a>主从扩容案例</h4><p>当我们的3主3从不够用了，我们就应该扩容</p><ol><li><p>在IP<code>192.168.0.132</code>新建6381、6388两个服务实例配置文件+新建后启动</p><ol><li><p><code>vim /myredis/cluster/redisCluster6387.conf</code>和<code>vim /myredis/cluster/redisCluster6388.conf</code></p></li><li><p>6387</p><p><img src="/hexo-docs/images/redisImages/image-20250420193527904.png" alt="image-20250420193527904"></p></li><li><p>6388</p><p><img src="/hexo-docs/images/redisImages/image-20250420193628392.png" alt="image-20250420193628392"></p></li></ol></li><li><p>启动6387和6388</p><p><img src="/hexo-docs/images/redisImages/image-20250420193737073.png" alt="image-20250420193737073"></p></li><li><p>将新增的6387节点（空槽号）作为master节点加入原集群</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">redis-cli -a 密码 --cluster add-node 自己实际IP地址:<span class="number">6387</span> 自己实际IP地址:<span class="number">6381</span></span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250420194839662.png" alt="image-20250420194839662"></p></li><li><p>检查集群情况</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">redis-cli -a 密码 --cluster check 真实ip地址:<span class="number">6381</span></span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250420195057422.png" alt="image-20250420195057422"></p></li><li><p>重新分派槽号（reshard）</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">redis-cli -a 密码 --cluster reshard IP地址:端口号</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250420195602536.png" alt="image-20250420195602536"></p><p><img src="/hexo-docs/images/redisImages/image-20250420195655887.png" alt="image-20250420195655887"></p></li><li><p>再次检查集群情况</p><p><img src="/hexo-docs/images/redisImages/image-20250420195852698.png" alt="image-20250420195852698"></p><p>可以看到，在3个主节点上匀了点给第四个主节点了！</p></li><li><p>为主节点6387分配从节点6388</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">redis-cli -a 密码 --cluster add-node ip:新slave端口 ip:新master端口 --cluster-slave --cluster-master-id 新主机节点ID</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250420200323623.png" alt="image-20250420200323623"></p><p>再次检查分配情况</p><p><img src="/hexo-docs/images/redisImages/image-20250420200446706.png" alt="image-20250420200446706"></p><h4 id="主从缩容案例"><a href="#主从缩容案例" class="headerlink" title="主从缩容案例"></a>主从缩容案例</h4><p>目的：让6387和6388下线</p></li></ol><p><img src="/hexo-docs/images/redisImages/image-20250421191204199.png" alt="image-20250421191204199"></p><p>从集群中将4号从节点6388删除</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">redis-cli -a 密码 --cluster <span class="built_in">del</span>-node ip:从机端口 从机<span class="number">6388</span>节点ID</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250421191458702.png" alt="image-20250421191458702"></p><p><img src="/hexo-docs/images/redisImages/image-20250421191556431.png" alt="image-20250421191556431"></p><p>将6387的槽号清空，重新分配，本案例将清出来的槽号都给6381</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">redis-cli -a redis --cluster reshard <span class="number">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">128</span>:<span class="number">6381</span></span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250421192052683.png" alt="image-20250421192052683"></p><p><img src="/hexo-docs/images/redisImages/image-20250421192137130.png" alt="image-20250421192137130"></p><p>删除6387节点</p><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">redis-cli -a 密码 --cluster <span class="built_in">del</span>-node ip:端口 <span class="number">6387</span>节点ID</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250421192332588.png" alt="image-20250421192332588"></p><p>移除成功，再次检查节点</p><p><img src="/hexo-docs/images/redisImages/image-20250421192424669.png" alt="image-20250421192424669"></p><h3 id="集群常用操作命令和CRC16算法分析"><a href="#集群常用操作命令和CRC16算法分析" class="headerlink" title="集群常用操作命令和CRC16算法分析"></a>集群常用操作命令和CRC16算法分析</h3><ol><li><p>不在同一个slot槽位下的多键操作支持不好，通识占位符登场</p><p><img src="/hexo-docs/images/redisImages/image-20250421192540391.png" alt="image-20250421192540391"></p><table><thead><tr><th>不在同一个slot槽位下的键值无法使用mset、mget等多键操作</th></tr></thead><tbody><tr><td>可以通过{}来定义同一个组的概念，使key中{}内相同内容的键值对放到一个slot槽位去，对照下图类似k1k2k3都映射为x，自然槽位一样</td></tr></tbody></table><p><img src="/hexo-docs/images/redisImages/image-20250421192558156.png" alt="image-20250421192558156"></p></li><li><p>redis集群有16384个哈希槽，每个key通过CRC16校验后对16384取模来决定放置那个槽。集群的每个节点负责一部分hash槽</p><p>CRC16源码</p><p>​cluster.c</p><p><img src="/hexo-docs/images/redisImages/image-20250421192803758.png" alt="image-20250421192803758"></p></li><li><p>常用命令</p><ol><li><p>集群是否完整才能对外提供服务</p><p><img src="/hexo-docs/images/redisImages/image-20250421192846552.png" alt="image-20250421192846552"></p><table><thead><tr><th>默认YES，现在集群架构是3主3从的redis cluster由3个master平分16384个slot，每个master的小集群负责1&#x2F;3的slot，对应一部分数据。cluster-require-full-coverage： 默认值 yes , 即需要集群完整性，方可对外提供服务 通常情况，如果这3个小集群中，任何一个（1主1从）挂了，你这个集群对外可提供的数据只有2&#x2F;3了， 整个集群是不完整的， redis 默认在这种情况下，是不会对外提供服务的。</th></tr></thead><tbody><tr><td>如果你的诉求是，集群不完整的话也需要对外提供服务，需要将该参数设置为no ，这样的话你挂了的那个小集群是不行了，但是其他的小集群仍然可以对外提供服务。</td></tr></tbody></table></li><li><p><code>cluster countkeysinslot</code>槽位数字编号</p><ol><li>1，该槽位被占用</li><li>0，该槽位没占用</li></ol></li><li><p><code>cluster keyslot</code>键名称</p><p>该键应该存在哪个槽位上</p></li></ol></li></ol><h2 id="SpringBoot集成Redis"><a href="#SpringBoot集成Redis" class="headerlink" title="SpringBoot集成Redis"></a>SpringBoot集成Redis</h2><h3 id="Jedis"><a href="#Jedis" class="headerlink" title="Jedis"></a>Jedis</h3><p><strong>Jedis 是一款老牌 Redis 的 Java 客户端。</strong></p><p>Jedis Client 是 Redis 官网推荐的一个面向java 客户端，库文件实现了对各类API 进行封装调用</p><p>优点：</p><ol><li>Jedis 的 API 提供了比较全面的 Redis 命令的支持</li><li>Jedis 中的 Java 方法基本和 Redis 的 API 保持着一致，也就是说了解 Redis 的API，可以熟练的使用 Jedis</li><li>支持 pipelining、事务、LUA Scripting、Redis Sentinel、Redis Cluster等等 redis 提供的高级特性</li><li>客户端轻量，简洁，便于集成和改造</li><li>使用广泛，开发人员易上手</li></ol><p>缺点：</p><ol><li><p>使用阻塞的 I&#x2F;O 操作，且其方法调用都是同步的，程序流需要等到 sockets 处理完 I&#x2F;O 才能执行，不支持异步</p></li><li><p>Jedis 在实现上是直接连接的 redis server，如果在多线程环境下是非线程安全的，这个时候可以使用连接池来管理 Jedis，解决 Jedis 客户端实例存在非线程安全的问题（也就是可以通过配置JedisPool来实现基于Jedis的连接池）</p></li><li><p>不支持读写分离，需要自己实现</p></li><li><p>技术文档差，可以说几乎没有</p></li></ol><p>通过配置 JedisPool 设置连接池并将JedisPool对象注入到spring容器内，使用时通过 @Autowired 方式注入JedisPool 使用。</p><p>示例：</p><p>​pom文件</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--jedis--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- lombok 因为要用到 @Slf4j--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.0.128&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        jedis.auth(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;redis 连接成功&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;ping,&#123;&#125;&quot;</span>, jedis.ping());</span><br><span class="line">        <span class="comment">//string</span></span><br><span class="line">        log.info(<span class="string">&quot;-------string---------&quot;</span>);</span><br><span class="line">        jedis.set(<span class="string">&quot;k1&quot;</span>, <span class="string">&quot;v1&quot;</span>);</span><br><span class="line">        System.out.println(jedis.get(<span class="string">&quot;k1&quot;</span>));</span><br><span class="line">        <span class="comment">//list</span></span><br><span class="line">        log.info(<span class="string">&quot;-------list---------&quot;</span>);</span><br><span class="line">        jedis.lpush(<span class="string">&quot;list&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;4&quot;</span>, <span class="string">&quot;5&quot;</span>);</span><br><span class="line">        List&lt;String&gt; list = jedis.lrange(<span class="string">&quot;list&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        list.forEach(System.out::println);</span><br><span class="line">        <span class="comment">//set</span></span><br><span class="line">        log.info(<span class="string">&quot;----------set----------&quot;</span>);</span><br><span class="line">        jedis.sadd(<span class="string">&quot;orders&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        jedis.sadd(<span class="string">&quot;orders&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line">        jedis.sadd(<span class="string">&quot;orders&quot;</span>, <span class="string">&quot;3&quot;</span>);</span><br><span class="line">        Set&lt;String&gt; orders = jedis.smembers(<span class="string">&quot;orders&quot;</span>);</span><br><span class="line">        orders.forEach(System.out::println);</span><br><span class="line">        jedis.srem(<span class="string">&quot;orders&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="comment">//打印orders</span></span><br><span class="line">        log.info(<span class="string">&quot;orders,size：&#123;&#125;&quot;</span>, jedis.smembers(<span class="string">&quot;orders&quot;</span>).size());</span><br><span class="line">        <span class="comment">//hash</span></span><br><span class="line">        log.info(<span class="string">&quot;----------hash----------&quot;</span>);</span><br><span class="line">        jedis.hset(<span class="string">&quot;hash1&quot;</span>, <span class="string">&quot;userName&quot;</span>, <span class="string">&quot;zs&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;hash：&#123;&#125;&quot;</span>, jedis.hget(<span class="string">&quot;hash1&quot;</span>, <span class="string">&quot;userName&quot;</span>));</span><br><span class="line">        HashMap&lt;String, String&gt; hash2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hash2.put(<span class="string">&quot;userName&quot;</span>, <span class="string">&quot;zs&quot;</span>);</span><br><span class="line">        hash2.put(<span class="string">&quot;age&quot;</span>, <span class="string">&quot;20&quot;</span>);</span><br><span class="line">        hash2.put(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;@qq.com&quot;</span>);</span><br><span class="line">        jedis.hmset(<span class="string">&quot;hash2&quot;</span>, hash2);</span><br><span class="line">        <span class="comment">//打印 hash2的值</span></span><br><span class="line">        log.info(<span class="string">&quot;-----hash2-----&quot;</span>);</span><br><span class="line">        List&lt;String&gt; hmget = jedis.hmget(<span class="string">&quot;hash2&quot;</span>, <span class="string">&quot;userName&quot;</span>, <span class="string">&quot;age&quot;</span>, <span class="string">&quot;email&quot;</span>);</span><br><span class="line">        hmget.forEach(System.out::println);</span><br><span class="line">        log.info(<span class="string">&quot;-----zset-----&quot;</span>);</span><br><span class="line">        <span class="comment">//zset</span></span><br><span class="line">        jedis.zadd(<span class="string">&quot;zset01&quot;</span>, <span class="number">50d</span>, <span class="string">&quot;70&quot;</span>);</span><br><span class="line">        jedis.zadd(<span class="string">&quot;zset01&quot;</span>, <span class="number">60d</span>, <span class="string">&quot;90&quot;</span>);</span><br><span class="line">        jedis.zadd(<span class="string">&quot;zset01&quot;</span>, <span class="number">70d</span>, <span class="string">&quot;70&quot;</span>);</span><br><span class="line">        List&lt;String&gt; zset01 = jedis.zrange(<span class="string">&quot;zset01&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        zset01.forEach(System.out::println);</span><br><span class="line">        jedis.flushDB();</span><br><span class="line">        <span class="comment">//关闭连接</span></span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Lettuce"><a href="#Lettuce" class="headerlink" title="Lettuce"></a>Lettuce</h3><p>Lettuce是一个Redis的Java驱动包，Lettuce翻译为生菜，没错，就是吃的那种生菜，所以它的Logo长这样</p><p><img src="/hexo-docs/images/redisImages/image-20250422171001852.png" alt="image-20250422171001852"></p><p><strong>Lettuce 是一种可扩展的、线程安全的 Redis 高级客户端，从 Spring Boot 2.x 开始， Lettuce 已取代 Jedis 成为SpringBoot 默认的 Redis 客户端</strong><br>优点：</p><ol><li>相比于 Jedis，Lettuce 属于后起之秀，对 Redis 支持更加全面，并且解决了 Jedis 客户端实例存在非线程安全的问题</li><li>支持同步编程，异步编程，响应式编程，自动重新连接，主从模式，集群模块，哨兵模式，管道和编码器等等高级的 Redis 特性</li><li>Lettuce 底层基于 Netty 框架的事件驱动与 redis 通信，采用了非阻塞的 I&#x2F;O 操作，可异步调用，相比 Jedis，性能高</li><li>Letuce 的 API 是线程安全的，如果不是执行阻塞和事务操作，如 BLPOP 和MULTI&#x2F;EXEC 等命令，多个线程就可以共享一个连接，性能方面差异很小</li></ol><p>缺点：</p><ol><li>API 更加抽象，学习使用成本高</li></ol><p>RedisTemplate是Spring Data Redis框架提供的对Jedis和Lettuce的封装客户端，本质上还是使用Jedis或Lettuce，spring boot1.x的版本默认采用Jedis实现，spring boot2.x的版本默认采用Lettuce实现；可以方便的在Jedis和Lettuce之间切换具体的客户端实现；和日志门面与日志实现框架的关系一样，日志门面统一了操作日志的api，而具体日志的记录交给日志实现框去做，这样在切换日志实现时不用修改日志相关代码；RedisTemplate性能上不及Jedis，使用RedisTemplate时项目中至少需要有Jedis或Lettuce客户端之一的依赖包，否则会报错，RedisTemplate会自动根据项目中依赖的客户端选择底层使用Jedis还是Lettuce。</p><p><strong>Jedis和Lettuce的区别</strong></p><p>jedis和Lettuce都是Redis的客户端，它们都可以连接Redis服务器，但是在SpringBoot2.0之后默认都是使用的 Lettuce 这个客户端连接Redis服务器，因为当时使用Jedis客户端连接Redis 服务器的时候，每个线程都要拿自己创建的Jedis实例去连接Redis客户端，当有很多个线程的时候，不仅开销大需要反复的创建关闭一个Jedis连接，而且也是线程不安全的，一个线程通过Jedis实例更改Redis服务器中的数据之后会影响另一个线程。</p><p>但是如果使用 Lettuce 这个客户端连接 Redis 服务器的时候，就不会出现上面的情况，Lettuce 底层使用的是 Netty，当有多个线程都需要连接 Redis 服务器的时候，可以保证只创建一个 Lettuce 连接，使所有的线程共享这一个 Lettuce 连接，这样可以减少创建关闭一个 Lettuce 连接时候的开销；而且这种方式也是线程安全的，不会出现一个线程通过 Lettuce 更改 Redis 服务器中的数据之后而影响另一个线程的情况；</p><p>使用：</p><p>pom</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.lettuce.core.RedisClient;</span><br><span class="line"><span class="keyword">import</span> io.lettuce.core.RedisURI;</span><br><span class="line"><span class="keyword">import</span> io.lettuce.core.SortArgs;</span><br><span class="line"><span class="keyword">import</span> io.lettuce.core.api.StatefulRedisConnection;</span><br><span class="line"><span class="keyword">import</span> io.lettuce.core.api.sync.RedisCommands;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LettuceDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//使用构建器链式编程 构建 RedisURI.builder</span></span><br><span class="line">        <span class="type">RedisURI</span> <span class="variable">uri</span> <span class="operator">=</span> RedisURI.Builder</span><br><span class="line">                .redis(<span class="string">&quot;192.168.0.128&quot;</span>)</span><br><span class="line">                .withPort(<span class="number">6379</span>)</span><br><span class="line">                .withAuthentication(<span class="string">&quot;default&quot;</span>, <span class="string">&quot;redis&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">//创建连接 redis 客户端</span></span><br><span class="line">        <span class="type">RedisClient</span> <span class="variable">redisClient</span> <span class="operator">=</span> RedisClient.create(uri);</span><br><span class="line">        <span class="comment">//创建连接</span></span><br><span class="line">        StatefulRedisConnection&lt;String, String&gt; connect = redisClient.connect();</span><br><span class="line">        <span class="comment">//创建redis同步操作命令</span></span><br><span class="line">        RedisCommands&lt;String, String&gt; commands = connect.sync();</span><br><span class="line">        <span class="comment">//string</span></span><br><span class="line">        log.info(<span class="string">&quot;=======string======&quot;</span>);</span><br><span class="line">        commands.set(<span class="string">&quot;k1&quot;</span>,<span class="string">&quot;v1&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;string：&#123;&#125;&quot;</span>,commands.get(<span class="string">&quot;k1&quot;</span>));</span><br><span class="line">        <span class="comment">//list</span></span><br><span class="line">        log.info(<span class="string">&quot;========list=========&quot;</span>);</span><br><span class="line">        commands.lpush(<span class="string">&quot;list&quot;</span>,<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>,<span class="string">&quot;3&quot;</span>,<span class="string">&quot;4&quot;</span>,<span class="string">&quot;5&quot;</span>);</span><br><span class="line">        List&lt;String&gt; list = commands.lrange(<span class="string">&quot;list&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        list.forEach(System.out::println);</span><br><span class="line">        log.info(<span class="string">&quot;=======set=======&quot;</span>);</span><br><span class="line">        commands.sadd(<span class="string">&quot;set&quot;</span>,<span class="string">&quot;set1&quot;</span>,<span class="string">&quot;set2&quot;</span>,<span class="string">&quot;set3&quot;</span>);</span><br><span class="line">        Set&lt;String&gt; set = commands.smembers(<span class="string">&quot;set&quot;</span>);</span><br><span class="line">        set.forEach(System.out::println);</span><br><span class="line">        log.info(<span class="string">&quot;=======hash=======&quot;</span>);</span><br><span class="line">        HashMap&lt;String, String&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;k1&quot;</span>, <span class="string">&quot;v1&quot;</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;k2&quot;</span>, <span class="string">&quot;v2&quot;</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;k3&quot;</span>, <span class="string">&quot;v3&quot;</span>);</span><br><span class="line">        commands.hset(<span class="string">&quot;hash&quot;</span>,hashMap);</span><br><span class="line">        Map&lt;String, String&gt; hash = commands.hgetall(<span class="string">&quot;hash&quot;</span>);</span><br><span class="line">        hash.keySet().forEach(System.out::println);</span><br><span class="line">        log.info(<span class="string">&quot;=======zset=======&quot;</span>);</span><br><span class="line">        commands.zadd(<span class="string">&quot;zset&quot;</span>,<span class="number">20d</span>,<span class="string">&quot;20&quot;</span>);</span><br><span class="line">        commands.zadd(<span class="string">&quot;zset&quot;</span>,<span class="number">30d</span>,<span class="string">&quot;30&quot;</span>);</span><br><span class="line">        commands.zadd(<span class="string">&quot;zset&quot;</span>,<span class="number">60d</span>,<span class="string">&quot;60&quot;</span>);</span><br><span class="line">        List&lt;String&gt; zset = commands.zrange(<span class="string">&quot;zset&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">        zset.forEach(System.out::println);</span><br><span class="line">        <span class="comment">//关闭资源</span></span><br><span class="line">        redisClient.shutdown();</span><br><span class="line">        redisClient.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="RedisTemplate"><a href="#RedisTemplate" class="headerlink" title="RedisTemplate"></a>RedisTemplate</h3><p>pom</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- redis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- swagger3 OpenAPI --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springdoc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springdoc-openapi-starter-webmvc-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Redis7_study</span></span><br><span class="line">  <span class="attr">swagger2:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span> <span class="comment"># 是否开启swagger</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.128</span> <span class="comment"># redis IP 地址</span></span><br><span class="line">      <span class="attr">database:</span> <span class="number">0</span> <span class="comment"># redis 0号数据库</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span> <span class="comment"># redis 端口</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">redis</span> <span class="comment"># redis 密码</span></span><br><span class="line">      <span class="attr">lettuce:</span></span><br><span class="line">        <span class="attr">pool:</span> <span class="comment"># lettuce 连接池</span></span><br><span class="line">          <span class="attr">max-active:</span> <span class="number">8</span> <span class="comment"># 连接池最大连接数</span></span><br><span class="line">          <span class="attr">max-wait:</span> <span class="string">-1ms</span> <span class="comment"># 连接池最大阻塞等待</span></span><br><span class="line">          <span class="attr">max-idle:</span> <span class="number">8</span> <span class="comment"># 连接池最大空闲连接</span></span><br><span class="line">          <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 连接池最小空闲连接</span></span><br></pre></td></tr></table></figure><p>service</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ORDER_KEY</span> <span class="operator">=</span> <span class="string">&quot;order:&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addOrder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">keyId</span> <span class="operator">=</span> ThreadLocalRandom.current().nextInt(<span class="number">100</span>) + <span class="number">1</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">order_id</span> <span class="operator">=</span> UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> ORDER_KEY + keyId;</span><br><span class="line">        redisTemplate.opsForValue().set(key, <span class="string">&quot;京东订单：&quot;</span>+order_id);</span><br><span class="line">        log.info(<span class="string">&quot;*****京东订单已生成：编号&#123;&#125;,订单号&#123;&#125;&quot;</span>,key,order_id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOrder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (String) redisTemplate.opsForValue().get(ORDER_KEY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>controller</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Tag(name = &quot;订单接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/order/add&quot;)</span></span><br><span class="line">    <span class="meta">@Operation(summary = &quot;新增订单&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        orderService.addOrder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/order/getOder/&#123;orderId&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@Operation(summary = &quot;根据order获取订单&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getOrder</span><span class="params">(<span class="meta">@PathVariable(&quot;orderId&quot;)</span> String orderId)</span> &#123;</span><br><span class="line">        orderService.getOrder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动运行</p><p><code>http://localhost:8080/swagger-ui/index.html</code></p><p>测试 <code>addOrder</code></p><p><img src="/hexo-docs/images/redisImages/image-20250423172232663.png" alt="image-20250423172232663"></p><p>发现乱码，明明启动的时候已经添加了，解析中文的命令了，怎么还会乱码？</p><p><img src="/hexo-docs/images/redisImages/image-20250423172632147.png" alt="image-20250423172632147"></p><p>阅读RedisTemplate源码后发现，默认情况下，RedisTemplate 使用该数据列化方式，我们来看下源码 RedisTemplate#afterPropertiesSet()</p><p>解决方法</p><ol><li><p>不用<code>RedisTemplate</code>改用<code>StringRedisTemplate</code></p><p>orderService</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ORDER_KEY</span> <span class="operator">=</span> <span class="string">&quot;order:&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addOrder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">keyId</span> <span class="operator">=</span> ThreadLocalRandom.current().nextInt(<span class="number">100</span>) + <span class="number">1</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">order_id</span> <span class="operator">=</span> UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> ORDER_KEY + keyId;</span><br><span class="line">        stringRedisTemplate.opsForSet().add(key, order_id);</span><br><span class="line">        log.info(<span class="string">&quot;*****京东订单已生成：编号&#123;&#125;,订单号&#123;&#125;&quot;</span>,key,order_id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOrder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stringRedisTemplate.opsForValue().get(ORDER_KEY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在测试一下</p><p><img src="/hexo-docs/images/redisImages/image-20250423173345696.png" alt="image-20250423173345696"></p><p>发现没有问题</p></li><li><p>继续使用<code>RedisTemplate</code>，添加<code>RedisConfig</code></p><p>在RedisConfig里面 去指定序列化方式</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * redis序列化的工具配置类，下面这个请一定开启配置</span></span><br><span class="line"><span class="comment">     * 127.0.0.1:6379&gt; keys *</span></span><br><span class="line"><span class="comment">     * 1) &quot;ord:102&quot;  序列化过</span></span><br><span class="line"><span class="comment">     * 2) &quot;\xac\xed\x00\x05t\x00\aord:102&quot;   野生，没有序列化过</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForValue(); //提供了操作string类型的所有方法</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForList(); // 提供了操作list类型的所有方法</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForSet(); //提供了操作set的所有方法</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForHash(); //提供了操作hash表的所有方法</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForZSet(); //提供了操作zset的所有方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lettuceConnectionFactory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(LettuceConnectionFactory lettuceConnectionFactory)</span></span><br><span class="line">    &#123;</span><br><span class="line">        RedisTemplate&lt;String,Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        redisTemplate.setConnectionFactory(lettuceConnectionFactory);</span><br><span class="line">        <span class="comment">//设置key序列化方式string</span></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        <span class="comment">//设置value的序列化方式json，使用GenericJackson2JsonRedisSerializer替换默认序列化</span></span><br><span class="line">        redisTemplate.setValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line"></span><br><span class="line">        redisTemplate.setHashKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setHashValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line"></span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="/hexo-docs/images/redisImages/image-20250423173757259.png" alt="image-20250423173757259"></p><p>也没有问题</p></li></ol><p><code>getOder</code></p><p><img src="/hexo-docs/images/redisImages/image-20250423172552580.png" alt="image-20250423172552580"></p><h3 id="连接redis注意："><a href="#连接redis注意：" class="headerlink" title="连接redis注意："></a>连接redis注意：</h3><blockquote><ol><li>bind 配置请注释掉</li><li>保护模式设置为no</li><li>linux 系统的防火墙设置</li><li>redis服务器的IP和密码是否正确</li><li>忘记写访问redis的服务端口号和密码</li><li>slave-read-only 设置成no 要不然服务器没有读写权限</li></ol></blockquote><h3 id="Spring集成RedisTemplate集群"><a href="#Spring集成RedisTemplate集群" class="headerlink" title="Spring集成RedisTemplate集群"></a>Spring集成RedisTemplate集群</h3><ol><li><p>启动redis集6台实例</p><p><img src="/hexo-docs/images/redisImages/image-20250423180832763.png" alt="image-20250423180832763"></p><p><img src="/hexo-docs/images/redisImages/image-20250423181037369.png" alt="image-20250423181037369"></p><p><img src="/hexo-docs/images/redisImages/image-20250423181054269.png" alt="image-20250423181054269"></p><p><img src="/hexo-docs/images/redisImages/image-20250423181534546.png" alt="image-20250423181534546"></p><p>添加集群yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Redis7_study</span></span><br><span class="line">  <span class="attr">swagger2:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span> <span class="comment"># 是否开启swagger</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.128</span> <span class="comment"># redis IP 地址</span></span><br><span class="line">      <span class="attr">database:</span> <span class="number">0</span> <span class="comment"># redis 0号数据库</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span> <span class="comment"># redis 端口</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">redis</span> <span class="comment"># redis 密码</span></span><br><span class="line">      <span class="attr">lettuce:</span></span><br><span class="line">        <span class="attr">pool:</span> <span class="comment"># lettuce 连接池</span></span><br><span class="line">          <span class="attr">max-active:</span> <span class="number">8</span> <span class="comment"># 连接池最大连接数</span></span><br><span class="line">          <span class="attr">max-wait:</span> <span class="string">-1ms</span> <span class="comment"># 连接池最大阻塞等待</span></span><br><span class="line">          <span class="attr">max-idle:</span> <span class="number">8</span> <span class="comment"># 连接池最大空闲连接</span></span><br><span class="line">          <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 连接池最小空闲连接</span></span><br><span class="line">      <span class="attr">cluster:</span> <span class="comment"># 添加集群</span></span><br><span class="line">        <span class="attr">nodes:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.128</span><span class="string">:6381,192.168.0.128:6382,192.168.0.128:6383,192.168.0.128:6384,192.168.0.128:6385,192.168.0.128:6386</span></span><br></pre></td></tr></table></figure><p>启动测试</p><p><img src="/hexo-docs/images/redisImages/image-20250423181827763.png" alt="image-20250423181827763"></p><p>添加成功</p></li><li><p>问题 <strong>SpringBoot2出现的问题</strong></p><ol><li><p>人为模拟，master-6381机器意外宕机，手动shutdown</p><p><img src="/hexo-docs/images/redisImages/image-20250423182130443.png" alt="image-20250423182130443"></p></li><li><p>在对redis集群命令方式，手动验证各种读写命令，看看6384是否上位</p><ol><li>6384已经上位了</li></ol><p><img src="/hexo-docs/images/redisImages/image-20250423182241046.png" alt="image-20250423182241046"></p></li><li><p>Redis Cluster 集群能自动感知并自动完成主备切换，对应的slave6384会被选举出新的master节点</p></li><li><p>微服务客户端再次读写访问试试</p><ol><li><p>Redis Cluster集群部署采用了3主3从拓扑结构，数据读写访问master节点， slave节点负责备份。当master宕机主从切换成功，redis手动OK，but 2个经典故障</p></li><li><p><img src="/hexo-docs/images/redisImages/image-20250423182602782.png" alt="image-20250423182602782"></p></li><li><p>SpringBoot 2.X 版本，Redis 默认的连接池采用 Lettuce 当 Redis集群节点发生变化后，Lettuce  默认是不会刷新节点拓扑</p></li><li><p>解决方案</p><ol><li><p>排除 Lettuce 采用 Jedis（不推荐）</p><p><img src="/hexo-docs/images/redisImages/image-20250423182748514.png" alt="image-20250423182748514"></p></li><li><p>重写连接工厂实例（极度不推荐）</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DefaultClientResources <span class="title function_">lettuceClientResources</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> DefaultClientResources.create();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> LettuceConnectionFactory <span class="title function_">lettuceConnectionFactory</span><span class="params">(RedisProperties redisProperties, ClientResources clientResources)</span> &#123;</span><br><span class="line">    <span class="type">ClusterTopologyRefreshOptions</span> <span class="variable">topologyRefreshOptions</span> <span class="operator">=</span> ClusterTopologyRefreshOptions.builder()</span><br><span class="line">            .enablePeriodicRefresh(Duration.ofSeconds(<span class="number">30</span>)) <span class="comment">//按照周期刷新拓扑</span></span><br><span class="line">            .enableAllAdaptiveRefreshTriggers() <span class="comment">//根据事件刷新拓扑</span></span><br><span class="line">            .build();</span><br><span class="line">    <span class="type">ClusterClientOptions</span> <span class="variable">clusterClientOptions</span> <span class="operator">=</span> ClusterClientOptions.builder()</span><br><span class="line">            <span class="comment">//redis命令超时时间,超时后才会使用新的拓扑信息重新建立连</span></span><br><span class="line">            .timeoutOptions(TimeoutOptions.enabled(Duration.ofSeconds(<span class="number">10</span>)))</span><br><span class="line">            .topologyRefreshOptions(topologyRefreshOptions)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="type">LettuceClientConfiguration</span> <span class="variable">clientConfiguration</span> <span class="operator">=</span> LettuceClientConfiguration.builder()</span><br><span class="line">            .clientResources(clientResources)</span><br><span class="line">            .clientOptions(clusterClientOptions)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="type">RedisClusterConfiguration</span> <span class="variable">clusterConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisClusterConfiguration</span>(redisProperties.getCluster().getNodes());</span><br><span class="line">    clusterConfig.setMaxRedirects(redisProperties.getCluster().getMaxRedirects());</span><br><span class="line">    clusterConfig.setPassword(RedisPassword.of(redisProperties.getPassword()));</span><br><span class="line">    <span class="type">LettuceConnectionFactory</span> <span class="variable">lettuceConnectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LettuceConnectionFactory</span>(clusterConfig, clientConfiguration);</span><br><span class="line">    <span class="keyword">return</span> lettuceConnectionFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>刷新节点集群拓扑动态感应</p><p><img src="/hexo-docs/images/redisImages/image-20250423182940311.png" alt="image-20250423182940311"></p></li><li><p>改写yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Redis7_study</span></span><br><span class="line">  <span class="attr">swagger2:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span> <span class="comment"># 是否开启swagger</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.128</span> <span class="comment"># redis IP 地址</span></span><br><span class="line">      <span class="attr">database:</span> <span class="number">0</span> <span class="comment"># redis 0号数据库</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span> <span class="comment"># redis 端口</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">redis</span> <span class="comment"># redis 密码</span></span><br><span class="line">      <span class="attr">lettuce:</span></span><br><span class="line">        <span class="attr">pool:</span> <span class="comment"># lettuce 连接池</span></span><br><span class="line">          <span class="attr">max-active:</span> <span class="number">8</span> <span class="comment"># 连接池最大连接数</span></span><br><span class="line">          <span class="attr">max-wait:</span> <span class="string">-1ms</span> <span class="comment"># 连接池最大阻塞等待</span></span><br><span class="line">          <span class="attr">max-idle:</span> <span class="number">8</span> <span class="comment"># 连接池最大空闲连接</span></span><br><span class="line">          <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 连接池最小空闲连接</span></span><br><span class="line">      <span class="attr">cluster:</span> <span class="comment"># 添加集群</span></span><br><span class="line">        <span class="attr">nodes:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.128</span><span class="string">:6381,192.168.0.128:6382,192.168.0.128:6383,192.168.0.128:6384,192.168.0.128:6385,192.168.0.128:6386</span></span><br><span class="line">        <span class="attr">refresh:</span></span><br><span class="line">         <span class="attr">period:</span> <span class="number">2000</span> <span class="comment"># 定时刷新</span></span><br><span class="line">        <span class="attr">refresh:</span></span><br><span class="line">         <span class="attr">adaptive:</span> <span class="literal">true</span> <span class="comment">#支持集群拓扑动态感应刷新,自适应拓扑刷新是否使用所有可用的更新，默认false关闭</span></span><br></pre></td></tr></table></figure></li></ol></li></ol></li></ol></li></ol>]]></content>
      
      
      <categories>
          
          <category> 后端 Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>缓存预热+缓存雪崩+缓存击穿+缓存穿透</title>
      <link href="/hexo-docs/2025/08/13/redis/%E7%BC%93%E5%AD%98%E9%A2%84%E7%83%AD+%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9+%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF+%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F/"/>
      <url>/hexo-docs/2025/08/13/redis/%E7%BC%93%E5%AD%98%E9%A2%84%E7%83%AD+%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9+%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF+%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F/</url>
      
        <content type="html"><![CDATA[<h2 id="缓存预热"><a href="#缓存预热" class="headerlink" title="缓存预热"></a>缓存预热</h2><p><img src="/hexo-docs/images/redisImages/image-20250704102238568.png" alt="image-20250704102238568"></p><p>使用<code>@PostConstruct</code>初始化白名单数据</p><h2 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h2><ul><li><p>发生</p><ul><li>redis主机挂了，redis 全盘崩溃，偏硬件运维</li><li>redis中有大量key同时过期大面积失效，偏软件开发</li></ul></li><li><p>预防+解决</p><ul><li>redis中key设置为永不过期或过期时间错开</li><li>redis缓存集群实现高可用<ul><li>主从节点</li><li>Redis Cluster（redis集群）</li><li>开启redis持久化机制aof&#x2F;rdb，尽快恢复缓存集群</li></ul></li><li>多缓存结合预防雪崩<ul><li>ehcache本地缓存+redis缓存</li></ul></li><li>服务降级<ul><li>Hystrix或者阿里Sentinel限流&amp;降级</li></ul></li><li>人民币玩家<ul><li>阿里云数据库Redis版</li><li><a href="https://www.aliyun.com/activity/database/bestoffers?utm_content=se_1019851947">数据库上云优选_数据库产品低至3折起-阿里云权益中心</a></li></ul></li></ul></li></ul><h2 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h2><p>  请求去查询一条记录，先查redis（无），后查mysql（无），都查不到该条记录，但是请求每次都会打到数据库上面去，导致后台数据库暴增，这种现象称为<strong>缓存穿透</strong>。</p><h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p><img src="/hexo-docs/images/redisImages/image-20250704103149152.png" alt="image-20250704103149152"></p><ul><li><p>空对象缓存或者缺省值（只能解决暂时）</p><ul><li><p>一般ok</p><ul><li><strong>第一种解决方案，回写增强</strong></li></ul><p>如果发生了缓存穿透，我们可以针对要查询的数据，在Redis里存一个和业务部门商量后确定的缺省值(比如，零、负数、defaultNull等)。</p><p>比如，键uid:abcdxxx，值defaultNull作为案例的key和value</p><p>先去redis查键uid:abcdxxx没有，再去mysql查没有获得 ，这就发生了一次穿透现象。</p><p>but，可以增强回写机制</p><p>mysql也查不到的话也让redis存入刚刚查不到的key并保护mysql。</p><p>第一次来查询uid:abcdxxx，redis和mysql都没有，返回null给调用者，但是增强回写后第二次来查uid:abcdxxx，此时redis就有值了。</p><p>可以直接从Redis中读取default缺省值返回给业务应用程序，避免了把大量请求发送给mysql处理，打爆mysql。</p><p><strong>但是，此方法架不住黑客的恶意攻击，有缺陷……，只能解决key相同的情况</strong></p></li><li><p>但是黑客或者恶意攻击</p><ul><li>黑客会对你的系统进行攻击，拿一个不存在的id去查询数据，会产生大量的请求到数据库去查询。可能会导致你的数据库由于压力过大而宕掉。</li><li>key相同打你系统<ul><li>第一次打到mysql，空对象缓存后第二次defaultNull缺省值，避免mysql被攻击，不用再到数据库中去走一圈了</li></ul></li><li>key不同打你系统<ul><li>由于存在空对象缓存和缓存会写（看自己业务不限死），redis中的无关紧要的key也会越写越多（<strong>记得设置redis过期时间</strong>）</li></ul></li></ul></li></ul></li><li><p>Google布隆过滤器Guava解决缓存穿透</p><ul><li><p>Guava 中布隆过滤器的实现算是比较权威的，所以实际项目中我们可以直接使用Guava布隆过滤器</p><p>案例</p><ul><li><p>架构说明</p><ul><li><img src="/hexo-docs/images/redisImages/image-20250704115619799.png" alt="image-20250704115619799"></li></ul></li><li><p>误判问题，但是概率小可以接受，不能从布隆过滤器删除</p></li><li><p>全部合法的key都需要放入Guava版本布隆过滤器+redis里面，不然数据就是返回null</p></li><li><p><code>pom</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--guava Google 开源的 Guava 中自带的布隆过滤器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>23.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- redis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><code>yaml</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Redis7_study</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.133</span> <span class="comment"># redis IP 地址</span></span><br><span class="line">      <span class="attr">database:</span> <span class="number">0</span> <span class="comment"># redis 0号数据库</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span> <span class="comment"># redis 端口</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">redis</span> <span class="comment"># redis 密码</span></span><br><span class="line">      <span class="attr">lettuce:</span></span><br><span class="line">        <span class="attr">pool:</span> <span class="comment"># lettuce 连接池</span></span><br><span class="line">          <span class="attr">max-active:</span> <span class="number">8</span> <span class="comment"># 连接池最大连接数</span></span><br><span class="line">          <span class="attr">max-wait:</span> <span class="string">-1ms</span> <span class="comment"># 连接池最大阻塞等待</span></span><br><span class="line">          <span class="attr">max-idle:</span> <span class="number">8</span> <span class="comment"># 连接池最大空闲连接</span></span><br><span class="line">          <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 连接池最小空闲连接</span></span><br></pre></td></tr></table></figure><p>小demo</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.google.common.hash.BloomFilter;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.google.common.hash.Funnels;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Redis7StudyApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">guavaWithBloomFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//创建布隆过滤器</span></span><br><span class="line">        BloomFilter&lt;Integer&gt; bloomFilter = BloomFilter.create(Funnels.integerFunnel(), <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//是否有该数据</span></span><br><span class="line">        System.out.println(bloomFilter.mightContain(<span class="number">1</span>));</span><br><span class="line">        System.out.println(bloomFilter.mightContain(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加数据</span></span><br><span class="line">        bloomFilter.put(<span class="number">1</span>);</span><br><span class="line">        bloomFilter.put(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">//是否有该数据</span></span><br><span class="line">        System.out.println(bloomFilter.mightContain(<span class="number">1</span>));</span><br><span class="line">        System.out.println(bloomFilter.mightContain(<span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/hexo-docs/images/redisImages/image-20250704120703494.png" alt="image-20250704120703494"></p></li><li><p>实操：取样本100w数据，查查不在100w范围内，其他10w数据是否存在</p><p><code>GuavaBloomFilterService</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.google.common.hash.BloomFilter;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.google.common.hash.Funnels;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuavaBloomFilterService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">_1W</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">SIZE</span> <span class="operator">=</span> <span class="number">100</span> * _1W;<span class="comment">//100w条数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">double</span> <span class="variable">fpp</span> <span class="operator">=</span> <span class="number">0.03</span>;<span class="comment">//误判率</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BloomFilter&lt;Integer&gt; bloomFilter = BloomFilter.create(Funnels.integerFunnel(), SIZE, fpp);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">guavaBloomFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//向布隆过滤器添加100w条数据</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= SIZE ; i++) &#123;</span><br><span class="line">            bloomFilter.put(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//取10万个不在过滤器里的值，看看有多少个会被认为在过滤器里</span></span><br><span class="line">        ArrayList&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">10</span> * _1W);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> SIZE+<span class="number">1</span>; i &lt;= SIZE + (<span class="number">10</span> * _1W); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bloomFilter.mightContain(i)) &#123;</span><br><span class="line">                list.add(i);</span><br><span class="line">                log.info(<span class="string">&quot;误判了：&#123;&#125;&quot;</span>,i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;误判总数是：&#123;&#125;&quot;</span>,list.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>GuavaBloomFilterController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.GuavaBloomFilterService;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuavaBloomFilterController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> GuavaBloomFilterService guavaBloomFilterService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/guavaFilter&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">guavaFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        guavaBloomFilterService.guavaBloomFilter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>结果</p><p><img src="/hexo-docs/images/redisImages/image-20250704122108315.png" alt="image-20250704122108315"></p></li></ul></li><li><p>为什么误判率写0.03</p><p>Guava选择<strong>0.03作为默认误判率</strong>，本质是在内存开销（空间）与准确性（误报）间选取的<strong>工程最优解</strong>。用户可根据业务需求灵活调整，但若未显式指定，0.03能确保大多数场景下高效且可靠。hash函数占5个，效率更好，如果越精确，效率越慢！</p><table><thead><tr><th align="left">FPP</th><th align="left">哈希函数数量</th><th align="left">内存占用 (百万元素)</th><th align="left">适用场景</th></tr></thead><tbody><tr><td align="left">0.01</td><td align="left">7</td><td align="left">~11.5 MB</td><td align="left">高精度要求（如安全）</td></tr><tr><td align="left"><strong>0.03</strong></td><td align="left">5</td><td align="left"><strong>~7.1 MB</strong></td><td align="left"><strong>通用默认（Guava）</strong></td></tr><tr><td align="left">0.1</td><td align="left">4</td><td align="left">~4.8 MB</td><td align="left">内存敏感场景</td></tr></tbody></table><p><img src="/hexo-docs/images/redisImages/image-20250704122337666.png" alt="image-20250704122337666"></p></li><li><p>布隆过滤器说明</p><p><img src="/hexo-docs/images/redisImages/image-20250704122403226.png" alt="image-20250704122403226"></p></li></ul></li></ul><h2 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h2><p>大量请求同时查询同一个key时，此时这个key正好失效，就会导致大量的请求都打到数据库上面去，简单来说就是热点key突然失效了，暴打MySQL</p><p>穿透和击穿，截然不同</p><h3 id="危害"><a href="#危害" class="headerlink" title="危害"></a>危害</h3><ul><li>会造成某一时刻数据库请求量过大，压力剧增</li><li>需要知道热点key有哪些，防止击穿</li></ul><h3 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h3><ul><li><p>热点key失效</p><ul><li>时间到了自然清除但还被访问到</li><li>delete掉的key，刚巧又被访问</li></ul></li><li><p>方案1</p><ul><li>差异失效时间，对于访问频繁的热点key，干脆就不设置过期时间</li></ul></li><li><p>方案2</p><ul><li><p>互斥更新，采用双检枷锁策略</p><p>多个线程同时去查询数据库的这条数据，那么我们可以在第一个查询数据的请求上使用一个 互斥锁来锁住它。</p><p>其他的线程走到这一步拿不到锁就等着，等第一个线程查询到了数据，然后做缓存。后面的线程进来发现已经有缓存了，就直接走缓存。</p><p> <img src="/hexo-docs/images/redisImages/image-20250629162233989.png"></p></li></ul></li></ul><h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>模拟高并发的天猫聚划算案例代码</p><table><thead><tr><th>步骤</th><th>说明</th></tr></thead><tbody><tr><td>1</td><td>100%高并发，绝对不可以用mysql实现</td></tr><tr><td>2</td><td>先把mysql里面参加活动的数据抽取进redis，一般采用定时器扫描来决定上线活动还是下线取消。</td></tr><tr><td>3</td><td>支持分页功能，一页20条记录</td></tr></tbody></table><p>redis数据类型使用list，因为zset更适合做排行榜</p><p><code>pom、yaml</code>参考上面的</p><p>实体类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Product</span> &#123;</span><br><span class="line">    <span class="comment">//产品ID</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">//产品名称</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//产品价格</span></span><br><span class="line">    <span class="keyword">private</span> Integer price;</span><br><span class="line">    <span class="comment">//产品详情</span></span><br><span class="line">    <span class="keyword">private</span> String detail;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>service</code>：采用定时器将参与聚划算活动的特价商品新增进redis中</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.pojo.Product;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JHSTaskService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY</span> <span class="operator">=</span> <span class="string">&quot;jhs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Product&gt; <span class="title function_">getProductFormMysql</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Product&gt; productList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">20</span>; i++) &#123;</span><br><span class="line">            <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">            <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> random.nextInt(<span class="number">100</span>);</span><br><span class="line">            <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>((<span class="type">long</span>) id, <span class="string">&quot;product&quot;</span> + i, i, <span class="string">&quot;detail&quot;</span>);</span><br><span class="line">            productList.add(product);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> productList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;启动定时器淘宝聚划算功能模拟..........&#123;&#125;&quot;</span>, System.currentTimeMillis());</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">//模拟定时器后台一个任务，定时把数据库的特价商品，刷新到redis中</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">//模拟从数据库读取20件特价商品，用于加载到聚划算的页面中</span></span><br><span class="line">                List&lt;Product&gt; list = <span class="built_in">this</span>.getProductFormMysql();</span><br><span class="line">                <span class="comment">//先删除redis有的key</span></span><br><span class="line">                redisTemplate.delete(KEY);</span><br><span class="line">                <span class="comment">//使用lpush添加到redis中</span></span><br><span class="line">                redisTemplate.opsForList().leftPush(KEY, list);</span><br><span class="line">                <span class="comment">//间隔一分钟 执行一遍，模拟聚划算每3天刷新一批次参加活动</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">&quot;runJhs定时刷新....&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>controller</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.pojo.Product;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JHSProductController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY</span> <span class="operator">=</span> <span class="string">&quot;jhs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Product&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/product/find&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Product&gt; <span class="title function_">find</span><span class="params">(<span class="type">int</span> page, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        List&lt;Product&gt; productList = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> (<span class="type">long</span>) (page - <span class="number">1</span>) * size;</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> start + size;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//采用redis list数据结构的lrange命令实现分页查询</span></span><br><span class="line">            productList = redisTemplate.opsForList().range(KEY, start, end);</span><br><span class="line">            <span class="keyword">if</span> (productList != <span class="literal">null</span> &amp;&amp; productList.isEmpty()) &#123;</span><br><span class="line">                <span class="comment">//TODO 查询mysql</span></span><br><span class="line">            &#125;</span><br><span class="line">            log.info(<span class="string">&quot;查询结果：&#123;&#125;&quot;</span>,productList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//这里的异常，一般是redis瘫痪 ，或 redis网络timeout</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">//TODO 走MySQL查询</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> productList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="bug和隐患"><a href="#bug和隐患" class="headerlink" title="bug和隐患"></a>bug和隐患</h3><p>热点key突然失效导致可怕的缓存击穿</p><p><img src="/hexo-docs/images/redisImages/image-20250705135318742.png" alt="image-20250705135318742"></p><p><img src="/hexo-docs/images/redisImages/image-20250705135327790.png" alt="image-20250705135327790"></p><ul><li>delete命令执行的一瞬间有空隙，其他请求线程继续找Redis为null</li><li>打到了mysql，暴击….</li></ul><p><img src="/hexo-docs/images/redisImages/image-20250705135428008.png" alt="image-20250705135428008"></p><p>最终目的</p><ul><li>两条原子性还是其次，主要是防止key突然失效暴击mysql打爆系统</li></ul><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><ul><li><p>采用双检枷锁策略</p><p>多个线程同时去查询数据库的这条数据，那么我们可以在第一个查询数据的请求上使用一个 互斥锁来锁住它。</p><p>其他的线程走到这一步拿不到锁就等着，等第一个线程查询到了数据，然后做缓存。后面的线程进来发现已经有缓存了，就直接走缓存。</p><p> <img src="/hexo-docs/images/redisImages/image-20250629162233989.png"></p></li><li><p>差异失效时间</p><p><img src="/hexo-docs/images/redisImages/image-20250705135638675.png" alt="image-20250705135638675"></p></li></ul><p>我们采用差异失效时间来设置</p><p>更新<code>JHSTaskService</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.pojo.Product;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JHSTaskService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_A</span> <span class="operator">=</span> <span class="string">&quot;jhs:a&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_B</span> <span class="operator">=</span> <span class="string">&quot;jhs:b&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Product&gt; <span class="title function_">getProductFormMysql</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Product&gt; productList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">20</span>; i++) &#123;</span><br><span class="line">            <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">            <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> random.nextInt(<span class="number">100</span>);</span><br><span class="line">            <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>((<span class="type">long</span>) id, <span class="string">&quot;product&quot;</span> + i, i, <span class="string">&quot;detail&quot;</span>);</span><br><span class="line">            productList.add(product);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> productList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initAB</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;启动定时器淘宝聚划算功能模拟..........&#123;&#125;&quot;</span>, System.currentTimeMillis());</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">//模拟定时器后台一个任务，定时把数据库的特价商品，刷新到redis中</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">//模拟从数据库读取20件特价商品，用于加载到聚划算的页面中</span></span><br><span class="line">                List&lt;Product&gt; list = <span class="built_in">this</span>.getProductFormMysql();</span><br><span class="line">                <span class="comment">//删除b缓存</span></span><br><span class="line">                redisTemplate.delete(KEY_B);</span><br><span class="line">                <span class="comment">//先更新b缓存</span></span><br><span class="line">                redisTemplate.opsForList().leftPush(KEY_B, list);</span><br><span class="line">                <span class="comment">//设置b缓存的过期时间，要比a的过期时间长</span></span><br><span class="line">                redisTemplate.expire(KEY_B, <span class="number">20L</span>, TimeUnit.DAYS);</span><br><span class="line">                <span class="comment">//删除a的缓存</span></span><br><span class="line">                redisTemplate.delete(KEY_A);</span><br><span class="line">                <span class="comment">//在更新a的缓存</span></span><br><span class="line">                redisTemplate.opsForList().leftPush(KEY_A, list);</span><br><span class="line">                redisTemplate.expire(KEY_A, <span class="number">15L</span>, TimeUnit.DAYS);</span><br><span class="line">                <span class="comment">//间隔一分钟 执行一遍，模拟聚划算每3天刷新一批次参加活动</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">&quot;runJhs定时刷新双缓存AB两层....&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>更新<code>JHSProductController</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.pojo.Product;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JHSProductController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_A</span> <span class="operator">=</span> <span class="string">&quot;jhs:a&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_B</span> <span class="operator">=</span> <span class="string">&quot;jhs:b&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Product&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/product/findab&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Product&gt; <span class="title function_">findAB</span><span class="params">(<span class="type">int</span> page, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        List&lt;Product&gt; productList = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> (<span class="type">long</span>) (page - <span class="number">1</span>) * size;</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> start + size;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//采用redis list数据结构的lrange命令实现分页查询</span></span><br><span class="line">            productList = redisTemplate.opsForList().range(KEY_A, start, end);</span><br><span class="line">            <span class="keyword">if</span> (productList != <span class="literal">null</span> &amp;&amp; productList.isEmpty()) &#123;</span><br><span class="line">                <span class="comment">//查询缓存b</span></span><br><span class="line">                productList = redisTemplate.opsForList().range(KEY_B, start, end);</span><br><span class="line">                <span class="keyword">if</span> (productList!=<span class="literal">null</span>&amp;&amp;productList.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">//TODO 查询mysql</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(<span class="string">&quot;查询结果：&#123;&#125;&quot;</span>,productList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//这里的异常，一般是redis瘫痪 ，或 redis网络timeout</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">//TODO 走MySQL查询</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> productList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><img src="/hexo-docs/images/redisImages/image-20250705135428008.png" alt="image-20250705135428008"></p>]]></content>
      
      
      <categories>
          
          <category> 后端 Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
