<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Redis分布式锁 | Lazy的个人博客</title><meta name="author" content="Lazy"><meta name="copyright" content="Lazy"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="redis分布式锁目的：解决多个服务原子性的问题 在很多场景中，我们为了保证数据的最终一致性，需要很多的技术方案来支持，比如分布式事务、分布式锁等。那具体什么是分布式锁，分布式锁应用在哪些业务场景、如何来实现分布式锁呢？ 锁的种类  单机版同一个jvm虚拟机内，synchronized或者Lock接口 分布式多个不同虚拟机，单机的线程锁机制不再起作用，资源类在不同的服务器之间共享了  一个靠谱分布">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis分布式锁">
<meta property="og:url" content="https://mac2git.github.io/hexo-docs/2025/08/13/redis/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/index.html">
<meta property="og:site_name" content="Lazy的个人博客">
<meta property="og:description" content="redis分布式锁目的：解决多个服务原子性的问题 在很多场景中，我们为了保证数据的最终一致性，需要很多的技术方案来支持，比如分布式事务、分布式锁等。那具体什么是分布式锁，分布式锁应用在哪些业务场景、如何来实现分布式锁呢？ 锁的种类  单机版同一个jvm虚拟机内，synchronized或者Lock接口 分布式多个不同虚拟机，单机的线程锁机制不再起作用，资源类在不同的服务器之间共享了  一个靠谱分布">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic.crazytaxii.com/Redis_Logo.png">
<meta property="article:published_time" content="2025-08-12T16:00:00.000Z">
<meta property="article:modified_time" content="2025-08-22T17:03:35.312Z">
<meta property="article:author" content="Lazy">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.crazytaxii.com/Redis_Logo.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Redis分布式锁",
  "url": "https://mac2git.github.io/hexo-docs/2025/08/13/redis/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/",
  "image": "https://pic.crazytaxii.com/Redis_Logo.png",
  "datePublished": "2025-08-12T16:00:00.000Z",
  "dateModified": "2025-08-22T17:03:35.312Z",
  "author": [
    {
      "@type": "Person",
      "name": "Lazy",
      "url": "https://mac2git.github.io/hexo-docs"
    }
  ]
}</script><link rel="shortcut icon" href="/hexo-docs/images/webImages/logo.svg"><link rel="canonical" href="https://mac2git.github.io/hexo-docs/2025/08/13/redis/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/hexo-docs/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/hexo-docs/',
  algolia: undefined,
  localSearch: {"path":"/hexo-docs/search.xml","preload":true,"top_n_per_article":-1,"unescape":true,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":30,"languages":{"author":"作者: Lazy","link":"链接: ","source":"来源: Lazy的个人博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redis分布式锁',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/hexo-docs/images/webImages/avatar.jpg" onerror="this.onerror=null;this.src='/hexo-docs/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/hexo-docs/archives/"><div class="headline">文章</div><div class="length-num">32</div></a><a href="/hexo-docs/tags/"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/hexo-docs/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/hexo-docs/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/hexo-docs/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/hexo-docs/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/hexo-docs/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/hexo-docs/about"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://pic.crazytaxii.com/Redis_Logo.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/hexo-docs/"><span class="site-name">Lazy的个人博客</span></a><a class="nav-page-title" href="/hexo-docs/"><span class="site-name">Redis分布式锁</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/hexo-docs/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/hexo-docs/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/hexo-docs/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/hexo-docs/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/hexo-docs/about"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Redis分布式锁</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-08-12T16:00:00.000Z" title="发表于 2025-08-13 00:00:00">2025-08-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-22T17:03:35.312Z" title="更新于 2025-08-23 01:03:35">2025-08-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/hexo-docs/categories/%E5%90%8E%E7%AB%AF-Redis/">后端 Redis</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">7.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>36分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="redis分布式锁"><a href="#redis分布式锁" class="headerlink" title="redis分布式锁"></a>redis分布式锁</h2><p>目的：解决多个服务原子性的问题</p>
<p>在很多场景中，我们为了保证数据的最终一致性，需要很多的技术方案来支持，比如分布式事务、分布式锁等。那具体什么是分布式锁，分布式锁应用在哪些业务场景、如何来实现分布式锁呢？</p>
<p>锁的种类</p>
<ul>
<li>单机版同一个jvm虚拟机内，synchronized或者Lock接口</li>
<li>分布式多个不同虚拟机，单机的线程锁机制不再起作用，资源类在不同的服务器之间共享了</li>
</ul>
<p>一个靠谱分布式锁需要具备的条件和刚需</p>
<ul>
<li><p>独占性</p>
<p>OnlyOne，任何时刻只能有且仅有一个线程持有</p>
</li>
<li><p>高可用</p>
<p>若redis集群环境下，不能因为某一个节点挂了而出现获取锁和释放锁失败的情况</p>
<p>高并发请求下，依旧性能ok好使</p>
</li>
<li><p>防死锁</p>
<p>杜绝死锁，必须有超时控制机制或者撤销操作，有个兜底终止跳出方案</p>
</li>
<li><p>不乱抢</p>
<p>不能私下unlock（解）别人的锁，只能自己加锁自己释放</p>
</li>
<li><p>重入性</p>
<p>同一个节点的同一个线程如何获得锁之后，它也可以再次获得这个锁。</p>
</li>
</ul>
<p>分布式锁</p>
<p><img src="/hexo-docs/images/redisImages/image-20250706154309003.png" alt="image-20250706154309003"></p>
<h2 id="案例1"><a href="#案例1" class="headerlink" title="案例1"></a>案例1</h2><p>使用场景：多个服务间保证同一时刻同一时间段内同一用户只能有一个请求（防止关键业务出现并发攻击）</p>
<p>两个服务，分别是<code>redis_distributed_lock2</code>和<code>redis_distributed_lock3</code>代码一样端口号不一样</p>
<p><code>pom</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--SpringBoot通用依赖模块--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--SpringBoot与Redis整合依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--通用基础配置boottest/lombok/hutool--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.36<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7777</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis_distributed_lock2</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.134</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">lettuce:</span></span><br><span class="line">        <span class="attr">pool:</span></span><br><span class="line">          <span class="attr">max-idle:</span> <span class="number">8</span></span><br><span class="line">          <span class="attr">max-wait:</span> <span class="string">-1ms</span></span><br><span class="line">          <span class="attr">max-active:</span> <span class="number">8</span></span><br><span class="line">          <span class="attr">min-idle:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">database:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><code>config</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(LettuceConnectionFactory lettuceConnectionFactory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(lettuceConnectionFactory);</span><br><span class="line">        <span class="comment">//设置key的序列化方式string</span></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        <span class="comment">//设置value序列化方式json</span></span><br><span class="line">        redisTemplate.setValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setHashKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setHashValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>service</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span>(inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>,String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span>+inventoryNumber;</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;服务端口号：&quot;</span>+port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>controller</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.service.InventoryService;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> InventoryService inventoryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/inventory/sale&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> inventoryService.sale();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>nginx配置</p>
<p><img src="/hexo-docs/images/redisImages/image-20250706164748316.png" alt="image-20250706164748316"></p>
<p>使用<code>start nginx</code>启动即可</p>
<p>测试：</p>
<p><img src="/hexo-docs/images/redisImages/image-20250706165511889.png" alt="image-20250706165511889"></p>
<p>没问题！使用压测工具同时开启100个线程访问</p>
<p><img src="/hexo-docs/images/redisImages/image-20250706165259013.png" alt="image-20250706165259013"></p>
<p><img src="/hexo-docs/images/redisImages/image-20250706165312138.png" alt="image-20250706165312138"></p>
<p>加了lock还是出现超卖的现象，在分布式下毫无意义，因为lock只适用于单服务！</p>
<h3 id="第一次改造-递归重试"><a href="#第一次改造-递归重试" class="headerlink" title="第一次改造(递归重试)"></a>第一次改造(递归重试)</h3><p>接下来改造我们的<code>service</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;lock&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> IdUtil.simpleUUID()+<span class="string">&quot;:&quot;</span>+Thread.currentThread().getId();<span class="comment">//uuid+当前线程id</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, value);</span><br><span class="line">        <span class="comment">//判断是否获得锁</span></span><br><span class="line">        <span class="keyword">if</span> (Boolean.FALSE.equals(flag))&#123;</span><br><span class="line">            <span class="comment">//未获得锁，停留20毫秒继续抢</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">20</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.sale();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//获得锁</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//1 查询库存信息</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">                <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">                <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">                <span class="comment">//3 扣减库存</span></span><br><span class="line">                <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">                    retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">                    System.out.println(retMessage);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//删除锁</span></span><br><span class="line">                stringRedisTemplate.delete(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动测试，我们要把值修改为5000，我们要使用1秒2w线程数进行压测</p>
<p><img src="/hexo-docs/images/redisImages/image-20250706172931582.png" alt="image-20250706172931582"></p>
<p><img src="/hexo-docs/images/redisImages/image-20250706172953495.png" alt="image-20250706172953495"></p>
<p><img src="/hexo-docs/images/redisImages/image-20250706173002069.png" alt="image-20250706173002069"></p>
<p>这是我们的锁</p>
<p><img src="/hexo-docs/images/redisImages/image-20250706173123232.png" alt="image-20250706173123232"></p>
<p>递归是一种思想没错，但是容易导致<code>StackOverflowError</code>，不太推荐，需要进一步完善，另外，高并发唤醒后推荐用white判断而不是if</p>
<h3 id="第二次改造（while替代）"><a href="#第二次改造（while替代）" class="headerlink" title="第二次改造（while替代）"></a>第二次改造（while替代）</h3><p>继续改造<code>service</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;lock&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> IdUtil.simpleUUID()+<span class="string">&quot;:&quot;</span>+Thread.currentThread().getId();<span class="comment">//uuid+当前线程id</span></span><br><span class="line">        <span class="keyword">while</span> (Boolean.FALSE.equals(stringRedisTemplate.opsForValue().setIfAbsent(key, value))) &#123;</span><br><span class="line">            <span class="comment">//休眠20毫秒</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">20</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获得锁</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//删除锁</span></span><br><span class="line">            stringRedisTemplate.delete(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续进行压测，压测1轮3000</p>
<p><img src="/hexo-docs/images/redisImages/image-20250706175549309.png" alt="image-20250706175549309"></p>
<p><img src="/hexo-docs/images/redisImages/image-20250706175558294.png" alt="image-20250706175558294"></p>
<p><img src="/hexo-docs/images/redisImages/image-20250706175612817.png" alt="image-20250706175612817"></p>
<p>问题：</p>
<ul>
<li>部署了微服务的java程序机器挂了，代码层面根本没有走到finally这块，没办法保证解锁（无过期时间改key一直存在），这个key没有被删除，需要加入一个过期时间限定key</li>
</ul>
<h3 id="第三次改造（宕机与过期-防止死锁）"><a href="#第三次改造（宕机与过期-防止死锁）" class="headerlink" title="第三次改造（宕机与过期+防止死锁）"></a>第三次改造（宕机与过期+防止死锁）</h3><p>设置key的过期时间，设置过期时间为30秒</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;lock&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> IdUtil.simpleUUID()+<span class="string">&quot;:&quot;</span>+Thread.currentThread().getId();<span class="comment">//uuid+当前线程id</span></span><br><span class="line">        <span class="keyword">while</span> (Boolean.FALSE.equals(stringRedisTemplate.opsForValue().setIfAbsent(key, value,<span class="number">30L</span>, TimeUnit.SECONDS))) &#123;</span><br><span class="line">            <span class="comment">//休眠20毫秒</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">20</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获得锁</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//删除锁</span></span><br><span class="line">            stringRedisTemplate.delete(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在进行压测</p>
<p><img src="/hexo-docs/images/redisImages/image-20250706180901881.png" alt="image-20250706180901881"></p>
<p>结论：</p>
<ul>
<li>加锁和过期时间必须设置同一行，保证原子性</li>
</ul>
<h3 id="第四次改造（防止误删key的问题）"><a href="#第四次改造（防止误删key的问题）" class="headerlink" title="第四次改造（防止误删key的问题）"></a>第四次改造（防止误删key的问题）</h3><p><img src="/hexo-docs/images/redisImages/image-20250706182055589.png" alt="image-20250706182055589"></p>
<p>只能删除自己的，不许删除别人的锁</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;lock&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> IdUtil.simpleUUID()+<span class="string">&quot;:&quot;</span>+Thread.currentThread().getId();<span class="comment">//uuid+当前线程id</span></span><br><span class="line">        <span class="keyword">while</span> (Boolean.FALSE.equals(stringRedisTemplate.opsForValue().setIfAbsent(key, value,<span class="number">30L</span>, TimeUnit.SECONDS))) &#123;</span><br><span class="line">            <span class="comment">//休眠20毫秒</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">20</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获得锁</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//判断不为空，才能进行equals判断</span></span><br><span class="line">            <span class="keyword">if</span> (Objects.requireNonNull(stringRedisTemplate.opsForValue().get(key)).equalsIgnoreCase(value)) &#123;</span><br><span class="line">                <span class="comment">//删除锁</span></span><br><span class="line">                stringRedisTemplate.delete(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存在问题，最后判断和删除不是原子性操作，需要使用lua脚本确保一致性操作</p>
<h3 id="第五次改造（保证原子性，使用lua脚本）"><a href="#第五次改造（保证原子性，使用lua脚本）" class="headerlink" title="第五次改造（保证原子性，使用lua脚本）"></a>第五次改造（保证原子性，使用lua脚本）</h3><p><img src="/hexo-docs/images/redisImages/image-20250707101521381.png" alt="image-20250707101521381"></p>
<h4 id="Lua脚本"><a href="#Lua脚本" class="headerlink" title="Lua脚本"></a>Lua脚本</h4><p>redis调用Lua脚本通过eval命令保证代码执行的原子性，直接用return返回脚本执行后的结果值</p>
<p>eval命令</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">EVAL script numkeys key [key ...] arg [arg ...]</span><br><span class="line">#numkeys 代表参数个数</span><br><span class="line">#key 是键</span><br><span class="line">#arg 是具体key的值</span><br></pre></td></tr></table></figure>

<p>hello world入门</p>
<ol>
<li><p>hello lua</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; EVAL &quot;return &#x27;hello lua&#x27;&quot; <span class="number">0</span> </span><br><span class="line">&quot;hello lua&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>set k1 v1 get k1</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; EVAL &quot;redis.<span class="keyword">call</span>(&#x27;<span class="built_in">set</span>&#x27;,&#x27;k1&#x27;,&#x27;v1&#x27;) return redis.<span class="keyword">call</span>(&#x27;get&#x27;,&#x27;k1&#x27;)&quot; <span class="number">0</span></span><br><span class="line">&quot;v1&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>mset</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; EVAL &quot;return redis.<span class="keyword">call</span>(&#x27;mset&#x27;,KEYS[<span class="number">1</span>],ARGV[<span class="number">1</span>],KEYS[<span class="number">2</span>],ARGV[<span class="number">2</span>]) &quot; <span class="number">2</span> k1 k2 v1 v2</span><br><span class="line">OK</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get k1</span><br><span class="line">&quot;v1&quot;</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get k2</span><br><span class="line">&quot;v2&quot;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>Lua脚本进一步</p>
<ul>
<li><p>条件判断语法</p>
<p><img src="/hexo-docs/images/redisImages/image-20250707102719142.png" alt="image-20250707102719142"></p>
</li>
<li><p>条件判断案例</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get keys</span><br><span class="line">&quot;<span class="number">1</span>&quot;</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; EVAL &quot;<span class="keyword">if</span> redis.<span class="keyword">call</span>(&#x27;get&#x27;,KEYS[<span class="number">1</span>])==ARGV[<span class="number">1</span>] then return redis.<span class="keyword">call</span>(&#x27;<span class="built_in">del</span>&#x27;,KEYS[<span class="number">1</span>]) <span class="keyword">else</span> return <span class="number">0</span> end&quot; <span class="number">1</span> keys <span class="number">2</span></span><br><span class="line">(integer) <span class="number">0</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; EVAL &quot;<span class="keyword">if</span> redis.<span class="keyword">call</span>(&#x27;get&#x27;,KEYS[<span class="number">1</span>])==ARGV[<span class="number">1</span>] then return redis.<span class="keyword">call</span>(&#x27;<span class="built_in">del</span>&#x27;,KEYS[<span class="number">1</span>]) <span class="keyword">else</span> return <span class="number">0</span> end&quot; <span class="number">1</span> keys <span class="number">1</span></span><br><span class="line">(integer) <span class="number">1</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>改造</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;lock&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> IdUtil.simpleUUID()+<span class="string">&quot;:&quot;</span>+Thread.currentThread().getId();<span class="comment">//uuid+当前线程id</span></span><br><span class="line">        <span class="keyword">while</span> (Boolean.FALSE.equals(stringRedisTemplate.opsForValue().setIfAbsent(key, value,<span class="number">30L</span>, TimeUnit.SECONDS))) &#123;</span><br><span class="line">            <span class="comment">//休眠20毫秒</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">20</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获得锁</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span> (inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>, String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span> + inventoryNumber;</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//添加lua脚本，确保原子性</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">luaScript</span> <span class="operator">=</span> <span class="string">&quot;if redis.call(&#x27;get&#x27;,KEYS[1]) == ARGV[1] then &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;return redis.call(&#x27;del&#x27;,KEYS[1]) &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;else return 0 end&quot;</span>;</span><br><span class="line">            stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(luaScript,Boolean.class), List.of(key),value);<span class="comment">//使用该构造方法，不然报错</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;服务端口号：&quot;</span> + port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get lock</span><br><span class="line">&quot;<span class="number">7</span>f5195a7954d468aa32830d9ebedcdd6:<span class="number">244</span>&quot;</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get lock</span><br><span class="line">&quot;<span class="number">4721213967994</span>ef28ce98ee6ed3a68bc:<span class="number">76</span>&quot;</span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; get lock</span><br><span class="line">&quot;e9d20717da254f5b930fc04b6e983974:<span class="number">47</span>&quot;</span><br></pre></td></tr></table></figure>

<p>保证了程序的原子性！</p>
<h3 id="第六次改造"><a href="#第六次改造" class="headerlink" title="第六次改造"></a>第六次改造</h3><p>while判断并自旋重试获得锁+setnx含自然过期时间+Lua脚本删除锁命令</p>
<p>问题</p>
<ul>
<li>如何兼顾锁的可重入性问题？</li>
</ul>
<p>一个靠谱分布式锁需要具备的条件和刚需</p>
<ul>
<li>独占性</li>
<li>高可用</li>
<li>防死锁</li>
<li>不乱抢</li>
<li>重入性</li>
</ul>
<h4 id="可重入锁（又名递归锁）"><a href="#可重入锁（又名递归锁）" class="headerlink" title="可重入锁（又名递归锁）"></a>可重入锁（又名递归锁）</h4><p>是指在同一个线程在外层方法获取锁的时候，再进入该线程的内层方法会自动获取锁(前提，锁对象得是同一个对象)，不会因为之前已经获取过还没释放而阻塞。</p>
<p>如果是1个有 synchronized 修饰的递归调用方法，程序第2次进入被自己阻塞了岂不是天大的笑话，出现了作茧自缚。</p>
<p>所以Java中ReentrantLock和synchronized都是可重入锁，可重入锁的一个优点是可一定程度避免死锁。</p>
<p>可重入锁种类</p>
<ul>
<li><p>隐式锁（即synchronized关键字使用的锁）默认是可重入锁</p>
<p>指的是可重复可递归调用的锁，在外层使用锁之后，在内层仍然可以使用，并且不发生死锁，这样的锁就叫做可重入锁。</p>
<p>简单的来说就是：在一个synchronized修饰的方法或代码块的内部调用本类的其他synchronized修饰的方法或代码块时，是永远可以得到锁的</p>
<p>与可重入锁相反，不可重入锁不可递归调用，递归调用就发生死锁。</p>
<ul>
<li><p>同步块</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReEntryLockDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockBlock</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">           <span class="keyword">synchronized</span> (obj)&#123;</span><br><span class="line">               System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---外层调用&quot;</span>);</span><br><span class="line">               <span class="keyword">synchronized</span> (obj)&#123;</span><br><span class="line">                   System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---中层调用&quot;</span>);</span><br><span class="line">                   <span class="keyword">synchronized</span> (obj)&#123;</span><br><span class="line">                       System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---内层调用&quot;</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ReEntryLockDemo</span> <span class="variable">reEntryLockDemo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReEntryLockDemo</span>();</span><br><span class="line">        reEntryLockDemo.lockBlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>同步方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReEntryLockDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">lockMethod</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---外层调用&quot;</span>);</span><br><span class="line">        lockMethod2();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">lockMethod2</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---中层调用&quot;</span>);</span><br><span class="line">        lockMethod3();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">lockMethod3</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---内层调用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ReEntryLockDemo</span> <span class="variable">reEntryLockDemo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReEntryLockDemo</span>();</span><br><span class="line">        reEntryLockDemo.lockMethod();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Synchronized的重入的实现原理</p>
<p><span style="color:#FF3333;">每个锁对象拥有一个锁计数器和一个指向持有该锁的线程的指针。</span></p>
<p>当执行monitorenter时，如果目标锁对象的计数器为零，那么说明它没有被其他线程所持有，Java虚拟机会将该锁对象的持有线程设置为当前线程，并且将其计数器加1。</p>
<p>在目标锁对象的计数器不为零的情况下，如果锁对象的持有线程是当前线程，那么Java虚拟机可以将其计数器加1，否则需要等待，甚至持有线程释放该锁。</p>
<p>当执行monitorexit时，Java虚拟机则需将锁对象的计数器减1。计数器为零代表锁已被释放。</p>
</li>
<li><p>显示锁（即Lock）也有ReentrantLock这样的可重入锁。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        myLock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---外层调用&quot;</span>);</span><br><span class="line">            myLock.lock();</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---中层调用&quot;</span>);</span><br><span class="line">                myLock.lock();</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName()+<span class="string">&quot;---内层调用&quot;</span>);</span><br><span class="line">                &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">//这里故意注释，实现加锁次数和释放次数不一样</span></span><br><span class="line">                    <span class="comment">//由于加锁次数和释放次数不一样，第二个线程始终无法获取到锁，导致一直在等待。</span></span><br><span class="line">                    myLock.unlock(); <span class="comment">// 正常情况，加锁几次就要解锁几次</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                myLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            myLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>切记，一般而言，lock了几次就要unlock几次。</p>
</li>
</ul>
</li>
<li><p>上述可重入锁问题，redis中那个数据类型可以代替？</p>
<ul>
<li><p>K，K，V</p>
<p><img src="/hexo-docs/images/redisImages/image-20250707174427391.png" alt="image-20250707174427391"></p>
<p>hset zzyyRedisLock 29f0ee01ac77414fb8b0861271902a94:1</p>
<ul>
<li><p>总结</p>
<p>setnx，只能解决有无的问题，够用但是不够完美</p>
<p>hset，不但解决有无，还解决可重入问题</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>思考+设计模式（一横一纵）</p>
<ul>
<li><p>目前有2条支线，目的是保证同一个时候只能有一个线程持有锁进去redis做扣减库存动作</p>
<ul>
<li><p>2个分支</p>
<ul>
<li><p>保证加锁&#x2F;解锁，lock&#x2F;unlock</p>
<p>一个靠谱分布式锁需要具备的条件和刚需</p>
<ul>
<li>独占性</li>
<li>高可用</li>
<li>防死锁</li>
<li>不乱抢</li>
<li>重入性</li>
</ul>
</li>
<li><p>扣减库存redis命令的原子性</p>
<p><img src="/hexo-docs/images/redisImages/image-20250707181751904.png" alt="image-20250707181751904"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Lua脚本</p>
<ul>
<li><p>redis命令过程分析</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; EXISTS lock</span><br><span class="line">(integer) <span class="number">0</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; HSET lock <span class="number">1</span>a2b3c <span class="number">1</span></span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; HINCRBY lock <span class="number">1</span>a2b3c <span class="number">1</span></span><br><span class="line">(integer) <span class="number">2</span></span><br><span class="line"><span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; HGET lock <span class="number">1</span>a2b3c</span><br><span class="line">&quot;<span class="number">2</span>&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>加锁Lua脚本lock</p>
<ul>
<li><p>先判断redis分布式锁这个key是否存在</p>
<ul>
<li><p>exists key</p>
<ul>
<li><p>返回0说明不存在，hset新建当前线程属于自己的锁 uuid:threadId</p>
<p><img src="/hexo-docs/images/redisImages/image-20250707182254870.png" alt="image-20250707182254870"></p>
</li>
<li><p>返回1说明已经有锁，需进一步判断是不是当前线程自己的</p>
<ul>
<li>hexists key uuid:threadID<ul>
<li>返回0说明不是自己的</li>
<li>返回1说明是自己的锁，自增1次表示重入</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>上述设计修改为Lua脚本</p>
<ul>
<li><p>v1</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.<span class="keyword">call</span>(&#x27;exists&#x27;,&#x27;key&#x27;) == <span class="number">0</span> then</span><br><span class="line">  redis.<span class="keyword">call</span>(&#x27;hset&#x27;,&#x27;key&#x27;,&#x27;uuid:threadid&#x27;,<span class="number">1</span>)</span><br><span class="line">  redis.<span class="keyword">call</span>(&#x27;expire&#x27;,&#x27;key&#x27;,<span class="number">30</span>)</span><br><span class="line">  return <span class="number">1</span></span><br><span class="line">elseif redis.<span class="keyword">call</span>(&#x27;hexists&#x27;,&#x27;key&#x27;,&#x27;uuid:threadid&#x27;) == <span class="number">1</span> then</span><br><span class="line">  redis.<span class="keyword">call</span>(&#x27;hincrby&#x27;,&#x27;key&#x27;,&#x27;uuid:threadid&#x27;,<span class="number">1</span>)</span><br><span class="line">  redis.<span class="keyword">call</span>(&#x27;expire&#x27;,&#x27;key&#x27;,<span class="number">30</span>)</span><br><span class="line">  return <span class="number">1</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  return <span class="number">0</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>相同部分是否可以替换处理？？？</p>
<p>hincrby命令可否替代hset命令</p>
</li>
<li><p>v2</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.<span class="keyword">call</span>(&#x27;exists&#x27;,&#x27;key&#x27;) == <span class="number">0</span> or redis.<span class="keyword">call</span>(&#x27;hexists&#x27;,&#x27;key&#x27;,&#x27;uuid:threadid&#x27;) == <span class="number">1</span> then</span><br><span class="line">  redis.<span class="keyword">call</span>(&#x27;hincrby&#x27;,&#x27;key&#x27;,&#x27;uuid:threadid&#x27;,<span class="number">1</span>)</span><br><span class="line">  redis.<span class="keyword">call</span>(&#x27;expire&#x27;,&#x27;key&#x27;,<span class="number">30</span>)</span><br><span class="line">  return <span class="number">1</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  return <span class="number">0</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>v3</p>
<table>
<thead>
<tr>
<th>key</th>
<th>KEYS[1]</th>
<th>lock</th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>ARGV[1]</td>
<td>2f586ae740a94736894ab9d51880ed9d:1</td>
</tr>
<tr>
<td>过期时间值</td>
<td>ARGV[2]</td>
<td>30  秒</td>
</tr>
</tbody></table>
 <figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.<span class="keyword">call</span>(&#x27;exists&#x27;,KEYS[<span class="number">1</span>]) == <span class="number">0</span> or redis.<span class="keyword">call</span>(&#x27;hexists&#x27;,KEYS[<span class="number">1</span>],ARGV[<span class="number">1</span>]) == <span class="number">1</span> then </span><br><span class="line"> redis.<span class="keyword">call</span>(&#x27;hincrby&#x27;,KEYS[<span class="number">1</span>],ARGV[<span class="number">1</span>],<span class="number">1</span>) </span><br><span class="line"> redis.<span class="keyword">call</span>(&#x27;expire&#x27;,KEYS[<span class="number">1</span>],ARGV[<span class="number">2</span>]) </span><br><span class="line"> return <span class="number">1</span> </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"> return <span class="number">0</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>解锁Lua脚本unlock</p>
<ul>
<li><p>设计思路：有锁且还是自己的锁</p>
<ul>
<li><p>hexists key uuid:threadID</p>
<ul>
<li>返回零，说明根本没有锁，程序块返回nil</li>
<li>不是零，说明有锁是自己的锁，直接调用<code>hincrby -1</code>表示每次减个1，解锁一次。直到它变为零表示可以删除该锁key,del锁key</li>
</ul>
</li>
<li><p>设计脚本</p>
<ul>
<li><p>v1</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.<span class="keyword">call</span>(&#x27;HEXISTS&#x27;,lock,uuid:threadID) == <span class="number">0</span> then</span><br><span class="line"> return nil</span><br><span class="line">elseif redis.<span class="keyword">call</span>(&#x27;HINCRBY&#x27;,lock,uuid:threadID,-<span class="number">1</span>) == <span class="number">0</span> then</span><br><span class="line"> return redis.<span class="keyword">call</span>(&#x27;<span class="built_in">del</span>&#x27;,lock)</span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line"> return <span class="number">0</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>v2</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.<span class="keyword">call</span>(&#x27;HEXISTS&#x27;,KEYS[<span class="number">1</span>],ARGV[<span class="number">1</span>]) == <span class="number">0</span> then</span><br><span class="line"> return nil</span><br><span class="line">elseif redis.<span class="keyword">call</span>(&#x27;HINCRBY&#x27;,KEYS[<span class="number">1</span>],ARGV[<span class="number">1</span>],-<span class="number">1</span>) == <span class="number">0</span> then</span><br><span class="line"> return redis.<span class="keyword">call</span>(&#x27;<span class="built_in">del</span>&#x27;,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"> return <span class="number">0</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="第七次改造（确保可重入性和原子性）"><a href="#第七次改造（确保可重入性和原子性）" class="headerlink" title="第七次改造（确保可重入性和原子性）"></a>第七次改造（确保可重入性和原子性）</h3><p><code>RedisDistributedLock</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.locks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisDistributedLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String lockName;<span class="comment">//KEYS[1]</span></span><br><span class="line">    <span class="keyword">private</span> String uuidValue;<span class="comment">//ARGV[1]</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span>   expireTime;<span class="comment">//ARGV[2]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisDistributedLock</span><span class="params">(StringRedisTemplate stringRedisTemplate, String lockName)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">        <span class="built_in">this</span>.lockName = lockName;</span><br><span class="line">        <span class="built_in">this</span>.uuidValue = IdUtil.simpleUUID()+<span class="string">&quot;:&quot;</span>+Thread.currentThread().getId();<span class="comment">//UUID:ThreadID</span></span><br><span class="line">        <span class="built_in">this</span>.expireTime = <span class="number">30L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>&#123;</span><br><span class="line">        tryLock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;tryLock(-<span class="number">1L</span>,TimeUnit.SECONDS);&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;e.printStackTrace();&#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 干活的，实现加锁功能，实现这一个干活的就OK，全盘通用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException&#123;</span><br><span class="line">        <span class="keyword">if</span>(time != -<span class="number">1L</span>)&#123;</span><br><span class="line">            <span class="built_in">this</span>.expireTime = unit.toSeconds(time);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;if redis.call(&#x27;exists&#x27;,KEYS[1]) == 0 or redis.call(&#x27;hexists&#x27;,KEYS[1],ARGV[1]) == 1 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;hincrby&#x27;,KEYS[1],ARGV[1],1) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;expire&#x27;,KEYS[1],ARGV[2]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 1 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 0 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;script: &quot;</span>+script);</span><br><span class="line">        System.out.println(<span class="string">&quot;lockName: &quot;</span>+lockName);</span><br><span class="line">        System.out.println(<span class="string">&quot;uuidValue: &quot;</span>+uuidValue);</span><br><span class="line">        System.out.println(<span class="string">&quot;expireTime: &quot;</span>+expireTime);</span><br><span class="line">        <span class="keyword">while</span> (Boolean.FALSE.equals(stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime)))) &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">50</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *干活的，实现解锁功能</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;if redis.call(&#x27;HEXISTS&#x27;,KEYS[1],ARGV[1]) == 0 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;   return nil &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;elseif redis.call(&#x27;HINCRBY&#x27;,KEYS[1],ARGV[1],-1) == 0 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;   return redis.call(&#x27;del&#x27;,KEYS[1]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;   return 0 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        <span class="comment">// nil = false 1 = true 0 = false</span></span><br><span class="line">        System.out.println(<span class="string">&quot;lockName: &quot;</span>+lockName);</span><br><span class="line">        System.out.println(<span class="string">&quot;uuidValue: &quot;</span>+uuidValue);</span><br><span class="line">        System.out.println(<span class="string">&quot;expireTime: &quot;</span>+expireTime);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class), Arrays.asList(lockName),uuidValue,String.valueOf(expireTime));</span><br><span class="line">        <span class="keyword">if</span>(flag == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;This lock doesn&#x27;t EXIST&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//===下面的redis分布式锁暂时用不到=======================================</span></span><br><span class="line">    <span class="comment">//===下面的redis分布式锁暂时用不到=======================================</span></span><br><span class="line">    <span class="comment">//===下面的redis分布式锁暂时用不到=======================================</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>service</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> com.lazy.locks.RedisDistributedLock;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisDistributedLock</span>(stringRedisTemplate,<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span>(inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>,String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，库存剩余: &quot;</span>+inventoryNumber;</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage+<span class="string">&quot;服务端口号：&quot;</span>+port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/hexo-docs/images/redisImages/image-20250708182329476.png" alt="image-20250708182329476"></p>
<p>为了有更好的兼容性我们引入了工程设计模式</p>
<p><code>DistributedLockFactory</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.locks.RedisDistributedLock;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="keyword">private</span> String lockName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Lock <span class="title function_">getDistributedLock</span><span class="params">(String lockType)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lockType == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (lockType.equalsIgnoreCase(<span class="string">&quot;redis&quot;</span>))&#123;</span><br><span class="line">            <span class="built_in">this</span>.lockName = <span class="string">&quot;redisLock&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisDistributedLock</span>(stringRedisTemplate,lockName);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (lockType.equalsIgnoreCase(<span class="string">&quot;mysql&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//TODO mysql版本的分布式锁实现</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(lockType.equalsIgnoreCase(<span class="string">&quot;zookeeper&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//TODO zookeeper版本的分布式锁实现</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>service</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.factory.DistributedFactory;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DistributedFactory distributedFactory;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Lock</span> <span class="variable">redisLock</span> <span class="operator">=</span> distributedFactory.getDistributedLock(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        redisLock.lock();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span>(inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>,String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，QD库存剩余: &quot;</span>+inventoryNumber;</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            redisLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage+<span class="string">&quot;服务端口号：&quot;</span>+port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/hexo-docs/images/redisImages/image-20250708191029076.png" alt="image-20250708191029076"></p>
<p>看着好像没问题</p>
<h4 id="可重入测试重点"><a href="#可重入测试重点" class="headerlink" title="可重入测试重点"></a>可重入测试重点</h4><p>我们在<code>service</code>增加一个方法试试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.factory.DistributedFactory;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DistributedFactory distributedFactory;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Lock</span> <span class="variable">redisLock</span> <span class="operator">=</span> distributedFactory.getDistributedLock(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        redisLock.lock();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span>(inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>,String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，QD库存剩余: &quot;</span>+inventoryNumber;</span><br><span class="line">                testLock();</span><br><span class="line">                System.out.println(retMessage);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            redisLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage+<span class="string">&quot;服务端口号：&quot;</span>+port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Lock</span> <span class="variable">redisLock</span> <span class="operator">=</span> distributedFactory.getDistributedLock(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line">        redisLock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;测试可重入性方法&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            redisLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动测试试试</p>
<p><img src="/hexo-docs/images/redisImages/image-20250708194225270.png" alt="image-20250708194225270"></p>
<p><code>DistributedLockFactory</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.IdUtil;</span><br><span class="line"><span class="keyword">import</span> com.lazy.locks.RedisDistributedLock;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedLockFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="keyword">private</span> String lockName;</span><br><span class="line">    <span class="keyword">private</span> String uuidValue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DistributedLockFactory</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>.uuidValue = IdUtil.simpleUUID();<span class="comment">//UUID</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Lock <span class="title function_">getDistributedLock</span><span class="params">(String lockType)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(lockType == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(lockType.equalsIgnoreCase(<span class="string">&quot;REDIS&quot;</span>))&#123;</span><br><span class="line">            lockName = <span class="string">&quot;zzyyRedisLock&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisDistributedLock</span>(stringRedisTemplate,lockName,uuidValue);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(lockType.equalsIgnoreCase(<span class="string">&quot;ZOOKEEPER&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//TODO zookeeper版本的分布式锁实现</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(lockType.equalsIgnoreCase(<span class="string">&quot;MYSQL&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//TODO mysql版本的分布式锁实现</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>RedisDistributedLock</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.locks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisDistributedLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="keyword">private</span> String lockName;</span><br><span class="line">    <span class="keyword">private</span> String uuidValue;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span>   expireTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisDistributedLock</span><span class="params">(StringRedisTemplate stringRedisTemplate, String lockName,String uuidValue)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">        <span class="built_in">this</span>.lockName = lockName;</span><br><span class="line">        <span class="built_in">this</span>.uuidValue = uuidValue+<span class="string">&quot;:&quot;</span>+Thread.currentThread().getId();</span><br><span class="line">        <span class="built_in">this</span>.expireTime = <span class="number">30L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>.tryLock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.tryLock(-<span class="number">1L</span>,TimeUnit.SECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(time != -<span class="number">1L</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            expireTime = unit.toSeconds(time);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;if redis.call(&#x27;exists&#x27;,KEYS[1]) == 0 or redis.call(&#x27;hexists&#x27;,KEYS[1],ARGV[1]) == 1 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;hincrby&#x27;,KEYS[1],ARGV[1],1) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;expire&#x27;,KEYS[1],ARGV[2]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 1 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 0 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;lockName: &quot;</span>+lockName+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;uuidValue: &quot;</span>+uuidValue);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123; TimeUnit.MILLISECONDS.sleep(<span class="number">60</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;if redis.call(&#x27;HEXISTS&#x27;,KEYS[1],ARGV[1]) == 0 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return nil &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;elseif redis.call(&#x27;HINCRBY&#x27;,KEYS[1],ARGV[1],-1) == 0 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return redis.call(&#x27;del&#x27;,KEYS[1]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 0 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;lockName: &quot;</span>+lockName+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;uuidValue: &quot;</span>+uuidValue);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime));</span><br><span class="line">        <span class="keyword">if</span>(flag == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;没有这个锁，HEXISTS查询无&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//=========================================================</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试通过！</p>
<h3 id="第八次改造（添加自动续期）"><a href="#第八次改造（添加自动续期）" class="headerlink" title="第八次改造（添加自动续期）"></a>第八次改造（添加自动续期）</h3><p>确保<code>redisLock</code>过期时间大于业务执行时间的问题，在第一次改造上修改</p>
<p><code>service</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lazy.factory.DistributedLockFactory;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DistributedLockFactory distributedFactory;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sale</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Lock</span> <span class="variable">redisLock</span> <span class="operator">=</span> distributedFactory.getDistributedLock(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">retMessage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        redisLock.lock();</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//1 查询库存信息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;inventory001&quot;</span>);</span><br><span class="line">            <span class="comment">//2 判断库存是否足够</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">inventoryNumber</span> <span class="operator">=</span> result == <span class="literal">null</span> ? <span class="number">0</span> : Integer.parseInt(result);</span><br><span class="line">            <span class="comment">//3 扣减库存</span></span><br><span class="line">            <span class="keyword">if</span>(inventoryNumber &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(<span class="string">&quot;inventory001&quot;</span>,String.valueOf(--inventoryNumber));</span><br><span class="line">                retMessage = <span class="string">&quot;成功卖出一个商品，QD库存剩余: &quot;</span>+inventoryNumber;</span><br><span class="line">                <span class="comment">//暂停120秒</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">120</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                retMessage = <span class="string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            redisLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retMessage+<span class="string">&quot;服务端口号：&quot;</span>+port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>RedisDistributedLock</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lazy.locks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisDistributedLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String lockName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String uuidValue;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> expireTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisDistributedLock</span><span class="params">(StringRedisTemplate stringRedisTemplate, String lockName, String uuidValue)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">        <span class="built_in">this</span>.lockName = lockName;</span><br><span class="line">        <span class="built_in">this</span>.uuidValue = uuidValue + <span class="string">&quot;:&quot;</span> + Thread.currentThread().getId();</span><br><span class="line">        <span class="built_in">this</span>.expireTime = <span class="number">30L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.tryLock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.tryLock(-<span class="number">1L</span>, TimeUnit.SECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (time != -<span class="number">1L</span>) &#123;</span><br><span class="line">            expireTime = unit.toSeconds(time);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;if redis.call(&#x27;exists&#x27;,KEYS[1]) == 0 or redis.call(&#x27;hexists&#x27;,KEYS[1],ARGV[1]) == 1 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;hincrby&#x27;,KEYS[1],ARGV[1],1) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;expire&#x27;,KEYS[1],ARGV[2]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 1 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 0 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;lockName: &quot;</span> + lockName + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;uuidValue: &quot;</span> + uuidValue);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class), Collections.singletonList(lockName), uuidValue, String.valueOf(expireTime))) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">60</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        renewExpire();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;if redis.call(&#x27;HEXISTS&#x27;,KEYS[1],ARGV[1]) == 0 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return nil &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;elseif redis.call(&#x27;HINCRBY&#x27;,KEYS[1],ARGV[1],-1) == 0 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return redis.call(&#x27;del&#x27;,KEYS[1]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 0 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;lockName: &quot;</span> + lockName + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;uuidValue: &quot;</span> + uuidValue);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class), Collections.singletonList(lockName), uuidValue, String.valueOf(expireTime));</span><br><span class="line">        <span class="keyword">if</span> (flag == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;没有这个锁，HEXISTS查询无&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">renewExpire</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;if redis.call(&#x27;HEXISTS&#x27;,KEYS[1],ARGV[1]) == 1 then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return redis.call(&#x27;expire&#x27;,KEYS[1],ARGV[2]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 0 &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line">		<span class="comment">//定时任务每隔10秒后执行一次</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Timer</span>().schedule(<span class="keyword">new</span> <span class="title class_">TimerTask</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Boolean.TRUE.equals(stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class), Arrays.asList(lockName), uuidValue, String.valueOf(expireTime)))) &#123;</span><br><span class="line">                    renewExpire();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,(<span class="built_in">this</span>.expireTime * <span class="number">1000</span>)/<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//=========================================================</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果！</p>
<p><img src="/hexo-docs/images/redisImages/image-20250711185139011.png" alt="image-20250711185139011"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>第一版：<code>synchronized</code>单机版OK，上分布式死翘翘</li>
<li>第二版：<code>nginx</code>分布式微服务单机锁不行</li>
<li>第三版：取消单机锁改为上<code>redis</code>分布式锁<code>setnx</code><ol>
<li>只加了锁，没有释放锁，出异常的话，可能无法释放锁，必须要在代码层面<code>finally</code>释放锁</li>
<li>宕机了，部署了微服务代码层面根本没有走到<code>finally</code>这块，没办法保证解锁，这个<code>key</code>没有被删除，需要有<code>lockKey</code>的过期时间设定</li>
</ol>
</li>
<li>第四版：为<code>redis</code>的分布式锁<code>key</code>，增加过期时间，此外，还必须要<code>setnx</code>+过期时间必须同一行</li>
<li>第五版：必须规定只能删除自己的锁，不能删除别人的锁</li>
<li>第六版：<code>unlock</code>变为<code>lua</code>脚本保证</li>
<li>第七版：锁重入，<code>hset</code>替代<code>setnx</code>+<code>lock</code>变为<code>lua</code>脚本保证</li>
<li>第八版：自动续期</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://mac2git.github.io/hexo-docs">Lazy</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://mac2git.github.io/hexo-docs/2025/08/13/redis/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">https://mac2git.github.io/hexo-docs/2025/08/13/redis/redis分布式锁/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://mac2git.github.io/hexo-docs" target="_blank">Lazy的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/hexo-docs/tags/Redis/">Redis</a></div><div class="post-share"><div class="social-share" data-image="https://pic.crazytaxii.com/Redis_Logo.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/hexo-docs/2025/08/13/redis/redis%E7%BB%8F%E5%85%B8%E4%BA%94%E5%A4%A7%E7%B1%BB%E5%9E%8B%E5%8F%8A%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/" title="Redis经典五大类型源码及底层实现"><img class="cover" src="https://pic.crazytaxii.com/Redis_Logo.png" onerror="onerror=null;src='/hexo-docs/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Redis经典五大类型源码及底层实现</div></div><div class="info-2"><div class="info-item-1">Redis经典五大类型源码及底层实现本源码基于redis7.0.5 Redis数据类型和底层数据结构  SDS动态字符串 双向链表 压缩列表ziplist 哈希表hashtable 跳表skiplist 整数集合intset 快速列表quicklist 紧凑列表listpack  源码在哪里？ github ：https://github.com/redis/redis  Redis核心部分src源码包下面该如何看？ Redis基本数据结构（骨架） Github官网说明   Redis对象object.c 字符串t_string.c 列表t_list.c 字典t_hash.c 集合及有序集合t_set.c和t_zset.c 数据流t_stream.c：Streams的底层实现结构listpack.c和rax.c   简单动态字符串sds.c  整数集合intset.c  压缩列表ziplist.c  快速链表quicklist.c  listpack（紧凑列表）  字典dict.c   Redis数据库的实现 数据库的底层实现db.c 持久化rdb.c和aof.c  Redis服...</div></div></div></a><a class="pagination-related" href="/hexo-docs/2025/08/13/redis/replica/" title="Replica(主从复制)"><img class="cover" src="https://pic.crazytaxii.com/Redis_Logo.png" onerror="onerror=null;src='/hexo-docs/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Replica(主从复制)</div></div><div class="info-2"><div class="info-item-1">复制（replica）就是主从复制，master以写为主，slave以读为主。当master数据变化的时候，自动将新的数据异步同步到其他slave数据库 优点：  读写分离 容灾恢复 数据备份 水平扩容支撑高并发  如何使用  配从（库）不配主（库） 权限细节，重要 master 如果配置了 requirepass 参数，需要密码登录 那么 slave 就要配置 masterauth 来设置校验密码，否则的话 master 会拒绝 slave的访问请求      基本操作命令 info replication：可以查看复制节点的主从关系和配置信息 replicaof 主库IP 主库端口：一般写入进 redis.conf 配置文件内 slaveof 主库IP 主库端口 每次与 master 断开之后，都需要重新连接，除非你配置进 redis.conf 文件 在运行期间修改 slave 节点的信息，如果该数据库已经是某个主数据库的从数据库，那么会停止和原主数据库的同步关系转而和新的主数据库同步，重新拜主数据库   slaveof no one：使当前数据库停止与其他数据库的同步，转成...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/hexo-docs/2025/08/13/redis/Redlock%E7%AE%97%E6%B3%95%E5%92%8C%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%92%8C%E7%BC%93%E5%AD%98%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5/" title="RedLock算法和底层源码分析和缓存淘汰策略"><img class="cover" src="https://pic.crazytaxii.com/Redis_Logo.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-13</div><div class="info-item-2">RedLock算法和底层源码分析和缓存淘汰策略</div></div><div class="info-2"><div class="info-item-1">上一章自研的redis锁对于一般中小公司，不是特别高并发场景足够用了，单机redis小业务也撑得住。但是对于特别高并发场景的话，就得使用Redisson了 Redis分布式锁-RedLock红锁算法（Distributed locks with Redis）官网：Redis 的分布式锁 |文档 说明：  为什么学习这个？怎样产生的？   线程 1 首先获取锁成功，将键值对写入 redis 的 master 节点，在 redis 将该键值对同步到 slave 节点之前，master 发生了故障；redis 触发故障转移，其中一个 slave 升级为新的 master，此时新上位的master并不包含线程1写入的键值对，因此线程 2 尝试获取锁也可以成功拿到锁，此时相当于有两个线程获取到了锁，可能会导致各种预期之外的情况发生，例如最常见的脏数据。  我们加的是排它独占锁，同一时间只能有一个建redis锁成功并持有锁，严禁出现2个以上的请求线程拿到锁。危险的！ RedLock算法设计理念Redis也提供了Redlock算法，用来实现基于多个实例的分布式锁。锁变量由多个实例维护，即使有实...</div></div></div></a><a class="pagination-related" href="/hexo-docs/2025/08/13/redis/RDB+AOF/" title="RDB+AOF"><img class="cover" src="https://pic.crazytaxii.com/Redis_Logo.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-13</div><div class="info-item-2">RDB+AOF</div></div><div class="info-2"><div class="info-item-1">redis数据数据持久化 为什么要用数据持久化？ 数据持久化可以在内存丢失或其他灾难性故障的情况下实现恢复。 数据持久化的两种方式  AOF：以日志的形式来记录每个写操作，将redis执行过的所有写指令记录下来（读操作不记录），只许追加文件但不可以改写文件，redis启动之初会读取该文件重新构建数据，换言之，redis重启的话就根据日志文件的内容将写入指令从前到后执行一次以完成数据的恢复工作。 RDB（Redis 数据库）：RDB 持久性以指定的时间间隔执行数据集的时间点快照。  rdb（redis database）能干嘛？ 在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是行话讲的Snapshot内存快照，它恢复时再将硬盘快照文件直接读回到内存里。Redis的数据都在内存中，保存备份时它执行的是全量快照，也就是说，把内存中的所有数据都记录到磁盘中，一锅端。 Rdb保存的是dump.rdb文件  Redis6.0.16以下  Redis6.2以及Redis-7.0.0  自动触发 redis7版本，按照redis.conf里配置的save&lt;seconds&gt;&lt...</div></div></div></a><a class="pagination-related" href="/hexo-docs/2025/08/13/redis/bigkey%E5%92%8C%E7%BC%93%E5%AD%98%E5%8F%8C%E5%86%99/" title="BigKey和缓存双写"><img class="cover" src="https://pic.crazytaxii.com/Redis_Logo.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-13</div><div class="info-item-2">BigKey和缓存双写</div></div><div class="info-2"><div class="info-item-1">Redis为什么是单线程这种问法其实并不严谨，为啥这么说呢? Redis的版本很多3.x、4.x、6.x，版本不同架构也是不同的，不限定版本问是否单线程也不太严谨。  版本3.x ，最早版本，也就是大家口口相传的redis是单线程，阳哥2016年讲解的redis就是3.X的版本。  版本4.x，严格意义来说也不是单线程，而是负责处理客户端请求的线程是单线程，但是开始加了点多线程的东西(异步删除)。—貌似  2020年5月版本的6.0.x后及2022年出的7.0版本后，告别了大家印象中的单线程，用一种全新的多线程来解决问题。—实锤   几个里程碑的redis版本！  5.0版本是直接升级到6.0版本，对于这个激进的升级，Redis之父antirez表现得很有信心和兴奋， 所以第一时间发文来阐述6.0的一些重大功能”Redis 6.0.0 GA is out!” 当然，Redis7.0后版本更加厉害  Redis是单线程 主要是指Redis的网络IO和键值对读写是由一个线程来完成的，Redis在处理客户端的请求时包括获取 (socket 读)、解析、执行、内容返回 (socket 写...</div></div></div></a><a class="pagination-related" href="/hexo-docs/2025/08/13/redis/hyperloglogGeoBitmap/" title="HyperLogLog&amp;Geo&amp;Bitmap"><img class="cover" src="https://pic.crazytaxii.com/Redis_Logo.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-13</div><div class="info-item-2">HyperLogLog&amp;Geo&amp;Bitmap</div></div><div class="info-2"><div class="info-item-1">统计类型有哪些？ 亿级系统中常见的四种统计  聚合统计 统计多个集合元素的聚合结果，就是前面的交集差集等集合统计   排序统计（zset） 在面对需要展示最新列表、排行榜等场景时，如果数据更新频繁或者需要分页显示，建议使用ZSet  因为可以使用分页，正反排序  二值统计（bitmap） 集合元素的取值就只有0和1两种，在钉钉上班签到打开的场景中，我们只用记录有签到（1）和没签到（0）  基数统计（hyperloglog） 指 统计一个集合不重复元素个数     HyperLogLog名词解释  什么是UV?  Unique Visitor，独立访客，一般理解为客户端IP 需要去重考虑，例如一个人一天访问了10次网站，一天的UV就是1   什么是PV?  Page View，页面浏览量 不用去重，例如一个人一天访问了10次网站，一天的PV就是10   什么是DAU?  Daily  Active User  日活跃用户量 登录或者使用了某个产品的用户数（去重复登录的用户），避免恶意刷单  常用于反映网站，互联网应用或者网络游戏的运营情况      什么是MAU？  Monthly...</div></div></div></a><a class="pagination-related" href="/hexo-docs/2025/08/13/redis/pub&sub/" title="pub&amp;sub(发布&amp;订阅)"><img class="cover" src="https://pic.crazytaxii.com/Redis_Logo.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-13</div><div class="info-item-2">pub&amp;sub(发布&amp;订阅)</div></div><div class="info-2"><div class="info-item-1">发布&#x2F;订阅是一种消息通信模式：发送者（publish）发送消息，订阅者（subscribe）接受消息，可以实现进程间的消息传递 Redis  可以实现消息中间件 MQ 的功能，通过发布订阅实现消息的引导和分流。不推荐使用该功能，专业的事情交给专业的中间件，redis就做好分布式缓存功能 能干嘛？  redis 客户端可以订阅任意数量的频道，类似我们微信关注多个公众号   当有新的消息通过 publish 命令发送给频道 channel1 时     总结： 发布&#x2F;订阅其实是一个轻量的队列，只不过数据不会被持久化，一般用来处理实时性较高的异步消息    常用命令  subscribe channel [channel...]   订阅给定的一个或多个频道的信息 推荐先执行订阅后再发布，订阅成功之前发布的消息是收不到的 订阅的客户端每次可以收到一个3个参数的消息 消息的种类 始发频道的名称 实际的消息内容         publish channel message    发布消息到指定的频道    psubscribe pattern[pattern...] ...</div></div></div></a><a class="pagination-related" href="/hexo-docs/2025/08/13/redis/epoll%E5%87%BD%E6%95%B0%E5%92%8CIO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/" title="epoll函数和IO多路复用深度解析"><img class="cover" src="https://pic.crazytaxii.com/Redis_Logo.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-13</div><div class="info-item-2">epoll函数和IO多路复用深度解析</div></div><div class="info-2"><div class="info-item-1">epoll 函数和 IO 多路复用深度解析没有 epoll 和 IO 多路复用之前多路复用要解决的问题并发多客户端连接，在多路复用之前最简单和典型的方案：同步阻塞网络IO模型 这种模式的特点就是用一个进程来处理一个网络连接(一个用户请求)，比如一段典型的示例代码如下。 直接调用 recv 函数从一个 socket 上读取数据。 int main()&#123; ... recv(sock, ...) //从用户角度来看非常简单，一个recv一用，要接收的数据就到我们手里了。&#125;  我们来总结一下这种方式： 优点： 就是这种方式非常容易让人理解，写起代码来非常的自然，符合人的直线型思维。 缺点： 就是性能差，每个用户请求到来都得占用一个进程来处理，来一个请求就要分配一个进程跟进处理， 类似一个学生配一个老师，一位患者配一个医生，可能吗？进程是一个很笨重的东西。一台服务器上创建不了多少个进程。 结论进程在 Linux 上是一个开销不小的家伙，先不说创建，光是上下文切换一次就得几个微秒。所以为了高效地对海量用户提供服务，必须要让一个进程能同时处理很多个 tcp 连接才行。现在假...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/hexo-docs/images/webImages/avatar.jpg" onerror="this.onerror=null;this.src='/hexo-docs/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Lazy</div><div class="author-info-description">归途也还可爱</div><div class="site-data"><a href="/hexo-docs/archives/"><div class="headline">文章</div><div class="length-num">32</div></a><a href="/hexo-docs/tags/"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/hexo-docs/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Mac2git"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Mac2git" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://gitee.com/wx_00ba6ce280" target="_blank" title="Gitee"><i class="fa fa-book-open"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">博客正在施工，请先随便逛逛。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">redis分布式锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B1"><span class="toc-text">案例1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%94%B9%E9%80%A0-%E9%80%92%E5%BD%92%E9%87%8D%E8%AF%95"><span class="toc-text">第一次改造(递归重试)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AC%A1%E6%94%B9%E9%80%A0%EF%BC%88while%E6%9B%BF%E4%BB%A3%EF%BC%89"><span class="toc-text">第二次改造（while替代）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AC%A1%E6%94%B9%E9%80%A0%EF%BC%88%E5%AE%95%E6%9C%BA%E4%B8%8E%E8%BF%87%E6%9C%9F-%E9%98%B2%E6%AD%A2%E6%AD%BB%E9%94%81%EF%BC%89"><span class="toc-text">第三次改造（宕机与过期+防止死锁）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AC%A1%E6%94%B9%E9%80%A0%EF%BC%88%E9%98%B2%E6%AD%A2%E8%AF%AF%E5%88%A0key%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%89"><span class="toc-text">第四次改造（防止误删key的问题）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AC%A1%E6%94%B9%E9%80%A0%EF%BC%88%E4%BF%9D%E8%AF%81%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%8C%E4%BD%BF%E7%94%A8lua%E8%84%9A%E6%9C%AC%EF%BC%89"><span class="toc-text">第五次改造（保证原子性，使用lua脚本）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Lua%E8%84%9A%E6%9C%AC"><span class="toc-text">Lua脚本</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E6%AC%A1%E6%94%B9%E9%80%A0"><span class="toc-text">第六次改造</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%EF%BC%88%E5%8F%88%E5%90%8D%E9%80%92%E5%BD%92%E9%94%81%EF%BC%89"><span class="toc-text">可重入锁（又名递归锁）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E6%AC%A1%E6%94%B9%E9%80%A0%EF%BC%88%E7%A1%AE%E4%BF%9D%E5%8F%AF%E9%87%8D%E5%85%A5%E6%80%A7%E5%92%8C%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%89"><span class="toc-text">第七次改造（确保可重入性和原子性）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E9%87%8D%E5%85%A5%E6%B5%8B%E8%AF%95%E9%87%8D%E7%82%B9"><span class="toc-text">可重入测试重点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E6%AC%A1%E6%94%B9%E9%80%A0%EF%BC%88%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%8A%A8%E7%BB%AD%E6%9C%9F%EF%BC%89"><span class="toc-text">第八次改造（添加自动续期）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/hexo-docs/2025/11/17/other/springboot3%E6%96%B0%E7%89%B9%E6%80%A7/" title="SpringBoot3新特性"><img src="https://spring.io/img/projects/spring-boot.svg" onerror="this.onerror=null;this.src='/hexo-docs/img/404.jpg'" alt="SpringBoot3新特性"/></a><div class="content"><a class="title" href="/hexo-docs/2025/11/17/other/springboot3%E6%96%B0%E7%89%B9%E6%80%A7/" title="SpringBoot3新特性">SpringBoot3新特性</a><time datetime="2025-11-17T10:19:12.000Z" title="发表于 2025-11-17 18:19:12">2025-11-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/hexo-docs/2025/10/28/other/MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/" title="MySQL索引优化"><img src="/hexo-docs/images/mysql_idImages/cover.svg" onerror="this.onerror=null;this.src='/hexo-docs/img/404.jpg'" alt="MySQL索引优化"/></a><div class="content"><a class="title" href="/hexo-docs/2025/10/28/other/MySQL%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/" title="MySQL索引优化">MySQL索引优化</a><time datetime="2025-10-27T16:00:00.000Z" title="发表于 2025-10-28 00:00:00">2025-10-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/hexo-docs/2025/10/22/MinIO/MinIO/" title="MinIO"><img src="https://www.minio.org.cn/resources/img/logo.svg" onerror="this.onerror=null;this.src='/hexo-docs/img/404.jpg'" alt="MinIO"/></a><div class="content"><a class="title" href="/hexo-docs/2025/10/22/MinIO/MinIO/" title="MinIO">MinIO</a><time datetime="2025-10-21T16:00:00.000Z" title="发表于 2025-10-22 00:00:00">2025-10-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/hexo-docs/2025/09/24/pay/ali_pay/" title="支付宝沙箱环境支付"><img src="/hexo-docs/images/payImages/alipay.png" onerror="this.onerror=null;this.src='/hexo-docs/img/404.jpg'" alt="支付宝沙箱环境支付"/></a><div class="content"><a class="title" href="/hexo-docs/2025/09/24/pay/ali_pay/" title="支付宝沙箱环境支付">支付宝沙箱环境支付</a><time datetime="2025-09-23T16:00:00.000Z" title="发表于 2025-09-24 00:00:00">2025-09-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/hexo-docs/2025/09/22/nginx/nginx/" title="Nginx"><img src="https://nginx.org/img/nginx_logo.png" onerror="this.onerror=null;this.src='/hexo-docs/img/404.jpg'" alt="Nginx"/></a><div class="content"><a class="title" href="/hexo-docs/2025/09/22/nginx/nginx/" title="Nginx">Nginx</a><time datetime="2025-09-21T16:00:00.000Z" title="发表于 2025-09-22 00:00:00">2025-09-22</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Lazy</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/hexo-docs/js/utils.js"></script><script src="/hexo-docs/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="富强,民主,文明,和谐,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="14px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/hexo-docs/js/search/local-search.js"></script></div></div></body></html>